<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>AFL学习(一)-补充QEMU模式</title>
      <link href="/posts/4bf8181c/"/>
      <url>/posts/4bf8181c/</url>
      
        <content type="html"><![CDATA[<h1>QEMU模式测试</h1><h2 id="编译QEMU">编译QEMU</h2><div class="story post-story"><p>参考<code>README.qemu</code></p><pre class="language-bash" data-language="bash"><code class="language-bash">$./build_qemu_support.sh<span class="token comment"># Cannot use 'python', Python 2.6 or later is required.Note that Python 3 or later is not yet supported.</span><span class="token comment"># 安装依赖，将python链接到python2上</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libtool,libtool-bin,bison,libgtk2.0-dev,python2<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>AFL binary-only instrumentation QEMU build script<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Performing basic sanity checks<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All checks passed<span class="token operator">!</span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Cryptographic signature on qemu-2.10.0.tar.xz checks out.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Uncompressing archive <span class="token punctuation">(</span>this will take a <span class="token keyword">while</span><span class="token punctuation">)</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Unpacking successful.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Configuring QEMU <span class="token keyword">for</span> <span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Applying patches<span class="token punctuation">..</span>.patching <span class="token function">file</span> linux-user/elfload.cpatching <span class="token function">file</span> accel/tcg/cpu-exec.cpatching <span class="token function">file</span> linux-user/syscall.cpatching <span class="token function">file</span> configurepatching <span class="token function">file</span> util/memfd.c<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Patching done.Install prefix    /usr/localBIOS directory    /usr/local/share/qemubinary directory  /usr/local/binlibrary directory /usr/local/libmodule directory  /usr/local/lib/qemulibexec directory /usr/local/libexecinclude directory /usr/local/includeconfig directory  /usr/local/etc<span class="token builtin class-name">local</span> state directory   /usr/local/varManual directory  /usr/local/share/manELF interp prefix /usr/gnemul/qemu-%MSource path       /home/workhome/AFL/qemu_mode/qemu-2.10.0C compiler        ccHost C compiler   ccC++ compiler      c++Objective-C compiler ccARFLAGS           rvCFLAGS            -O2 -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE<span class="token operator">=</span><span class="token number">2</span> -g -O3 -ggdbQEMU_CFLAGS       -I/usr/include/pixman-1 -I<span class="token variable"><span class="token variable">$(</span>SRC_PATH<span class="token variable">)</span></span>/dtc/libfdt -pthread -I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include -fPIE -DPIE -m64 -mcx16 -D_GNU_SOURCE -D_FILE_OFFSET_BITS<span class="token operator">=</span><span class="token number">64</span> -D_LARGEFILE_SOURCE -Wstrict-prototypes -Wredundant-decls -Wall -Wundef -Wwrite-strings -Wmissing-prototypes -fno-strict-aliasing -fno-common -fwrapv  -Wexpansion-to-defined -Wendif-labels -Wno-shift-negative-value -Wno-missing-include-dirs -Wempty-body -Wnested-externs -Wformat-security -Wformat-y2k -Winit-self -Wignored-qualifiers -Wold-style-declaration -Wold-style-definition -Wtype-limits -fstack-protector-strongLDFLAGS           -Wl,--warn-common -Wl,-z,relro -Wl,-z,now -pie -m64 -g<span class="token function">make</span>              <span class="token function">make</span><span class="token function">install</span>           <span class="token function">install</span>python            python -Bsmbd              /usr/sbin/smbdmodule support    no<span class="token function">host</span> CPU          x86_64<span class="token function">host</span> big endian   notarget list       x86_64-linux-usergprof enabled     nosparse enabled    nostrip binaries    <span class="token function">yes</span>profiler          nostatic build      nopixman            systemSDL support       noGTK support       noGTK GL support    noVTE support       noTLS priority      NORMALGNUTLS support    noGNUTLS rnd        nolibgcrypt         nolibgcrypt kdf     nonettle            nonettle kdf        nolibtasn1          nocurses support    novirgl support     no<span class="token function">curl</span> support      nomingw32 support   noAudio drivers     ossBlock whitelist <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>Block whitelist <span class="token punctuation">(</span>ro<span class="token punctuation">)</span>VirtFS supportVNC support       noxen support       nobrlapi support    nobluez  support    noDocumentation     noPIE               <span class="token function">yes</span>vde support       nonetmap support    noLinux AIO support noATTR/XATTR support <span class="token function">yes</span>Install blobs     <span class="token function">yes</span>KVM support       <span class="token function">yes</span>HAX support       noTCG support       <span class="token function">yes</span>TCG debug enabled noTCG interpreter   noRDMA support      nofdt support       <span class="token function">yes</span>preadv support    <span class="token function">yes</span>fdatasync         <span class="token function">yes</span>madvise           <span class="token function">yes</span>posix_madvise     <span class="token function">yes</span>libcap-ng support novhost-net support <span class="token function">yes</span>vhost-scsi support <span class="token function">yes</span>vhost-vsock support <span class="token function">yes</span>vhost-user support <span class="token function">yes</span>Trace backends    logspice support     norbd support       noxfsctl support    nosmartcard support nolibusb            nousb net redir     noOpenGL support    noOpenGL dmabufs    nolibiscsi support  nolibnfs support    nobuild guest agent <span class="token function">yes</span>QGA VSS support   noQGA w32 disk info noQGA MSI support   noseccomp support   nocoroutine backend ucontextcoroutine pool    <span class="token function">yes</span>debug stack usage nocrypto afalg      noGlusterFS support nogcov              gcovgcov enabled      noTPM support       <span class="token function">yes</span>libssh2 support   noTPM passthrough   <span class="token function">yes</span>QOM debugging     <span class="token function">yes</span>Live block migration <span class="token function">yes</span>lzo support       nosnappy support    no<span class="token function">bzip2</span> support     noNUMA <span class="token function">host</span> support notcmalloc support  nojemalloc support  noavx2 optimization <span class="token function">yes</span>replication support <span class="token function">yes</span>VxHS block device no<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Configuration complete.</code></pre><h3 id="gettid-错误">gettid 错误</h3><blockquote><p>error: static declaration of ‘gettid’ follows non-static declaration  261 | _syscall0(int, gettid)</p></blockquote><p><a href="https://blog.csdn.net/geniusle201/article/details/111028697">AFL QEMU模式安装报错（afl-2.52b &amp; qemu-2.10.0）[已解决]</a></p><h3 id="util-memfd-c-40-12-error-static-declaration-of-‘memfd-create-错误">util/memfd.c:40:12: error: static declaration of ‘memfd_create 错误</h3><p><a href="https://blog.csdn.net/liyihao17/article/details/109981662">【AFL-qemu安装问题】出现util/memfd.c:40:12: error: static declaration of ‘memfd_create’ follows non-static d</a></p><pre class="language-shell" data-language="shell"><code class="language-shell">$ ./build_qemu_support.sh········省略编译过程········<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Build process successful<span class="token operator">!</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Copying binary<span class="token punctuation">..</span>.-rwxr-xr-x <span class="token number">1</span> root root <span class="token number">14238392</span> Apr <span class="token number">10</span> 07:54 <span class="token punctuation">..</span>/afl-qemu-trace<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Successfully created <span class="token string">'../afl-qemu-trace'</span><span class="token builtin class-name">.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Testing the build<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Instrumentation tests passed.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All set, you can now use the -Q mode <span class="token keyword">in</span> afl-fuzz<span class="token operator">!</span><span class="token comment"># 将afl-qemu-trace 放到与afl-fuzz 同目录下(/usr/local/bin) 并将此目录添加到环境变量即可</span></code></pre></div><h2 id="编写C-代码测试">编写C++代码测试</h2><div class="story post-story"><pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;signal.h&gt;using namespace std;void test (string buf) &#123;    int len &#x3D; buf.length();    if (( len &#x3D;&#x3D; 6  &amp;&amp; buf[0] &#x3D;&#x3D; &#39;s&#39; &amp;&amp; buf[1]&#x3D;&#x3D;&#39;i&#39; &amp;&amp; buf[2]&#x3D;&#x3D;&#39;z&#39;)||(len &gt;&#x3D;7 &amp;&amp; buf[0]&#x3D;&#x3D;&#39;x&#39; &amp;&amp; buf[1]&#x3D;&#x3D;&#39;i&#39; &amp;&amp; buf[2]&#x3D;&#x3D;&#39;d&#39; &amp;&amp; buf[3]&#x3D;&#x3D;&#39;i&#39;&amp;&amp; buf[4]&#x3D;&#x3D;&#39;a&#39; &amp;&amp; buf[5]&#x3D;&#x3D;&#39;n&#39;))&#123;        cout&lt;&lt;&quot;awesome found sizaif !&quot;&lt;&lt;endl;        raise(SIGSEGV);    &#125;    else&#123;        cout&lt;&lt;&quot;sorry not&quot;&lt;&lt;endl;    &#125;&#125;int main(int argc, char *argv[]) &#123;    string buf &#x3D; &quot;&quot;;    cin&gt;&gt;buf;    test(buf);    return 0;&#125;</code></pre></div><h2 id="编译并进行fuzz">编译并进行fuzz</h2><div class="story post-story"><pre class="language-bash" data-language="bash"><code class="language-bash">$ root@2d34b521fdd5:/home/workhome/afl-test/insc++<span class="token comment"># afl-fuzz -Q -i in -o crash_qemu ./afltestc++2</span>afl-fuzz <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> You have <span class="token number">16</span> CPU cores and <span class="token number">4</span> runnable tasks <span class="token punctuation">(</span>utilization: <span class="token number">25</span>%<span class="token punctuation">)</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Try parallel <span class="token function">jobs</span> - see /usr/local/share/doc/afl/parallel_fuzzing.txt.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking CPU core loadout<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Found a <span class="token function">free</span> CPU core, binding to <span class="token comment">#0.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking core_pattern<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Setting up output directories<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Output directory exists but deemed OK to reuse.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Deleting old session data<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Output <span class="token function">dir</span> cleanup successful.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Scanning <span class="token string">'in'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> No auto-generated dictionary tokens to reuse.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating hard links <span class="token keyword">for</span> all input files<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Validating target binary<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Attempting dry run with <span class="token string">'id:000000,orig:t.txt'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Spinning up the fork server<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All right - fork server is up.    len <span class="token operator">=</span> <span class="token number">6</span>, map size <span class="token operator">=</span> <span class="token number">58</span>, <span class="token builtin class-name">exec</span> speed <span class="token operator">=</span> <span class="token number">3060</span> us<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">test</span> cases processed.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Here are some useful stats:    Test <span class="token keyword">case</span> count <span class="token builtin class-name">:</span> <span class="token number">1</span> favored, <span class="token number">0</span> variable, <span class="token number">1</span> total       Bitmap range <span class="token builtin class-name">:</span> <span class="token number">58</span> to <span class="token number">58</span> bits <span class="token punctuation">(</span>average: <span class="token number">58.00</span> bits<span class="token punctuation">)</span>        Exec timing <span class="token builtin class-name">:</span> <span class="token number">3060</span> to <span class="token number">3060</span> us <span class="token punctuation">(</span>average: <span class="token number">3060</span> us<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> No -t option specified, so I'll use <span class="token builtin class-name">exec</span> <span class="token function">timeout</span> of <span class="token number">20</span> ms.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">set</span> and ready to roll<span class="token operator">!</span></code></pre><p><img src="https://s2.loli.net/2022/04/10/G5xzSqXviWnOQud.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/10/G5xzSqXviWnOQud.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220410161439855"></p><h3 id="crash">crash</h3><p><img src="https://s2.loli.net/2022/04/10/l3wubpCoiO6FxPd.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/10/l3wubpCoiO6FxPd.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220410161922597"></p></div>]]></content>
      
      
      <categories>
          
          <category> Master </category>
          
          <category> 论文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzing </tag>
            
            <tag> 论文 </tag>
            
            <tag> AFL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AFL学习(一)</title>
      <link href="/posts/9cd8386/"/>
      <url>/posts/9cd8386/</url>
      
        <content type="html"><![CDATA[<h1>american fuzzy lop</h1><blockquote><p>@sizaf</p></blockquote><h2 id="AFL-的模糊方法">AFL 的模糊方法</h2><div class="story post-story"><ol><li>基于改进的边缘覆盖</li><li>插桩法引导的遗传算法</li></ol><p><strong>流程：</strong></p><p><strong>插桩</strong></p><p><img src="https://s2.loli.net/2022/04/09/iUJThAQBZNGXF62.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/iUJThAQBZNGXF62.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211201143448119"></p><ol><li><p>从源码编译程序时进行插桩，以记录代码覆盖率（Code Coverage）；</p></li><li><p>选择一些输入文件，作为初始测试集加入输入队列（queue）；</p></li><li><p>将队列中的文件按一定的策略进行“突变”；</p></li><li><p>如果经过变异文件更新了覆盖范围，则将其保留添加到队列中;</p></li><li><p>上述过程会一直循环进行，期间触发了crash的文件会被记录下来。</p></li></ol><p><strong>二进制</strong></p><p><img src="Q:/whx/Dropbox/Master/paper&amp;project/fuzzer/afl/img_article/american%20fuzzy%20lop/xUp1dTYRcSakQZn.png" class="lazyload" data-srcset="Q:/whx/Dropbox/Master/paper&amp;project/fuzzer/afl/img_article/american%20fuzzy%20lop/xUp1dTYRcSakQZn.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="fuzzer"></p><p><strong>改进边缘覆盖：</strong></p><blockquote><p>向目标程序注入以下工具来记录采用了哪些分支和次数</p><ul><li>一条边表示为当前基本块(分配了一个随机常数)与前一个基本块(即元组 (prev_location, cur_location))之间的 XOR</li><li>覆盖信息存储在一个紧凑共享的64KB的哈希表中，称为跟踪位图(bitmap)</li><li>当访问一条边时，通过增加与该特定边的哈希相对应的位图中的值来记录命中</li></ul></blockquote><pre class="language-c++" data-language="c++"><code class="language-c++">cur_location &#x3D; &lt;COMPILE_TIME_RANDOM&gt;;shared_mem[cur_location ^ prev_location]++;prev_location &#x3D; cur_location &gt;&gt; 1;</code></pre><p><img src="https://s2.loli.net/2022/04/09/TROMyG8FarhglDu.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/TROMyG8FarhglDu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409092606122"></p></div><h2 id="Instrumenting-programs-for-use-with-AFL">Instrumenting programs for use with AFL</h2><div class="story post-story"><p>源代码已知的情况下：编译插桩afl工具：</p><p><strong>通用方法：</strong></p><pre class="language-shell" data-language="shell"><code class="language-shell">$ <span class="token assign-left variable">CC</span><span class="token operator">=</span>/path/to/afl/afl-gcc ./configure <span class="token comment"># c</span>$ <span class="token assign-left variable">CXX</span><span class="token operator">=</span>/path/to/afl/afl-g++ ./configure <span class="token comment"># c++</span>$ <span class="token function">make</span> clean all</code></pre><p>对于clang(afl-clang and afl-clang++) 也适用</p><pre class="language-shell" data-language="shell"><code class="language-shell">$ <span class="token assign-left variable">CC</span><span class="token operator">=</span>/path/to/afl/afl-clang-fast ./configure <span class="token punctuation">[</span><span class="token punctuation">..</span>.options<span class="token punctuation">..</span>.<span class="token punctuation">]</span>$ <span class="token assign-left variable">CXX</span><span class="token operator">=</span>/path/to/afl/afl-clang-fast++ ./configure <span class="token punctuation">[</span><span class="token punctuation">..</span>.options<span class="token punctuation">..</span>.<span class="token punctuation">]</span>$ <span class="token function">make</span></code></pre><p>测试(libraries)时， 需要找到或编写一个简单的程序，该程序从stdin或文件中读取数据，并将数据传递给测试库。</p><blockquote><p>将此可执行文件链接到已检测库的静态版本，或者确保在运行时加载正确的**.so**文件(通常通过设置<code>LD_LIBRARY _PATH</code>)。最简单的选择是静态构建，通常通过</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">$ CC<span class="token punctuation">(</span>C++<span class="token punctuation">)</span><span class="token operator">=</span>/path/to/afl/afl-XXX ./configure --disable-shared</code></pre></div><h2 id="Instrumenting-binary-only-apps">Instrumenting binary-only apps</h2><div class="story post-story"><p>无法获得源码时，针对二进制文件进行fuzzer， 使用<code>QEMU</code></p><pre class="language-shell" data-language="shell"><code class="language-shell">$ <span class="token builtin class-name">cd</span> qemu_mode$ ./build_qemu_support.sh</code></pre></div><h2 id="源码">源码</h2><div class="story post-story"><ul><li>afl-analyze：用来对用例进行分析，发现其中有意义的字段。</li><li>afl-clang++：相当于c++的编译器的封装。</li><li>afl-fuzz：AFL主体，用于对目标程序进行fuzz。</li><li>afl-gcc：相当于gcc的封装。</li><li>afl-plot：生成模糊测试任务的状态图。</li><li>afl-tmin：对用例进行简化。</li><li>afl-clang：相当于c的编译器封装。</li><li>afl-cmin：对用例进行简化。</li><li>afl-g++：相当于g++的封装。</li><li>afl-gotcpu：用于查看当前CPU状态。</li><li>afl-showmap：用于对单个用例执行路径跟踪。</li><li>afl-whatsup：用于查看fuzz任务当前的状态。</li><li>alf-clang-fast: 基于LLVM高效clang针对c</li><li>afl-clang-fast++: 基于LLVM高效clang针对c++</li></ul></div><h2 id="输出">输出</h2><div class="story post-story"><p><strong>解释输出</strong></p><p>在输出目录中创建了三个子目录并实时更新</p><ol><li><code>queue/</code> 每个独特的执行路径的测试用例，加上用户给出的所有开始文件。这就是第2节提到的合成语料。在将这个语料库用于任何其他目的之前，您可以使用<code>afl-cmin</code>工具将它缩小到更小的大小。该工具将找到提供同等边缘覆盖的较小文件子集。</li><li><code>crashes/</code> 导致被测试程序接收致命信号的唯一测试用例(例如SIGSEGV, SIGILL, SIGABRT)。这些条目按接收到的信号分组。</li><li><code>hangs/</code>  导致被测试程序超时的唯一测试用例。在某些东西被归类为挂起之前的默认时间限制大于1秒和<code>-t</code>参数的值。可以通过设置<code>AFL_HANG_TMOUT</code>来微调该值，但很少需要这样做。</li></ol></div><h2 id="运行含义">运行含义</h2><div class="story post-story"><p><img src="https://s2.loli.net/2022/04/09/vqBMwJTgDVLjIKd.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/vqBMwJTgDVLjIKd.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409160927874"></p><pre class="language-none"><code class="language-none">1) Process timing 指示了Fuzzer测试的时间消耗 +----------------------------------------------------+ |        run time : 0 days, 8 hrs, 32 min, 43 sec    | |   last new path : 0 days, 0 hrs, 6 min, 40 sec     | | last uniq crash : none seen yet                    | |  last uniq hang : 0 days, 1 hrs, 24 min, 32 sec    | +----------------------------------------------------+</code></pre><ol><li>process timing 指示了Fuzzer测试的时间消耗</li><li>run time: 运行总时间</li><li>last new path: path(触发新执行的测试用例的缩写)，上次执行测试用例的时间,长时间未变化说明有程序有问题，过于简单无分支或内存太小会收到一个红色警告</li><li>last uniq crash: 上次崩溃的时间</li><li>last uniq hang: 上次挂起的时间</li></ol><pre class="language-none"><code class="language-none">2) Overall results 汇总了fuzzer测试的执行结果。  +-----------------------+  |  cycles done : 0      |  |  total paths : 2095   |  | uniq crashes : 0      |  |   uniq hangs : 19     |  +-----------------------+</code></pre><ol><li>cycle done: 表明fuzzer的轮数<ol><li>颜色说明<ol><li>品红色处于 the first pass，</li><li>如果有新发现，颜色会变成黄色，</li><li>所有子过程完成后将会变成蓝色，</li><li>最后变成绿色的话表明已经长时间没有新的动作了，此时也提示我们应该手动ctrl-c去关闭fuzzing。</li></ol></li></ol></li><li>total paths: 目前为止执行的测试用例</li><li>uniq crashes: 目前为止发现的崩溃</li><li>uniq hang: 目前为止发现的挂起</li></ol><pre class="language-none"><code class="language-none">3) Cycle progress 展示了当前队列中fuzzer 执行了多少  +-------------------------------------+  |  now processing : 1296 (61.86%)     |  | paths timed out : 0 (0.00%)         |  +-------------------------------------+</code></pre><ol><li>ow processing: 当前测试用例的进程的ID 因为fuzzer是开启另一个进程进行测试的 结果写回共享内存中</li><li>paths timed out: 根据超时决定是否放弃</li></ol><pre class="language-none"><code class="language-none">4) Map coverage  +--------------------------------------+  |    map density : 10.15% &#x2F; 29.07%     |  | count coverage : 4.03 bits&#x2F;tuple     |  +--------------------------------------+</code></pre><ol><li><p>map density：多少个分支元组,命中，与位图的容量成比例.号码在左边描述当前输入;右边的是整体的值是输入语料库。绝对值低于二百说的是表明了以下三种情况之一</p><p>程序极其简单;它没有被正确地使用(例如，由于链接到目标的非工具副本图书馆);或者它过早地退出了您的输入测试用例。绒毛会尝试用粉红色标记，只是为了让你意识到。超过70%的百分比可能很少发生在非常复杂的程序大量使用模板生成的代码。将以红色标记高百分比。但是一般不会有红色标记除非你用的是非常复杂的软件(比如v8, perl，ffmpeg)。</p></li><li><p>count coverage：另一行处理元组命中次数的可变性二进制文件。本质上，如果每一个被取的分支总是取一个固定数量的对于我们尝试过的所有输入，这将是“1.00”。当我们管理为了触发每个分支的其他命中计数，指针将开始移动接近“8.00”(8位地图命中的每一个位)，但可能永远不会达到这一极端。</p></li></ol><pre class="language-none"><code class="language-none">5) Stage progress 进一步展示了fuzzer的执行过程细节。  +-------------------------------------+  |  now trying : interest 32&#x2F;8         |  | stage execs : 3996&#x2F;34.4k (11.62%)   |  | total execs : 27.4M                 |  |  exec speed : 891.7&#x2F;sec             |  +-------------------------------------+</code></pre><ol><li><p>now trying: 指明当前所用的变异输入的方法</p><p>参数含义</p><ol><li>calibration – 在fuzzing测试之前的阶段，主要是检查执行路径检测异常，建立基线执行速度。</li><li>trim L/S – 同样也是在fuzzing测试之前的阶段，修建测试用例使其更短，但保证裁剪后仍能达到相同的执行路径。L表示length长度，S表示stepover步距，其值与文件大小是相关的。</li><li>bitflip L/S – 确定性的比特位翻转。以S为增量，L长度的bit数被翻转。有以下几种变型模式：1/1, 2/1, 4/1, 8/8, 16/8, 32/8。</li><li>arith L/8 – 确定性的算术运算。AFL会尝试去减去或者加上一些整数使其为8bit/16bit/32bit的值，步距永远是8bits。</li><li>interest L/8 – 确定性的值覆盖。AFL自身保留了一些Interesting的8bit/16bit/32bit的值，用这些值去覆盖原有的测试用例，步距永远是8bits。</li><li>extras – 确定性的字典注入。这里AFL自身有一个字典，当然也可以使用-x选项来指明使用用户提供的字典。</li><li>havoc – 固定长度的堆叠随机扭曲。该阶段会尝试位翻转，用随机数或者Interesting的整数去覆盖，块删除，块复制，以及字典的相关操作。</li><li>splice – 最后一种策略。在上述策略都执行完后将会执行该策略，它和havoc差不多，不过它会首先将队列中的两个随机输入先拼接在一起。</li><li>sync – 这个是并行执行的策略选项，通过-M或者-S选项进行指定。该策略并不会涉及到真正的fuzzing，会导入从另一个fuzzer得到的输出和测试用例。</li></ol></li></ol><p>以上所有策略执行一遍也就是前文提到的the first pass。</p><ol start="2"><li><p>stage execs: 当前阶段的进度指示</p></li><li><p>total execs: 全局的进度指示</p></li><li><p>exec speed: 执行速度但是基准测试应该理想地超过500次执行/秒大多数时候——如果它保持在100以下，这项工作可能会非常长。fuzzer也会明确地警告你缓慢的目标。如果发生这种情况,查看fuzzer中包含的perf_tips.txt文件，了解如何提高速度的事情了。</p></li></ol><pre class="language-none"><code class="language-none">6) Findings in depth 应该是种子变异产生的信息  +--------------------------------------+  | favored paths : 879 (41.96%)         |  |  new edges on : 423 (20.19%)         |  | total crashes : 0 (0 unique)         |  |  total tmouts : 24 (19 unique)       |  +--------------------------------------+</code></pre><ol><li><p>favored paths: 基于最小化算法产生新的更好的路径</p></li><li><p>new edges on: 基于更好路径产生的新边</p></li><li><p>total crashes: 基于更好路径产生的崩溃</p></li><li><p>total tmouts: 基于更好路径产生的超时 包括所有超时的超时 即使这些超时不足以分类到hangs.</p></li></ol><pre class="language-none"><code class="language-none">7) Fuzzing strategy yields 进一步展示了AFL所做的工作，在更有效路径上得到的结果比例 针对的应该是上文的 stage progress的now trying一栏的参数  +-----------------------------------------------------+  |   bit flips : 57&#x2F;289k, 18&#x2F;289k, 18&#x2F;288k             |  |  byte flips : 0&#x2F;36.2k, 4&#x2F;35.7k, 7&#x2F;34.6k             |  | arithmetics : 53&#x2F;2.54M, 0&#x2F;537k, 0&#x2F;55.2k             |  |  known ints : 8&#x2F;322k, 12&#x2F;1.32M, 10&#x2F;1.70M            |  |  dictionary : 9&#x2F;52k, 1&#x2F;53k, 1&#x2F;24k                   |  |       havoc : 1903&#x2F;20.0M, 0&#x2F;0                       |  |        trim : 20.31%&#x2F;9201, 17.05%                   |  +-----------------------------------------------------+</code></pre><ol><li>bit flips: 确定性的比特位翻转。以S为增量，L长度的bit数被翻转。有以下几种变型模式：1/1, 2/1, 4/1, 8/8, 16/8, 32/8。</li><li>byte flips: 这个应该就是字节翻转了</li><li>arithmetics: – 确定性的算术运算。AFL会尝试去减去或者加上一些整数使其为8bit/16bit/32bit的值，步距永远是8bits。</li><li>known ints:</li><li>dictionary:</li><li>havoc:– 固定长度的堆叠随机扭曲。该阶段会尝试位翻转，用随机数或者Interesting的整数去覆盖，块删除，块复制，以及字典的相关操作。</li><li>trim:– 同样也是在fuzzing测试之前的阶段，修建测试用例使其更短，但保证裁剪后仍能达到相同的执行路径。L表示length长度，S表示stepover步距，其值与文件大小是相关的。 这个修剪策略有一些不同/ 这一行中的第一个数字显示了从输入中删除的字节的比率，第二个数字表示实现这一目标需要的执行数，第三个数字显示了字节的比例，尽管不可能移除，被视为没有效果，在进行效果更好的fuzzer步骤的时候不是考虑的因素</li></ol><pre class="language-none"><code class="language-none">8) Path geometry 汇总了路径测试的相关信息。  +---------------------+  |    levels : 5       |  |   pending : 1570    |  |  pend fav : 583     |  | own finds : 0       |  |  imported : 0       |  | stability : 100.00% |  +---------------------+</code></pre><ol><li><p>levels: 表示测试等级</p></li><li><p>pending: 表示还没有经过fuzzing的输入数量</p></li><li><p>pend fav: 表明fuzzer感兴趣的输入数量</p></li><li><p>own finds: 表示在fuzzing过程中新找到的，或者是并行测试从另一个实例导入的</p></li><li><p>imported: n/a表明不可用，即没有导入</p></li><li><p>stability: 表明相同输入是否产生了相同的行为，一般结果都是100%，如果低于100%并且变红，则需要查阅官方文档寻找解决步骤。</p></li></ol><pre class="language-none"><code class="language-none">  9) CPU load    [cpu: 25%]显示了本地系统上的CPU利用率。它是计算处于“可运行”状态的进程数，然后将其与系统上的逻辑核数进行比较。绿色-则表示使用的CPU核比可用的少红色-则表示您的CPU可能已经超额订阅运行额外的fuzzers可能不会给你带来任何好处</code></pre><p>1</p><pre class="language-none"><code class="language-none"> 10) Addendum: status and plot filesFor unattended operation, some of the key status screen information can be alsofound in a machine-readable format in the fuzzer_stats file in the outputdirectory. This includes: - start_time     - unix time indicating the start time of afl-fuzz - last_update    - unix time corresponding to the last update of this file - fuzzer_pid     - PID of the fuzzer process - cycles_done    - queue cycles completed so far - execs_done     - number of execve() calls attempted - execs_per_sec  - current number of execs per second - paths_total    - total number of entries in the queue - paths_found    - number of entries discovered through local fuzzing - paths_imported - number of entries imported from other instances - max_depth      - number of levels in the generated data set - cur_path       - currently processed entry number - pending_favs   - number of favored entries still waiting to be fuzzed - pending_total  - number of all entries waiting to be fuzzed - stability      - percentage of bitmap bytes that behave consistently - variable_paths - number of test cases showing variable behavior - unique_crashes - number of unique crashes recorded - unique_hangs   - number of unique hangs encountered - command_line   - full command line used for the fuzzing session - slowest_exec_ms- real time of the slowest execution in ms - peak_rss_mb    - max rss usage reached during fuzzing in mb</code></pre></div><h2 id="c-编译插桩测试">c 编译插桩测试</h2><div class="story post-story"><h3 id="编写alftestc代码">编写alftestc代码</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//afltestc.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span><span class="token keyword">void</span> <span class="token function">test</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'s'</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'z'</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'i'</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'f'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"awesome found sizaif !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token function">raise</span><span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sorry not\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>           <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">test</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="创建configure-makefile等文件">创建configure makefile等文件</h3><pre class="language-bash" data-language="bash"><code class="language-bash">root@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># ls</span>Makefile.am  aclocal.m4  autom4te.cache  compile   config.h.in  configure     depcomp     missingMakefile.in  afltestc.c  autoscan.log    config.h  config.log   configure.ac  install-sh  stamp-h1</code></pre><h3 id="使用afl-gcc-插桩">使用<code>afl-gcc</code> 插桩</h3><h4 id="afl-gcc插桩">afl-gcc插桩</h4><pre class="language-shell" data-language="shell"><code class="language-shell">root@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># CC=afl-gcc ./configure</span>checking <span class="token keyword">for</span> a BSD-compatible install<span class="token punctuation">..</span>. /usr/bin/install -cchecking whether build environment is sane<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> a thread-safe <span class="token function">mkdir</span> -p<span class="token punctuation">..</span>. /usr/bin/mkdir -pchecking <span class="token keyword">for</span> gawk<span class="token punctuation">..</span>. nochecking <span class="token keyword">for</span> mawk<span class="token punctuation">..</span>. mawkchecking whether <span class="token function">make</span> sets <span class="token variable"><span class="token variable">$(</span>MAKE<span class="token variable">)</span></span><span class="token punctuation">..</span>. <span class="token function">yes</span>checking whether <span class="token function">make</span> supports nested variables<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> gcc<span class="token punctuation">..</span>. afl-gccchecking whether the C compiler works<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> C compiler default output <span class="token function">file</span> name<span class="token punctuation">..</span>. a.outchecking <span class="token keyword">for</span> suffix of executables<span class="token punctuation">..</span>.checking whether we are cross compiling<span class="token punctuation">..</span>. nochecking <span class="token keyword">for</span> suffix of object files<span class="token punctuation">..</span>. ochecking whether we are using the GNU C compiler<span class="token punctuation">..</span>. <span class="token function">yes</span>checking whether afl-gcc accepts -g<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> afl-gcc option to accept ISO C89<span class="token punctuation">..</span>. none neededchecking whether afl-gcc understands -c and -o together<span class="token punctuation">..</span>. <span class="token function">yes</span>checking whether <span class="token function">make</span> supports the include directive<span class="token punctuation">..</span>. <span class="token function">yes</span> <span class="token punctuation">(</span>GNU style<span class="token punctuation">)</span>checking dependency style of afl-gcc<span class="token punctuation">..</span>. gcc3checking that generated files are newer than configure<span class="token punctuation">..</span>. <span class="token keyword">done</span>configure: creating ./config.statusconfig.status: creating Makefileconfig.status: creating config.hconfig.status: executing depfiles commands</code></pre><h4 id="编译运行">编译运行</h4><pre class="language-shell" data-language="shell"><code class="language-shell">root@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># make afl_harden=1</span><span class="token function">make</span>  all-ammake<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Entering directory <span class="token string">'/home/workhome/afl-test/ins-c'</span>afl-gcc -DHAVE_CONFIG_H -I.     -g -O2 -MT afltestc.o -MD -MP -MF .deps/afltestc.Tpo -c -o afltestc.o afltestc.cafl-cc <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span>afltestc.c: In <span class="token keyword">function</span> <span class="token string">'main'</span><span class="token builtin class-name">:</span>afltestc.c:26:5: warning: implicit declaration of <span class="token keyword">function</span> <span class="token string">'gets'</span><span class="token punctuation">;</span> did you mean <span class="token string">'fgets'</span>? <span class="token punctuation">[</span>-Wimplicit-function-declaration<span class="token punctuation">]</span>   <span class="token number">26</span> <span class="token operator">|</span>     gets<span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token operator">|</span>     ^~~~      <span class="token operator">|</span>     fgetsafl-as <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Instrumented <span class="token number">11</span> locations <span class="token punctuation">(</span><span class="token number">64</span>-bit, non-hardened mode, ratio <span class="token number">100</span>%<span class="token punctuation">)</span>.<span class="token function">mv</span> -f .deps/afltestc.Tpo .deps/afltestc.Poafl-gcc  -g -O2   -o afltestc afltestc.oafl-cc <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span>/usr/bin/ld: afltestc.o: <span class="token keyword">in</span> <span class="token keyword">function</span> <span class="token variable"><span class="token variable">`</span>main':/home/workhome/afl-test/ins-c/afltestc.c:26: warning: the <span class="token variable">`</span></span>gets<span class="token string">' function is dangerous and should not be used.make[1]: Leaving directory '</span>/home/workhome/afl-test/ins-c'</code></pre><p><strong>创建 <code>in</code>,<code>crash</code> 文件夹</strong></p><p><code>in</code> 中创建初始seed ： <code>hello.txt</code></p><pre class="language-none"><code class="language-none"># hello.txthello</code></pre><p><strong>afl-fuzz 运行</strong></p><pre class="language-shell" data-language="shell"><code class="language-shell">$ afl-fuzz -d -i <span class="token keyword">in</span> -o crash ./afltestc root@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># afl-fuzz -d -i in -o crash ./afltestc </span>afl-fuzz <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> You have <span class="token number">16</span> CPU cores and <span class="token number">3</span> runnable tasks <span class="token punctuation">(</span>utilization: <span class="token number">19</span>%<span class="token punctuation">)</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Try parallel <span class="token function">jobs</span> - see /usr/local/share/doc/afl/parallel_fuzzing.txt.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking CPU core loadout<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Found a <span class="token function">free</span> CPU core, binding to <span class="token comment">#0.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking core_pattern<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Setting up output directories<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Scanning <span class="token string">'in'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> No auto-generated dictionary tokens to reuse.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating hard links <span class="token keyword">for</span> all input files<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Validating target binary<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Attempting dry run with <span class="token string">'id:000000,orig:hello.txt'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Spinning up the fork server<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All right - fork server is up.    len <span class="token operator">=</span> <span class="token number">6</span>, map size <span class="token operator">=</span> <span class="token number">4</span>, <span class="token builtin class-name">exec</span> speed <span class="token operator">=</span> <span class="token number">164</span> us<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">test</span> cases processed.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Here are some useful stats:    Test <span class="token keyword">case</span> count <span class="token builtin class-name">:</span> <span class="token number">1</span> favored, <span class="token number">0</span> variable, <span class="token number">1</span> total       Bitmap range <span class="token builtin class-name">:</span> <span class="token number">4</span> to <span class="token number">4</span> bits <span class="token punctuation">(</span>average: <span class="token number">4.00</span> bits<span class="token punctuation">)</span>        Exec timing <span class="token builtin class-name">:</span> <span class="token number">164</span> to <span class="token number">164</span> us <span class="token punctuation">(</span>average: <span class="token number">164</span> us<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> No -t option specified, so I'll use <span class="token builtin class-name">exec</span> <span class="token function">timeout</span> of <span class="token number">20</span> ms.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">set</span> and ready to roll<span class="token operator">!</span></code></pre><p><img src="https://s2.loli.net/2022/04/09/5rqBUlQ6nkDWhdb.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/5rqBUlQ6nkDWhdb.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409151131697"></p><p><img src="https://s2.loli.net/2022/04/09/WVeSbI89NMZFPTH.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/WVeSbI89NMZFPTH.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409152000552"></p><h4 id="crash">crash</h4><blockquote><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'s'</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'z'</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'i'</span> <span class="token operator">&amp;&amp;</span> buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'f'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"awesome found sizaif !\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">raise</span><span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sorry not\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>当输入seed 突变为sizaif，且长度为6时，crash</p></blockquote><p><img src="https://s2.loli.net/2022/04/09/ZE27aljhT1tzOP9.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/ZE27aljhT1tzOP9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409152818414"></p><h4 id="plot">plot</h4><p><img src="https://s2.loli.net/2022/04/09/JAGgVauxpSNECt7.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/JAGgVauxpSNECt7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409155148688"></p><h3 id="使用afl-clang-fast-插桩">使用<code>afl-clang-fast</code> 插桩:</h3><pre class="language-shell" data-language="shell"><code class="language-shell">root@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># CC=afl-clang-fast ./configure</span>checking <span class="token keyword">for</span> a BSD-compatible install<span class="token punctuation">..</span>. /usr/bin/install -cchecking whether build environment is sane<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> a thread-safe <span class="token function">mkdir</span> -p<span class="token punctuation">..</span>. /usr/bin/mkdir -pchecking <span class="token keyword">for</span> gawk<span class="token punctuation">..</span>. nochecking <span class="token keyword">for</span> mawk<span class="token punctuation">..</span>. mawkchecking whether <span class="token function">make</span> sets <span class="token variable"><span class="token variable">$(</span>MAKE<span class="token variable">)</span></span><span class="token punctuation">..</span>. <span class="token function">yes</span>checking whether <span class="token function">make</span> supports nested variables<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> gcc<span class="token punctuation">..</span>. afl-clang-fastchecking whether the C compiler works<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> C compiler default output <span class="token function">file</span> name<span class="token punctuation">..</span>. a.outchecking <span class="token keyword">for</span> suffix of executables<span class="token punctuation">..</span>.checking whether we are cross compiling<span class="token punctuation">..</span>. nochecking <span class="token keyword">for</span> suffix of object files<span class="token punctuation">..</span>. ochecking whether we are using the GNU C compiler<span class="token punctuation">..</span>. <span class="token function">yes</span>checking whether afl-clang-fast accepts -g<span class="token punctuation">..</span>. <span class="token function">yes</span>checking <span class="token keyword">for</span> afl-clang-fast option to accept ISO C89<span class="token punctuation">..</span>. none neededchecking whether afl-clang-fast understands -c and -o together<span class="token punctuation">..</span>. <span class="token function">yes</span>checking whether <span class="token function">make</span> supports the include directive<span class="token punctuation">..</span>. <span class="token function">yes</span> <span class="token punctuation">(</span>GNU style<span class="token punctuation">)</span>checking dependency style of afl-clang-fast<span class="token punctuation">..</span>. gcc3checking that generated files are newer than configure<span class="token punctuation">..</span>. <span class="token keyword">done</span>configure: creating ./config.statusconfig.status: creating Makefileconfig.status: creating config.hconfig.status: executing depfiles commands</code></pre><h4 id="编译运行-2">编译运行</h4><pre class="language-shell" data-language="shell"><code class="language-shell">oot@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># make afl_harden=1</span><span class="token function">make</span>  all-ammake<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Entering directory <span class="token string">'/home/workhome/afl-test/ins-c'</span>afl-clang-fast -DHAVE_CONFIG_H -I.     -g -O2 -MT afltestc.o -MD -MP -MF .deps/afltestc.Tpo -c -o afltestc.o afltestc.cafl-clang-fast <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lszekeres@google.com<span class="token operator">></span>afltestc.c:26:5: warning: implicit declaration of <span class="token keyword">function</span> <span class="token string">'gets'</span> is invalid <span class="token keyword">in</span> C99 <span class="token punctuation">[</span>-Wimplicit-function-declaration<span class="token punctuation">]</span>    gets<span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>    ^afl-llvm-pass <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lszekeres@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Instrumented <span class="token number">11</span> locations <span class="token punctuation">(</span>non-hardened mode, ratio <span class="token number">100</span>%<span class="token punctuation">)</span>.<span class="token number">1</span> warning generated.<span class="token function">mv</span> -f .deps/afltestc.Tpo .deps/afltestc.Poafl-clang-fast  -g -O2   -o afltestc afltestc.oafl-clang-fast <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lszekeres@google.com<span class="token operator">></span>/usr/bin/ld: afltestc.o: <span class="token keyword">in</span> <span class="token keyword">function</span> <span class="token variable"><span class="token variable">`</span>main':/home/workhome/afl-test/ins-c/afltestc.c:26: warning: the <span class="token variable">`</span></span>gets<span class="token string">' function is dangerous and should not be used.make[1]: Leaving directory '</span>/home/workhome/afl-test/ins-c'</code></pre><p><strong>创建 <code>in</code>,<code>crash</code> 文件夹</strong></p><p><code>in</code> 中创建初始seed ： <code>hello.txt</code></p><pre class="language-none"><code class="language-none"># hello.txtabc</code></pre><p><strong>afl-fuzz 运行</strong></p><pre class="language-shell" data-language="shell"><code class="language-shell">$ afl-fuzz -d -i <span class="token keyword">in</span> -o crash2 ./afltestc root@0187031113b5:/home/workhome/afl-test/ins-c<span class="token comment"># afl-fuzz -d -i in -o crash2 ./afltestc</span>afl-fuzz <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> You have <span class="token number">16</span> CPU cores and <span class="token number">2</span> runnable tasks <span class="token punctuation">(</span>utilization: <span class="token number">12</span>%<span class="token punctuation">)</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Try parallel <span class="token function">jobs</span> - see /usr/local/share/doc/afl/parallel_fuzzing.txt.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking CPU core loadout<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Found a <span class="token function">free</span> CPU core, binding to <span class="token comment">#0.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking core_pattern<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Setting up output directories<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Scanning <span class="token string">'in'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> No auto-generated dictionary tokens to reuse.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating hard links <span class="token keyword">for</span> all input files<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Validating target binary<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Attempting dry run with <span class="token string">'id:000000,orig:hello.txt'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Spinning up the fork server<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All right - fork server is up.    len <span class="token operator">=</span> <span class="token number">4</span>, map size <span class="token operator">=</span> <span class="token number">3</span>, <span class="token builtin class-name">exec</span> speed <span class="token operator">=</span> <span class="token number">152</span> us<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">test</span> cases processed.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Here are some useful stats:    Test <span class="token keyword">case</span> count <span class="token builtin class-name">:</span> <span class="token number">1</span> favored, <span class="token number">0</span> variable, <span class="token number">1</span> total       Bitmap range <span class="token builtin class-name">:</span> <span class="token number">3</span> to <span class="token number">3</span> bits <span class="token punctuation">(</span>average: <span class="token number">3.00</span> bits<span class="token punctuation">)</span>        Exec timing <span class="token builtin class-name">:</span> <span class="token number">152</span> to <span class="token number">152</span> us <span class="token punctuation">(</span>average: <span class="token number">152</span> us<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> No -t option specified, so I'll use <span class="token builtin class-name">exec</span> <span class="token function">timeout</span> of <span class="token number">20</span> ms.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">set</span> and ready to roll<span class="token operator">!</span></code></pre><p><img src="https://s2.loli.net/2022/04/09/vqBMwJTgDVLjIKd.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/vqBMwJTgDVLjIKd.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409160927874"></p><h4 id="crash-2">crash</h4><p><img src="https://s2.loli.net/2022/04/09/bRylPJwx65SAt1s.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/bRylPJwx65SAt1s.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409174504054"></p><h4 id="plot-2">plot</h4><p><img src="https://s2.loli.net/2022/04/09/XsQVZDbJR3Ny8eI.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/XsQVZDbJR3Ny8eI.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409161251733"></p></div><h2 id="c-编译插桩测试-2">c++ 编译插桩测试</h2><div class="story post-story"><p>编写<code>afltestc++</code>代码</p><pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;iostream&gt;#include &lt;string&gt;#include &lt;signal.h&gt;using namespace std;void test (string buf) &#123;    int len &#x3D; buf.length();    if ( len &#x3D;&#x3D; 6  &amp;&amp; buf[0] &#x3D;&#x3D; &#39;s&#39; &amp;&amp; buf[1]&#x3D;&#x3D;&#39;i&#39; &amp;&amp; buf[2]&#x3D;&#x3D;&#39;z&#39;)&#123;        cout&lt;&lt;&quot;awesome found sizaif !&quot;&lt;&lt;endl;        raise(SIGSEGV);    &#125;    else&#123;        cout&lt;&lt;&quot;sorry not&quot;&lt;&lt;endl;    &#125;&#125;int main(int argc, char *argv[]) &#123;        string buf &#x3D; &quot;&quot;;    cin&gt;&gt;buf    test(buf);    return 0;&#125;</code></pre><h3 id="使用afl-g-插桩">使用<code>afl-g++</code>插桩 :</h3><pre class="language-shell" data-language="shell"><code class="language-shell">root@0187031113b5:/home/workhome/afl-test/ins-c++<span class="token comment"># afl-g++ -g -o afltestc++ afltestc++.cpp</span>afl-cc <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span>afl-as <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Instrumented <span class="token number">41</span> locations <span class="token punctuation">(</span><span class="token number">64</span>-bit, non-hardened mode, ratio <span class="token number">100</span>%<span class="token punctuation">)</span>.</code></pre><p><strong>运行</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">root@0187031113b5:/home/workhome/afl-test/ins-c++<span class="token comment"># afl-fuzz -b 6 -i in -o crashc++ ./afltestc++</span>afl-fuzz <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lcamtuf@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> You have <span class="token number">16</span> CPU cores and <span class="token number">2</span> runnable tasks <span class="token punctuation">(</span>utilization: <span class="token number">12</span>%<span class="token punctuation">)</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Try parallel <span class="token function">jobs</span> - see /usr/local/share/doc/afl/parallel_fuzzing.txt.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking CPU core loadout<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Found a <span class="token function">free</span> CPU core, binding to <span class="token comment">#6.</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Checking core_pattern<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Setting up output directories<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Scanning <span class="token string">'in'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> No auto-generated dictionary tokens to reuse.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Creating hard links <span class="token keyword">for</span> all input files<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Validating target binary<span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Attempting dry run with <span class="token string">'id:000000,orig:hello.txt'</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Spinning up the fork server<span class="token punctuation">..</span>.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All right - fork server is up.    len <span class="token operator">=</span> <span class="token number">29</span>, map size <span class="token operator">=</span> <span class="token number">15</span>, <span class="token builtin class-name">exec</span> speed <span class="token operator">=</span> <span class="token number">212</span> us<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">test</span> cases processed.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Here are some useful stats:    Test <span class="token keyword">case</span> count <span class="token builtin class-name">:</span> <span class="token number">1</span> favored, <span class="token number">0</span> variable, <span class="token number">1</span> total       Bitmap range <span class="token builtin class-name">:</span> <span class="token number">15</span> to <span class="token number">15</span> bits <span class="token punctuation">(</span>average: <span class="token number">15.00</span> bits<span class="token punctuation">)</span>        Exec timing <span class="token builtin class-name">:</span> <span class="token number">212</span> to <span class="token number">212</span> us <span class="token punctuation">(</span>average: <span class="token number">212</span> us<span class="token punctuation">)</span><span class="token punctuation">[</span>*<span class="token punctuation">]</span> No -t option specified, so I'll use <span class="token builtin class-name">exec</span> <span class="token function">timeout</span> of <span class="token number">20</span> ms.<span class="token punctuation">[</span>+<span class="token punctuation">]</span> All <span class="token builtin class-name">set</span> and ready to roll<span class="token operator">!</span></code></pre><p><img src="https://s2.loli.net/2022/04/09/5MWHpylXSQdutNs.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/5MWHpylXSQdutNs.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409173924093"></p><h4 id="crash-3">crash</h4><p><img src="https://s2.loli.net/2022/04/09/42QSkZyDRvE9scV.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/42QSkZyDRvE9scV.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409174042577"></p><h4 id="plot-3">plot</h4><p><img src="https://s2.loli.net/2022/04/09/DVgvcniK7sxuZlr.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/DVgvcniK7sxuZlr.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409175654831"></p><h3 id="使用afl-clang-fast">使用<code>afl-clang-fast</code>++</h3><pre class="language-shell" data-language="shell"><code class="language-shell">root@0187031113b5:/home/workhome/afl-test/ins-c++<span class="token comment"># afl-clang-fast++ -g -o afltestc++clang afltestc++.cpp</span>afl-clang-fast <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lszekeres@google.com<span class="token operator">></span>afl-llvm-pass <span class="token number">2</span>.57b by <span class="token operator">&lt;</span>lszekeres@google.com<span class="token operator">></span><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Instrumented <span class="token number">127</span> locations <span class="token punctuation">(</span>non-hardened mode, ratio <span class="token number">100</span>%<span class="token punctuation">)</span>.</code></pre><p><img src="https://s2.loli.net/2022/04/09/amPrf153LI6QMVF.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/amPrf153LI6QMVF.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409173933365"></p><h4 id="crash-4">crash</h4><p><img src="https://s2.loli.net/2022/04/09/QFZKcG1nihuBXH4.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/QFZKcG1nihuBXH4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409174149786"></p><h4 id="plot-4">plot</h4><p><img src="https://s2.loli.net/2022/04/09/4tLJcNTPnIuHmvY.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/09/4tLJcNTPnIuHmvY.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220409174621876"></p></div>]]></content>
      
      
      <categories>
          
          <category> Master </category>
          
          <category> 论文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzing </tag>
            
            <tag> 论文 </tag>
            
            <tag> AFL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 下C/C++ 生成Configure 和Makefile</title>
      <link href="/posts/f4dff8fd/"/>
      <url>/posts/f4dff8fd/</url>
      
        <content type="html"><![CDATA[<h1>linux 下C/C++ 生成Configure 和Makefile</h1><h2 id="前提：">前提：</h2><div class="story post-story"><p>automake</p></div><h2 id="简要步骤">简要步骤</h2><div class="story post-story"><ol><li><p>编写test.c</p></li><li><p>运行<code>autoscan</code></p></li><li><p>运行<code>mv configure.scan configure.ac</code></p></li><li><p>修改<code>configure.ac</code>中内容</p><pre class="language-none"><code class="language-none"># -*- Autoconf -*-# Process this file with autoconf to produce a configure script. AC_PREREQ([2.69])AC_INIT(test, 1.0, sizaif@mail.com)AC_CONFIG_SRCDIR([test.cpp])AC_CONFIG_HEADERS([config.h])AM_INIT_AUTOMAKE # 增加# Checks for programs.AC_PROG_CXXAC_PROG_CC # Checks for libraries. # Checks for header files. # Checks for typedefs, structures, and compiler characteristics.AC_TYPE_SIZE_T # Checks for library functions.AC_CONFIG_FILES([Makefile])</code></pre></li><li><p>运行<code>aclocal</code></p></li><li><p>创建<code>Makefile.am</code></p><pre class="language-none"><code class="language-none">AUTOMAKE_OPTIONS&#x3D;foreign # 固定写法bin_PROGRAMS&#x3D;test # 生成的可执行文件名称test_SOURCES&#x3D;test.c # 可执行文件名称_SOURCES</code></pre></li><li><p>运行<code>automake --add-missing</code></p></li><li><p>运行<code>autoconf</code> 生成<code>configure</code> 文件</p></li><li><p>执行<code>./configure</code>就可以得到<code>Makefile</code> , 以及<code>config.h</code>文件</p></li></ol></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> make </tag>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>模糊测试技术</title>
      <link href="/posts/d619a3ee/"/>
      <url>/posts/d619a3ee/</url>
      
        <content type="html"><![CDATA[<h1>模糊测试技术</h1><blockquote><p>2022-01-09-</p></blockquote><p>[TOC]</p><p>模糊测试基本流程:  预处理(preprocessing)、输入数据构造(input building)、输入选择(input selection)、评估(evalution)、结果分析(post-fuzzing)</p><p>2013年AFL诞生,基于<font color='red'>覆盖率引导</font>的模糊测试成为主流方向</p><p>AFL 是覆盖率为导向的模糊测试工具,通过插桩的方法,采集输入数据对应的边覆盖率,作为模糊测试种子选取的衡量指标．通过使用进化算法以及精心构造的突变策略</p><h2 id="预处理">预处理</h2><div class="story post-story"><p>工作: <strong>搜集目标相关信息</strong>并制定模糊测试的策略, 为监控目标在测试中的运行状态做必要的准备．通常依赖于<font color='red'>插桩、符号执行以及污点分析</font>这类程序分析技术</p><p>搜集目标相关信息,比如目标的输入数据格式、目标的内部结构,并为监控测试中目标的状态变化做必要的准备．该环节面临的挑战是:使用什么程序分析技术,以及模糊测试究竟需要对目标内部信息有多详细的了解</p><p>根据模糊测试对程序内部信息分析的程度,现代的模糊测试方法可以划分为３类:<font color='orange'>黑盒模糊测试 (blackＧboxfuzzing)、灰盒模糊测试(greyＧboxfuzzing) 和白盒模糊测试(whiteＧboxfuzzing)</font></p><h3 id="1-插桩">1. 插桩:</h3><p>插桩技术通过向目标的代码中合适的位置添加预设好的代码,获得程序的静态或动态执行信息．比如程序的抽象语法树,覆盖率以及函数内变量取值等</p><p><strong>动态插桩</strong></p><p>动态插桩则是在运行的过程中对运行过的代码 进行插桩．比如利用 QEMU等模拟技术,进行动态插桩,可以获得程序运行时的信息,<font color='green'>缺点是资源的开销大</font></p><p><strong>静态插桩</strong></p><p>通过 GCC编译器在汇编语言上插 桩,LLVM在生成的中间语言LLVMIR(low level virtual machine intermediate representation)上插桩．<font color='green'>优点是节省时间、速度快,缺点是依赖于程序源码．</font></p><p><font color='red'>插桩技术的缺点是会带来资源的开销</font></p><h3 id="2-符号执行">2. 符号执行</h3><p>将程序行为的推理归结为逻辑领域的推理,通过构建一个表示程序执行的逻辑公式,可以同时推断一个程序在不同输入上的行为．</p><blockquote><p>该方法可以使模糊测试获得较好的覆盖率,并可以深入到程序深处,探寻可能存在漏洞的区域</p></blockquote><p><strong>静态符号执行</strong></p><p><font color='purple'>静态符号执行通常会因为程序中循环和递归的存在,陷入到路径爆炸中,还会因为路径约束中包含诸如取Hash值等操作,导致约束求解失败．</font>由于存在这2种问题,使用较多的是动态符号执行</p><p><strong>动态符号执行</strong></p><p>动态符号执行通过对程序进行<strong>实际执行与符号化执行</strong>,维护程序的实际状态和符号化状态,<font color='red'>通过将难以求解的约束替换为实际值</font>,缓解了静态符号执行的问题,并按照<font color='red'>深度优先</font>的搜索策略对目标程序进行了探索．</p><p>存在的问题:</p><p>①由于程序分支的存在,路径爆炸的问题仍然存在,程序越复杂, 路径爆炸的问题就越严重．<font color='orange'>解决的一种办法是通过启发式的方法,选择比较重要的路径进行探索．</font></p><p>②虽然动态符号执行使用实际值替换的方法,解决了一 部分静态符号执行无法绕过的约束,但是也会丢失 一些路径,造成探索结果的不完整．</p><p>③所有的符号执行技术都受限于约束求解方法的能力,比如如何处理类似取余操作这样的非线性约束,仍然是符号执行面临的挑战</p><blockquote><p>为了能够将符号执行更好地应用到模糊测试中,近年来诞生了一些工作,</p><p>比如Pangolin 通过 [22] 允许符号执行重用之前的计算结果,</p><p>Intriguer通 [23]过利用字段级的信息,都实现了对符号执行过程的加速．</p><p>ILF[24] 通过使用神经网络,对由符号执行专家生成的大量高质量输入数据进行学习,得到了合适 的模糊测试策略<br>[２２] Huang Heqing,Yao Peisen,Wu Rongxin,et al．Pangolin incremental hybrid fuzzing with polyhedral path abstraction [C]∕∕ Procofthe２０２０IEEE Sympon Security and Privacy (SP)．Piscataway,NJ:IEEE,２０２０:１６１３１６２７<br>[２３] Cho M,Kim S,Kwon T．Intriguer field-level constraint solving for hybrid fuzzing [C]∕∕ procofthe２０１９ ACM SIGSAC Conf on Computer and Communications Security． New York: ACM,２０１９:５１５５３０<br>[２４] He Jingxuan,Balunovi M,AmbroladzeN,et al．Learning to fuzz from symbolic execution with application to smart contracts[C]∕∕Procofthe２０１９ ACM SIGSAC Conf on Computer and Communications Security．New York:A CM, ２０１９:５３１５４８</p></blockquote><h3 id="3-污点分析">3. 污点分析</h3><p>该技术会观测程序中,哪些程序数据受到了预先准备好的污染源(比如输入)的污染,目的是跟踪污染源和汇聚点(比如有敏感信息的程序数据)之间的信息流</p><p><strong>静态污点分析</strong></p><p>静态污点分析不需要程序实际运行,通过对程序静态分析,获得程序控制流图、抽象语法树等信息, 依据数据流以及依赖关系进行污点分析;</p><p><strong>动态污点分析</strong></p><p>动态污点分析则是在程序实际执行的过程中,利用程序的动态执行信息进行污点分析</p><p><font color='red'>动态污点分析检测的可信度更高,但是检测结果是否全面, 取决于动态污点分析对程序的覆盖情况,而且动态污点分析会消耗更多的资源; 静态污点分析又会和符号执行一样,可能会陷入到路径爆炸中,而简化后的静态污点分析又存在着严重的过度污染问题</font></p><blockquote><p>将污点分析技术应用到模糊测试中,并降低其资源消耗是近年来的重要研究方向．比如GREYONE [２５]尝试通过减少污点分析跟踪的对象、降低污点分析的开销、提升模糊测试的检测效率．</p><p>[２５] GanShuitao,ZhangChao,ChenPeng,etal．GREYONE dataflowsensitivefuzzing[C]∕∕Procofthe２９thUSENIX SecuritySymposium．Berkeley,CA:USENIXAssociation, ２０２０:２５７７２５９４</p></blockquote></div><h2 id="基于AFL的模糊测试方法">基于AFL的模糊测试方法</h2><div class="story post-story"><p><img src="https://s2.loli.net/2022/01/09/MzWb9LFIg58cjJm.png" class="lazyload" data-srcset="https://s2.loli.net/2022/01/09/MzWb9LFIg58cjJm.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220109150026279"></p><p><img src="https://s2.loli.net/2022/01/09/g5TyonYkvzxDFui.png" class="lazyload" data-srcset="https://s2.loli.net/2022/01/09/g5TyonYkvzxDFui.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220109150051850"></p><p><img src="https://s2.loli.net/2022/01/09/KxD8LUgl1sQbZC9.png" class="lazyload" data-srcset="https://s2.loli.net/2022/01/09/KxD8LUgl1sQbZC9.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220109150137214"></p></div><h2 id="输入构造">输入构造</h2><div class="story post-story"><pre><code>种子获取、种子筛选、种子突变</code></pre><p><font color='cornflowerblue'>具体的挑战是如何在尽量满足语法语义检查的情况下,短时间内生成 大量的输入,用以对目标做全面而深入分析．</font></p><p><font color='green'>首先得到一个数据 $S$ ,然后数据 $S$ 按照一 定的策略进行一定次数的变异,获得大量新数据 $I$ , 最后将$I$输入到被测试对象中进行测试．其中数据 $S$ 被称为种子(seed), $I$ 是测试实际使用的输入数据</font></p></div><h2 id="评估">评估</h2><div class="story post-story"><p>现阶段的研究都会聚焦于模糊测试器在２个指标上的表现:<font color='red'>覆盖率和暴露漏洞平均时间</font></p><p><font color='cornflowerblue'>覆盖率是软件测试中的一个衡量指标,指的是在测试过程中,对象被覆盖到的数目占总数的比例． 通常而言,高覆盖率更可能发现更多的隐藏漏洞,众多研究因此集中在覆盖率提升上</font></p><p>AFL 使用上下文无关的边覆盖率作为评估指标． [13]</p><p>Angora 使用上下文敏感的分支覆盖率．[42]</p><p>VUzzer 使用了块覆盖率替代边覆盖率作为覆盖率评估的对象．[41]</p><p>暴露漏洞平均时间:</p><blockquote><p>暴露 漏 洞 平 均 时 间 被 Böhme４６] AFLGo 选 做 评 估 指 标．在 与 基 准 模 糊 工 具 [４６] AFL 的对比实验中,AFLGo 复现单个漏洞的 [１３] [４６] 时间远比AFL少,这证明了该评估指标的有效性． 此后Hawakeye[４７] 同样使用了这一指标来证明其性 能．Parmesan 在通过sanitizer来发现潜在漏洞的 [６３] 研究工作中,也是用暴露漏洞平均时间作为评估指 标同Angora [４２] 等定向灰盒模糊工具进行比较</p></blockquote></div><h2 id="结果分析">结果分析</h2><div class="story post-story"><p>结果分析发生在模糊测试结束以后,主要目的是对于模糊测试的输出信息进行分析和处理</p></div><h2 id="具体应用场景下的模糊测试">具体应用场景下的模糊测试</h2><div class="story post-story"><h3 id="物联网中的模糊测试">物联网中的模糊测试</h3><p>主要面临两个问题:</p><ol><li>将模糊测试应用到物联网领域问题就是特定物联网设备上运行的程序通常对于其实际硬件的配置有着高度的依赖性．</li></ol><p>​简单的从固件中提取一个用户级别的程序,然后使用模糊测试进行检测,通常是行不通的</p><blockquote><p>Iot-Fuzzer[３０] 认为大多数物联网设备通过其官方移动应用程序进行控制,并且此类应用程序通常包含有与设备进行通信所使用协议的丰富信息,因此通过识别和重用特定于程序的逻辑(比如加密)来改变测试用例(尤其是消息字段),就能够有效地对物联网目标进行模糊测试,而无需依赖于有关其协议规范的任何知识．</p></blockquote><ol start="2"><li><p>物联网设备远远无法满足模糊测试需要的吞吐率</p><blockquote><p>多项研究成果表明物联网设备采用全仿真的系统,可以获得最高的吞吐量,这是因为真实的物联网设备相比于桌面工作站或者服务器要慢得多</p></blockquote></li></ol><h3 id="内核安全中的模糊测试">内核安全中的模糊测试</h3><p>内核模糊测试通常利用暴露出来的系统调用接口和外围接口,从用户空间进入到内核组件中进行模糊测试,以检测内核中可能存在的漏洞</p><p>主要面临的问题:</p><ol><li>Windows内核程序以及很多相关组件的源代码并 不开源,将导致传统的反馈机制不再适用．</li><li>内核中的代码由于存在中断、多线程操作等机制,使得模糊测试变的很复杂．</li><li>内核模糊测试一旦检测到程序的崩溃,将会导致整个操作系统重新启动,极大地影响了模糊测试的效率．</li></ol><blockquote><p>为了克服这些问题,产生了一些专门针对内核安全进行模糊测试的研究,</p><p>比如syzkaller [７０] 是由Google开发的一种以获得高覆盖率为导向的内核 模糊测试工具,目前实际使用比较多,并经常被用于对比实验中．</p><p>Razzer[７１] 是基于syzkaller [７０] 通过使用LLVM和修改后的SVF技术针对内核中存在的数据争用问题进行的模糊测试</p><p>TriforceAFL[３６] AFL [１３]的QEMU模式,在系统模拟器的帮助下,通过跟踪分支信息,对Linux的内核进行模糊测试．</p><p>kAFL[３７] 通过利用Intel提供的进程追踪技术,获取代码运行时的控制流信息,并通过使用Intel的硬件 虚拟特征(VTＧx)提升效率并使得kAFL[３７] 独立于特定的操作系统</p></blockquote><blockquote><p>传统的模糊测试应用到内核模糊测试上将面临着众多的问题,包 括内核态代码的复杂执行环境,以及内核崩溃的处 理问题．另外内核安全面临的威胁来源是不确定的, 可以是外部固件,也可以是第三方开发的驱动程序, 还可以是内核程序自身设计的问题．模糊测试在内 核安全领域的应用还有待进一步的研究．</p></blockquote><p>静态分析或模糊检测技术通常对内存溢出等漏洞有效,而无法挖掘协议实现库的逻辑漏洞.</p><p>通过提取安全协议实现的状态机,能够实现对协议实现的形式化建模.</p></div>]]></content>
      
      
      <categories>
          
          <category> Master </category>
          
          <category> 论文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fuzzing </tag>
            
            <tag> 论文 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tlspuffin-Docker:changelog</title>
      <link href="/posts/95953aea/"/>
      <url>/posts/95953aea/</url>
      
        <content type="html"><![CDATA[<div class="timeline"><div class="timenode"><div class="meta"><p><p><code>1.6.0</code></p></p></div><div class="body"><ul><li>修复deps/rust-openssl-src 文件权限<ul><li><code>util/dmod</code> 权限问题</li></ul></li><li>修复 <code>makedepend: not found</code><ul><li>apt-get install xutils-dev</li></ul></li><li>修改主版本号</li><li>pust到dcokerhub</li><li>稳定版本</li></ul></div></div><div class="timenode"><div class="meta"><p><p><code>1.3.0</code> - <code>1.5.0</code></p></p></div><div class="body"><ul><li>修复编译错误</li></ul></div></div><div class="timenode"><div class="meta"><p><p><code>1.2.0</code></p></p></div><div class="body"><ul><li>增加openssl1.01f的依赖</li></ul></div></div><div class="timenode"><div class="meta"><p><p><code>1.1.0</code></p></p></div><div class="body"><ul><li>增加openssl1.01f支持</li></ul></div></div><div class="timenode"><div class="meta"><p><p><code>1.0.0</code></p></p></div><div class="body"><ul><li>移植到docker中</li><li>初始src</li></ul></div></div></div>]]></content>
      
      
      <categories>
          
          <category> Master </category>
          
          <category> 论文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Master </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tlspuffin 切换LUT版本</title>
      <link href="/posts/ed5ef6e5/"/>
      <url>/posts/ed5ef6e5/</url>
      
        <content type="html"><![CDATA[<h2 id="说明">说明</h2><div class="story post-story"><p><strong>当前的缺陷</strong></p><p>只有<code>openssl1.1.1k</code> 和<code>libressl</code>（存疑) 支持<code>Security Violation Oracle</code></p><blockquote><p>文献8.2.2节</p><p><strong>Improved Security Violation Oracle</strong></p><p>In Section 5.2 we designed a bug oracle which is able to check security properties. Right now we only check after successful handshakes whether no security violation happened. For example whether a downgrade or authentication bypass happened. This could be extended by also verifying invariants during the execution of a handshake. That way we could for example detect the FREAK vulnerability automatically.</p><p>Furthermore, the security violation oracle could also be extended to other TLS implementations.<br><font color='red'><strong>Right now only OpenSSL 1.1.1k is supported</strong>.</font> Support for checking security violations could be ported to LibreSSL 3.3.3 and backported to OpenSSL 1.0.x.</p></blockquote><p>那么切换到其他版本的时候，暂时不能使用<code>Oracle</code></p></div><h2 id="deps的关系">deps的关系</h2><div class="story post-story"><p><img src="https://s2.loli.net/2022/03/04/O32BfHNia9tK8eh.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/04/O32BfHNia9tK8eh.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220304204130691"></p><ol><li>Tlspuffin 顶层 Cargo.toml中定义 features中<code>openssl</code>版本, 以及依赖<code>rust-openssl/openssl</code></li><li><code>rust-openssl/openssl</code> Cargo.toml中定义<code>vendored-openssl</code>版本，以及依赖<code>openssl-sys</code></li><li><code>openssl-sys</code>  Cargo.toml中定义细化的<code>vendored-openssl</code>版本，以及依赖<code>openssl-srs</code></li></ol><pre class="language-none"><code class="language-none">功能: cfg定义对应的openssl版本绑定路径: src&#x2F;openssl_binding.rs&#x2F;fn create_openssl_server功能: 定义features对应的版本源码位置路径: deps&#x2F;rust-openssl-src&#x2F;src&#x2F;lib.rs&#x2F;fn source_dir</code></pre></div><h2 id="步骤">步骤</h2><div class="story post-story"><ol><li><code>rust-openssl-src</code> 文件存放 openssl的各版本源码</li><li>修改<code>Tlspuffin </code>顶层<code>Cargo.toml</code> 添加版本名称</li><li>根据依赖依次添加版本信息</li><li>在两个路径文件中添加对应的信息</li></ol></div><h2 id="编译其他版本">编译其他版本</h2><div class="story post-story"><p><strong>方式一：</strong></p><p>修改 顶层<code>Cargo.toml</code> 文件中 [features] 项中 default 参数</p><pre class="language-toml" data-language="toml"><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">features</span><span class="token punctuation">]</span><span class="token key property">default</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"sancov_libafl"</span><span class="token punctuation">,</span> <span class="token string">"openssl111j"</span><span class="token punctuation">,</span> <span class="token string">"introspection"</span><span class="token punctuation">]</span></code></pre><p><strong>方式二：</strong></p><p>使用<code>cargo </code> 命令 添加参数</p><pre class="language-shell" data-language="shell"><code class="language-shell">$ cargo run --no-default-features --features openssl102u,sancov_libafl,introspection</code></pre><blockquote><p>sancov_libafl,introspection 必须项</p></blockquote></div>]]></content>
      
      
      <categories>
          
          <category> Master </category>
          
          <category> 论文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Master </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Miui13-mi10s刷twrp和Magisk</title>
      <link href="/posts/9d7955fe/"/>
      <url>/posts/9d7955fe/</url>
      
        <content type="html"><![CDATA[<h2 id="前言">前言</h2><div class="story post-story"><p>待手机解锁BL锁后,</p><p>尝试开始刷机</p><p>目标:</p><ol><li>刷SkyMi星空包-<code>miui13</code> 官改包高级包</li><li>刷入<code>Magisk v24.1</code>面具</li><li>以及EDXP,实现绕过<code>ROOT</code>检测</li></ol></div><h2 id="步骤">步骤</h2><div class="story post-story"><h3 id="解BL锁">解BL锁</h3><p><strong>前提条件</strong></p><ul><li>手机与账号绑定168h</li><li>电脑安装好相应的adb驱动</li><li>电脑安装好mifash驱动</li></ul><p>连接手机，手机设置<code>usb调试</code>后, 开启<code>OEM调试</code> 在<code>platform-tools</code>目录下</p><p>先查看是否连接成功</p><pre class="language-shell" data-language="shell"><code class="language-shell">$./adb.exe devices</code></pre><p>进入<code>fastboot</code>模式</p><pre class="language-shell" data-language="shell"><code class="language-shell">$./adb.exe <span class="token function">reboot</span> bootloader</code></pre><p>电脑进入miflash 登录账号后进行解锁</p><h3 id="刷入Twrp">刷入Twrp</h3><p><strong>前提条件</strong></p><ul><li>BL已解锁</li><li>需要PC /笔记本电脑和USB数据线</li><li>电脑安装好相应的adb驱动</li><li>电脑安装好mifash驱动</li><li>提前下载好对应的<code>Twrp</code>版本</li><li>提前做好备份</li><li>手机有足够的电量</li><li>USB Drivers: <a href="https://www.getdroidtips.com/download-latest-xiaomi-usb-drivers/">Xiaomi USB Drivers</a></li><li><a href="https://www.getdroidtips.com/download-adb/">Download ADB and Fastboot</a> and install them on your PC</li></ul><p><strong>TWRP Recovery Details</strong></p><table><thead><tr><th>File Name</th><th>TWRP Recovery</th></tr></thead><tbody><tr><td>Version</td><td>3.6.0</td></tr><tr><td>Support</td><td>Unofficial</td></tr><tr><td>Developer</td><td><a href="https://forum.xda-developers.com/m/theromfan.11952709/">TheRomFan</a></td></tr></tbody></table><p>连接手机，手机设置<code>usb调试</code>后,开启<code>OEM调试</code> 在<code>platform-tools</code>目录下</p><ol><li>进入<code>fastboot</code>模式</li></ol><pre class="language-shell" data-language="shell"><code class="language-shell">$./adb.exe <span class="token function">reboot</span> bootloader</code></pre><ol start="2"><li>查看<code>fastboot</code>设备信息</li></ol><pre class="language-shell" data-language="shell"><code class="language-shell">$./fastboot.exe devices</code></pre><p><strong>Devices with A/B partition scheme</strong></p><p>twrp.img为下载的twrp名称</p><ol start="3"><li>刷入boot ， 临时进入twrp</li></ol><pre class="language-shell" data-language="shell"><code class="language-shell">$./fastboot.exe boot twrp.img</code></pre><ol start="4"><li>将twrp.img文件复制到设备</li></ol><pre class="language-shell" data-language="shell"><code class="language-shell">$ ./adb.exe push twrp.img /sdcard</code></pre><ol start="5"><li>进入到twrp中</li></ol><pre class="language-shell" data-language="shell"><code class="language-shell">$./fastboot.exe oem reboot-recovery</code></pre><ol start="6"><li>选择 <code>Install Recovery Ramdisk</code></li></ol><p><img src="https://s2.loli.net/2022/03/08/gM71anPeEkvd8tO.jpg" class="lazyload" data-srcset="https://s2.loli.net/2022/03/08/gM71anPeEkvd8tO.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Install recovery ramdisk option under TWRP"></p><ol start="7"><li>选择刚刚复制进去的<code>twrp.img</code></li><li>重启recovery</li></ol><h3 id="安装Magisk">安装Magisk</h3><p><font color='red'>magisk root权限的正确获得方法是修补你目前系统的boot，再通过电脑adb命令刷入修补后的boot。</font></p><p><font color='cornflowerblue'>错误方法: 先获得官方root权限，再给magisk manager权限来让其直接刷入magisk来获得root权限。</font></p><blockquote><p>首先要有一个概念，小米11（后文均代指出厂就是安卓11）的手机与之前的小米/红米是不一样的（哪怕后来从10升级了安卓11），小米11使用的是V a/b的分区形式。不同于其他手机，其他手机的启动流程图可以大致参考一下</p></blockquote><p><img src="https://s2.loli.net/2022/03/01/aK9d4kNcVB1AM6b.jpg" class="lazyload" data-srcset="https://s2.loli.net/2022/03/01/aK9d4kNcVB1AM6b.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><ol><li><p>拿到<code>boot.img</code></p><p>新版本需要先解压payload.bin，然后需要一个工具来二次解包工具在这里 <a href="aili.lanzoux.com/ii2lkkp079g">aili.lanzoux.com/ii2lkkp079g</a>密码:5b8x)<br>这个工具很简单，包里也有readme，大概意思就是把payload.bin放入input，运行exe，到output去找解压出的boot.img包就行</p></li><li><p>手机上安装Magisk Manager</p><p>将刚刚提取到的boot.img移到手机里，打开梯或者更改面具的自定义通道，</p><p>然后回到主界面选择Magisk的安装</p><p><img src="https://s2.loli.net/2022/03/01/GkaoXV1PgrcYqNM.jpg" class="lazyload" data-srcset="https://s2.loli.net/2022/03/01/GkaoXV1PgrcYqNM.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p></li><li><p>Magisk安装</p><p>此处选择并修补一个文件，选择到刚刚移入手机的boot.img，等待修补完成，在同目录下会生成boot_patch.img文件。</p><p>此处不可选择直接安装（推荐），原因后面会说</p></li><li><p>将这个修补的boot_patch.img移回电脑。开始线刷，</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token variable">$fastboot</span> flash boot_a boot_patched.img<span class="token variable">$fastboot</span> flash boot_b boot_patched.img</code></pre></li></ol><p><strong>为什么面具不能选择直接安装（推荐）？</strong></p><p>如果你提前已经获取了官方Root，这一步你当然可以正常运行并且刷好面具。但为了绕过银行等APPRoot检测，使的Magiskhide正常发挥作用。使用官方Root获取到面具，面具接管了你的官方Root，当你使用hide时，面具的Root被隐藏了，官方的Root就恢复了（对该应用）。所以应用能检测出Root，而且很难再把官方Root去隐藏。本教程压根就不刷官方Root直接获取面具Root，所以Magiskhide能正常发挥作用（并且大多数情况是绝对够用的）。<br>你当然也能再刷一个某某银行去Root的模块，但是不麻烦么？明明自带的腿就能发挥作用，你先砍断他的腿在给他接上，这不是多此一举？而且模块越多稳定性啊软件更新啊都是问题。一劳永逸的方法不好么？</p><h3 id="Magisk-隐藏生效">Magisk 隐藏生效</h3><p>[填坑]</p></div><h2 id="星空ROM包">星空ROM包</h2><div class="story post-story"><blockquote><p>经过测试后， 星空集成的ROM包与Twrp无法同时存在</p><ol><li>刷入Twrp后， 使用Twrp卡刷ROM后，twrp会自动回滚成官方recovery <font color="red">没刷内核的原因。</font></li><li>星空ROM自动线刷卡刷两种方式，集成Magisk。 所以没有必要使用Twrp</li></ol></blockquote><p>前提：</p><ol><li>安装好usb驱动</li><li>安装好adb命令</li></ol><p>临时使用Twrp方式：</p><pre class="language-shell" data-language="shell"><code class="language-shell">$./fastboot.exe boot twrp.img</code></pre><p>进入Twrp</p><pre class="language-shell" data-language="shell"><code class="language-shell">$./fastboot.exe oem reboot-recovery</code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Win </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastboot </tag>
            
            <tag> 驱动 </tag>
            
            <tag> miflash unlock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决Win10 Fastboot驱动问题</title>
      <link href="/posts/c1ff5c7b/"/>
      <url>/posts/c1ff5c7b/</url>
      
        <content type="html"><![CDATA[<h2 id="前言">前言</h2><div class="story post-story"><p>小米手机解锁BL,</p><p>使用从官网下载的<a href="http://miuirom.xiaomi.com/rom/u1106245679/6.5.224.28/miflash_unlock-6.5.224.28.zip">解锁工具</a> (miflash_unlock-6.5.224.28 版本自身不带win10 驱动)导致出现即使连接手机后也显示: <font color='red'>当前未连接手机</font></p><p><img src="https://s2.loli.net/2022/03/01/D5NLZIfz3wmEkJP.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/01/D5NLZIfz3wmEkJP.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220301173447180"></p></div><h2 id="解决方法">解决方法</h2><div class="story post-story"><p>下载驱动:  <a href="https://github.com/xushuan/google_latest_usb_driver_windows">google_latest_usb_driver_windows</a></p><p>解压后目录下有个: <code>android_winusb.inf</code> 文件</p><ol><li><p>打开设备管理器</p></li><li><p>其他设备里找到 <code>Android</code>类似带有!不正常驱动</p></li><li><p>更新驱动程序-&gt;浏览我的计算机以查找驱动程序</p></li><li><p>让我从计算机上的可用驱动程序列表选取-&gt;下一步-&gt;从磁盘安装</p></li><li><p><img src="https://s2.loli.net/2022/03/01/LMuSJy7ZXcKI3eO.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/01/LMuSJy7ZXcKI3eO.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p></li><li><p><img src="https://s2.loli.net/2022/03/01/Dsx7yudQF1mY83E.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/01/Dsx7yudQF1mY83E.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p></li><li><p>选择从磁盘安装</p></li><li><p>选择<code>android_winusb.inf</code>文件</p></li><li><p>下一步安装等待安装完成后即可</p></li><li><p>刷新其他设备, 驱动变的可用如图</p><p><img src="https://s2.loli.net/2022/03/01/b4Q5dCKzesGUO3h.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/01/b4Q5dCKzesGUO3h.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220301174005151"></p></li></ol></div><h2 id="安装ADB">安装ADB</h2><div class="story post-story"><p><a href="https://www.mediafire.com/file/7iaxnjqiptc3um7/platform-tools_r31.0.3-windows.zip/file">platform-tools_r31.0.3-windows.zip</a></p><ol><li>手机开发者选项里设置 USB 调试, OEM启动 后</li><li>在platform文件夹下打开控制台输入</li></ol><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 查看设备</span>$ ./adb.exe devicesList of devices attached2b24874b        device<span class="token comment"># 进入fastboot模式</span>$./adb.exe <span class="token function">reboot</span> bootloader<span class="token comment"># 等待手机进入fastboot后 查看fastboot信息</span>$ ./fastboot.exe devices2b24874b        fastboot<span class="token comment"># 手机重启</span>$ ./fastboot.exe <span class="token function">reboot</span>Rebooting                                          OKAY <span class="token punctuation">[</span>  <span class="token number">0</span>.001s<span class="token punctuation">]</span>Finished. Total time: <span class="token number">0</span>.002s</code></pre></div><h2 id="使用miflash-unlock-解BL锁">使用miflash unlock 解BL锁</h2><div class="story post-story"><p>此时登录账户后, 可正常解锁</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Win </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fastboot </tag>
            
            <tag> 驱动 </tag>
            
            <tag> miflash unlock </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AD与AAD区别和联系</title>
      <link href="/posts/2036bda7/"/>
      <url>/posts/2036bda7/</url>
      
        <content type="html"><![CDATA[<h1>AD 与AAD 的区别与联系</h1><blockquote><p>2022-01-07</p></blockquote><p>[TOC]</p><h2 id="AD是什么">AD是什么</h2><div class="story post-story"><p>Active Directory(AD) 活动目录</p><p>Active Directory (AD)是一个数据库和一组服务，将用户与他们完成工作所需的网络资源连接起来。</p><p>活动目录(Active Directory)主要提供以下功能：1、服务器及客户端计算机管理，2、用户服务，3、资源管理，4、桌面配置，5、应用系统支撑等。</p><p><strong>AD（Active Directory）概述：</strong></p><p>传统AD依赖于Kerbose进行身份验证，Kerbose又叫做三头狗，要求计算机、用户和域控三方都要参与验证。因此，在传统AD中，计算机也拥有账号，也需要加域。另外，计算机也有登录到域的过程，甚至可以授权计算机账号访问文件夹和其他资源。在传统AD中，所有以Local System、Network Service身份运行的服务在访问域中其他共享资源时，都是以计算机账户的身份进行验证的。</p><p>传统AD的登录会由用户向域控申请和计算机之间通信的会话票据(默认存活8小时)，用户登录计算机时，向计算机出示会话票据，同时加上时间戳证明没有篡改过，计算机才会授权用户登录。登录以后，会在该计算机上生成登录会话，并查询该用户所属的域组和本地组，以此来创建访问令牌，如果是本地管理员，则会生成2张访问令牌(普通用户令牌和管理员令牌)。</p><p>传统AD协议(如Kerbose和LDAP）太沉重，一般只能适合内网C/S架构，无法穿透Internet。如果要穿透Internet，通常要将其转为基于Claim的形式，例如ADFS。ADFS类似于调制解调器，能够把Kerbose协议&quot;转换&quot;为其他Internet验证协议(SAML等)，但这其实并不是真正意义上的&quot;转换&quot;。</p><h3 id="ADDS-是什么">ADDS 是什么</h3><blockquote><p><a href="https://www.quest.com/solutions/active-directory/what-is-active-directory.aspx">What is Active Directory?</a></p></blockquote><p>Active Directory Domain Services (AD DS) 域控服务</p><p>运行AD DS的服务器称为域控制器(DCs, domain controllers)</p><p>组织通常具有多个DCS，每个组织都有一个用于整个域的目录的副本。对一个域控制器上的目录 - 例如密码更新或删除用户帐户的更改将复制到其他DCS，以便它们保持最新状态。全局目录服务器是一个DC，它存储其域目录中的所有对象的完整副本以及森林中所有其他域的所有对象的部分副本;这使用户和应用程序能够在其林的任何域中查找对象。桌面，笔记本电脑和运行Windows（而不是Windows Server）的其他设备可以是Active Directory环境的一部分，但它们不会运行AD DS。AD DS依赖于多种建立的协议和标准，包括LDAP（轻量级目录访问协议），Kerberos和DNS（域名系统）。</p><p><img src="Q:/whx/Dropbox/Master/Blog/blog/source/_posts/img_article/2022-02-23-AD%E4%B8%8EAAD%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/NLRxYiBq9S2s7mX.png" class="lazyload" data-srcset="Q:/whx/Dropbox/Master/Blog/blog/source/_posts/img_article/2022-02-23-AD%E4%B8%8EAAD%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/NLRxYiBq9S2s7mX.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220107150308606"></p></div><h2 id="AAD是什么">AAD是什么</h2><div class="story post-story"><p>Azure Active Directory (Azure AD)</p><p>是 Microsoft <font color='red'>基于云的身份和访问管理服务</font>，可实现的员工登录和访问 Azure 中的资源：</p><blockquote><p><a href="https://docs.microsoft.com/zh-cn/azure/active-directory/fundamentals/active-directory-whatis">What is Azure Active Directory</a></p></blockquote><p><img src="Q:/whx/Dropbox/Master/Blog/blog/source/_posts/img_article/2022-02-23-AD%E4%B8%8EAAD%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/3ghsbeXnqIjmiSu.png" class="lazyload" data-srcset="Q:/whx/Dropbox/Master/Blog/blog/source/_posts/img_article/2022-02-23-AD%E4%B8%8EAAD%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/3ghsbeXnqIjmiSu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220107150447019"></p><p><strong>AAD（Azure Active Directory）概述</strong></p><p>Azure 提供通过AAD管理身份验证和授权的服务，AAD是一种基于云的标识服务，管理员和开发人员可以使用Azure AD配置的集中式规则和策略来控制对内部和外部数据及应用程序的访问。  AAD支持常见的Internet验证协议，例如WS-Federation、SAML等轻量级的基于Claim的验证协议。与传统AD类似，AAD同样有访问令牌，不过其中的内容是Claim属性，而且由于需要在Internet上交付，所以需要对其进行数字签名和加密。下面是AAD主要包含的四个服务：</p><ul><li><p>身份验证： 包括验证身份以访问应用程序和资源、自助密码重置、多重身份验证（MFA）等功能。</p></li><li><p>单一登录（SSO）：用户只需记住一个ID和一个密码即可访问多个应用程序。</p></li><li><p>应用程序管理：可以使用AAD应用程序代理、SSO、“访问”面板和SaaS应用来管理云应用和本地应用。</p></li><li><p>设备管理：管理云设备或本地设备访问企业数据的方式</p></li></ul><h3 id="AADDS是什么">AADDS是什么</h3><p>Azure Active Directory Domain Services( Azure AD DS)<font color='red'> 提供托管域服务</font></p><p>类似ADDS，例如域加入、组策略、轻型目录访问协议 (LDAP) 和 Kerberos/NTLM 身份验证。 无需在云中部署、管理和修补域控制器 (DC) 即可使用这些域服务。</p><p>Azure AD DS 托管域使你能够在云中或你不希望目录查找始终返回到本地 AD DS 环境的位置，运行无法使用现代身份验证方法的旧版应用程序。 你可以将这些旧版应用程序从本地环境直接迁移到托管域，而无需在云中管理 AD DS 环境。</p><p>Azure AD DS 与现有的 Azure AD 租户集成。 通过此集成，用户可以使用其现有凭据登录到与托管域相连的服务和应用程序。 还可以使用现有组和用户帐户来保护对资源的访问。 这些功能可更顺畅地将本地资源直接迁移到 Azure。</p><blockquote><p><a href="https://docs.microsoft.com/zh-cn/azure/active-directory-domain-services/overview">什么是 Azure Active Directory 域服务</a></p></blockquote></div><h2 id="AD与AAD的区别与联系">AD与AAD的区别与联系</h2><div class="story post-story"><blockquote><p><a href="https://docs.microsoft.com/zh-cn/azure/active-directory/fundamentals/active-directory-compare-azure-ad-to-ad">将 Active Directory 与 Azure Active Directory 进行比较</a></p></blockquote><p><img src="https://s2.loli.net/2022/04/10/SXokAZFt3dbnfr8.png" class="lazyload" data-srcset="https://s2.loli.net/2022/04/10/SXokAZFt3dbnfr8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220107150753638"></p><p><img src="Q:/whx/Dropbox/Master/Blog/blog/source/_posts/img_article/2022-02-23-AD%E4%B8%8EAAD%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/8e1qBxAPUYCp3Wh.png" class="lazyload" data-srcset="Q:/whx/Dropbox/Master/Blog/blog/source/_posts/img_article/2022-02-23-AD%E4%B8%8EAAD%E5%8C%BA%E5%88%AB%E5%92%8C%E8%81%94%E7%B3%BB/8e1qBxAPUYCp3Wh.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220107185446160"></p><h3 id="AD和AAD的区别">AD和AAD的区别</h3><pre><code>    AAD与传统AD是完全不同的，前者是云服务，只管验证与授权, 而AAD更像是传统AD向云端的一个扩展，用以满足更多的应用场景与验证需求。AAD 通过为组织提供一种适用于在云中和本地所有应用的标识即服务解决方案，将目录服务方案提升到了一个新层次。同时，AAD是基于云的身份和访问管理解决方案，它也可以与本地AD同步，为本地和基于云的系统提供身份验证。AAD相较于AD的扩展功能概述如下：</code></pre><ol><li><p><strong>AAD 解决了传统AD无法扩展到外部的局限性问题</strong>。传统AD在验证和授权方面更多的是做验证，并且无法扩展到外部（受限于Kerbose和LDAP），只能局限在企业环境。而AAD恰好能够解决这一问题，它支持如OAuth2、SAML、WS-Federation和OpenID等轻量级的基于Claim的验证协议，同时也提供了Rest接口。</p></li><li><p><strong>AAD 更关注于验证与授权</strong>。除去验证，传统AD更关注于资源的发现与管理，如最常用的组策略，而这部分内容在AAD里是不关注的，AAD关注的是验证与授权，而非管理本身。</p></li><li><p><strong>AAD 通过多重身份验证和无密码技术提高了密码安全性</strong>。传统AD中的凭据基于密码、证书或智能卡的身份验证，通过密码策略来管理密码的长度、到期时间和复杂性，以此确保AD中密码的安全性；而AAD对云和本地使用智能密码保护，AAD通过多重身份验证和无密码技术显著的提高了密码安全性，同时也为用户提供了自助重置密码的功能来提升用户体验，降低技术支持成本。</p></li><li><p><strong>AAD 使用AAD应用程序代理访问本地应用</strong>。AD当中大多数本地应用都使用LDAP、NTLM或kerberos协议来控制用户的访问。AAD则可使用在本地运行的AAD应用程序代理来访问这些类型的本地应用。</p></li><li><p><strong>AAD 完全基于云</strong>。AAD 的优势在于它完全基于云所提供的灵活性，这意味着它既可以充当组织的唯一目录，也可以通过 AAD Connect 与本地AD目录服务同步。无论采取哪种方式，它都使本地和基于云的用户能够访问相同的应用程序和资源，同时受益于诸如单点登录 (SSO)、多重身份验证 (MFA)、条件访问等功能。更重要的是，它提供了一个单一位置来管理整个 IT 资产中的身份、安全性和合规性控制。</p><p>下表展示了AD与AAD的具体区别：</p></li></ol><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">On-Premises Active Directory</th><th style="text-align:center">Azure Active Directory</th></tr></thead><tbody><tr><td style="text-align:center">Authentication</td><td style="text-align:center">kerberos</td><td style="text-align:center">A number of protocols such as SAML，WS-Federation and OAuth，OIDC</td></tr><tr><td style="text-align:center">Locator mechanism</td><td style="text-align:center">DNS</td><td style="text-align:center">✗</td></tr><tr><td style="text-align:center">Structure</td><td style="text-align:center">Hierarchical(based on X.500)</td><td style="text-align:center">Flat</td></tr><tr><td style="text-align:center">Query</td><td style="text-align:center">LDAP</td><td style="text-align:center">A rest API, called AD Graph API</td></tr><tr><td style="text-align:center">Communication types</td><td style="text-align:center">All kinds of types</td><td style="text-align:center">HTTP(port 80) HTTP(port 443)</td></tr><tr><td style="text-align:center">Devices</td><td style="text-align:center">Corporate assets, mostly PC</td><td style="text-align:center">BYOD</td></tr><tr><td style="text-align:center">Focus on</td><td style="text-align:center">On-perm services</td><td style="text-align:center">Internet-based services, such as O365, Azure and Facebook(Any services federated with Azure AD)</td></tr><tr><td style="text-align:center">Domain joined</td><td style="text-align:center">✓</td><td style="text-align:center">✗</td></tr><tr><td style="text-align:center">User</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr><tr><td style="text-align:center">Group</td><td style="text-align:center">✓</td><td style="text-align:center">✓</td></tr><tr><td style="text-align:center">OU</td><td style="text-align:center">✓</td><td style="text-align:center">✗</td></tr><tr><td style="text-align:center">GPO</td><td style="text-align:center">✓</td><td style="text-align:center">✗</td></tr></tbody></table></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Azure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Azure </tag>
            
            <tag> 微软 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rust学习4-关键字</title>
      <link href="/posts/8358a15/"/>
      <url>/posts/8358a15/</url>
      
        <content type="html"><![CDATA[<h2 id="关键字">关键字</h2><div class="story post-story"><p>下面的列表包含 Rust 中正在使用或者以后会用到的关键字。因此，这些关键字不能被用作标识符（除了 “<a href="https://kaisery.github.io/trpl-zh-cn/appendix-01-keywords.html#%E5%8E%9F%E5%A7%8B%E6%A0%87%E8%AF%86%E7%AC%A6">原始标识符</a>” 部分介绍的原始标识符），这包括函数、变量、参数、结构体字段、模块、crate、常量、宏、静态值、属性、类型、trait 或生命周期 的名字。</p><h3 id="目前正在使用的关键字">目前正在使用的关键字</h3><p>如下关键字目前有对应其描述的功能。</p><ul><li><code>as</code> - 强制类型转换，消除特定包含项的 trait 的歧义，或者对 <code>use</code> 和 <code>extern crate</code> 语句中的项重命名</li><li><code>async</code> - 返回一个 <code>Future</code> 而不是阻塞当前线程</li><li><code>await</code> - 暂停执行直到 <code>Future</code> 的结果就绪</li><li><code>break</code> - 立刻退出循环</li><li><code>const</code> - 定义常量或不变裸指针（constant raw pointer）</li><li><code>continue</code> - 继续进入下一次循环迭代</li><li><code>crate</code> - <strong>链接（link）一个外部 crate 或一个代表宏定义的 crate 的宏变量</strong></li><li><code>dyn</code> - <strong>动态分发 trait 对象</strong></li><li><code>else</code> - 作为 <code>if</code> 和 <code>if let</code> 控制流结构的 fallback</li><li><code>enum</code> - 定义一个枚举</li><li><code>extern</code> - 链接一个外部 <strong>crate</strong> 、函数或变量</li><li><code>false</code> - 布尔字面值 <code>false</code></li><li><code>fn</code> - 定义一个函数或 <strong>函数指针类型</strong> (<em>function pointer type</em>)</li><li><code>for</code> - 遍历一个迭代器或实现一个 trait 或者指定一个更高级的生命周期</li><li><code>if</code> - 基于条件表达式的结果分支</li><li><code>impl</code> - <strong>实现自有或 trait 功能</strong></li><li><code>in</code> - <code>for</code> 循环语法的一部分</li><li><code>let</code> - 绑定一个变量</li><li><code>loop</code> - 无条件循环</li><li><code>match</code> - 模式匹配</li><li><code>mod</code> - 定义一个模块</li><li><code>move</code> - 使闭包获取其所捕获项的所有权</li><li><code>mut</code> - 表示引用、裸指针或模式绑定的可变性</li><li><code>pub</code> - 表示结构体字段、<code>impl</code> 块或模块的公有可见性</li><li><code>ref</code> - 通过引用绑定</li><li><code>return</code> - 从函数中返回</li><li><code>Self</code> - <strong>定义或实现 trait 的类型的类型别名</strong></li><li><code>self</code> - 表示方法本身或当前模块</li><li><code>static</code> - 表示全局变量或在整个程序执行期间保持其生命周期</li><li><code>struct</code> - 定义一个结构体</li><li><code>super</code> - 表示当前模块的父模块</li><li><code>trait</code> - <strong>定义一个 trait</strong></li><li><code>true</code> - 布尔字面值 <code>true</code></li><li><code>type</code> - 定义一个类型别名或关联类型</li><li><code>union</code> - 定义一个 <a href="https://doc.rust-lang.org/reference/items/unions.html">union</a> 并且是 union 声明中唯一用到的关键字</li><li><code>unsafe</code> - 表示不安全的代码、函数、trait 或实现</li><li><code>use</code> - 引入外部空间的符号</li><li><code>where</code> - 表示一个约束类型的从句</li><li><code>while</code> - 基于一个表达式的结果判断是否进行循环</li></ul><h3 id="保留做将来使用的关键字">保留做将来使用的关键字</h3><p>如下关键字没有任何功能，不过由 Rust 保留以备将来的应用。</p><ul><li><code>abstract</code></li><li><code>become</code></li><li><code>box</code></li><li><code>do</code></li><li><code>final</code></li><li><code>macro</code></li><li><code>override</code></li><li><code>priv</code></li><li><code>try</code></li><li><code>typeof</code></li><li><code>unsized</code></li><li><code>virtual</code></li><li><code>yield</code></li></ul></div><h2 id="原始标识符">原始标识符</h2><div class="story post-story"><p>原始标识符（Raw identifiers）允许你使用通常不能使用的关键字，其带有 <code>r#</code> 前缀。</p><p>例如，<code>match</code> 是关键字。如果尝试编译如下使用 <code>match</code> 作为名字的函数：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">match</span><span class="token punctuation">(</span>needle<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> haystack<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>    haystack<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>needle<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></code></pre><p>会得到这个错误：</p><pre class="language-text" data-language="text"><code class="language-text">error: expected identifier, found keyword `match` --> src/main.rs:4:4  |4 | fn match(needle: &amp;str, haystack: &amp;str) -> bool &#123;  |    ^^^^^ expected identifier, found keyword</code></pre><p>该错误表示你不能将关键字 <code>match</code> 用作函数标识符。你可以使用原始标识符将 <code>match</code> 作为函数名称使用：</p><p>文件名: src/main.rs</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">r</span>#<span class="token keyword">match</span><span class="token punctuation">(</span>needle<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> haystack<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>    haystack<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>needle<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token macro property">assert!</span><span class="token punctuation">(</span>r#<span class="token keyword">match</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"foobar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>此代码编译没有任何错误。注意 <code>r#</code> 前缀需同时用于函数名定义和 <code>main</code> 函数中的调用。</p><p>原始标识符允许使用你选择的任何单词作为标识符，即使该单词恰好是保留关键字。 此外，原始标识符允许你使用以不同于你的 crate 使用的 Rust 版本编写的库。比如，<code>try</code> 在 2015 edition 中不是关键字，而在 2018 edition 则是。所以如果用 2015 edition 编写的库中带有 <code>try</code> 函数，在 2018 edition 中调用时就需要使用原始标识符语法，在这里是 <code>r#try</code>。有关版本的更多信息，请参见<a href="https://kaisery.github.io/trpl-zh-cn/appendix-05-editions.html">附录 E</a>.</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rust </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rust学习3-派生-Derive</title>
      <link href="/posts/d76d00f/"/>
      <url>/posts/d76d00f/</url>
      
        <content type="html"><![CDATA[<h2 id="派生">派生</h2><div class="story post-story"><p>通过 <code>#[derive]</code> <a href="https://rustwiki.org/zh-CN/rust-by-example/attribute.html">属性</a>，编译器能够提供某些 trait 的基本实现。如果需要更复杂的行为，这些 trait 也可以手动实现。</p><p>下面是可以自动派生的 trait：</p><ul><li>比较 trait: <a href="https://rustwiki.org/zh-CN/std/cmp/trait.Eq.html"><code>Eq</code></a>, <a href="https://rustwiki.org/zh-CN/std/cmp/trait.PartialEq.html"><code>PartialEq</code></a>, <a href="https://rustwiki.org/zh-CN/std/cmp/trait.Ord.html"><code>Ord</code></a>, <a href="https://rustwiki.org/zh-CN/std/cmp/trait.PartialOrd.html"><code>PartialOrd</code></a><ul><li>Eq：<a href="https://en.wikipedia.org/wiki/Equivalence_relation">完全等价关系</a></li><li>PartialEq： <a href="https://en.wikipedia.org/wiki/Partial_equivalence_relation">部分等价关系</a></li><li>Ord：<a href="https://en.wikipedia.org/wiki/Total_order">全序关系</a></li><li>PartialOrd：比较排序顺序的值</li></ul></li><li><a href="https://rustwiki.org/zh-CN/std/clone/trait.Clone.html"><code>Clone</code></a>, 用来从 <code>&amp;T</code> 创建副本 <code>T</code>。</li><li><a href="https://rustwiki.org/zh-CN/core/marker/trait.Copy.html"><code>Copy</code></a>，使类型具有 “复制语义”（copy semantics）而非 “移动语义”（move semantics）。</li><li><a href="https://rustwiki.org/zh-CN/std/hash/trait.Hash.html"><code>Hash</code></a>，从 <code>&amp;T</code> 计算哈希值（hash）。</li><li><a href="https://rustwiki.org/zh-CN/std/default/trait.Default.html"><code>Default</code></a>, 创建数据类型的一个空实例。</li><li><a href="https://rustwiki.org/zh-CN/std/fmt/trait.Debug.html"><code>Debug</code></a>，使用 <code>&#123;:?&#125;</code> formatter 来格式化一个值。</li></ul><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// `Centimeters`，可以比较的元组结构体</span><span class="token attribute attr-name">#[derive(PartialEq, PartialOrd)]</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Centimeters</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// `Inches`，可以打印的元组结构体</span><span class="token attribute attr-name">#[derive(Debug)]</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Inches</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">impl</span> <span class="token class-name">Inches</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">to_centimeters</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Centimeters</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token operator">&amp;</span><span class="token class-name">Inches</span><span class="token punctuation">(</span>inches<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>        <span class="token class-name">Centimeters</span><span class="token punctuation">(</span>inches <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">*</span> <span class="token number">2.54</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// `Seconds`，不带附加属性的元组结构体</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Seconds</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> _one_second <span class="token operator">=</span> <span class="token class-name">Seconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 报错：`Seconds` 不能打印；它没有实现 `Debug` trait</span>    <span class="token comment">//println!("One second looks like: &#123;:?&#125;", _one_second);</span>    <span class="token comment">// 试一试 ^ 取消此行注释</span>    <span class="token comment">// 报错：`Seconds`不能比较；它没有实现 `PartialEq` trait</span>    <span class="token comment">//let _this_is_true = (_one_second == _one_second);</span>    <span class="token comment">// 试一试 ^ 取消此行注释</span>    <span class="token keyword">let</span> foot <span class="token operator">=</span> <span class="token class-name">Inches</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"One foot equals &#123;:?&#125;"</span><span class="token punctuation">,</span> foot<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> meter <span class="token operator">=</span> <span class="token class-name">Centimeters</span><span class="token punctuation">(</span><span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> cmp <span class="token operator">=</span>        <span class="token keyword">if</span> foot<span class="token punctuation">.</span><span class="token function">to_centimeters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> meter <span class="token punctuation">&#123;</span>            <span class="token string">"smaller"</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token string">"bigger"</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"One foot is &#123;&#125; than one meter."</span><span class="token punctuation">,</span> cmp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></div><h2 id="属性">属性</h2><div class="story post-story"><p>属性是应用于某些模块、crate 或项的元数据（metadata）。这元数据可以用来：</p><ul><li><a href="https://rustwiki.org/zh-CN/rust-by-example/attribute/cfg.html">条件编译代码</a></li><li><a href="https://rustwiki.org/zh-CN/rust-by-example/attribute/crate.html">设置 crate 名称、版本和类型（二进制文件或库）</a></li><li>禁用 <a href="https://en.wikipedia.org/wiki/Lint_(software)">lint</a> （警告）</li><li>启用编译器的特性（宏、全局导入（glob import）等）</li><li>链接到一个非 Rust 语言的库</li><li>标记函数作为单元测试</li><li>标记函数作为基准测试的某个部分</li></ul><p>当属性作用于整个 crate 时，它们的语法为 <code>#![crate_attribute]</code>，当它们用于模块 或项时，语法为 <code>#[item_attribute]</code>（注意少了感叹号 <code>!</code>）。</p><p>属性可以接受参数，有不同的语法形式：</p><ul><li><code>#[attribute = &quot;value&quot;]</code></li><li><code>#[attribute(key = &quot;value&quot;)]</code></li><li><code>#[attribute(value)]</code></li></ul><p>属性可以多个值，它们可以分开到多行中：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[attribute(value, value2)]</span><span class="token attribute attr-name">#[attribute(value, value2, value3,            value4, value5)]</span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rust </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rust学习2-宏与元编程</title>
      <link href="/posts/7af06751/"/>
      <url>/posts/7af06751/</url>
      
        <content type="html"><![CDATA[<h1>Rust学习2-宏与元编程</h1><blockquote><p>2022-02-04-</p></blockquote><p>[TOC]</p><h2 id="什么是元编程">什么是元编程</h2><div class="story post-story"><blockquote><p>元编程是指某类[计算机程序]的编写，这类计算机程序编写或者操纵其他程序(或者自身)作为它们的数据，或者在[运行时]完成部分本应在[编译时]完成的工作。 <strong>元编程</strong>是用来产生代码的程序，操纵代码的程序，在运行时创建和修改代码而非编程时，这种程序叫做元程序。而编写这种程序就叫做元编程。</p></blockquote><p>元编程是一种编程技术,编写能够生产新代码的代码,根据语言的不同,实现的方式有两种: 在运行时编译和在编译期.</p><p>运行时元编程可用于动态语言: 例如python,JavaScript,Lisp.</p><p>编译型语言不可能在运行时生成指令,执行程序预编译.</p><p>Rust提供编译期代码生成功能,</p><p>Rust宏不会从执行环境中捕获变量</p></div><h2 id="Rust中的宏及其类型">Rust中的宏及其类型</h2><div class="story post-story"><p>Rust宏时在抽象语法树构造的第二阶段结束时解析的, 进行名称解析的阶段, 名称解析时在作用域中查找在表达式中定义的变量是否存在的阶段.</p><p>Rust宏能够识别上下文,并根据宏扩展响应的内容,</p><p>常见的宏就是<code>println!</code> , 允许我们向<code>println</code>宏传递尽可能多的参数. Rust不支持传递函数的可变参数.</p><blockquote><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 默认用法,打印Display</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:o&#125;"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 八进制</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:x&#125;"</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 十六进制 小写</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:X&#125;"</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 十六进制 大写</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:p&#125;"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 指针</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:b&#125;"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 二进制</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:e&#125;"</span><span class="token punctuation">,</span> <span class="token number">10000f32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 科学计数(小写)</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:E&#125;"</span><span class="token punctuation">,</span> <span class="token number">10000f32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 科学计数(大写)</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 打印Debug</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:#?&#125;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"test1"</span><span class="token punctuation">,</span> <span class="token string">"test2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 带换行和缩进的Debug打印 输出非基本类型的类JSON格式的值</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;a&#125; &#123;b&#125; &#123;b&#125;"</span><span class="token punctuation">,</span> a <span class="token operator">=</span> <span class="token string">"x"</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 命名参数</span></code></pre></blockquote><h3 id="宏的类型">宏的类型</h3><ul><li>声明宏（Declarative Macro） 使用<code>macro_rules!</code>宏创建</li><li>过程宏（Procedural Macro） 更高级形式,完全控制代码的操作和生成.</li></ul><p>声明宏（Declarative Macro）和过程宏（Procedural Macro）。前者指的是用某种语法直接声明出的宏。后者是对应直接生成抽象语法树的过程的宏。直觉上过程宏更隐式，更全能；声明宏更可读，更直接。</p><p>编写一个声明宏,实例:</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span><span class="token comment">// 定义一个输入宏</span><span class="token macro property">macro_rules!</span> scanline <span class="token punctuation">&#123;</span>    <span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token function">stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> input <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">scanline!</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">" read &#123;:?&#125;"</span><span class="token punctuation">,</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>过程宏(Procedural Macro）:</p><ul><li>自定义 <code>#[derive]</code> 宏在结构体和枚举上指定通过 <code>derive</code> 属性添加的代码,在函数上使用<code>#[proc_macro_derive]</code>属性,</li><li>类属性（Attribute-like）宏定义可用于任意项的自定义属性, 在函数上使用<code>#[proc_macro_attribute]</code>属性,</li><li>类函数宏看起来像函数不过作用于作为参数传递的 token, 在函数上使用<code>#[proc_macro]</code>属性,</li></ul><h3 id="标准库中的内置宏">标准库中的内置宏</h3><ul><li><code>dbg!</code>: 允许使用他们的值输出表达式的值</li><li><code>compile_error!</code>: 在编译期从代码中报告错误.</li><li><code>concat!</code> 链接传递给它的任意数量的文字, 并将链接的文字作为<code>&amp;'static str</code>返回</li><li><code>env!</code>: 检查编译期的环境变量, 安全版本的宏为 : <code>option_env!</code></li><li><code>eprint!</code>和<code>eprintln!</code> 与<code>println!</code>类型, 将消息输出到标准异常流中</li><li><code>include_bytes!</code>: 作为一种将文件读取为字节数组的快捷方式,</li><li><code>stringify!</code>: 获得类型或标记作为字符串的字面转换</li><li><code>vec!</code>:  vector</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rust </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rust学习1-入门</title>
      <link href="/posts/dba35a1e/"/>
      <url>/posts/dba35a1e/</url>
      
        <content type="html"><![CDATA[<h1>Rust学习1-入门</h1><h2 id="安装Rust-VScode集成Rust">安装Rust &amp;VScode集成Rust</h2><div class="story post-story"><p><strong>目标:</strong></p><ul><li><p>windows 环境下使用VScode IDE 进行rust编写和测试运行</p></li><li><p>VScode集成rust</p></li></ul><h3 id="windows-安装Rust">windows 安装Rust</h3><blockquote><p>It looks like you’re running Windows. To start using Rust, download the installer, then run the program and follow the onscreen instructions. You may need to install the <a href="https://visualstudio.microsoft.com/visual-cpp-build-tools/">Visual Studio C++ Build tools</a> when prompted to do so. If you are not on Windows see <a href="https://forge.rust-lang.org/infra/other-installation-methods.html">“Other Installation Methods”</a>.</p></blockquote><ol><li><p>安装 Visual Studio 2019 的构建工具</p><p><a href="https://visualstudio.microsoft.com/visual-cpp-build-tools/">https://visualstudio.microsoft.com/visual-cpp-build-tools/</a></p><p>语言包: 选择中文和英文</p><p><img src="https://s2.loli.net/2022/02/03/xDuwtvKPmhrpsNg.png" class="lazyload" data-srcset="https://s2.loli.net/2022/02/03/xDuwtvKPmhrpsNg.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220203173414217"></p></li><li><p>安装rust</p><p><a href="https://www.rust-lang.org/tools/install">https://www.rust-lang.org/tools/install</a> 选择64位</p><p>默认安装即可</p></li><li><p>测试是否安装成功:</p><pre class="language-shell" data-language="shell"><code class="language-shell">$ cargo --versioncargo <span class="token number">1.58</span>.0 <span class="token punctuation">(</span>f01b232bc <span class="token number">2022</span>-01-19<span class="token punctuation">)</span></code></pre></li></ol><h3 id="VSCode集成rust">VSCode集成rust</h3><ol><li><p>安装<code>Rust and Friends</code> 集成包</p><p><img src="https://s2.loli.net/2022/02/03/VZbG5ERQP1iv9ND.png" class="lazyload" data-srcset="https://s2.loli.net/2022/02/03/VZbG5ERQP1iv9ND.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220203173823339"></p></li><li><p>集成包中包括: <code>rust-analyzer</code></p><p>使用rust-analyzer 进行编译运行</p></li></ol></div><h2 id="Rust语言">Rust语言</h2><div class="story post-story"><h3 id="基元类型">基元类型</h3><p>bool,char</p><p>整型 最大支持128位</p><table><thead><tr><th>有符号</th><th>无符号</th></tr></thead><tbody><tr><td>i8</td><td>u8</td></tr><tr><td>i16</td><td>u16</td></tr><tr><td>i32</td><td>u32</td></tr><tr><td>i64</td><td>u64</td></tr><tr><td>i126</td><td>u128</td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>isize</td><td>尺寸可变的有符号整型</td></tr><tr><td>usize</td><td>尺寸可变的无符号整型</td></tr><tr><td>f32</td><td>32位浮点数</td></tr><tr><td>f64</td><td>64位浮点数</td></tr><tr><td>[T,N]</td><td>固定大小的数组, T元素类型,N数组大小</td></tr><tr><td>[T]</td><td>动态大小的连续序列的视图,T任意类型</td></tr><tr><td>str</td><td>字符串切片,主要做引用, 即<code>&amp;str</code></td></tr><tr><td>(T,U,…)</td><td>有限序列,T,U为不同类型</td></tr><tr><td>fn(i32) -&gt; i32</td><td>接受i32类型参数并返回i32类型参数的函数</td></tr></tbody></table><h3 id="变量声明和不可变性">变量声明和不可变性</h3><p>使用关键字<code>let</code>声明变量, 变量初始,无法分配其他值,若要修改,则前面添加<code>mut</code>关键字</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    b <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;,&#123;&#125;"</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>报错.</p><p><img src="https://s2.loli.net/2022/02/03/s3OaXJ6Igdt7QbD.png" class="lazyload" data-srcset="https://s2.loli.net/2022/02/03/s3OaXJ6Igdt7QbD.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20220203152052669"></p><h3 id="函数">函数</h3><p>函数表示:</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">,</span><span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-></span><span class="token keyword">u64</span></code></pre><h3 id="闭包">闭包</h3><p>简单闭包, 通过a来调用, <code>||</code>内存放参数</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>实例:</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> double <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> twice <span class="token operator">=</span> <span class="token function">double</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> big_c <span class="token operator">=</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>b<span class="token punctuation">,</span>c<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> z <span class="token operator">=</span> b<span class="token operator">+</span>c<span class="token punctuation">;</span>        z <span class="token operator">*</span> twice    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> some <span class="token operator">=</span> <span class="token function">big_c</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>some<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>     <span class="token class-name">Running</span> `target\debug\helloworld<span class="token punctuation">.</span>exe`<span class="token number">30</span></code></pre><h3 id="字符串">字符串</h3><p><code>&amp;str</code>, <code>String</code> 两种类型, 保证字符串为有效的UTF-8</p><h3 id="条件和判断">条件和判断</h3><p>类似 C++ if-else</p><p>但Rust的if-else 不是语句,而是一个表达式,表达式会返回值</p><p>花括号最后一行成为表达式的返回值, if-else分支应具有相同的返回类型</p><h3 id="match-表达式">match 表达式</h3><p>类似于c语言<code>switch</code>语句</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    math a <span class="token punctuation">&#123;</span>        b <span class="token operator">=></span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        c <span class="token operator">=></span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        other <span class="token operator">=></span><span class="token punctuation">&#123;</span>            xxxx<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="循环">循环</h3><p><code>loop</code>,<code>while</code>,<code>for</code></p><p>loop 无限循环 break 跳出</p><p>rust中的<code>for</code> 循环只适用用可以转换为迭代器的类型</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">&#123;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// 0..10  0-10 不包括10 </span><span class="token comment">// 0..=10 0-10 包括10</span></code></pre><h3 id="结构体">结构体</h3><p>Rust结构体类似C语言结构体</p><p>Rust 中的结构体（Struct）与元组（Tuple）都可以将若干个类型不一定相同的数据捆绑在一起形成整体，但结构体的每个成员和其本身都有一个名字，这样访问它成员的时候就不用记住下标了。元组常用于非定义的多值传递，而结构体用于规范常用的数据结构。结构体的每个成员叫做&quot;字段&quot;。</p><p>这是一个结构体定义：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Site</span> <span class="token punctuation">&#123;</span>    domain<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    nation<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    found<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">&#125;</span></code></pre><p>注意：如果你常用 C/C++，请记住在 Rust 里 struct 语句仅用来定义，不能声明实例，结尾不需要 <strong>;</strong> 符号，而且每个字段定义之后用 <strong>,</strong> 分隔。</p><p>有一种更简单的定义和使用结构体的方式：<strong>元组结构体</strong>。</p><p>元组结构体是一种形式是元组的结构体。</p><p>与元组的区别是它有名字和固定的类型格式。它存在的意义是为了处理那些需要定义类型（经常使用）又不想太复杂的简单数据：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Color</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> black <span class="token operator">=</span> <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">let</span> origin <span class="token operator">=</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>&quot;颜色&quot;和&quot;点坐标&quot;是常用的两种数据类型，但如果实例化时写个大括号再写上两个名字就为了可读性牺牲了便捷性，Rust 不会遗留这个问题。元组结构体对象的使用方式和元组一样，通过 . 和下标来进行访问：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token type-definition class-name">Color</span><span class="token punctuation">(</span><span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">,</span> <span class="token keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span><span class="token punctuation">(</span><span class="token keyword">f64</span><span class="token punctuation">,</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> black <span class="token operator">=</span> <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> origin <span class="token operator">=</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"black = (&#123;&#125;, &#123;&#125;, &#123;&#125;)"</span><span class="token punctuation">,</span> black<span class="token number">.0</span><span class="token punctuation">,</span> black<span class="token number">.1</span><span class="token punctuation">,</span> black<span class="token number">.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"origin = (&#123;&#125;, &#123;&#125;)"</span><span class="token punctuation">,</span> origin<span class="token number">.0</span><span class="token punctuation">,</span> origin<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>Rust 语言不是面向对象的，从它所有权机制的创新可以看出这一点。但是面向对象的珍贵思想可以在 Rust 实现。</p><p>结构体方法的第一个参数必须是 <code>&amp;self</code>，不需声明类型，因为 <code>self </code>不是一种风格而是关键字。</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Rectangle</span> <span class="token punctuation">&#123;</span>    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">impl</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">fn</span> <span class="token function-definition function">output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">u32</span><span class="token punctuation">&#123;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;,"</span><span class="token punctuation">,</span><span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token keyword">self</span><span class="token punctuation">.</span>width    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> rect1 <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">&#123;</span> width<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token class-name">Rectangle</span><span class="token punctuation">::</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rect1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"rect.1调用&#123;&#125;"</span><span class="token punctuation">,</span>rect1<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>输出<span class="token punctuation">:</span><span class="token number">1500</span><span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">,</span>rect<span class="token number">.1</span>调用<span class="token number">80</span></code></pre><ul><li><code>self</code> 调用此方法后,不允许后续使用该类型</li><li><code>&amp;self</code> 类型实例的读取访问权限</li><li><code>&amp;mut self</code> 类型实例的可变访问</li></ul><h3 id="module-import-use">module,import,use</h3><p>模块</p><ul><li>每个rust程序都需要root模块, 可执行文件,<a href="http://xn--main-uh5f306f8z3f.rs">通常为main.rs</a>, 对于程序库,<a href="http://xn--lib-c88d344een2e.rs">通常为lib.rs</a></li><li>模块可以在其他模块内部声明,也可以组织为文件和目录</li><li>使用<code>mod</code>声明, 使用<code>use</code>引用</li><li>模块中定义的元素默认为私有的, 使用<code>pub</code> 公共访问</li></ul><p>Rust 中有两种简单的访问权：公共（public）和私有（private）。</p><p>默认情况下，如果不加修饰符，模块中的成员访问权将是私有的。</p><p>如果想使用公共权限，需要使用 pub 关键字。</p><p>对于私有的模块，只有在与其平级的位置或下级的位置才能访问，不能从其外部访问。</p><p>use 关键字能够将模块标识符引入当前作用域：</p><p>当存在两个相同的名称，且同样需要导入，可以使用 as 关键字为标识符添加别名：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">nation</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">government</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">govern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">govern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>   <span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>nation<span class="token punctuation">::</span>government<span class="token punctuation">::</span></span>govern<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>nation<span class="token punctuation">::</span></span>govern <span class="token keyword">as</span> nation_govern<span class="token punctuation">;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">nation_govern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">govern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>use 关键字可以与 pub 关键字配合使用：</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">nation</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">government</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">govern</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">pub</span> <span class="token keyword">use</span> <span class="token namespace">government<span class="token punctuation">::</span></span>govern<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token namespace">nation<span class="token punctuation">::</span></span><span class="token function">govern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="数组-元组-项目列表">数组,元组,项目列表</h3><p>数组具有固定长度, 存储相同类型元素, 数组大小必须是<code>usize</code>确定值,不能是变量</p><p>元组可以是不同类型, 元组是异构集合,</p><p>项目列表:  类似数组, 但内容和长度可以不用事先指定; 从堆上分配,使用<code>Vec::new</code> 构造或 宏<code>vec![]</code>创建</p><pre class="language-rust" data-language="rust"><code class="language-rust">    <span class="token keyword">let</span> <span class="token keyword">mut</span> number_vec<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span>  <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    number_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    number_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> vec_with_macro <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    vec_with_macro<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> _ <span class="token operator">=</span> vec_with_macro<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"number_vec :&#123;:?&#125;, vec_with_macro:&#123;:?&#125;"</span><span class="token punctuation">,</span>number_vec<span class="token punctuation">,</span>vec_with_macro<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> 输出<span class="token punctuation">:</span>number_vec <span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vec_with_macro<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span></code></pre><h3 id="HashMap-键-值-对">HashMap 键/值 对</h3><p>来自<code>std::collections</code> 模块</p><p>使用<code>HashMap::new</code> 创建</p><pre class="language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> fmap <span class="token operator">=</span> <span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token operator">&amp;</span>fmap<span class="token punctuation">&#123;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">" got &#123;&#125;,&#123;&#125;"</span><span class="token punctuation">,</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//fmap["a"] = 11;  错误语法</span>fmap<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span>fmap<span class="token punctuation">.</span><span class="token function">get_mut</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span><span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"fmap[\"a\"] : &#123;&#125;"</span><span class="token punctuation">,</span>fmap<span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>修改内容无法直接使用<code>fmap[&quot;a&quot;] = 11; </code> 进行修改</p><blockquote><p><a href="http://doc.rust-lang.org/std/collections/struct.HashMap.html"><code>HashMap</code></a> does not implement <code>IndexMut</code>, while <a href="http://doc.rust-lang.org/std/vec/struct.Vec.html"><code>Vec</code> does</a>.</p></blockquote><p>修改方法:</p><p>若famp存在其值的话, 直接用insert方法修改</p><p>若不确定可以使用: <code> *fmap.get_mut(&quot;a&quot;).unwrap() = 13;</code> 这种方法</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Rust </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Rust </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Azure RBAC</title>
      <link href="/posts/e56d5251/"/>
      <url>/posts/e56d5251/</url>
      
        <content type="html"><![CDATA[<h1>Azure RBAC</h1><p><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/overview">https://docs.microsoft.com/zh-cn/azure/role-based-access-control/overview</a></p><p><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/conditions-overview">https://docs.microsoft.com/zh-cn/azure/role-based-access-control/conditions-overview</a></p><p><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/rbac-and-directory-admin-roles">https://docs.microsoft.com/zh-cn/azure/role-based-access-control/rbac-and-directory-admin-roles</a></p><h2 id="什么是-Azure-基于角色的访问控制-Azure-RBAC-？">什么是 Azure 基于角色的访问控制 (Azure RBAC)？</h2><div class="story post-story"><h3 id="Azure-RBAC-有什么用途？">Azure RBAC 有什么用途？</h3><p>下面是 Azure RBAC 的用途的一些示例：</p><ul><li>让一个用户管理订阅中的虚拟机，另一个用户管理虚拟网络</li><li>让 DBA 组管理订阅中的 SQL 数据库</li><li>让某个用户管理资源组中的所有资源，例如虚拟机、网站和子网</li><li>允许某个应用程序访问资源组中的所有资源</li></ul><h3 id="Azure-RBAC-的工作原理">Azure RBAC 的工作原理</h3><p>使用 Azure RBAC 控制资源访问权限的方式是分配 Azure 角色。 这是一个需要理解的重要概念 — 它涉及到如何强制实施权限。 角色分配包含三个要素：安全主体、角色订阅和范围。</p><h4 id="安全主体">安全主体</h4><p>安全主体是一个对象，表示请求访问 Azure 资源的用户、组、服务主体或托管标识。 可以将角色分配给其中任何一个安全主体。</p><p><img src="https://s2.loli.net/2021/12/22/Zzsgy2vSkBHKlGf.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/Zzsgy2vSkBHKlGf.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示意图显示了角色分配的安全主体类型。"></p><h4 id="角色定义">角色定义</h4><p>角色定义是权限的集合。 它通常直接称为“角色”。 角色定义列出可执行的操作，例如读取、写入和删除。 角色可以是高级别的（例如所有者），也可以是特定的（例如虚拟机读取者）。</p><p><img src="https://s2.loli.net/2021/12/22/a9mBYPwnsrd8vyF.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/a9mBYPwnsrd8vyF.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示意图显示了角色分配的角色定义示例"></p><p>Azure 包含多个可用的<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles">内置角色</a>。 例如，<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#virtual-machine-contributor">虚拟机参与者</a>角色允许用户创建和管理虚拟机。 如果内置角色不能满足组织的特定需求，你可以创建自己的 <a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/custom-roles">Azure 自定义角色</a>。</p><h4 id="范围">范围</h4><p>范围是访问权限适用于的资源集。 分配角色时，可以通过定义范围来进一步限制允许的操作。 若要将某人分配为<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#website-contributor">网站参与者</a>，但只针对一个资源组执行此分配，则可使用范围。</p><p>在 Azure 中，可在四个级别指定范围：<a href="https://docs.microsoft.com/zh-cn/azure/governance/management-groups/overview">管理组</a>、订阅、<a href="https://docs.microsoft.com/zh-cn/azure/azure-resource-manager/management/overview#resource-groups">资源组</a>或资源。 范围采用父子关系结构。 可以在其中任何一个范围级别分配角色。</p><p><img src="https://s2.loli.net/2021/12/22/t64iDKaNegGSWqB.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/t64iDKaNegGSWqB.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示意图显示了角色分配的范围级别。"></p><p>有关范围的详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/scope-overview">了解范围</a>。</p><h3 id="角色分配">角色分配</h3><p>角色分配是出于授予访问权限的目的，将角色定义附加到特定范围内的用户、组、服务主体或托管标识的过程。 通过创建角色分配来授予访问权限，通过删除角色分配来撤销访问权限。</p><p>下图显示了角色分配的示例。 在此示例中，为“营销”组分配了医药销售资源组的<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#contributor">参与者</a>角色。 这意味着，“营销”组中的用户可以在医药销售资源组中创建或管理任何 Azure 资源。 “营销”用户无权访问医药销售资源组外部的资源，除非他们属于另一个角色分配。</p><p><img src="https://s2.loli.net/2021/12/22/zKc3xoeCI4ENTF8.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/zKc3xoeCI4ENTF8.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示意图显示了安全主体、角色定义和范围如何创建角色分配。"></p><p>可使用 Azure 门户、Azure CLI、Azure PowerShell、Azure SDK 或 REST API 分配角色。</p><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/role-assignments-steps">分配 Azure 角色的步骤</a>。</p><h3 id="组">组</h3><p>角色分配对组来说是可传递的，这意味着如果某用户是某个组的成员，而该组属于具有角色分配的另一个组，那么该用户将具有该角色分配中的权限。</p><p><img src="https://s2.loli.net/2021/12/22/u4xbEgJsIq5WOeG.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/u4xbEgJsIq5WOeG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示意图显示了组的角色分配是如何传递的。"></p><h3 id="多角色分配">多角色分配</h3><p>如果有多个重叠的角色分配，将会发生什么情况？ Azure RBAC 是一个加法模型，因此有效权限是角色分配的总和。 请考虑以下示例，其中在订阅范围内向用户授予了“参与者”角色，并且授予了对资源组的“读者”角色。 “参与者”权限与“读者”权限的总和实际上是订阅的“参与者”角色。 因此，在这种情况下，“读者”角色分配没有任何影响。</p><p><img src="https://s2.loli.net/2021/12/22/N4l2ySpm6iTBI5t.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/N4l2ySpm6iTBI5t.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示意图显示了多个角色分配如何重叠。"></p><h3 id="拒绝分配">拒绝分配</h3><p>以前，Azure RBAC 是一种只能执行允许操作的模型，没有拒绝功能，但 Azure RBAC 现在以有限方式支持拒绝分配。 <em>拒绝分配</em>类似于角色分配，可将一组拒绝操作附加到特定范围内的用户、组、服务主体或托管标识，以便拒绝访问。 角色分配定义了一组允许的操作，而拒绝分配定义了一组不允许的操作。 换而言之，即使角色分配授予用户访问权限，拒绝分配也会阻止用户执行指定的操作。 拒绝分配优先于角色分配。</p><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/deny-assignments">了解 Azure 拒绝分配</a>。</p><h3 id="Azure-RBAC-如何确定用户是否有权访问资源">Azure RBAC 如何确定用户是否有权访问资源</h3><p>下面是 Azure RBAC 用于确定你是否可访问资源的概要步骤。 这些步骤适用于与 Azure RBAC 集成的 Azure 资源管理器或数据平面服务。 如果正在尝试对访问问题进行故障排除，这有助于了解问题。</p><ol><li><p>用户（或服务主体）获取 Azure 资源管理器的令牌。</p><p>令牌包含用户的组成员身份（包括可传递的组成员身份）。</p></li><li><p>用户使用附加的令牌对 Azure 资源管理器发出 REST API 调用。</p></li><li><p>Azure 资源管理器检索适用于对其执行操作的资源的所有角色分配和拒绝分配。</p></li><li><p>如果拒绝分配适用，则阻止访问。 否则，评估将继续进行。</p></li><li><p>Azure 资源管理器缩小适用于此用户或其组的角色分配范围，并确定用户针对此资源拥有的角色。</p></li><li><p>Azure 资源管理器确定 API 调用中的操作是否包含在用户针对此资源拥有的角色中。 如果角色包含的 <code>Actions</code> 具有通配符 (<code>*</code>)，则通过从允许的 <code>Actions</code> 中减去 <code>NotActions</code> 来计算有效权限。 同样，对任何数据操作执行相同的减法运算。</p><p><code>Actions - NotActions = Effective management permissions</code></p><p><code>DataActions - NotDataActions = Effective data permissions</code></p></li><li><p>如果用户在请求的范围内没有包含该操作的角色，则不允许访问。 否则，将评估任何条件。</p></li><li><p>如果角色分配包含条件，则对这些条件进行评估。 否则将允许访问。</p></li><li><p>如果满足条件，则允许访问。 否则将不允许访问。</p></li></ol><p>下图是评估逻辑的摘要。</p><p><img src="https://s2.loli.net/2021/12/22/h7NeEXWQfGIDTcU.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/h7NeEXWQfGIDTcU.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="评估逻辑流程图，用于确定对资源的访问权限。"></p><h3 id="经典订阅管理员角色、Azure-角色和-Azure-AD-角色">经典订阅管理员角色、Azure 角色和 Azure AD 角色</h3><ul><li>经典订阅管理员角色</li><li>Azure 角色</li><li>Azure Active Directory (Azure AD) 角色</li></ul><h3 id="角色之间的相互关系">角色之间的相互关系</h3><p>若要更好地理解 Azure 中的角色，最好是先了解一些历史信息。 Azure 最初发布时，对资源的访问权限只是通过以下三种管理员角色进行管理：<font color='orange'>帐户管理员、服务管理员和共同管理员</font>。 后来添加了 Azure 基于角色的访问控制 (Azure RBAC)。 Azure RBAC 是一个较新的授权系统，它针对 Azure 资源提供精细的访问管理。 Azure RBAC 包括许多内置角色，可在不同的范围进行分配，并允许你创建自己的自定义角色。 若要管理 Azure AD 中的资源（例如用户、组和域），可以使用多种 Azure AD 角色。</p><p>下图从较高的层面显示了经典订阅管理员角色、Azure 角色与 Azure AD 角色之间的相互关系。</p><p><img src="https://s2.loli.net/2021/12/22/58GSCoEyrthcwKk.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/58GSCoEyrthcwKk.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure 中的不同角色"></p><h3 id="经典订阅管理员角色">经典订阅管理员角色</h3><p><font color='orange'>帐户管理员、服务管理员和共同管理员是 Azure 中的三种经典订阅管理员角色</font>。 <font color='brown'>经典订阅管理员对 Azure 订阅拥有完全访问权限。 他们可以使用 Azure 门户、Azure 资源管理器 API 和经典部署模型 API 来管理资源。</font> 用于注册 Azure 的帐户会自动同时设置为帐户管理员和服务管理员。其次，可以添加其他共同管理员。 服务管理员和共同管理员拥有在订阅范围内分配有“所有者”角色（一个 Azure 角色）的用户的等效访问权限。 下表描述了这三种经典订阅管理角色之间的差别。</p><table><thead><tr><th style="text-align:left">经典订阅管理员</th><th style="text-align:left">限制</th><th style="text-align:left">权限</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">帐户管理员</td><td style="text-align:left">每个 Azure 帐户有 1 个</td><td style="text-align:left">可以访问 <a href="https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade">Azure 门户</a>并管理计费管理帐户中所有订阅的计费创建新订阅取消订阅更改订阅的计费更改服务管理员除非具有服务管理员或订阅所有者角色，否则无法取消订阅</td><td style="text-align:left">在概念上是订阅的计费所有者。</td></tr><tr><td style="text-align:left">服务管理员</td><td style="text-align:left">每个 Azure 订阅有 1 个</td><td style="text-align:left">在 <a href="https://portal.azure.com/">Azure 门户</a>中管理服务取消订阅将用户分配到共同管理员角色</td><td style="text-align:left">默认情况下，新订阅的帐户管理员也是服务管理员。 服务管理员拥有在订阅范围内分配有“所有者”角色的用户的等效访问权限。 服务管理员具有 Azure 门户的完全访问权限。</td></tr><tr><td style="text-align:left">共同管理员</td><td style="text-align:left">每个订阅有 200 个</td><td style="text-align:left">与服务管理员的访问特权相同，但无法更改订阅与 Azure 目录之间的关联。将用户分配到共同管理员角色，但无法更改服务管理员</td><td style="text-align:left">共同管理员拥有在订阅范围内分配有“所有者”角色的用户的等效访问权限。</td></tr></tbody></table><p>在 Azure 门户中，可以使用“经典管理员”选项卡管理共同管理员或查看服务管理员。</p><p><img src="https://s2.loli.net/2021/12/22/UlnI3m1aHDTcbrN.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/UlnI3m1aHDTcbrN.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure 门户中的 Azure 经典订阅管理员"></p><p>在 Azure 门户中，可以在订阅的属性边栏选项卡上，查看或更改服务管理员，或是查看帐户管理员。</p><p><img src="https://s2.loli.net/2021/12/22/EeGKorIC4YFpDct.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/EeGKorIC4YFpDct.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure 门户中的帐户管理员和服务管理员"></p><p>有关详细信息，请参阅 <a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/classic-administrators">Azure 经典订阅管理员</a>。</p><h3 id="Azure-帐户和-Azure-订阅">Azure 帐户和 Azure 订阅</h3><p>Azure 帐户代表计费关系。 一个 Azure 帐户代表一个用户标识、一个或多个 Azure 订阅和一组关联的 Azure 资源。 创建帐户的人员是该帐户中创建的所有订阅的帐户管理员。 此人也是订阅的默认服务管理员。</p><p>Azure 订阅可帮助你组织 Azure 资源的访问权限。 它们还可帮助控制如何根据资源使用量生成报告、计费及付费。 每个订阅可以采用不同的计费和付款设置，因此，根据办公室、部门、项目等因素，可以采用不同的订阅和不同的计划。 每个服务属于一个订阅，执行编程操作时可能需要订阅 ID。</p><p>每个订阅都与一个 Azure AD 目录相关联。 若要查找与订阅关联的目录，请在 Azure 门户中打开“订阅”，然后选择一个订阅以查看目录。</p><p>帐户和订阅在 <a href="https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade">Azure 门户</a>中进行管理。</p><h3 id="Azure-角色">Azure 角色</h3><p><font color='red'>Azure RBAC 是基于 <a href="https://docs.microsoft.com/zh-cn/azure/azure-resource-manager/management/overview">Azure 资源管理器</a>构建的授权系统，它针对 Azure 资源（例如计算和存储）提供精细的访问权限管理。</font> Azure RBAC 包括 70 多个内置角色。 有四个基本的 Azure 角色。 前三个角色适用于所有资源类型：</p><table><thead><tr><th style="text-align:left">Azure 角色</th><th style="text-align:left">权限</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#owner">所有者</a></td><td style="text-align:left">对所有资源的完全访问权限将访问权限委托给其他人</td><td style="text-align:left">服务管理员和共同管理员在订阅范围内分配有“所有者”角色 适用于所有资源类型。</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#contributor">参与者</a></td><td style="text-align:left">创建和管理所有类型的 Azure 资源在 Azure Active Directory 中创建一个新租户无法将访问权限授予其他人</td><td style="text-align:left">适用于所有资源类型。</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#reader">读取者</a></td><td style="text-align:left">查看 Azure 资源</td><td style="text-align:left">适用于所有资源类型。</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#user-access-administrator">用户访问管理员</a></td><td style="text-align:left">管理用户对 Azure 资源的访问</td><td style="text-align:left"></td></tr></tbody></table><p>剩余的内置角色允许管理特定的 Azure 资源。 例如，<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#virtual-machine-contributor">虚拟机参与者</a>角色允许用户创建和管理虚拟机。 有关所有内置角色的列表，请参阅 <a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles">Azure 内置角色</a>。</p><p>只有 Azure 门户和 Azure 资源管理器 API 支持 Azure RBAC。 <font color='cornflowerblue'>分配有 Azure 角色的用户、组和应用程序无法使用 <a href="https://docs.microsoft.com/zh-cn/azure/azure-resource-manager/management/deployment-models">Azure 经典部署模型 API</a>。</font></p><p>在 Azure 门户中，使用 Azure RBAC 的角色分配显示在“访问控制(标识和访问管理)”边栏选项卡上。 在整个门户中都可以找到此边栏选项卡，例如，在管理组、订阅、资源组和各种资源所在的部分。</p><p><img src="https://s2.loli.net/2021/12/22/qcZBbX6aWH7DeIY.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/qcZBbX6aWH7DeIY.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure 门户中的“访问控制(IAM)”边栏选项卡"></p><p>单击“角色”选项卡时，会看到内置角色和自定义角色的列表。</p><p><img src="https://s2.loli.net/2021/12/22/BDVUrieN15zkb9t.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/BDVUrieN15zkb9t.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure 门户中的内置角色"></p><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/role-assignments-portal">使用 Azure 门户分配 Azure 角色</a>。</p><h3 id="Azure-AD-角色">Azure AD 角色</h3><p><font color='red'>Azure AD 角色用于管理目录中的 Azure AD 资源，例如，创建或编辑用户、将管理角色分配给其他人、重置用户密码、管理用户许可证以及管理域。 下表描述了几个更重要的 Azure AD 角色。</font></p><table><thead><tr><th style="text-align:left">Azure AD 角色</th><th style="text-align:left">权限</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/active-directory/roles/permissions-reference#global-administrator">全局管理员</a></td><td style="text-align:left">管理对 Azure Active Directory 中所有管理功能的访问，以及与 Azure Active Directory 联合的服务将管理员角色分配给其他人重置任何用户和其他所有管理员的密码</td><td style="text-align:left">注册 Azure Active Directory 租户的人员将成为全局管理员。</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/active-directory/roles/permissions-reference#user-administrator">用户管理员</a></td><td style="text-align:left">创建和管理用户与组的所有方面管理支持票证监视服务运行状况更改用户、支持管理员和其他用户帐户管理员的密码</td><td style="text-align:left"></td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/active-directory/roles/permissions-reference#billing-administrator">计费管理员</a></td><td style="text-align:left">购买产品管理订阅管理支持票证监视服务运行状况</td><td style="text-align:left"></td></tr></tbody></table><p>在 Azure 门户中的“角色和管理员”边栏选项卡上，可以看到 Azure AD 角色的列表。 有关所有 Azure AD 角色的列表，请参阅 <a href="https://docs.microsoft.com/zh-cn/azure/active-directory/roles/permissions-reference">Azure Active Directory 中的管理员角色权限</a>。</p><p><img src="https://s2.loli.net/2021/12/22/HQBtZfT4aNyIsOk.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/HQBtZfT4aNyIsOk.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure 门户中的 Azure AD 角色"></p><h3 id="Azure-角色与-Azure-AD-角色之间的差别">Azure 角色与 Azure AD 角色之间的差别</h3><p><font color='red'>从较高层面讲，Azure 角色控制 Azure 资源的管理权限，而 Azure AD 角色控制 Azure Active Directory 资源的管理权限。</font> 下表比较了两者之间的一些差别。</p><table><thead><tr><th style="text-align:left">Azure 角色</th><th style="text-align:left">Azure AD 角色</th></tr></thead><tbody><tr><td style="text-align:left">管理对 Azure 资源的访问</td><td style="text-align:left">管理对 Azure Active Directory 资源的访问</td></tr><tr><td style="text-align:left">支持自定义角色</td><td style="text-align:left">支持自定义角色</td></tr><tr><td style="text-align:left">可在多个级别（管理组、订阅、资源组、资源）指定范围</td><td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/azure/active-directory/roles/custom-overview#scope">范围</a>可以在租户级别（组织范围）、管理单元或单个对象（例如，特定应用程序）上指定</td></tr><tr><td style="text-align:left">可在 Azure 门户、Azure CLI、Azure PowerShell、Azure 资源管理器模板、REST API 中访问角色信息</td><td style="text-align:left">可在 Azure 管理门户、Microsoft 365 管理中心、Microsoft Graph、AzureAD PowerShell 中访问角色信息</td></tr></tbody></table><h3 id="Azure-角色与-Azure-AD-角色是否重叠？">Azure 角色与 Azure AD 角色是否重叠？</h3><p>默认情况下，Azure 角色与 Azure AD 角色不会跨越 Azure 与 Azure AD。 但是，如果全局管理员通过在 Azure 门户中选择“Azure 资源的访问管理”开关，提升了自己的访问权限，则会针对特定租户的所有订阅为全局管理员授予<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/built-in-roles#user-access-administrator">用户访问管理员</a>角色（Azure 角色）。 “用户访问管理员”角色允许用户向其他用户授予对 Azure 资源的访问权限。 此开关可帮助重新获取订阅的访问权限。 有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/azure/role-based-access-control/elevate-access-global-admin">提升访问权限以管理所有 Azure 订阅和管理组</a>。</p><p>有多个 Azure AD 角色（例如全局管理员和用户管理员角色）可跨越 Azure AD 和 Microsoft 365。 例如，如果你是全局管理员角色的成员，则会获得 Azure AD 和 Microsoft 365 中的全局管理员功能，例如，对 Microsoft Exchange 和 Microsoft SharePoint 进行更改。 但是，在默认情况下，全局管理员无权访问 Azure 资源。</p><p><img src="https://s2.loli.net/2021/12/22/6HBYsnPrplLhDye.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/22/6HBYsnPrplLhDye.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Azure RBAC 与 Azure AD 角色"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Azure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Azure </tag>
            
            <tag> 微软 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>什么是OIDC(OpenID Connect)</title>
      <link href="/posts/de08e406/"/>
      <url>/posts/de08e406/</url>
      
        <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2021/12/19/d9XiT87zYhUVf5R.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/19/d9XiT87zYhUVf5R.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211219153451121"></p><h2 id="什么是-OIDC？"><strong>什么是 OIDC？</strong></h2><div class="story post-story"><p>OIDC 的全称是 OpenID Connect，是一套基于 OAuth 2.0 的<strong>认证 + 授权</strong>协议，用于用户身份认证，将用户数据安全地暴露给第三方。</p></div><h2 id="OIDC-与-OAuth-2-0-有何不同？"><strong>OIDC 与 OAuth 2.0 有何不同？</strong></h2><div class="story post-story"><p><strong>OAuth 2.0</strong> 是用于<strong>授权</strong>的行业标准协议。OAuth 2.0 致力于简化客户端开发人员的工作，同时为Web 应用程序，桌面应用程序，移动电话和物联网设备提供特定的授权流程。</p><p>以上是 OAuth 2.0 的官方定义。我们举一个实际的例子，你在登录京东的时候，会发现在京东的登录框中有<strong>使用 QQ 登录</strong>、<strong>使用 QQ 登录</strong>的按钮，这些地方就是 OAuth 2.0 协议的用武之地。京东希望从 QQ 获取你的 QQ 用户数据，从而完成在京东的注册，这就需要数据的主人——<strong>你的授权</strong>。完成授权之后， QQ 会给京东一个 access_token，京东携带这个凭证，就能<strong>以你的名义</strong>，以及<strong>你授予此网站的权限（例如你授权京东能够访问你的个人信息而不是转账能力）</strong>，访问<strong>你在 QQ 服务器上的数据</strong>，从而获取你的信息，在此过程中，你<strong>无须告诉</strong>京东你的 QQ <strong>账号和密码</strong>，你输入账密信息的时候，是在腾讯的服务器完成的认证。</p><p><strong>OIDC</strong> 与 <strong>OAuth 2.0</strong> 相比，多了<strong>认证</strong>的能力。不但能够返回用户的 <strong>access_token</strong>，让第三方通过 access_token 调用用户授权过的接口（用户<strong>授权</strong>），还可以返回用户的 <strong>id_token</strong>，第三方可以将 id_token 用作用户身份标识（用户<strong>认证</strong>）。</p><p>回到刚才的例子，京东获取到 QQ 颁发的 access_token（是一个随机字符串）之后确实能够获取到你的信息，但是如果不借助其他手段，是<strong>不具备用户身份认证</strong>功能的。而在 OIDC 协议中，获取 access_token 的同时，会返回一个 JWT 格式的 id_token，可直接用作身份标识，供第三方确认用户身份。</p><p>JWT Token 是这个样子的：</p><pre class="language-none"><code class="language-none">eyJ0eXAiOiJKV1QiLA0KICJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJqb2UiLA0KICJleHAiOjEzMDA4MTkzODAsDQogImh0dHA6Ly9leGFtcGxlLmNvbS9pc19yb290Ijp0cnVlfQ.dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk</code></pre><p>格式为“点分 base64 编码”，一共三段，第一部分叫作<strong>头部</strong>（JOSE Header），第二部分叫作<strong>荷载</strong>（Payload），第三部分叫作<strong>签名</strong>（Signature）。其中的签名根据头部、荷载和一个密钥计算得出，不可伪造。</p><p>base64 解码之后是这样子的：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"typ"</span><span class="token builtin class-name">:</span><span class="token string">"JWT"</span>, <span class="token string">"alg"</span><span class="token builtin class-name">:</span><span class="token string">"HS256"</span><span class="token punctuation">&#125;</span>.<span class="token punctuation">&#123;</span><span class="token string">"iss"</span><span class="token builtin class-name">:</span><span class="token string">"joe"</span>, <span class="token string">"exp"</span>:1300819380, <span class="token string">"http://example.com/is_root"</span>:true<span class="token punctuation">&#125;</span>.<span class="token operator">&lt;</span>签名<span class="token operator">></span></code></pre><p>总结成一句话：OAuth 2.0 能做的 OIDC 都能做，OAuth 2.0 不具备的认证能力，OIDC 也具备。</p></div><h2 id="OIDC-协议的应用场景"><strong>OIDC 协议的应用场景</strong></h2><div class="story post-story"><p>所有使用 OAuth 2.0 的场景都可以升级为 OIDC 协议，OIDC 协议是 OAuth 2.0 的超集。以下是一些 OIDC 协议的应用场景：</p><ul><li>社会化登录场景，网站登录框上常见许多按钮「使用 XXX 登录」。</li><li>物联网设备的身份认证和授权。</li><li>企业内多个应用统一身份，单点登录。</li><li>开放平台对外暴露应用数据，做用户认证与授权。</li><li>Serverless 中的身份层。</li></ul><p>OIDC 协议是 OAuth 2.0 协议的下一代，是身份认证协议升级的不二之选。</p></div><h2 id="OIDC-协议中的四个主体"><strong>OIDC 协议中的四个主体</strong></h2><div class="story post-story"><p>在介绍 OIDC 授权模式之前，先要明确四个主体：<strong>第三方应用、资源服务器、资源所有者、认证授权服务器</strong>。我们继续沿用前文京东与 QQ 登录的例子。</p><p>P.S. QQ 使用的是变种 OAuth 2.0 协议，并不完全符合 OIDC 规范，在此假设 QQ 使用 OIDC 协议进行对外数据授权。</p><p><strong>第三方应用</strong></p><p>京东的角色是第三方应用。</p><p><strong>资源服务器</strong></p><p>QQ 的个人信息存放于资源服务器。</p><p><strong>资源所有者</strong></p><p>用户是 QQ 账号的所有者。</p><p><strong>认证授权服务器</strong></p><p>QQ 的授权服务器负责用户的身份认证和授权，管理<strong>第三方应用</strong>、<strong>受保护资源</strong>、<strong>资源所有者</strong>之间的关系。</p><p><img src="https://s2.loli.net/2021/12/19/QrWXwbmqOH7uSYc.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/19/QrWXwbmqOH7uSYc.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211219153524610"></p></div><h2 id="OIDC-的三种授权模式"><strong>OIDC 的三种授权模式</strong></h2><div class="story post-story"><h3 id="Authorization-Code-Flow"><strong>Authorization Code Flow</strong></h3><p>应用最为广泛的是<strong>授权码模式</strong>，此模式的交互过程如下图**：**</p><p><img src="https://s2.loli.net/2021/12/19/Lam7RpZHjdVI2qk.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/19/Lam7RpZHjdVI2qk.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211219153612400"></p><ol><li>第三方应用访问认证服务器的授权链接。（用户在京东网站登录框点击使用 QQ 登录）</li><li>用户与认证服务器完成身份认证。（浏览器跳转到 QQ 授权页面，用户输入 QQ 号和密码）</li><li>认证服务器向第三方应用返回授权码 code。（QQ 服务器将用户的浏览器重定向，将授权码发送到京东服务器）</li><li>第三方应用携带授权码访问认证服务器的 token 接口。（京东服务器携带授权码与 QQ 服务器交互）</li><li>认证服务器返回 <strong>access_token</strong> 和 <strong>id_token</strong> 给第三方应用。（QQ 服务器返回 access_token 和 id_token 给京东服务器）</li></ol><p>此后，<strong>第三方应用</strong>可以利用 access_token 到<strong>资源服务器</strong>获取用户的信息，完成在第三方应用的注册和登录业务，并可以将 <strong>id_token 作为用户的身份凭证</strong>，存放在前端。第三方应用的前端需要访问受保护的资源（例如用户账单信息、购物车）时需要<strong>携带 id_token</strong>，<strong>后端验证 id_token 合法性</strong>，核实用户身份之后，返回相关资源数据。</p><p><strong>OIDC 认证时相关 Token 解释</strong></p><p>OIDC 认证时会签发两种 Token，一类叫 id_token，还有一类叫  access_token。</p><ol><li><p>id_token 是<strong>用户身份的凭证</strong>，<strong>只起到判定用户身份</strong>的作用。</p><p>id_token 示例：</p></li></ol><pre class="language-none"><code class="language-none">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1ZTQ5NjBkZmJkOTE1OGZiODQ0OTAzYTkiLCJiaXJ0aGRhdGUiOiIiLCJmYW1pbHlfbmFtZSI6IiIsImdlbmRlciI6IiIsImdpdmVuX25hbWUiOiIiLCJsb2NhbGUiOiIiLCJtaWRkbGVfbmFtZSI6IiIsIm5hbWUiOiIiLCJuaWNrbmFtZSI6IiIsInBpY3R1cmUiOiJodHRwczovL3VzZXJjb250ZW50cy5hdXRoaW5nLmNuL2F1dGhpbmctYXZhdGFyLnBuZyIsInByZWZlcnJlZF91c2VybmFtZSI6IiIsInByb2ZpbGUiOiIiLCJ1cGRhdGVkX2F0IjoiIiwid2Vic2l0ZSI6IiIsInpvbmVpbmZvIjoiIiwiY29tcGFueSI6IiIsImJyb3dzZXIiOiJNb3ppbGxhLzUuMCAoTWFjaW50b3NoOyBJbnRlbCBNYWMgT1MgWCAxMF8xNF82KSBBcHBsZVdlYktpdC81MzcuMzYgKEtIVE1MLCBsaWtlIEdlY2tvKSBDaHJvbWUvODAuMC4zOTg3Ljg3IFNhZmFyaS81MzcuMzYiLCJkZXZpY2UiOiIiLCJsb2dpbnNfY291bnQiOjEsInJlZ2lzdGVyX21ldGhvZCI6ImRlZmF1bHQ6dXNlcm5hbWUtcGFzc3dvcmQiLCJibG9ja2VkIjpmYWxzZSwibGFzdF9pcCI6IjEyMS4yMS41Ni4xNzEiLCJyZWdpc3Rlcl9pbl91c2VycG9vbCI6IjVjOTU5MDU1NzhmY2U1MDAwMTY2Zjg1MyIsImxhc3RfbG9naW4iOiIyMDIwLTAyLTE2VDE1OjMzOjUyLjQ0NFoiLCJzaWduZWRfdXAiOiIyMDIwLTAyLTE2VDE1OjMzOjUxLjY2NVoiLCJlbWFpbCI6InRlc3QxQDEyMy5jb20iLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInBob25lX251bWJlciI6IiIsInBob25lX251bWJlcl92ZXJpZmllZCI6ZmFsc2UsImF0X2hhc2giOiJWYW9sSnVqWXltQjUxNlNGOGNaQkpBIiwic2lkIjoiZGYzMGFlNDgtOTkzMS00YjZlLWI0YzgtMWI5NjRkOGZjOWIyIiwiYXVkIjoiNWQwMWUzODk5ODVmODFjNmMxZGQzMWRlIiwiZXhwIjoxNTgxODcwOTc4LCJpYXQiOjE1ODE4NjczODEsImlzcyI6Imh0dHBzOi8vb2F1dGguYXV0aGluZy5jbi9vYXV0aC9vaWRjIn0.pH-bWm-Im0wnOcUEA-OG_iKwy9DTZlAXuik50HPsfGY</code></pre><p>​解码后：</p><pre class="language-none"><code class="language-none">&#123;  &quot;alg&quot;: &quot;HS256&quot;,  &quot;typ&quot;: &quot;JWT&quot;&#125;.&#123;  &quot;sub&quot;: &quot;5e3a3b2315a0b8398cdaaa08&quot;,  &quot;birthdate&quot;: &quot;&quot;,  &quot;family_name&quot;: &quot;&quot;,  &quot;gender&quot;: &quot;&quot;,  &quot;given_name&quot;: &quot;&quot;,  &quot;locale&quot;: &quot;&quot;,  &quot;middle_name&quot;: &quot;&quot;,  &quot;name&quot;: &quot;&quot;,  &quot;nickname&quot;: &quot;&quot;,  &quot;picture&quot;: &quot;https:&#x2F;&#x2F;usercontents.authing.cn&#x2F;authing-avatar.png&quot;,  &quot;preferred_username&quot;: &quot;&quot;,  &quot;profile&quot;: &quot;&quot;,  &quot;updated_at&quot;: &quot;&quot;,  &quot;website&quot;: &quot;&quot;,  &quot;zoneinfo&quot;: &quot;&quot;,  &quot;company&quot;: &quot;&quot;,  &quot;browser&quot;: &quot;&quot;,  &quot;device&quot;: &quot;&quot;,  &quot;logins_count&quot;: 8,  &quot;register_method&quot;: &quot;default:username-password&quot;,  &quot;blocked&quot;: false,  &quot;last_ip&quot;: &quot;127.0.0.1&quot;,  &quot;register_in_userpool&quot;: &quot;5e3a3b2315a0b8398cdaaa04&quot;,  &quot;last_login&quot;: &quot;2020-02-16T09:04:09.764Z&quot;,  &quot;signed_up&quot;: &quot;2020-02-05T03:48:51.447Z&quot;,  &quot;email&quot;: &quot;test@test.com&quot;,  &quot;email_verified&quot;: false,  &quot;phone_number&quot;: &quot;&quot;,  &quot;at_hash&quot;: &quot;6k-IWJwh-Dd3_hLOay0s7A&quot;,  &quot;sid&quot;: &quot;d50a8c9d-23db-4156-80ea-1c82d199d0e9&quot;,  &quot;aud&quot;: &quot;5e3a3b2315a0b8398cdaaa0e&quot;,  &quot;exp&quot;: 1581948533,  &quot;iat&quot;: 1581944933,  &quot;iss&quot;: &quot;https:&#x2F;&#x2F;core.littleimp.cn&#x2F;oauth&#x2F;oidc&quot;&#125;.签名</code></pre><ol start="2"><li>access_token 是<strong>用户授权给第三方应用的一个令牌</strong>，第三方应用可以使用这个令牌访问用户在资源服务器上受保护的资源，一般<strong>不用于用户凭证</strong>和身份标识。</li></ol><p>​access_token 示例：</p><pre class="language-none"><code class="language-none">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJXaXdndEdHYzVMeGtZRUFRY012RFkiLCJzdWIiOiI1ZTNhM2IyMzE1YTBiODM5OGNkYWFhMDgiLCJpc3MiOiJodHRwczovL2NvcmUubGl0dGxlaW1wLmNuL29hdXRoL29pZGMiLCJpYXQiOjE1ODE5NDQ5MzMsImV4cCI6MTU4MTk0ODUzMywic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCBwaG9uZSIsImF1ZCI6IjVlM2EzYjIzMTVhMGI4Mzk4Y2RhYWEwZSJ9.MnAAGj6HlYvN3FOAo6PA2cxNxZDZbL3yhxTM3uxnt0M</code></pre><p>解码后：</p><pre><code>&#123;  &quot;alg&quot;: &quot;HS256&quot;,  &quot;typ&quot;: &quot;JWT&quot;&#125;.&#123;  &quot;jti&quot;: &quot;WiwgtGGc5LxkYEAQcMvDY&quot;,  &quot;sub&quot;: &quot;5e3a3b2315a0b8398cdaaa08&quot;,  &quot;iss&quot;: &quot;https://core.littleimp.cn/oauth/oidc&quot;,  &quot;iat&quot;: 1581944933,  &quot;exp&quot;: 1581948533,  &quot;scope&quot;: &quot;openid profile email phone&quot;,  &quot;aud&quot;: &quot;5e3a3b2315a0b8398cdaaa0e&quot;&#125;.签名</code></pre><h3 id="Implicit-Flow"><strong>Implicit Flow</strong></h3><p>在隐式模式中，认证服务器的授权接口不会返回授权码 code，而是在与用户完成认证后返回 id_token 和 access_token，交互模式如下图所示：</p><p><img src="https://s2.loli.net/2021/12/19/W63sx8Ivwyl9CZH.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/19/W63sx8Ivwyl9CZH.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211219153927656"></p><ol><li>第三方应用访问认证服务器的授权链接。（用户在京东网站登录框点击使用 QQ 登录）</li><li>用户与认证服务器完成身份认证。（浏览器跳转到 QQ 授权页面，用户输入 QQ 号和密码）</li><li>认证服务器向第三方应用返回 id_token 和 access_token。（QQ 服务器将用户的浏览器重定向，将 id_token access_token 发送到京东前端页面）</li></ol><p>隐式模式比授权码模式简单，经常用于将 id_token、access_token <strong>直接返回到前端</strong>，方便前端直接存储 id_token 用于证明用户身份。也需要前端自行将 access_token 发回后端，后端用于获取用户的详细信息，这增加了<strong>暴露 access_token 的风险。<strong>隐式模式</strong>不支持返回 refresh_token</strong>，即不能从后端刷新 access_token，登录一旦过期需要用户重新登录。</p><h3 id="Hybrid-Flow"><strong>Hybrid Flow</strong></h3><p>混合模式是以上两种模式的组合，特点是能够在授权接口<strong>一次性获取到</strong> code、id_token、access_token，一般 code 会与 id_token、access_token 混合出现，混合模式的交互如下图所示：</p><p><img src="https://s2.loli.net/2021/12/19/cW2RgSCeY8q6FxN.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/19/cW2RgSCeY8q6FxN.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211219154035227"></p><ol><li>第三方应用访问认证服务器的授权链接。（用户在京东网站登录框点击使用 QQ 登录）</li><li>用户与认证服务器完成身份认证。（浏览器跳转到 QQ 授权页面，用户输入 QQ 号和密码）</li><li>认证服务器向第三方应用返回 code、id_token 和 access_token。（QQ 服务器将用户的浏览器重定向，将 id_token access_token 发送到京东前端页面）</li><li>第三方应用携带授权码访问认证服务器的 token 接口。（京东服务器携带授权码与 QQ 服务器交互）</li><li>认证服务器返回 <strong>access_token</strong> 和 <strong>id_token</strong> 给第三方应用。（QQ 服务器返回 access_token 和 id_token 给京东服务器）</li></ol><p>混合模式可以灵活满足 code、id_token、access_token 的各种处理方式，可以在享有隐式模式便利的同时，利用 code 获取 refresh_token，从而可以在后端刷新用户 access_token，不必重复让用户登录。</p></div><h2 id="总结"><strong>总结</strong></h2><div class="story post-story"><p>OIDC 协议是 OAuth 2.0 协议的超集，是可以替代 OAuth 2.0 的下一代身份认证协议，能够解决认证 + 授权两个问题。OIDC 的授权流程与 OAuth 2.0 完全一致，能够保持向下兼容。</p><p>授权服务器的意义在于管理<strong>第三方应用</strong>、<strong>受保护资源</strong>、<strong>资源所有者</strong>之间的关系，让互相不信任的应用之间安全地暴露数据——应用之间约定好某种规范，按照这种规范，就能在用户授权的前提下，安全地将数据暴露给第三方，<strong>而第三方也无需获知用户的账密信息。</strong></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Azure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OIDC </tag>
            
            <tag> OAuth2.0 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Azure Tenant,subscription的关系</title>
      <link href="/posts/1bfddf42/"/>
      <url>/posts/1bfddf42/</url>
      
        <content type="html"><![CDATA[<p>[toc]</p><h1>Subscriptions, licenses, accounts, and tenants</h1><p>微软提供了组织、订阅、许可证和用户帐户的层次结构，以便在其云产品中一致使用身份和账单</p><p><img src="https://s2.loli.net/2021/12/14/87bVk69BItDXlMg.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/14/87bVk69BItDXlMg.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211214210108770"></p><h2 id="Organization-tenants租户">Organization(tenants租户)</h2><div class="story post-story"><p>租户与Azure相关，指的是Azure Active Directory的单个实例，或者通常被称为“Azure AD”。Azure AD是Microsoft的云平台的关键部分，因为它提供了一个单一的位置来管理用户、组以及他们所持有的与在Azure AD中发布的应用程序相关的权限。</p><p>Azure AD提供的主要Microsoft应用程序包括Office 365、Dynamics 365和Azure。</p><p>每个Azure AD租户都是全球唯一的，通常使用以“<a href="http://onmicrosoft.com">onmicrosoft.com</a>”结尾的域（即 <a href="http://myazuread.onmicrosoft.com">myazuread.onmicrosoft.com</a>），并且每个租户都有一个 UUID/GUID 形式的“租户 ID”。独立于其他的Azure AD 租户。</p><p><font color='red'>一个租户可以关联多个订阅，但是一个订阅只能个一个租户绑定</font></p><blockquote><p>通俗理解租户：<br>Azure AD是用来身份认证管理的。组织由多个用户组成，如果一个组织里的好多人都需要注册登录使用一个应用程序，那么租户将这个组织里的人和应用程序圈在一起，租户里面有用户的AD 以及 注册这个应用程序，那么这个租户里面的人就可以通过AD登录进去这个应用程序。<br>多租户技术的好处在于：<br>1）多个租户里面有相应的应用程序，在多租户构架下享有一样的软件环境，这样软件更新可以统一进行，也可以共享底层资源（多种共享模式）。<br>2）租户与租户之间进行数据隔离。<br>一言以蔽之：多租户的关键就是同一套应用程序下实现多用户组织的数据隔离。</p></blockquote></div><h2 id="Subscriptions">Subscriptions</h2><div class="story post-story"><p>订阅是与 Microsoft 针对使用一个或多个 Microsoft 云平台或服务签订的协议，其费用基于每个用户许可证费用或云资源使用累计。</p><p>订阅是一个逻辑容器，可以在其中部署任意数量的资源(虚拟机、Web应用程序、存储帐户等)。它还可以用于对这些资源进行访问控制，不过目前正确的方法是利用基于角色的访问控制(Role Based access control, RBAC)或管理组。</p><p><strong>一句话说订阅就是用来关联Azure账户和Azure资源服务的东西。</strong></p><p><font color='red'>一个租户可以关联多个订阅</font>。比如，公司可以把订阅命名为财务部、市场部、销售部等等来管理。每个订阅的费用和计费方式和使用都是独立分开的。<font color='red'>但是一个订阅只能个一个租户绑定。</font></p><blockquote><p>账户和订阅的关系可以理解为：<br><strong>账户是人的身份证，订阅是手机号码，手机号码需要用身份证去注册申请，一个人可以有好几个手机号码，拿一个工作用，一个家人用，两者分别单独计费不同用途，而且一个手机号只能对应一个身份证号。</strong></p></blockquote><p>组织可订阅多个 Micrososft 云服务</p><p><img src="https://s2.loli.net/2021/12/14/hbnHZ2X5YRowf1C.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/14/hbnHZ2X5YRowf1C.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="组织订阅多个 Micrososft 云服务的示例。"></p></div><h2 id="Licenses">Licenses</h2><div class="story post-story"><p>许可证允许特定用户帐户使用云产品的服务。管理员将许可证分配给订阅中的各个用户帐户</p><p><img src="https://s2.loli.net/2021/12/14/Hce2UvzZI9xthMa.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/14/Hce2UvzZI9xthMa.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Microsoft 基于 SaaS 的云服务订阅中的多个许可证示例。"></p><blockquote><p>对于图中的示例，Contoso 公司订阅了具有 100 个许可证的 Office 365 E5，允许最多 100 个单个用户帐户使用 Microsoft 365 E5 的功能和服务。</p></blockquote></div><h2 id="AD-Active-Directory">AD Active Directory</h2><div class="story post-story"><p>所有 Microsoft 云服务的用户帐户均存储在 Active Directory (Azure AD) 租户(tenant)中，其中包含用户帐户和组。Azure AD tenant 可以使用基于 Windows 服务器服务的 Azure AD Connect与现有的Active Directory Domain Services (AD DS)帐户同步。这叫做目录同步。</p><p><img src="https://s2.loli.net/2021/12/14/cHGwkK5X7UNeLJF.png" class="lazyload" data-srcset="https://s2.loli.net/2021/12/14/cHGwkK5X7UNeLJF.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="组织使用同一个 Azure AD 租户进行多个订阅的示例。"></p><blockquote><p><strong>组织使用同一 Azure AD 租户进行的多个订阅</strong></p></blockquote><p><strong>活动目录是一个系统，用来存储目录数据，管理用户和资源之间的通信</strong></p><blockquote><p>AD有 Azure AD 和本地的 AD域服务（AD DS）</p><p>​AD DS是本地Windows server服务器上的角色。</p><p>​Azure AD 是多用户公共目录服务，这意味着Azure AD为云服务和应用程序创建租户。</p><p>Azure AD是云上的多租户目录和标识管理服务，提供核心目录和身份管理功能，user可以使用单一登录SSO来访问其他云的SaaS应用程序，如Office365。比如，每个Office365，Azure，CRM online租户实际上都是Azure AD的租户。用租户来为Azure AD里面的app管理访问权限。</p><p>AAD是多租户服务，意味着能够同时支持多个不同的组织，可存储每个组织中用户的目录信息。<br>AAD十一目录为单位来区分范围的。每个目录相当于一个房间。这些房间同在一个大楼里面，但是每个房间又是相对独立的一个个体。要想在AAD中添加人或者添加程序时首先需要创建一个目录，目录是最基本的存在，AAD中所有的东西都是保存在目录中。</p></blockquote></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Win </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Azure </tag>
            
            <tag> Azure AD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 处理Soap-Post方法</title>
      <link href="/posts/d61d731c/"/>
      <url>/posts/d61d731c/</url>
      
        <content type="html"><![CDATA[<h2 id="导语">导语</h2><div class="story post-story"><p>最近项目用到处理soap接口协议，使用post方法发送数据</p><p>在这个地方停留许久，故将解决方法记录下来</p></div><h2 id="soap">soap</h2><div class="story post-story"><p>soap 依赖于<code>XML</code>文件</p><p>首先要处理XML文件</p><p>python中有<code>xmltodict,dicttoxml</code>两个库可以使用</p></div><h2 id="使用方法">使用方法</h2><div class="story post-story"><p>两种解决方法：</p><p>一种是 <code>requests</code>方法</p><p>另一种是使用<code>suds</code>库</p><p>两种方法可参考：</p><p><a href="https://gist.github.com/toast38coza/17e2ad6c2cfa2e96b0b1">Call a SOAP Service with plain old requests</a></p><p><a href="https://gist.github.com/toast38coza/c7342fcc1dd5762d4c02">Calling a SOAP WebService with Python Suds</a></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># Call a SOAP Service with plain old requests</span><span class="token keyword">import</span> requestsurl<span class="token operator">=</span><span class="token string">"http://wsf.cdyne.com/WeatherWS/Weather.asmx?WSDL"</span><span class="token comment">#headers = &#123;'content-type': 'application/soap+xml'&#125;</span>headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'text/xml'</span><span class="token punctuation">&#125;</span>body <span class="token operator">=</span> <span class="token triple-quoted-string string">"""&lt;?xml version="1.0" encoding="UTF-8"?> &lt;SOAP-ENV:Envelope xmlns:ns0="http://ws.cdyne.com/WeatherWS/" xmlns:ns1="http://schemas.xmlsoap.org/soap/envelope/"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> &lt;SOAP-ENV:Header/>   &lt;ns1:Body>&lt;ns0:GetWeatherInformation/>&lt;/ns1:Body> &lt;/SOAP-ENV:Envelope>"""</span>response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>body<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token keyword">print</span> response<span class="token punctuation">.</span>content<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>华丽的分割线<span class="token number">1</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token comment"># Calling a SOAP WebService with Python Suds</span><span class="token keyword">from</span> suds<span class="token punctuation">.</span>client <span class="token keyword">import</span> Clienturl<span class="token operator">=</span><span class="token string">"http://wsf.cdyne.com/WeatherWS/Weather.asmx?WSDL"</span>client <span class="token operator">=</span> Client<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">print</span> client <span class="token comment">## shows the details of this service</span>result <span class="token operator">=</span> client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>GetWeatherInformation<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">print</span> result <span class="token comment">## see: restult.txt below</span></code></pre><p>这里采用的是<code>requests</code>方法</p></div><h2 id="遇到问题">遇到问题</h2><div class="story post-story"><p>构造<code>header``body</code>,<code>uri</code> 后</p><p>无论是使用python代码还是使用postman工具</p><p>获得返回的结果都是二进制流，解析后乱码</p><p>如下图：</p><p><img src="https://i.loli.net/2021/11/25/Dfa8t1ScETWlUid.png" class="lazyload" data-srcset="https://i.loli.net/2021/11/25/Dfa8t1ScETWlUid.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211125121849081"></p><p>尝试各种设置编码为<code>'utf-8'</code> 仍输出乱码， 初步判断：<font color='red'> 对返回的结果解析编码的问题</font></p><p><strong>构造的body为：</strong></p><pre class="language-python" data-language="python"><code class="language-python">body <span class="token operator">=</span> <span class="token string">"&lt;?xml version=\"1.0\" encoding=\"utf-8\"?>\n&lt;soap:Envelope xmlns:exm=\"http://schemas.microsoft.com/exchange/services/2006/messages\" xmlns:ext=\"http://schemas.microsoft.com/exchange/services/2006/types\" xmlns:a=\"http://www.w3.org/2005/08/addressing\" xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\">\n&lt;soap:Header>\n&lt;a:Action soap:mustUnderstand=\"1\">http://schemas.microsoft.com/exchange/2010/Autodiscover/Autodiscover/GetFederationInformation&lt;/a:Action>\n&lt;a:To soap:mustUnderstand=\"1\">https://autodiscover-s.outlook.com/autodiscover/autodiscover.svc&lt;/a:To>\n&lt;a:ReplyTo>\n&lt;a:Address>http://www.w3.org/2005/08/addressing/anonymous&lt;/a:Address>\n&lt;/a:ReplyTo>\n&lt;/soap:Header>\n&lt;soap:Body>\n&lt;GetFederationInformationRequestMessage xmlns=\"http://schemas.microsoft.com/exchange/2010/Autodiscover\">\n&lt;Request>\n&lt;Domain>"</span> <span class="token operator">+</span> domain <span class="token operator">+</span> <span class="token string">"&lt;/Domain>\n&lt;/Request>\n&lt;/GetFederationInformationRequestMessage>\n&lt;/soap:Body>\n&lt;/soap:Envelope>"</span></code></pre><p><strong>构造的header为</strong></p><pre class="language-python" data-language="python"><code class="language-python">headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'text/xml'</span><span class="token punctuation">,</span>    <span class="token string">'SOAPAction'</span><span class="token punctuation">:</span> <span class="token string">'http://schemas.microsoft.com/exchange/2010/Autodiscover/Autodiscover/GetFederationInformation'</span><span class="token punctuation">,</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'AutodiscoverClient'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span></code></pre></div><h2 id="解决方法：">解决方法：</h2><div class="story post-story"><p><font color='orange'>判断为返回结果解码造成的</font></p><p>尝试在header中添加<code>'Accept-Encoding':'utf-8'</code></p><p>如下:</p><pre class="language-python" data-language="python"><code class="language-python">headers <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'text/xml'</span><span class="token punctuation">,</span>    <span class="token string">'SOAPAction'</span><span class="token punctuation">:</span> <span class="token string">'http://schemas.microsoft.com/exchange/2010/Autodiscover/Autodiscover/GetFederationInformation'</span><span class="token punctuation">,</span>    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'AutodiscoverClient'</span><span class="token punctuation">,</span>    <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span></code></pre><p><strong>结果：</strong></p><p>乱码问题成功解决：</p><p><img src="https://i.loli.net/2021/11/25/pMeXbHc8gtNxYQm.png" class="lazyload" data-srcset="https://i.loli.net/2021/11/25/pMeXbHc8gtNxYQm.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211125122254951"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> soap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python解析DNS记录</title>
      <link href="/posts/c3784c4e/"/>
      <url>/posts/c3784c4e/</url>
      
        <content type="html"><![CDATA[<h2 id="导语">导语</h2><div class="story post-story"><p>最近项目用到 python 解析DNS记录，故将过程记录下来</p><p><strong>常用解析记录</strong></p><blockquote><p><strong>1.主机[A]记录</strong></p><p>描述: 主机地址记录。在 DNS 域名与 IP 地址之间建立映射关系语法: owner class ttl A IP_v4_address 例子: <a href="http://host1.example.microsoft.com">host1.example.microsoft.com</a>. IN A 127.0.0.1</p><p><strong>2.别名[CNAME]</strong></p><p>描述: 用来表示用在该区域中的其它资源记录类型中已指定名称的替补或别名 DNS 域名。语法: owner ttl class AFSDB subtype server_host_name 例子: <a href="http://aliasname.example.microsoft.com">aliasname.example.microsoft.com</a>. AFSDB 1 <a href="http://truename.example.microsoft.com">truename.example.microsoft.com</a>.</p><p><strong>3.主机信息[HINFO]</strong></p><p>描述: 用来说明映射到特定 DNS 主机名的 CPU 类型和操作系统类型的 RFC-1700 保留字符串类型，这个信息可以被应用程序通信协议使用。语法: owner ttl class HINFO cpu_type os_type 例子: <a href="http://my-computer-name.example.microsoft.com">my-computer-name.example.microsoft.com</a>. HINFO INTEL-386 WIN32</p><p><strong>4.邮箱[MB]</strong></p><p>描述: 用来将指定的域邮箱名映射到这个邮箱的主机的当前区域中的主机地址记录语法: owner ttl class MB mailbox_hostname 例子: <a href="http://mailbox.example.microsoft.com">mailbox.example.microsoft.com</a>. MB <a href="http://mailhost1.example.microsoft.com">mailhost1.example.microsoft.com</a></p><p><strong>5.邮箱或通信信息 MINFO</strong></p><p>描述: 用来指定负责维护该记录中特定通信名单或邮箱的联系域邮箱名称。同时，还被用来指定接收与该记录中特定通信名单或邮箱有关的错误信息的邮箱语法: owner ttl class MINFO responsible_mailbox error_mailbox 例子: <a href="http://administrator.example.microsoft.com">administrator.example.microsoft.com</a>. MINFO <a href="http://resp-mbox.example.microsoft.com">resp-mbox.example.microsoft.com</a> <a href="http://err-mbox.example.microsoft.com">err-mbox.example.microsoft.com</a></p><p><strong>6.邮件交换器 [MX]</strong></p><p>描述: 用来向特定邮件交换器提供消息路由，该主机作为指定 DNS 域名的邮件交换器。MX 记录需要一个16-位整数来表示消息路由中的主机优先级，多个邮件交换在消息一中被指定。对于这个记录类型中的每个邮件交换主机，需要一个相应的主机地址类型记录。语法: owner ttl class MX preference mail_exchanger_host 例子: <a href="http://example.microsoft.com">example.microsoft.com</a>. MX 10 <a href="http://mailserver1.example.microsoft.com">mailserver1.example.microsoft.com</a></p><p><strong>7.指针记录 [PTR]</strong></p><p>描述:用来指向域名空间中的某个位置。PTR记录通常在特殊域中来执行地址到名称镜像的反向搜索。每个记录提供要指向域名称空间的某个其它位置的简单数据。 Syntax: owner ttl class PTR targeted_domain_name 例子: 1.0.0.10.in-addr.arpa. PTR <a href="http://host.example.microsoft.com">host.example.microsoft.com</a>.</p><p><strong>8.服务记录 [SRV]</strong></p><p>描述: SRV 资源记录允许管理员使用单一 DNS 域的多个服务器，容易的用管理功能将 TCP/IP 服务从一个主机移到另一个主机，并且将服务提供的程序主机分派为服务的主服务器，将其它的分派为辅助的语法: <a href="http://service.protocol.name">service.protocol.name</a> ttl class SRV preference weight port target 例子: ldap.tcp.ms-dcs SRV 0 0 389 <a href="http://dc1.example.microsoft.com">dc1.example.microsoft.com</a> SRV 10 0 389 <a href="http://dc2.example.microsoft.com">dc2.example.microsoft.com</a></p><p><strong>9.已知服务记录 [WKS]</strong></p><p>描述: 用来描述一个特定 IP 地址上特定通讯协议支持的 TCP/IP 服务，它提供 TCP 和 UDP 可使用性信息。如果服务器同时支持 TCP 和 UDP 的已知服务，或者有多个支持服务的 IP 地址，多个 WKS 记录会被使用语法: owner ttl class WKS address protocol service_list 例子: <a href="http://example.microsoft.com">example.microsoft.com</a>. WKS 10.0.0.1 TCP ( telnet smtp ftp ) 　　在&quot;起始颁发机构&quot; SOA 中，记录了这个 Zone 中 DNS 服务器是那一台主机，也记录着负责本 zone 的管理员的邮件地址，如果以后在安装邮件服务器需要修改该信息时，注意将邮件地址中的 “@” 符改为句点 “.” ，因为 “@” 是保留字，代表 zone；另外，要使用域完整名称 FQDN，不要漏掉最后的句点。可以通过 &quot;zone→属性→起始颁发机构&quot;对管理员邮件地址进行修改。</p></blockquote></div><h2 id="dnspython库">dnspython库</h2><div class="story post-story"><p>如果查询不到对应的结果报<font color="red">dns.resolver.NoAnswer</font>错误：</p><pre class="language-python" data-language="python"><code class="language-python">dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>NoAnswer<span class="token punctuation">:</span> The DNS response does <span class="token keyword">not</span> contain an answer to the question<span class="token punctuation">:</span> baidu<span class="token punctuation">.</span>com<span class="token punctuation">.</span> IN XXX</code></pre><p>可以使用如下：</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>    re <span class="token operator">=</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>query<span class="token punctuation">(</span>qname<span class="token punctuation">,</span>rdtype<span class="token punctuation">)</span><span class="token keyword">except</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>NoAnswer<span class="token punctuation">:</span>   XXXX</code></pre></div><h2 id="解析-A记录">解析 A记录</h2><div class="story post-story"><pre class="language-python" data-language="python"><code class="language-python"><span class="token triple-quoted-string string">'''如果不知道返回的Re 结果怎么取值， 可以通过 print(re.__dict__) 查看返回结果的内置对象或者print(dir(re))'''</span><span class="token keyword">import</span> dns<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    re <span class="token operator">=</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"www.bai.com"</span><span class="token punctuation">,</span><span class="token string">"A"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>rrset<span class="token punctuation">:</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>response<span class="token punctuation">.</span>answer<span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>items<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''output:&#123;'qname': &lt;DNS name baidu.com.>, 'rdtype': 1, 'rdclass': 1, 'response': &lt;DNS message, ID 22745>, 'canonical_name': &lt;DNS name baidu.com.>, 'rrset': &lt;DNS baidu.com. IN A RRset>, 'expiration': 1637812232.3766685&#125;---------------------华丽的分割线1----------------------220.181.38.148220.181.38.251---------------------华丽的分割线2----------------------220.181.38.148220.181.38.251'''</span></code></pre></div><h2 id="解析-CNAME记录">解析 CNAME记录</h2><div class="story post-story"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> dns<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    re <span class="token operator">=</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"www.baidu.com"</span><span class="token punctuation">,</span><span class="token string">'CNAME'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>rrset<span class="token punctuation">:</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>response<span class="token punctuation">.</span>answer<span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>items<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''output: &#123;'qname': &lt;DNS name www.baidu.com.>, 'rdtype': 5, 'rdclass': 1, 'response': &lt;DNS message, ID 21322>, 'canonical_name': &lt;DNS name www.baidu.com.>, 'rrset': &lt;DNS www.baidu.com. IN CNAME RRset>, 'expiration': 1637813064.512025&#125;---------------------华丽的分割线1----------------------www.a.shifen.com.---------------------华丽的分割线2----------------------www.a.shifen.com.---------------------华丽的分割线3----------------------www.a.shifen.com.'''</span></code></pre></div><h2 id="解析-MX记录">解析 MX记录</h2><div class="story post-story"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> dns<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    re <span class="token operator">=</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"baidu.com"</span><span class="token punctuation">,</span><span class="token string">"MX"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>rrset<span class="token punctuation">:</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>response<span class="token punctuation">.</span>answer<span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>items<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'MX preference ='</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>preference<span class="token punctuation">,</span> <span class="token string">'mail exchanger ='</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>exchange<span class="token punctuation">)</span>        <span class="token triple-quoted-string string">'''output:&#123;'qname': &lt;DNS name baidu.com.>, 'rdtype': 15, 'rdclass': 1, 'response': &lt;DNS message, ID 47237>, 'canonical_name': &lt;DNS name baidu.com.>, 'rrset': &lt;DNS baidu.com. IN MX RRset>, 'expiration': 1637817511.307147&#125;---------------------华丽的分割线1----------------------20 mx1.baidu.com.15 mx.n.shifen.com.20 mx50.baidu.com.20 usmx01.baidu.com.20 jpmx.baidu.com.10 mx.maillb.baidu.com.---------------------华丽的分割线2----------------------20 mx1.baidu.com.15 mx.n.shifen.com.20 mx50.baidu.com.20 usmx01.baidu.com.20 jpmx.baidu.com.10 mx.maillb.baidu.com.---------------------华丽的分割线3----------------------MX preference = 20 mail exchanger = mx1.baidu.com.MX preference = 15 mail exchanger = mx.n.shifen.com.MX preference = 20 mail exchanger = mx50.baidu.com.MX preference = 20 mail exchanger = usmx01.baidu.com.MX preference = 20 mail exchanger = jpmx.baidu.com.MX preference = 10 mail exchanger = mx.maillb.baidu.com.'''</span></code></pre></div><h2 id="解析-NS记录">解析 NS记录</h2><div class="story post-story"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> dns<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    re <span class="token operator">=</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"baidu.com"</span><span class="token punctuation">,</span><span class="token string">"NS"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>rrset<span class="token punctuation">:</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>response<span class="token punctuation">.</span>answer<span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>items<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''output:&#123;'qname': &lt;DNS name baidu.com.>, 'rdtype': 2, 'rdclass': 1, 'response': &lt;DNS message, ID 64405>, 'canonical_name': &lt;DNS name baidu.com.>, 'rrset': &lt;DNS baidu.com. IN NS RRset>, 'expiration': 1637815874.9459918&#125;---------------------华丽的分割线1----------------------dns.baidu.com.ns4.baidu.com.ns3.baidu.com.ns7.baidu.com.ns2.baidu.com.---------------------华丽的分割线2----------------------dns.baidu.com.ns4.baidu.com.ns3.baidu.com.ns7.baidu.com.ns2.baidu.com.---------------------华丽的分割线3----------------------dns.baidu.com.ns4.baidu.com.ns3.baidu.com.ns7.baidu.com.ns2.baidu.com.Process finished with exit code 0'''</span></code></pre></div><h2 id="解析-DMARC-记录">解析 DMARC 记录</h2><div class="story post-story"><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> dns<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    re <span class="token operator">=</span> dns<span class="token punctuation">.</span>resolver<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"_dmarc."</span><span class="token operator">+</span><span class="token string">"google.com"</span><span class="token punctuation">,</span><span class="token string">"TXT"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>rrset<span class="token punctuation">:</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">.</span>response<span class="token punctuation">.</span>answer<span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>items<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&#123;:-^50s&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"华丽的分割线3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> re<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>to_text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token triple-quoted-string string">'''output:---------------------华丽的分割线1----------------------v=DMARC1; p=reject; rua=mailto:mailauth-reports@google.com---------------------华丽的分割线2----------------------"v=DMARC1; p=reject; rua=mailto:mailauth-reports@google.com"---------------------华丽的分割线3----------------------"v=DMARC1; p=reject; rua=mailto:mailauth-reports@google.com"'''</span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5G空口协议栈</title>
      <link href="/posts/f5bfc31f/"/>
      <url>/posts/f5bfc31f/</url>
      
        <content type="html"><![CDATA[<h1>5G 空口协议栈</h1><blockquote><p>create date: 2021-10-28 09:03:43</p></blockquote><p>[TOC]</p><h2 id="一、空口协议栈概述">一、空口协议栈概述</h2><div class="story post-story"><h3 id="（一）、控制面">（一）、控制面</h3><img src="https://i.loli.net/2021/11/14/v8Vk4gK6bxQmC2G.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/v8Vk4gK6bxQmC2G.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>● 层三</p><ul><li>NAS：会话管理、用户管理、安全管理、计费。</li><li>RRC：系统消息、准入控制、安全管理、测量与上报、切换和移动性、NAS消息传输、无线资源管理。</li></ul><p>● 层二</p><p>对不同的层三数据进行区分标识，并提供不同的服务</p><ul><li>PDCP（分组数据汇聚协议层）：传输用户面和控制面数据、维护PDCP的SN号、路由和重复（双连接场景）、加密/解密和完整性保护、重排序、支持乱序递交、 重复丢弃、ROHC（用户面）。</li><li>RLC（无线链路控制层）：检错、纠错ARQ（AM实体）；分段重组（UM实体和AM实体）；重分段（AM实体）；重复包检测（AM实体）。</li><li>MAC（媒体接入层）：逻辑信道和传输信道之间的映射、复用/解复用、调度、HARQ、逻辑信道优先级设置。</li></ul><p>● 层一</p><p>物理层为高层的数据提供无线资源及物理层的处理</p><p>PHY（物理层）</p><ul><li>场景编码：控制信道Polar码，业务信道LDPC码；</li><li>调制：QPSK、16QAM、64QAM、256QAM；</li><li>massiveMIMO：<a href="https://zhuanlan.zhihu.com/p/338056199">详见第1部分-massiveMIMO概述</a></li></ul><h3 id="（二）、用户面">（二）、用户面</h3><img src="https://i.loli.net/2021/11/14/Sf9GlDs8tdOxk1B.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/Sf9GlDs8tdOxk1B.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>● 层二增加SDAP层(<code>Service Data Adaptation Protocol</code>,服务数据适配协议)</p><p>在SA组网下，4G网络中的无线承载的概念依然被沿用，但5G核心网为了使业务实现更加的精细化，5G的基本业务的传输单位从4G时代承载的概念细化到以QoS Flow。SDAP协议栈功能就是完成无线侧的承载（DRB）与5GC中的QoSFlow进行映射</p></div><h2 id="二、RRC层功能介绍">二、RRC层功能介绍</h2><div class="story post-story"><img src="https://i.loli.net/2021/11/14/vIaCKckrW4Zpqyi.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/vIaCKckrW4Zpqyi.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>RRC（<code>Radio Resource Control</code>，无线资源控制）层，是整个无线通信协议栈接入层的消息配置中心及控制中心，其重要性不言而喻。RRC层的主要作用是给其下层（<code>PDCP</code>,<code>RLC</code>,<code>MAC</code>,<code>PHY</code>）控制和配置所有无线资源，从而可以使UE与基站之间进行通信。</p><h3 id="（一）、功能">（一）、功能</h3><img src="https://i.loli.net/2021/11/14/VdlWJ3C6aovZhuG.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/VdlWJ3C6aovZhuG.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>RRC层位于PDCP层之上，功能和LTE基本一致</p><ul><li>系统消息</li><li>准入控制</li><li>安全管理</li><li>测量与上报</li><li>切换和移动性</li><li>NAS消息传输</li><li>无限资源管理</li></ul><h3 id="（二）、RRC状态">（二）、RRC状态</h3><p>● Connected/IDEL</p><img src="https://i.loli.net/2021/11/14/2AmGX4f5qJuVngH.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/2AmGX4f5qJuVngH.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>LTE时仅有这两个状态，用户要传数据必须在<code>RRC_C0NNECTED</code>状态，因为该状态下各个节点之间的通道都需要打通；IDEL状态是与基站的资源（DRB承载、S1承载）都要释放，而核心网资源保留。两种状态通过寻呼和RRC释放转换。5G两种状态与LTE一致。</p><p>● Inactive</p><p>相对于LTE，NR新增了Inactive状态。在该状态下UE存储AS上下文信息，监听寻呼以及执行小区重选流程。在RRC Inactive状态下，UE和gNB只会维持RRC和PDCP层的链接，gNB和UE会释放C-RNTI上下文；为了标识用户，gNB和UE侧会新建立I-RNTI用于用户的标识。仅释放空口资源，简化了RRC状态转换的流程，节省了用户返回链接态的时延，减少了信令开销，但现网尚未启用。</p><h3 id="（三）、定义RNA（RAN-Based-Notification-Area）">（三）、定义RNA（RAN-Based Notification Area）</h3><p>RNA可以覆盖一个基站或者多个基站，但一定要在核心网配置的注册区范围内 当UE的RNA定时器超时或者UE移动出了RNA范围时，UE都要发起RANU（RAN-based notification area update）流程</p><p>关于如何配置RNA有几种不同的选择：</p><ol><li>-小区列表：<ol><li>–gNB给UE提供一个明确的小区列表作为RNA。</li></ol></li><li>-RAN area列表：<ol><li>–gNB给UE提供一个RAN area ID列表作为RNA，这里提供的RAN area是CN Tracking Area的一个子集或者等于CN Tracking Area，一个RAN area对应一个RAN area ID，一个RAN area由TAI和一个可选的RAN area Code组成。</li><li>–一个小区会在其系统消息广播它的RAN area ID。 参考：<strong>TS23.501、TS38.413</strong></li></ol></li></ol><p>● 当UE处于RRC_INACTIVE时，如果最后一个服务gNB收到来自UPF的下行数据或者来自AMF的下行信令，则该gNB在RNA的所有小区寻呼UE，如果RNA的小区属于邻gNB的，则通过Xn口给对应的邻gNB发送<code>XnAP-RAN-Paging</code>消息。如果RAN寻呼失败，则【见于TS23.501 5.3.3.2.5】：</p><ul><li>如果NG-RAN有NAS PDU要发给UE，则RAN节点应该发起AN Release流程释放UE的N2口连接，将UE的CM状态迁移到<code>CM_IDLE</code>状态。</li><li>如果NG-RAN仅仅只有用户面数据要发送给UE，则NG-RAN节点可以继续保留N2连接或者发起AN Release流程释放N2口连接，如何选择取决于NG-RAN的本地配置。</li><li>注：在RAN寻呼失败时触发RAN寻呼的用户面数据包可能会丢失。</li></ul><p>● AMF给NG-RAN提供RRC Inactive Assistance Information，以供NG-RAN用于决定UE是否可以进入RRC_INACTIVE状态；这个RRC Inactive Assistance Information信息包括：配置给UE的注册区、UE特定的DRX、周期注册定时器、MICO指示、UE id index值等。</p><img src="https://i.loli.net/2021/11/14/kMRCdfLJvlO2pIe.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/kMRCdfLJvlO2pIe.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p><strong>● RNA更新流程</strong></p><p>● UE触发的RNA更新过程，包括在Xn接口上的上下文检索。这个过程可能会在UE移动出所配置的RNA时触发，或者周期性地触发。</p><img src="https://i.loli.net/2021/11/14/cHwmlfnW7o9DGyO.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/cHwmlfnW7o9DGyO.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><ol><li><p>UE从RRC_INACTIVE状态恢复，提供由最后服务的gNB分配的I-RNTI和适当的原因值，例如RNA更新。</p></li><li><p>如果gNB能够解析I-RNTI中包含的gNB标识，则请求最后服务的gNB提供UE上下文，提供步骤1中接收到的原因值。</p></li><li><p>最后服务的gNB可以提供UE上下文(如下所述)。另外,最后服务gNB可能决定把问题转移到RRC_IDLE(且程序遵循步骤3和图9.2.2.5-3之后),或者如果问题仍在前面配置的RNA,使问题过去服务上下文gNB和保持问题RRC_INACTIVE(且程序遵循步骤3和图9.2.2.5-2之后)。</p></li><li><p>gNB可以将UE转移到RRC_CONNECTED状态，或者使UE重回RRC_IDLE态(这种情况下，gNB发送一条RRCRelease消息)，或者使UE返回RRC_INACTIVE，如下假定。</p></li><li><p>如果要防止在最后服务gNB中缓冲的下行用户数据的丢失，则接入的gNB给最后服务gNB提供下行数据转发地址</p></li></ol><p>6/7. gNB进行路径切换（向服务AMF发路径切换请求消息，AMF回复路径切换响应消息 ）</p><ol start="8"><li><p>gNB通过发送带有挂起指示的RRCRelease来使终端处于RRC_INACTIVE状态</p></li><li><p>通知最后服务的gNB释放UE上下文</p></li></ol><p>● 当UE仍然在所配置的RNA，并且最后服务的gNB判定不重新定位UE上下文，并保持UE在RRC_INACTIVE的情况下的RNA更新过程</p><img src="https://i.loli.net/2021/11/14/c2uj8FfXP5VYEIa.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/c2uj8FfXP5VYEIa.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><ol><li><p>UE从RRC_INACTIVE状态恢复，提供由最后服务的gNB分配的I-RNTI和适当的原因值，例如RNA更新。</p></li><li><p>如果gNB能够解析I-RNTI中包含的gNB标识，则请求最后服务的gNB提供UE上下文，提供步骤1中接收到的原因值。</p></li><li><p>最后提供服务的gNB存储接收到的用于下次尝试恢复的消息(例如与要恢复小区相关的C-RNTI和PCI)，并以检索UE上下文失败消息(包括封装的RRCRelease消息)响应gNB。RRCRelease消息包括暂停指示。</p></li><li><p>gNB将RRCRelease消息转发到UE。</p></li></ol><p>● 当最后服务的gNB决定移动终端到RRC_IDLE的情况下的RNA更新过程</p><img src="https://i.loli.net/2021/11/14/uaZvcOkXbV87UeP.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/uaZvcOkXbV87UeP.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><ol><li><p>UE从RRC_INACTIVE状态恢复，提供由最后服务的gNB分配的I-RNTI和适当的原因值，例如RNA域更新。</p></li><li><p>如果gNB能够解析I-RNTI中包含的gNB标识，则请求最后服务的gNB提供UE上下文，提供步骤1中接收到的原因值。</p></li><li><p>最后服务的gNB提供一条<code>RRC Release</code>消息，使UE转换到<code>RRC_IDLE</code>状态，而不提供UE上下文。</p></li><li><p>最后服务的gNB删除UE上下文。</p></li><li><p>gNB发送<code>RRC Release</code>消息，触发转换到<code>RRC_IDLE</code>状态。</p></li></ol><h3 id="（四）、状态转换">（四）、状态转换</h3><img src="https://i.loli.net/2021/11/14/VQKGCBf2UaLFRgn.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/VQKGCBf2UaLFRgn.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><img src="https://i.loli.net/2021/11/14/P8NBAeqZpkmSXKd.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/P8NBAeqZpkmSXKd.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>RRC_CONNECTED 和 RRC_INACTIVE可以互相转换 ；RRC_CONNECTED 和 RRC_IDLE可以互相转换 ；RRC_INACTIVE 只能单向释放资源转换到RRC_IDLE</p><p>参考：TS38.300、TS38.331</p><p><strong>● RRC_CONNECTED to RRC_INACTIVE</strong></p><ul><li>通过定时器超时触发（T380）</li></ul><p><strong>● RRC_INACTIVE to RRC_IDLE</strong></p><ul><li>通过定时器超时触发（一般是1500s）</li></ul><p><strong>● RRC_INACTIVE to RRC_CONNECTED</strong></p><ul><li>UE发起：UE上下文检索成功状态下：UE触发从RRC_INACTIVE到RRC_CONNECTED的转换</li></ul><img src="https://i.loli.net/2021/11/14/SdionFX7mwygaUx.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/SdionFX7mwygaUx.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>1.UE从RRC_INACTIVE恢复，提供由最后服务gNB分配的I-RNTI</p><p>2.如果能够解析I-RNTI中包含的gNB身份，则gNB请求最后服务gNB提供UE上下文数据</p><p>3.最后服务gNB提供UE上下文数据</p><p>4/5.gNB完成RRC连接的恢复 注意:如果授权允许，用户数据也可以在步骤5中发送</p><p>6.如果要防止在最后服务gNB中缓冲的下行用户数据的丢失，则接入的gNB给最后服务gNB提供下行数据转发地址</p><p>7/8.gNB执行路径切换（向服务AMF发路径切换请求消息,AMF回复路径切换响应消息 ）</p><p>9.通知最后服务gNB释放UE的资源</p><ul><li>UE发起：UE上下文检索失败状态下：UE触发从RRC_INACTIVE到RRC_CONNECTED的转换</li></ul><img src="https://i.loli.net/2021/11/14/PeLjvI8ABYkCbx2.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/PeLjvI8ABYkCbx2.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>\1. UE从RRC_INACTIVE恢复，提供I-RNTI，由最后服务的gNB分配。</p><p>\2. 如果gNB能够解析I-RNTI中包含的gNB标识，就请求最后服务的gNB提供UE上下文数据。</p><p>\3. 最后一个服务的gNB无法检索或验证终端上下文数据。</p><p>\4. 最后一次服务的gNB向gNB返回失败信息。</p><p>\5. gNB执行回退，通过发送RRCSetup来建立新的RRC连接。</p><p>\6. 建立新的RRC Connection。</p><ul><li>网络拒绝：终端试图从RRC_INACTIVE恢复连接时，网络拒绝的情况</li></ul><img src="https://i.loli.net/2021/11/14/tUuMLKYxcp3I8jd.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/tUuMLKYxcp3I8jd.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>\1. UE尝试从RRC_INACTIVE恢复连接。</p><p>\2. gNB无法处理这个流程，例如由于拥塞。</p><p>\3. gNB发送RRCReject(带有等待时间信息)来保持UE处于RRC_INACTIVE状态。</p><ul><li>网络发起：网络触发的从RRC_INACTIVE到RRC_CONNECTED的转换</li></ul><img src="https://i.loli.net/2021/11/14/BcAlbu4EvXhxzpC.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/BcAlbu4EvXhxzpC.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>1.发生RAN寻呼触发事件（收到下行用户面数据，来自5GC的下行信令等） 2.触发RAN寻呼，寻呼范围是RNA 3.使用 I-RNTI寻呼UE 4.如果UE被寻呼到，则后续流程同上面的“UE发起：UE触发从RRC_INACTIVE到RRC_CONNECTED的转换”</p></div><h2 id="三、SDAP层">三、SDAP层</h2><div class="story post-story"><img src="https://i.loli.net/2021/11/14/Hh2oEWj91NTf6Z5.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/Hh2oEWj91NTf6Z5.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>(Service Data Adaptation Protocol,服务数据适配协议层)属于层二，只存在于用户面，位于PDCP层以上，直接承载IP数据包。 负责QoS流与DRB（数据无线承载）之间的映射 为数据包添加QFI（QoS flow ID）标识</p><h3 id="（一）、承载">（一）、承载</h3><p>● <strong>4G基于EPS承载</strong></p><img src="https://i.loli.net/2021/11/14/ngH8aIpAdNJus96.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/ngH8aIpAdNJus96.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>● 特点：</p><ul><li>QoS控制的基本粒度是EPS承载(Bearer)；</li><li>需要通过建立多个专用承载为UE提供具有不同QoS保障的业务。</li></ul><p>● 局限：</p><ul><li>LTE QoS机制更适用于运营商内部应用；</li><li>基于承载的QoS管理机制粒度较粗，无法实现业务流粒度的QoS控制；</li><li>承载建立信令开销大、较慢，无法跟踪TCP session变化。</li></ul><p><strong>● 5G承载基于QoS架构：</strong></p><img src="https://i.loli.net/2021/11/14/f7Embo1usU2yLgl.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/f7Embo1usU2yLgl.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>5GC会为每个UE建立一个或多个PDU（协议数据单元）会话（PDU session），PDU会话可能会建立一个或多个QoS流，NG-RAN会为拥有不同需求的QoS流建立不同的DRB，或将属于同一PDU会话的多个QoS流映射到同一个DRB上</p><p>● 5G QoS模型基于QoS流，QoS流是PDU会话内区分QoS差异的最佳粒度，并且由QoS流ID（QFI）唯一标记，每个QoS流都把其相关联的QoS属性进行集合。</p><p>● 一个QoS规则包含：关联的QoS流的QFI、数据包过滤器集（一个过滤器列表）、优先级。一个QoS流可以有多个QoS规则。</p><p>● UE和UPF（用户平面功能）通过Packet Filter Set将业务和QoS流关联，RAN侧将QoS流映射到DRB上，来确保服务的质量</p><p>● 5G QoS 架构只用于SA组网</p><p>● 一个QoS流的QoS配置包含的QoS参数如下：</p><ul><li>每条GBR QoS流的QoS配置可能还会包含：指示控制、最大丢包率。</li><li>每条GBR QoS流的QoS配置还会包含参数：保证流比特率(GFBR)、最大流比特率(MFBR)、AMBR（Aggregate Maximum Bit Rate，用来钳制Non GBR总带宽）。</li><li>每条Non-GBR QoS流的QoS配置可能还会包含参数：反射QoS属性（RQA）。</li><li>每条QoS流的QoS配置都会包含的QoS参数：5QI（定义QoS等级：时延、误块、优先级）、ARP。</li></ul><h3 id="（二）、SDAP层处理流程">（二）、SDAP层处理流程</h3><img src="https://i.loli.net/2021/11/14/OGUKEqCp8AZbF6S.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/OGUKEqCp8AZbF6S.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>是否添加SDAP头取决于UE上行的QoS流的映射方法，如果采用反射式映射，则gNB必须添加SDAP头，用于标识该数据包的QoS流。若果采用基于配置的映射，则gNB无需添加SDAP包头</p></div><h2 id="四、PDCP层">四、PDCP层</h2><div class="story post-story"><img src="https://i.loli.net/2021/11/14/nABFrEvIdRgMSO1.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/nABFrEvIdRgMSO1.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>数据分流的节点；Cloud RAN中CU,DU分离的节点</p><h3 id="（一）、功能-2">（一）、功能</h3><p>● <strong>LTE原有</strong></p><ul><li>传输用户面和控制面数据</li><li>维护PDCP的SN号</li><li>加密/解密和完整性保护（5G：用户面和控制面；4G：仅控制面 ）</li><li>重复丢弃</li><li>RoHC头压缩（用户面，需基站和UE均支持）</li></ul><p><strong>● NR新增</strong></p><ul><li>路由和重复（双连接场景时）</li><li>重排序（从RLC层移至PDCP层）</li><li>支持乱序递交</li></ul><h3 id="（二）、参数">（二）、参数</h3><p>● 在RoHC的框架下，针对不同协议的数据流，有不同的头部压缩算法。5G RFC定义了如下一些Profile用于RoHC压缩</p><img src="https://i.loli.net/2021/11/14/WL4zAnrNESuC2FX.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/WL4zAnrNESuC2FX.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>● RoHC（RObust Header Compression)是一种专为无限连路设计的数据包头压缩机制，以适应无线链路高误码率和长环回时间的链路特性。</p><ul><li>可靠性高：由于RoHC提供了反馈机制，因此它在高误码高时延东无线链路中具有更高的可靠性</li><li>压缩效率高：最小可将包头压缩成1个字节</li></ul><p>● 安全流程算法</p><ul><li>NIA0/NEA0：不进行完整性保护</li><li>128-NIA1/NEA1：128-bit SNOW 3G 欧洲</li><li>128-NIA2/NEA2：128-bit AES 美国</li><li>128-NIA3/NEA3：128-bit ZUC 中国</li></ul></div><h2 id="五、RLC层">五、RLC层</h2><div class="story post-story"><img src="https://i.loli.net/2021/11/14/gTVfkPKvwseiZdz.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/gTVfkPKvwseiZdz.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>位于PDCP层以下 实体分为TM实体、UM实体、AM实体，AM数据收发共用一个实体，UM和TM收发实体分开 不同于LTE，NR RLC层组装RLC层PDU时，不需要底层MAC通知是否有发送机会，可先行封装PDU包，RLC也没有串联功能（下移到MAC层），但RLC PDU要真正发送出去同样需要等待MAC层指示</p><h3 id="（一）、实体">（一）、实体</h3><ul><li>TM：透传，不做任何处理</li><li>AM：确认，需要ACK/NACK</li><li>UM：非确认，没有纠错机制，时延低（VoIP业务）</li></ul><h3 id="（二）、功能">（二）、功能</h3><ul><li>检错、纠错ARQ（AM）</li><li>分段重组（UM,AM）</li><li>重分段（AM）</li><li>重复包检测（AM）</li><li><em><strong>取消了串联功能</strong></em></li></ul><p>● 六、MAC层</p><img src="https://i.loli.net/2021/11/14/GsNCRAxEnpvIJlm.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/GsNCRAxEnpvIJlm.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>MAC层用于逻辑信道到传输信道的映射 UE和基站侧都有MAC层实体,但存在DC（双连接）时，终端则会存在多个MAC实体</p><p><strong>● 调度</strong></p><p>关键功能</p><p>● UE调度请求</p><ul><li>PRACH：当手机空口IDEL态</li><li>SR-PUCCH：RRC链接还在，只是没有上行资源</li></ul><p>● gNB授权</p><p>● UE状态报告</p><p>● gNB上下行调度PDCCH</p><p>● UE解时频资源位置，数据传输，HARQ</p><p><strong>● 逻辑信道和传输信道之间的映射（信道的复用和解复用）</strong></p><p><strong>● HARQ控制</strong></p><ul><li><strong>同步HARQ：一个HARQ进程发生在固定的时刻，接收端预先知道重传的时刻。</strong></li><li><strong>异步HARQ：一个HARQ进程可以发生在任何时刻，接收端预先不知道重传的时刻</strong></li><li><strong>根据重传的数据特征是否发生变化（重传的MCS与初始的一致为非自适应，不一样则为自适应），可以分为自适应和非自适应。目前NR上下行全部采用异步自适应重传</strong>。</li><li>（1）上行采用异步自适应的HARQ,基站侧不需要反馈ACK/NACK,所以5G取消了PHICH,节省了信道资源。在下次调度时，通过NDI（新老数据指示，0为重传，1为初传）字段，间接通知UE上行数据解调是否成功。</li></ul><img src="https://i.loli.net/2021/11/14/2zjOPBxdWRE5hiM.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/2zjOPBxdWRE5hiM.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><ul><li>（2）下行采用异步自适应的HARQ，需要指示UE反馈ACK/NACK的时域位置</li></ul><img src="https://i.loli.net/2021/11/14/3ctdg8lFuMfseIW.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/3ctdg8lFuMfseIW.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p><strong>● 逻辑信道优先级控制</strong></p></div><h2 id="七、PHY层">七、PHY层</h2><div class="story post-story"><img src="https://i.loli.net/2021/11/14/yIRGK5sL3uHb7f9.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/yIRGK5sL3uHb7f9.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><h3 id="（一）、物理层处理流程">（一）、物理层处理流程</h3><img src="https://i.loli.net/2021/11/14/MhzTUZCAidnpoHx.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/MhzTUZCAidnpoHx.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>物理层是空口协议栈最复杂的一层，如图所示的是物理层的典型流程，但不同信道的处理过程会有所变化。</p><ul><li>TB（Transport Block，传输块）：1个TB包含1个MAC PDU的数据块</li><li>CW（Code Word，码字）：首先对每个TB添加CRC，然后进行码块分段生成若干CB（Code Block，码块），对每个码块增加CRC、信道编码、速率匹配之后，得到码字</li></ul><img src="https://i.loli.net/2021/11/14/3oXfV2pPgWCELN4.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/3oXfV2pPgWCELN4.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><ul><li>层：也就是流，码字通过层映射到不同的流上，实现串行到并行的转换。流越多，速率就会越高。</li><li>调制：更高阶的调制方式使每符号携带的比特数更大，从而实现更高的传输速率。</li></ul><img src="https://i.loli.net/2021/11/14/zeJYxn3RQNsiZKl.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/zeJYxn3RQNsiZKl.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><ul><li>天线端口：天线的逻辑端口，每个端口号上有自己独立的DMRS信号。取代了LTE中CRS参考信号，节省了功率的开销，缓解了MOD 3干扰。</li><li>编码：eMBB场景，控制信道使用Polar码编码，业务信道使用LDPC码编码</li><li>层映射：把码字映射到多个层并行发送的过程</li><li>预编码：经过加权，使数据流映射到天线端口</li><li>波束：各层数据通过赋型加权后映射到天线上发送，在权值的作用下，波束指向UE。波束的个数与流的个数相同。</li></ul><img src="https://i.loli.net/2021/11/14/tkjDaxmXg3bS4qO.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/tkjDaxmXg3bS4qO.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><h3 id="（二）、准共址（QCL-Quasi-Co-Location">（二）、准共址（QCL,Quasi Co-Location)</h3><img src="https://i.loli.net/2021/11/14/uTzefyZnlvFrKRD.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/uTzefyZnlvFrKRD.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p>● 功能：5G数据通过波束的方式发送，每个信道在空口的波束上如何发送写一种没有定义，终端通过两个信号的QCL关系可以从某已知信号的传播特征中推导出未知信号的传播特征，进而提高终端对未知信道的解调能力。</p><p>● QCL类型：由于不同信号的波束发送方式不同，特性可能存在差异，所以有QCL类型之分。</p><img src="https://i.loli.net/2021/11/14/oLsb3UVPWwaKcz7.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/oLsb3UVPWwaKcz7.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom:150%;" /><p><img src="C:/siz_bak/siz_Master/Dropbox/Master/%E8%AE%BA%E6%96%87&amp;%20%E9%A1%B9%E7%9B%AE%20md/LTE%204G&amp;5G/5G%20Basic%20Knowledge/img_article/5G%20%E7%A9%BA%E5%8F%A3%E5%8D%8F%E8%AE%AE%E6%A0%88/kjy8loegrMiBwZP.jpg" class="lazyload" data-srcset="C:/siz_bak/siz_Master/Dropbox/Master/%E8%AE%BA%E6%96%87&amp;%20%E9%A1%B9%E7%9B%AE%20md/LTE%204G&amp;5G/5G%20Basic%20Knowledge/img_article/5G%20%E7%A9%BA%E5%8F%A3%E5%8D%8F%E8%AE%AE%E6%A0%88/kjy8loegrMiBwZP.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="5G空口协议栈思维导图"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> 5G </tag>
            
            <tag> [object Object] </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>4G&amp;5G缩写词定义</title>
      <link href="/posts/cdc9cc72/"/>
      <url>/posts/cdc9cc72/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>缩写</th><th>全称</th><th>解释</th></tr></thead><tbody><tr><td>4G-GUTI</td><td>4G-Globally Unique Temporary  Identifier</td><td>4G-全球唯一临时标识符</td></tr><tr><td>5GCN</td><td>5G Core Network</td><td>5G核心网络</td></tr><tr><td>5G-GUTI</td><td>5G-Globally Unique Temporary Identifier</td><td>5G-全球唯一临时标识符</td></tr><tr><td>5GMM</td><td>5GS Mobility Management</td><td>5GS移动管理</td></tr><tr><td>5G-RG</td><td>5G Residential Gateway</td><td>5G住宅网关</td></tr><tr><td>5G-BRG</td><td>5G Broadband Residential Gateway</td><td>5G宽带住宅网关</td></tr><tr><td>5G-CRG</td><td>5G Cable Residential Gateway</td><td>5G有线住宅网关</td></tr><tr><td>5GS</td><td>5G System</td><td>5G系统</td></tr><tr><td>5GSM</td><td>5GS Session Management</td><td>5G会话管理</td></tr><tr><td>5G-S-TMSI</td><td>5G S-Temporary Mobile Subscription Identifier</td><td>5G S-临时移动订阅标识符</td></tr><tr><td>5G-TMSI</td><td>5G Temporary Mobile Subscription Identifier</td><td>5G 临时移动订阅标识符</td></tr><tr><td>5QI</td><td>5G QoS Identifier</td><td>5G QoS 标识符</td></tr><tr><td>ACS</td><td>Auto-Configuration Server</td><td>自动配置服务器</td></tr><tr><td>AKA</td><td>Authentication and Key Agreement</td><td>身份验证和密钥协议</td></tr><tr><td>AKMA</td><td>Authentication and Key Management for Applications</td><td>应用程序的 AKMA 身份验证和密钥管理</td></tr><tr><td>A-KID</td><td>AKMA Key Identifier</td><td>AKMA 密钥标识符</td></tr><tr><td>A-TID</td><td>AKMA Temporary Identifier</td><td>AKMA 临时标识符</td></tr><tr><td>AMBR</td><td>Aggregate Maximum Bit Rate</td><td>聚合最大比特率</td></tr><tr><td>AMF</td><td>Access and Mobility Management Function</td><td>访问和移动管理功能</td></tr><tr><td>APN</td><td>Access Point Name</td><td>接入点名称</td></tr><tr><td>ATSSS</td><td>Access Traffic Steering, Switching and Splitting</td><td>接入流量转向、切换和分流</td></tr><tr><td>AUSF</td><td>Authentication Server Function</td><td>认证服务器功能</td></tr><tr><td>CAG</td><td>Closed access group</td><td>封闭访问组</td></tr><tr><td>CHAP</td><td>Challenge Handshake Authentication Protocol</td><td>质询握手认证协议</td></tr><tr><td>DDX</td><td>Downlink Data Expected</td><td>预期 DDX 下行数据</td></tr><tr><td>DL</td><td>Downlink</td><td>下行链路</td></tr><tr><td>DN</td><td>Data Network</td><td>数据网络</td></tr><tr><td>DNN</td><td>Data Network Name</td><td>数据网络名称</td></tr><tr><td>DNS</td><td>Domain Name System</td><td>域名系统</td></tr><tr><td>eDRX</td><td>Extended DRX cycle</td><td>扩展 DRX 周期</td></tr><tr><td>DS-TT</td><td>Device-Side TSN Translator</td><td>设备端 TSN 转换器</td></tr><tr><td>EUI</td><td>Extended Unique Identifier</td><td>扩展唯一标识符</td></tr><tr><td>E-UTRAN</td><td>Evolved Universal Terrestrial Radio Access Network</td><td>演进的通用陆地无线接入网络</td></tr><tr><td>EAC</td><td>Early Admission Control</td><td>早期进入控制</td></tr><tr><td>EAP-AKA’</td><td>Improved Extensible Authentication Protocol method for 3rd  generation Authentication and Key Agreement</td><td>用于第三代身份验证和密钥协议的改进的可扩展身份验证协议方法</td></tr><tr><td>EAS</td><td>Edge Application Server</td><td>边缘应用服务器</td></tr><tr><td>EASDF</td><td>Edge Application Server Discovery Function</td><td>边缘应用服务器发现功能</td></tr><tr><td>ECIES</td><td>Elliptic Curve Integrated Encryption Scheme</td><td>椭圆曲线集成加密方案</td></tr><tr><td>ECS</td><td>Edge Configuration Server</td><td>边缘配置服务器</td></tr><tr><td>EEC</td><td>Edge Enabler Client</td><td>Edge Enabler 客户端</td></tr><tr><td>EPD</td><td>Extended Protocol Discriminator</td><td>EPD 扩展协议鉴别器</td></tr><tr><td>EMM</td><td>EPS Mobility Management</td><td>EPS 移动性管理</td></tr><tr><td>EPC</td><td>Evolved Packet Core Network</td><td>演进分组核心网</td></tr><tr><td>EPS</td><td>Evolved Packet System</td><td>演进分组系统</td></tr><tr><td>ESM</td><td>EPS Session Management</td><td>EPS 会话管理</td></tr><tr><td>FN-RG</td><td>Fixed Network RG</td><td>固网RG</td></tr><tr><td>FN-BRG</td><td>Fixed Network Broadband RG</td><td>固网宽带RG</td></tr><tr><td>FN-CRG</td><td>Fixed Network Cable RG</td><td>固网电缆 RG</td></tr><tr><td>Gbps</td><td>Gigabits per second</td><td>千兆位每秒</td></tr><tr><td>GFBR</td><td>Guaranteed Flow Bit Rate</td><td>保证浏览比特率</td></tr><tr><td>GUAMI</td><td>Globally Unique AMF Identifier</td><td>全球唯一 AMF 标识符</td></tr><tr><td>IAB</td><td>Integrated access and backhaul</td><td>集成接入和回传</td></tr><tr><td>IMEI</td><td>International Mobile station Equipment Identity</td><td>国际移动台设备标识</td></tr><tr><td>IMEISV</td><td>International Mobile station Equipment Identity and Software  Version number</td><td>IMEISV 国际移动台设备标识和软件版本号</td></tr><tr><td>IMSI</td><td>International Mobile Subscriber Identity</td><td>国际移动用户身份</td></tr><tr><td>IP-CAN</td><td>IP-Connectivity Access Network</td><td>IP-连通性接入网络</td></tr><tr><td>KSI</td><td>Key Set Identifier</td><td>密钥集标识符</td></tr><tr><td>LADN</td><td>Local Area Data Network</td><td>局域网数据网络</td></tr><tr><td>LCS</td><td>LoCation Services</td><td>位置服务</td></tr><tr><td>LMF</td><td>Location Management Function</td><td>位置管理功能</td></tr><tr><td>LPP</td><td>LTE Positioning Protocol</td><td>LTE 定位协议</td></tr><tr><td>MAC</td><td>Message Authentication Code</td><td>消息认证码</td></tr><tr><td>MA PDU</td><td>Multi-Access PDU</td><td>多路访问 PDU</td></tr><tr><td>Mbps</td><td>Megabits per second</td><td>兆比特每秒</td></tr><tr><td>MFBR</td><td>Maximum Flow Bit Rate</td><td>最大流比特率</td></tr><tr><td>MICO</td><td>Mobile Initiated Connection Only</td><td>仅限 MICO Mobile 发起的连接</td></tr><tr><td>MUSIM</td><td>Multi-USIM</td><td>多USIM</td></tr><tr><td>N3IWF</td><td>Non-3GPP Inter-Working Function</td><td>非 3GPP 互通功能</td></tr><tr><td>N5CW</td><td>Non-5G-Capable over WLAN</td><td>不支持 5G 的 WLAN</td></tr><tr><td>N5GC</td><td>Non-5G Capable</td><td>非 5G 能力</td></tr><tr><td>NAI</td><td>Network Access Identifier</td><td>网络访问标识符</td></tr><tr><td>NITZ</td><td>Network Identity and Time Zone</td><td>网络身份和时区</td></tr><tr><td>NR</td><td>New Radio</td><td>新无线电</td></tr><tr><td>ngKSI</td><td>Key Set Identifier for Next Generation Radio Access Network</td><td>下一代无线接入网络的 ngKSI 密钥集标识符</td></tr><tr><td>NPN</td><td>Non-public network</td><td>非公网</td></tr><tr><td>NSAC</td><td>Network Slice Admission Control</td><td>网络切片准入控制</td></tr><tr><td>NSACF</td><td>Network Slice Admission Control FunctionNSSAA Network  slice-specific authentication and authorization</td><td>网络切片准入控制功能NSSAA 网络切片专用认证授权</td></tr><tr><td>NSSAAF</td><td>NSSAA Function</td><td>NSSAA 功能</td></tr><tr><td>NSSAI</td><td>Network Slice Selection Assistance Information</td><td>网络切片选择辅助信息</td></tr><tr><td>OS</td><td>Operating System</td><td>操作系统</td></tr><tr><td>OS Id</td><td>OS Identity</td><td>操作系统 ID 操作系统身份</td></tr><tr><td>PAP</td><td>Password Authentication Protocol</td><td>密码认证协议</td></tr><tr><td>PCO</td><td>Protocol Configuration Option</td><td>协议配置选项</td></tr><tr><td>PEI</td><td>Permanent Equipment Identifier</td><td>永久设备标识符</td></tr><tr><td>PNI-NPN</td><td>Public Network Integrated Non-Public Network</td><td>公网综合非公网</td></tr><tr><td>ProSe</td><td>Proximity based Services</td><td>就近服务</td></tr><tr><td>ProSeP</td><td>5G ProSe policy</td><td>5G ProSe 政策</td></tr><tr><td>PTI</td><td>Procedure Transaction Identity</td><td>程序事务标识</td></tr><tr><td>PVS</td><td>Provisioning Server</td><td>供应服务器</td></tr><tr><td>QFI</td><td>QoS Flow Identifier</td><td>QoS 流标识符</td></tr><tr><td>QoS</td><td>Quality of Service</td><td>QoS 服务质量</td></tr><tr><td>QRI</td><td>QoS Rule Identifier</td><td>QoS 规则标识符</td></tr><tr><td>RACS</td><td>Radio Capability Signalling Optimisation</td><td>无线电能力信令优化</td></tr><tr><td>®AN</td><td>(Radio) Access Network</td><td>无线电接入网络</td></tr><tr><td>RFSP</td><td>RAT Frequency Selection Priority</td><td>RAT 频率选择优先级</td></tr><tr><td>RG</td><td>Residential Gateway</td><td>住宅网关</td></tr><tr><td>RPLMN</td><td>Registered PLMN</td><td>注册 PLMN</td></tr><tr><td>RQA</td><td>Reflective QoS Attribute</td><td>反射 QoS 属性</td></tr><tr><td>RQI</td><td>Reflective QoS Indication</td><td>反射式 QoS 指示</td></tr><tr><td>RSNPN</td><td>Registered SNPN</td><td>注册 SNPN</td></tr><tr><td>S-NSSAI</td><td>Single NSSAI</td><td>单 NSSAI</td></tr><tr><td>SA</td><td>Security Association</td><td>SA安全协会</td></tr><tr><td>SDF</td><td>Service Data Flow</td><td>服务数据流</td></tr><tr><td>SMF</td><td>Session Management Function</td><td>会话管理功能</td></tr><tr><td>SGC</td><td>Service Gap Control</td><td>服务差距控制</td></tr><tr><td>SNN</td><td>Serving Network Name</td><td>服务网络名称</td></tr><tr><td>SNPN</td><td>Stand-alone Non-Public Network</td><td>独立非公网</td></tr><tr><td>SOR</td><td>Steering of Roaming</td><td>漫游转向</td></tr><tr><td>SOR-CMCI</td><td>Steering of Roaming Connected Mode Control Information</td><td>漫游连接模式控制信息的 SOR-CMCI 转向</td></tr><tr><td>SUCI</td><td>Subscription Concealed Identifier</td><td>订阅隐藏标识符</td></tr><tr><td>SUPI</td><td>Subscription Permanent Identifier</td><td>订阅永久标识符</td></tr><tr><td>TA</td><td>Tracking Area</td><td>追踪区</td></tr><tr><td>TAC</td><td>Tracking Area Code</td><td>追踪区号</td></tr><tr><td>TAI</td><td>Tracking Area Identity</td><td>跟踪区域标识</td></tr><tr><td>Tbps</td><td>Terabits per second</td><td>每秒 Tbps 太比特</td></tr><tr><td>TNGF</td><td>Trusted Non-3GPP Gateway Function</td><td>可信非 3GPP 网关功能</td></tr><tr><td>TSC</td><td>Time Sensitive Communication</td><td>时间敏感通信</td></tr><tr><td>TWIF</td><td>Trusted WLAN Interworking Function</td><td>可信 WLAN 互通功能</td></tr><tr><td>TSN</td><td>Time-Sensitive Networking</td><td>时间敏感网络</td></tr><tr><td>UAS</td><td>Uncrewed Aerial System</td><td>无人空中系统</td></tr><tr><td>UAV</td><td>Uncrewed Aerial Vehicle</td><td>无人驾驶飞行器</td></tr><tr><td>UDM</td><td>Unified Data Management</td><td>统一数据管理</td></tr><tr><td>UL</td><td>Uplink</td><td>上行链路</td></tr><tr><td>UPDS</td><td>UE policy delivery service</td><td>UE 策略交付服务</td></tr><tr><td>UPF</td><td>User Plane Function</td><td>用户面功能</td></tr><tr><td>UPSC</td><td>UE Policy Section Code</td><td>UE 策略部分代码</td></tr><tr><td>UPSI</td><td>UE Policy Section Identifier</td><td>UE 策略部分标识符</td></tr><tr><td>URN</td><td>Uniform Resource Name</td><td>统一资源名称</td></tr><tr><td>URSP</td><td>UE Route Selection Policy</td><td>UE 路由选择策略</td></tr><tr><td>USS</td><td>UAS Service Supplier</td><td>UAS 服务供应商</td></tr><tr><td>UUAA</td><td>USS UAV Authorization/Authentication</td><td>USS 无人机授权/认证</td></tr><tr><td>V2X</td><td>Vehicle-to-Everything</td><td>车联网</td></tr><tr><td>V2XP</td><td>V2X policy</td><td>V2X 策略</td></tr><tr><td>W-AGF</td><td>Wireline Access Gateway Function</td><td>有线接入网关功能</td></tr><tr><td>WLAN</td><td>Wireless Local Area Network</td><td>无线局域网</td></tr><tr><td>WUS</td><td>Wake-up signal</td><td>唤醒信号</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> 5G </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3GPP 5G 常用协议规范下载整理</title>
      <link href="/posts/be65a0a1/"/>
      <url>/posts/be65a0a1/</url>
      
        <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/11/13/LM7ZfywvFQ4NDVG.png" class="lazyload" data-srcset="https://i.loli.net/2021/11/13/LM7ZfywvFQ4NDVG.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211113102023734"></p><h2 id="常用协议标准">常用协议标准</h2><div class="story post-story"><h3 id="系统架构">系统架构</h3><table><thead><tr><th>编号</th><th>协议</th><th>全称</th><th>描述</th><th>下载地址</th></tr></thead><tbody><tr><td>1</td><td>RAN Architecture</td><td>NG-RAN Architecture description</td><td>系统架构</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.473">TS 38.473</a></td></tr><tr><td>2</td><td>Overall</td><td>NR and NG-RAN Overall Description</td><td>NR and NG-RAN 总体技术要求</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.300">TS 38.300</a></td></tr><tr><td>3</td><td>5GS</td><td>NG-RAN Architecture description</td><td>系统架构</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/23_series/23.501">TS 23.501</a></td></tr><tr><td>4</td><td>5GC</td><td>Procedures for the 5G System (5GS)</td><td>系统架构</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/23_series/23.502">TS 23.502</a></td></tr></tbody></table><h3 id="无线侧（RAN-NR）">无线侧（RAN/NR）</h3><table><thead><tr><th>编号</th><th>协议</th><th>全称</th><th>描述</th><th>下载地址</th></tr></thead><tbody><tr><td>1</td><td>RRC</td><td>Radio Resource Control</td><td>无线资源控制</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.331">TS 38.331</a></td></tr><tr><td>2</td><td>SDAP</td><td>Service Data Adaptation Protocol</td><td>服务数据适配协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/37_series/37.324">TS 37.324</a></td></tr><tr><td>3</td><td>PDCP</td><td>Packet Data Convergence Protocol</td><td>分组数据汇聚协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.323">TS 38.323</a></td></tr><tr><td>4</td><td>RLC</td><td>Radio Link Control</td><td>无线链路层控制协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.322">TS 38.322</a></td></tr><tr><td>5</td><td>MAC</td><td>Media Access Control</td><td>媒体接入控制协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.321">TS 38.321</a></td></tr><tr><td>6</td><td>F1Ap</td><td>F1 Application Protocol</td><td>F1 应用程序协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.401">TS 38.401</a></td></tr><tr><td>7</td><td>XnAp</td><td>Xn Application Protocol</td><td>Xn 应用程序协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.423">TS 38.423</a></td></tr></tbody></table><h3 id="核心网（CN-5GC）">核心网（CN/5GC）</h3><table><thead><tr><th>编号</th><th>协议</th><th>全程</th><th>描述</th><th>下载地址</th></tr></thead><tbody><tr><td>1</td><td>NgAp</td><td>NG Application Protocol</td><td>NG 应用程序协议</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/38_series/38.413">TS 38.413</a></td></tr><tr><td>2</td><td>NAS</td><td>Non-Access-Stratum</td><td>非接入层</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/24_series/24.501/">TS 24.501</a></td></tr><tr><td>3</td><td>PCF</td><td>Policy Control Function</td><td>策略控制功能</td><td><a href="https://www.3gpp.org/ftp/Specs/archive/29_series/29.507/">TS 29.507</a></td></tr></tbody></table><p><img src="https://i.loli.net/2021/11/14/L9VmBZsrEA6tfJo.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/14/L9VmBZsrEA6tfJo.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="5g协议"></p><p><a href="https://www.3gpp.org/ftp/Specs/archive/">3GPP协议下载链接</a></p></div><h2 id="整体">整体</h2><div class="story post-story"><ul><li>整体描述：TS38.300</li><li>5G接入网架构：TS38.401</li></ul></div><h2 id="频点相关">频点相关</h2><div class="story post-story"><ul><li>频率、频点相关F R1：TS38.101-1</li><li>频率、频点相关F R2：TS38.101-2</li><li>EN-DC相关：TS38.101-3</li><li>频率、频点相关基站类型：TS38.104</li></ul></div><h2 id="空口协议L2L3">空口协议L2L3</h2><div class="story post-story"><ul><li>SDAP层协议：TS37.324</li><li>5G-RAN无线接口框架总体描述：TS38.300</li><li>定义了UE空闲态和非活动态下载接入层部分的过程（包括PLMN选择、小区选择、重选相关门限）：TS38.304</li><li>MAC层协议：TS38.321</li><li>RLC协议层：TS38.323</li><li>RRC层协议：TS38.331</li></ul></div><h2 id="空口协议层L1">空口协议层L1</h2><div class="story post-story"><ul><li>物理层概述：TS38.201</li><li>物理层的功能与服务：TS38.202</li><li>物理层信道定义：TS38.211（物理层信号的生成、调制，DMRS和额外DMRS，PRACH configuration index，Point A等介绍）</li><li>传输信道和控制信道的数据处理：TS38.212（包括复用，信道编码，交织，DCI，DMRS端口号等）</li><li>物理层控制过程：TS38.213（同步，上行功控，随机接入，UE上报和接收控制消息的过程，SSB等）</li><li>物理层数据过程：TS38.214（功率控制，PDSCH PUSCH数据处理过程，步长275）</li><li>物理层测量：TS38.215（UE和网络的测量控制，UE测量能力）</li></ul></div><h2 id="Xn口协议">Xn口协议</h2><div class="story post-story"><ul><li>Xn接口综述：TS38.420</li><li>Xn口物理层：TS38.421</li><li>Xn如何传信令：TS38.422</li><li>NG-RAN信令：TS38.423</li><li>Xn数据传输规范：TS38.424</li><li>Xn用户面协议栈：TS38.425</li></ul></div><h2 id="NR-UE能力相关">NR UE能力相关</h2><div class="story post-story"><ul><li>手机的最低性能要求：TS38.101-4</li><li>终端定位相关协议：TS38.305</li><li>UE在接入网的能力参数：TS38.306</li><li>UE支持的特性要求：TS38.307</li></ul></div><h2 id="NG接口协议">NG接口协议</h2><div class="story post-story"><ul><li>NG接口综述：TS38.410</li><li>NG接口相关物理层：TS38.411</li><li>NG如何传输信令消息：TS38.412</li><li>NG-RAN和AMF控制信令：TS38.413</li><li>NG接口用户面数据：TS38.414</li><li>用户面协议：TS38.415</li></ul></div><h2 id="F1接口协议">F1接口协议</h2><div class="story post-story"><ul><li>架构综述：TS38.470</li><li>物理层：TS38.471</li><li>信令如何传：TS38.472</li><li>控制面：TS38.473</li><li>数据面：TS38.474</li><li>数据面协议：TS38.475</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> 5G </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LTE(4G)–USIM基础</title>
      <link href="/posts/a71e591c/"/>
      <url>/posts/a71e591c/</url>
      
        <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/11/13/Ny89ukcrYDm61vS.jpg" class="lazyload" data-srcset="https://i.loli.net/2021/11/13/Ny89ukcrYDm61vS.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><h2 id="USIM是在身份验证中的作用">USIM是在身份验证中的作用</h2><div class="story post-story"><p>当您启动手机时，其中的基带模块会与卡上的 USIM 应用程序进行通信。</p><p>当需要向网络进行身份验证并验证网络本身时，基带模块将提供的质询信息从网络发送到 USIM，USIM 执行加密以生成对网络发出的身份验证质询的响应，然后 USIM问题是它自己对网络的挑战。</p></div><h2 id="What’s-Inside">What’s Inside?</h2><div class="story post-story"><h3 id="所有GSM用于传统SIM应用程序的GSM内容">所有GSM用于传统SIM应用程序的GSM内容</h3><p>一般来说USIM也有能力在GSM网络中作为SIMs运行，毕竟它只是一个不同的软件堆栈。我们在这里不涉及GSM SIM。</p><h3 id="ICCID">ICCID</h3><p>由于USIM只是在通用集成电路卡上运行的应用程序，因此它得到了ICCID或通用集成电路卡ID。通常这是卡本身上印有的长条形码/数量。</p><p>网络一般不关心这个值，但运营商可能会把它用于物流，如发货卡。</p><h3 id="PIN-PUK">PIN &amp; PUK</h3><p>pin和PUKs是解锁卡的密码。如果你的PIN错了太多次，你需要更长的PUK来解锁它。</p><p>这些字段可以写入(在验证到卡片时)，但不能直接读取，只有尝试。(你可以尝试一个密码，但你不能看到它的设置)。</p><p>正如我们之前提到的，终端会询问卡是否正确，但终端也不知道密码。</p><h3 id="IMSI">IMSI</h3><p>每个订阅者都有一个IMSI，是一个国际移动用户标识。</p><p>IMSIS是分层的，从3位数移动国家/地区代码MCC开始，然后移动网络代码(MNC)(2/3位)以及最终是移动订阅识别号(MSIN)，由操作员分配给用户的唯一号码网络。</p><p>这意味着虽然两个订阅者理论上可以具有相同的MSIN，但它们不会分享相同的MNC和MCC，因此ISMI仍然是唯一的。</p><p>除非订户更改运营商时，IMSI永远不会发生变化，除非新的操作员发出新的USIM卡，具有不同的IMSI（不同的MNC）。</p><p>MSIN与电话号码/MSISDN号码不同，但IMSI通常具有网络相关联的MSISDN。这允许您在不更改USIM / SIM的情况下移植/更改MSISDN号码。</p><h3 id="K-–-Subscriber-Key">K – Subscriber Key</h3><p>仅针对订户和认证中心(AUC/HSS)已知的订户的秘密密钥。</p><p>所有身份验证都依赖于仅为USIM和AUC/HHS已知的单个密钥(k)的原则。</p><h3 id="OP-–-Operator-Code">OP – Operator Code</h3><p>操作员代码 - 来自单个操作员的所有SIM卡相同。</p><p>与K结合使用作为一些身份验证/授权加密生成的输入。</p><p>由于操作员代码对网络中的所有订阅者都是通用的，因为要恢复此密钥可能会导致安全问题，因此通常使用OPC。</p><h3 id="OPc-–-Operator-Code-Derived">OPc – Operator Code (Derived)</h3><p>当USIM用K键写入USIM时，可以预先计算Operator代码，而不是给出每个USIM的操作员代码。</p><p>这意味着OP不存储在USIM上。</p><p><code>OPc=Encypt-Algo(OP,Key)</code></p><h3 id="PLMN-Public-Land-Mobile-Network">PLMN (Public Land Mobile Network)</h3><p>PLMN是MCC和MNC的组合，用于识别运营商的无线接入网(RAN)。</p><p>虽然在大多数USIMs中没有特定的PLMN字段，但值得理解的是，有几个字段需要PLMN。</p><h3 id="HPLMNwAcT-HPLMN-selector-with-Access-Technology">HPLMNwAcT (HPLMN selector with Access Technology)</h3><p>按优先级顺序包含指定接入技术的Home-PLMN编码</p><p>这允许USIM计算出哪个PLMN附加到哪个访问技术(RAN)，例如，如果操作员的PLMN是50599，我们可以</p><ul><li>50599 E-UTRAN</li><li>50599 UTRAN</li><li></li></ul><p>尝试4G，如果失败了就使用3G。</p><p>在运营商可能合作共享不同地区的网络的情况下，可以先设置运营商的PLMN，然后再设置合作运营商的PLMN。</p><h3 id="OPLMNwACT-Operator-controlled-PLMN-selector-with-Access-Technology">OPLMNwACT (Operator controlled PLMN selector with Access Technology)</h3><p>这是运营商与优先顺序和访问技术有关漫游协议的PLMNS列表。</p><p>操作员可以漫游到运营商X，但仅允许UTRAN访问，而不是E-TRAN。</p><h3 id="FEHPLMN-Equivalent-HPLMN">FEHPLMN (Equivalent HPLMN)</h3><p>用于定义等效的HPMN，例如，如果两个载波合并并仍有两个PLMN。</p><h3 id="FPLMN-Forbidden-PLMN-list">FPLMN (Forbidden PLMN list)</h3><p>用户不能浏览的plmn列表。</p><h3 id="HPPLMN-Higher-Priority-PLMN-search-period">HPPLMN (Higher Priority PLMN search period)</h3><p>在HPLMNWACT列表中的每个PLMN / Access技术之间花费多长时间。</p><h3 id="ACC-Access-Control-Class">ACC (Access Control Class)</h3><p>ACC允许0-15的值，并确定订户的访问控制类。</p><p>在英国，ACC值用于限制紧急情况期间对手机网络的平民访问。</p><p>普通用户在0 - 9.较高的优先级用户分配12-14中的普通订阅者。</p><p>在紧急情况下，禁用范围0 - 9中的某些或所有访问类。</p><p>这意味着可以将服务截止到具有0-9的ACC值的公众，但第一个响应者和紧急服务等人将具有更高的ACC值，网络将允许它们附加。</p><h3 id="AD-Administrative-Data">AD (Administrative Data)</h3><p>与ACC字段一样，AD字段允许运营商在没有与网络附加的有效支付订阅者的情况下驱动测试网络</p><p>The defined levels are:</p><ul><li>'00’正常运行。</li><li>'80’型批准操作。</li><li>'01’正常运行+特定设施。</li><li>'81’型批准操作+特定设施。</li><li>'02’维护（离线）。</li><li>'04’单元测试操作。</li></ul><h3 id="GID-1-2-–-Group-Identifier">GID 1 / 2 – Group Identifier</h3><p>两个组标识符字段，允许操作符为特定应用程序标识一组USIMs。</p><h3 id="SPN-Service-Provider-Name">SPN (Service Provider Name)</h3><p>SPN是包含网络的人类可读名称的可选字段。</p><p>SPN允许MVNOS以手机上的操作员提供自己的USIM。</p><h3 id="ECC-Emergency-Call-Codes">ECC (Emergency Call Codes)</h3><p>多达6位数的代码长时间允许从主屏幕/紧急/不经过身份验证等拨号。</p><h3 id="MSISDN">MSISDN</h3><p>移动台国际订户目录号码。E.164格式的用户的电话号码。</p><p>这是可选的，因为移植可能会覆盖此操作，因此它并不总是匹配。</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> USIM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.Pcap包学习</title>
      <link href="/posts/a30ed9b8/"/>
      <url>/posts/a30ed9b8/</url>
      
        <content type="html"><![CDATA[<h2 id="pacp-cap-文件结构">.pacp/.cap 文件结构</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211106090545.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211106090545.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p><strong>1.Pcap Header</strong></p><blockquote><p>文件头，每一个pcap文件只有一个文件头，总共占24（B ）字节，以下是总共7个字段的含义。</p></blockquote><details green><summary> detail </summary>              <div class='content'>              <ul><li><p>Magic(4B)： 标记文件开始，并用来识别文件和字节顺序。值可以为<code>0xa1b2c3d4</code>或者<code>0xd4c3b2a1</code>，如果是<code>0xa1b2c3d4</code>表示是大端模式，按照原来的顺序一个字节一个字节的读，如果是<code>0xd4c3b2a1</code>表示小端模式，下<strong>面的字节都要交换顺序(从后往前)</strong>。现在的电脑大部分是小端模式。</p></li><li><p>Major(2B)： 当前文件的主要版本号，一般为0x0200</p></li><li><p>Minor(2B)： 当前文件的次要版本号，一般为0x0400</p></li><li><p>ThisZone(4B)： 当地的标准事件，如果用的是GMT则全零，一般全零</p></li><li><p>SigFigs(4B)： 时间戳的精度，一般为全零</p></li><li><p>SnapLen(4B)： 最大的存储长度，设置所抓获的数据包的最大长度，如果所有数据包都要抓获，将值设置为65535</p></li><li><p>LinkType(4B)： 链路类型。解析数据包首先要判断它的<code>LinkType</code>，所以这个值很重要。一般的值为1，即以太网<br>常用的LinkType（链路类型）：</p><ul><li><table><thead><tr><th>值</th><th>类型描述</th></tr></thead><tbody><tr><td>0</td><td>BSD loopback devices, except for later OpenBSD</td></tr><tr><td>1</td><td>Ethernet, and Linux loopback devices</td></tr><tr><td>6</td><td>802.5 Token Ring</td></tr><tr><td>7</td><td>ARCnet</td></tr><tr><td>8</td><td>SLIP</td></tr><tr><td>9</td><td>PPP</td></tr><tr><td>10</td><td>FDDI</td></tr><tr><td>100</td><td>LLC/SNAP-encapsulated ATM</td></tr><tr><td>101</td><td>“raw IP”, with no link</td></tr><tr><td>102</td><td>BSD/OS SLIP</td></tr><tr><td>103</td><td>BSD/OS PPP</td></tr><tr><td>104</td><td>Cisco HDLC</td></tr><tr><td>105</td><td>802.11</td></tr><tr><td>108</td><td>later OpenBSD loopback devices (with the AF_value in network byte order)</td></tr><tr><td>113</td><td>special Linux “cooked” capture</td></tr><tr><td>114</td><td>LocalTalk</td></tr></tbody></table></li></ul></li></ul>              </div>            </details><p>​<strong>2.Packet Header</strong></p><p>数据包头可以有多个，每个数据包头后面都跟着真正的数据包。以下是Packet Header的4个字段含义</p><ul><li>Timestamp(4B)： 时间戳高位，精确到seconds，这是Unix时间戳。捕获数据包的时间一般是根据这个值</li><li>Timestamp(4B)： 时间戳低位，能够精确到microseconds</li><li>Caplen(4B)： 当前数据区的长度，即抓取到的数据帧长度，由此可以得到下一个数据帧的位置。</li><li>Len(4B)： 离线数据长度，网路中实际数据帧的长度，一般不大于Caplen，多数情况下和Caplen值一样</li></ul><p><strong>3.Packet Data</strong></p><p>Packet是链路层的数据帧，长度就是Packet Header中定义的Caplen值，<u>所以每个Packet Header后面都跟着Caplen长度的Packet Data</u>。也就是说pcap文件并没有规定捕获的数据帧之间有什么间隔字符串。<u>Packet数据帧部分的格式就是标准的网络协议格式了</u>。</p><p>eg：<br>下图为16进制pcap文件：</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211106093845.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211106093845.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><blockquote><p><strong>备注：</strong></p><p>红色部分：Pcap Header</p><p>蓝色部分：Packet Header</p><p>PcapHeader</p><p>Magic(4B)： D4 C3 B2 A1 表示小端模式，后面的字节从后往前读；</p><p>Major(2B)： 02 00，计算机读的是00 02；</p><p>Minor(2B)： 04 00，计算机读的是00 04；</p><p>ThisZone(4B)： 00 00 00 00，全零；</p><p>SigFigs(4B)： 00 00 00 00，全零；</p><p>SnapLen(4B)： FF FF 00 00, 计算机读的是：00 00 FF FF，所以是2^16-1=65535</p><p>LinkType(4B)： 01 00 00 00, 计算机读的是：00 00 00 01，表示是以太网类型</p><p>Packet Header</p><p>Timestamp(4B)： CA 4D A4 5C，计算机读的是：5C A4 4D CA，十进制：1554271690，日期为：2019-04-03 14:08:10；</p><p>Timestamp(4B)： 4F 2A 08 00，计算机读的是：00 08 2A 4F，十进制：535119，代表535119ms；</p><p>Caplen(4B)： BA 1C 00 00, 计算机读的是：00 00 1C BA，十进制：7354，代表后面的7354个字节为一个数据帧，之后又是一个新的PacketHeader，如此循环；</p><p>Len(4B)： BA 1C 00 00，和Caplen相同</p></blockquote></div>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
          <category> Wireshark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pcap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Deep Packet Inspection,DPI</title>
      <link href="/posts/ac712918/"/>
      <url>/posts/ac712918/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是DPI">什么是DPI?</h2><div class="story post-story"><p>Deep packet inspection,DPI 也被叫做<code>信息提取</code>,<code>IX</code>或<code>完整的数据包检查</code>. 是一种网络数据包过滤. 深度数据包检查是对通过检查点传输的报文的数据部分和报文头进行评估，排除任何不符合协议、垃圾邮件、病毒、入侵和任何其他阻止报文通过检查点的定义标准。</p><p>深度数据包检查也用于确定特定数据包是否被重定向到另一个目的地。简而言之，深度数据包检查能够定位、检测、分类、阻塞或重路由具有特定代码或数据负载的包，这些包是传统包过滤无法检测、定位、分类、阻塞或重定向的。与普通数据包过滤不同，深度数据包检查不仅仅是检查包头</p></div><h2 id="DPI-怎样工作">DPI 怎样工作?</h2><div class="story post-story"><p>深度数据包检查是包过滤的一种形式，通常作为防火墙的功能执行。它被应用于开放系统互连的应用层。</p><p>深度数据包检查是对通过检查点的包的内容进行评估。使用由你、Internet服务提供商或网络或系统管理员分配的规则，深度包检查确定如何实时处理这些包</p><p>深度数据包检查能够检查这些包的内容，然后找出它来自哪里，比如发送它的服务或应用程序。此外，它还可以与过滤器一起工作，以便从在线服务(如Twitter或Facebook)或特定IP地址查找和重定向网络流量</p></div><h2 id="DPI-VS-传统包过滤">DPI VS 传统包过滤</h2><div class="story post-story"><p>传统的包过滤只读取每个包的头信息。这是一种基本方法，主要由于当时的技术限制而没有现代数据包过滤方法复杂。防火墙的处理能力非常低，不足以处理大量数据包。换句话说，传统的数据包过滤类似于阅读一本书的书名，而不知道或评估封面内的内容。</p><p>随着新技术的出现，深度数据包检测变得可行。随着它变得更加彻底和完整，它变得更像是拿起一本书，打开它，从头到尾阅读。</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DPI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Wireshark抓包LTE RRC</title>
      <link href="/posts/172b8d62/"/>
      <url>/posts/172b8d62/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><h2 id="使用Wireshark抓包LTE-RRC-包">使用Wireshark抓包LTE RRC 包</h2><div class="story post-story"><h3 id="实验环境说明">实验环境说明</h3><blockquote><p>一台<code>ubuntu20.04</code>虚拟机</p><p><code>Wireshark</code></p><p>基于<code>srsRAN</code> 模拟LTE环境</p><p>使用<code>ZeroMQ RF</code> 实现无RF硬件构建<code>srsUE</code>与<code>srsENB</code> 通信</p><p><img src="F:/sizaif/Dropbox/Master/Blog/blog/source/_posts/img_article/2021-10-07-%E4%BD%BF%E7%94%A8Wireshark%E6%8A%93%E5%8C%85LTE-RRC/20211007100349.png" class="lazyload" data-srcset="F:/sizaif/Dropbox/Master/Blog/blog/source/_posts/img_article/2021-10-07-%E4%BD%BF%E7%94%A8Wireshark%E6%8A%93%E5%8C%85LTE-RRC/20211007100349.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="srsran_architecture.png"></p><p>With srsRAN this can be achieved <strong>by replacing the radio link between eNodeB and UE with a mechanism</strong> that allows to exchange baseband IQ samples over an alternative transport. For this purpose, we’ve implemented a ZeroMQ-based RF driver that essentially acts as a transmit and receive pipe for exchanging IQ samples over TCP or IPC.</p></blockquote></div><h2 id="Wireshark配置">Wireshark配置</h2><div class="story post-story"><blockquote><p>在<code>srsran</code> doc 文档中由提到wireshark 抓取用法 <a href="https://docs.srsran.com/en/latest/general/source/5_troubleshooting.html#examining-pcaps-with-wireshark">Examining PCAPs with Wireshark</a></p></blockquote><p><strong>打开<code>DLT_User</code>选项</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007162848.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007162848.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211007162846683"></p><p><strong>添加配置</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007163000.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007163000.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211007162959662"></p><p>保存后即可开始抓取, 按照原文的意思设置此项后就可以抓取到LTE消息.</p><blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007163152.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007163152.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p></blockquote><p>但在使用<code>ZeroMQ</code> 实现免RF中并没有出现上述的情况,</p><p>因为<code>ZeroMQ</code>的流量都是通过<code>localhost:2000</code> 和 <code>localhost:2001</code> 端口 实现流量交换</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007163649.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007163649.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211007163648723"></p><p>既然如此,尝试添加解析选项 <code>分析-&gt; 解码为</code>, 添加对应端口, 以及要解析成的协议,保存即可</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007163740.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007163740.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211007163739935"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007163924.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007163924.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211007163923058"></p></div><h2 id="srsRAN配置">srsRAN配置</h2><div class="story post-story"><p>在<code>~/.config/srsran/</code> 目录下, 修改<code>epc.conf</code>, <code>enb.conf</code>,<code>ue.conf</code> 文件</p><p>在对应的<code>pcap</code> 选项下, 设置<code> enable = true</code></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211007164214.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211007164214.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211007164212972"></p><p>当运行完成后,即可以用<code>wireshark</code> 打开 <code>/tmp/</code>目录下对应的pcap文件, 设置对应解析查看</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> Wireshark </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>提取3GPP TS中RRC ASN.1模式及编译</title>
      <link href="/posts/b0e1c2b9/"/>
      <url>/posts/b0e1c2b9/</url>
      
        <content type="html"><![CDATA[<h2 id="整体流程图">整体流程图</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211006095550.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211006095550.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211006095545911"></p></div><h2 id="ASN-1-标准简介">ASN.1 标准简介</h2><div class="story post-story"><p>在电信和计算机网络领域，<strong>ASN.1</strong>（<strong>Abstract Syntax Notation One</strong>) 是一套标准，是描述数据、编码、传输、解码的灵活的抽象语义记法。它提供了一套正式、无歧义和精确的规则以描述独立于特定计算机硬件的对象结构。</p></div><h2 id="3GPP协议">3GPP协议</h2><div class="story post-story"><blockquote><p><strong>5G NR 的无线资源控制(RRC)协议是 <code>38.331</code></strong></p><div class="tag link"><a class="link-card" title="38.331" href="https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=3197"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">38.331</p><p class="url">https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=3197</p></div></a></div><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005113543.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005113543.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005113541974"></p><p><strong>LTE 的无线资源控制(RRC)协议是 <code>36.331</code></strong></p><div class="tag link"><a class="link-card" title="36.331" href="https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=2440"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">36.331</p><p class="url">https://portal.3gpp.org/desktopmodules/Specifications/SpecificationDetails.aspx?specificationId=2440</p></div></a></div><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005113604.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005113604.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005113603915"></p></blockquote><p><strong>提取RRC,ASN1样式</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005113919.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005113919.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005113918113"></p></div><h2 id="转换工具下载">转换工具下载</h2><div class="story post-story"><p>将下载后的3GPP协议<code>Word</code> 文档<strong>去掉页眉页脚</strong>后转换成<code>纯文本txt</code>, 编码选择<code>UTF-8</code></p><h3 id="使用txt2asn1-转换">使用<code>txt2asn1</code> 转换</h3><div class="tag link"><a class="link-card" title="txt2asn1" href="https://github.com/Dybinx/txt2asn1"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">txt2asn1</p><p class="url">https://github.com/Dybinx/txt2asn1</p></div></a></div><div class="note info"><p>请下载ZIP格式并解压,避免出现exe权限无法运行问题</p></div><p><strong>在同目录下终端运行 得到xxx.asn1文件</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">./txt2asn1.exe XXX.txt</code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005115105.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005115105.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005115104278"></p><h3 id="使用extract-asn1-from-spec-pl">使用<a href="https://gitlab.eurecom.fr/oai/openairinterface5g/-/blob/master/openair2/RRC/LTE/MESSAGES/asn1c/ASN1_files/extract_asn1_from_spec.pl"><strong>extract_asn1_from_spec.pl</strong></a></h3><div class="tag link"><a class="link-card" title="extract_asn1_from_spec" href="https://gitlab.eurecom.fr/oai/openairinterface5g/-/blob/master/openair2/RRC/LTE/MESSAGES/asn1c/ASN1_files/extract_asn1_from_spec.pl"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">extract_asn1_from_spec</p><p class="url">https://gitlab.eurecom.fr/oai/openairinterface5g/-/blob/master/openair2/RRC/LTE/MESSAGES/asn1c/ASN1_files/extract_asn1_from_spec.pl</p></div></a></div><p><strong>下载文件后, 源文件同目录终端运行</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">perl extract_asn1_from_spec xxxx.txt</code></pre><p>得到 <code>EUTRA-RRC-Definitions.asn</code>, <code>EUTRA-UE-Variables.asn</code> ,<code>EUTRA-InterNodeDefinitions</code> 三个文件</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005115416.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005115416.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005115415629"></p></div><h2 id="ASN1C编译ASN-1文件">ASN1C编译ASN.1文件</h2><div class="story post-story"><p>ASN1C 是将 ASN.1 规范转换为 C 源代码的免费开源编译器。 它支持一系列 ASN.1 语法，包括 ISO/IEC/ITU ASN.1 1988、'94、'97、2002 和以后的修正。 支持的编码规则集是</p><ul><li>BER: ITU-T Rec. X.690 | ISO/IEC 8825-1 (2002) (BER/DER/CER)</li><li>PER: X.691|8825-2 (2002) (PER).</li><li>XER: X.693|8825-3 (2001) (BASIC-XER/CXER).</li></ul><div class="tag link"><a class="link-card" title="asn1c官网" href="http://www.lionet.info/asn1c/"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">asn1c官网</p><p class="url">http://www.lionet.info/asn1c/</p></div></a></div><div class="tag link"><a class="link-card" title="asn1c源码" href="https://github.com/vlm/asn1c"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">asn1c源码</p><p class="url">https://github.com/vlm/asn1c</p></div></a></div><p>ubuntu 可直接通过 <code>sudo apt-get install asn1c</code> 进行安装</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> asn1c</code></pre><blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005115808.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005115808.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005115807407"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211005115923.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211005115923.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211005115922220"></p></blockquote><p>使用<code>asn1c</code> 编译</p><pre class="language-bash" data-language="bash"><code class="language-bash">asn1c -S /usr/share/asn1c -fcompound-names -gen-PER -pdu<span class="token operator">=</span>auto <span class="token number">36331</span>-f40.asn1<span class="token comment"># -pdu=auto  产生pdu_colletion.c文件</span><span class="token comment"># -fcompound-names 去除重定义</span><span class="token comment"># -gen-PER 使用PER编码</span><span class="token comment"># -S /usr/share/asn1c 指定asn1c库文件位置, 通过使用whereis asn1c命令查看其库位置</span></code></pre><details green><summary> FAQ </summary>              <div class='content'>              <p><strong>Q.:</strong> Does asn1c support BER encoding? I see only DER encoding in documentation.<br><strong>A.:</strong> Yes, the asn1c compiler fully supports BER encoding. Any <a href="http://en.wikipedia.org/wiki/Distinguished_Encoding_Rules">DER</a> encoded data is, by definition, a valid BER data, from the receiver’s point of view.</p><p>If you want data to be BER or DER encoded, just invoke der_encode().</p><p><strong>Q.:</strong> My linker complains: Undefined symbols: <code>_asn_DEF_PDU</code>.<br><strong>A.:</strong> <strong>If you have your own file with main() routine, just delete the <code>converter-sample.c</code>file, you won’t need it. If you haven’t created the main() routine yourself and wish to rely on converter-sample.c for your transcoding needs, <code>add -DPDU=YourPdu</code> to the list of compiler flags.</strong></p><p><strong>Q.:</strong> How to compile the 3GPP Radio Resource Control specification?<br><strong>A.:</strong> The asn1c distribution includes an RRC 25.331 (version 7.1.0) example, check out <a href="https://github.com/vlm/asn1c/tree/master/examples/sample.source.RRC">https://github.com/vlm/asn1c/tree/master/examples/sample.source.RRC</a>. You can also use the pre-compiled <strong>rrc-dump.exe</strong> program, which is part of <a href="http://lionet.info/asn1c/download.html">Windows ASN.1 compiler installer</a>.</p><p><strong>Q.:</strong> How to compile the ISO 13522 (MHEG-5) specification?<br><strong>A.:</strong> The ASN.1 compiler comes with a MHEG-5 decoder. Follow the <a href="https://github.com/vlm/asn1c/tree/master/examples/sample.source.MHEG5">https://github.com/vlm/asn1c/tree/master/examples/sample.source.MHEG5</a> README file instructions. You can also use the pre-compiled <strong>mheg5dump.exe</strong> program, which is part of <a href="http://lionet.info/asn1c/download.html">Windows ASN.1 compiler installer</a>.</p><p><strong>Q.:</strong> How to compile the <em>XYZ</em> decoder?<br><strong>A.:</strong> If <em>XYZ</em> is one of MEGACO (Media Gateway Control), PKIX1/X.509, LDAP, GSM TAP3 or OAM ULP, just go to <em>examples/sample.source.XYZ</em> and run <code>make</code>. The <a href="http://lionet.info/asn1c/download.html">Windows ASN.1 compiler installer</a> already contains the pre-compiled decoders for these encoding formats.</p><p>If you have something else, you should either use the <a href="http://lionet.info/asn1c/asn1c.cgi">Online ASN.1 compiler</a>, or download the <a href="http://lionet.info/asn1c/download.html">ASN.1 compiler source code</a>.</p>              </div>            </details><p>如果不使用自己的<code>main()</code>函数, 直接使用<code>converter-sample.c</code>的化, 需要在其中添加一个目标<code>PDU</code></p><pre class="language-c++" data-language="c++"><code class="language-c++">#include &lt;asn_application.h&gt;#include &lt;asn_internal.h&gt;&#x2F;* for ASN__DEFAULT_STACK_MAX *&#x2F;#define PDU BCCH_BCH_Message&#x2F;* Convert &quot;Type&quot; defined by -DPDU into &quot;asn_DEF_Type&quot; *&#x2F;#defineASN_DEF_PDU(t)asn_DEF_ ## t#defineDEF_PDU_Type(t)ASN_DEF_PDU(t)#definePDU_TypeDEF_PDU_Type(PDU)</code></pre><p>或者在<code>Makefile.am.sample</code> 文件中, 修改 <code>CFLAGS</code> 添加 <code>-DPDU= </code> 选项</p><pre class="language-bash" data-language="bash"><code class="language-bash">CFLAGS <span class="token operator">+=</span> -DHAVE_CONFIG_H -DJUNKTEST -D_DEFAULT_SOURCE  -DPDU<span class="token operator">=</span>BCCH_BCH_Message -DASN_PDU_COLLECTION -I.<span class="token assign-left variable">OBJS</span><span class="token operator">=</span><span class="token variable">$&#123;ASN_MODULE_SRCS<span class="token operator">:</span>.c=.o&#125;</span> <span class="token variable">$&#123;ASN_CONVERTER_SOURCES<span class="token operator">:</span>.c=.o&#125;</span>all: <span class="token variable"><span class="token variable">$(</span>TARGET<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>TARGET<span class="token variable">)</span></span><span class="token builtin class-name">:</span> <span class="token variable">$&#123;OBJS&#125;</span><span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>CFLAGS<span class="token variable">)</span></span> -o <span class="token variable"><span class="token variable">$(</span>TARGET<span class="token variable">)</span></span> <span class="token variable">$&#123;OBJS&#125;</span> <span class="token variable"><span class="token variable">$(</span>LDFLAGS<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LIBS<span class="token variable">)</span></span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> ASN.1 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LTE 基础知识</title>
      <link href="/posts/cdac3e0/"/>
      <url>/posts/cdac3e0/</url>
      
        <content type="html"><![CDATA[<h2 id="LTE相关基础知识">LTE相关基础知识</h2><div class="story post-story"><h3 id="LTE架构">LTE架构</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210720160620.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210720160620.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210720160540823"></p><ul><li>第一层物理层(PHY),在时间和频率域使用无线电资源进行通信。</li><li>第二层由介质访问控制(MAC)、无线链路控制(RLC)、分组数据收敛协议(PDCP)三层组成。它们支持上行和下行调度、分组分割、加密和完整性保护等功能。</li><li>RRC是一个第三层协议，负责创建和维护无线电连接、广播系统信息、发送分页通知、配置和报告无线电测量以及隧道化NAS消息。</li><li>NAS是终端与CN之间的控制平面协议;它负责设置安全性，处理移动性和会话管理。</li></ul><hr><ul><li><p><strong>UE代表手机;</strong></p></li><li><p><strong>RAN为终端提供无线通信服务;</strong></p></li><li><p><strong>CN(EPC)(包括其他功能)在终端和Internet之间路由数据。</strong></p></li></ul><p>RAN由无线基站组成，在5G中称为<code>gNB</code>，在4G中称为<code>eNB</code>。gNB所使用的无线电接入技术被称为新无线电<code>(NR)</code>， eNB所使用的无线电接入技术被称为进化通用地面无线电接入(<code>E-UTRA</code>)。</p><p>CN由几个网络功能组成，其中5G的接入和移动性管理功能(AMF)和4G的移动性管理实体(MME)如图所示。<strong>UE到RAN/CN的方向称为上行，另一个方向称为下行。</strong></p><p>4G和5G的流量有两种类型:</p><ul><li>一种称为控制平面的类型负责建立和维护连接，并建立安全性;</li><li>用户平面: 承载实际数据，如语音通话和互联网数据。每种类型都由几个协议组成。</li></ul><p>控制平面上使用的协议栈的空中接口,包括无线电资源控制协议(RRC)和不可访问层协议(NAS)，</p><h4 id="RRC-Radio-Resource-Control">RRC(Radio Resource Control)</h4><blockquote><p>无线资源控制</p><p>RRC是一个第三层协议，负责创建和维护无线电连接、广播系统信息、发送分页通知、配置和报告无线电测量以及隧道化NAS消息。</p></blockquote><p>在<code>NG-RAN</code>中，<code>RRC</code>在<code>UE</code>和<code>gNB</code>之间的控制平面消息中进行操作。它携带了与<code>RAN控制平面</code>程序相关的信息</p><p>RRC层还为终端和核心网接入移动性管理功能(Access and Mobility Management Function,  AMF)之间发送的NAS消息提供服务。</p><p>RRC中的消息依赖于PDCP,在必要时提供一个具有加密和完整性保护的通道。</p><p>RRC负责广播系统信息或获取系统信息以便在小区内进行通信，用于在<code>RRC_IDLE</code>状态下发送<code>寻呼消息</code>、<code>连接管理</code>、<code>移动性管理</code>等。</p><h5 id="RRC三种状态转换">RRC三种状态转换</h5><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211004112537.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211004112537.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211004112535677">5G  NR中 引入了额外的状态<code>RRC_INACTIVE</code></p><ul><li><strong>RRC_IDLE:</strong>  网络不包含终端RRC连接信息的状态。因此，设备不能发送或接收数据。设备定期醒来，接收来自网络的寻呼消息，将状态更改为<code>RRC_CONNECTED</code>。小区和网络之间的移动性可以通过小区重新选择过程实现</li><li><strong>RRC_INACTIVE:</strong> 无法发送或接收数据。 在<code>UE</code>和<code>gNB</code>中都维护<code>RRC上下文</code>。<code>UE</code>可以类似于<code>RRC_IDLE</code>模式休眠，以节省电池电量。减少到<code>RRC_CONNECTED</code>模式的转换时间,用于数据传输，因为已经在核心网络建立了上下文。 通过小区重选程序的移动性</li><li><strong>RRC_CONNECTED:</strong>  在<code>UE</code>和<code>gNB</code>之间建立<code>RRC上下文</code>，用于在网络上传输数据。通过小区无线网络临时标识符(C-RNTI)用于信令的网络识别设备。由RAN管理的移动性，在需要时进行切换</li></ul><p>新的状态<code>RRC_INACTIVE</code>有助于减少发送用户数据之前的状态转换所涉及的信令量。</p><p><code>RRC_INACTIVE</code>充当了一个中介状态，用于在RRC上下文已经建立时直接转换。在<code>RRC_INACTIVE</code>状态下，设备会像<code>RRC_IDLE</code>一样休眠。</p><p>RRC层负责控制平面过程中的大量消息，对于任何RRC层的实现来说，健壮地抵御恶意攻击并向上层提供可靠的服务都是非常重要的。</p><h5 id="RRC组成">RRC组成</h5><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210731093826.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210731093826.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210731093825549"></p><p>RC消息是使用平台无关的ASN.1定义的，可以看作图2中的树。每个RRC消息由结构化的(<code>SEQUENCE</code>, <code>SEQUENCE OF</code>, <code>CHOICE</code>) 和原语(<code>BOOLEAN</code>,<code>INTEGER</code>, <code>ENUMERATED</code>,<code>BIT STRING</code>,<code>OCTET STRING</code>) 数据类型, 每个结构化数据类型可以进一步由结构化数据类型和基本数据类型组成. 在传输过程中，RRC消息使用<code>Unaligned Packed Encoding Rules (UPER)[36]</code>进行编码，该规则将数据结构转换为紧凑的字节序列。</p><blockquote><p>[36] ITU. Recommendation ITU-T X.691 International Standard 8825-2: Information technology – ASN.1 encoding rules: Specification of Packed Encoding Rules (PER), Aug 2015. Available at <a href="https://www.itu.int/rec/T-REC-X.680-X.693-201508-I/en">https://www.itu.int/rec/T-REC-X.680-X.693-201508-I/en</a>.</p></blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210731103926.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210731103926.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210731103925068"></p><h5 id="RRC-消息">RRC 消息</h5><p>RRC层利用底层的服务实现RRC消息的可靠、安全的传递。上行通道为<code>ULCCCH</code>、<code>UL-DCCH</code>，下行通道为<code>DL-CCCH</code>、<code>DL-DCCH</code>、<code>BCCH</code>、<code>PCCH</code>。</p><p><code>CCCH</code>、<code>PCCH</code>和<code>BCCH</code>通道中的消息通过<code>RLC</code>中的透明模式™以明文形式发送，用于初始AS激活和随机访问过程。<strong>因此这些消息不使用PDCP层的服务进行加密和完整性保护</strong>。RLC仍然提供检测到错误的重传和RRC有效负载的无重复交付。在上行链路中，RRC报文只通过<code>UL-CCCH</code>和<code>UL-DCCH</code>发送。</p><h3 id="5G-NR">5G NR</h3><blockquote><p>5G New Radio</p><p>Fuzzing Radio Resource Control messages in 5G and LTE systems</p></blockquote><p>5G系统提出新的无线电标准, 5G New Radio; 新标准应该支持为将来使用而确定的需求，如更高的数据速度、更低的延迟、移动性和可靠性。<code>5G NR</code>是在<code>RAN</code>和<code>UE</code>之间使用经过许可的电磁频谱传输数据的接入机制。5G系统中的<code>NG-RAN</code>可以由多个下一代节点基站(<code>gN</code>B)或单个<code>gNB</code>组成。<code>NG-RAN</code>将为<code>LTE</code>、<code>3G</code>等传统无线接入技术提供支持。<code>RAN</code>为终端提供了与核心网络和数据网络交互的接口。<code>5G NR</code>由处理控制平面的网络协议栈和处理用户平面消息的网络协议栈组成，分别如下所示</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211004142917.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211004142917.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211004142916341"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211004142931.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211004142931.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211004142929890"></p><p><code>UE</code>和<code>NG-RAN</code>之间的接口叫做Uu，它同时承载着控制平面和用户平面的流量。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20211004143026.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20211004143026.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20211004143025311"></p></div><h2 id="缩写名词解释">缩写名词解释</h2><div class="story post-story"></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> LTE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LTE </tag>
            
            <tag> 标签二 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker文件夹映射权限问题思考及可能解决方法</title>
      <link href="/posts/39ff9093/"/>
      <url>/posts/39ff9093/</url>
      
        <content type="html"><![CDATA[<h1>docker文件夹映射权限问题思考及可能解决方法</h1><h2 id="背景分析">背景分析</h2><div class="story post-story"><p>在多用户服务器上公用docker搭建环境时,初步设想为宿主机用户为普通用户,容器内用户为root,</p><p>用户在容器内自由搭建自己所需的环境,而不影响其他人以及容器外的环境.</p><p>但当用户在使用docker挂载磁盘的时候,由于容器内使用root运行程序，会导致挂载中产生的文件属于root:root。而容器外用户并不是root，会使的文件共享甚至阅读日志产生权限上的问题,导致不可读或不可写之类的问题。</p><p>本文旨在宿主机使用普通用户,而容器内仍然使用<code>root</code>用户,且不会产生文件权限的问题.</p><p>案例截图:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923104602.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923104602.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923104601353"></p><p>可以看到创建映射的 <code>srs</code>和<code>srsRAN</code> 文件夹 因为是由<code>docker run </code>命令自动创建的,权限被化为<code>root</code></p><p>普通用户在这个文件夹下没有权限!,</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923104828.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923104828.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923104827265"></p><h3 id="需求">需求</h3><div class='checkbox green checked'><input type="radio" checked="checked"/>            <p>容器外使用普通用户(没有sudo权限等管理员权限)</p>            </div><div class='checkbox green checked'><input type="radio" checked="checked"/>            <p>容器内使用带管理员权限的root用户</p>            </div><h3 id="文件挂载原理">文件挂载原理</h3><p>简而言之，<strong>docker的文件挂载中，容器内外uid与gid相同</strong>。</p><p>最简单的挂载磁盘，例如：<code>docker run -v $PWD:/data bash</code>，就是将当前目录挂载到容器内的<code>/data</code>目录。文件的权限可以通过<code>ls -l</code>查看。</p><p>容器内可能有使用root用户和非root用户运行程序的两种情况。</p><ul><li>若容器内使用root运行程序，可以想象，产生的文件属于0:0，也就是root:root。容器外文件也会属于0:0，同样是root:root。这样产生的文件就需要容器外的root权限才可以操作。</li><li>若容器内使用非root运行程序，例如<code>demo:x:1000:1000::/home/blog:/bin/bash</code>，产生的文件属于1000:1000。容器外文件也会属于1000:1000，而容器外uid为1000的用户可能是test，这是若碰巧你就是test，你就可以顺利读取这个文件。但若你是uid为1001的test2，而且t是个test2讨厌鬼，你就告别这个文件了。甚至容器外根本没有uid为1000的用户，那这个文件就不属于任何人。</li></ul><h3 id="docker用户组">docker用户组</h3><p>docker用户组的出现,目的在于当普通用户既无<code>sudo</code>权限,有想运行<code>docker</code>命令时出现.</p><p>一般来说,在<code>linux</code>环境下安装完成<code>docker</code>,系统会自动创建<code>id=999</code>的<code>docker组</code> . 此时只需要将普通用户加入到<code>docker组</code>中即可.</p><blockquote><p>具体 docker组的id, 请自行查看</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923103643.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923103643.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923103642016"></p></blockquote><p>方式有两种(需要在拥有sudo权限的账号下修改):</p><ul><li><p>使用<code>usermod</code>命令</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">usermod</span> -aG docker <span class="token operator">&lt;</span>用户名<span class="token operator">></span><span class="token comment"># e.g sudo usermod -aG docker test1</span></code></pre></li><li><p>直接修改 <code>/etc/group</code> 中 <code>docker </code>所在组</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/group<span class="token comment"># 在docker所在行,按格式在后面添加用户名即可</span></code></pre><p>修改完成后,重启ssh或重新登即可, 使用<code>id &lt;用户名&gt; </code> 检查是否在docker所在组</p></li></ul></div><h2 id="三种可能解决方法">三种可能解决方法</h2><div class="story post-story"><h3 id="1-限定开启用户">1. 限定开启用户</h3><p>即运行 <code>docker run -u &lt;xxx&gt;:&lt;xxx&gt; </code></p><p>但这个方法无法解决上述的需求</p><h3 id="2-使用子用户">2.使用子用户</h3><blockquote><p>若容器内外文件的uid:gid可以不同，这个问题就可以很容易解决。的确有这么一个方案，让容器内所有的uid:gid以一定的规则映射，<strong>我推荐使用这一方案</strong>。文章的方案演示节中我会演示这一方案。</p><p>在官方文档中，这个方案本身是为了解决安全问题，见<a href="https://docs.docker.com/engine/security/userns-remap/">这里</a>。发生容器挂载磁盘root权限提权也不是一次两次了，这算是一个官方的解决方案。</p><p><a href="https://docs.docker.com/engine/security/userns-remap/">https://docs.docker.com/engine/security/userns-remap/</a></p><p><strong>但这个方案会有一些<a href="https://docs.docker.com/engine/security/userns-remap/#user-namespace-known-limitations">限制</a>：</strong></p><ul><li><strong>不可使用<code>--pid=host</code> 或 <code>--network=host</code></strong></li><li><strong>不可使用无法识别或使用用户映射的挂载磁盘</strong></li><li><strong>若使用<code>docker run --privileged</code>则必须同时使用<code>--userns=host</code></strong></li></ul><p><strong>都是不大的限制，使用的时候留个心眼即可。</strong></p></blockquote><h4 id="解释"><strong>解释:</strong></h4><p>因为<code>docker</code> 权限映射的原理是, 容器内外uid与gid相同,</p><p>那么我是否可以 通过 <code>userns-remap</code>  命令实现, 将容器内的root 映射到容器外宿主机上一个具有管理员(sudo)的用户(称为<code>siz</code>)上呢,而其他普通用户(<code>test&lt;xxx&gt;</code>)只需要在这个<code>siz</code>所在的组即可. 而这个组的小组管理员即为<code>siz</code>.</p><p>但此时一个新的问题出现了: 当普通用户创建文件夹映射时, 此文件夹的所属者为<code>siz</code>,但小组权限仅为<code>xr</code> 即所在组的成员没有修改的权限,只有读和运行的权限, 并且此时普通用户(<code>test&lt;xxx</code>&gt; 并没有<code>sudo</code>权限,也就无法通过<code>chmod g+w</code> 等命令来实现提权.   此时该如何解决呢?</p><p>答: 通过进入容器内提权实现,</p><p>​因为容器内的用户为<code>root</code>,即对应的权限为小组管理员<code>siz</code>, 而小组管理员拥有(<code>sudo</code>) 权限, 又因为文件映射是容器内外相同的, 在容器内修改了文件权限, 那么在容器外普通用户就有了<code>读写执行</code>的权限.</p><h4 id="操作实现">操作实现</h4><ol><li><p>修改<code>/etc/subuid</code> 与 <code>/etc/subgid</code></p><p><strong>查看小组的管理员id</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">id</span> siz<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token comment"># 得到 siz的id 为 1000</span></code></pre><p>使用带<code>sudo</code>的权限账号修改 <code>/etc/subuid</code> 与 <code>/etc/subgid</code> 文件</p><pre class="language-bash" data-language="bash"><code class="language-bash">格式为: <span class="token operator">&lt;</span>name<span class="token operator">></span>:start:number</code></pre><p>对应方式:  如果组管理员<code>id </code>为<code>1000</code> , 则对应容器内的<code>root</code> 为<code>1</code> , 即<code>&lt;name&gt;:1000:1</code></p><p>如果组管理员<code>id</code>为 <code>1003</code> ,则对应容器内的<code>root</code> 为 <code>1+(1003-1000)=4</code> 即 <code>&lt;name&gt;:1003:4</code></p><p><strong>根据组管理员<code>id</code> 对应设置好映射</strong></p><p>例如本文组管理员<code>siz</code> 的 <code>id </code> 为1000 , 则修改为如下样式, 并保存修改</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sudo vim /etc/subuid</span>siz:1000:1siz:100000:65536test1:165536:65536test2:231072:65536demo:296608:65536<span class="token comment"># sudo vim /etc/subgid</span>siz:1000:1siz:100000:65536test1:165536:65536test2:231072:65536demo:296608:65536</code></pre></li><li><p>修改<code>docker</code> 守护程序  <code>/etc/docker/daemon.json</code></p><p>注意修改  <code>/etc/docker/daemon.json</code> 文件后, 会导致之前的 镜像与容器不被识别, 所以请做好备份.</p><p>容器-&gt;打包成镜像-&gt; 推送到hub</p><blockquote><p><strong>Enabling <code>userns-remap</code> effectively masks existing image and container layers, as well as other Docker objects within <code>/var/lib/docker/</code>.</strong> This is because Docker needs to adjust the ownership of these resources and actually stores them in a subdirectory within <code>/var/lib/docker/</code>. It is best to enable this feature on a new Docker installation rather than an existing one.</p></blockquote><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 没有这个文件的化, 请创建</span><span class="token comment"># sudo vim /etc/docker/daemon.json</span><span class="token punctuation">&#123;</span><span class="token string">"userns-remap"</span><span class="token builtin class-name">:</span><span class="token string">"&lt;组管理员名称>"</span><span class="token punctuation">&#125;</span><span class="token comment"># sudo service docker restart</span><span class="token comment"># 查看docker 状态 sudo systemctl status docker.service </span></code></pre><blockquote><p>这里 `“userns-remap”:&quot;&lt;组管理员名称&gt;&quot;的格式 参考官方文档</p><p><a href="https://docs.docker.com/engine/security/userns-remap/">https://docs.docker.com/engine/security/userns-remap/</a></p><p>Edit <code>/etc/docker/daemon.json</code>. Assuming the file was previously empty, the following entry enables <code>userns-remap</code> using user and group called <code>testuser</code>. You can address the user and group by ID or name. You only need to specify the group name or ID if it is different from the user name or ID. If you provide both the user and group name or ID, separate them by a colon (<code>:</code>) character. The following formats all work for the value, assuming the UID and GID of <code>testuser</code> are <code>1001</code>:</p><ul><li><code>testuser</code></li><li><code>testuser:testuser</code></li><li><code>1001</code></li><li><code>1001:1001</code></li><li><code>testuser:1001</code></li><li><code>1001:testuser</code></li></ul></blockquote></li><li><p>修改普通用户的组</p><div class="note danger"><p>当在进行测试的时候发现一个新的问题:</p></div><span class='p cyan'>即组内普通用户创建的文件在容器中因为没有相应的`uid:gid` 映射, 并且容器中的`root`用户的权限很低时(组管理员拥有sudo权限,但需要输入sudo才可以; 而容器中时没有sudo命令的,所有说这里的`root`权限很低)在这种情况下: 就会出现普通用户创建的文件,在容器中被识别为: `nobody ,nogroups 现象</span><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923191104.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923191104.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923191103296"></p><details cyan><summary> 暂时的解决方法 </summary>              <div class='content'>              <ol><li><p>普通用户删除私有组,即让普通用户的主组为(docker容器映射的管理员所在的组)</p><p>​例如: 本文演示小组管理员为<code>siz</code>, 组名为(<code>siz</code>) 则让 普通用户<code>test&lt;xxx&gt;</code> 的主组为<code>siz</code></p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 命令:  sudo usermod -g &lt;小组管理员名称> &lt;普通用户名称></span><span class="token comment"># 将普通用户的主组从私有组改为小组管理员所在的组</span>$ <span class="token function">sudo</span> <span class="token function">usermod</span> -g  test1 siz</code></pre><ol start="2"><li>对宿主机(容器外)组成员中普通用户创建的文件或文件夹提升组权限</li></ol><p><strong>目的: 使容器内<code>root</code>获得对这个文件夹拥有修改<code>(w)</code> 权限</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">chmod</span> g+wxr <span class="token operator">&lt;</span>xxx<span class="token operator">></span></code></pre><ol start="3"><li>对容器内<code>root</code> 创建的文件或文件夹提升组权限</li></ol><p><strong>目的: 使宿主机(容器外) 组成员普通用户获得对这个文件夹拥有修改<code>(w)</code> 权限</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">chmod</span> g+wxr <span class="token operator">&lt;</span>xxx<span class="token operator">></span></code></pre></li></ol><p><strong>缺陷:</strong></p><p><strong>当内外创建新的文件和文件夹使, 内外要不断的使用<code>chmod</code> 命令进行授权,</strong></p>              </div>            </details></li></ol><h4 id="演示"><strong>演示:</strong></h4><p><strong>组成员</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923112730.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923112730.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923112729409"></p><ul><li><p>组管理员(<code>siz</code>) 进行映射测试:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923112455.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923112455.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923112454090"></p></li><li><p>组成员<code>test1</code> 进行映射测试</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923113946.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923113946.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923113945262"></p></li></ul><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210923114232.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210923114232.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210923114231331"></p><ol start="3"><li><p>使用<code>entrypoint.sh</code> 定制脚本</p><p>这个过程是在编写<code>Dockerfile</code>文件时使用的,</p><p>目的是让容器内外对应的用户相等来解决文件夹映射目录权限的问题.</p><p>主要的思路是,从主机中读取当前用户的<code>id</code>, 然后再创建容器时相应的在容器内部新建一个对应的用户,</p><p>这样保证了容器内外的<code>uid:gid</code> 相等.</p><p>但在这个里不符合我们的需求, 故不讨论.</p></li></ol></div><h2 id="总结">总结</h2><div class="story post-story"><p>为了解决<strong>让宿主机使用普通用户来使用docker,而在容器中相对给与较高的<code>root</code> 权限用户需求.</strong></p><p>本文采用了修改docker守护程序的方法,其官方文件本意是<code>docker</code>为了解决容器内<code>root</code>升权的问题</p><blockquote><p>所谓升权, 即不做任何修改情况下, 容器内<code>root</code> 与宿主机<code>root</code>相对应, 虽然这个容器内的权限是有一定限制的<code>root</code> 权限, 但可以通过映射宿主机根目录,将所有内容映射到容器中, 实现在容器中获得所有文件的权限,来实现恶意攻击.</p></blockquote><p>通过映射用户, 容器中的<code>root</code> 权限与宿主机被映射的用户权限相等,</p><div class="note info"><p>可以思考这样一个问题: 如果我映射的宿主机用户是一个普通用户(没有<code>sudo</code>)权限,那么容器里的<code>root</code> 有没有<code>sudo</code>权限呢?</p></div><details green><summary> 答案 </summary>              <div class='content'>              <p><psw>答案是没有的, 可以尝试一下. 容器的的<code>root </code>仅仅是个名称, 它可以叫做<code>superhero</code> 也可以叫做 <code>tom</code> , 只是个名字,并无所谓,真正相关的是<code>uid:gid</code></psw></p>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实验室服务器用户分级管理+Docker多环境运行设想</title>
      <link href="/posts/55127002/"/>
      <url>/posts/55127002/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><h2 id="用户分级管理">用户分级管理</h2><div class="story post-story"><h3 id="初步设想">初步设想:</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210910114927.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210910114927.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210910114926555"></p><p>root 用户为超级管理员,</p><p>管理员-A 拥有管理权限,负责维护.</p><p>普通群组无超级管理员权限, 但拥有对docker镜像容器的创建修改删减启动等权限.</p><p>普通用户从dockerhub中拉取镜像,创建容器环境</p><div class='dropmenu-wrapper'>              <div class='dropmenu'>                <a>跳转</a>                <ul class='list-v'>                  <li>                <a class='menuitem' href='/page/clubmanualv1/' title='docker使用手册v1'>                  <i class='fas fa-book-open fa-fw'></i>                  docker使用手册v1                </a>              </li><hr>                </ul>              </div>            </div></div><h2 id="步骤">步骤</h2><div class="story post-story"><h3 id="安装Docker">安装Docker</h3><p>查看版本</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /proc/version$ <span class="token function">uname</span> -a$ lsb_release -a$ <span class="token function">cat</span> /etc/issue</code></pre><p>对症下药</p><h4 id="ubuntu">ubuntu</h4><p>参考文档 <a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p><h5 id="使用远程仓库安装">使用远程仓库安装</h5><p><strong>Install using the repository</strong></p><p>Before you install Docker Engine for the first time on a new host machine, you need to set up the Docker repository. Afterward, you can install and update Docker from the repository.</p><ol><li><p>Update the <code>apt</code> package index and install packages to allow <code>apt</code> to use a repository over HTTPS</p> <pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token comment"># 必要软件</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> gnupg lsb-release</code></pre></li><li><p>Add Docker’s official GPG key:</p> <pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">curl</span> -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</code></pre></li><li><p>Use the following command to set up the <strong>stable</strong> repository. To add the <strong>nightly</strong> or <strong>test</strong> repository, add the word <code>nightly</code> or <code>test</code> (or both) after the word <code>stable</code> in the commands below. <a href="https://docs.docker.com/engine/install/">Learn about <strong>nightly</strong> and <strong>test</strong> channels</a>.</p><blockquote><p>​<strong>Note</strong>: The <code>lsb_release -cs</code> sub-command below returns the name of your Ubuntu distribution, such as <code>xenial</code>. Sometimes, in a distribution like Linux Mint, you might need to change <code>$(lsb_release -cs)</code> to your parent Ubuntu distribution. For example, if you are using <code>Linux Mint Tessa</code>, you could use <code>bionic</code>. Docker does not offer any guarantees on untested and unsupported Ubuntu distributions.</p></blockquote> <div class="tabs" id="service"><ul class="nav-tabs"><li class="tab active"><a class="#service-1">x86_64 / amd64</a></li><li class="tab"><a class="#service-2">armhf</a></li><li class="tab"><a class="#service-3">arm64</a></li><li class="tab"><a class="#service-4">s390x</a></li></ul><div class="tab-content"><div class="tab-pane active" id="service-1"><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>  <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \  <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null</code></pre></div><div class="tab-pane" id="service-2"><pre class="language-bash" data-language="bash"><code class="language-bash">$  <span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>  <span class="token string">"deb [arch=armhf signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \  <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null</code></pre></div><div class="tab-pane" id="service-3"><pre class="language-bash" data-language="bash"><code class="language-bash">$  <span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>  <span class="token string">"deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \  <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null</code></pre></div><div class="tab-pane" id="service-4"><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>  <span class="token string">"deb [arch=s390x signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \  <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">></span> /dev/null</code></pre></div></div></div></li></ol><p><strong>Install Docker Engine</strong></p><ol><li><p>Update the <code>apt</code> package index, and install the <em>latest version</em> of Docker Engine and containerd, or go to the next step to install a specific version:</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io</code></pre><blockquote><p>Got multiple Docker repositories?</p><p>If you have multiple Docker repositories enabled, installing or updating without specifying a version in the <code>apt-get install</code> or <code>apt-get update</code> command always installs the highest possible version, which may not be appropriate for your stability needs.</p></blockquote></li></ol><p><strong>Upgrade Docker Engine</strong></p><p>To upgrade Docker Engine, first run <code>sudo apt-get update</code>, then follow the <a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">installation instructions</a>, choosing the new version you want to install.</p><h3 id="添加测试用户">添加测试用户</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> adduser test1Adding user <span class="token variable"><span class="token variable">`</span>test1' <span class="token punctuation">..</span>.Adding new group <span class="token variable">`</span></span>test1<span class="token string">' (1001) ...Adding new user `test1'</span> <span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">)</span> with group <span class="token variable"><span class="token variable">`</span>test1' <span class="token punctuation">..</span>.Creating home directory <span class="token variable">`</span></span>/home/test1<span class="token string">' ...Copying files from `/etc/skel'</span> <span class="token punctuation">..</span>.New password: Retype new password: passwd: password updated successfullyChanging the user information <span class="token keyword">for</span> test1Enter the new value, or press ENTER <span class="token keyword">for</span> the defaultFull Name <span class="token punctuation">[</span><span class="token punctuation">]</span>: Room Number <span class="token punctuation">[</span><span class="token punctuation">]</span>: Work Phone <span class="token punctuation">[</span><span class="token punctuation">]</span>: Home Phone <span class="token punctuation">[</span><span class="token punctuation">]</span>: Other <span class="token punctuation">[</span><span class="token punctuation">]</span>: Is the information correct? <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> y$ <span class="token function">sudo</span> adduser test2Adding user <span class="token variable"><span class="token variable">`</span>test2' <span class="token punctuation">..</span>.Adding new group <span class="token variable">`</span></span>test2<span class="token string">' (1002) ...Adding new user `test2'</span> <span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">)</span> with group <span class="token variable"><span class="token variable">`</span>test2' <span class="token punctuation">..</span>.Creating home directory <span class="token variable">`</span></span>/home/test2<span class="token string">' ...Copying files from `/etc/skel'</span> <span class="token punctuation">..</span>.New password: Retype new password: passwd: password updated successfullyChanging the user information <span class="token keyword">for</span> test2Enter the new value, or press ENTER <span class="token keyword">for</span> the defaultFull Name <span class="token punctuation">[</span><span class="token punctuation">]</span>: Room Number <span class="token punctuation">[</span><span class="token punctuation">]</span>: Work Phone <span class="token punctuation">[</span><span class="token punctuation">]</span>: Home Phone <span class="token punctuation">[</span><span class="token punctuation">]</span>: Other <span class="token punctuation">[</span><span class="token punctuation">]</span>: Is the information correct? <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> ysiz@ubuntu:/etc/apt$ </code></pre><p><strong>查看test1,test2 用户</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">id</span> test1<span class="token comment"># uid=1001(test1) gid=1001(test1) groups=1001(test1)</span>$ <span class="token function">id</span> test2<span class="token comment"># uid=1002(test2) gid=1002(test2) groups=1002(test2)</span><span class="token comment"># 可以发现 test1 test2 没有sudo 等权限,为 普通用户</span></code></pre><h3 id="授予docker权限">授予docker权限</h3><p><strong>将test1,test2 普通用户 添加到docker组中</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">usermod</span> -aG docker test1$ <span class="token function">sudo</span> <span class="token function">usermod</span> -aG docker test2</code></pre><p>重新登陆ssh 或者<code> log out</code> 在登陆后, 查看 用户标识</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">id</span> test1<span class="token comment"># uid=1001(test1) gid=1001(test1) groups=1001(test1),,998(docker)</span><span class="token comment"># 可以发现多了docker的 组标识</span><span class="token comment"># 此时运行docker info 测试</span>$ docker infoClient: Context:    default Debug Mode: <span class="token boolean">false</span> Plugins:  app: Docker App <span class="token punctuation">(</span>Docker Inc., v0.9.1-beta3<span class="token punctuation">)</span>  buildx: Build with BuildKit <span class="token punctuation">(</span>Docker Inc., v0.6.1-docker<span class="token punctuation">)</span>  scan: Docker Scan <span class="token punctuation">(</span>Docker Inc., v0.8.0<span class="token punctuation">)</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210916153753.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210916153753.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210916153752143"></p><h3 id="拉取-docker-images">拉取 docker images</h3><p>测试test1拉去docker镜像</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker pull sizaif2000/ubuntu2004v1:1.0</code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210916153828.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210916153828.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210916153827220"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210916153921.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210916153921.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210916153920876"></p><p><strong>ubuntu:20.04  V1</strong></p><blockquote><p>使用清华源</p><p>已安装基本工具:</p><p><code>VIM - Vi IMproved 8.1 (2018 May 18, compiled Apr 15 2020 06:40:31)</code></p><p><code>cmake version 3.16.3</code></p><p><code>gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)</code></p><p><code>g++  (4:9.3.0-1ubuntu2).</code></p><p><code>wget</code>,<code>git</code>,<code>autoconf</code>,<code>automake</code>,<code>build-essential</code></p><p><code>Python 3.8.10 (default, Jun  2 2021, 10:49:15)</code></p><p><code>pip3 pip 20.0.2 from /usr/lib/python3/dist-packages/pip (python 3.8)</code></p></blockquote><p><strong>ubuntu:20.04  V2</strong></p><blockquote><p>使用清华源</p><p>已安装基本工具:</p><p><code>VIM - Vi IMproved 8.1 (2018 May 18, compiled Apr 15 2020 06:40:31)</code></p><p><code>cmake version 3.16.3</code></p><p><code>gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)</code></p><p><code>g++  (4:9.3.0-1ubuntu2).</code></p><p><code>wget</code>,<code>git</code>,<code>autoconf</code>,<code>automake</code>,<code>build-essential</code></p><p><code>Python 3.8.10 (default, Jun  2 2021, 10:49:15)</code></p><p><code>pip3 pip 20.0.2 from /usr/lib/python3/dist-packages/pip (python 3.8)</code></p><p>==<code>java-jdk1.8.0_291</code>==</p></blockquote></div><h2 id="参考知识">参考知识</h2><div class="story post-story"><h3 id="添加-移除-sudo-权限">添加/移除 sudo 权限</h3><p>给某个用户添加 sudo 权限</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> adduser XXXX <span class="token function">sudo</span></code></pre><p>移除某个用户sudo权限</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> deluser xxxx <span class="token function">sudo</span></code></pre><blockquote><p>==注意!!!==  移除sudo时, 管理用不要把唯一的管理员的sudo权限移除掉, 否则需要 root 用户重新添加</p></blockquote><h3 id="ubuntu用户组">ubuntu用户组</h3><h4 id="用户和用户标识号">用户和用户标识号</h4><p><strong>用户</strong></p><p>我们登录到Linux系统，使用的登录名和密码实际上就是用户的信息标识。用户拥有账号、登录名、真实姓名、密码、主目录、默认shell等属性。每个用户实际上代表了一组权限，而这些权限分别表示可以执行不同的操作，是能够获取系统资源的权限的集合。</p><p><strong>用户标识号</strong></p><p>Linux实际上并不直接认识用户的账号，而是查看用户标识号。</p><p><strong>用户标识号（整数）：</strong></p><p>0： root，超级用户。</p><p>1-499：系统用户，保证系统服务正常运行，一般不使用。</p><p>500-60000：普通用户，可登录系统，拥有一定的权限。管理员添加的用户在此范围内。</p><p>用户名和标识号不一定一一对应，Linux允许几个登录名对应同一个用户标识号。</p><p>系统内部管理进程和文件访问权限时使用用户标识号。</p><p>账号和标识号的对应关系在/etc/passwd文件中。</p><p><strong>/etc/passwd文件</strong></p><p>该文件所有者和所属组为root，除了root用户外只有读取的权限。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210914225753.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210914225753.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p>格式：登录名：口令：用户标识号：组标识号：注释：用户主目录：Shell程序</p><p>登录名：同意系统中唯一，大小敏感。</p><p>口令：密码，root和用户可使用passwd命令修改。<br>用户标识号：唯一。<br>组标识号：每个用户可以同时属于多个组。<br>注释：相关信息，真实姓名、联系电话等。mail和finger等会使用这些信息。<br>用户主目录：用户登录后的默认工作目录。root为/root，一般用户在/home下。<br>Shell程序：登录后默认启动的Shell程序。</p><p><strong>/etc/shadow文件</strong></p><p>包含用户的密码和过期时间，只有root组可读写。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210914225924.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210914225924.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p>格式：登录名：加密口令：最后一次修改时间：最小时间间隔：最大时间间隔：警告时间：密码禁用期：账户失效时间：保留字段</p><p>登录名：略。</p><p>加密口令：*表示账户被锁定，！表示密码被锁定。其他的前三位表示加密方式。</p><p>最后一次修改时间：最近修改密码的时间，天为单位，1970年1月1日算起。</p><p>最小时间间隔：最小修改密码的时间间隔。</p><p>最大时间间隔：最长密码有效期，到期要求修改密码。</p><p>警告时间：密码过期后多久发出警告。</p><p>密码禁用期：密码过期后仍然接受的最长期限。</p><p>账号失效时间：账户的有效期，1970年1月1日算起，空串表示永不过期。</p><p>保留字段：保留将来使用。</p><p><strong>用户组和组标识号</strong></p><p><strong>用户组</strong></p><p>用户组指，一组权限和功能相类似的用户的集合。</p><p>Linux本身预定义了许多用户组，包括root、daemon、bin、sys等，用户可根据需要自行添加用户组。</p><p>用户组拥有组名、组标识号、组成员等属性。</p><p><strong>用户组编号</strong></p><p>Linux内部通过组标识号来标识用户组。</p><p>用户组信息保存在 /etc/group 中。</p><p><strong>/etc/group文件</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210914230040.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210914230040.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p>格式：组名：口令：组标识符：成员列表</p><p>/etc/passwd文件指定的用户组在/etc/group中不存在则无法登录。</p><p><strong>用户管理</strong></p><p><strong>添加用户</strong></p><p><strong>useradd命令</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">useradd</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> 登录名<span class="token comment"># option参数自行查阅。</span><span class="token comment"># 一般加-m创建目录。</span></code></pre><p><strong>adduser命令</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ adduser <span class="token punctuation">[</span>option<span class="token punctuation">]</span> user</code></pre><p>如果没有指定–system和–group选项，则创建普通用户。</p><p>否则创建系统用户或用户组。</p><p><strong>修改用户信息：usermod</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">usermod</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> 用户名<span class="token comment"># 具体选项信息自行查阅。</span></code></pre><p><strong>删除用户：userdel</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">userdel</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> 用户名<span class="token comment"># -f：强制删除（谨慎使用）</span><span class="token comment"># -r：主目录中的文件一并删除。</span></code></pre><p><strong>修改用户密码：passwd</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">passwd</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> 登录名</code></pre><p><strong>显示用户信息</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">id</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token punctuation">[</span>用户<span class="token punctuation">]</span></code></pre><p><strong>用户间切换：su命令</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">su</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token punctuation">[</span>用户名<span class="token punctuation">]</span><span class="token comment"># 用户名为 - ，则切换到root用户。</span></code></pre><p><strong>受限的特权：sudo命令</strong></p><p>sudo使得用户可以在自己的环境下，执行需要root权限的命令。</p><p>该信息保存在/etc/sudoers中。</p><h3 id="用户组管理">用户组管理</h3><p><strong>添加用户组</strong><br><strong>addgroup命令</strong><br>类似adduser</p><p><strong>groupadd</strong><br>类似useradd</p><p><strong>修改用户组</strong><br>类似usermod，使用groupmod。</p><p><strong>删除用户组</strong><br>类似userdel，使用groupdel。</p><h3 id="权限管理">权限管理</h3><p><strong>权限组</strong><br>一般创建文件的人为所有者，其所属的主组为所属组，其他用户为其他组。</p><p><strong>基本权限类型</strong></p><p>三种：读、写、执行。</p><p>权限及其表示值：</p><p>读：r或4</p><p>写：w或2</p><p>执行：x或1</p><p><strong>特殊权限</strong><br>setuid、setgid和黏滞位。</p><p>setuid和setgid能以文件所有者或所属组的身份运行。</p><p>黏滞位使得只有文件的所有者才可以重命名和删除文件。</p><p><strong>访问控制列表</strong><br>访问控制表ACL可以针对某个用户或者用户组单独设置访问权限。</p><p><strong>改变文件所有者chown命令</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">chown</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>:<span class="token punctuation">[</span>group<span class="token punctuation">]</span><span class="token punctuation">]</span> file<span class="token punctuation">..</span>.</code></pre><p><strong>改变文件所属组chgrp命令</strong></p><p>用户不受文件的文件主或超级用户不能修改组。</p><p><strong>设置权限掩码umask命令</strong></p><p>文件的权限为666-掩码</p><p>目录的权限为777-掩码</p><p><strong>修改文件访问权限</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">chmod</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span><span class="token punctuation">..</span>.mode<span class="token punctuation">[</span>,mode<span class="token punctuation">]</span><span class="token punctuation">..</span>.file<span class="token punctuation">..</span>.</code></pre><p>“+”：增加权限</p><p>“-”：减少权限</p><p>“=”：设置权限</p><p><strong>修改文件ACL：setfacl命令</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ setfacl <span class="token punctuation">[</span>option<span class="token punctuation">]</span> file<span class="token punctuation">..</span>.</code></pre><p><strong>查询文件的ACL</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ getfacl <span class="token punctuation">[</span>文件名<span class="token punctuation">]</span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TSW-2 列车操作手册合集</title>
      <link href="/posts/238e4ec1/"/>
      <url>/posts/238e4ec1/</url>
      
        <content type="html"><![CDATA[<h2 id="F40PH-3C型号操作手册">F40PH-3C型号操作手册</h2><div class="story post-story"><p>the F40PH-3C is a locomotive used on the <a href="https://train-sim-world.fandom.com/wiki/MBTA_Commuter_Rail">MBTA Commuter Rail</a>. It is featured in <a href="https://train-sim-world.fandom.com/wiki/Boston_Sprinter">Boston Sprinter</a>.</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829121101.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829121101.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829113012169"></p><h3 id="快速启动">快速启动</h3><ol><li>主电池<code>打开</code></li><li>无线电保险丝<code>打开</code></li><li>按住引擎启动开关4s</li><li>按住列车供电引擎启动4s</li><li>交流电按钮 <code>打开</code></li><li>列车电力设置为 “<code>长机罩拖车</code>”</li><li>隔离开关设置为<code>运行</code></li><li>断流阀设置为&quot;<code>切入</code>&quot;</li><li>MU-2A阀门设置为 “<code>导联或断开</code>”</li><li>引擎运行设置为<code>打开</code></li><li>电机磁场设置为<code>打开</code></li><li>控制与燃料泵设置为<code>打开</code></li><li>电空制动设置为<code>打开</code></li><li>设置主钥匙<code>插入</code></li></ol><p>此时状态为:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829114800.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829114800.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829114748256"></p><ol><li>打开车门迎客<code>U</code></li><li>反向器设置为: <code>前牵位</code> ( 此时阀门要设置空挡)</li><li>设置列车单独制动为 &quot; <code>缓解</code>&quot;</li><li>增加阀门上调动力 <code>前进</code></li><li>列车启动 done</li></ol><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829121035.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829121035.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829121034412"></p></div><h2 id="CTC-3-型号操作手册">CTC-3 型号操作手册</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829163940.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829163940.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829163938684"></p><h3 id="快速启动-2">快速启动</h3><ol><li><p>发电机磁场设置为<code>打开</code></p></li><li><p>引擎运行设置为<code>打开</code></p></li><li><p>电空制动控制设置为<code>打开</code></p></li><li><p>反向器设置为<code>空挡</code></p></li><li><p>断流阀设置为<code>客运</code></p></li><li><p>打开车门<code>上客</code></p></li><li><p>反向器设置为: <code>前牵位</code> ( 此时阀门要设置空挡)</p></li><li><p>制动设置为<code>缓解</code></p></li><li><p>增加阀门上调动力</p></li><li><p>列车启动done</p></li></ol></div><h2 id="德铁-403-ICE3-机型手册">德铁 403&quot;ICE3&quot;机型手册</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829200448.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829200448.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829200444842"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829201251.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829201251.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829201248278"></p><h3 id="快速启动-3">快速启动</h3><p>节流阀启动增加动力</p></div><h2 id="423-机型手册">423 机型手册</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210829201448.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210829201448.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210829201446421"></p><h3 id="快速启动-4">快速启动</h3><ol><li><p>插入反向器钥匙</p></li><li><p>反向器设置为<code>前牵引</code></p></li><li><p>开启<code>车门</code></p></li><li><p>施加动力<code>开启火车</code> ( 主控器向前施加百分比动力/ 向后设置制动减速)</p></li></ol></div>]]></content>
      
      
      <categories>
          
          <category> 游戏向 </category>
          
          <category> TSW2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TSW2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决Win平台上linux虚拟机脚本格式问题</title>
      <link href="/posts/448c4b49/"/>
      <url>/posts/448c4b49/</url>
      
        <content type="html"><![CDATA[<h1>解决Win平台上linux虚拟机脚本格式问题</h1><h2 id="问题描述">问题描述</h2><div class="story post-story"><p>经常会有以下使用场景:</p><p>在windows平台上编写脚本,复制脚本到docker容器linux中运行,或者复制到linux虚拟机中运行.</p><p>尝尝会报错: <code>$'\r' command not found </code> 这样的错误</p><hr><p>原因在于:</p><p><code>Carriage-Return 回车符\r</code></p><p><code>Line-Feed 换行符\n</code></p><p>windows平台使用的格式是<code>CRLF</code> 结尾是 <code>\r\n</code>; 而 linux 和macOS平台使用的是<code>LF</code>结尾是<code>\n</code> ;而MAC平台使用的是<code>CR</code> 结尾是<code>\r</code></p><blockquote><p>老的Mac系统（Mac OS, OS X）：<code> \r</code></p><p>新的Mac系统（macOS）:<code>\n</code></p><p>在2001年以前的Mac操作系统，称为Classic Mac OS，行末采用”\r”，这一系列操作系统的最后一个版本是1999年发布的Mac OS 9；</p><p>从2001年3月发布的Mac OS 10.0开始，行末采用”\n”，称为macOS或OS X</p></blockquote><h3 id="查看脚本格式">查看脚本格式</h3><p>1.<code>cat -A filename</code>，如果输出结果中行末尾是^M$，则是dos格式，如果行末尾只是$，则是unix格式。</p><p>2.<code>vim filename</code>，编辑文件，执行“:set ff”,若执行结果为fileformat=dos则为dos格式，若执行结果为fileformat=unix则为unix格式。</p><p>3.<code>od -t x1 filename</code>，以16进制查看文件，若输出结果中存在“0d 0a”则为dos格式，如果只有“0a”则为unix格式。其中“0d”即为回车符“\r”，“0a”即为换行符“\n”。</p></div><h2 id="解决方法">解决方法</h2><div class="story post-story"><p>当然是想办法把windows平台下的脚本转换成 <code>LF</code>呀</p><ol><li>如果有<emp>vim\vi</emp></li></ol><p>​vim内执行  <kbd>Shift</kbd> + <kbd>;</kbd></p><pre class="language-bash" data-language="bash"><code class="language-bash">:set ff <span class="token operator">=</span> unix:wq</code></pre><ol start="2"><li><p>使用<code>dos2unix</code> 工具</p><p>如果用的是 <code>git bash</code> 那么该客户端已经自带了 <code>dos2unix</code></p><p>如果不是的话前提需要先安装<code>dos2unix</code></p><p><a href="http://dos2unix.sourceforge.net/">http://dos2unix.sourceforge.net/</a></p><p>例如: 我使用的是  <code>CygWin64 Mintty</code> 控制台</p><p>那么我只需要执行即可</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ apt-cyg <span class="token function">install</span> dos2unix</code></pre><p><strong>dos2unix 使用方法</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用方法</span>$ dos2unix filename<span class="token comment"># 或者使用以下命令,强制转换</span>$ <span class="token function">find</span> <span class="token builtin class-name">.</span> -type f -exec dos2unix <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> +<span class="token comment"># -f --force  Force conversion of all files. Also binary files.</span></code></pre></li><li><p>使用<code>sed</code> 命令</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sed</span> -e ‘s/.$//’ dosfile <span class="token operator">></span> unixfile</code></pre><p>通常情况下是完全可以实现的, 但这个方法不是100%的解决方法</p></li></ol><h3 id="git">git</h3><p>跨平台协作开发, 经场会出现在win平台下,使用<code>git clone</code> 命令将项目源码下载下来后,拿到linux虚拟机中运行,出现换行符错误的问题, 原因在于win平台使用git的时候, git自动将换行符替换为<code>\r\n</code>, 这时候再拿到linux中运行当然就不行了.</p><p>还好 Git 在设计时就考虑了这一点，其提供了一个 <code>autocrlf</code> 的配置项，用于在提交和检出时自动转换换行符，该配置有三个可选项：</p><ul><li><strong>true:</strong> 提交时转换为 LF，检出时转换为 CRLF</li><li><strong>false:</strong> 提交检出均不转换</li><li><strong>input:</strong> 提交时转换为LF，检出时不转换</li></ul><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 提交时转换为LF，检出时转换为CRLF</span><span class="token function">git</span> config --global core.autocrlf <span class="token boolean">true</span><span class="token comment"># 提交时转换为LF，检出时不转换</span><span class="token function">git</span> config --global core.autocrlf input<span class="token comment"># 提交检出均不转换</span><span class="token function">git</span> config --global core.autocrlf <span class="token boolean">false</span></code></pre><p><strong>查看当前<code>git config 配置</code></strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> config --listhttp.proxy<span class="token operator">=</span>socks5://127.0.0.1:7890https.proxy<span class="token operator">=</span>socks5://127.0.0.1:7890user.name<span class="token operator">=</span>XXXXuser.email<span class="token operator">=</span>XXXXcore.autocrlf<span class="token operator">=</span>true</code></pre><p>如果把 <code>autocrlf </code>设置为 <code>false</code> 时，那另一个配置项 <code>safecrlf</code> 最好设置为 <strong><code>ture</code></strong>。该选项用于检查文件是否包含混合换行符，其有三个可选项</p><ul><li><strong>true:</strong> 拒绝提交包含混合换行符的文件</li><li><strong>false:</strong> 允许提交包含混合换行符的文件</li><li><strong>warn:</strong> 提交包含混合换行符的文件时给出警告</li></ul><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 拒绝提交包含混合换行符的文件</span><span class="token function">git</span> config --global core.safecrlf <span class="token boolean">true</span><span class="token comment"># 允许提交包含混合换行符的文件</span><span class="token function">git</span> config --global core.safecrlf <span class="token boolean">false</span><span class="token comment"># 提交包含混合换行符的文件时给出警告</span><span class="token function">git</span> config --global core.safecrlf warn</code></pre><p>像比如我, 再win上开发,使用git提交到github, 经常从github上下载项目,再win上修改后,拿到linux虚拟机/docker中运行,</p><p>那我的做法就是: <strong>代码仓库使用统一的换行符(LF)</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> config --global core.autocrlf input$ <span class="token function">git</span> config --global core.safecrlf <span class="token boolean">true</span></code></pre><p>当遇到CRLF无法提交的时候, 用<code>doc2unix</code> 转换一下即可</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Win </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Win </tag>
            
            <tag> 脚本格式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo博客优化</title>
      <link href="/posts/83186147/"/>
      <url>/posts/83186147/</url>
      
        <content type="html"><![CDATA[<h1>hexo博客优化</h1><h2 id="本地优化">本地优化</h2><div class="story post-story"><h3 id="文章链接唯一">文章链接唯一</h3><p>Hexo默认使用的文章永久链接格式是：</p><pre class="language-bash" data-language="bash"><code class="language-bash">year/:month/:day/:title/</code></pre><p><strong>缺点:</strong></p><p>若标题为中文标题,则分享链接时会变成%X%X%X%之类的东西,非常难受.又臭又长,而且一旦更改标题和日期,链接会失效,非常不友好</p><p><strong>解决方法:</strong></p><p>采用 <code>hexo-abbrlink </code>插件</p><ol><li><p>在博客根目录（执行hexo命令的地方）安装插件：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-abbrlink --save</code></pre></li><li><p>编辑站点配置文件 <code>_config.yml</code></p><p>首先注释掉原先的<code>permalink</code>设置</p><details green><summary> 配置代码 </summary>              <div class='content'>              <pre class="language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># ======================================================= #</span><span class="token comment"># =====================abbrlink========================== #</span><span class="token comment"># ======================================================= #</span><span class="token comment">#permalink: :year/:month/:day/:title/</span><span class="token comment"># permalink_defaults:</span><span class="token comment"># pretty_urls:</span><span class="token comment">#   trailing_index: false # Set to false to remove trailing 'index.html' from permalinks</span><span class="token comment">#   trailing_html: false # Set to false to remove trailing '.html' from permalinks</span><span class="token key atrule">permalink</span><span class="token punctuation">:</span> posts/<span class="token punctuation">:</span>abbrlink/  <span class="token key atrule">abbrlink</span><span class="token punctuation">:</span>  <span class="token key atrule">alg</span><span class="token punctuation">:</span> crc32      <span class="token comment">#support crc16(default) and crc32</span>  <span class="token key atrule">rep</span><span class="token punctuation">:</span> hex        <span class="token comment">#support dec(default) and hex</span>  <span class="token key atrule">drafts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment">#(true)Process draft,(false)Do not process draft. false(default)</span>  <span class="token comment"># Generate categories from directory-tree</span>  <span class="token comment"># depth: the max_depth of directory-tree you want to generate, should > 0</span>  <span class="token key atrule">auto_category</span><span class="token punctuation">:</span>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment">#true(default)</span>    <span class="token key atrule">depth</span><span class="token punctuation">:</span>        <span class="token comment">#3(default)</span>    <span class="token key atrule">over_write</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">auto_title</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#enable auto title, it can auto fill the title by path</span>  <span class="token key atrule">auto_date</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#enable auto date, it can auto fill the date by time today</span>  <span class="token key atrule">force</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#enable force mode,in this mode, the plugin will ignore the cache, and calc the abbrlink for every post even it already had abbrlink.</span></code></pre>              </div>            </details><p>项目链接:  <div class="tag link"><a class="link-card" title="hexo-abbrlink" href="https://github.com/Rozbo/hexo-abbrlink"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">hexo-abbrlink</p><p class="url">https://github.com/Rozbo/hexo-abbrlink</p></div></a></div></p></li><li><p>重新部署</p><pre class="language-bash" data-language="bash"><code class="language-bash">hexo clean <span class="token operator">&amp;&amp;</span> hexo g</code></pre><p>重新部署后,会在<code>front-matter</code> 字段中增加<code> abbrlink</code> 字段</p></li><li><p>验证查看 ,本地测试查看</p><pre class="language-bash" data-language="bash"><code class="language-bash">hexo s -g</code></pre></li></ol><h3 id="Gulp压缩资源">Gulp压缩资源</h3><h4 id="安装gulp及相关插件">安装gulp及相关插件</h4><p>可以直接修改 <code>package.json</code>  添加 <code>gulp-replace </code> 版本号以及<code>gulp依赖</code></p><p>修改完成后, 在blog根目录下控制台 输入: <code> npm i</code> 重新部署<code>package.json</code></p><p>以下是我的<code>package.json</code> 可供参考</p><details green><summary> package.json </summary>              <div class='content'>              <pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"hexo-site"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.0"</span><span class="token punctuation">,</span>  <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"rebuild"</span><span class="token operator">:</span> <span class="token string">"hexo clean &amp;&amp; hexo g &amp;&amp; gulp"</span><span class="token punctuation">,</span>    <span class="token property">"rebuildJsd"</span><span class="token operator">:</span> <span class="token string">"hexo clean &amp;&amp; hexo generate --config _github.yml &amp;&amp; gulp two"</span><span class="token punctuation">,</span>    <span class="token property">"deployGit"</span><span class="token operator">:</span> <span class="token string">"hexo deploy --config _github.yml"</span><span class="token punctuation">,</span>    <span class="token property">"deployGitHub"</span><span class="token operator">:</span> <span class="token string">"hexo deploy --config _githubOnly.yml"</span><span class="token punctuation">,</span>    <span class="token property">"deployOss"</span><span class="token operator">:</span> <span class="token string">"hexo deploy --config _tencent.yml"</span><span class="token punctuation">,</span>    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"hexo clean &amp;&amp; hexo g &amp;&amp; gulp &amp;&amp; hexo d"</span><span class="token punctuation">,</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"hexo generate"</span><span class="token punctuation">,</span>    <span class="token property">"clean"</span><span class="token operator">:</span> <span class="token string">"hexo clean"</span><span class="token punctuation">,</span>    <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"hexo server"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"hexo"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"5.4.0"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"aplayer"</span><span class="token operator">:</span> <span class="token string">"^1.10.1"</span><span class="token punctuation">,</span>    <span class="token property">"gulp-replace"</span><span class="token operator">:</span> <span class="token string">"^1.1.3"</span><span class="token punctuation">,</span>    <span class="token property">"hexo"</span><span class="token operator">:</span> <span class="token string">"^5.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-abbrlink"</span><span class="token operator">:</span> <span class="token string">"^2.2.1"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-autonofollow"</span><span class="token operator">:</span> <span class="token string">"^1.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-deployer-git"</span><span class="token operator">:</span> <span class="token string">"^3.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-archive"</span><span class="token operator">:</span> <span class="token string">"^1.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-baidu-sitemap"</span><span class="token operator">:</span> <span class="token string">"^0.1.9"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-category"</span><span class="token operator">:</span> <span class="token string">"^1.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-index"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-json-content"</span><span class="token operator">:</span> <span class="token string">"^4.2.3"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-search"</span><span class="token operator">:</span> <span class="token string">"^2.4.3"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-sitemap"</span><span class="token operator">:</span> <span class="token string">"^2.1.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-generator-tag"</span><span class="token operator">:</span> <span class="token string">"^1.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-renderer-ejs"</span><span class="token operator">:</span> <span class="token string">"^1.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-renderer-markdown-it"</span><span class="token operator">:</span> <span class="token string">"^5.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-renderer-stylus"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-server"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-theme-stellar"</span><span class="token operator">:</span> <span class="token string">"^1.4.1"</span><span class="token punctuation">,</span>    <span class="token property">"hexo-wordcount"</span><span class="token operator">:</span> <span class="token string">"^6.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"markdown-it-emoji"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"gulp"</span><span class="token operator">:</span> <span class="token string">"^4.0.2"</span><span class="token punctuation">,</span>    <span class="token property">"gulp-html-minifier-terser"</span><span class="token operator">:</span> <span class="token string">"^6.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"gulp-htmlclean"</span><span class="token operator">:</span> <span class="token string">"^2.7.22"</span><span class="token punctuation">,</span>    <span class="token property">"gulp-htmlmin"</span><span class="token operator">:</span> <span class="token string">"^5.0.1"</span><span class="token punctuation">,</span>    <span class="token property">"gulp-minify-css"</span><span class="token operator">:</span> <span class="token string">"^1.2.4"</span><span class="token punctuation">,</span>    <span class="token property">"gulp-terser"</span><span class="token operator">:</span> <span class="token string">"^2.0.1"</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h4 id="编辑gulpfile-js">编辑gulpfile.js</h4><p>blog根目录下添加<code>gulpfile.js</code> 文件</p><p>添加代码</p><blockquote><ol><li>其中  minify_html_jsd 对应的是使用cdn 重定向, 后面链接对应改成自己的静态文件仓库即可</li><li>pipe(replace(xxx, xxx)) 是链接重定向, 跟根据需求自定义</li></ol></blockquote><details green><summary> gulpfile.js </summary>              <div class='content'>              <pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> minifycss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-minify-css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> htmlmin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-html-minifier-terser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// var uglify = require('gulp-uglify');</span><span class="token keyword">var</span> htmlclean <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-htmlclean'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> terser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-terser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> replace <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-replace'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 压缩css文件</span><span class="token keyword">const</span> <span class="token function-variable function">minify_css</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./public/**/*.css'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">minifycss</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            compatibility<span class="token operator">:</span> <span class="token string">'ie8'</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// .pipe(minifycss())</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 压缩html文件</span><span class="token keyword">const</span> <span class="token function-variable function">minify_html</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./public/**/*.html'</span><span class="token punctuation">,</span><span class="token string">'!./public/&#123;lib,lib/**&#125;'</span><span class="token punctuation">,</span><span class="token string">'!./public/**.xml'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'src="/js/'</span><span class="token punctuation">,</span> <span class="token string">'src="https://sizaif.com/js/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'href="/css/"'</span><span class="token punctuation">,</span> <span class="token string">'href="https://sizaif.com/css/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'../img/img_article'</span><span class="token punctuation">,</span> <span class="token string">'https://sizaif.com/img/img_article/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">htmlclean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            removeComments<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            minifyURLs<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token function-variable function">minify_html_jsd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./public/**/*.html'</span><span class="token punctuation">,</span><span class="token string">'!./public/&#123;lib,lib/**&#125;'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'src="/js/'</span><span class="token punctuation">,</span> <span class="token string">'src="https://cdn.jsdelivr.net/gh/sizaif/blog-cdn@main/js/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'href="/css/"'</span><span class="token punctuation">,</span> <span class="token string">'href="https://cdn.jsdelivr.net/gh/sizaif/blog-cdn@main/css/"'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'../img/img_article'</span><span class="token punctuation">,</span> <span class="token string">'https://cdn.jsdelivr.net/gh/sizaif/blog-cdn@main/img/img_article'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">htmlclean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>            removeComments<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            minifyJS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            minifyURLs<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 压缩js文件</span><span class="token keyword">const</span> <span class="token function-variable function">minify_js</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>    gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./public/**/*.js'</span><span class="token punctuation">,</span> <span class="token string">'!./public/**/*.min.js'</span><span class="token punctuation">,</span><span class="token string">'!./public/&#123;lib,lib/**&#125;'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">terser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// .pipe(uglify())</span>        <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'./public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    minify_html<span class="token operator">:</span> minify_html<span class="token punctuation">,</span>    minify_css<span class="token operator">:</span> minify_css<span class="token punctuation">,</span>    minify_js<span class="token operator">:</span> minify_js<span class="token punctuation">,</span>    minify_html_jsd<span class="token operator">:</span> minify_html_jsd<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span>    minify_html<span class="token punctuation">,</span>    minify_css<span class="token punctuation">,</span>    minify_js<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'two'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span>    minify_html_jsd<span class="token punctuation">,</span>    minify_css<span class="token punctuation">,</span>    minify_js<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> gulp<span class="token punctuation">.</span><span class="token function">series</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>              </div>            </details><h4 id="运行">运行</h4><p>使用gulp后, 发布推送(<code>hexo d</code>)前需要添加一个命令</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 不使用cdn</span>$ hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> gulp <span class="token operator">&amp;&amp;</span> hexo d<span class="token comment"># 使用cdn重定向</span>$ hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> gulp two <span class="token operator">&amp;&amp;</span> hexo d</code></pre><h3 id="SEO-sitemap">SEO-sitemap</h3><h4 id="安装插件">安装插件</h4><p><strong>百度</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> hexo-generator-baidu-sitemap --save</code></pre><p><strong>谷歌</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> hexo-generator-sitemap --save</code></pre><h4 id="编辑主站-config-yml">编辑主站_config.yml</h4><p>添加代码</p><pre class="language-yml" data-language="yml"><code class="language-yml"><span class="token comment">## ======================================================= #</span><span class="token comment">## ==三、SEO 优化二网站地图 npm install hexo-generator-sitemap --save====== #</span><span class="token comment">## npm install hexo-generator-baidu-sitemap --save</span><span class="token comment">## ======================================================= #</span><span class="token key atrule">sitemap</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> sitemap.xml<span class="token comment">#  tag: true</span><span class="token comment">#  category: true</span><span class="token key atrule">baidusitemap</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> baidusitemap.xml</code></pre><h4 id="重新部署">重新部署</h4><p>会在<code>public</code>目录下生成:</p><p><code>sitemap.xml -&gt; 谷歌</code></p><p><code>baidusitemap.xml -&gt; 百度</code></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ hexo clean <span class="token operator">&amp;&amp;</span> hexo g</code></pre><p>然后分别去对于站点网站提交即可</p><div class="tag link"><a class="link-card" title="百度站点管理" href="https://ziyuan.baidu.com/site/"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">百度站点管理</p><p class="url">https://ziyuan.baidu.com/site/</p></div></a></div><div class="tag link"><a class="link-card" title="谷歌站点管理" href="https://search.google.com/search-console/about"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">谷歌站点管理</p><p class="url">https://search.google.com/search-console/about</p></div></a></div><h3 id="robots-txt文件">robots.txt文件</h3><blockquote><p>robots.txt是一个纯文本文件，在这个文件中网站管理者可以声明该网站中不想被robots访问的部分，或者指定搜索引擎只收录指定的内容。</p><p>当一个搜索机器人（有的叫搜索蜘蛛）访问一个站点时，它会首先检查该站点根目录下是否存在robots.txt，如果存在，搜索机器人就会按照该文件中的内容来确定访问的范围；如果该文件不存在，那么搜索机器人就沿着链接抓取。</p><p>另外，robots.txt必须放置在一个站点的根目录下，而且文件名必须全部小写。</p></blockquote><p>在<code>source</code> 目录下 新建 <code>robots.txt</code></p><p>域名改成自己的</p><details green><summary> robots.txt </summary>              <div class='content'>              <pre class="language-txt" data-language="txt"><code class="language-txt"># robots.txt www.sizaif.comUser-agent: * Allow: /sitemap.xmlAllow: /baidusitemap.xmlAllow: /category-sitemap.xmlAllow: /page-sitemap.xmlAllow: /post-sitemap.xmlAllow: /tag-sitemap.xmlAllow: /posts/Disallow: /cssDisallow: /jsDisallow: /fontsDisallow: /imgDisallow: /fontsDisallow: /pageDisallow: /navigationDisallow: /tagsDisallow: /archivesDisallow: /404.htmlDisallow: /403.htmlDisallow: /update.logDisallow: /search.xmlDisallow: /README.md</code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>七夕-杂谈</title>
      <link href="/posts/52b019f9/"/>
      <url>/posts/52b019f9/</url>
      
        <content type="html"><![CDATA[<p><img src="https://gitee.com/sizaif/images/raw/master/img/20210814173546.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210814173546.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt=""></p><p><strong>送给每一对甜甜蜜蜜的你们!</strong></p>]]></content>
      
      
      <categories>
          
          <category> 杂谈 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 杂谈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis Insert 插入时拿到自增的主键ID</title>
      <link href="/posts/eabbfbf/"/>
      <url>/posts/eabbfbf/</url>
      
        <content type="html"><![CDATA[<p><strong>useGeneratedKeys=“true” : 是否开启生成主键</strong></p><p><strong>keyColumn=“数据库中主键名称”</strong></p><p><strong>eyProperty=“(实体类中主键对应的名称或者自定义名称)”&gt;</strong></p><p>如果你传入的参数是<strong>实体类</strong>, 那么请注意keyProperty 对应的应该是实体类中的主键ID;</p><p>如果你传入的参数是<strong>map</strong>,那么就可以自定义名称.</p><p><strong>注意:新添加主键id并不是在执行添加操作时直接返回的，而是在执行添加操作之后将新添加记录的主键id字段返回到传入的参数类中.</strong></p><p>例如:</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>addUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span> <span class="token attr-name">useGeneratedKeys</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">keyColumn</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">keyProperty</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        INSERT INTO saishiguanli.users        (createDate, modifyDate, isEnabled, isLocked, lastLoginDate, lastLoginIp, lockDate, name, encodePassword)        VALUES        (#&#123;createDate&#125;,#&#123;modifyDate&#125;,#&#123;isEnabled&#125;,#&#123;isLocked&#125;,#&#123;lastLoginDate&#125;,#&#123;lastLoginIp&#125;,#&#123;lockDate&#125;,#&#123;name&#125;,#&#123;encodePassword&#125;)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">></span></span></code></pre><pre class="language-java" data-language="java"><code class="language-java">调用addUser方法后<span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 便可以取得主键ID<span class="token punctuation">;</span></code></pre><p><strong>若 传入的是实体类, 那么调用方法后 int id = user.getId(); 即可</strong></p>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis中update使用动态SQL语句</title>
      <link href="/posts/119fdf75/"/>
      <url>/posts/119fdf75/</url>
      
        <content type="html"><![CDATA[<p><strong>记个笔记:mybatis遇到的坑</strong></p><p>Mybatis 进行Update 操作时;</p><p>有的数据不一定要进行修改,因此从前台传过来的数据,某些项可能为null;</p><p>在进行sql 语句时 就会进行异常;导致操作失败;</p><p>所以进行动态SQL语句拼接:</p><p>在UserMapper.xml中 更改:Mybatis中update使用动态SQL语句</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>updateUser<span class="token punctuation">"</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>map<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>    update saishiguanli.user    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trim</span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>set<span class="token punctuation">"</span></span> <span class="token attr-name">suffixOverrides</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>,<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ulevel!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ulevel=#&#123;ulevel&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ugender!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ugender=#&#123;ugender&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uname!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>uname=#&#123;uname&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>upwd!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>upwd=#&#123;upwd&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>unickname!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>unickname=#&#123;unickname&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uimage!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>uimage=#&#123;uimage&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uphone!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>uphone=#&#123;uphone&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ucreatetime!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ucreatetime=#&#123;ucreatetime&#125;,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trim</span><span class="token punctuation">></span></span>    where uid = #&#123;uid&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决Waline使用图片上传图床跨域错误问题</title>
      <link href="/posts/db8bf7ad/"/>
      <url>/posts/db8bf7ad/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaf</p></blockquote><h2 id="错误描述">错误描述:</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210813100846.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210813100846.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210813100844769"></p></div><h2 id="说明">说明</h2><div class="story post-story"><ol><li>我采用的是Volantis 作为主题</li></ol><p>在主题<code>_config.yml</code> 文件中</p><p>修改waline 配置</p><pre class="language-stylus" data-language="stylus"><code class="language-stylus">waline<span class="token punctuation">:</span>  <span class="token property-declaration"><span class="token property">js</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment">//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js</span></span>  <span class="token property-declaration"><span class="token property">path</span><span class="token punctuation">:</span> # 全局评论地址 目前设置全局评论地址后visitor失效<span class="token punctuation">,</span>这是waline的问题</span>  <span class="token property-declaration"><span class="token property">placeholder</span><span class="token punctuation">:</span> 允许匿名评论，评论支持贴图，大家在截图后，在评论框粘贴，自动传至图床，欢迎使用体验<span class="token operator">~</span>  # 评论占位提示</span>  <span class="token property-declaration"><span class="token property">imageHosting</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment">//7bu.top/api/upload # 图床api「默认使用去不图床」</span></span>  # 其他配置项按照yml格式继续填写即可 除了 <span class="token punctuation">[</span>el path placeholder uploadImage<span class="token punctuation">]</span> 选项  <span class="token property-declaration"><span class="token property">meta</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nick<span class="token punctuation">,</span>mail<span class="token punctuation">,</span>link<span class="token punctuation">]</span> # waline comment header info</span>  <span class="token property-declaration"><span class="token property">requiredFields</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nick<span class="token punctuation">,</span>mail<span class="token punctuation">]</span></span>  <span class="token property-declaration"><span class="token property">serverURL</span><span class="token punctuation">:</span> # Waline 的服务端地址「必填」 测试用地址<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token comment">//waline-ruddy.vercel.app</span></span>  <span class="token property-declaration"><span class="token property">avatar</span><span class="token punctuation">:</span> robohash # gravatar style https<span class="token punctuation">:</span><span class="token comment">//waline.js.org/client/basic.html#avatar</span></span>  <span class="token property-declaration"><span class="token property">pageSize</span><span class="token punctuation">:</span> <span class="token number">10</span> # 评论每页显示数量</span>  <span class="token property-declaration"><span class="token property">lang</span><span class="token punctuation">:</span> zh-CN</span>  <span class="token property-declaration"><span class="token property">visitor</span><span class="token punctuation">:</span> <span class="token boolean">true</span></span></code></pre><p>其中 serverURL 选项 请参考文档使用说明</p><div class="tag link"><a class="link-card" title="waline文档" href="https://waline.js.org/guide/get-started.html"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">waline文档</p><p class="url">https://waline.js.org/guide/get-started.html</p></div></a></div><ol start="2"><li>若采用其他主题,可按照官方设置加入 uploadImage 即可, 具体参考</li></ol><pre class="language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>head<span class="token operator">></span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">'//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>  <span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span><span class="token operator">&lt;</span>body<span class="token operator">></span>  <span class="token operator">...</span>  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"waline"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token keyword">new</span> <span class="token class-name">Waline</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      el<span class="token operator">:</span> <span class="token string">'#waline'</span><span class="token punctuation">,</span>      path<span class="token operator">:</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span>      serverURL<span class="token operator">:</span> <span class="token string">'https://your-domain.vercel.app'</span>      <span class="token function-variable function">uploadImage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://7bu.top/upload/upload.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>        body<span class="token operator">:</span> formData      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span></code></pre></div><h2 id="修改">修改</h2><div class="story post-story"><ol><li><p>如果你使用volantis作为主题,</p><p>那么只需要修改<code>themes\volantis\layout\_third-party\comments\waline\script.ejs</code> 文件中 的<code>uploadImage</code>函数</p><p>将<code>your's token value</code> 替换为你自己的 图床 <code>token</code></p></li></ol><pre class="language-ejs" data-language="ejs"><code class="language-ejs">  uploadImage: function(file) &#123;   const formData = new FormData();   formData.append('image', file);   const token = "your's token value";   return fetch('<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>comments<span class="token punctuation">.</span>waline<span class="token punctuation">.</span>imageHosting </span><span class="token delimiter punctuation">%></span></span>', &#123;   method: 'POST',   body: formData,     headers: &#123;'Authorization': token&#125;   &#125;).then(resp => resp.json()).then(resp => resp.data.url);&#125;,</code></pre><ol start="2"><li><p>若采用其他主题</p><p>请修改代码 将<code>your's token value</code> 替换为你自己的 图床 <code>token</code></p><pre class="language-js" data-language="js"><code class="language-js"><span class="token operator">&lt;</span>head<span class="token operator">></span>  <span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">'//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>  <span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">></span><span class="token operator">&lt;</span>body<span class="token operator">></span>  <span class="token operator">...</span>  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"waline"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>  <span class="token operator">&lt;</span>script<span class="token operator">></span>    <span class="token keyword">new</span> <span class="token class-name">Waline</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>      el<span class="token operator">:</span> <span class="token string">'#waline'</span><span class="token punctuation">,</span>      path<span class="token operator">:</span> location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span>      serverURL<span class="token operator">:</span> <span class="token string">'https://your-domain.vercel.app'</span>      <span class="token function-variable function">uploadImage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token string">" your's token value"</span><span class="token punctuation">;</span>      formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://7bu.top/upload/upload.html'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>        method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>        body<span class="token operator">:</span> formData<span class="token punctuation">,</span>        headers<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token string">'Authorization'</span><span class="token operator">:</span> token<span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">></span></code></pre></li></ol></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 图床 </tag>
            
            <tag> Waline </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PicGo + Gitee(码云)实现markdown图床</title>
      <link href="/posts/373ab937/"/>
      <url>/posts/373ab937/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><div class="tag link"><a class="link-card" title="转载" href="https://www.jianshu.com/p/b69950a49ae2"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">转载</p><p class="url">https://www.jianshu.com/p/b69950a49ae2</p></div></a></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 图床 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PicGo </tag>
            
            <tag> Gitee </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HE 在人脸识别中的应用Demo 演示文档</title>
      <link href="/posts/6c15e2cc/"/>
      <url>/posts/6c15e2cc/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>HE 在人脸识别中的应用demo 演示文档</h1><p>@[toc]</p><h2 id="说明">说明</h2><div class="story post-story"><ol><li><code>使用的HE方案是</code><strong>CKKS</strong></li></ol><pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token operator">/</span><span class="token operator">|</span> Encryption parameters <span class="token operator">:</span><span class="token operator">|</span>   scheme<span class="token operator">:</span> CKKS<span class="token operator">|</span>   poly_modulus_degree<span class="token operator">:</span> <span class="token number">8192</span><span class="token operator">|</span>   coeff_modulus size<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">+</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token number">40</span> <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span> bits<span class="token operator">|</span>   scale<span class="token operator">:</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span>\</code></pre><ol start="2"><li>输入数据的长度 n = 10 ,</li><li>因为没有用FaceNet数据集的缘故,演示所用的测试数据来源为简单生成,<a href="#%E6%95%B0%E6%8D%AE%E6%9D%A5%E6%BA%90">生成方式为:</a></li><li>编译平台: Visual Studio 2019</li><li>所需外部环境: <code>seal.h</code>  ; <code> examples.h</code> ； <code>bits/stdc++.h</code></li><li>项目代码上传至: github: <a href="https://github.com/sizaif/SEALExamples/tree/main">https://github.com/sizaif/SEALExamples/tree/main</a></li></ol></div><h2 id="数据来源">数据来源</h2><div class="story post-story"><p>输入的input数据和database数据来源生成代码如下:</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// slot_count = poly_modulus_degree /2  => 4096 </span><span class="token keyword">double</span> curr_point <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">double</span> step_size <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>slot_count<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ofstream out<span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"database.txt"</span><span class="token punctuation">,</span> ios<span class="token double-colon punctuation">::</span>in <span class="token operator">|</span> ios<span class="token double-colon punctuation">::</span>out <span class="token operator">|</span> ios<span class="token double-colon punctuation">::</span>binary <span class="token operator">|</span> ios<span class="token double-colon punctuation">::</span>trunc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> step <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> slot_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 每10行一个数据</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>step <span class="token operator">%</span><span class="token number">10</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span>            out <span class="token operator">&lt;&lt;</span> curr_point <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            out <span class="token operator">&lt;&lt;</span> curr_point <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        step<span class="token operator">++</span><span class="token punctuation">;</span>        curr_point <span class="token operator">+=</span> step_size<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    out <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input vector: "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><strong>选取的input数据如下:</strong></p><p>[0.984127 0.984371 0.984615 0.98486 0.985104 0.985348 0.985592 0.985836 0.986081 0.986325]</p><p><code>从生成的database中最后10行中选取第6行生成</code></p><p><img src="https://img-blog.csdnimg.cn/img_convert/306a3ef9b0eb9fc250a42668b72cdca7.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/306a3ef9b0eb9fc250a42668b72cdca7.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203124141787"></p><hr><p><strong>选取的database E 数据如下:</strong></p><details green><summary> data </summary>              <div class='content'>              <p>[0.974359 0.974603 0.974847 0.975092 0.975336 0.97558 0.975824 0.976068 0.976313 0.976557]<br>[0.976801 0.977045 0.977289 0.977534 0.977778 0.978022 0.978266 0.97851 0.978755 0.978999]<br>[0.979243 0.979487 0.979731 0.979976 0.98022 0.980464 0.980708 0.980952 0.981197 0.981441]<br>[0.981685 0.981929 0.982173 0.982418 0.982662 0.982906 0.98315 0.983394 0.983639 0.983883]<br>[0.984127 0.984371 0.984615 0.98486 0.985104 0.985348 0.985592 0.985836 0.986081 0.986325]<br>[0.986569 0.986813 0.987057 0.987302 0.987546 0.98779 0.988034 0.988278 0.988523 0.988767]<br>[0.989011 0.989255 0.989499 0.989744 0.989988 0.990232 0.990476 0.99072 0.990965 0.991209]<br>[0.991453 0.991697 0.991941 0.992186 0.99243 0.992674 0.992918 0.993162 0.993407 0.993651]<br>[0.993895 0.994139 0.994383 0.994628 0.994872 0.995116 0.99536 0.995604 0.995849 0.996093]<br>[0.996337 0.996581 0.996825 0.99707 0.997314 0.997558 0.997802 0.998046 0.998291 0.998535]</p>              </div>            </details><hr><p><img src="https://img-blog.csdnimg.cn/img_convert/40e96468e1b70174d204a366dbae6687.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/40e96468e1b70174d204a366dbae6687.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203124350026"></p></div><h2 id="过程步骤">过程步骤</h2><div class="story post-story"><h3 id="总览">总览</h3><p><img src="https://img-blog.csdnimg.cn/img_convert/80fe9cdfad6a4374ef4e118e97792730.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/80fe9cdfad6a4374ef4e118e97792730.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203193037721"></p><ol><li><p>首先计算 p 与 E 中的 $C_{i}$ 比较分数并用 $r_{i}$表示,求最佳的 $r_{i}$,</p><p>$\mathbf{r}<em>{i}=\operatorname{dist}\left(\mathbf{p}, \mathbf{c}</em>{i}\right) \cdot \mathbf{k} ; k={1,0, \ldots 0}$​</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812101706.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812101706.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812101705064"></p></li><li><p>处理完全部数据库内容后,N个单独结果的</p><p>vector $\mathbf{R}=\left[\begin{array}{c}\mathbf{r}<em>{1} \ \mathbf{r}</em>{2} \ \vdots \ \mathbf{r}<em>{N}\end{array}\right]=\left[\begin{array}{c}\left(\mathbf{r}</em>{1,1}, 0, \ldots 0\right) \ \left(\mathbf{r}<em>{2,1}, 0, \ldots 0\right) \ \vdots \ \left(\mathbf{r}</em>{N, 1}, 0, \ldots 0\right)\end{array}\right]$​</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812101659.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812101659.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812101658056"></p><p>每个$r_{i}$​是单独加密的, 可以随机打乱$r_{i}$​的顺序</p></li><li><p>通过将$r_{i}$​移位,变成对角矩阵</p><p>例如 $\mathbf{R}=\left[\begin{array}{c}<br>\left(\mathbf{r}<em>{1,1}, 0, \ldots 0\right) \<br>\left(0, \mathbf{r}</em>{2,1}, \ldots 0\right) \<br>\vdots \<br>\left(0,0, \ldots \mathbf{r}_{N, 1}\right)<br>\end{array}\right]$​</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812101648.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812101648.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812101647010"></p></li><li><p>将对角线上vector组合成新的带有与P比较分数的vector格式</p><p>i.e.  $R-&gt;\left(\mathbf{r}<em>{1,1}, \mathbf{r}</em>{2,1}, \ldots \mathbf{r}_{N, 1}\right)$​</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812101716.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812101716.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812101715291"></p></li><li><p>将上式跟预先设定的阈值${t}=(t, t, \ldots t)$进行比较   形成新的vector d:  $d = R - t$, 然后将d 传输给第三方</p></li><li><p>最终将 d 进行解密决定结果(decision),并传送给客户</p><p>$d = R - t$​​  ;   $d=R-t ; \quad$​​ decision $= \begin{cases}\text { accept } &amp; \text { if } \exists d \in \mathbf{d}: d&gt;0 \ \text { reject } &amp; \text { if } \forall d \in \mathbf{d}: d \leq 0\end{cases}$</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812101725.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812101725.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812101724423"></p></li></ol><h3 id="一-将input和database中的数据分别加密获得encrypt-probe-p和-encrypt-E-matrix">一: 将input和database中的数据分别加密获得encrypt_probe_p和 encrypt_E_matrix</h3><p><strong>1：加密得到probe_p</strong></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">Ciphertext <span class="token function">get_encrypt_probe</span><span class="token punctuation">(</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span>Encryptor <span class="token operator">&amp;</span> encryptor<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span>v_input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_encrypt_probe() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 加密获得probe_p;    */</span>    Plaintext v_plaintext<span class="token punctuation">;</span>    <span class="token comment">// v编码</span>    ckks_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>v_input<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> v_plaintext<span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext probe_p<span class="token punctuation">;</span>    <span class="token comment">// 加密</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>v_plaintext<span class="token punctuation">,</span> probe_p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_encrypt_probe() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> probe_p<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p><img src="https://img-blog.csdnimg.cn/img_convert/a5e3ed2d7a94d1518bb634c25419cee2.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/a5e3ed2d7a94d1518bb634c25419cee2.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203124905421"></p><p>将加密的probe_p解密做验证:</p><p><img src="https://img-blog.csdnimg.cn/img_convert/1d831b1f13b80c3f08a75a0fc0419fdb.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/1d831b1f13b80c3f08a75a0fc0419fdb.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203130111249"></p><hr><p><strong>2：将database中的所有数据分别加密，组成矩阵E:</strong></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> <span class="token function">get_encrypt_E_matrix</span><span class="token punctuation">(</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span> Encryptor<span class="token operator">&amp;</span> encryptor<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">>></span>E_matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_encrypt_E_matrix() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_E_matrix<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> E_matrix<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> E_matrix<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Plaintext plain_E_ci<span class="token punctuation">;</span>        Ciphertext encrypt_E_ci<span class="token punctuation">;</span>        ckks_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain_E_ci<span class="token punctuation">)</span><span class="token punctuation">;</span>        encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain_E_ci<span class="token punctuation">,</span> encrypt_E_ci<span class="token punctuation">)</span><span class="token punctuation">;</span>        encrypt_E_matrix<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>encrypt_E_ci<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_encrypt_E_matrix() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> encrypt_E_matrix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p><img src="https://img-blog.csdnimg.cn/img_convert/904d6192f6298c75476819786f79bb0f.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/904d6192f6298c75476819786f79bb0f.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203124920149"></p><p><strong>将加密的databse数据做解密验证:</strong></p><p><code>输出前4行:</code></p><p><img src="https://img-blog.csdnimg.cn/img_convert/79fdf547a5f97dac1206b302d34ad491.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/79fdf547a5f97dac1206b302d34ad491.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203130122350"></p><hr><h3 id="二-计算-mathbf-r-i-operatorname-dist-left-mathbf-p-mathbf-c-i-right-cdot-mathbf-k">二: 计算   $\mathbf{r}<em>{i}=\operatorname{dist}\left(\mathbf{p}, \mathbf{c}</em>{i}\right) \cdot \mathbf{k}$</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812102015.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812102015.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812102013754"></p><p>分步骤:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812102035.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812102035.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812102034661"></p><p><strong>总代码调用:</strong></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> <span class="token function">get_dist</span><span class="token punctuation">(</span>SEALContext<span class="token operator">&amp;</span> context<span class="token punctuation">,</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span> Evaluator<span class="token operator">&amp;</span> evaluator<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_E_matrix<span class="token punctuation">,</span> Ciphertext probe_p<span class="token punctuation">,</span>Encryptor <span class="token operator">&amp;</span> encryptor <span class="token punctuation">,</span>Decryptor<span class="token operator">&amp;</span> decryptor<span class="token punctuation">,</span> RelinKeys<span class="token operator">&amp;</span> relin_keys<span class="token punctuation">,</span>  GaloisKeys<span class="token operator">&amp;</span> galois_keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_dist() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_R_matrix<span class="token punctuation">;</span>    <span class="token comment">/*    * get (Ci - Pi)^2    */</span>       cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sub &amp; square &amp;&amp; stored in encrypt_R_matrix: "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_R_matrix_cache <span class="token operator">=</span> <span class="token function">get_sub_square</span><span class="token punctuation">(</span>ckks_encoder<span class="token punctuation">,</span> evaluator<span class="token punctuation">,</span> decryptor<span class="token punctuation">,</span>encrypt_E_matrix<span class="token punctuation">,</span>probe_p<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    * get sum    */</span>    encrypt_R_matrix <span class="token operator">=</span> <span class="token function">get_sum_rotate</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>ckks_encoder<span class="token punctuation">,</span>evaluator<span class="token punctuation">,</span>encryptor<span class="token punctuation">,</span> decryptor<span class="token punctuation">,</span> encrypt_R_matrix_cache<span class="token punctuation">,</span>galois_keys<span class="token punctuation">,</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_dist() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> encrypt_R_matrix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h4 id="1：求-C-i-P-i-2">1：求 ${(C_{i} - P_{i})}^{2}$</h4><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> <span class="token function">get_sub_square</span><span class="token punctuation">(</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span>Evaluator <span class="token operator">&amp;</span> evaluator<span class="token punctuation">,</span>Decryptor <span class="token operator">&amp;</span> decryptor<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_E_matrix<span class="token punctuation">,</span> Ciphertext probe_p<span class="token punctuation">,</span>RelinKeys <span class="token operator">&amp;</span> relin_keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_sub_square() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_R_matrix<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> encrypt_E_matrix<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> encrypt_E_matrix<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Plaintext plain_sub_cache<span class="token punctuation">,</span> plain_mult_cache<span class="token punctuation">;</span>        Ciphertext encrypt_sub_cache<span class="token punctuation">,</span> encrypt_multiply_cache<span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span>result_sub_cache<span class="token punctuation">,</span> result_mult_cache<span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>probe_p<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">,</span> encrypt_sub_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypt_sub_cache<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>encrypt_sub_cache<span class="token punctuation">,</span> encrypt_multiply_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>                evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypt_multiply_cache<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">rescale_to_next_inplace</span><span class="token punctuation">(</span>encrypt_multiply_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>                 encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>encrypt_multiply_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_sub_square() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> encrypt_R_matrix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><strong>解码结果验证测试：</strong></p><p>​1. $(C_{i} - P_{i})$结果:</p><p><img src="https://img-blog.csdnimg.cn/img_convert/7ed439628708bdf609879799603a99b6.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/7ed439628708bdf609879799603a99b6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203132236684"></p><ol start="2"><li><p>${(C_{i} - P_{i})}^{2}$结果:</p><p><img src="https://img-blog.csdnimg.cn/img_convert/80cbecf334c48ea480b6a2258e6158d6.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/80cbecf334c48ea480b6a2258e6158d6.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203133516381"></p></li></ol><hr><h4 id="2-sum-i-0-s-left-mathbf-c-i-mathbf-p-i-right-2">2:   $\sum_{i=0}<sup>{s}\left(\mathbf{c}_{i}-\mathbf{p}_{i}\right)</sup>{2}$</h4><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812102108.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812102108.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812102107289"></p><p><code>循环遍历encrypt_R_matrix， 将密文每次移位step步后加到encrypt_sum_cache上得到最终的结果，</code></p><p><code>step从0到number-1</code></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> <span class="token function">get_sum_rotate</span><span class="token punctuation">(</span>SEALContext <span class="token operator">&amp;</span>context<span class="token punctuation">,</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span> Evaluator<span class="token operator">&amp;</span> evaluator<span class="token punctuation">,</span>Encryptor <span class="token operator">&amp;</span>encryptor <span class="token punctuation">,</span>Decryptor<span class="token operator">&amp;</span> decryptor<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span>encrypt_R_matrix<span class="token punctuation">,</span>GaloisKeys <span class="token operator">&amp;</span> galois_keys<span class="token punctuation">,</span>RelinKeys <span class="token operator">&amp;</span> relin_keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_sum_rotate() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_RR_matrix<span class="token punctuation">;</span>    <span class="token comment">/*    * get encryptor of vector K&#123;1,0,0,....0&#125;    * begin    */</span>    size_t slot_count <span class="token operator">=</span> ckks_encoder<span class="token punctuation">.</span><span class="token function">slot_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span><span class="token function">vector_k</span><span class="token punctuation">(</span>slot_count<span class="token punctuation">,</span> <span class="token number">0ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    vector_k<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1ULL</span><span class="token punctuation">;</span>    <span class="token comment">//print_vector(vector_k, 3, 13);</span>    Plaintext plain_vector_k<span class="token punctuation">;</span>    Ciphertext encrypt_vector_k<span class="token punctuation">;</span>    ckks_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>vector_k<span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plain_vector_k<span class="token punctuation">)</span><span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain_vector_k<span class="token punctuation">,</span> encrypt_vector_k<span class="token punctuation">)</span><span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_next_inplace</span><span class="token punctuation">(</span>encrypt_vector_k<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//end</span>    <span class="token comment">/*    *  Calculate begin    */</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Plaintext plain_rotated_cache<span class="token punctuation">,</span> plain_sum_cache<span class="token punctuation">;</span>        Ciphertext encrypt_rotated_cache<span class="token punctuation">,</span> encrypt_sum_cache<span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span>result_rotated_cache<span class="token punctuation">,</span> result_sum_cache<span class="token punctuation">;</span>        encrypt_sum_cache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/*        * rotated &amp; add to get sum of them        */</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number_n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            evaluator<span class="token punctuation">.</span><span class="token function">rotate_vector</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">,</span> encrypt_rotated_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>            encrypt_sum_cache <span class="token operator">=</span> encrypt_rotated_cache<span class="token punctuation">;</span>            evaluator<span class="token punctuation">.</span><span class="token function">add_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>            evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        evaluator<span class="token punctuation">.</span><span class="token function">multiply_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">,</span> encrypt_vector_k<span class="token punctuation">)</span><span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">rescale_to_next_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>        encrypt_RR_matrix<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/*    *  Calculate end;    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_sum_rotate() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> encrypt_RR_matrix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><strong>解码结果验证测试(部分截取):</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/359941312c960414e49adc41b215b76b.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/359941312c960414e49adc41b215b76b.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203140928407"></p><hr><h4 id="3-求-operatorname-dist-left-mathbf-p-mathbf-c-i-right-cdot-mathbf-k">3: 求 $\operatorname{dist}\left(\mathbf{p}, \mathbf{c}_{i}\right) \cdot \mathbf{k}$</h4><p><strong>代码内嵌在第二步求 2:   $\sum_{i=0}<sup>{s}\left(\mathbf{c}_{i}-\mathbf{p}_{i}\right)</sup>{2}$​中</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812102210.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812102210.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812102208665"></p><pre class="language-cpp" data-language="cpp"><code class="language-cpp">evaluator<span class="token punctuation">.</span><span class="token function">multiply_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">,</span> encrypt_vector_k<span class="token punctuation">)</span><span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rescale_to_next_inplace</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>encrypt_RR_matrix<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>encrypt_sum_cache<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>解码结果验证:</p><img src="https://gitee.com/sizaif/images/raw/master/img/20210203140007.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210203140007.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203140007458"  /><hr><h3 id="三-将得到-R-进行移位叠加操作">三: 将得到 R 进行移位叠加操作:</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812102121.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812102121.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812102120353"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp">vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> <span class="token function">get_shifting_ri</span><span class="token punctuation">(</span>SEALContext<span class="token operator">&amp;</span> context<span class="token punctuation">,</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span>Evaluator<span class="token operator">&amp;</span> evaluator<span class="token punctuation">,</span>vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_R_matrix<span class="token punctuation">,</span> GaloisKeys<span class="token operator">&amp;</span> galois_keys<span class="token punctuation">,</span> Decryptor<span class="token operator">&amp;</span> decryptor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_shifting_ri() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_RR_matrix<span class="token punctuation">;</span>    Plaintext plain_shift_cache<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span>result_shift_cache<span class="token punctuation">;</span>        <span class="token keyword">int</span> step <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        Ciphertext after_shift<span class="token punctuation">;</span>        <span class="token comment">// 右移</span>        evaluator<span class="token punctuation">.</span><span class="token function">rotate_vector</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">,</span>step<span class="token punctuation">,</span> galois_keys<span class="token punctuation">,</span>after_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>        step<span class="token operator">--</span><span class="token punctuation">;</span>        encrypt_RR_matrix<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>after_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_shifting_ri() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> encrypt_RR_matrix<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><strong>解码结果验证测试；</strong></p><p><code>输出前10列前10行， 保留13位小数</code></p><img src="https://gitee.com/sizaif/images/raw/master/img/20210203162006.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210203162006.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203162006063" style="zoom:200%;" /><hr><h3 id="四-将得到-R-left-mathbf-r-1-1-mathbf-r-2-1-ldots-mathbf-r-N-1-right">四: 将得到 $R-&gt;\left(\mathbf{r}<em>{1,1}, \mathbf{r}</em>{2,1}, \ldots \mathbf{r}_{N, 1}\right)$:</h3><p>通过移位操作得到对角矩阵后，将所有的$C_{i}$​ 累加起来得到$R-&gt;\left(\mathbf{r}<em>{1,1}, \mathbf{r}</em>{2,1}, \ldots \mathbf{r}_{N, 1}\right)$:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812102140.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812102140.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812102139359"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp">Ciphertext <span class="token function">get_combined_R</span><span class="token punctuation">(</span>SEALContext<span class="token operator">&amp;</span> context<span class="token punctuation">,</span>CKKSEncoder<span class="token operator">&amp;</span> ckks_encoder<span class="token punctuation">,</span>Evaluator<span class="token operator">&amp;</span> evaluator<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>Ciphertext<span class="token operator">></span> encrypt_R_matrix<span class="token punctuation">,</span> Encryptor<span class="token operator">&amp;</span> encryptor<span class="token punctuation">,</span> Decryptor<span class="token operator">&amp;</span> decryptor<span class="token punctuation">,</span> RelinKeys<span class="token operator">&amp;</span> relin_keys<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_combined_R() begin------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        Ciphertext encrypt_R_sum_cache<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" combined together: "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">int</span> step <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> encrypt_R_matrix<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>step <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            encrypt_R_sum_cache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>            step<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            parms_id_type last_parms_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            evaluator<span class="token punctuation">.</span><span class="token function">add_inplace</span><span class="token punctuation">(</span>encrypt_R_sum_cache<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypt_R_sum_cache<span class="token punctuation">,</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>            step<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"------get_combined_R() end------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> encrypt_R_sum_cache<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><strong>解密结果测试:</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/eb2e7a41898c866db7ebd12df2fae661.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/eb2e7a41898c866db7ebd12df2fae661.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203183212079"></p><hr><h3 id="最终结果展示">最终结果展示</h3><p>==注意！==</p><p><code>(因为没有用FaceNet缘故,这里给定的阈值 t 不得知，故程序只运行到将R做完对角化后并加在一起变成一个</code></p><p>$R-&gt;(r1,1, r2,1, . . . rN,1).$形式</p><p><code>若给定的设定的t已知; 则只需要做如下操作判定结果:</code></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// d = R - t</span>Ciphertext encrypt_T<span class="token punctuation">,</span>encrypt_d<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>mapping_R<span class="token punctuation">,</span>encrypt_T<span class="token punctuation">,</span>encrypt_d<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// *d = Dec(d)</span>Plaintext plain_dd_cache<span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span>result_dd_cache<span class="token punctuation">;</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypt_d<span class="token punctuation">,</span> plain_dd_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>ckks_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_dd_cache<span class="token punctuation">,</span> result_dd_cache<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// judge ∃d ∈ d∗: d > 0 ? accept : reject</span><span class="token keyword">bool</span> ok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">auto</span> len <span class="token operator">=</span> result_dd_cache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>result_dd_cache<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        ok <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>string ans <span class="token operator">=</span> ok <span class="token operator">?</span> <span class="token string">"accept"</span> <span class="token operator">:</span> <span class="token string">"reject"</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> ans <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">//输出最后结果</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/img_convert/eb2e7a41898c866db7ebd12df2fae661.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/eb2e7a41898c866db7ebd12df2fae661.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210203183215036"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis  XXX.ReflectionException_ There Is No Getter for Name XXX问题</title>
      <link href="/posts/12adf317/"/>
      <url>/posts/12adf317/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><blockquote><p>@auther by sizaif</p></blockquote><h1>解决方法</h1><p><strong>首先,这个肯定是因为数据库表中的字段名,和实体类中的字段名映射失败引起的;</strong></p><h2 id="1-查看-resultMap-是否拼写错误">1: 查看 <resultMap> 是否拼写错误</h2><div class="story post-story"><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--映射表--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UsersMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sizaif.emsdemo.pojo.User.Users<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--column数据库中的字段，property实体类中的属性--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createDate<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createDate<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modifyDate<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>modifyDate<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isLocked<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isLocked<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>INTEGER<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lastLoginDate<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lastLoginDate<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lastLoginIp<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lastLoginIp<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lockDate<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lockDate<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>uname<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>encodePassword<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>role<span class="token punctuation">"</span></span> <span class="token attr-name">jdbcType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>VARCHAR<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span></code></pre></div><h2 id="2-查看-sql动态插入或更新语句中字段是否拼写错误与实体类中字段不符">2: 查看 sql动态插入或更新语句中字段是否拼写错误与实体类中字段不符**</h2><div class="story post-story"><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>XXX实体类字段名 != null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>XXX数据库字段名,<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Layui Tree 获取复选框选中节点的Id</title>
      <link href="/posts/b7de2574/"/>
      <url>/posts/b7de2574/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><blockquote><p>@auther by sizaif</p></blockquote><h1>说明</h1><p>官方文档提供的代码只能获取到根节点的id,没有进行树遍历,无法获取到子树的id.</p><h1>Code</h1><p>官方文档提供的</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript">tree<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  elem<span class="token operator">:</span> <span class="token string">'#test'</span>  <span class="token punctuation">,</span>data<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">//数据源</span>  <span class="token punctuation">,</span>id<span class="token operator">:</span> <span class="token string">'demoId'</span> <span class="token comment">//定义索引</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获得选中的节点</span><span class="token keyword">var</span> checkData <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">getChecked</span><span class="token punctuation">(</span><span class="token string">'demoId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我的代码</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> treecheckdata  <span class="token operator">=</span> tree<span class="token punctuation">.</span><span class="token function">getChecked</span><span class="token punctuation">(</span><span class="token string">'demoId'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> nodeIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>nodeIds <span class="token operator">=</span> <span class="token function">getCheckedId</span><span class="token punctuation">(</span>treecheckdata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 测试</span><span class="token keyword">var</span> permList <span class="token operator">=</span> nodeIds<span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"permList:"</span><span class="token operator">+</span>permList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 获取选中节点的id</span><span class="token keyword">function</span> <span class="token function">getCheckedId</span><span class="token punctuation">(</span><span class="token parameter">jsonObj</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>    $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            id <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>id<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            id <span class="token operator">=</span> item<span class="token punctuation">.</span>id<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token function">getCheckedId</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            id <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><h1>效果图</h1><p><img src="https://img-blog.csdnimg.cn/20200411154638307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200411154638307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200411154705177.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200411154705177.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Js </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Js </tag>
            
            <tag> Layui </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Layui Table 解决从后台传入数据为二维数组模式,即带有子类的数据格式</title>
      <link href="/posts/2b51004/"/>
      <url>/posts/2b51004/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><blockquote><p>@auther by sizaif</p></blockquote><h1>后台传入的格式</h1><p><img src="https://img-blog.csdnimg.cn/20200504124156316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200504124156316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><h1>前台处理</h1><details green><summary> code </summary>              <div class='content'>              <pre class="language-js" data-language="js"><code class="language-js"><span class="token punctuation">,</span>response<span class="token operator">:</span><span class="token punctuation">&#123;</span>                statusName<span class="token operator">:</span> <span class="token string">'code'</span> <span class="token comment">//数据状态的字段名称，默认：code</span>                <span class="token punctuation">,</span>statusCode<span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">//成功的状态码，默认：0</span>                <span class="token punctuation">,</span>countName<span class="token operator">:</span> <span class="token string">'totals'</span> <span class="token comment">//数据总数的字段名称，默认：count</span>                <span class="token punctuation">,</span>dataName<span class="token operator">:</span> <span class="token string">'list'</span> <span class="token comment">//数据列表的字段名称，默认：data</span>            <span class="token punctuation">&#125;</span>            <span class="token punctuation">,</span><span class="token function-variable function">parseData</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">//res 即为原始返回的数据</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>                    <span class="token string">"code"</span><span class="token operator">:</span>res<span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token comment">//解析接口状态</span>                    <span class="token string">"msg"</span><span class="token operator">:</span> res<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token comment">//解析提示文本</span>                    <span class="token string">"totals"</span><span class="token operator">:</span> res<span class="token punctuation">.</span>totals<span class="token punctuation">,</span> <span class="token comment">//解析数据长度</span>                    <span class="token string">"list"</span><span class="token operator">:</span> res<span class="token punctuation">.</span>list <span class="token comment">//解析数据列表</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token punctuation">,</span>cols<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token comment">//表头</span>                <span class="token punctuation">&#123;</span>field<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'上次登录IP'</span><span class="token punctuation">,</span>sort<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token function-variable function">templet</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> d<span class="token punctuation">.</span>users<span class="token punctuation">.</span>lastLoginIp<span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>                <span class="token punctuation">,</span><span class="token punctuation">&#123;</span>field<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> title<span class="token operator">:</span> <span class="token string">'角色'</span><span class="token punctuation">,</span>sort<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token function-variable function">templet</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> d<span class="token punctuation">.</span>users<span class="token punctuation">.</span>role<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre>              </div>            </details><h1>效果</h1><p><img src="https://img-blog.csdnimg.cn/20200504124419953.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200504124419953.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Js </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Js </tag>
            
            <tag> Layui </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis 单表自关联 实现树结构的几种方式</title>
      <link href="/posts/843fdcdc/"/>
      <url>/posts/843fdcdc/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h1>结构</h1><h2 id="Bean">Bean</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@JsonIdentityInfo</span><span class="token punctuation">(</span> generator <span class="token operator">=</span> <span class="token class-name">ObjectIdGenerators<span class="token punctuation">.</span>IntSequenceGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PermissionVO</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">&#123;</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2783081162690878303L</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> pid<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Integer</span> istype<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> code<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">String</span> page<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> checked<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token keyword">open</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> children<span class="token punctuation">;</span></code></pre>              </div>            </details><h1>法一:使用mybatis映射实现</h1></div><h2 id="mabatis-xml配置">mabatis.xml配置</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--=Start findPerms 查找权限树列表 结果集映射--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPermissionMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sizaif.emsdemo.dto.PermissionVO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pid<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pid<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>istype<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>istype<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>collection</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>children<span class="token punctuation">"</span></span>  <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">ofType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sizaif.emsdemo.dto.PermissionVO<span class="token punctuation">"</span></span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findChildPerm<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--=End findPerms 查找权限树列表--></span>    <span class="token comment">&lt;!-- pID 对应 PermissionVO 中 pID--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sql</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PermColumn<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>        id, name,pid,istype, code,page    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sql</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--=Start findPerms 查找权限树列表--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPerms<span class="token punctuation">"</span></span>  <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPermissionMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        SELECT          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PermColumn<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        FROM          permission        WHERE          pid = 0 OR  pid is NULL    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--=End findPerms 查找权限树列表--></span>    <span class="token comment">&lt;!--=Start findChildPerm 查找所有子节点权限--></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findChildPerm<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findPermissionMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        select        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>PermColumn<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        from permission        where pid = #&#123;pid&#125;    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>    <span class="token comment">&lt;!--=End findChildPerm 查找所有子节点权限--></span></code></pre>              </div>            </details></div><h2 id="service层调用">service层调用</h2><div class="story post-story"><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> <span class="token function">findPerms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> permissionsMapper<span class="token punctuation">.</span><span class="token function">findPerms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></div><h2 id="controller">controller</h2><div class="story post-story"><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> pvos <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">findPerms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1>法二:通过递归实现</h1></div><h2 id="mybatis-xml配置">mybatis.xml配置</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sizaif.emsdemo.dto.PermissionVO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pid<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pid<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>istype<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>istype<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getChildren<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select id, pid, name, istype, code,page    from permission where pid = #&#123;id&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></code></pre>              </div>            </details></div><h2 id="service">service</h2><div class="story post-story"><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> <span class="token function">getChildPerms</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> permissionsMapper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></div><h2 id="controller-2">controller</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">PermissionVO</span> <span class="token function">initPermission1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">PermissionVO</span> permissionvo<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PermissionVO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>        permissionvo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这个地方应该通过数据库查询出根节点，因为根节点id在数据库是0，</span>        <span class="token function">queryChildPermissions</span><span class="token punctuation">(</span>permissionvo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//递归得到全部节点</span>    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span>  e<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> permissionvo<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">private</span> <span class="token keyword">void</span> queryChildPermissions <span class="token punctuation">(</span><span class="token class-name">PermissionVO</span> permissionvo<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> children<span class="token operator">=</span>  authService<span class="token punctuation">.</span><span class="token function">getChildPerms</span><span class="token punctuation">(</span>permissionvo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过id查询子集合</span>    permissionvo<span class="token punctuation">.</span><span class="token function">setChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将查询出来的子节点集合放入到permissionvo集合中</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">PermissionVO</span> innerChildren<span class="token operator">:</span>children<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">//遍历出子集合的子集合</span>        <span class="token function">queryChildPermissions</span><span class="token punctuation">(</span>innerChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//放入到子节点的子集合中</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h1>法三: 一次查出全部记录，通过嵌套循环遍历结果</h1></div><h2 id="xml">xml</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resultMap</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sizaif.emsdemo.dto.PermissionVO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>id<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pid<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pid<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>istype<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>istype<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>code<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>result</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span> <span class="token attr-name">column</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resultMap</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>selectAll<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    select id, pid, name, istype,code,page    from permission<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></code></pre>              </div>            </details></div><h2 id="service-2">service:</h2><div class="story post-story"><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> <span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> permissionsMapper<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></div><h2 id="controller-3">controller:</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">PermissionVO</span> <span class="token function">initPermissionVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">PermissionVO</span> permissionvo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionVO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> lists<span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查询所有节点</span>    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">PermissionVO</span> ps<span class="token operator">:</span>lists<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//遍历节点</span>            <span class="token class-name">PermissionVO</span> child <span class="token operator">=</span> ps<span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> ps<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> ps<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//获取根节点,Integer类型是包装类，判断对象引用</span>                permissionvo <span class="token operator">=</span> ps<span class="token punctuation">;</span><span class="token comment">//根节点</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PermissionVO</span> innerpermissionvo<span class="token operator">:</span>lists<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> innerpermissionvo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//如果节点的的pid和集合中某个节点的id一致</span>                        <span class="token class-name">PermissionVO</span> parent<span class="token operator">=</span>innerpermissionvo<span class="token punctuation">;</span><span class="token comment">//将这个节点命名为父节点</span>                        parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//然后把child放入到它的父亲集合中</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">throw</span>  e<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> permissionvo<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h1>法四:一次查出所有数据,通过Map集合实现树结构</h1></div><h2 id="xml-与service-与法三一致">xml 与service 与法三一致,</h2><div class="story post-story"></div><h2 id="controller-4">controller:</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">PermissionVO</span> <span class="token function">initPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token class-name">PermissionVO</span> permissionvo<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">PermissionVO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> lists <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查询所有节点</span>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">PermissionVO</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将所有节点存入到map集合</span>    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">PermissionVO</span> ps<span class="token operator">:</span>lists<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将所有id做为key，Permissionvo对象做值，存入到map集合</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">PermissionVO</span> ps<span class="token operator">:</span>lists<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//遍历所有节点</span>            <span class="token class-name">PermissionVO</span> child <span class="token operator">=</span> ps<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">||</span>child<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                permissionvo <span class="token operator">=</span> ps<span class="token punctuation">;</span><span class="token comment">//取出根节点</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                <span class="token class-name">PermissionVO</span> parent <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过子节点的pid获取父节点</span>                parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将子节点放入父节点中</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> permissionvo<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><strong>四种方式查出来的结果是一样的,但效率方面法四最快</strong></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Mybatis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux安装java1.8 Jdk并配置环境变量</title>
      <link href="/posts/f03f62f2/"/>
      <url>/posts/f03f62f2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h1>下载jdk</h1><p>百度网盘链接:<a href="https://pan.baidu.com/s/1o0LlfAInZug4apeL3lCyYw">提取码: krfa</a></p><h1>使用fileZilla将jdk传输到linux上</h1><p><img src="https://img-blog.csdnimg.cn/20200513211713523.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200513211713523.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><h1>安装</h1><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">rpm</span> -ivh jdk-8u251-linux-x64.rpm</code></pre><h1>配置环境变量</h1><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> /etc/profile</code></pre><p><img src="https://img-blog.csdnimg.cn/20200513212331756.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200513212331756.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_251-amd64<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span></code></pre><h1>更新环境变量</h1><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">source</span> /etc/profile</code></pre><h1>验证:</h1><pre class="language-shell" data-language="shell"><code class="language-shell">java -version </code></pre><p><img src="https://img-blog.csdnimg.cn/2020051321255422.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/2020051321255422.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Java </category>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Jdk </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Docker部署SpringBoot项目全流程记录,超详细!</title>
      <link href="/posts/dfba8e73/"/>
      <url>/posts/dfba8e73/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h1>引言</h1><p>我的linux环境为:<br>centos:7<br>服务器在国外,所以有一些操作像阿里云的端口安全组设置就不需要操作</p><h1>需要的软件</h1><ol><li>xshell(用来连接linux服务器)</li><li>xftp或fileZilla用来给linux服务器上传文件</li><li>sqlyog(或者navicat)在服务器上解析.sql脚本</li><li>maven(idea自带) 用来打包</li></ol><h1>安装Docker</h1><h2 id="官网对系统的要求">官网对系统的要求</h2><div class="story post-story"><blockquote><p>OS requirements<br>To install Docker Engine, you need a maintained version of CentOS 7. Archived versions aren’t supported or tested.<br>The centos-extras repository must be enabled. This repository is enabled by default, but if you have disabled it, you need to re-enable it.<br>The overlay2 storage driver is recommended.</p></blockquote><p><strong>要求版本Centos7, 其版本不支持或未测试</strong><br>经过我测试,的确在安装时会遇到依赖的错误所以干脆将Centos6 换成Centos7</p></div><h2 id="安装和设置仓库">安装和设置仓库</h2><div class="story post-story"><blockquote><p>官方教程</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils<span class="token function">sudo</span> yum-config-manager <span class="token punctuation">\</span>   --add-repo <span class="token punctuation">\</span>   https://download.docker.com/linux/centos/docker-ce.repo</code></pre><blockquote><p>这个仓库是官方的,如果太慢的换,换成阿里云镜像:<br><strong>需要配置文件</strong><br><strong>可以自行百度</strong></p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> yum-config-manager <span class="token punctuation">\</span>    --add-repo <span class="token punctuation">\</span>    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre><blockquote><p>安装最新版的docker</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io</code></pre><blockquote><p>若要安装特定版本</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">$ yum list docker-ce --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -rdocker-ce.x86_64  <span class="token number">3</span>:18.09.1-3.el7                     docker-ce-stabledocker-ce.x86_64  <span class="token number">3</span>:18.09.0-3.el7                     docker-ce-stabledocker-ce.x86_64  <span class="token number">18.06</span>.1.ce-3.el7                    docker-ce-stabledocker-ce.x86_64  <span class="token number">18.06</span>.0.ce-3.el7                    docker-ce-stable</code></pre><blockquote><p>例如要按照 docker-ce.x86_64 18.06.1.ce-3.el7<br>&lt;VERSION_STRING&gt; docker-ce-18.06.1</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> yum <span class="token function">install</span> docker-ce-<span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">></span> docker-ce-cli-<span class="token operator">&lt;</span>VERSION_STRING<span class="token operator">></span> containerd.io</code></pre><blockquote><p>开启docker</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> systemctl start docker</code></pre><p>跑一个docker版的helloworld，类似于java的hello，测试是否安装成功</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> docker run hello-world</code></pre><p><img src="https://img-blog.csdnimg.cn/20200430183106810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430183106810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="成功样式"></p><h1>安装mysql</h1><blockquote><p>从docker hub上查找mysql镜像</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">docker search mysql</code></pre><blockquote><p>从docker hub上拉取mysql,我拉取的mysql版本是mysql5.7</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">docker pull mysql:5.7</code></pre><blockquote><p>docker volume create mysql_data 创建数据挂载点（即存储数据的地方，这样即便mysql容器删除了，数据还是在）</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">docker volume create mysql_data </code></pre><blockquote><p>运行mysql，开放的端口是3306，密码是root， -d是后台运行</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">docker run --name mysql -p <span class="token number">3306</span>:3306 -v mysql_data:/var/lib/mysql -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>root -d mysql:5.7</code></pre><p>docker ps 查看容器创建成功</p><p><img src="https://img-blog.csdnimg.cn/20200430183359426.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430183359426.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br>进入mysql 的容器内</p><pre class="language-shell" data-language="shell"><code class="language-shell">docker <span class="token builtin class-name">exec</span> -it 容器的id /bin/bash</code></pre><p>进入mysql,<br><img src="https://img-blog.csdnimg.cn/20200430183600916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430183600916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br>当可以进入时,说明mysql 没问题了,</p><blockquote><p>通过docker restart 镜像名  可以重启镜像</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">docker restart mysql</code></pre></div><h2 id="使用navicat-远程连接数据库">使用navicat 远程连接数据库</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200430183906822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430183906822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><blockquote><p>运行本地的.sql 文件, 将远程数据库中增加数据</p></blockquote><h1>将springboot项目打成jar包</h1><p><strong>注意将applicayion.yml中密码改成你服务器上mysql的密码</strong></p><p><img src="https://img-blog.csdnimg.cn/20200430184453660.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430184453660.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200430184148260.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430184148260.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><blockquote><p><strong>打包后在target下会生成一个jar包</strong></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200430184311308.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430184311308.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="编写Dockfile文件">编写Dockfile文件</h2><div class="story post-story"><blockquote><p><strong>在 /home 目录下创建docker文件夹</strong></p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">mkdir</span> /home/docker </code></pre><p><strong>使用xftp上传jar包</strong><br><img src="https://img-blog.csdnimg.cn/20200430184620884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430184620884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><blockquote><p><strong>编写Dockerfile文件</strong><br><img src="https://img-blog.csdnimg.cn/20200430192744182.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430192744182.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> Dockerfile</code></pre><blockquote><p>完整命令, vim的使用方法：点击i开始编写，编写完后点击esc，点击冒号，输入wq保存<br><img src="https://img-blog.csdnimg.cn/20200430192653896.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430192653896.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">FROM java:8ADD emsdemo-0.0.2-SNAPSHOT.jar /emsdemo.jarEXPOSE 8081ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>,<span class="token string">"-jar"</span>,<span class="token string">"/emsdemo.jar"</span><span class="token punctuation">]</span></code></pre><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#注意，docker命令全部大写，这是规定。</span><span class="token comment">#   From 关键字表示，jar包依赖的环境。java:8  相当于jdk1.8</span>FROM java:8 <span class="token comment">#ADD命令 </span><span class="token comment">#   emsdemo-0.0.2-SNAPSHOT.jar：这是你上传jar包的名称。</span><span class="token comment">#   /emsdemo.jar：这是自定义的名称。但是注意要有之前的/</span>ADD emsdemo-0.0.2-SNAPSHOT.jar /emsdemo.jar <span class="token comment">#MAINTAINER  作者名称。可以删除不写。</span>MAINTAINER Sizaif <span class="token comment">#EXPOSE 项目暴露的端口号</span>EXPOSE <span class="token number">8080</span> <span class="token comment">#/blog.jar此处的名称要和ADD命令后面的一样。</span>ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>,<span class="token string">"-jar"</span>,<span class="token string">"/emsdemo.jar"</span><span class="token punctuation">]</span></code></pre><p><strong>在docker文件夹下执行如下命令</strong></p><pre class="language-shell" data-language="shell"><code class="language-shell">docker build -t emsdemo:1.0 <span class="token builtin class-name">.</span></code></pre><p><img src="https://img-blog.csdnimg.cn/20200430192801282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430192801282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><h1>运行镜像</h1><pre class="language-shell" data-language="shell"><code class="language-shell">docker run -it --net<span class="token operator">=</span>host --name emsdemo -d -p <span class="token number">80</span>:8081 emsdemo:1.0</code></pre><p><img src="https://img-blog.csdnimg.cn/20200430193058999.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200430193058999.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p>至此全部完成.<br>在浏览器访问就可以了</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Springboot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在windows上安装Microsoft SEAL</title>
      <link href="/posts/6b27b8ff/"/>
      <url>/posts/6b27b8ff/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>在windows上安装Microsoft SEAL</h1><blockquote><p>Note！说明</p><p>安装的版本为3.6</p></blockquote><h2 id="需要环境">需要环境</h2><div class="story post-story"><p>Visual Studio 2019 with C++ CMake Tools for Windows</p></div><h2 id="1-git-项目文件">1. git 项目文件</h2><div class="story post-story"><pre class="language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;microsoft&#x2F;SEAL.git</code></pre></div><h2 id="2-以管理员打开VS2019打开SEAL文件夹">2. 以管理员打开VS2019打开SEAL文件夹</h2><div class="story post-story"><img src="https://gitee.com/sizaif/images/raw/master/img/20210122214210.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210122214210.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210122214210031" style="zoom:80%;" /><p>打开后，VS会自动运行cmake配置</p><blockquote><p>Visual Studio will detect that this is a CMake-based project and will enable the menu command <code>Project / CMake settings for SEAL</code>. This will open the CMake settings editor that provides a user interface where you can create different configurations and set different CMake options.</p></blockquote></div><h2 id="3-VS里打开终端powershell">3. VS里打开终端powershell</h2><div class="story post-story"><img src="https://gitee.com/sizaif/images/raw/master/img/20210122214602.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210122214602.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210122214602674" style="zoom: 67%;" /><blockquote><p>因为VS2019是以管理员打开的，所以打开的终端也是带有管理员权限的</p></blockquote></div><h2 id="4-在终端中依次输入">4. 在终端中依次输入</h2><div class="story post-story"><pre class="language-powershell" data-language="powershell"><code class="language-powershell">cmake <span class="token operator">-</span>S <span class="token punctuation">.</span> <span class="token operator">-</span>B buildcmake <span class="token operator">--</span>build buildcmake <span class="token operator">--</span>install build</code></pre><p>或者采用<br>#Generate and build for x64 in Release mode</p><pre class="language-PowerShell" data-language="PowerShell"><code class="language-PowerShell">cmake -S . -B build -G &quot;Visual  Studio 16 2019&quot; -A x64cmake --build build --config Releasecmake --install build</code></pre><p>如果成功，则默认安装的C:/Program Files(x86)/SEAL/目录下</p><img src="https://gitee.com/sizaif/images/raw/master/img/20210122214935.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210122214935.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210122214935322" style="zoom:80%;" /></div><h2 id="或者直接打开-x64-Native-Tools">或者直接打开 x64 Native Tools</h2><div class="story post-story"><p>进入到你的从github上下载的SEAL文件夹位置<br><img src="https://img-blog.csdnimg.cn/20210123001330833.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20210123001330833.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br>依次输入以下命令</p><pre class="language-none"><code class="language-none">cmake -S . -B build -G Ninjacmake --build buildcmake --install build</code></pre><p>如果不出问题出现下面图片,则安装完成<br><img src="https://img-blog.csdnimg.cn/20210123001607611.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20210123001607611.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
            <tag> Win </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>线性表(链表)题目算法题目整理(附代码)</title>
      <link href="/posts/41ebddd6/"/>
      <url>/posts/41ebddd6/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><blockquote><p>说明：<br>部分题目为王道题目整理，(ps.王道上思路没问题，在实现代码上略有些问题)<br>因个人代码风格与王道略有不同，部分细节代码也不尽相同<br>个人整理by sizaif</p></blockquote><p>@<a href="%E9%93%BE%E8%A1%A8%E9%A2%98%E7%9B%AE%E7%AE%97%E6%B3%95%E6%95%B4%E7%90%86">TOC</a></p><h1>链表：</h1><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//单链表结构</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">link</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> data<span class="token punctuation">;</span>    link <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>node<span class="token punctuation">,</span><span class="token operator">*</span>linklist<span class="token punctuation">;</span></code></pre><h2 id="1-输入一组整型元素序列，使用尾插法-头插法-建立一个带有头结点-不带头结点-的单链表。">1)   <strong>输入一组整型元素序列，使用尾插法(头插法)建立一个带有头结点(不带头结点)的单链表</strong>。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/** * 建立带头结点的单链表 * @param L [description] */</span><span class="token keyword">void</span> <span class="token function">Creat_list_Head</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    L <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    linklist p<span class="token punctuation">,</span>s<span class="token operator">=</span>L<span class="token punctuation">;</span>    L<span class="token operator">-></span>next<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> x<span class="token punctuation">;</span>    <span class="token comment">/*while(cin>>x,x>0)// 头插    &#123;        p= new node();        p->data =x;        p->next=L->next;        L->next=p;    &#125;*/</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>cin<span class="token operator">>></span>x<span class="token punctuation">,</span>x<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//尾插</span>    <span class="token punctuation">&#123;</span>        p<span class="token operator">=</span>new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">-></span>data<span class="token operator">=</span>x<span class="token punctuation">;</span>        s<span class="token operator">-></span>next<span class="token operator">=</span>p<span class="token punctuation">;</span>        s<span class="token operator">=</span>p<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">Creat_list_withoutHead</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    L <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    linklist p<span class="token punctuation">,</span>s<span class="token punctuation">;</span>    <span class="token keyword">int</span> x<span class="token punctuation">;</span>    <span class="token comment">/*    while(cin>>x,x>0)// 头插    &#123;        p= new node();        p->data =x;        p->next=L;          L=p;     &#125;    */</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>cin<span class="token operator">>></span>x<span class="token punctuation">,</span>x<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 尾插</span>        p <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">-></span>data <span class="token operator">=</span> x<span class="token punctuation">;</span>        p<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>L<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> L <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 第一个结点</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            s <span class="token operator">=</span> L<span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>s<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 遍历到最后一个结点</span>                s <span class="token operator">=</span> s<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            s<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="2-在该单链表的第i个元素前插入一个整数。-从0开始"><strong>2)   在该单链表的第i个元素前插入一个整数。(从0开始)</strong></h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 在 单链表 第x个位置 前插入y * @param  L [description] * @param  x [description] * @param  y [description] * @return   [description] */</span><span class="token keyword">void</span> <span class="token function">Add_before_X</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">,</span><span class="token keyword">int</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>s<span class="token punctuation">;</span>    p<span class="token operator">=</span>L<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">&amp;&amp;</span>j<span class="token operator">&lt;</span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        p<span class="token operator">=</span>p<span class="token operator">-></span>next<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>p<span class="token operator">||</span>j<span class="token operator">></span>x<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>cout<span class="token operator">&lt;&lt;</span><span class="token string">"error"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>    s<span class="token operator">=</span>new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    s<span class="token operator">-></span>data<span class="token operator">=</span>y<span class="token punctuation">;</span>    s<span class="token operator">-></span>next<span class="token operator">=</span>p<span class="token operator">-></span>next<span class="token punctuation">;</span>    p<span class="token operator">-></span>next<span class="token operator">=</span>s<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="3-删除该单链表中的第i个元素，其值通过参数将其返回-从0开始-。">3)   删除该单链表中的第i个元素，其值通过参数将其返回(从0开始)。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 删除单链表中第i个元素 的结点 * @param L [description] * @param i [description] */</span><span class="token keyword">void</span> <span class="token function">Delet_x</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist s<span class="token punctuation">,</span>p<span class="token punctuation">;</span>    p<span class="token operator">=</span>L<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">&amp;&amp;</span>j<span class="token operator">&lt;</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        p<span class="token operator">=</span>p<span class="token operator">-></span>next<span class="token punctuation">;</span>        j<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    i <span class="token operator">=</span> p<span class="token operator">-></span>data<span class="token punctuation">;</span>    s <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>    p<span class="token operator">-></span>next<span class="token operator">=</span>s<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="4-建立两个按值递增有序的带头结点的单链表，将他们合并成一个按值递减有序的单链表。">4)   建立两个按值递增有序的带头结点的单链表，将他们合并成一个按值递减有序的单链表。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/*** 思路： 归并， 头插法*/</span>linklist <span class="token function">Union</span><span class="token punctuation">(</span>linklist la<span class="token punctuation">,</span>linklist lb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>q<span class="token punctuation">,</span>r<span class="token punctuation">,</span>rear<span class="token punctuation">,</span>t<span class="token punctuation">;</span>    p <span class="token operator">=</span> la<span class="token operator">-></span>next<span class="token punctuation">,</span>q <span class="token operator">=</span> lb<span class="token operator">-></span>next<span class="token punctuation">;</span>    la<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    r <span class="token operator">=</span> la<span class="token punctuation">;</span> <span class="token comment">// r重构la</span>    <span class="token keyword">while</span><span class="token punctuation">(</span> p <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token operator">-></span>data <span class="token operator">&lt;</span> q<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            rear <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            p<span class="token operator">-></span>next <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            p <span class="token operator">=</span> rear<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token operator">-></span>data <span class="token operator">></span> q<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            rear <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>            q<span class="token operator">-></span>next <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>            q <span class="token operator">=</span> rear<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 当两个值相同时,(按题目要求两个都保留, 另外一个free掉)</span>            rear <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>            t <span class="token operator">=</span> p <span class="token operator">-></span>next<span class="token punctuation">;</span>            p<span class="token operator">-></span>next <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            q<span class="token operator">-></span>next <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>            <span class="token comment">// free(q);</span>           q <span class="token operator">=</span> rear<span class="token punctuation">;</span>            p <span class="token operator">=</span> t<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>   <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 因为是倒叙, 所以必须 逐步遍历头插剩余部分</span>        rear <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        p<span class="token operator">-></span>next <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>        r<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>        p <span class="token operator">=</span> rear<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        rear <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>        q<span class="token operator">-></span>next <span class="token operator">=</span> r<span class="token operator">-></span>next<span class="token punctuation">;</span>        r<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>        q <span class="token operator">=</span> rear<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>     <span class="token keyword">return</span> la<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><hr><h3 id="plus-两个单调递增有序的单链表A-B-合并成一个单调递增有序的单链表C">plus-两个单调递增有序的单链表A B 合并成一个单调递增有序的单链表C</h3><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 两个单调递增有序的单链表A B 合并成一个单调递增有序的单链表C * @param L [description] * @param B [description] */</span><span class="token keyword">void</span> <span class="token function">Merage_A_B</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>A<span class="token punctuation">,</span>linklist <span class="token operator">&amp;</span>B<span class="token punctuation">,</span>linklist <span class="token operator">&amp;</span>C<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>linklist pa<span class="token punctuation">,</span>pb<span class="token punctuation">,</span>pc<span class="token punctuation">;</span>pa <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>pc <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pc <span class="token operator">-></span>next <span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>pa<span class="token operator">&amp;&amp;</span>pb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>pa<span class="token operator">-></span>data <span class="token operator">&lt;=</span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    pc<span class="token operator">-></span>next <span class="token operator">=</span> pa<span class="token punctuation">;</span>    pc <span class="token operator">=</span> pa<span class="token punctuation">;</span>    pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    pc <span class="token operator">-></span>next <span class="token operator">=</span> pb<span class="token punctuation">;</span>    pc <span class="token operator">=</span> pb<span class="token punctuation">;</span>    pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 尾插</span>pc <span class="token operator">-></span>next <span class="token operator">=</span> pa<span class="token operator">?</span> pa<span class="token operator">:</span>pb<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="5-试编写算法将带头结点的单链表就地逆置，所谓“就地”是指辅助空间复杂度为O-1-。-计-期末-10-1">5)   试编写算法将带头结点的单链表就地逆置，所谓“就地”是指辅助空间复杂度为O(1)。 (计.期末.10.1)</h2><div class="story post-story"><p>头插重新建表</p><img src="https://gitee.com/sizaif/images/raw/master/img/20201111233325.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201111233325.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201111233325409" style="zoom:50%;" /><p>指针反转</p><img src="https://gitee.com/sizaif/images/raw/master/img/20201111233350.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201111233350.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201111233350810" style="zoom:50%;" /><p>顺序存储 数组</p><img src="https://gitee.com/sizaif/images/raw/master/img/20201111233416.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201111233416.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201111233416308" style="zoom:50%;" /><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">//法一：头插法从新建表</span><span class="token keyword">void</span> <span class="token function">reverse</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>rear<span class="token punctuation">;</span> <span class="token comment">// rear 为p的后继 防止断链</span>    p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>    L<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 头结点的Next 置为null</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        rear <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token comment">//  头插法</span>        p<span class="token operator">-></span>next <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>        L<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>        p <span class="token operator">=</span> rear<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//法二：指针反转</span><span class="token keyword">void</span> <span class="token function">reverse</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    LinkList temp<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">;</span>    temp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>    q <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        temp <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 暂存q-Next</span>        q<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 指针逆置</span>        p <span class="token operator">=</span> q<span class="token punctuation">;</span> <span class="token comment">// 往后移</span>        q <span class="token operator">=</span> temp<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    L<span class="token operator">-></span>next<span class="token operator">-></span>next<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 第一个结点变成最后一个结点</span>    L<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 最后一个结点变成第一个结点</span><span class="token punctuation">&#125;</span><span class="token comment">//法三： 顺序存储 数组</span><span class="token keyword">void</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token keyword">int</span> A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        temp <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>n<span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        A<span class="token punctuation">[</span>n<span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="6-将一个头指针为head且不带头节点的单链表改造为一个含头节点且头指针为head的单循环链表-计-期末-09-1">6)   将一个头指针为head且不带头节点的单链表改造为一个含头节点且头指针为head的单循环链表 (计.期末.09.1)</h2><div class="story post-story"><img src="https://gitee.com/sizaif/images/raw/master/img/20201111233456.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201111233456.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201111233456163" style="zoom: 67%;" /><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">//没有单循环-> head->next = head; 改造为带头结点的</span><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span>LinkList <span class="token operator">&amp;</span>head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    LinkList p<span class="token punctuation">;</span>    p <span class="token operator">=</span> new <span class="token function">LinkNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>head <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        head <span class="token operator">=</span> p<span class="token punctuation">;</span>        p<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 单循环</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        p<span class="token operator">-></span>next <span class="token operator">=</span> head<span class="token punctuation">;</span> <span class="token comment">// 创造头结点</span>        <span class="token comment">// 单循环列表</span>        Linklist t <span class="token operator">=</span>  head<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>t<span class="token operator">-></span>next <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            t <span class="token operator">=</span> t<span class="token operator">-></span>next<span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>        t<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 最后一个结点指向头结点</span>        head <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">// 将p 赋给 head 变成head链表</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="7-假设有两个按元素值递增次序排列的线性表，均不带头结点以单链表形式存储。请编写算法将这两个单链表归并为一个按元素值递减-非递减-次序排列的单链表，并要求利用原来两个单链表的结点存放归并后的单链表-计-期末-08-2">7)   假设有两个按元素值递增次序排列的线性表，<strong>均不带头结点</strong>以单链表形式存储。请编写算法将这两个单链表归并为一个按元素值递减(非递减)次序排列的单链表，并要求利用原来两个单链表的结点存放归并后的单链表 (计.期末.08.2) !!!</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c">linklist <span class="token function">merge_without_Head</span><span class="token punctuation">(</span>linklist la<span class="token punctuation">,</span>linklist lb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>linklist lc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>lce <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>la <span class="token operator">&amp;&amp;</span> lb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> la<span class="token operator">-></span>data <span class="token operator">&lt;=</span> lb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lc<span class="token punctuation">)</span> lc <span class="token operator">=</span> la<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    lce<span class="token operator">-></span>next <span class="token operator">=</span> la<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    lce <span class="token operator">=</span> la<span class="token punctuation">;</span>    la <span class="token operator">=</span> la<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lc<span class="token punctuation">)</span> lc <span class="token operator">=</span> lb<span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    lce<span class="token operator">-></span>next <span class="token operator">=</span> lb<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    lce <span class="token operator">=</span> lb<span class="token punctuation">;</span>    lb <span class="token operator">=</span> lb<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>lc<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>la<span class="token punctuation">)</span> lce <span class="token operator">-></span>next <span class="token operator">=</span> la<span class="token punctuation">;</span><span class="token keyword">else</span>lce <span class="token operator">-></span>next <span class="token operator">=</span> lb<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>la <span class="token punctuation">)</span> lc <span class="token operator">=</span> la<span class="token punctuation">;</span><span class="token keyword">else</span>lc <span class="token operator">=</span> lb<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> lc<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="8-给定一个带表头结点的单链表A分解为两个带头结点的单链表A和B，使得A表中含有原表中序号为奇数的元素，而B表中含有原表中序号为偶数的元素，且保持其相对顺序不变">8)   给定一个带表头结点的单链表A分解为两个带头结点的单链表A和B，使得A表中含有原表中序号为奇数的元素，而B表中含有原表中序号为偶数的元素，且保持其相对顺序不变</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token keyword">void</span> <span class="token function">div</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>A<span class="token punctuation">,</span>linklist <span class="token operator">&amp;</span>B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>linklist p<span class="token punctuation">,</span>pc<span class="token punctuation">,</span>pb<span class="token punctuation">,</span>temp<span class="token punctuation">,</span>Lc<span class="token punctuation">;</span>    p <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>    Lc <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Lc<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    pc <span class="token operator">=</span> Lc<span class="token punctuation">;</span>    pb <span class="token operator">=</span> B<span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    temp <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 保存后继防止断链</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">//尾插</span>            p<span class="token operator">-></span>next <span class="token operator">=</span> pc<span class="token operator">-></span>next<span class="token punctuation">;</span>            pc<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            pc <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            <span class="token comment">//尾插</span>            p<span class="token operator">-></span>next <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>            pb<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            pb <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        p <span class="token operator">=</span> temp<span class="token punctuation">;</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    A <span class="token operator">=</span> LC<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="9-设计一个递归算法，删除不带头结点的单链表L中所有值为x的结点-统计值等于x的数目-int-CountX-Lnode-HL-ElemType-x">9)   设计一个递归算法，删除不带头结点的单链表L中所有值为x的结点(统计值等于x的数目) int CountX(Lnode * HL, ElemType x)</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span>LinkList <span class="token operator">&amp;</span>L<span class="token punctuation">,</span>ElemType x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    LinkList temp<span class="token punctuation">;</span> <span class="token comment">// 做释放用</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>L<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">//  结束条件</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>L<span class="token operator">-></span>data <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        temp <span class="token operator">=</span> L<span class="token punctuation">;</span>        L <span class="token operator">=</span> L <span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token function">free</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">del</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        <span class="token function">del</span><span class="token punctuation">(</span>L<span class="token operator">-></span>next<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 递归统计</span><span class="token keyword">int</span> ct <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">count</span><span class="token punctuation">(</span>LinkList <span class="token operator">&amp;</span>L<span class="token punctuation">,</span>ElemType x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>L <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>L<span class="token operator">-></span>data <span class="token operator">==</span> x<span class="token punctuation">)</span> ct<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">count</span><span class="token punctuation">(</span>L<span class="token operator">-></span>next<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="10-在带头结点的单链表L中，删除所有值为x的结点，并释放空间，假设值为x的结点不唯一，试编写算法以实现上述操作。">10)  在带头结点的单链表L中，删除所有值为x的结点，并释放空间，假设值为x的结点不唯一，试编写算法以实现上述操作。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token keyword">void</span> <span class="token function">del_x</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">,</span><span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>   linklist p<span class="token punctuation">,</span>temp<span class="token punctuation">,</span>pre<span class="token punctuation">;</span>    p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">,</span>pre <span class="token operator">=</span> L<span class="token punctuation">;</span> <span class="token comment">// pre 防止断链</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            temp <span class="token operator">=</span> p<span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            pre <span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span> <span class="token comment">// 同时后移</span>        pre <span class="token operator">=</span> p<span class="token punctuation">;</span>        p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="11-设L为带头结点的单链表，编写算法实现从尾到头反向输出每个结点的值-头插法建表，遍历">11)  设L为带头结点的单链表，编写算法实现从尾到头反向输出每个结点的值(头插法建表，遍历)</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">//法一： 一边遍历一边头插法建立新表</span>linklist <span class="token function">create_head</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>     liklist newL<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">;</span>    newL <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    newL<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        q <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        q<span class="token operator">-></span>data <span class="token operator">=</span> p<span class="token operator">-></span>data<span class="token punctuation">;</span>        q<span class="token operator">-></span>next <span class="token operator">=</span> newL<span class="token operator">-></span>next<span class="token punctuation">;</span>        newL<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> newL<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">Visit</span><span class="token punctuation">(</span>linklist L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">;</span>    p<span class="token operator">=</span>L<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d "</span><span class="token punctuation">,</span>p<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token operator">=</span>p<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>法二：<span class="token comment">// 采用递归输出 栈的思想</span><span class="token keyword">void</span> <span class="token function">R_p</span><span class="token punctuation">(</span>linklist L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>L<span class="token operator">-></span>next <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">R_p</span><span class="token punctuation">(</span>L<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>cout<span class="token operator">&lt;&lt;</span>L<span class="token operator">-></span>data<span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="12-试编写在带头结点的单链表L中删除一个最小值结点的高效算法（假设最小值结点时唯一的）">12)  试编写在带头结点的单链表L中删除一个最小值结点的高效算法（假设最小值结点时唯一的）</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token keyword">void</span> <span class="token function">delete_MinX</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist pre<span class="token punctuation">,</span>p<span class="token punctuation">,</span>minp<span class="token punctuation">,</span>minpre<span class="token punctuation">;</span>    pre <span class="token operator">=</span> L<span class="token punctuation">;</span> p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token comment">// pre 指向前驱</span>   minp <span class="token operator">=</span> p<span class="token punctuation">,</span>minpre <span class="token operator">=</span> pre<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 遍历寻找最小值</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data <span class="token operator">&lt;=</span> minp<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            minp <span class="token operator">=</span> p<span class="token punctuation">;</span>            minpre <span class="token operator">=</span> pre<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        pre <span class="token operator">=</span> p<span class="token punctuation">;</span>        p <span class="token operator">=</span> p <span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 删除minp 结点</span>    minpre<span class="token operator">-></span>next <span class="token operator">=</span> minp<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>minp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="13-有一个带头结点的单链表L，设计一个算法使其元素递增有序">13)  有一个带头结点的单链表L，设计一个算法使其元素递增有序</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/img_convert/f9afd526f2074191285c684f14a22934.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/f9afd526f2074191285c684f14a22934.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20200828213127042"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">// 空间换时间O(n^2) 考的概率不大</span><span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>pre<span class="token punctuation">,</span>rear<span class="token punctuation">;</span>    p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>    rear <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// rear 保留p后面的链表保证不断链</span>    p<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 让 L 只有一个结点， 重构 L</span>    p <span class="token operator">=</span> rear<span class="token punctuation">;</span> <span class="token comment">// 遍历剩下的内容链表</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        rear <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        pre <span class="token operator">=</span> L<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>pre<span class="token operator">-></span>next<span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> pre<span class="token operator">-></span>next<span class="token operator">-></span>data <span class="token operator">&lt;</span> p<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>             <span class="token comment">// 在新L中找到p->data应该的位置</span>            pre <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        p<span class="token operator">-></span>next <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 尾插法 把 p 插入到新L 中</span>        pre <span class="token operator">-></span> next <span class="token operator">=</span> p<span class="token punctuation">;</span><span class="token comment">// 尾插法 把 p 插入到 新L 中</span>        p <span class="token operator">=</span> rear<span class="token punctuation">;</span> <span class="token comment">// 继续遍历 旧L 剩下的内容</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200824223913524.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824223913524.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="14-设在一个带表结点的单链表中所有元素结点的数据值无序，试编写一个函数，删除表中所有介于给定的两个值（作为函数参数给出）之间的元素的元素（若存在）">14)  <strong>设在一个带表结点的单链表中所有元素结点的数据值无序，试编写一个函数，删除表中所有介于给定的两个值（作为函数参数给出）之间的元素的元素（若存在）</strong></h2><div class="story post-story"><p>数字之间，字母之间等问题</p><img src="https://gitee.com/sizaif/images/raw/master/img/20201111233535.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201111233535.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201111233535101" style="zoom:50%;" /><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token keyword">void</span> <span class="token function">delete_between</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">,</span>ElemType x<span class="token punctuation">,</span>ElemType y<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>pre<span class="token punctuation">,</span>temp<span class="token punctuation">;</span>    p <span class="token operator">=</span>  L<span class="token operator">-></span>next<span class="token punctuation">;</span>    pre <span class="token operator">=</span> L<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data <span class="token operator">>=</span> x <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>data <span class="token operator">&lt;=</span> y<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 如果介于之间</span>            <span class="token comment">// 删除</span>            pre<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>            p <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span> <span class="token comment">// 否则继续遍历</span>            pre <span class="token operator">=</span> p<span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details>## 15)  **给定两个单链表，编写算法找出两个链表的公共结点。**<p>掌握解题思想，先走k步，然后一同走，<br><img src="https://gitee.com/sizaif/images/raw/master/img/20201111233605.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201111233605.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201111233605129" style="zoom:80%;" /></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">// 公共结点指， 两个链表从某一结点开始， next都指向同一个节点 Y型</span><span class="token comment">// 长的先走k步,然后一同走,第一个相同的结点即为公共结点初始点</span>linklist <span class="token function">Common</span><span class="token punctuation">(</span>linklist A<span class="token punctuation">,</span>linklist B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist pa<span class="token punctuation">,</span>pb<span class="token punctuation">;</span>    <span class="token keyword">int</span> lena <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span>lenb <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>k<span class="token punctuation">;</span>    pa <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>    pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token comment">// 求lena lenb </span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        lena<span class="token operator">++</span><span class="token punctuation">;</span>pa<span class="token operator">=</span>pa<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        lenb<span class="token operator">++</span><span class="token punctuation">;</span>pb<span class="token operator">=</span>pb<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 长链赋给 pa 断链 赋给 pb</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>lena<span class="token operator">></span>lenb<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        k <span class="token operator">=</span> lena<span class="token operator">-</span>lenb<span class="token punctuation">;</span>        pa <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>        pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>      k <span class="token operator">=</span> lenb<span class="token operator">-</span>lena<span class="token punctuation">;</span>          pa <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>        pb <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>   <span class="token comment">// 先走k步</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>k<span class="token operator">--</span><span class="token punctuation">)</span> pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>   <span class="token comment">// 同时走，第一个相同的结点即为公共链的起点</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> pa<span class="token operator">-></span>data <span class="token operator">==</span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> pa<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>            pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200824223956325.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824223956325.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="16-给定一个带表头结点的单链表，设head为头指针，结点的结构为（data，next），data为整形元素，next为指针，试写出算法：按递增次序输出单链表中各结点的数据元素，并释放结点所占的存储空间-注意-：不允许使用数组作为辅助空间）">16)  给定一个带表头结点的单链表，设head为头指针，结点的结构为（data，next），data为整形元素，next为指针，试写出算法：按递增次序输出单链表中各结点的数据元素，并释放结点所占的存储空间 (注意)：不允许使用数组作为辅助空间）</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">// 每次寻找最小的结点输出 O(n^2)</span><span class="token comment">// pre记录的是最小值的前驱，pre->next 既为最小值结点</span><span class="token comment">// p 相等于记录的是最小值结点</span><span class="token comment">// 每次比较的是 p->next->data 与 pre->next->data； 即 最小值后一个结点与最小值结点</span><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>Head<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>Head<span class="token operator">-></span>next<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist pre<span class="token punctuation">,</span>p<span class="token punctuation">,</span>temp<span class="token punctuation">;</span>        pre <span class="token operator">=</span> Head<span class="token punctuation">;</span>p <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token comment">// 寻找最小值结点</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">// pre->next为最小值结点， p->next为最小值结点后继一个结点</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next<span class="token operator">-></span>data <span class="token operator">&lt;</span> pre<span class="token operator">-></span>next<span class="token operator">-></span>data <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                pre <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment">//updata</span>            <span class="token punctuation">&#125;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        cout<span class="token operator">&lt;&lt;</span>pre<span class="token operator">-></span>next<span class="token operator">-></span>data<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token comment">//输出最小结点值</span>        <span class="token comment">// 释放空间，free，并保证不断链</span>        p <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// </span>        pre<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token comment">//保正不断链</span>        <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">free</span><span class="token punctuation">(</span>Head<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200824224009888.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824224009888.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="17-设C-a1-b1-a2-b2…-an-bn-为线性表，采用带头结点的hc单链表存放，设计一个就地算法，将其拆分为两个线性表，使得A-a1-a2-…-an-B-bn-…-b2-b1">17)  设C={a1,b1,a2,b2…,an,bn}为线性表，采用带头结点的hc单链表存放，设计一个就地算法，将其拆分为两个线性表，使得A={a1,a2,…,an} B={bn,…,b2,b1}</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">// 思想： A存放的是奇数位置，尾插法 ； B存放的是偶数位置，头插法</span><span class="token keyword">void</span> <span class="token function">fun2</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist la<span class="token punctuation">,</span>lb<span class="token punctuation">,</span>pl<span class="token punctuation">,</span>pa<span class="token punctuation">,</span>pb<span class="token punctuation">,</span>temp<span class="token punctuation">;</span>    la <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>lb <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> la<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>lb<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    pa <span class="token operator">=</span> la<span class="token punctuation">;</span>pb <span class="token operator">=</span> lb<span class="token punctuation">;</span>    pl <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pl<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    i<span class="token operator">++</span><span class="token punctuation">;</span>        temp <span class="token operator">=</span> pl<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 保存后继结点，防止断链</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token comment">// A采用尾插法</span>            pl<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">// 很重要,保证尾必为null</span>            pa<span class="token operator">-></span>next <span class="token operator">=</span> pl<span class="token punctuation">;</span>            pa <span class="token operator">=</span> pl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>           <span class="token comment">// B采用头插法</span>            pl<span class="token operator">-></span>next <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>            pb<span class="token operator">-></span>next <span class="token operator">=</span> pl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        pl <span class="token operator">=</span> temp<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>    <span class="token function">Visit</span><span class="token punctuation">(</span>la<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">Visit</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200824224031449.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824224031449.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="18-在一个递增有序的线性表中，有数值相同的元素存在。若存储方式为单链表，设计算法去掉数值相同的元素，使表中不再有重复的元素。例如（7-10-10-21-30-42-42-42-51-70）将变作（7-10-21-30-42-51-70）">18)  在一个递增有序的线性表中，有数值相同的元素存在。若存储方式为单链表，设计算法去掉数值相同的元素，使表中不再有重复的元素。例如（7,10,10,21,30,42,42,42,51,70）将变作（7,10,21,30,42,51,70）</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">// 递增有序， 相同的挨着， 一个pre 一个 p  比较p->next是否和pre->next 相同</span><span class="token comment">// 相同删除 p结点  O(N)</span><span class="token keyword">void</span> <span class="token function">delete_same</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist pre<span class="token punctuation">,</span>p<span class="token punctuation">,</span>temp<span class="token punctuation">;</span>    pre <span class="token operator">=</span> L<span class="token punctuation">;</span>p <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        temp <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 防止断链</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next<span class="token operator">-></span>data <span class="token operator">==</span> pre<span class="token operator">-></span>next<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            pre<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>        pre <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        p <span class="token operator">=</span> temp<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200824224054742.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824224054742.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="19-设A和B是两个单链表（带头结点），其中元素递增有序，设计一个算法从A和B中公共元素产生单链表C，要求不破坏A-B-的结点">19)  设A和B是两个单链表（带头结点），其中元素递增有序，设计一个算法从A和B中公共元素产生单链表C，要求不破坏A B 的结点</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">//有序 C中元素即是A的也是B的 尾插建链表即可</span><span class="token keyword">void</span> <span class="token function">fun3</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>A<span class="token punctuation">,</span>linklist <span class="token operator">&amp;</span>B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist C<span class="token punctuation">,</span>pa<span class="token punctuation">,</span>pb<span class="token punctuation">,</span>pc<span class="token punctuation">,</span>temp<span class="token punctuation">;</span>    C <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> C<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    pc <span class="token operator">=</span> C<span class="token punctuation">;</span>    pa <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">,</span>pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> pb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 小折后移</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> pa<span class="token operator">-></span>data <span class="token operator">&lt;</span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pa<span class="token operator">-></span>data <span class="token operator">></span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span>         <span class="token punctuation">&#123;</span>           <span class="token comment">// 相同值</span>            temp <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            temp<span class="token operator">-></span>data <span class="token operator">=</span> pa<span class="token operator">-></span>data<span class="token punctuation">;</span>            pc<span class="token operator">-></span>next <span class="token operator">=</span> temp<span class="token punctuation">;</span>            <span class="token comment">/*            如果这样写就会出现图2的情况            pc->next = pa;            pc = pa;            */</span>            pc <span class="token operator">=</span> temp<span class="token punctuation">;</span>            <span class="token comment">// 同时后移</span>            pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>            pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">Visit</span><span class="token punctuation">(</span>C<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200824224106163.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824224106163.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200824224113285.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200824224113285.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="20-已知两个链表A和B分别表示两个集合，其元素递增排列。绘制函数，求A与B的交集，并存放于A链表中。">20)  已知两个链表A和B分别表示两个集合，其元素递增排列。绘制函数，求A与B的交集，并存放于A链表中。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">//  有序， 相同存入，AB同时后移， 不同，小者后移</span><span class="token keyword">void</span> <span class="token function">fun4</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>A<span class="token punctuation">,</span>linklist <span class="token operator">&amp;</span>B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist pa<span class="token punctuation">,</span>pb<span class="token punctuation">,</span>pre<span class="token punctuation">,</span>temp<span class="token punctuation">;</span>    pa <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>    pre <span class="token operator">=</span> A<span class="token punctuation">;</span> <span class="token comment">// pre 指向A  重构A链表</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pa<span class="token operator">&amp;&amp;</span>pb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 小者后移</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> pa<span class="token operator">-></span>data <span class="token operator">&lt;</span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            pa <span class="token operator">=</span> pa <span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pa<span class="token operator">-></span>data <span class="token operator">></span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 相等时存入，</span>            temp <span class="token operator">=</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            temp<span class="token operator">-></span>data <span class="token operator">=</span> pa<span class="token operator">-></span>data<span class="token punctuation">;</span>            pre<span class="token operator">-></span>next <span class="token operator">=</span> temp<span class="token punctuation">;</span>            pre <span class="token operator">=</span> temp<span class="token punctuation">;</span>            pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>            pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/2020082522163453.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/2020082522163453.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="21-头指针分别为la-lb的带头结点的单链表中，结点按元素递增有序排列，将la和lb两个链表合并成按元素递增有序的单链表，要求不另外开辟空间，la作为合并后的单链表的头结点-951-Y19">21) 头指针分别为la,lb的带头结点的单链表中，结点按元素递增有序排列，将la和lb两个链表合并成按元素递增有序的单链表，要求不另外开辟空间，la作为合并后的单链表的头结点(951.Y19)</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">//  归并 原理与上题一致</span>linklist <span class="token function">Union</span><span class="token punctuation">(</span>linklist la<span class="token punctuation">,</span>linklist lb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>q<span class="token punctuation">,</span>r<span class="token punctuation">,</span>s<span class="token punctuation">;</span>    p <span class="token operator">=</span> la<span class="token operator">-></span>next<span class="token punctuation">,</span>q <span class="token operator">=</span> lb<span class="token operator">-></span>next<span class="token punctuation">;</span>    r <span class="token operator">=</span> la<span class="token punctuation">;</span> <span class="token comment">// r重构la</span>    <span class="token keyword">while</span><span class="token punctuation">(</span> p <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token operator">-></span>data <span class="token operator">&lt;</span> q<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            r <span class="token operator">=</span> p<span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token operator">-></span>data <span class="token operator">></span> q<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>            r <span class="token operator">=</span> q<span class="token punctuation">;</span>            q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>            r <span class="token operator">=</span> p<span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            s <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>           q <span class="token operator">=</span> s<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>            r<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> la<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="22-两个整数序列A-a1-a2-a3-…-am和B-b1-b2-b3-…-bn已经存入两个单链表中，设计一个算法，判断序列B是否是序列A的连续子序列">22)  两个整数序列A=a1,a2,a3,…,am和B=b1,b2,b3,…,bn已经存入两个单链表中，设计一个算法，判断序列B是否是序列A的连续子序列</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** 模式匹配 链表实现 一般算法 O(n^2)  * 带头结点, 当相同时，同时后移，， 当不相同时，B从头开始，A后移一个* 判断条件： 如果B跑完说明匹配完成，否则不存在*/</span><span class="token keyword">int</span> <span class="token function">Pattern</span><span class="token punctuation">(</span>linklist A<span class="token punctuation">,</span>linklist B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist pa<span class="token punctuation">,</span>pb<span class="token punctuation">,</span>pre<span class="token punctuation">;</span>    pa <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">,</span>pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span>    pre <span class="token operator">=</span> A<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>pa<span class="token operator">&amp;&amp;</span>pb<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 相同，同时后移</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>pa<span class="token operator">-></span>data <span class="token operator">==</span> pb<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            pa <span class="token operator">=</span> pa<span class="token operator">-></span>next<span class="token punctuation">;</span>            pb <span class="token operator">=</span> pb<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">// 不相同 A后移</span>            pre <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span>            pa <span class="token operator">=</span> pre<span class="token punctuation">;</span> <span class="token comment">// A后移一个结点后从新匹配，</span>            pb <span class="token operator">=</span> B<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// B从头开始  </span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> pb <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token operator">?</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 如果pb 跑完说明匹配完成存在</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200825221729532.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200825221729532.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="23-设计一个算法用于判断带头结点的循环双链表是否对称">23)  设计一个算法用于判断带头结点的循环双链表是否对称</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** 对称指 设各元素值 a1,a2,...,an, 则有 ai=an-i+1 ，* 即指： a1= an ， a2= an-1 。。。。。。。* p 从头， q 从尾 当两个相同时，p后移，q前移，一旦不同则break，* 结束条件　p==q　|｜p->next = q;  */</span><span class="token keyword">int</span> <span class="token function">flag1</span><span class="token punctuation">(</span>linklist L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>q<span class="token punctuation">;</span>    p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span> p <span class="token operator">=</span> L<span class="token operator">-></span>prior<span class="token punctuation">;</span>    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 初始默认对称</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span>q <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>next <span class="token operator">!=</span> q <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token operator">-></span>data <span class="token operator">==</span> q<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            q <span class="token operator">=</span> q<span class="token operator">-></span>prior<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> flag<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="24-有两个循环单链表，链表头指针分别为h1和h2，编写一个函数将链表h2链接到链表h1之后，要求链接后的链表仍保持循环链表形式。">24)  有两个循环单链表，链表头指针分别为h1和h2，编写一个函数将链表h2链接到链表h1之后，要求链接后的链表仍保持循环链表形式。</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200825221922581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,zoom:50%25,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200825221922581.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,zoom:50%25,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** *  */</span><span class="token keyword">void</span> <span class="token function">fun5</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>h1<span class="token punctuation">,</span>linklist <span class="token operator">&amp;</span>h2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>q<span class="token punctuation">;</span>    p <span class="token operator">=</span> h1<span class="token punctuation">,</span>q <span class="token operator">=</span> h2<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next <span class="token operator">!=</span> h1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token operator">-></span>next <span class="token operator">!=</span> h2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    p<span class="token operator">-></span>next <span class="token operator">=</span> h2<span class="token punctuation">;</span>    q<span class="token operator">-></span>next <span class="token operator">=</span> h1<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="25-设有一个带头结点的循环单链表，其结点值均为正整数。设计一个算法，反复找出单链表中结点值最小的结点并输出，然后将该结点从中删除，直到单链表为空位置，再删除表头结点">25)  设有一个带头结点的循环单链表，其结点值均为正整数。设计一个算法，反复找出单链表中结点值最小的结点并输出，然后将该结点从中删除，直到单链表为空位置，再删除表头结点</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** *  同第16方法一致，这里为循环电单链表，判空条件需改变 */</span><span class="token keyword">void</span> <span class="token function">Del_all</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>pre<span class="token punctuation">,</span>minp<span class="token punctuation">,</span>minpre<span class="token punctuation">;</span>    <span class="token comment">// 没循环一次L减少一个结点，当L->next为L时，说明全部删完</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>L<span class="token operator">-></span>next<span class="token operator">!</span> <span class="token operator">=</span> L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        p <span class="token operator">=</span> L<span class="token operator">-></span>next<span class="token punctuation">;</span>pre <span class="token operator">=</span> L<span class="token punctuation">;</span>        minp <span class="token operator">=</span> p<span class="token punctuation">,</span> minpre <span class="token operator">=</span> pre<span class="token punctuation">;</span>        <span class="token comment">// 找到最小结点</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">-></span>next <span class="token operator">!=</span> L<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 循环单链表</span>            <span class="token comment">// 找到最小结点</span>            <span class="token keyword">if</span><span class="token punctuation">(</span> p<span class="token operator">-></span>data <span class="token operator">&lt;</span> minp<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                minp <span class="token operator">=</span> p<span class="token punctuation">;</span>                minpre <span class="token operator">=</span> pre<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>                pre <span class="token operator">=</span> p<span class="token punctuation">;</span>                p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">//free minp</span>        cout<span class="token operator">&lt;&lt;</span>minp<span class="token operator">-></span>data<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>        minpre<span class="token operator">-></span>next <span class="token operator">=</span> minp<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 删除节点保证不断链</span>        <span class="token function">free</span><span class="token punctuation">(</span>minp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">free</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="26-已知带头结点单链表，头指针list，不改变链表的前提下设计高效的算法，查找链表中倒数第k个位置上的节点的值-408-Y09">26)  已知带头结点单链表，头指针list，不改变链表的前提下设计高效的算法，查找链表中倒数第k个位置上的节点的值(408.Y09)</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 掌握思想很重要，O(n)内实现 * 两个指针p,q， p先走k步，然后p,q一起走，当p到时，q即为倒数第k个位置 * 有可能会出现 k 大于表长的情况,需要判断 */</span><span class="token keyword">int</span> <span class="token function">fun6</span><span class="token punctuation">(</span>linklist list<span class="token punctuation">,</span><span class="token keyword">int</span> k<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>q<span class="token punctuation">;</span>    p <span class="token operator">=</span> list<span class="token operator">-></span>next<span class="token punctuation">;</span>    q <span class="token operator">=</span> list<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// p 走k步</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">// p,q 同时走</span>            q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>     <span class="token punctuation">&#125;</span>    <span class="token comment">// k > n</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> i <span class="token operator">&lt;</span> k<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout<span class="token operator">&lt;&lt;</span>q<span class="token operator">-></span>data<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span> <span class="token comment">// 此时q->data即为倒数第k个位置</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="27-假定采用带头结点的单链表保存单词-当两个单词有相同的后缀时-可共享相同的后缀存储空间-例如-“-loading”和-being”的存储映像如下图所示-408-Y12">27) 假定采用带头结点的单链表保存单词,当两个单词有相同的后缀时,可共享相同的后缀存储空间,例如,“ loading”和&quot; being”的存储映像如下图所示(408,Y12)</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200825222102312.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200825222102312.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><p><strong>设str1和str2分别指向两个单词所在单链表的头结点,链表结点结构为 data next请设计一个时间上尽可能高效的算法,找出由str1和str2所指向两个链表共同后缀的起始位置(如图中字符主所在结点的位置p)。要求</strong></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/*** 求公共后缀,  求strlen(str1),strlen(str2);* 求差k， 大者先走k步， 然后同时走，第一个相等的即为公共后缀起点*/</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">link</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> data<span class="token punctuation">;</span>    link <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>node<span class="token punctuation">,</span><span class="token operator">*</span>linklist<span class="token punctuation">;</span>linklist <span class="token function">Common2</span><span class="token punctuation">(</span>linklist str1<span class="token punctuation">,</span>linklist str2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>q<span class="token punctuation">,</span>s<span class="token punctuation">,</span>l<span class="token punctuation">;</span>    p <span class="token operator">=</span> str1<span class="token operator">-></span>next<span class="token punctuation">,</span>q <span class="token operator">=</span> str2<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token keyword">int</span> len1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>len2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>k<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">,</span>len1<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 求str1长度</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">,</span>len2<span class="token operator">++</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 求str2长度</span>    <span class="token comment">// 让 s指向短链 ；l指向长链</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>len1 <span class="token operator">&lt;</span> len2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        k <span class="token operator">=</span> len2 <span class="token operator">-</span> len1<span class="token punctuation">;</span>        s <span class="token operator">=</span> str1<span class="token operator">-></span>next<span class="token punctuation">;</span>        l <span class="token operator">=</span> str2<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">else</span><span class="token punctuation">&#123;</span>        k <span class="token operator">=</span> len1 <span class="token operator">-</span> len2<span class="token punctuation">;</span>        s <span class="token operator">=</span> str2<span class="token operator">-></span>next<span class="token punctuation">;</span>        l <span class="token operator">=</span> str1<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>k<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">// 或者 for(int i = 0 ;i &lt; k ;i++)</span>        l <span class="token operator">=</span> l<span class="token operator">-></span>next<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>s<span class="token operator">&amp;&amp;</span>l<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span> s<span class="token operator">-></span>data <span class="token operator">==</span> l<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">return</span> s<span class="token punctuation">;</span> <span class="token comment">//  返回s的起始位置,此时s->data即为第一个相同元素(不带头结点)</span>           <span class="token comment">/* 此时返回的是带头结点的            linklist temp = new node();            temp->next = s;            return temp;            */</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            s <span class="token operator">=</span> s<span class="token operator">-></span>next<span class="token punctuation">;</span>            l <span class="token operator">=</span> l<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> new <span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/20200825222122888.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200825222122888.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200825222140373.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200825222140373.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div><h2 id="28-用单链表保存m个整数-结点的结构为data-link-data-≤n-n为正整数-。现要求设计一个时间复杂度尽可能高效的算法-对于链表中data的绝对值相等的结点-仅保留第一次出现的结点而删除其余绝对值相等的结点。例如-若给定的单链表head如下-408-Y15">28) 用单链表保存m个整数,结点的结构为data,link,|data|≤n(n为正整数)。现要求设计一个时间复杂度尽可能高效的算法,对于链表中data的绝对值相等的结点,仅保留第一次出现的结点而删除其余绝对值相等的结点。例如,若给定的单链表head如下:(408,Y15)</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200825222153477.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200825222153477.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/*** 删除重复结点,无序* 建立一个map索引,存放data,如果不存在则,链表跳过，否则删除这个结点，* 这里求的是|data| 所以索引用数组即可* 时间O(m),空间O(n)**/</span><span class="token keyword">void</span> <span class="token function">fun6</span><span class="token punctuation">(</span>linklist <span class="token operator">&amp;</span>Head<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    linklist p<span class="token punctuation">,</span>pre<span class="token punctuation">;</span>    <span class="token keyword">int</span> vis<span class="token punctuation">[</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 初始化vis 标记为0;</span>    <span class="token function">memset</span><span class="token punctuation">(</span>vis<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>vis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    p <span class="token operator">=</span> Head<span class="token operator">-></span>next<span class="token punctuation">;</span>pre <span class="token operator">=</span> Head<span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 第一次存在，跳过(保留)</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>vis<span class="token punctuation">[</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            vis<span class="token punctuation">[</span><span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            pre <span class="token operator">=</span> p<span class="token punctuation">;</span>            p <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token comment">//重复</span>            pre<span class="token operator">-></span>next <span class="token operator">=</span> p<span class="token operator">-></span>next<span class="token punctuation">;</span>            <span class="token function">free</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放</span>            p <span class="token operator">=</span> pre<span class="token operator">-></span>next<span class="token punctuation">;</span> <span class="token comment">// 删除p后,保证不断链</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://img-blog.csdnimg.cn/2020082522220442.png#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/2020082522220442.png#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 算法 </category>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>循环右移K位问题的思考，几种方法的解决</title>
      <link href="/posts/c1919217/"/>
      <url>/posts/c1919217/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>循环右移K位问题</h1><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h2 id="试用顺序存储结构设计一个算法，仅用一个辅助结点，实现将线性表中的结点循环右移k位的运算，并分析，算法的时间复杂度．">试用顺序存储结构设计一个算法，仅用一个辅助结点，实现将线性表中的结点循环右移k位的运算，并分析，算法的时间复杂度．</h2><div class="story post-story"><h3 id="方法一-mod移位思想">方法一: mod移位思想</h3><img src="https://gitee.com/sizaif/images/raw/master/img/20201021133306.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20201021133306.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20200921203625271" style="zoom: 33%;" /><pre><code>图一：</code></pre><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/** * 思路:  * 运用mod的思想, 将n复制成2n的数组 如图一所示; 那么循环有移 逃不出2n内 * 右移后的结果为： (i+k)   缩到n内的话 就是 (i+k)%n * 实际上只需要用另外一个数组B[] 来存取 原数组A[] 的内容 即 B[i] = A[(i+n-k)%n]; * 但是 这样的话  空间复杂度就为 O(n), 时间复杂度为 O(n); */</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> n <span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>b<span class="token punctuation">[</span> i <span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> n <span class="token operator">-</span> k<span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p><img src="https://img-blog.csdnimg.cn/img_convert/d64be21c100fd50a38736322cb6c002c.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/d64be21c100fd50a38736322cb6c002c.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201107120751845"></p><h3 id="方法一plus：">方法一plus：</h3><p><img src="https://img-blog.csdnimg.cn/img_convert/e80ebb7f29f60cf5a4459eecd01af216.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/e80ebb7f29f60cf5a4459eecd01af216.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="IMG_0301(20201107-114415)"></p><p><strong>会出现如下的情况：</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/d75b979d884bb35f34566d48dd7a51e4.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/d75b979d884bb35f34566d48dd7a51e4.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201107115225238"></p><h4 id="改进-最大公约数GCD">改进-最大公约数GCD</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*** 将方法加以改进 * 将其按照 k 步进行分组，   类似于希尔排序的思想， 每间隔k的位置构成一组，那么我们* 的所谓右移只是在这每一组中组内移动，类似下图* 那么我们只需要确定我们要循环几次就可以找到答案呢？* 答案是确定的只需要找到他们的 gcd ，* 然后记录下开始位置，采用 反求x的方法 即  （x+k)%n = t, t,n,k已知 求未知数x*  x = (t+n-k)%n; 当 x == 开始位置时停止,进入下一组*  时间复杂度O(n) , 空间复杂度O(1)*/</span><span class="token keyword">int</span> <span class="token function">Gcd</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token keyword">return</span> b<span class="token operator">==</span><span class="token number">0</span><span class="token operator">?</span>a<span class="token operator">:</span><span class="token function">Gcd</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>a<span class="token operator">%</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 辗转相除法求GCD</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">int</span> k<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> gcd <span class="token operator">=</span> <span class="token function">Gcd</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> t<span class="token punctuation">,</span>temp<span class="token punctuation">,</span>j<span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;</span> gcd<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>temp <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 记录开始位置 </span>t <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>j <span class="token operator">=</span> <span class="token punctuation">(</span> t <span class="token operator">+</span> n <span class="token operator">-</span> k <span class="token punctuation">)</span><span class="token operator">%</span>n<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> j <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 循环到自己跳出 </span>a<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>t <span class="token operator">=</span> j<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>a<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><ul><li></li></ul><p><img src="https://img-blog.csdnimg.cn/img_convert/ba65b8ae4f7ecfb73fdce18cfa10c903.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/ba65b8ae4f7ecfb73fdce18cfa10c903.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201107154859498"></p><p>==验证：==</p><p><img src="https://img-blog.csdnimg.cn/img_convert/5633b4ad5f4d0d428e0940d69d2d0f1b.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/5633b4ad5f4d0d428e0940d69d2d0f1b.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20201107155752226"></p><hr><h3 id="方法二：倒叙移位">方法二：倒叙移位</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/** ``````````````````````分割线``````````````````````````````* 将空间复杂度降到O(1)* 所以考虑只用一个辅助结点的优化方法* * 第一种 循环k次， 从后面开始移动，  空间复杂度为O(1) ,但时间复杂度为 O(kn)**/</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> k<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">int</span> temp <span class="token operator">=</span> a<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>           a<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span></code></pre><hr><h3 id="方法三：递归调用">方法三：递归调用</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/** ``````````````````````分割线``````````````````````````````* 将空间复杂度降到O(1)* 所以考虑只用一个辅助结点的优化方法* * 第二种 采用递归反转的方式  空间复杂度为O(1) ,时间复杂度为 O(n)* 先递归反转前 （n-k)位  在反转后 k位  最后 全部反转*/</span>   <span class="token keyword">void</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> l <span class="token operator">&lt;</span> r<span class="token punctuation">;</span> l<span class="token operator">++</span><span class="token punctuation">,</span>r<span class="token operator">--</span><span class="token punctuation">)</span>       <span class="token punctuation">&#123;</span>           <span class="token keyword">int</span> temp <span class="token operator">=</span> a<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">;</span>           a<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span>           a<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>   <span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>              <span class="token function">reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>n<span class="token operator">-</span>k<span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span></code></pre><hr></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 算法 </category>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小米青春版路由器解锁root与SSH方法</title>
      <link href="/posts/e5a81842/"/>
      <url>/posts/e5a81842/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h1>前期准备</h1><blockquote><p>小米路由器 x1; 宽带线x1(连接路由器和电脑),</p></blockquote><h1>思路</h1><blockquote><p>因为小米青春版路由器没有USB插口,只能通过先刷开发版,再通过开发版来开启ROOT和SSH</p></blockquote><h1>下载开发版本ROM包</h1><p><strong>版本(miwifi_r1cl_all_59371_2.1.26.bin)</strong></p><blockquote><p>更高版本已经修复了此方法,所以只能是此版本</p></blockquote><p><a href="http://bigota.miwifi.com/xiaoqiang/rom/r1cl/miwifi_r1cl_all_59371_2.1.26.bin">下载地址1:</a><br><a href="https://pan.baidu.com/s/1tAzoAZDvfvQGfSEsDYIe3A">百度W盘: </a> e2p6</p><h1>登录后台手动升级系统</h1><p>后台地址: <strong>192.168.1.1</strong><br>进入后台后,系统升级,手动选择,选择对应的ROM包,等待5-8分钟左右,路由器会自动升级,重启</p><h1>本地以太网设置手动IP地址为192.168.31.2</h1><p><img src="https://img-blog.csdnimg.cn/20200623222155119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200623222155119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><h1>进入后台192.168.31.1进行引导</h1><blockquote><p>此过程中会设置Wifi名称密码,以及管理员密码,<br>注意!: <strong>管理员密码很重要,后面会用到</strong></p></blockquote><h1>地址栏开启ROOT和ssh</h1><p><strong>进入后台后,浏览器地址内会出现<br><a href="http://192.168.31.1/cgi-bin/luci/;stok=09a506ee0b8e14d4acf3004a504eba4d/web/home#router">http://192.168.31.1/cgi-bin/luci/;stok=09a506ee0b8e14d4acf3004a504eba4d/web/home#router</a><br>这样的信息,</strong><br><img src="https://img-blog.csdnimg.cn/20200623222720539.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200623222720539.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br><strong>我们将URL中 /web/home#router 修改为/api/xqsystem/set_name_password?oldPwd=前面设置的管理员密码&amp;newPwd=新的管理员密码</strong></p><blockquote><p>注意:新密码与旧密码不能一致</p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200623223033744.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200623223033744.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br><strong>回车后:<br>如果成功则返回{“code”:0}, 如果是其他参数,请检查软件包是否为:59371_2.1.26</strong></p><h1>测试</h1><p>电脑连接路由器的情况下,控制台:</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">ssh</span> root@192.168.31.1</code></pre><p>第一次登录会提示存储密钥,yes即可</p>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 路由器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 路由器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小米青春版使用OpenWrt实现无线中继功能</title>
      <link href="/posts/57997d7/"/>
      <url>/posts/57997d7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h1>简介</h1><blockquote><p>因为小米路由器自带的后台无线功能太鸡肋了, 无法实现自定义设置DCHP,默认为DCHP分配IP,但是分配的IP地址和主路由器在同一个字段,当设备多时会造成IP冲突现象.所以将机器刷机成Openwrt后实现需要的功能</p></blockquote><h1>小米青春版OpenWrt刷机</h1><h2 id="一解锁SSH与Root">一解锁SSH与Root</h2><div class="story post-story"><p><strong>参考文章链接:<a href="https://blog.csdn.net/sizaif/article/details/106933093">小米青春版路由器解锁root与SSH方法</a></strong></p></div><h2 id="刷入OpenWrt包">刷入OpenWrt包</h2><div class="story post-story"><blockquote><p><strong>使用有线连接电脑和路由器</strong></p></blockquote><p><a href="http://downloads.openwrt.org/releases/19.07.3/targets/ramips/mt76x8/openwrt-19.07.3-ramips-mt76x8-miwifi-nano-squashfs-sysupgrade.bin">下载地址:</a></p><p><strong>1: 重命名包名为 1.bin<br>2: 将下载的文件拷贝到路由器中 /tmp目录下</strong><br>使用CMD控制台命令:<br>(<strong>为了方便,可以把文件放到我的文档里, ip地址应该为192.168.31.1, 如果第一次刷完机</strong>)<br>1:</p> <pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">scp</span> <span class="token number">1</span>.bin root@192.168.31.1:/tmp/</code></pre><p><img src="https://img-blog.csdnimg.cn/20200708232407257.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200708232407257.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br>3: 刷机</p><blockquote><p>进入路由器内部/tmp/目录下:</p></blockquote> <pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">ssh</span> root@192.168.31.1</code></pre><p><img src="https://img-blog.csdnimg.cn/20200708232659839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200708232659839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><blockquote><p>开始刷机</p></blockquote> <pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /tmp/mtd -r <span class="token function">write</span> <span class="token number">1</span>.bin firmware</code></pre><p><img src="https://img-blog.csdnimg.cn/2020070823284936.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/2020070823284936.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"><br>等待一会后路由器会重启 刷机完成</p><h1>浏览器进入路由器后台</h1><p><img src="https://img-blog.csdnimg.cn/202007082332522.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/202007082332522.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 路由器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 路由器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>二叉树题目算法题目整理(附代码)</title>
      <link href="/posts/cfa0d73d/"/>
      <url>/posts/cfa0d73d/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><blockquote><p>说明：<br>由个人整理，部分题目是王道的题目,已经经常会考的点。<br>因个人代码风格,已经stack和queue的代码实现不同,代码略有不同之处，<br>但总体思想是正确的<br>有错误之处,欢迎指出<br>by sizaif</p></blockquote><p>@<a href="%E4%BA%8C%E5%8F%89%E6%A0%91%E9%A2%98%E7%9B%AE%E7%AE%97%E6%B3%95%E6%95%B4%E7%90%86">TOC</a></p><h1>二叉树</h1><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/*** 树结构*/</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> x<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">Node</span> <span class="token operator">*</span>lson<span class="token punctuation">,</span><span class="token operator">*</span>rson<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Tree<span class="token punctuation">,</span><span class="token operator">*</span>BiTree<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Queue</span><span class="token punctuation">&#123;</span>    <span class="token comment">//自己构造队列</span>    BiTree <span class="token operator">*</span>x<span class="token punctuation">;</span>    <span class="token keyword">int</span> front<span class="token punctuation">;</span>    <span class="token keyword">int</span> rear<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">Initqueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        front<span class="token operator">=</span>rear<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        x <span class="token operator">=</span><span class="token punctuation">(</span>BiTree <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>MAX<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        front<span class="token operator">=</span><span class="token punctuation">(</span>front<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>MAX<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>rear<span class="token operator">-</span>front <span class="token operator">+</span>MAX<span class="token punctuation">)</span><span class="token operator">%</span>MAX<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    bool <span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>front<span class="token operator">==</span>rear<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Push_back</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rear<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>MAX<span class="token operator">==</span>front<span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        x<span class="token punctuation">[</span>rear<span class="token punctuation">]</span><span class="token operator">=</span>T<span class="token punctuation">;</span>        rear<span class="token operator">=</span><span class="token punctuation">(</span>rear<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>MAX<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    BiTree <span class="token function">Getfront</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>front<span class="token operator">==</span>rear<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        BiTree T<span class="token punctuation">;</span>        T <span class="token operator">=</span>  x<span class="token punctuation">[</span>front<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> T<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>queues<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Stack</span><span class="token punctuation">&#123;</span>     <span class="token comment">// 自己构造栈</span>    BiTree <span class="token operator">*</span>tt<span class="token punctuation">;</span>    <span class="token keyword">int</span> top<span class="token punctuation">;</span>    <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">InitStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        tt<span class="token operator">=</span> <span class="token punctuation">(</span> BiTree <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>n<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Tree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        top<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        size<span class="token operator">=</span>n<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    bool <span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>top<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> true<span class="token punctuation">;</span>        <span class="token keyword">return</span> false<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Push_back</span><span class="token punctuation">(</span>BiTree num<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        tt<span class="token punctuation">[</span>top<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>num<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>top<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>        top<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token comment">//num=x[--top];</span>    <span class="token punctuation">&#125;</span>    BiTree <span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>top<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> tt<span class="token punctuation">[</span>top<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// top</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>stacks<span class="token punctuation">;</span></code></pre>              </div>            </details><h2 id="1-采用下列方法之一建立二叉树的二叉链表：">1) 采用下列方法之一建立二叉树的二叉链表：</h2><div class="story post-story"><h3 id="a-输入完全二叉树的先序序列，用-代表虚结点（空指针），如ABD-CE-F-，建立二叉树的二叉链表。">a) 输入完全二叉树的先序序列，用#代表虚结点（空指针），如ABD###CE##F##，建立二叉树的二叉链表。</h3><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 先序建立 * @param T [description] */</span><span class="token keyword">void</span> <span class="token function">build_frist</span><span class="token punctuation">(</span>BiTree <span class="token operator">&amp;</span>T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> ch<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>ch<span class="token operator">==</span><span class="token string">'#'</span><span class="token punctuation">)</span>        T<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>    <span class="token punctuation">&#123;</span>        T<span class="token operator">=</span> new Tree <span class="token punctuation">;</span>        T<span class="token operator">-></span>x<span class="token operator">=</span>ch<span class="token punctuation">;</span>        <span class="token function">build_frist</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">build_frist</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h3 id="b-已知二叉树的先序遍历序列和中序遍历序列。">b) 已知二叉树的先序遍历序列和中序遍历序列。</h3><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [pre_mid_build 先序+中序建立二叉树] * @param Fi [先序] * @param In [中序] * @param l1 [先序左端下标] * @param h1 [先序右端下标] * @param l2 [中序左端下标] * @param h2 [中序右端下标] * 初始 l1 = l2 = 0 , h1 = h2 = n; */</span>BiTree <span class="token function">pre_mid_build</span><span class="token punctuation">(</span>BiTree Fi<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>BiTree In<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> l1<span class="token punctuation">,</span><span class="token keyword">int</span> h1<span class="token punctuation">,</span><span class="token keyword">int</span> l2<span class="token punctuation">,</span><span class="token keyword">int</span> h2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>BiTree T <span class="token operator">=</span> new Tree<span class="token punctuation">;</span>T<span class="token operator">-></span>data <span class="token operator">=</span> Fi<span class="token punctuation">[</span>l1<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> l2<span class="token punctuation">;</span>In<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>Fi<span class="token punctuation">[</span>l1<span class="token punctuation">]</span> <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> llen <span class="token operator">=</span> i <span class="token operator">-</span> l2<span class="token punctuation">;</span><span class="token keyword">int</span> rlen <span class="token operator">=</span> h2 <span class="token operator">-</span> i<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>llen<span class="token punctuation">)</span>T<span class="token operator">-></span>lchild <span class="token operator">=</span> <span class="token function">pre_mid_build</span><span class="token punctuation">(</span>Fi<span class="token punctuation">,</span>In<span class="token punctuation">,</span>l1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>l1<span class="token operator">+</span>llen<span class="token punctuation">,</span>l2<span class="token punctuation">,</span>l2<span class="token operator">+</span>llen<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span>T<span class="token operator">-></span>lchild <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>rlen<span class="token punctuation">)</span>T<span class="token operator">-></span>rchild <span class="token operator">=</span> <span class="token function">pre_mid_build</span><span class="token punctuation">(</span>Fi<span class="token punctuation">,</span>In<span class="token punctuation">,</span>h1<span class="token operator">-</span>rlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>h1<span class="token punctuation">,</span>h2<span class="token operator">-</span>rlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>h2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span>T<span class="token operator">-></span>rchild <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">return</span> T<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * 已知先序和中序 建立二叉树 * @param T  [description] * @param Fi [description] * @param In [description] * @param n  [description] */</span><span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span>BiTree <span class="token operator">&amp;</span>T<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>Fi<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>In<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        T<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>p<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>m<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> lson<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rson<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span> str1<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span>str2<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">mem</span><span class="token punctuation">(</span>lson<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">mem</span><span class="token punctuation">(</span>rson<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    T<span class="token operator">=</span> new Tree<span class="token punctuation">;</span>    T<span class="token operator">-></span>x<span class="token operator">=</span>Fi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>In<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span>Fi<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span>    l1<span class="token operator">=</span>i<span class="token punctuation">;</span> l2<span class="token operator">=</span>n<span class="token operator">-</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> temp<span class="token operator">=</span>i<span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;=</span>temp<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>        lson<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>Fi<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>temp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        rson<span class="token punctuation">[</span>j<span class="token operator">-</span>temp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>Fi<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        str2<span class="token punctuation">[</span>j<span class="token operator">-</span>temp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>In<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>temp<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>        str1<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>In<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lson<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        T<span class="token operator">-></span>lson<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">build</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>lson<span class="token punctuation">,</span>str1<span class="token punctuation">,</span>l1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rson<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        T<span class="token operator">-></span>rson<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        <span class="token function">build</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">,</span>rson<span class="token punctuation">,</span>str2<span class="token punctuation">,</span>l2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">frist_and_mid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"*****************************"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    BiTree T2<span class="token punctuation">;</span>    <span class="token keyword">char</span> str1<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span>str2<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">,</span>str3<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input of the first :\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input of the mid :\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>str2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">build</span><span class="token punctuation">(</span>T2<span class="token punctuation">,</span>str1<span class="token punctuation">,</span>str2<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"构造的二叉树 后序遍历为: \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">query</span><span class="token punctuation">(</span>T2<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"\n*****************************"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h3 id="c-已知二叉树的中序遍历序列和后序遍历序列，建立二叉树的二叉链表。">c) 已知二叉树的中序遍历序列和后序遍历序列，建立二叉树的二叉链表。</h3><pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"></code></pre></div><h2 id="2-写出对用二叉链表存储的二叉树进行先序、中序和后序遍历的递归算法">2) 写出对用二叉链表存储的二叉树进行先序、中序和后序遍历的递归算法</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 三种递归 1先序 2中序与 3后序 * @param T    [description] * @param oper [description] */</span><span class="token keyword">void</span> <span class="token function">query</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span><span class="token keyword">int</span> oper<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>oper<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>T<span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">query</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>oper<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>oper<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>T<span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">query</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">,</span>oper<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>oper<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>T<span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="3-写出对用二叉链表存储的二叉树进行先序遍历的非递归算法。">3) 写出对用二叉链表存储的二叉树进行先序遍历的非递归算法。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 非递归先序 * @param T [description] */</span><span class="token keyword">void</span> <span class="token function">query_frist</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    stacks S<span class="token punctuation">;</span>    S<span class="token punctuation">.</span><span class="token function">InitStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>            S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            BiTree Temp<span class="token punctuation">;</span>            Temp<span class="token operator">=</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>Temp<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="4-写出对用二叉链表存储的二叉树中序遍历的非递归算法。">4) 写出对用二叉链表存储的二叉树中序遍历的非递归算法。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 非递归中序 * @param T [description] */</span><span class="token keyword">void</span> <span class="token function">query_mid</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    stacks S<span class="token punctuation">;</span>    S<span class="token punctuation">.</span><span class="token function">InitStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            BiTree Temp<span class="token punctuation">;</span>            Temp<span class="token operator">=</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>Temp<span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>            S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>Temp<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="5-写出对用二叉链表存储的二叉树后序遍历的非递归算法。">5) 写出对用二叉链表存储的二叉树后序遍历的非递归算法。</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 非递归后序 * @param T [description] */</span><span class="token keyword">void</span> <span class="token function">query_last</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    stacks S<span class="token punctuation">;</span>    S<span class="token punctuation">.</span><span class="token function">InitStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>rson<span class="token punctuation">)</span>                S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>            <span class="token punctuation">&#123;</span>                BiTree  Temp<span class="token punctuation">;</span>                Temp<span class="token operator">=</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>Temp<span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>rson<span class="token operator">==</span>Temp<span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c "</span><span class="token punctuation">,</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>                    Temp<span class="token operator">=</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    S<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>S<span class="token punctuation">.</span><span class="token function">emptys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span>                    S<span class="token punctuation">.</span><span class="token function">Push_back</span><span class="token punctuation">(</span>S<span class="token punctuation">.</span><span class="token function">Gettop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * [PostOrder 后序遍历二叉树非递归] * @param T [Bitree] */</span><span class="token keyword">void</span> <span class="token function">PostOrder</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">InitStack</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span>BiTree p <span class="token operator">=</span> T<span class="token punctuation">;</span>BiTree r <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>p <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token comment">// 走到最左边</span><span class="token punctuation">&#123;</span> <span class="token function">Push</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>lchild<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">GetTop</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild <span class="token operator">&amp;&amp;</span> p<span class="token operator">-></span>rchild <span class="token operator">!=</span> r<span class="token punctuation">)</span> <span class="token comment">// 右子树存在且未被访问</span><span class="token punctuation">&#123;</span>p <span class="token operator">=</span> p<span class="token operator">-></span>rchild<span class="token punctuation">;</span> <span class="token comment">// 转向右</span><span class="token function">Push</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 入栈</span>p <span class="token operator">=</span> p<span class="token operator">-></span>lchild<span class="token punctuation">;</span> <span class="token comment">// 转向左</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">Pop</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">visit</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>r<span class="token operator">=</span> p <span class="token punctuation">;</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="6-写出对用二叉链表存储的二叉树进行层次遍历算法。">6) 写出对用二叉链表存储的二叉树进行层次遍历算法。</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826212154217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826212154217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [Invertlevel 层次遍历,自下而上,自左到右] * @param T [BiTree] * 二叉树自下而上,自左到右 * 正常层次遍历, 出队时入栈 * 最后依次出栈为结果 */</span><span class="token keyword">void</span> <span class="token function">Invertlevel</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Stack<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> S<span class="token punctuation">;</span>Queue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> Q<span class="token punctuation">;</span>BiTree p<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">InitQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">InitStack</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">EnQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span>Q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">DeQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">Push</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  出队,入栈</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>lchild<span class="token punctuation">)</span><span class="token function">EnQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>p<span class="token operator">-></span>lchild<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild<span class="token punctuation">)</span><span class="token function">EnQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>p<span class="token operator">-></span>rchild<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">Pop</span><span class="token punctuation">(</span>S<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">visit</span><span class="token punctuation">(</span>p<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自下而上,自左到右</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> </code></pre>              </div>            </details></div><h2 id="7-递归实现求二叉树的所有叶子数。">7) 递归实现求二叉树的所有叶子数。</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826212139288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826212139288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 求二叉树的所有叶子数] * @param T [description] */</span><span class="token keyword">void</span> <span class="token function">query_leaf</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> T<span class="token operator">-></span>rson <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">query_leaf</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">query_leaf</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="8-递归实现求二叉树的所有结点总数。">8) 递归实现求二叉树的所有结点总数。</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826212126863.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826212126863.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token keyword">int</span> <span class="token function">query_node</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token comment">// 节点总个数 </span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> T<span class="token operator">-></span>rson <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">query_node</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">query_node</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></div><h2 id="8-求二叉树第k层的结点个数">8+) 求二叉树第k层的结点个数</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826212110361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826212110361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 求二叉树第 k 层的结点个数 * 思想: 如图 * @param  T [description] * @param  k [第k层] * @return   [description] */</span><span class="token keyword">int</span> <span class="token function">query_levelk</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>k <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">query_levelk</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">query_levelk</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rsom<span class="token punctuation">,</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="9-判断完全二叉树">9) 判断完全二叉树</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826212024741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826212024741.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 判断完全二叉树  * @param  T [description] * @return   [description] */</span>bool <span class="token function">judge</span><span class="token punctuation">(</span>Bitree <span class="token operator">&amp;</span>T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//1 2 4 8 -1 -1 9 -1 -1 5 10 -1 -1 -1 3 6 -1 -1 7 -1 -1</span>    queue<span class="token operator">&lt;</span>Bitree<span class="token operator">></span>Q<span class="token punctuation">;</span>    Bitree pre<span class="token punctuation">;</span>    Q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>Q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        pre <span class="token operator">=</span> Q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pre<span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token punctuation">;</span>        Q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pre<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>Q<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        pre <span class="token operator">=</span> Q<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Q<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pre<span class="token punctuation">)</span>            <span class="token keyword">return</span> false<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> true<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="10-递归实现求-二叉树高度-深度">10) 递归实现求 二叉树高度(深度)</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826212011620.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826212011620.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 二叉树高度  * @param  T [description] * @return   [description] */</span><span class="token keyword">int</span> <span class="token function">deep_tree</span><span class="token punctuation">(</span>Bitree <span class="token operator">&amp;</span>T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token function">deep_tree</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> rig <span class="token operator">=</span> <span class="token function">deep_tree</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> left <span class="token operator">></span> rig  <span class="token operator">?</span> <span class="token punctuation">(</span>left<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span>rig<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="11-非递归求二叉树高度-深度-利用层次遍历">11) 非递归求二叉树高度(深度)(利用层次遍历)</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826211951688.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826211951688.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [BtDepth 非递归求二叉树高度] * @param T [BiTree] *  数组模拟队列,level 记录层数, *  每次层次遍历出队列时,与last指针比较,若两者相同,则层数+1; */</span><span class="token keyword">void</span> <span class="token function">BtDepth</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> front <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span> rear <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> last <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span> level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>BiTree Q<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">;</span>Q<span class="token punctuation">[</span><span class="token operator">++</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> T<span class="token punctuation">;</span>BiTree p<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>front <span class="token operator">&lt;=</span> rear<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    p <span class="token operator">=</span> Q<span class="token punctuation">[</span><span class="token operator">++</span>front<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>lchild<span class="token punctuation">)</span>    Q<span class="token punctuation">[</span><span class="token operator">++</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-></span>lchild<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild<span class="token punctuation">)</span>    Q<span class="token punctuation">[</span><span class="token operator">++</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-></span>rchild<span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>front <span class="token operator">==</span> last<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 该层最右结点</span>    level<span class="token operator">++</span><span class="token punctuation">;</span>    last <span class="token operator">=</span> rear<span class="token punctuation">;</span>  <span class="token comment">//  更新</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="11-孩子兄弟表示法求树的深度">11+) 孩子兄弟表示法求树的深度</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [Height_CS 孩子兄弟表示法求树的深度] * @param  T [description] * @return   [description] */</span><span class="token keyword">int</span> <span class="token function">Height_CS</span><span class="token punctuation">(</span>CSTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> hc<span class="token punctuation">,</span>hs<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>hc <span class="token operator">=</span> <span class="token function">Height_CS</span><span class="token punctuation">(</span>T<span class="token operator">-></span>fichild<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第一子树高</span>hs <span class="token operator">=</span> <span class="token function">Height_CS</span><span class="token punctuation">(</span>T<span class="token operator">-></span>nextchild<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 兄弟树高</span><span class="token keyword">return</span> hc<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">></span> hs <span class="token operator">?</span> hc<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">:</span> hs<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="12-判断平衡二叉数是否平衡">12) 判断平衡二叉数是否平衡</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [judge_AVL 判断二叉排序树,是否平衡] * @param T       [description] * @param balance [description] * @param h       [description] * balanc = 1 平衡, 0 不平衡 *  空树 , 仅有根节点,  平衡 */</span><span class="token keyword">void</span> <span class="token function">judge_AVL</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>balance <span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>h<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> bl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> br <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> hl <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span> hr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 空树 ,高度为 0 </span><span class="token punctuation">&#123;</span>h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> balance <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span>  T<span class="token operator">-></span>rchild <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 仅有根节点,  高度为1 </span><span class="token punctuation">&#123;</span>h <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> balance <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span><span class="token function">judge_AVL</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild<span class="token punctuation">,</span>bl<span class="token punctuation">,</span>h1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">judge_AVL</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rchild<span class="token punctuation">,</span>br<span class="token punctuation">,</span>h2<span class="token punctuation">)</span><span class="token punctuation">;</span>h <span class="token operator">=</span> <span class="token punctuation">(</span>hl<span class="token operator">></span> hr <span class="token operator">?</span> hl<span class="token operator">:</span>hr<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>hl<span class="token operator">-</span>hr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 高度差 小于2 </span>balance <span class="token operator">=</span> bl <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">;</span>  <span class="token comment">//逻辑与  当左右都平衡时, 平衡</span><span class="token keyword">else</span>balance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="13-递归实现求二叉树双分支节点树">13) 递归实现求二叉树双分支节点树</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c++" data-language="c++"><code class="language-c++">&#x2F;** * [DsonNode 递归实现求二叉树双分支节点树] * @param  T [二叉链表] * @return   [节点数] *&#x2F;int DsonNode(BiTree T)&#123;if(T&#x3D;&#x3D;NULL)return 0;else if(T-&gt;lchild !&#x3D;NULL &amp;&amp; T-&gt;rchild !&#x3D;NULL ) &#x2F;&#x2F; 左右孩子都有return DsonNode(T-&gt;lchild) + DsonNode(T-&gt;rchild) +1;elsereturn DsonNode(T-&gt;lchild) + DsonNode(T-&gt;rchild);&#125;</code></pre>              </div>            </details></div><h2 id="14-递归实现左右孩子互换">14) 递归实现左右孩子互换</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [Swap_child 递归实现左右孩子互换] * @param T [description] * 先换T结点 左子树左右孩子 * 再换右子树,  * 最后节点的孩子互换 */</span><span class="token keyword">void</span> <span class="token function">Swap_child</span><span class="token punctuation">(</span>Bitree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">Swap_child</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 先左子树</span><span class="token function">Swap_child</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rchild<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 右子树</span>Bitree temp <span class="token operator">=</span> T<span class="token operator">-></span>lchild<span class="token punctuation">;</span> <span class="token comment">// 左右孩子互换</span>T<span class="token operator">-></span>lchild <span class="token operator">=</span> T<span class="token operator">-></span>rchild<span class="token punctuation">;</span>T<span class="token operator">-></span>lchild <span class="token operator">=</span> temp<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="15-删除二叉树中每个元素值-为x的结点">15) 删除二叉树中每个元素值 为x的结点</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [Search 删除二叉树中每个元素值 为x的结点] * 并删去以他为根的子树 * @param T [description] * @param x [description] * 后序遍历二叉树, 层次遍历找到结点的父节点 */</span><span class="token keyword">void</span> <span class="token function">Search</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span>ElemType x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>BiTree Q<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>data <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">DeleteXTree</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>InitQueue Q<span class="token punctuation">;</span><span class="token function">EnQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span>Q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">DeQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>lchild<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 左非空</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>lchild<span class="token operator">-></span>data <span class="token operator">==</span> x<span class="token punctuation">)</span>  <span class="token comment">// 左子树符合, 删除左子树</span><span class="token punctuation">&#123;</span><span class="token function">DeleteXTree</span><span class="token punctuation">(</span>p<span class="token operator">-></span>lchild<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">-></span>lchild <span class="token operator">=</span>  <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span>  <span class="token comment">// 父节点左子树置为空</span><span class="token function">EnQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>p<span class="token operator">-></span>lchild<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//左子女入队列</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild<span class="token punctuation">)</span>  <span class="token comment">// 右子树符合, 删除右子树</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild<span class="token operator">-></span>data <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">DeleteXTree</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild<span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token operator">-></span>rchild <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token function">EnQueue</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>p<span class="token operator">-></span>rchild<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 右子女入队列</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="16-求先序遍历中第k个结点的值">16) 求先序遍历中第k个结点的值</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [PreNode 求先序遍历中第k个结点的值] * @param  Bt [description] * @param  k  [description] * @return    [description] */</span><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>ElemType <span class="token function">PreNode</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token string">'#'</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> count <span class="token operator">==</span> k<span class="token punctuation">)</span><span class="token keyword">return</span> T<span class="token operator">-></span>data<span class="token punctuation">;</span>count<span class="token operator">++</span><span class="token punctuation">;</span>ch <span class="token operator">=</span> <span class="token function">PreNode</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 左子树返回该值</span><span class="token keyword">if</span><span class="token punctuation">(</span>ch <span class="token operator">!=</span> <span class="token string">'#'</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token punctuation">;</span>ch <span class="token operator">=</span> <span class="token function">PreNode</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rchild<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 右子树递归查找</span><span class="token keyword">return</span> ch<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="17-求代权路径长度和">17) 求代权路径长度和</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [Wpl_preOreder 求代权路径长度和] * @param  T    [description] * @param  deep [description] * @return      [description] * 2014 408 真题 , 王道127页 */</span><span class="token keyword">int</span> <span class="token function">Wpl</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">Wpl_preOreder</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> wpl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">Wpl_preOreder</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span><span class="token keyword">int</span> deep<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> T<span class="token operator">-></span>rchild <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 叶节点 返回 wp</span>wpl <span class="token operator">+=</span> deep <span class="token operator">*</span> T<span class="token operator">-></span>data<span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token function">Wpl_preOreder</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lchild<span class="token punctuation">,</span>deep<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rchild <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token function">Wpl_preOreder</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rchild<span class="token punctuation">,</span>deep<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> wpl<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="18-求非空二叉树的宽度">18) 求非空二叉树的宽度</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [BTWidth 求非空二叉树的宽度] * @param  T [description] * @return   [description] * 层次遍历求所有点的层次,将所有节点和对应层次放在一个队列中 * 扫描队列,求最大层次节点总数 */</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span>BiTree data<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 存放指针</span><span class="token keyword">int</span> level<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//层次</span><span class="token keyword">int</span> front<span class="token punctuation">,</span>rear<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>Que<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">BTWidth</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>BiTree p<span class="token punctuation">;</span>Que<span class="token punctuation">.</span>front <span class="token operator">=</span> Que<span class="token punctuation">.</span>rear <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>Que<span class="token punctuation">.</span>rear <span class="token operator">++</span><span class="token punctuation">;</span>Que<span class="token punctuation">.</span>data<span class="token punctuation">[</span>Que<span class="token punctuation">.</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> T<span class="token punctuation">;</span> <span class="token comment">// 入队</span>Que<span class="token punctuation">.</span>level<span class="token punctuation">[</span>Que<span class="token punctuation">.</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 层次为1;</span><span class="token keyword">int</span> k<span class="token punctuation">,</span>Max<span class="token punctuation">,</span>n<span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>Que<span class="token punctuation">.</span>front <span class="token operator">&lt;</span> Que<span class="token punctuation">.</span>rear<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>Que<span class="token punctuation">.</span>front <span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 出队</span>p <span class="token operator">=</span> Que<span class="token punctuation">.</span>data<span class="token punctuation">[</span>Que<span class="token punctuation">.</span>front<span class="token punctuation">]</span><span class="token punctuation">;</span>k <span class="token operator">=</span> Que<span class="token punctuation">.</span>level<span class="token punctuation">[</span>Que<span class="token punctuation">.</span>front<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>lchlid <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 左孩子进队列</span><span class="token punctuation">&#123;</span>Que<span class="token punctuation">.</span>rear<span class="token operator">++</span><span class="token punctuation">;</span>Que<span class="token punctuation">.</span>data<span class="token punctuation">[</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-></span>lchlid<span class="token punctuation">;</span>Que<span class="token punctuation">.</span>level<span class="token punctuation">[</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span>  k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>rchild<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 右孩子进队列</span><span class="token punctuation">&#123;</span>Que<span class="token punctuation">.</span>rear<span class="token operator">++</span><span class="token punctuation">;</span>Que<span class="token punctuation">.</span>data<span class="token punctuation">[</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-></span>rchlid<span class="token punctuation">;</span>Que<span class="token punctuation">.</span>level<span class="token punctuation">[</span>rear<span class="token punctuation">]</span> <span class="token operator">=</span>  k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>Max <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span> i <span class="token operator">&lt;</span> Que<span class="token punctuation">.</span>rear<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>Que<span class="token punctuation">.</span>rear <span class="token operator">&amp;&amp;</span> Que<span class="token punctuation">.</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 统计第k曾节点数</span>        n<span class="token operator">++</span><span class="token punctuation">;</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    k <span class="token operator">=</span> Que<span class="token punctuation">.</span>level<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span> n <span class="token operator">></span> Max<span class="token punctuation">)</span>    Max <span class="token operator">=</span> n<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> Max<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="19-判断两颗二叉树是否结构相同">19) 判断两颗二叉树是否结构相同</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826211709293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826211709293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [判断两个二叉树结构是否相等] * @param  T1 [description] * @param  T2 [description] * @return    [description] */</span><span class="token keyword">int</span> <span class="token function">isEqual</span><span class="token punctuation">(</span>BiTree T1<span class="token punctuation">,</span>BiTree T2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>T1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>T2<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>T1 <span class="token operator">||</span> <span class="token operator">!</span>T2<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token function">isEqual</span><span class="token punctuation">(</span> T1<span class="token operator">-></span>lson<span class="token punctuation">,</span>T2<span class="token operator">-></span>lson<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isEqual</span><span class="token punctuation">(</span>T1<span class="token operator">-></span>rson<span class="token punctuation">,</span>T2<span class="token operator">-></span>rson<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="20-求两个结点的最低-近-公共祖先结点">20) 求两个结点的最低(近)公共祖先结点</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826211723957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826211723957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [求两个结点的最低公共祖先结点] * @param  T [description] * @param  A [description] * @param  B [description] * @return   [description] */</span>BiTree <span class="token function">lowAnc</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span>BiTree A<span class="token punctuation">,</span>BiTree B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>T<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> T <span class="token operator">==</span> A <span class="token operator">||</span> T <span class="token operator">==</span> B<span class="token punctuation">)</span> <span class="token keyword">return</span> T<span class="token punctuation">;</span> <span class="token comment">// 说明在某左子树或右子树中找到目标结点</span>BiTree left <span class="token operator">=</span> <span class="token function">lowAnc</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>BiTree right <span class="token operator">=</span> <span class="token function">lowAnc</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 当在左子树和右子树中都找到A,B 说明是最近的公共祖先</span><span class="token keyword">if</span><span class="token punctuation">(</span> left <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> T<span class="token punctuation">;</span>    <span class="token comment">//对一个底层向上更新的根结点来说，只在左子树或右子树找到了目标结点，则返回找到的结点。</span><span class="token keyword">return</span> <span class="token operator">!</span>left <span class="token operator">?</span> right<span class="token operator">:</span>left<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="20-求任意两结点距离">20+) 求任意两结点距离</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826211737387.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826211737387.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * [求两个结点的最低公共祖先结点] * @param  T [description] * @param  A [description] * @param  B [description] * @return   [description] */</span>BiTree <span class="token function">lowAnc</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span>BiTree A<span class="token punctuation">,</span>BiTree B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>T<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> T <span class="token operator">==</span> A <span class="token operator">||</span> T <span class="token operator">==</span> B<span class="token punctuation">)</span> <span class="token keyword">return</span> T<span class="token punctuation">;</span> <span class="token comment">// 说明在某左子树或右子树中找到目标结点</span>BiTree left <span class="token operator">=</span> <span class="token function">lowAnc</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>BiTree right <span class="token operator">=</span> <span class="token function">lowAnc</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> left <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> right <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token comment">// 当在左子树和右子树中都找到A,B 说明是最近的公共祖先</span><span class="token keyword">return</span> T<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token operator">!</span>left <span class="token operator">?</span> right<span class="token operator">:</span>left<span class="token punctuation">;</span> <span class="token comment">//对一个底层向上更新的根结点来说，只在左子树或右子树找到了目标结点，则返回找到的结点。</span><span class="token punctuation">&#125;</span><span class="token comment">/** * [求最近公共祖先到目标p的距离] * @param  T [description] * @param  p [description] * @return   [description] */</span><span class="token keyword">int</span> <span class="token function">CalDistance</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span>BiTree p<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>T <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> T <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 先在左子树找</span><span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">CalDistance</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果未找到,在右子树中找</span><span class="token keyword">if</span><span class="token punctuation">(</span> res <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>res <span class="token operator">=</span> <span class="token function">CalDistance</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 找到, 距离+1 </span><span class="token keyword">if</span><span class="token punctuation">(</span> res <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">return</span> res <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 如果带权值, 这里改成+权值</span><span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/** * [求树中A-B的距离] * @param  T [description] * @param  A [description] * @param  B [description] * @return   [description] */</span><span class="token keyword">int</span> <span class="token function">Dis_A_B</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span>BiTree A<span class="token punctuation">,</span>BiTree B<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//找到最低公共祖先结点</span>BiTree lowanc <span class="token operator">=</span> <span class="token function">lowAnc</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 求最近最近公共祖先结点到两目标结点的距离之和</span><span class="token keyword">return</span>  <span class="token function">CalDistance</span><span class="token punctuation">(</span>lowanc<span class="token punctuation">,</span>A<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">CalDistance</span><span class="token punctuation">(</span>lowanc<span class="token punctuation">,</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="20-找出二叉树中某个结点的所有祖先结点">20++) 找出二叉树中某个结点的所有祖先结点</h2><div class="story post-story"><p><img src="https://img-blog.csdnimg.cn/20200826211751339.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/20200826211751339.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NpemFpZg==,size_16,color_FFFFFF,t_70#pic_center" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="在这里插入图片描述"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><div class="caption"><span>++</span></div><code class="language-c"><span class="token comment">/** * 找出二叉树中某个结点的所有祖先结点 * @param  T [description] * @param  A [description] * @return   [description] */</span><span class="token keyword">int</span> <span class="token function">FindAllAnc</span><span class="token punctuation">(</span>BiTree T<span class="token punctuation">,</span> BiTree A<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 未找到</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span>T <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//  找到目标结点</span><span class="token keyword">if</span><span class="token punctuation">(</span>　T <span class="token operator">==</span> A<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 如果在左子树或右子树中找到输出此祖先结点</span><span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">FindAllAnc</span><span class="token punctuation">(</span>T<span class="token operator">-></span>lson<span class="token punctuation">,</span>A<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">FindAllAnc</span><span class="token punctuation">(</span>T<span class="token operator">-></span>rson<span class="token punctuation">,</span>A<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 或者其他操作</span>cout<span class="token operator">&lt;&lt;</span>T<span class="token operator">-></span>data<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 算法 </category>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot项目打包并发布到linux线上详细记录全过程,详细!</title>
      <link href="/posts/48019f05/"/>
      <url>/posts/48019f05/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><p>@<a href="%E8%BF%99%E9%87%8C%E5%86%99%E7%9B%AE%E5%BD%95">TOC</a></p><h1>前期准备</h1><ol><li>一台线上linux服务器.阿里云,腾讯云,华为云或者国外的vps都可以</li><li>ssh工具,像xshell,putty</li><li>sftp传输工具,像filezilla. 传输jar包文件</li><li>java jdk linux 安装包, 官网即可下载</li></ol><h1>使用Maven打包项目</h1><h2 id="处理静态文件以及端口号">处理静态文件以及端口号</h2><div class="story post-story"><blockquote><p>如果引入了外部文件,像upload上传图片的功能, 需要设置目录为linux目录<br>一般在windows上开发,windows和linux不一样</p></blockquote><h3 id="application-yml配置">application.yml配置</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092536.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092536.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092531985"></p><h3 id="MVCconfig">MVCconfig</h3><blockquote><p>写个java iimplements  WebMvcConfigurer</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092523.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092523.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092520181"></p></blockquote><pre class="language-java" data-language="java"><code class="language-java"> <span class="token comment">//    接入虚拟路径（解决重启服务器才显示图片的问题）</span> <span class="token comment">// 拦截本地路径</span> <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;web.upload-path&#125;"</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span> <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// addResourceHandler: （ 存储图片的虚拟路径，在 static 目录下的 picture 文件夹，用于存储上传图片）</span>     <span class="token comment">// addResourceLocations: （ file: + 存储图片的路径）    </span>     registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">"/images/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span><span class="token string">"file:"</span><span class="token operator">+</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></code></pre></div><h2 id="打包">打包</h2><div class="story post-story"><p>步骤:</p><blockquote><p>忽略掉test测试,防止发布到线上出现各种问题</p></blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092511.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092511.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092505953"></p><blockquote><p>成功后会在target目录下生成</p></blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092457.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092457.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092451400"></p><blockquote><p>版本号与pom.xml 中version有关</p></blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092442.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092442.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092441767"></p><h1>安装JDK</h1><p>参考文章: <a href="https://blog.csdn.net/sizaif/article/details/106106955">linux安装java1.8 jdk并配置环境变量</a></p><blockquote><p>像阿里云和腾讯云需要配置安全组,</p></blockquote><p>参考连接:<a href="https://help.aliyun.com/document_detail/25471.html">阿里云安全组配置方法</a></p><h1>将jar包传输到linux服务器上</h1><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092407.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092407.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092406021"></p><h1>java运行jar包</h1><blockquote><p>为了方便,写一个start.sh脚本 方便日后更新版本执行</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> start.sh<span class="token function">nohup</span> java -jar emsdemo-0.1.8-SNAPSHOT.jar <span class="token operator">></span>springboot.log <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span class="token function">chmod</span> +x start.sh</code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092420.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092420.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092418809"></p><blockquote><p>运行  并查看运行日志</p></blockquote><pre class="language-shell" data-language="shell"><code class="language-shell">./start.sh<span class="token function">cat</span> springboot.log </code></pre><p>然后在浏览器输入你的<strong>ip:端口号</strong>就可以访问了</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092334.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092334.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092332928"></p><h1>额外:使用域名访问</h1><blockquote><p>如果我想通过域名直接访问项目,不想用ip+ 端口号的方式</p></blockquote><p>==<strong><strong>国内的服务器域名绑定需要备案,国外不用</strong></strong>==</p><blockquote><p>思路:<br>==默认域名绑定80端口,所以<strong>使用nginx 端口转发功能</strong>==</p></blockquote></div><h2 id="安装nginx">安装nginx</h2><div class="story post-story"><p>如果不想手动安装,安装宝塔,用宝塔安装和配置<br>宝塔安装:<a href="https://www.bt.cn/bbs/thread-19376-1-1.html">linux安装宝塔</a></p><h3 id="配置nginx">配置nginx</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092311.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092311.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092308964"></p><pre class="language-conf" data-language="conf"><code class="language-conf">server   &#123;       listen 80;       #server_name phpmyadmin;       #index index.html index.htm index.php;       #root  &#x2F;www&#x2F;server&#x2F;phpmyadmin;       #error_page   404   &#x2F;404.html;       #include enable-php.conf;       location &#x2F; &#123;            proxy_pass http:&#x2F;&#x2F;sizaif.com:8080;       &#125;   &#125;</code></pre><p>然后relod nginx 过一会通过域名就可以访问了</p></div><h2 id="效果">效果</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092610.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092610.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092608387"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Java </category>
          
          <category> Springboot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot项目图片文件的上传与显示</title>
      <link href="/posts/38a7ff2/"/>
      <url>/posts/38a7ff2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>需求分析</h1><p>在个人信息页面点击图片上传,上传文件到后台后,并修改图片的名称,设置为<br>唯一的名称,并同步跟新图片名称到数据库中</p><h1>数据库设计</h1><p>我的数据库中: Users存放用户名和密码, Member 存放用户详细信息(包括图片)</p><h1>配置application.yml</h1><p>设置自定义的文件上传目录:</p><pre class="language-yml" data-language="yml"><code class="language-yml"><span class="token comment"># 自定义文件上传路径</span><span class="token key atrule">web</span><span class="token punctuation">:</span>  <span class="token comment"># Linux</span>  <span class="token comment"># upload-path: /root/emsdemo/image</span>  <span class="token comment"># Windows 10</span>  <span class="token key atrule">upload-path</span><span class="token punctuation">:</span> C<span class="token punctuation">:</span>/Users/SIZ/Desktop/bishe/image/</code></pre><h1>后台代码</h1><h2 id="控制代码">控制代码</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;web.upload-path&#125;"</span><span class="token punctuation">)</span><span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/users/doUpload/&#123;uid&#125;"</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">UploadImage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"imgfile"</span><span class="token punctuation">)</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">/**     * header_img_url是从数据库里捞的，要和你本地或者线上的专门放图片的文件夹里的文件去匹配，     * 如果一开始我捞了数据库的头像，发现这个已经存在文件夹里了，那我需要换头像的时候，     * 就需要找文件夹里有没有和这一模一样的文件，很明显是有的，因为不管换不换头像之前，     * 我这个头像一定是保存在数据库字段里面，并且也在文件夹里面，此时我要更换头像了，     * 那我肯定要把文件的这个头像文件删掉并把新上传的头像文件加进来，不存历史记录，     * 防止越来越多的头像占内存，并且，我要把这条记录插到数据库里面，，相当于更新了头像。     */</span>    <span class="token comment">// 获取当前用户</span>    <span class="token class-name">Subject</span> currentUser <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Users</span> curru <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Users</span><span class="token punctuation">)</span> currentUser<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"currenttUser.ID--> "</span> <span class="token operator">+</span> curru<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     * 根据User.id  拿到member 全部信息     */</span>    <span class="token class-name">Member</span> member <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">memberService<span class="token punctuation">.</span></span>QueryOneMemberInfoByID</span><span class="token punctuation">(</span>curru<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     *  获取数据库中当前用户的照片     *  若存在则删除,替换     */</span>    <span class="token class-name">File</span> sqlfile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Boolean</span> isExits <span class="token operator">=</span> sqlfile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>isExits<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        sqlfile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//得到将要上传的文件名</span>    <span class="token class-name">String</span> fileName <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//设置文件上传，并且设置了新的唯一名字XXXXX.jpg</span>    <span class="token class-name">String</span> newFileName <span class="token operator">=</span> <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> path<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/**     *  连接数据库进行进行更新     */</span>    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> memberMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    memberMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span>newFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>    memberMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SystemResult</span> systemResult <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">memberService<span class="token punctuation">.</span></span>UpdateMemberInfo</span><span class="token punctuation">(</span>memberMap<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>systemResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 失败</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>systemResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 成功</span>        <span class="token comment">/**         *  更新到IndexDto 中         */</span>        <span class="token class-name">Member</span> afterUpdateImageMember <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">memberService<span class="token punctuation">.</span></span>QueryOneMemberInfoByID</span><span class="token punctuation">(</span>curru<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">IndexDto</span> indexDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UsersServiceAppoint<span class="token punctuation">.</span>WriteUsersInfoToDto</span><span class="token punctuation">(</span>indexDto<span class="token punctuation">,</span>curru<span class="token punctuation">,</span>afterUpdateImageMember<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Session</span> session <span class="token operator">=</span>  currentUser<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">HttpSession</span> httpSession <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        httpSession<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"IndexDto"</span><span class="token punctuation">,</span>indexDto<span class="token punctuation">)</span><span class="token punctuation">;</span>        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"IndexDto"</span><span class="token punctuation">,</span>indexDto<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"进行了图片上传功能,并更新到数据库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>systemResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     *  重定向到--->个人信息页面     */</span>    <span class="token keyword">return</span> <span class="token string">"redirect:/users/toProfilesPage/"</span><span class="token operator">+</span> id<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="FileUtils代码">FileUtils代码</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>sizaif<span class="token punctuation">.</span>emsdemo<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span></span><span class="token class-name">MultipartFile</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUtils</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/**     * 唯一识别的UUID     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 获取文件后缀     * @param fileName     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getSuffix</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 和随机的UUID生成新的文件名     * @param fileOriginName     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileOriginName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">getUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">getSuffix</span><span class="token punctuation">(</span>fileOriginName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/**     * 保存文件到本地,并返回新的唯一文件名     * @param file 文件     * @param path 文件存放路径     * @param fileName 文件名字     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">String</span> fileName<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token class-name">String</span> newFileName <span class="token operator">=</span> <span class="token function">getFileName</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 生成新的文件名</span>        <span class="token class-name">String</span> realPath <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> newFileName<span class="token punctuation">;</span>        <span class="token class-name">File</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>realPath<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//判断文件父目录是否存在</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dest<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            dest<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>            <span class="token comment">//保存文件</span>            file<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> newFileName<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div><h2 id="MVCConfig设置">MVCConfig设置</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-java" data-language="java"><code class="language-java">新建<span class="token class-name">MyMvcConfig</span><span class="token punctuation">.</span>java <span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//    接入虚拟路径（解决重启服务器才显示图片的问题）</span>    <span class="token comment">// 拦截本地路径</span>    <span class="token comment">// 前端代码只需要设置成到/images/目录下拿图片,</span>   <span class="token comment">// 便可以自动到自己设置的path目录下拿图片</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;web.upload-path&#125;"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">// addResourceHandler: （ 存储图片的虚拟路径，在 static 目录下的 picture 文件夹，用于存储上传图片）</span>        <span class="token comment">// addResourceLocations: （ file: + 存储图片的路径）</span>        registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">"/images/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceLocations</span><span class="token punctuation">(</span><span class="token string">"file:"</span> <span class="token operator">+</span>path <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h1>前端代码</h1></div><h2 id="上传代码">上传代码</h2><div class="story post-story"><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@&#123;/users/doUpload/&#125; + $&#123;ProfilesInfo.getId()&#125;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success <span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>imgfile<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fa  fa-image m-right-xs<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">></span></span>修改照片<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>input</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tn btn-success<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>上传<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre></div><h2 id="显示代码">显示代码</h2><div class="story post-story"><p>${ProfilesInfo.getImage()} 拿到的是数据库中图片的名字</p><pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>img-responsive avatar-view<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@&#123;/images/&#125;+$&#123;ProfilesInfo.getImage()&#125;<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Avatar<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Change the avatar<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value javascript language-javascript"><span class="token function">F_Open_dialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Java </category>
          
          <category> Springboot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SEAL学习第四天-Ckks_basics</title>
      <link href="/posts/51f3b771/"/>
      <url>/posts/51f3b771/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>SEAL 学习第四天： ckks_basics</h1><p>@[toc]</p><h2 id="简介说明">简介说明</h2><div class="story post-story"><p>通常一个好的策略是为CKKS选择参数方案如下:</p><pre><code>    (1) 选择一个60位素数作为coeff_modulus中的第一个素数.这将解密时给出最高的精度;     (2) 选择另一个60位素数作为coeff_modulus的最后一个元素，,同时这将被用作特殊的素数，应该与其他质数中最大的一样打；    (3) 选择中间素数彼此接近</code></pre><p>我们使用CoeffModulus::Create来生成适当大小的素数。请注意我们的coeff_modulus是200位的总和，这低于</p><p>poly_modulus_degree: CoeffModulus::MaxBitCount(8192)返回218。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093248.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093248.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093247166"></p></div><h2 id="scale">scale</h2><div class="story post-story"><p>比例增大输入的浮点系数数据</p><p>即使在纯文本元素的CKKS方案基本上是多项式的整数系数  x^n</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093239.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093239.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093238121"></p><p>编码的位精度;自然会影响精度结果。</p><p>所以设置一个放大比例系数是很有必要的。</p><p>有了scale 必然有rescale</p></div><h2 id="rescale">rescale</h2><div class="story post-story"><p>通常在乘法后执行</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093231.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093231.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093229431"></p><p>目的: 乘法后： scale =  scale + scale = 2*scale 即   $ \Delta^{2}\to \Delta  $</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093221.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093221.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093220619"></p><table><thead><tr><th>函数调用</th><th>参数类型</th><th>解释说明</th></tr></thead><tbody><tr><td>evaluator.rescale_to_next_inplace(Ciphertext)</td><td>Ciphertext</td><td>重新调整scale比例系数接近于初始设置的值，接近但不是等于</td></tr><tr><td>double scale = pow(2.0, 40);</td><td>int</td><td>定义一个2^40 的scale 比例系数</td></tr><tr><td></td><td></td><td></td></tr></tbody></table></div><h2 id="Encoding-Decoding">Encoding &amp; Decoding</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093210.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093210.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093209543"></p></div><h2 id="计算">计算</h2><div class="story post-story"><p>对于多项式 不同的计算顺序消耗的噪声预算以及性能不同</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093201.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093201.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093200182"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093151.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093151.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093149879"></p><p>在这个样例中:</p><p>求   $F(x) = \pi * x^{3}  + 0.4 * x +1$</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093137.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093137.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093136655"></p><pre class="language-c" data-language="c"><code class="language-c">Plaintext plain_coeff3<span class="token punctuation">,</span> plain_coeff1<span class="token punctuation">,</span> plain_coeff0<span class="token punctuation">;</span><span class="token comment">// 编码</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token number">3.14159265</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain_coeff3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// PI</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain_coeff1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.4</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain_coeff0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span><span class="token comment">// x^2</span>evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>x1_encrypted<span class="token punctuation">,</span> x3_encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x3_encrypted = x1_encrypted * x1_encrypted</span>evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>x3_encrypted<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rescale_to_next_inplace</span><span class="token punctuation">(</span>x3_encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新调整scale 规模</span><span class="token comment">// PI * x</span>evaluator<span class="token punctuation">.</span><span class="token function">multiply_plain</span><span class="token punctuation">(</span>x1_encrypted<span class="token punctuation">,</span> plain_coeff3<span class="token punctuation">,</span> x1_encrypted_coeff3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// x1_encrypted_coeff3 = x1_encrypted * plain_coeff3</span>evaluator<span class="token punctuation">.</span><span class="token function">rescale_to_next_inplace</span><span class="token punctuation">(</span>x1_encrypted_coeff3<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 0.4*x</span>evaluator<span class="token punctuation">.</span><span class="token function">multiply_plain_inplace</span><span class="token punctuation">(</span>x1_encrypted<span class="token punctuation">,</span> plain_coeff1<span class="token punctuation">)</span><span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rescale_to_next_inplace</span><span class="token punctuation">(</span>x1_encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>然后就可以三项之和；然而,有一个严重的问题是:</p><p>​这三个术语使用的加密参数都是不同是由于模数从缩放转换而来。</p><p>​而加密的加法和减法要求输入的level为相同并且加密参数(parms_id)匹配。</p><p>​如果有不匹配时，求值器将抛出异常。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093126.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093126.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093125056"></p><p>我们验证可以发现三者的level是不一样的</p><p>在这个样例中 level的变化过程</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token operator">-</span> Product x<span class="token operator">^</span><span class="token number">2</span> has scale <span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span> and is at level <span class="token number">2</span><span class="token punctuation">;</span><span class="token operator">-</span> Product PI<span class="token operator">*</span>x has scale <span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span> and is at level <span class="token number">2</span><span class="token punctuation">;</span><span class="token operator">-</span> We rescaled both down to scale <span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span><span class="token operator">/</span>P_2 and level <span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">-</span> Product PI<span class="token operator">*</span>x<span class="token operator">^</span><span class="token number">3</span> has <span class="token function">scale</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span><span class="token operator">/</span>P_2<span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token operator">-</span> We rescaled it down to <span class="token function">scale</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span><span class="token operator">/</span>P_2<span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span>P_1 and level <span class="token number">0</span><span class="token punctuation">;</span><span class="token operator">-</span> Product <span class="token number">0.4</span><span class="token operator">*</span>x has scale <span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span><span class="token punctuation">;</span><span class="token operator">-</span> We rescaled it down to scale <span class="token number">2</span><span class="token operator">^</span><span class="token number">80</span><span class="token operator">/</span>P_2 and level <span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">-</span> The contant term <span class="token number">1</span> has scale <span class="token number">2</span><span class="token operator">^</span><span class="token number">40</span> and is at level <span class="token number">2.</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093117.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093117.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093116370"></p><p>三者的scale 虽然接近，但也是不一样的</p><p>这里有几种方法来解决这个scale问题</p><ol><li><p>既然P_2和P_1非常接近2 ^ 40,我们可以简单欺骗 Microsoft SEAL，把scale 设置成一样的，因为以及非常接近2^40</p><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 重新设置两者的scale</span>x3_encrypted<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    x1_encrypted<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>另一种方法就是将1 编码成 2^80/P_2 在做一个 multiply_plain 将level降到与0.4*x 保持一致</p></li></ol><p>解决掉上面的问题后我们还有加密参数不匹配的问题。这是很容易的通过使用modulus switching (no rescaling) 来解决</p><p>CKKS支持modulus switching就像BFV格式一样、</p><pre class="language-c" data-language="c"><code class="language-c">cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Normalize encryption parameters to the lowest level."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>parms_id_type last_parms_id <span class="token operator">=</span> x3_encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_inplace</span><span class="token punctuation">(</span>x1_encrypted<span class="token punctuation">,</span> last_parms_id<span class="token punctuation">)</span><span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_inplace</span><span class="token punctuation">(</span>plain_coeff0<span class="token punctuation">,</span> last_parms_id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>到现在这三种密文现在都是兼容的，可以进行add运算了</p><pre class="language-c" data-language="c"><code class="language-c">cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute PI*x^3 + 0.4*x + 1."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>Ciphertext encrypted_result<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x3_encrypted<span class="token punctuation">,</span> x1_encrypted<span class="token punctuation">,</span> encrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">add_plain_inplace</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">,</span> plain_coeff0<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>结果验证:</p><p>输出一个真的，然后将加密的解密解码，做对比验证</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093101.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093101.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093100409"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c">Plaintext plain_result<span class="token punctuation">;</span><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt and decode PI*x^3 + 0.4x + 1."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Expected result:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> true_result<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> input<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">double</span> x <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    true_result<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3.14159265</span> <span class="token operator">*</span> x <span class="token operator">*</span> x <span class="token operator">+</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token operator">*</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">print_vector</span><span class="token punctuation">(</span>true_result<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*    Decrypt, decode, and print the result. */</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> result<span class="token punctuation">;</span>encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Computed result ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token function">print_vector</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>              </div>            </details><h1>源代码</h1><details green><summary> code </summary>              <div class='content'>              <pre class="language-C++" data-language="C++"><code class="language-C++">#include &quot;examples.h&quot;using namespace std;using namespace seal;void example_ckks_basics() &#123;print_example_banner(&quot;Example: CKKS Basics&quot;);&#x2F;*In this example we demonstrate evaluating a polynomial functionPI*x^3 + 0.4*x + 1on encrypted floating-point input data x for a set of 4096 equidistant pointsin the interval [0, 1]. This example demonstrates many of the main featuresof the CKKS scheme, but also the challenges in using it.We start by setting up the CKKS scheme.*&#x2F;EncryptionParameters parms(scheme_type::ckks);size_t poly_modulus_degree &#x3D; 8192;  &#x2F;&#x2F;long long unsigned intparms.set_poly_modulus_degree(poly_modulus_degree);parms.set_coeff_modulus(CoeffModulus::Create(poly_modulus_degree, &#123; 60, 40, 40, 60 &#125;));&#x2F;** 我们选择初始比例为2^40 * this leaves us 60-40&#x3D;20 bits of precision before the decimal point, and enough (roughly    10-20 bits) of precision after the decimal point. Since our intermediate    primes are 40 bits (in fact, they are very close to 2^40), we can achieve    scale stabilization as described above.*&#x2F;double scale &#x3D; pow(2.0, 40);SEALContext context(parms);print_parameters(context);cout &lt;&lt; endl;KeyGenerator keygen(context);auto secret_key &#x3D; keygen.secret_key();PublicKey public_key;keygen.create_public_key(public_key);RelinKeys relin_keys;keygen.create_relin_keys(relin_keys);GaloisKeys galois_keys;keygen.create_galois_keys(galois_keys);Encryptor encryptor(context, public_key);Evaluator evaluator(context);Decryptor decryptor(context, secret_key);CKKSEncoder encoder(context);size_t slot_count &#x3D; encoder.slot_count();cout &lt;&lt; &quot;Number of slots: &quot; &lt;&lt; slot_count &lt;&lt; endl;vector&lt;double&gt; input;input.reserve(slot_count); &#x2F;&#x2F; 申请空间double curr_point &#x3D; 0;&#x2F;&#x2F;static_cast&lt;double&gt; 将size_t 转成成double 在运算double step_size &#x3D; 1.0 &#x2F; (static_cast&lt;double&gt;(slot_count) - 1); &#x2F;&#x2F; for (size_t i &#x3D; 0; i &lt; slot_count; i++)&#123;input.push_back(curr_point);curr_point +&#x3D; step_size;&#125;cout &lt;&lt; &quot;Input vector: &quot; &lt;&lt; endl;print_vector(input,3,7); &#x2F;&#x2F; 打印vector 前3 项后3项,  保留小数点后7位cout &lt;&lt; &quot;Evaluating polynomial PI*x^3 + 0.4x + 1 ...&quot; &lt;&lt; endl;Plaintext plain_coeff3, plain_coeff1, plain_coeff0;&#x2F;&#x2F; 编码encoder.encode(3.14159265, scale, plain_coeff3);encoder.encode(0.4, scale, plain_coeff1);encoder.encode(1.0, scale, plain_coeff0);Plaintext x_plain;print_line(__LINE__);cout &lt;&lt; &quot;Encode input vectors.&quot; &lt;&lt; endl;encoder.encode(input, scale, x_plain);&#x2F;&#x2F; 加密Ciphertext x1_encrypted;encryptor.encrypt(x_plain, x1_encrypted);&#x2F;** 为了计算x^3，我们首先计算x^2并重新线性化。然而，scale已经现在变成了2的80次方。*&#x2F;&#x2F;&#x2F; x^2Ciphertext x3_encrypted;print_line(__LINE__);cout &lt;&lt; &quot;Compute x^2 and relinearize:&quot; &lt;&lt; endl;evaluator.square(x1_encrypted, x3_encrypted); &#x2F;&#x2F; x3_encrypted &#x3D; x1_encrypted * x1_encryptedevaluator.relinearize_inplace(x3_encrypted, relin_keys);cout &lt;&lt; &quot;    + Scale of x^2 before rescale: &quot; &lt;&lt; log2(x3_encrypted.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;&#x2F;** 现在重新调节;rescale* 除了modulus switch 方法外，scale 减少的系数等于被转移的质数（40位质数）* 因此,新的比例尺应该接近2^40。然而，scale !&#x3D; 2^40 :这是因为40位素数只是接近2^40。* *&#x2F;print_line(__LINE__);cout &lt;&lt; &quot;Rescale x^2.&quot; &lt;&lt; endl;evaluator.rescale_to_next_inplace(x3_encrypted); &#x2F;&#x2F; 重新调整scale 规模cout &lt;&lt; &quot;    + Scale of x^2 after rescale: &quot; &lt;&lt; log2(x3_encrypted.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;&#x2F;** 现在x3_encrypted与x1_encrypted处于不同的级别* 这阻止了我们 x3_encrypted*x1_encrypted 来计算x^3* 因此通过modulus switch 链 将x1_encrypted 切换到与x3_encrypted 同一级别,* 但又需要计算PI* x^3  所以 我们先计算 PI*x  然后调整scale 从2^80 -&gt; 2^40 * 然后在计算 Pi*x * x^2 * *&#x2F;print_line(__LINE__);&#x2F;&#x2F; PI * xcout &lt;&lt; &quot;Compute and rescale PI*x.&quot; &lt;&lt; endl;Ciphertext x1_encrypted_coeff3;evaluator.multiply_plain(x1_encrypted, plain_coeff3, x1_encrypted_coeff3);&#x2F;&#x2F; x1_encrypted_coeff3 &#x3D; x1_encrypted * plain_coeff3cout &lt;&lt; &quot;    + Scale of PI*x before rescale: &quot; &lt;&lt; log2(x1_encrypted_coeff3.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;evaluator.rescale_to_next_inplace(x1_encrypted_coeff3);cout &lt;&lt; &quot;    + Scale of PI*x after rescale: &quot; &lt;&lt; log2(x1_encrypted_coeff3.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;&#x2F;&#x2F;(PI*x)*x^2.print_line(__LINE__);cout &lt;&lt; &quot;Compute, relinearize, and rescale (PI*x)*x^2.&quot; &lt;&lt; endl;evaluator.multiply_inplace(x3_encrypted, x1_encrypted_coeff3);evaluator.relinearize_inplace(x3_encrypted, relin_keys);cout &lt;&lt; &quot;    + Scale of PI*x^3 before rescale: &quot; &lt;&lt; log2(x3_encrypted.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;evaluator.rescale_to_next_inplace(x3_encrypted);cout &lt;&lt; &quot;    + Scale of PI*x^3 after rescale: &quot; &lt;&lt; log2(x3_encrypted.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;&#x2F;&#x2F; 0.4*xprint_line(__LINE__);cout &lt;&lt; &quot;Compute and rescale 0.4*x.&quot; &lt;&lt; endl;evaluator.multiply_plain_inplace(x1_encrypted, plain_coeff1);cout &lt;&lt; &quot;    + Scale of 0.4*x before rescale: &quot; &lt;&lt; log2(x1_encrypted.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;evaluator.rescale_to_next_inplace(x1_encrypted);cout &lt;&lt; &quot;    + Scale of 0.4*x after rescale: &quot; &lt;&lt; log2(x1_encrypted.scale()) &lt;&lt; &quot; bits&quot; &lt;&lt; endl;&#x2F;** 现在我们希望计算这三项的和。然而,有一个严重的问题是:这三个术语使用的加密参数都是不同是由于模数从缩放转换而来。加密的加法和减法要求输入的刻度为相同，并且加密参数(parms_id)匹配。如果有不匹配时，求值器将抛出异常。*&#x2F;cout &lt;&lt; endl;print_line(__LINE__);cout &lt;&lt; &quot;Parameters used by all three terms are different.&quot; &lt;&lt; endl;cout &lt;&lt; &quot;    + Modulus chain index for x3_encrypted: &quot;&lt;&lt; context.get_context_data(x3_encrypted.parms_id())-&gt;chain_index() &lt;&lt; endl;cout &lt;&lt; &quot;    + Modulus chain index for x1_encrypted: &quot;&lt;&lt; context.get_context_data(x1_encrypted.parms_id())-&gt;chain_index() &lt;&lt; endl;cout &lt;&lt; &quot;    + Modulus chain index for plain_coeff0: &quot;&lt;&lt; context.get_context_data(plain_coeff0.parms_id())-&gt;chain_index() &lt;&lt; endl;cout &lt;&lt; endl;print_line(__LINE__);cout &lt;&lt; &quot;The exact scales of all three terms are different:&quot; &lt;&lt; endl;ios old_fmt(nullptr);old_fmt.copyfmt(cout);cout &lt;&lt; fixed &lt;&lt; setprecision(10);cout &lt;&lt; &quot;    + Exact scale in PI*x^3: &quot; &lt;&lt; x3_encrypted.scale() &lt;&lt; endl;cout &lt;&lt; &quot;    + Exact scale in  0.4*x: &quot; &lt;&lt; x1_encrypted.scale() &lt;&lt; endl;cout &lt;&lt; &quot;    + Exact scale in      1: &quot; &lt;&lt; plain_coeff0.scale() &lt;&lt; endl;cout &lt;&lt; endl;cout.copyfmt(old_fmt);print_line(__LINE__);cout &lt;&lt; &quot;Normalize scales to 2^40.&quot; &lt;&lt; endl;x3_encrypted.scale() &#x3D; pow(2.0, 40);x1_encrypted.scale() &#x3D; pow(2.0, 40);&#x2F;** 我们还有加密参数不匹配的问题。这是很容易的通过使用modulus switching (no rescaling) 来解决*&#x2F;print_line(__LINE__);cout &lt;&lt; &quot;Normalize encryption parameters to the lowest level.&quot; &lt;&lt; endl;parms_id_type last_parms_id &#x3D; x3_encrypted.parms_id();evaluator.mod_switch_to_inplace(x1_encrypted, last_parms_id);evaluator.mod_switch_to_inplace(plain_coeff0, last_parms_id);&#x2F;*到现在这三种密文现在都是兼容的，可以进行add运算了*&#x2F;print_line(__LINE__);cout &lt;&lt; &quot;Compute PI*x^3 + 0.4*x + 1.&quot; &lt;&lt; endl;Ciphertext encrypted_result;evaluator.add(x3_encrypted, x1_encrypted, encrypted_result);evaluator.add_plain_inplace(encrypted_result, plain_coeff0);Plaintext plain_result;print_line(__LINE__);cout &lt;&lt; &quot;Decrypt and decode PI*x^3 + 0.4x + 1.&quot; &lt;&lt; endl;cout &lt;&lt; &quot;    + Expected result:&quot; &lt;&lt; endl;vector&lt;double&gt; true_result;for (size_t i &#x3D; 0; i &lt; input.size(); i++)&#123;double x &#x3D; input[i];true_result.push_back((3.14159265 * x * x + 0.4) * x + 1);&#125;print_vector(true_result, 3, 7);&#x2F;*Decrypt, decode, and print the result.*&#x2F;decryptor.decrypt(encrypted_result, plain_result);vector&lt;double&gt; result;encoder.decode(plain_result, result);cout &lt;&lt; &quot;    + Computed result ...... Correct.&quot; &lt;&lt; endl;print_vector(result, 3, 7);return;&#125;</code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SEAL学习第五天-Rotaion</title>
      <link href="/posts/1aba18cf/"/>
      <url>/posts/1aba18cf/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>SEAL 学习第五天：rotaion</h1><p>@[toc]</p><h2 id="BFV">BFV</h2><div class="story post-story"><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*  * 旋转还需要另一种类型的特殊键 Galois keys */</span>GaloisKeys galois_keys<span class="token punctuation">;</span>keygen<span class="token punctuation">.</span><span class="token function">create_galois_keys</span><span class="token punctuation">(</span>galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="两种基本操作">两种基本操作</h3><table><thead><tr><th>函数调用</th><th>参数</th><th>解释说明</th></tr></thead><tbody><tr><td>evaluator.rotate_rows_inplace(encrypted_matrix, 3, galois_keys);</td><td>Ciphertext，steps，GaloisKeys</td><td>将矩阵向左(steps 为正)循环移动3步</td></tr><tr><td>evaluator.rotate_columns_inplace(encrypted_matrix, galois_keys);</td><td>Ciphertext，GaloisKeys</td><td>将矩阵行旋转</td></tr><tr><td></td><td></td><td></td></tr></tbody></table><p>==旋转不消耗任何噪音预算==</p><h4 id="旋转列">旋转列</h4><p><code>steps 为正  向左移动</code></p><p><code>steps 为负  向右移动</code></p><pre class="language-c" data-language="c"><code class="language-c"><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate rows 3 steps left."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rotate_rows_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>Plaintext plain_result<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after rotation: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>    <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093021.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093021.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093019938"></p><h4 id="旋转行">旋转行</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate columns."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rotate_columns_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after rotation: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>    <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093010.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093010.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093008588"></p></div><h2 id="CKKS">CKKS</h2><div class="story post-story"><table><thead><tr><th>函数调用</th><th>参数</th><th>解释说明</th></tr></thead><tbody><tr><td>evaluator.rotate_vector(encrypted, 2, galois_keys, rotated);</td><td>Ciphertext，steps，GaloisKeys，Ciphertext</td><td>将encrypted左(steps为正)循环移动后，输出到rotated</td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c">Ciphertext rotated<span class="token punctuation">;</span><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate 2 steps left."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rotate_vector</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">,</span> rotated<span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>rotated<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> result<span class="token punctuation">;</span>ckks_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_vector</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate 2 steps right."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">rotate_vector</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">,</span> rotated<span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>rotated<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>ckks_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_vector</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>              </div>            </details><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092936.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092936.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092935587"></p><h1>源代码</h1><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"examples.h"</span></span>using namespace std<span class="token punctuation">;</span>using namespace seal<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">example_rotation_bfv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Rotation / Rotation in BFV"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>bfv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">BFVDefault</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_plain_modulus</span><span class="token punctuation">(</span>PlainModulus<span class="token operator">::</span><span class="token function">Batching</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    SecretKey secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    PublicKey public_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    RelinKeys relin_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    Encryptor <span class="token function">encryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    Evaluator <span class="token function">evaluator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    Decryptor <span class="token function">decryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    BatchEncoder <span class="token function">batch_encoder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> slot_count <span class="token operator">=</span> batch_encoder<span class="token punctuation">.</span><span class="token function">slot_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> row_size <span class="token operator">=</span> slot_count <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Plaintext matrix row size: "</span> <span class="token operator">&lt;&lt;</span> row_size <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> <span class="token function">pod_matrix</span><span class="token punctuation">(</span>slot_count<span class="token punctuation">,</span> <span class="token number">0ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7ULL</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    Plaintext plain_matrix<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encode and encrypt."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> plain_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext encrypted_matrix<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain_matrix<span class="token punctuation">,</span> encrypted_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget in fresh encryption: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>    <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*     * 旋转还需要另一种类型的特殊键 Galois keys    */</span>    GaloisKeys galois_keys<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_galois_keys</span><span class="token punctuation">(</span>galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    现在将矩阵行向左循环移动3步, 解密、解码和打印    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate rows 3 steps left."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">rotate_rows_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    Plaintext plain_result<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after rotation: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    我们也可以旋转列, i.e., 交换行.    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate columns."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">rotate_columns_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after rotation: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    最后，我们将这些行向右旋转4步, decrypt, decode, and print.    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate rows 4 steps right."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">rotate_rows_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after rotation: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">example_rotation_ckks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Rotation / Rotation in CKKS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    Rotations in the CKKS scheme work very similarly to rotations in BFV.    */</span>    EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>ckks<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    SecretKey secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    PublicKey public_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    RelinKeys relin_keys<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    GaloisKeys galois_keys<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_galois_keys</span><span class="token punctuation">(</span>galois_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    Encryptor <span class="token function">encryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    Evaluator <span class="token function">evaluator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    Decryptor <span class="token function">decryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    CKKSEncoder <span class="token function">ckks_encoder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> slot_count <span class="token operator">=</span> ckks_encoder<span class="token punctuation">.</span><span class="token function">slot_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of slots: "</span> <span class="token operator">&lt;&lt;</span> slot_count <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> input<span class="token punctuation">;</span>    input<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>slot_count<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> curr_point <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">double</span> step_size <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>static_cast<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span><span class="token punctuation">(</span>slot_count<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> slot_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> curr_point <span class="token operator">+=</span> step_size<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        input<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>curr_point<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input vector:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> scale <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encode and encrypt."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Plaintext plain<span class="token punctuation">;</span>    ckks_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext encrypted<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext rotated<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate 2 steps left."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">rotate_vector</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">,</span> rotated<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>rotated<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> result<span class="token punctuation">;</span>    ckks_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Rotate 2 steps right."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">rotate_vector</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> galois_keys<span class="token punctuation">,</span> rotated<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decrypt and decode ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>rotated<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>        ckks_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">example_rotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Rotation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    Run all rotation examples.    */</span>    <span class="token function">example_rotation_bfv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">example_rotation_ckks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SEAL学习第二天-Encoder处理</title>
      <link href="/posts/286653df/"/>
      <url>/posts/286653df/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>SEAL 学习第二天 encoders</h1><p>@[toc]<br>​</p><h2 id="BatchEncoder">BatchEncoder</h2><div class="story post-story"><p>[BatchEncoder] (For BFV scheme only)</p><p>在“1 _bfv_basics。我们展示了如何使用BFV方案执行一个非常简单的计算。计算以明文模为参数，仅利用一个BFV明文多项式的系数。这种方法有两个值得注意的问题:</p><pre class="language-none"><code class="language-none">(1)实际应用中一般采用整数或实数算法，而不是模运算;(2)我们只使用了明文多项式的一个系数。这是非常浪费的，因为明文多项式很大，而且在任何情况下都将全部加密。</code></pre><p>对于(1) 若增大plain_modulus ，虽然可行，但同时增加了 噪声预算的消耗(当噪声预算消耗到0时，计算结果是不正确的，所以我们要随时关注噪声预算)，</p><p>将数据编码为明文(plaintext) 进行encoder 允许更多的计算而没有数据类型溢出，还可以允许使用完整的明文多项式。</p><table><thead><tr><th>调用</th><th>参数</th><th>解释说明</th></tr></thead><tbody><tr><td>BatchEncoder batch_encoder(context);</td><td>SEALContext</td><td>声明一个批处理类</td></tr><tr><td>batch_encoder.encode(pod_matrix, plain_matrix);</td><td>VectorPlaintext</td><td>将一个vector批量编码成成明文Plaintext</td></tr><tr><td>batch_encoder.decode(plain_matrix, pod_result);</td><td>Plaintext,Vector</td><td>将一个明文Plaintext处理解码成vector</td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*设N为poly_modulus_degree，T为plain_modulus。批处理允许BFV明文多项式被视为2×(N/2)矩阵，每个元素都是一个模T整数。在矩阵视图中，加密操作在加密矩阵上逐个执行element-wise，允许用户在完全向量化计算中获得几个数量级的速度提升。因此，除了最简单的计算之外，批处理应该是首选的方法。使用BFV时，如果使用得当，实现的性能将超过使用IntegerEncoder完成的任何工作。*/</span>EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>bfv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">BFVDefault</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>要启用批处理，我们需要将plain_modulus设置为一个素数，等于1模2* poly_modulus_degrees。Microsoft SEAL提供了一个助手</p><p>找到这样一个质数的方法。在这个例子中，我们创建了一个20位素数支持批处理。</p><p>通过CoeffModulus::BFVDefault(poly_modulus_degree) 产出一个<strong>素数</strong></p><pre class="language-c" data-language="c"><code class="language-c">parms<span class="token punctuation">.</span><span class="token function">set_plain_modulus</span><span class="token punctuation">(</span>PlainModulus<span class="token operator">::</span><span class="token function">Batching</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 声明完context后类，后就可以开始使用了</span><span class="token comment">// 检测是否成功启用</span><span class="token keyword">auto</span> qualifiers <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">first_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">qualifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Batching enabled: "</span> <span class="token operator">&lt;&lt;</span> boolalpha <span class="token operator">&lt;&lt;</span> qualifiers<span class="token punctuation">.</span>using_batching <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></code></pre><p>批处理‘slots’的总数等于poly_modulus_degree, N，这些’slots’被组织成<a href="**2%C3%97(N/2)**">2×(N/2)</a>矩阵，可以被加密和计算。每个slot含一个整数 MOD plain_modulus。</p><p><strong>2×(N/2)</strong></p><pre class="language-c" data-language="c"><code class="language-c"><span class="token class-name">size_t</span> slot_count <span class="token operator">=</span> batch_encoder<span class="token punctuation">.</span><span class="token function">slot_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> row_size <span class="token operator">=</span> slot_count <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Plaintext matrix slot_count size: "</span> <span class="token operator">&lt;&lt;</span> slot_count <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Plaintext matrix row size: "</span> <span class="token operator">&lt;&lt;</span> row_size <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">/** 声明一个vector，长度为slot_count， 默为 0 * 形式为： 2*(slot_count/2) 的二维矩阵* [0...............row_size]* [row_size......slot_count]*/</span>vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> <span class="token function">pod_matrix</span><span class="token punctuation">(</span>slot_count<span class="token punctuation">,</span> <span class="token number">0ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//赋值</span>pod_matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span>row_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6ULL</span><span class="token punctuation">;</span>pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7ULL</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span><span class="token comment">/** 这个print_matrix不会打印矩阵的每一列,只打印每一行的前5个和最后5个* [ 0,  1,  2,  3,  0,  0, ...,  0 ]* [ 4,  5,  6,  7,  0,  0, ...,  0 ]*/</span><span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>encode</strong></p><p>从给定的矩阵创建一个明文,&quot;批量处理&quot;一个给定的矩阵 Mod (plaintext modulus) 然后将结果存储到<br>plaintext类，输入的vecotr的大小 &lt;= 多项式模的次数(poly_modulus_degree)</p><pre class="language-c" data-language="c"><code class="language-c">batch_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> plain_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="简单样例验证">简单样例验证</h3><p>生成矩阵A和矩阵B</p><pre class="language-c" data-language="c"><code class="language-c">矩阵A形式<span class="token operator">:</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>  <span class="token number">0</span> <span class="token punctuation">]</span>矩阵B形式：<span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">]</span>求  <span class="token punctuation">(</span>A<span class="token operator">+</span>B<span class="token punctuation">)</span><span class="token operator">^</span><span class="token number">2</span> 并验证结果</code></pre><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c">vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> <span class="token function">pod_matrix</span><span class="token punctuation">(</span>slot_count<span class="token punctuation">,</span> <span class="token number">0ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// </span>   pod_matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span>row_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6ULL</span><span class="token punctuation">;</span>   pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7ULL</span><span class="token punctuation">;</span>   <span class="token comment">/*   首先，我们使用BatchEncoder将矩阵编码成一个明文多项式。   */</span>   Plaintext plain_matrix<span class="token punctuation">;</span>   <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encode plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   <span class="token comment">/*    从给定的矩阵创建一个明文,"批量处理"一个给定的矩阵 Mod (plaintext modulus) 然后将结果存储到    plaintext类，输入的vecotr的大小 &lt;= 多项式模的次数(poly_modulus_degree)   */</span>   batch_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> plain_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/*   接下来，我们加密已编码的明文。   */</span>   Ciphertext encrypted_matrix<span class="token punctuation">;</span>   <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encrypt plain_matrix to encrypted_matrix."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain_matrix<span class="token punctuation">,</span> encrypted_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget in encrypted_matrix: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>       <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   <span class="token comment">/*   * 对密文的操作导致在所有8192(poly_modulus_degree)个slot(矩阵元素)中同时执行同态操作。为了说明这一点，我们构造了另一个明文矩阵：        [ 1,  2,  1,  2,  1,  2, ..., 2 ]        [ 1,  2,  1,  2,  1,  2, ..., 2 ]    然后把它编码成明文。    */</span>   vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> pod_matrix2<span class="token punctuation">;</span>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> slot_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span>       pod_matrix2<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token class-name">size_t</span><span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span>   Plaintext plain_matrix2<span class="token punctuation">;</span>   batch_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pod_matrix2<span class="token punctuation">,</span> plain_matrix2<span class="token punctuation">)</span><span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Second input plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix2<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/*    现在我们将第二个(明文)矩阵添加到加密矩阵中，并求sum^2。    */</span>   <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Sum, square, and relinearize."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   evaluator<span class="token punctuation">.</span><span class="token function">add_plain_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_matrix2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// encrypted_matrix = ncrypted_matrix +　plain_matrix2</span>   evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// encrypted_matrix = encrypted_matrix * encrypted_matrix;</span>   evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列化</span>   <span class="token comment">/*   查看剩余噪音预算   */</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget in result: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   <span class="token comment">/*   我们将加密的 数据进行解密并解码并验证结果   */</span>   Plaintext plain_result<span class="token punctuation">;</span>   <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt and decode result."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>   decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>   batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_result<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_result<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 验证结果</span></code></pre>              </div>            </details><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093931.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093931.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093930292"></p><h3 id="总结：">总结：</h3><p>当所需的加密计算高度可并行化时，批处理允许我们有效地使用全明文多项式。但是，它并没有解决这个文件开头提到的另一个问题:每个槽只包含一个整数模的明文模量，除非明文模量非常大，否则我们可以很快遇到数据类型溢出，并在需要整数计算时会得到意外的结果。注意，溢出并不能以加密的形式检测到。CKKS方案(以及CKKSEncoder)解决了数据类型溢出问题，但代价是只产生近似的结果。</p></div><h2 id="CKKSEncoder">CKKSEncoder</h2><div class="story post-story"><p>[CKKSEncoder] (For CKKS scheme only)<br>实数或复数形式</p><blockquote><p>(1) CKKS不使用plain_modulus加密参数;</p><p>(2) 当使用CKKS方案时,选择coeff_modulus是非常重要的</p></blockquote><p>声明方式 同bfv一致，</p><pre class="language-c" data-language="c"><code class="language-c">EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>ckks<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用ckks</span><span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 产生5个40位的素数的数组</span></code></pre><p>CKKS 中 slot数目  =  poly_modulus_degree / 2  每个slot编码为一个实数或复数。</p><p>而在BFV中 slot = poly_modulus_degree 并且被处理成 一个2X(N/2)的矩阵</p><pre class="language-c++" data-language="c++"><code class="language-c++">size_t slot_count &#x3D; encoder.slot_count();</code></pre><p>要创建CKKS纯文本，我们需要一个特殊的编码器:</p><p>BatchEncoder不适用于CKKS<br>CKKSEncoder 的方式是将实数或复数的向量编码为Plaintext objects 然后对object就可以加密了</p><table><thead><tr><th>函数调用</th><th>参数类型</th><th>解释说明</th></tr></thead><tbody><tr><td>CKKSEncoder encoder(context);</td><td>SEALContext</td><td>声明一个CKKS编码器</td></tr><tr><td>encoder.encode(input, scale, plain);</td><td>Vector,scale,Plaintext</td><td>将vector 按照scale定义的编码精度的尺度参数 编码成 Plaintext</td></tr><tr><td>encoder.decode(plain, output);</td><td>Plaintext，Vector</td><td>将明文Plaintext解密成Vector</td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></tbody></table><h3 id="编码与解码">编码与解码</h3><pre class="language-c" data-language="c"><code class="language-c">Plaintext plain<span class="token punctuation">;</span><span class="token keyword">double</span> scale <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encode input vector. and the size of scale: "</span><span class="token operator">&lt;&lt;</span> scale <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将vector 按照scale定义的编码精度的尺度参数 编码成 Plaintext</span><span class="token comment">/* 我们可以立即解码以检查编码的正确性。*/</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> output<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decode input vector ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码</span><span class="token function">print_vector</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093958.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093958.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093957617"></p><p>做个简单样例验证，　将输入的vector加密后 求平方　并　序列化后　解码验证结果</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/*    The vector is encrypted the same was as in BFV.    简单样例:        将输入的 vector 加密后 求平方 并 序列化    */</span>    Ciphertext encrypted<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encrypt input vector, square, and relinearize."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加密 Plaintext -> Ciphertext</span>    <span class="token comment">// 计算</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// encrypted = encrypted * encrypted</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列化</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Scale in squared input: "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ("</span> <span class="token operator">&lt;&lt;</span> <span class="token function">log2</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits)"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt and decode."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解密</span>    encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Result vector ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果</span></code></pre>              </div>            </details><p>验证结果正确</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812094017.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812094017.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812094016156"></p></div><h2 id="全部源代码">全部源代码</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"examples.h"</span></span>using namespace std<span class="token punctuation">;</span>using namespace seal<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">example_batch_encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Encoders / Batch Encoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">/*    [BatchEncoder] (For BFV scheme only)    Let N 表示 poly_modulus_degree ; T 表示 plain_modulus. Batching    allows the BFV plaintext polynomials to be viewed as 2-by-(N/2) matrices, with    each element an integer modulo T. 在矩阵视图中，加密操作法案在加密的矩阵上,    allowing the user to obtain speeds-ups of several orders of magnitude in fully vectorizable computations.     Thus, in all but the simplest computations, batching should be the preferred method to use    with BFV, and when used properly will result in implementations outperforming    anything done without batching.    */</span>    EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>bfv<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">BFVDefault</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_plain_modulus</span><span class="token punctuation">(</span>PlainModulus<span class="token operator">::</span><span class="token function">Batching</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//PlainModulus::Batching(poly_modulus_degree, 20) 产生20位的素数</span>    SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">// 检测是否成功启用</span>    <span class="token keyword">auto</span> qualifiers <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">first_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">qualifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Batching enabled: "</span> <span class="token operator">&lt;&lt;</span> boolalpha <span class="token operator">&lt;&lt;</span> qualifiers<span class="token punctuation">.</span>using_batching <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    SecretKey secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    PublicKey public_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    RelinKeys relin_keys<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    Encryptor <span class="token function">encryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    Evaluator <span class="token function">evaluator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    Decryptor <span class="token function">decryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    BatchEncoder <span class="token function">batch_encoder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> slot_count <span class="token operator">=</span> batch_encoder<span class="token punctuation">.</span><span class="token function">slot_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">size_t</span> row_size <span class="token operator">=</span> slot_count <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Plaintext matrix slot_count size: "</span> <span class="token operator">&lt;&lt;</span> slot_count <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Plaintext matrix row size: "</span> <span class="token operator">&lt;&lt;</span> row_size <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 声明一个vector，长度为slot_count， 默为 0     * 形式为： 2*(slot_count/2) 的二维矩阵    * [0...............row_size]    * [row_size......slot_count]    */</span>    vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> <span class="token function">pod_matrix</span><span class="token punctuation">(</span>slot_count<span class="token punctuation">,</span> <span class="token number">0ULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// </span>        pod_matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6ULL</span><span class="token punctuation">;</span>    pod_matrix<span class="token punctuation">[</span>row_size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7ULL</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 这个print_matrix不会打印矩阵的每一列,只打印每一行的前5个和最后5个    * [ 0,  1,  2,  3,  0,  0, ...,  0 ]    * [ 4,  5,  6,  7,  0,  0, ...,  0 ]    */</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    首先，我们使用BatchEncoder将矩阵编码成一个明文多项式。    */</span>    Plaintext plain_matrix<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encode plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*     从给定的矩阵创建一个明文,"批量处理"一个给定的矩阵 Mod (plaintext modulus) 然后将结果存储到     plaintext类，输入的vecotr的大小 &lt;= 多项式模的次数(poly_modulus_degree)    */</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pod_matrix<span class="token punctuation">,</span> plain_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    我们可以立即解码以验证编码的正确性. 但注意，还未进行加密或解密    */</span>    vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> pod_result<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decode plaintext matrix ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_matrix<span class="token punctuation">,</span> pod_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_result<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    接下来，我们加密已编码的明文。    */</span>    Ciphertext encrypted_matrix<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encrypt plain_matrix to encrypted_matrix."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain_matrix<span class="token punctuation">,</span> encrypted_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget in encrypted_matrix: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 对密文的操作导致在所有8192(poly_modulus_degree)个slot(矩阵元素)中同时执行同态操作。为了说明这一点，我们构造了另一个明文矩阵：         [ 1,  2,  1,  2,  1,  2, ..., 2 ]         [ 1,  2,  1,  2,  1,  2, ..., 2 ]     然后把它编码成明文。     */</span>    vector<span class="token operator">&lt;</span><span class="token class-name">uint64_t</span><span class="token operator">></span> pod_matrix2<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> slot_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        pod_matrix2<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token class-name">size_t</span><span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    Plaintext plain_matrix2<span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>pod_matrix2<span class="token punctuation">,</span> plain_matrix2<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Second input plaintext matrix:"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_matrix2<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">/*     现在我们将第二个(明文)矩阵添加到加密矩阵中，并求sum^2。     */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Sum, square, and relinearize."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">add_plain_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_matrix2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// encrypted_matrix = ncrypted_matrix +　plain_matrix2</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// encrypted_matrix = encrypted_matrix * encrypted_matrix;</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列化</span>    <span class="token comment">/*    查看剩余噪音预算    */</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget in result: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    我们将加密的 数据进行解密并解码并验证结果    */</span>    Plaintext plain_result<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt and decode result."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_matrix<span class="token punctuation">,</span> plain_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    batch_encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain_result<span class="token punctuation">,</span> pod_result<span class="token punctuation">)</span><span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Result plaintext matrix ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_matrix</span><span class="token punctuation">(</span>pod_result<span class="token punctuation">,</span> row_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    当所需的加密计算高度可并行化时，批处理允许我们有效地使用全明文多项式。    但是，它并没有解决这个文件开头提到的另一个问题:    每个槽只包含一个整数模的明文模量，除非明文模量非常大，    否则我们可以很快遇到数据类型溢出，并在需要整数计算时会得到意外的结果。    注意，溢出并不能以加密的形式检测到。CKKS方案(以及CKKSEncoder)解决了数据类型溢出问题，    但代价是只产生近似的结果。        */</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">example_ckks_encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Encoders / CKKS Encoder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>ckks<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 使用ckks</span>    <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 产生5个40位的素数的数组</span>        <span class="token comment">// 同BFV一致，声明</span>    SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">// 密钥产生的方式和 bfv 是一样的</span>    KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    PublicKey public_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    RelinKeys relin_keys<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 加密器，解密器，计算器</span>    Encryptor <span class="token function">encryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    Evaluator <span class="token function">evaluator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    Decryptor <span class="token function">decryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    * 要创建CKKS纯文本，我们需要一个特殊的编码器:        BatchEncoder不适用于CKKS       CKKSEncoder 的方式是将实数或复数的向量编码为Plaintext objects 然后对object就可以加密了    看起来很像BatchEncoder为BFV方案所做的，但理论上它的背后是完全不同的。    */</span>    CKKSEncoder <span class="token function">encoder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    * CKKS 中 slot数目  =  poly_modulus_degree / 2  每个slot编码为一个实数或复数。    * 而在BFV中 slot = poly_modulus_degree 并且被处理成 一个2X(N/2)的矩阵    */</span>    <span class="token class-name">size_t</span> slot_count <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">slot_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of slots: "</span> <span class="token operator">&lt;&lt;</span> slot_count <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> input<span class="token punctuation">&#123;</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.1</span><span class="token punctuation">,</span> <span class="token number">2.2</span><span class="token punctuation">,</span> <span class="token number">3.3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input vector: "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    * 现在我们用CKKSEncoder进行编码。输入的浮点系数将通过参数“scale”放大    * 这是必要的，因为即使是在纯文本元素的CKKS方案,基本上是多项式整数系数。    * 在CKKS中，消息是存 MOD coeff_modulus,(而在BFV中是 存储 MOD plain_modulus)    * 因此，缩放后的消息不能太接近总大小coeff_modulus。    *     */</span>    Plaintext plain<span class="token punctuation">;</span>    <span class="token keyword">double</span> scale <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encode input vector. and the size of scale: "</span><span class="token operator">&lt;&lt;</span> scale <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将vector 按照scale定义的编码精度的尺度参数 编码成 Plaintext</span>    <span class="token comment">/*    我们可以立即解码以检查编码的正确性。    */</span>    vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">></span> output<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decode input vector ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    The vector is encrypted the same was as in BFV.    简单样例:        将输入的 vector 加密后 求平方 并 序列化    */</span>    Ciphertext encrypted<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encrypt input vector, square, and relinearize."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加密 Plaintext -> Ciphertext</span>    <span class="token comment">// 计算</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// encrypted = encrypted * encrypted</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 序列化</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Scale in squared input: "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ("</span> <span class="token operator">&lt;&lt;</span> <span class="token function">log2</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits)"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt and decode."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解密</span>    encoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解码</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Result vector ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_vector</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果</span>    <span class="token comment">/*    * CKKS方案允许减少加密计算之间的规模。这是CKKS非常强大和关键的基本特性灵活。    * 我们将在' 3_levels中详细讨论它。cpp'和稍后“4 _ckks_basics.cpp”。    */</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">example_encoders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Encoders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    Run all encoder examples.    */</span>    <span class="token comment">//example_batch_encoder();</span>    <span class="token function">example_ckks_encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SEAL学习第三天-Levels</title>
      <link href="/posts/51e56618/"/>
      <url>/posts/51e56618/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>SEAL 学习第三天：levels</h1><p>@[toc]</p><h2 id="简介">简介</h2><div class="story post-story"><p>今天学习描述在BFV和CKKS和在Microsoft SEAL中表示它们的相关对象</p><p>在Microsoft SEAL中，一组加密参数(不包括随机数生成器)由参数的256位散列唯一标识。这个散列称为’ parms_id’，可以在任何时候方便地访问和打印。一旦任何参数发生变化，散列就会发生变化。</p><p>当从给定的EncryptionParameters实例创建SEALContext时，微软SEAL会自动创建一个所谓的“模数切换链”，它是从原始集合衍生出来的其他加密参数链。模量交换链中的参数除系数模量沿链向下逐渐减小外，其余参数均与原参数相同。更准确地说，链中的每个参数集都试图从前一个集合中移除最后一个系数模素数;这会一直持续到参数集不再有效为止。(例如:plain_modulus大于剩余的coeff_modulus)。很容易遍历整个链并访问所有参数集。此外，链中设置的每个参数都有一个“链索引”，指示其在链中的位置，因此最后一组参数的索引为0。我们说，一组加密参数，或者一个携带这些加密参数的对象，在链中的级别高于另一组参数，如果它的链索引较大，也就是说，它在链中较早。</p><p>链中的每一组参数都涉及到执行的唯一预计算。当创建SEALContext并存储在SEALContext::ContextData中时对象。这个链基本上是SEALContext::ContextData的链表对象，并且可以在任何时候通过SEALContext轻松访问。每一个节点可以通过其特定加密参数的parms_id来标识(poly_modulus_degree保持不变，coeff_modulus变化)。</p><pre class="language-c++" data-language="c++"><code class="language-c++">EncryptionParameters parms(scheme_type::bfv);size_t poly_modulus_degree &#x3D; 8192;parms.set_poly_modulus_degree(poly_modulus_degree);</code></pre><p>在这个例子中，我们使用了一个自定义的coeff_modulus， c由5个质数组成的50, 30, 30, 50, 50 位素数.</p><pre><code>CoeffModulus::MaxBitCount(poly_modulus_degree)</code></pre><p>returns 218 (greater than 50+30+30+50+50=210).<br>由于模量切换链，5个素数的顺序是重要的。最后一个质数有特殊的含义，我们称之为“特殊质数”。<br>因此,第一个参数设置在模切换链只有一个涉及到特殊的prime<br>创建所有密钥对象，如SecretKey在这个最高的层次。所有数据对象，如密文，只能在较低的水平。<br>这个特殊质数应该与在coeff_modulus中的其他素数的最大质数一样大</p><p>在SEAL中有一个重要的<code>level</code>的概念，根据示例代码里的注释，可以理解为SEAL根据默认的参数创建了一个<code>modulus switching chain</code> ，在同一个链上的加密实例除了<code>coefficient modulus</code> 其他都相同。下面示例代码给的一个解释：</p><pre><code>              special prime +---------+                                  |                                  vcoeff_modulus: &#123; 50, 30, 30, 50, 50 &#125;  +---+  Level 4 (all keys; `key level')                                           |                                           |    coeff_modulus: &#123; 50, 30, 30, 50 &#125;  +---+  Level 3 (highest `data level')                                           |                                           |        coeff_modulus: &#123; 50, 30, 30 &#125;  +---+  Level 2                                           |                                           |            coeff_modulus: &#123; 50, 30 &#125;  +---+  Level 1                                           |                                           |                coeff_modulus: &#123; 50 &#125;  +---+  Level 0 (lowest level)有方便的访问方法 SEALContext::ContextData SEALContext::key_context_data(): access to key level ContextDataSEALContext::first_context_data(): access to highest data level ContextDataSEALContext::last_context_data(): access to lowest level ContextData</code></pre><p>这是通过<code>set_coeff_modulus(CoeffModulus::Create(poly_modulus_degree, &#123; 50, 30, 30, 50, 50 &#125;))</code> 方法设置的</p><p>打印信息查看</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093830.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093830.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093828226"></p><h3 id="验证keys级别。">验证keys级别。</h3><pre class="language-c" data-language="c"><code class="language-c">KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">auto</span> secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>PublicKey public_key<span class="token punctuation">;</span>keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>RelinKeys relin_keys<span class="token punctuation">;</span>keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Print the parameter IDs of generated elements."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + public_key:  "</span> <span class="token operator">&lt;&lt;</span> public_key<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + secret_key:  "</span> <span class="token operator">&lt;&lt;</span> secret_key<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + relin_keys:  "</span> <span class="token operator">&lt;&lt;</span> relin_keys<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093819.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093819.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093815038"></p></div><h2 id="验证密文Ciphertext级别">验证密文Ciphertext级别</h2><div class="story post-story"><pre class="language-c" data-language="c"><code class="language-c">Plaintext <span class="token function">plain</span><span class="token punctuation">(</span><span class="token string">"1x^3 + 2x^2 + 3x^1 + 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Ciphertext encrypted<span class="token punctuation">;</span>encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + plain:       "</span> <span class="token operator">&lt;&lt;</span> plain<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" (not set in BFV)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + encrypted:   "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093801.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093801.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093759931"></p><h3 id="“Modulus-switching”">“Modulus switching”</h3><p>“Modulus switching”是一种降低密文参数的技术在链中 Evaluator::mod_switch_to_next总是切换到<br>下一级链，而Evaluator::mod_switch_to切换到在对应于给定parms_id的链上设置的参数。然而,它<br>是不可能在链条向上切换的。</p><p>验证:</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Perform modulus switching on encrypted and print."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>context_data <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">first_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"---->"</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>context_data<span class="token operator">-></span><span class="token function">next_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id of encrypted: "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      Noise budget at this level: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_next_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    context_data <span class="token operator">=</span> context_data<span class="token operator">-></span><span class="token function">next_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id of encrypted: "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      Noise budget at this level: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" End of chain reached"</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></code></pre>              </div>            </details><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812093724.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812093724.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812093722716"></p><h1>源代码</h1><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"examples.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"seal/seal.h"</span></span>using namespace std<span class="token punctuation">;</span>using namespace seal<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">example_levels</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: Levels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>bfv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/*    在这个例子中，我们使用了一个自定义的coeff_modulus， c由5个质数组成的50, 30, 30, 50, 50 位素数.         CoeffModulus::MaxBitCount(poly_modulus_degree)    returns 218 (greater than 50+30+30+50+50=210).由于模量切换链，5个素数的顺序是重要的。最后一个质数有特殊的含义，我们称之为“特殊质数”。因此,第一个参数设置在模切换链只有一个涉及到特殊的prime创建所有密钥对象，如SecretKey在这个最高的层次。所有数据对象，如密文，只能在较低的水平。这个特殊质数应该与在coeff_modulus中的其他素数的最大质数一样大                  special prime +---------+                                      |                                      v    coeff_modulus: &#123; 50, 30, 30, 50, 50 &#125;  +---+  Level 4 (all keys; `key level')                                               |                                               |        coeff_modulus: &#123; 50, 30, 30, 50 &#125;  +---+  Level 3 (highest `data level')                                               |                                               |            coeff_modulus: &#123; 50, 30, 30 &#125;  +---+  Level 2                                               |                                               |                coeff_modulus: &#123; 50, 30 &#125;  +---+  Level 1                                               |                                               |                    coeff_modulus: &#123; 50 &#125;  +---+  Level 0 (lowest level)*/</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    在这个例子中，plain_modulus没有发挥太大的作用;我们选择一些合理的价值    */</span>    parms<span class="token punctuation">.</span><span class="token function">set_plain_modulus</span><span class="token punctuation">(</span>PlainModulus<span class="token operator">::</span><span class="token function">Batching</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 有方便的访问方法 SEALContext::ContextData         SEALContext::key_context_data(): access to key level ContextData        SEALContext::first_context_data(): access to highest data level ContextData        SEALContext::last_context_data(): access to lowest level ContextData    */</span>    <span class="token comment">//遍历该链并打印每组参数的parms_id。</span>    <span class="token comment">//首先打印关键级别参数信息</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Print the modulus switching chain."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">auto</span> context_data <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">key_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"----> Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" ...... key_context_data()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id: "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      coeff_modulus primes: "</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> hex<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> prime <span class="token operator">:</span> context_data<span class="token operator">-></span><span class="token function">parms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">coeff_modulus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        cout <span class="token operator">&lt;&lt;</span> prime<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout <span class="token operator">&lt;&lt;</span> dec <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>        <span class="token comment">//接下来迭代其余的</span>    context_data <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">first_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>context_data<span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>context_data<span class="token operator">-></span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> context<span class="token punctuation">.</span><span class="token function">first_parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            cout <span class="token operator">&lt;&lt;</span> <span class="token string">" ...... first_context_data()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context_data<span class="token operator">-></span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> context<span class="token punctuation">.</span><span class="token function">last_parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            cout <span class="token operator">&lt;&lt;</span> <span class="token string">" ...... last_context_data()"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span>        <span class="token punctuation">&#123;</span>            cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id: "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      coeff_modulus primes: "</span><span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> hex<span class="token punctuation">;</span> <span class="token comment">// 16进制输出</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> prime <span class="token operator">:</span> context_data<span class="token operator">-></span><span class="token function">parms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">coeff_modulus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            cout <span class="token operator">&lt;&lt;</span> prime<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        cout <span class="token operator">&lt;&lt;</span> dec <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>        <span class="token comment">/*        Step forward in the chain.        */</span>        context_data <span class="token operator">=</span> context_data<span class="token operator">-></span><span class="token function">next_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" End of chain reached"</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">//我们创建一些keys并检查它们是否确实出现在最高层。</span>    KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">auto</span> secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    PublicKey public_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    RelinKeys relin_keys<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Print the parameter IDs of generated elements."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + public_key:  "</span> <span class="token operator">&lt;&lt;</span> public_key<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + secret_key:  "</span> <span class="token operator">&lt;&lt;</span> secret_key<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + relin_keys:  "</span> <span class="token operator">&lt;&lt;</span> relin_keys<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Encryptor <span class="token function">encryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    Evaluator <span class="token function">evaluator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    Decryptor <span class="token function">decryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    * 在BFV方案中，明文不携带parms_id，而密文携带parms_id。    请注意新加密的密文如何在最高数据级别。    */</span>    Plaintext <span class="token function">plain</span><span class="token punctuation">(</span><span class="token string">"1x^3 + 2x^2 + 3x^1 + 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext encrypted<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + plain:       "</span> <span class="token operator">&lt;&lt;</span> plain<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" (not set in BFV)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + encrypted:   "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * “Modulus switching”是一种降低密文参数的技术在链中 Evaluator::mod_switch_to_next总是切换到    下一级链，而Evaluator::mod_switch_to切换到在对应于给定parms_id的链上设置的参数。然而,它    是不可能在链条向上切换的。    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Perform modulus switching on encrypted and print."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    context_data <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">first_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"---->"</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>context_data<span class="token operator">-></span><span class="token function">next_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id of encrypted: "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      Noise budget at this level: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_next_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>        context_data <span class="token operator">=</span> context_data<span class="token operator">-></span><span class="token function">next_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id of encrypted: "</span> <span class="token operator">&lt;&lt;</span> encrypted<span class="token punctuation">.</span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      Noise budget at this level: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" End of chain reached"</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    在这一点上，很难看到这样做有任何好处:我们损失了巨大噪音预算(即计算能力)没有任何回报。    解密仍能工作。    然而，有一个隐藏的好处:密文的大小取决于系数模数中素数数的线性关系。    因此,如果有不需要或不打算对给定的对象执行任何进一步的计算密文，    我们不妨把它切换到最小的(最后的)集合参数，然后将其发送回密钥持有者解密。    此外，噪音损失预算实际上根本不是一个问题        */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt still works after modulus switching."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decryption of encrypted: "</span> <span class="token operator">&lt;&lt;</span> plain<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 因此,如果有不需要或不打算对给定的对象执行任何进一步的计算密文，    * 我们不妨把它切换到最小的(最后的)集合参数，然后将其发送回密钥持有者解密。    * 此外，噪音损失预算实际上根本不是一个问题    * 首先，我们重新创建原始密文并执行一些计算。    *     */</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Computation is more efficient with modulus switching."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute the 8th power."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget fresh:                   "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget of the 2nd power:         "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget of the 4th power:         "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    在这种情况下 modulus switching 对噪声预算完全没有影响。    */</span>    evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_next_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after modulus switching:  "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 这意味着降低一些系数是没有任何害处的在做了足够的计算之后。    * 在某些情况下，人们可能稍微早一点切换到一个较低的级别，实际上牺牲了一些过程中的噪音预算    * 以用更小的参数来获得计算性能    * 我们从打印出来的数据中可以看到，当噪音预算降到25位左右时，下一个modulus switch应该理想地完成。    */</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget of the 8th power:         "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">mod_switch_to_next_inplace</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Noise budget after modulus switching:  "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 此时，密文仍能正确解密，体积很小，而且计算效率也尽可能高。    * 注意，解密器可以用来解密在modulus switching链中任意层次一个密文    */</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + Decryption of the 8th power (hexadecimal) ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    "</span> <span class="token operator">&lt;&lt;</span> plain<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 在BFV中不需要modulus switching    * 在某些情况下，用户可能会不想创建modulus switching链，    * 只实现最高的两个level（key level and highest data level)    * 这可以通过将bool值' false'传递给SEALContext的构造函数来实现。    */</span>    context <span class="token operator">=</span> <span class="token function">SEALContext</span><span class="token punctuation">(</span>parms<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*    * 我们可以检查确实只创建了模数交换链最高的两层    */</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Optionally disable modulus switching chain expansion."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Print the modulus switching chain."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"---->"</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>context_data <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">key_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> context_data<span class="token punctuation">;</span> context_data <span class="token operator">=</span> context_data<span class="token operator">-></span><span class="token function">next_context_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" Level (chain index): "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">chain_index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      parms_id: "</span> <span class="token operator">&lt;&lt;</span> context_data<span class="token operator">-></span><span class="token function">parms_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"      coeff_modulus primes: "</span><span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> hex<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> prime <span class="token operator">:</span> context_data<span class="token operator">-></span><span class="token function">parms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">coeff_modulus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>            cout <span class="token operator">&lt;&lt;</span> prime<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        cout <span class="token operator">&lt;&lt;</span> dec <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\\"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" \\-->"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">" End of chain reached"</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SEAL学习第一天-Bfv_basics使用用法</title>
      <link href="/posts/9959b7cc/"/>
      <url>/posts/9959b7cc/</url>
      
        <content type="html"><![CDATA[<blockquote><p>@auther by sizaif</p></blockquote><h1>SEAL学习第一天： bfv_basics使用用法</h1><p>@<a href="%E7%9B%AE%E5%BD%95">TOC</a></p><h1>bfv_basics</h1><h2 id="一-parms类">一 parms类</h2><div class="story post-story"><blockquote><p>创建一个HE方案类</p><p>parms类需要的3个参数</p><ul><li>poly_modulus_degree (degree of polynomial modulus 多项式模的次数);</li><li>coeff_modulus ([ciphertext] coefficient modulus 系数模);</li><li>plain_modulus (plaintext modulus; only for the BFV scheme).  MOD X, 将结果MOD到X内</li></ul></blockquote><table><thead><tr><th>用法</th><th>参数</th><th>解释说明</th></tr></thead><tbody><tr><td>EncryptionParameters parms();</td><td>scheme_type::bfv</td><td>创建一个HE以BFV方案类</td></tr><tr><td>size_t poly_modulus_degree = 4096;</td><td>integear</td><td>[size_t poly_modulus_degree](###size_t poly_modulus_degree)</td></tr><tr><td>parms.set_poly_modulus_degree();</td><td>poly_modulus_degree</td><td></td></tr><tr><td>parms.set_coeff_modulus()；</td><td>CoeffModulus::BFVDefault(poly_modulus_degree)</td><td><a href="###coeff_modulus">poly_modulus_degree</a></td></tr><tr><td>parms.set_plain_modulus(1024);</td><td>integear</td><td><a href="###MOD">MOD</a></td></tr><tr><td>context.parameter_error_message()</td><td></td><td>输出报错信息</td></tr><tr><td>SEALContext context(parms);</td><td></td><td><a href="####%E6%BC%94%E7%A4%BAcode">创建SEALContext类</a></td></tr></tbody></table><p><strong>EncryptionParameters parms(scheme_type::bfv);</strong></p><pre><code>The BFV scheme cannot perform arbitrary computations on encrypted data.Instead, each ciphertext has a specific quantity called the `invariant noisebudget' -- or `noise budget' for short -- measured in bits. The noise budgetin a freshly encrypted ciphertext (initial noise budget) is determined bythe encryption parameters. Homomorphic operations consume the noise budgetat a rate also determined by the encryption parameters. In BFV the two basicoperations allowed on encrypted data are additions and multiplications, ofwhich additions can generally be thought of as being nearly free in terms ofnoise budget consumption compared to multiplications. Since noise budgetconsumption compounds in sequential multiplications, the most significantfactor in choosing appropriate encryption parameters is the multiplicativedepth of the arithmetic circuit that the user wants to evaluate on encrypteddata. Once the noise budget of a ciphertext reaches zero it becomes toocorrupted to be decrypted. Thus, it is essential to choose the parameters tobe large enough to support the desired computation; otherwise the result isimpossible to make sense of even with the secret key.基本运算: 加法 和乘法 In BFV the two basic operations allowed on encrypted data are additions and multiplications</code></pre><p>基本运算: 加法 和乘法</p><p><strong>size_t poly_modulus_degree = 4096;</strong></p><h3 id="size-t-poly-modulus-degree">size_t poly_modulus_degree</h3><p>多项式模”的次数,2的倍数;1024, 2048, 4096, 8192, 16384, 32768,</p><p><strong>parms.set_poly_modulus_degree(poly_modulus_degree);</strong></p><p><strong>parms.set_coeff_modulus(CoeffModulus::BFVDefault(poly_modulus_degree));</strong></p><h3 id="coeff-modulus">coeff_modulus</h3><details green><summary> code </summary>              <div class='content'>              <p>[ciphertext] `coefficient modulus’ (coeff_modulus) [密文]‘系数模量’ (coeff_modulus)</p><p>Microsoft SEAL comes with helper functions for selecting the coeff_modulus.<br>For new users the easiest way is to simply use<br>简单调用:<br>CoeffModulus::BFVDefault(poly_modulus_degree),<br>返回vector类型<br>which returns std::vector<Modulus> consisting of a generally good choice<br>for the given poly_modulus_degree.<br>模长度对应素数长度<br>±---------------------------------------------------+<br>| poly_modulus_degree | max coeff_modulus bit-length |<br>±--------------------±-----------------------------+<br>| 1024                | 27                           |<br>| 2048                | 54                           |<br>| 4096                | 109                          |<br>| 8192                | 218                          |<br>| 16384               | 438                          |<br>| 32768               | 881                          |<br>±--------------------±-----------------------------+</p>              </div>            </details><p><strong>parms.set_plain_modulus(1024);</strong></p><h3 id="MOD">MOD</h3><pre><code>    ~ log2(coeff_modulus/plain_modulus) (bits)噪声预算计算方式:and the noise budget consumption in a homomorphic multiplication is of theform log2(plain_modulus) + (other terms).明文模量是BFV格式特有的，使用CKKS格式时不能设置明文模量。</code></pre><p>既然所有参数都设置好了，我们就可以构建一个SEALContext了<br>对象。类的有效性和属性是一个重类 我们刚刚设置的参数。</p><h4 id="演示code">演示code</h4><pre class="language-c" data-language="c"><code class="language-c">   EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>bfv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//声明HE 使用的模式</span>   <span class="token comment">// 设置 3 个参数</span>   <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>   parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>   parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">BFVDefault</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   parms<span class="token punctuation">.</span><span class="token function">set_plain_modulus</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 明文 MOD数 (2的倍数, 素数最好)</span>   <span class="token comment">//创建一个context</span>   SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当使用参数创建SEALContext时，Microsoft SEAL将首先创建验证这些参数。这里选择的参数是有效的。</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Parameter validation (success): "</span> <span class="token operator">&lt;&lt;</span> context<span class="token punctuation">.</span><span class="token function">parameter_error_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></code></pre></div><h2 id="二-KeyGenerator类">二 KeyGenerator类</h2><div class="story post-story"><p>公钥加密方案有一个用于加密数据的单独的公钥，和一个用于解密数据的单独的秘密密钥。</p><p>我们需要KeyGenerator类的一个实例。构造密钥生成器会自动生成一个密钥。然后，我们可以使用</p><p>KeyGenerator::create_public_key为它创建尽可能多的公钥。</p><table><thead><tr><th>用法</th><th>参数</th><th>解释说明</th></tr></thead><tbody><tr><td>KeyGenerator keygen(context);</td><td>SEALContext</td><td>创建一个钥匙生成器</td></tr><tr><td>SecretKey secret_key = keygen.secret_key();</td><td></td><td>创造一个私钥</td></tr><tr><td>PublicKey public_key;</td><td></td><td>声明一个公钥</td></tr><tr><td>keygen.create_public_key(public_key);</td><td></td><td>创造一个公钥</td></tr><tr><td>Encryptor encryptor();</td><td>SEALContext，PublicKey</td><td>构造Encryptor的一个实例</td></tr><tr><td>Evaluator evaluator();</td><td>SEALContext</td><td>对密文的计算使用Evaluator类执行</td></tr><tr><td>Decryptor decryptor();</td><td>SEALContext，SecretKey</td><td>构造Decryptor类的一个实例</td></tr><tr><td></td><td></td><td></td></tr></tbody></table> <pre class="language-none"><code class="language-none">Note that KeyGenerator::create_public_key has another overload that takesno parameters and returns a Serializable&lt;PublicKey&gt; object. We will discussthis in &#96;6_serialization.cpp&#39;.</code></pre><p>为了能够加密，我们需要构造Encryptor的一个实例,注意，加密器只需要公钥，</p><p>​Encryptor encryptor(contest,public_key);</p><p>对密文的计算使用Evaluator类执行,Evaluator不会由持有密钥的同一方构造。</p><p>​Evaluator evaluator(context);</p><p>当然，我们希望对结果进行解密，以验证一切工作正常，因此还需要构造Decryptor类的一个实例。注意，解密器需要密钥。</p><p>​Decryptor decryptor(context, secret_key);</p><h4 id="演示code-2">演示code</h4><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c">Ciphertext x_encrypted<span class="token punctuation">;</span> <span class="token comment">// 密文</span>encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>x_plain<span class="token punctuation">,</span> x_encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将明文 x_plain 加密输出到密文x_encrypted上</span>Plaintext x_decrypted<span class="token punctuation">;</span>decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> x_decrypted<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解密 将加密密文,输出覆盖到明文上</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute x_sq_plus_one (x^2+1)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>Ciphertext x_sq_plus_one<span class="token punctuation">;</span>evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> x_sq_plus_one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算平方, 结果输出到 x_sq_plus_one 中</span>Plaintext <span class="token function">plain_one</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 明文 1</span>    <span class="token comment">/**    加密的乘法导致输出密文的大小增加。    更准确地说，如果输入密文的大小为M和N，则输出    同态乘法后的密文大小为M+N-1。    **/</span></code></pre>              </div>            </details></div><h2 id="线性化-Relinearization">线性化 Relinearization</h2><div class="story post-story"><blockquote><p>`Relinearization’ is an operation that reduces the size of a ciphertext after<br>multiplication back to the initial size, 2. Thus, relinearizing one or both<br>input ciphertexts before the next multiplication can have a huge positive<br>impact on both noise growth and performance, even though relinearization has<br>a significant computational cost itself. It is only possible to relinearize<br>size 3 ciphertexts down to size 2, so often the user would want to relinearize<br>after each multiplication to keep the ciphertext sizes at 2.</p><p>Relinearization requires special `relinearization keys’, which can be thought<br>of as a kind of public key. Relinearization keys can easily be created with<br>the KeyGenerator.<br>“重新线性化”是一种减少密文大小的操作。<br>乘法返回初始大小2。因此，重新线性化一个或两个<br>下一个乘法之前的输入密文可以具有很大的正数<br>即使重新线性化已对噪声增长和性能产生影响<br>巨大的计算成本本身。 只能重新线性化<br>大小为3的密文，大小减小为2，因此用户经常需要重新线性化<br>每次乘法后，将密文大小保持为2。</p><p>重新线性化需要特殊的“重新线性化键”，可以认为<br>作为一种公钥。 重新线性化键可以轻松创建<br>KeyGenerator。</p></blockquote><p>线性化用法</p><table><thead><tr><th>用法</th><th>参数</th><th>解释说明</th></tr></thead><tbody><tr><td>RelinKeys relin_keys;</td><td></td><td>声明线性化类</td></tr><tr><td>keygen.create_relin_keys(relin_keys);</td><td>(RelinKeys)</td><td>创建一个线性密钥</td></tr><tr><td>evaluator.relinearize_inplace(x_squared, relin_keys);</td><td>(Ciphertext，RelinKeys)</td><td>将计算结果重新线性化大小到2以内</td></tr></tbody></table><h4 id="演示Code">演示Code</h4><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute and relinearize x_squared (x^2),"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"then compute x_sq_plus_one (x^2+1)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Ciphertext x_squared<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> x_squared<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_squared: "</span> <span class="token operator">&lt;&lt;</span> x_squared<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>x_squared<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 重新线性化大小到2以内</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_squared (after relinearization): "</span> <span class="token operator">&lt;&lt;</span> x_squared<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>     evaluator<span class="token punctuation">.</span><span class="token function">add_plain</span><span class="token punctuation">(</span>x_squared<span class="token punctuation">,</span> plain_one<span class="token punctuation">,</span> x_sq_plus_one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x_sq_plus_one = x_squared +  plain_one;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in x_sq_plus_one: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of x_sq_plus_one: "</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2 <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2 <span class="token operator">>></span> d2<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hex: 0x"</span> <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" Integer: "</span><span class="token operator">&lt;&lt;</span>d2<span class="token operator">&lt;&lt;</span><span class="token string">" ...... Correct. (x^2 + 1 ) "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span></code></pre>              </div>            </details><h1>源代码</h1><details green><summary> code </summary>              <div class='content'>              <pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"seal/seal.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"examples.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>using namespace std<span class="token punctuation">;</span>using namespace seal<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">print_example_banner</span><span class="token punctuation">(</span><span class="token string">"Example: BFV Basics"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    EncryptionParameters <span class="token function">parms</span><span class="token punctuation">(</span>scheme_type<span class="token operator">::</span>bfv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//声明HE 使用的模式</span>    <span class="token comment">// 设置 3 个参数</span>    <span class="token class-name">size_t</span> poly_modulus_degree <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_coeff_modulus</span><span class="token punctuation">(</span>CoeffModulus<span class="token operator">::</span><span class="token function">BFVDefault</span><span class="token punctuation">(</span>poly_modulus_degree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_plain_modulus</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 明文 MOD数 (2的倍数, 素数最好)</span>    <span class="token comment">//创建一个context</span>    SEALContext <span class="token function">context</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Set encryption parameters and print"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hello World!"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Parameter validation (success): "</span> <span class="token operator">&lt;&lt;</span> context<span class="token punctuation">.</span><span class="token function">parameter_error_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~~~~~~ A naive way to calculate 4(x^2+1)(x+1)^2. ~~~~~~"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    KeyGenerator <span class="token function">keygen</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 密钥类</span>    SecretKey secret_key <span class="token operator">=</span> keygen<span class="token punctuation">.</span><span class="token function">secret_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建私钥</span>    PublicKey public_key<span class="token punctuation">;</span>    keygen<span class="token punctuation">.</span><span class="token function">create_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建公钥</span>    Encryptor <span class="token function">encryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 加密类,只需要公钥即可;</span>    Evaluator <span class="token function">evaluator</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 评估计算类</span>    Decryptor <span class="token function">decryptor</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> secret_key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 解密类</span>    <span class="token comment">/**    4x^4 + 8x^3 + 8x^2 + 8x + 4    **/</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>    Plaintext <span class="token function">x_plain</span><span class="token punctuation">(</span><span class="token function">to_string</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//x_plain.to_string() 转换成16进制输出</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Express x = "</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" as a plaintext polynomial 0x"</span> <span class="token operator">+</span> x_plain<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext x_encrypted<span class="token punctuation">;</span><span class="token comment">// 密文类</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Encrypt x_plain to x_encrypted."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    encryptor<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>x_plain<span class="token punctuation">,</span> x_encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of freshly encrypted x: "</span> <span class="token operator">&lt;&lt;</span> x_encrypted<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*There is plenty of noise budget left in this freshly encrypted ciphertext. 噪声预算，当噪音预算降低到0的时候，计算结果不正确*/</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in freshly encrypted x: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Plaintext x_decrypted<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of x_encrypted: "</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> x_decrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"0x"</span> <span class="token operator">&lt;&lt;</span> x_decrypted<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute x_sq_plus_one (x^2+1)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        Ciphertext x_sq_plus_one<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> x_sq_plus_one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算平方, 结果输出到 x_sq_plus_one 中</span>    Plaintext <span class="token function">plain_one</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 明文 1</span>    evaluator<span class="token punctuation">.</span><span class="token function">add_plain_inplace</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> plain_one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x_sq_plus_one = x_sq_plus_one + plain_one</span>        <span class="token comment">/**    加密的乘法导致输出密文的大小增加。    更准确地说，如果输入密文的大小为M和N，则输出    同态乘法后的密文大小为M+N-1。    **/</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_sq_plus_one: "</span> <span class="token operator">&lt;&lt;</span> x_sq_plus_one<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in x_sq_plus_one: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 计算4个多项式样例    * 4x^4 + 8x^3 + 8x^2 + 8x + 4    * 4x^4 + 8x^3 + 8x^2 + 8x + 4 = 4(x + 1)^2 * (x^2 + 1) 转换成 4(x + 1)^2 * (x^2 + 1) 降低多项式系数    */</span>    stringstream ss2<span class="token punctuation">;</span><span class="token comment">//字符串流 ,做字符转换用</span>    <span class="token keyword">int</span> d2<span class="token punctuation">;</span>    <span class="token comment">// 密文计算(x^2+1)  的解密结果为:</span>    Plaintext decrypted_result<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of x_sq_plus_one : "</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2 <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 十六进制输出到ss2，</span>    ss2 <span class="token operator">>></span> d2<span class="token punctuation">;</span> <span class="token comment">// ss2 输出十进制到 d2</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"HEX: 0x"</span> <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" Integer: "</span> <span class="token operator">&lt;&lt;</span> d2 <span class="token operator">&lt;&lt;</span> <span class="token string">" .... Correct. "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    接着密文计算 (x + 1)^2.    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute x_plus_one_sq ((x+1)^2)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Ciphertext x_plus_one_sq<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">add_plain</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> plain_one<span class="token punctuation">,</span> x_plus_one_sq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//密文 x_plus_one_sq = x_encrypted + plain_one (x+1)</span>    evaluator<span class="token punctuation">.</span><span class="token function">square_inplace</span><span class="token punctuation">(</span>x_plus_one_sq<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  x_plus_one_sq = x_plus_one_sq * x_plus_one_sq;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_plus_one_sq: "</span> <span class="token operator">&lt;&lt;</span> x_plus_one_sq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in x_plus_one_sq: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>x_plus_one_sq<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of x_plus_one_sq: "</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_plus_one_sq<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2 <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 十六进制输出到ss2，</span>    ss2 <span class="token operator">>></span> d2<span class="token punctuation">;</span> <span class="token comment">// ss2 输出十进制到 d2</span>    cout<span class="token operator">&lt;&lt;</span><span class="token string">"Hex: Ox"</span><span class="token operator">&lt;&lt;</span>decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" Integer: "</span><span class="token operator">&lt;&lt;</span>d2<span class="token operator">&lt;&lt;</span><span class="token string">" .... Correct. "</span>  <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*        最终计算 (x^2 + 1) * (x + 1)^2 * 4.    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute encrypted_result (4(x^2+1)(x+1)^2)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Ciphertext encrypted_result<span class="token punctuation">;</span>    Plaintext <span class="token function">plain_four</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">multiply_plain_inplace</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> plain_four<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x_sq_plus_one = x_sq_plus_one * 4;</span>    evaluator<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> x_plus_one_sq<span class="token punctuation">,</span> encrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  密文encrypted_result = x_sq_plus_one * x_plus_one_sq ;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of encrypted_result: "</span> <span class="token operator">&lt;&lt;</span> encrypted_result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in encrypted_result: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"NOTE: Decryption can be incorrect if noise budget is zero."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"~~~~~~ A better way to calculate 4(x^2+1)(x+1)^2. ~~~~~~"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    stringstream ss3<span class="token punctuation">;</span>    ss3<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss3 <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss3 <span class="token operator">>></span> d2<span class="token punctuation">;</span> <span class="token comment">// ss2 输出十进制到 d2</span>    cout <span class="token operator">&lt;&lt;</span> d2 <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span> <span class="token comment">// 得到的结果不正确</span>    <span class="token comment">/*    * 利用Relinearization 线性化 对运算进行优化    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Generate relinearization keys."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    RelinKeys relin_keys<span class="token punctuation">;</span> <span class="token comment">// 做线性化类</span>    keygen<span class="token punctuation">.</span><span class="token function">create_relin_keys</span><span class="token punctuation">(</span>relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建线性化密钥</span>    <span class="token comment">/*        We now repeat the computation relinearizing after each multiplication.        我们在每次乘法之后重复重新线性化的计算。    */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute and relinearize x_squared (x^2),"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"then compute x_sq_plus_one (x^2+1)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    Ciphertext x_squared<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> x_squared<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_squared: "</span> <span class="token operator">&lt;&lt;</span> x_squared<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>x_squared<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 重新线性化大小到2以内</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_squared (after relinearization): "</span> <span class="token operator">&lt;&lt;</span> x_squared<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>     evaluator<span class="token punctuation">.</span><span class="token function">add_plain</span><span class="token punctuation">(</span>x_squared<span class="token punctuation">,</span> plain_one<span class="token punctuation">,</span> x_sq_plus_one<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// x_sq_plus_one = x_squared +  plain_one;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in x_sq_plus_one: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of x_sq_plus_one: "</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2 <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss2 <span class="token operator">>></span> d2<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hex: 0x"</span> <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" Integer: "</span><span class="token operator">&lt;&lt;</span>d2<span class="token operator">&lt;&lt;</span><span class="token string">" ...... Correct. (x^2 + 1 ) "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Ciphertext x_plus_one<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute x_plus_one (x+1),"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"then compute and relinearize x_plus_one_sq ((x+1)^2)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">add_plain</span><span class="token punctuation">(</span>x_encrypted<span class="token punctuation">,</span> plain_one<span class="token punctuation">,</span> x_plus_one<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// x_plus_one = x_encrypted +  plain_one;</span>    evaluator<span class="token punctuation">.</span><span class="token function">square</span><span class="token punctuation">(</span>x_plus_one<span class="token punctuation">,</span> x_plus_one_sq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// x_plus_one_sq =  x_plus_one * x_plus_one;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of x_plus_one_sq: "</span> <span class="token operator">&lt;&lt;</span> x_plus_one_sq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>x_plus_one_sq<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 大小线性优化到2内</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in x_plus_one_sq: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>x_plus_one_sq<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of x_plus_one_sq: "</span><span class="token punctuation">;</span>    ss3<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>x_plus_one_sq<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    ss3<span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss3 <span class="token operator">>></span> d2<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hex: 0x"</span> <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" Integer: "</span><span class="token operator">&lt;&lt;</span>d2<span class="token operator">&lt;&lt;</span><span class="token string">" ...... Correct."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Compute and relinearize encrypted_result (4(x^2+1)(x+1)^2)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">multiply_plain_inplace</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> plain_four<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  x_sq_plus_one = x_sq_plus_one * plain_four</span>    evaluator<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>x_sq_plus_one<span class="token punctuation">,</span> x_plus_one_sq<span class="token punctuation">,</span> encrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// encrypted_result = x_sq_plus_one * x_plus_one_sq</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of encrypted_result: "</span> <span class="token operator">&lt;&lt;</span> encrypted_result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    evaluator<span class="token punctuation">.</span><span class="token function">relinearize_inplace</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">,</span> relin_keys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线性优化</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + size of encrypted_result (after relinearization): "</span> <span class="token operator">&lt;&lt;</span> encrypted_result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + noise budget in encrypted_result: "</span> <span class="token operator">&lt;&lt;</span> decryptor<span class="token punctuation">.</span><span class="token function">invariant_noise_budget</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" bits"</span>        <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"NOTE: Notice the increase in remaining noise budget."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>        <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Decrypt encrypted_result (4(x^2+1)(x+1)^2)."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    ss3<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    decryptor<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted_result<span class="token punctuation">,</span> decrypted_result<span class="token punctuation">)</span><span class="token punctuation">;</span>    ss3 <span class="token operator">&lt;&lt;</span> hex <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ss3 <span class="token operator">>></span> d2<span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"    + decryption of 4(x^2+1)(x+1)^2 ,after Mod = Hex: 0x"</span> <span class="token operator">&lt;&lt;</span> decrypted_result<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">&lt;&lt;</span> <span class="token string">" Integer:"</span> <span class="token operator">&lt;&lt;</span> d2 <span class="token operator">&lt;&lt;</span> <span class="token string">" ...... Correct.(4(x^2+1)(x+1)^2)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token comment">/*    * 对于 x=6, 4(x^2+1)(x+1)^2 = 7252. 因为 plaintext modulus MOD被设置为 1024,    * 所以结果%1024.故 7252 % 1024 == 84, 或者16进制： 0x54     */</span>    <span class="token function">print_line</span><span class="token punctuation">(</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"An example of invalid parameters"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    parms<span class="token punctuation">.</span><span class="token function">set_poly_modulus_degree</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    context <span class="token operator">=</span> <span class="token function">SEALContext</span><span class="token punctuation">(</span>parms<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">print_parameters</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Parameter validation (failed): "</span> <span class="token operator">&lt;&lt;</span> context<span class="token punctuation">.</span><span class="token function">parameter_error_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210812092836.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210812092836.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210812092827578"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Microsoft SEAL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Seal </tag>
            
            <tag> 同态加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反射技术拿取和设置Object实体类中的属性</title>
      <link href="/posts/c57ba29d/"/>
      <url>/posts/c57ba29d/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><blockquote><p>@auther by sizaif</p></blockquote><h1>说明</h1><p><strong>在实际项目开发中使用PageHelper插件拿到的数据封装在 PageInfo中,而某些操作需要拿到里面的值和设置一些值,由于Object的缘故,无法直接get和set,所有使用java反射来get和set</strong></p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> contestVO <span class="token operator">:</span> pageInfo<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>XXXXX<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span></code></pre><h1>拿属性的值</h1><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 根据属性名获取属性值 * * @param 要拿取的属性的名称 * @param 实体类 * @return */</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFieldValueByFieldName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Field</span> field <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//设置对象的访问权限，保证对private的属性的访问</span>        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span>  <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h1>设置</h1><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">/** * 根据属性名设置属性值 * * @param 要设置的属性名称 * @param 实体类 * @param 对于要设置的属性类型 * @return */</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValueByFieldName</span><span class="token punctuation">(</span><span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> 对于要设置的属性类型 value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 获取obj类的字节文件对象</span>        <span class="token class-name">Class</span> aClass <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获取该类的成员变量</span>        <span class="token class-name">Field</span> field <span class="token operator">=</span> aClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 取消语言访问检查</span>        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 给变量赋值</span>        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决 Win10 Hyper-v 保留端口占用问题</title>
      <link href="/posts/f8215b18/"/>
      <url>/posts/f8215b18/</url>
      
        <content type="html"><![CDATA[<h1>解决 win10 hyper-v 保留端口占用问题</h1><p>[TOC]</p><h2 id="查找问题">查找问题</h2><div class="story post-story"><p>首先，检查端口占用</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment"># powershell</span>netstat <span class="token operator">-</span>ano <span class="token punctuation">|</span> findstr <span class="token string">":8080"</span></code></pre><p>没有结果，意味着并不是有程序占用了端口。</p><p>猜测可能是更新了win10 2004，导致win10防火墙配置有变更，又检查了一番win10防火墙，发现并没有拦截或者端口禁用的配置。此时，我才想起好像先前开启了hyper-v，最后搜索了一番，找到了出现问题的地方：</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment"># powershell </span><span class="token comment"># 查看系统默认端口占用访问</span>netsh int ipv4 show dynamicport tcp 协议 tcp 动态端口范围<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span><span class="token operator">-</span>启动端口        : 1024端口数          : 13977<span class="token comment"># 查看hyper-v启动后的保留端口范围</span>netsh interface ipv4 show excludedportrange protocol=tcp协议 tcp 端口排除范围 开始端口    结束端口<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">-</span>    <span class="token operator">--</span>-<span class="token operator">--</span>-<span class="token operator">--</span>      1026        1125      1226        1325      1326        1425      1426        1525      1526        1625      2180        2279<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment"># 通过这个可以查看被占用的项目端口是否在这个范围内</span></code></pre>              </div>            </details></div><h2 id="解决办法">解决办法</h2><div class="story post-story"><ol><li>由于直接进行第二步配置，会遇到程序占用(hyper-v占用)，所以需要先关闭hyper-v， 可以win+s 快捷键搜索 “windows功能” ，关闭hyper-v，或者使用下列命令，然后重启</li></ol><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment"># powershell / cmd</span>dism<span class="token punctuation">.</span>exe <span class="token operator">/</span>Online <span class="token operator">/</span><span class="token function">Disable-Feature</span>:Microsoft<span class="token operator">-</span>Hyper<span class="token operator">-</span>V</code></pre><ol><li>配置ipv4动态端口 /  或者配置需要的端口不被占用</li></ol><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token comment"># powershell / cmd 管理员权限</span><span class="token comment"># start 起始端口  num 表示可用端口数     按自己的需求来</span>netsh int ipv4 <span class="token function">set</span> dynamicport tcp <span class="token function">start</span>=30000 num=16383<span class="token comment"># 排除ipv4动态端口占用 startport 起始端口 numberofports 端口数</span>netsh int ipv4 add excludedportrange protocol=tcp startport=50051 numberofports=1</code></pre><ol><li>重启hyper-v</li></ol><p>命令或配置窗口(参考1</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">dism<span class="token punctuation">.</span>exe <span class="token operator">/</span>Online <span class="token operator">/</span><span class="token function">Enable-Feature</span>:Microsoft<span class="token operator">-</span>Hyper<span class="token operator">-</span>V <span class="token operator">/</span>All</code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Win </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Win </tag>
            
            <tag> Hyper-v </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VS2019平台引入C++版tensorflow遇到的一些问题及解决方法</title>
      <link href="/posts/54fe9f8f/"/>
      <url>/posts/54fe9f8f/</url>
      
        <content type="html"><![CDATA[<h1>VS2019平台引入C++版tensorflow遇到的一些问题及解决方法</h1><p>[TOC]</p><h2 id="安装tensorflow">安装tensorflow</h2><div class="story post-story"><p>我采用的是已编译好的tensorflow</p><h3 id="下载tensorflow">下载tensorflow</h3><p><a href="https://github.com/fo40225/tensorflow-windows-wheel">https://github.com/fo40225/tensorflow-windows-wheel</a></p><blockquote><p>注意:</p><p>这里面只有tensorflow1.7<sub>1.10的版本有编译好的cpp库，其他的版本只有编译好的安装tf的python库的whl文件，所以强烈推荐大家用1.7</sub>1.10的tensorflow。</p><p>例如我需要tensorflow1.10的、cpu支持AVX2指令集的版本，就下载tensorflow-windows-wheel/1.10.0/cpp/libtensorflow-cpu-windows-x86_64-1.10.0-avx2.7z</p><p>例如我需要tensorflow1.10的、cpu支持SSE2指令集、且gpu支持CUDA9.2和CUDNN7.2的版本，就下载tensorflow-windows-wheel/1.10.0/cpp/libtensorflow-gpu-windows-x86_64-1.10.0-sse2cuda92cudnn72.7z</p><p>然后把其中的include路径包含进去，把lib文件添加到工程中，再在执行exe时把dll文件复制进去就好了<br>————————————————<br>版权声明：本文为CSDN博主「_沥川往事」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href="https://blog.csdn.net/yuejisuo1948/article/details/84197534">https://blog.csdn.net/yuejisuo1948/article/details/84197534</a></p></blockquote><h3 id="引入tensorflow">引入tensorflow</h3><p>在cmakelist.txt中写入；</p><pre class="language-none"><code class="language-none">include_directories(&lt;Your Path&gt;&#x2F;tensorflow&#x2F;include)link_directories(&lt;Your Path&gt;&#x2F;tensorflow&#x2F;lib)target_link_libraries(&lt;Your exe name&gt; tensorflow)</code></pre></div><h2 id="遇到的问题">遇到的问题:</h2><div class="story post-story"><h3 id="1-“-”-“-”右边的非法标记应输入标记符">1. “(”:“::”右边的非法标记应输入标记符</h3><p>原因处在vc和c++模板库上.min和max与&lt;windows.h&gt;中传统的min/max宏定义有冲突</p><p>在属性-&gt;C/C+±&gt;预处理器-&gt; 预处理定义中 添加<strong>NOMINMAX</strong></p><p><strong>解决方法:</strong></p><img src="https://gitee.com/sizaif/images/raw/master/img/20210228151125.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210228151125.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210228151125411" style="zoom:50%;" /><img src="https://gitee.com/sizaif/images/raw/master/img/20210228151146.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210228151146.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210228151146594" style="zoom:50%;" /><h3 id="2-找不到tensorflow-dll">2.找不到tensorflow.dll</h3><img src="https://gitee.com/sizaif/images/raw/master/img/20210228151404.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210228151404.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210228151404078" style="zoom:80%;" /><p><strong>解决方法:</strong></p><p>==将已编译好的tensorflow的bin目录下 tensorflow.dll 复制到 debug目录下和*.exe一起==</p><p>如图:</p><img src="https://gitee.com/sizaif/images/raw/master/img/20210228151948.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210228151948.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210228151948803" style="zoom:80%;" /><h3 id="3-找不到cublas64-92-dll">3.找不到cublas64_92.dll</h3><p>没安装cuda的缘故</p><p><img src="https://img-blog.csdnimg.cn/img_convert/3604c54b4997219b79641e19a0914c34.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/3604c54b4997219b79641e19a0914c34.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210228154527664"></p><p>我对应的是安装9.2的版本</p><p>参考安装CUDA文章</p><p><a href="https://blog.csdn.net/qq_46126258/article/details/112739305?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&amp;dist_request_id=94a15f6a-35fe-4639-90bf-20c5530f2251&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control">https://blog.csdn.net/qq_46126258/article/details/112739305?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&amp;dist_request_id=94a15f6a-35fe-4639-90bf-20c5530f2251&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.control</a></p><p><strong>安装完后再运行提示 找不到 cudnn64_7.dll</strong></p><p>没有安装对应的cudnn版本</p><p>去nvidia官网安装 <a href="https://developer.nvidia.com/rdp/cudnn-archive">https://developer.nvidia.com/rdp/cudnn-archive</a></p><p>选择对应的Cuda版本 ， 这里选择的就是<img src="https://img-blog.csdnimg.cn/img_convert/537ba6297fe7931b97db5bf79059b340.png" class="lazyload" data-srcset="https://img-blog.csdnimg.cn/img_convert/537ba6297fe7931b97db5bf79059b340.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210228162439099"></p><p>下载后 将对应的文件复制到 CUDA 的安装目录：</p><pre class="language-python" data-language="python"><code class="language-python">a<span class="token punctuation">)</span> Copy <span class="token operator">&lt;</span>installpath<span class="token operator">></span>\cuda\<span class="token builtin">bin</span>\cudnn64_7<span class="token punctuation">.</span>dll to C<span class="token punctuation">:</span>\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9<span class="token punctuation">.</span><span class="token number">2</span>\<span class="token builtin">bin</span><span class="token punctuation">.</span>b<span class="token punctuation">)</span> Copy <span class="token operator">&lt;</span>installpath<span class="token operator">></span>\cuda\ include\cudnn<span class="token punctuation">.</span>h to C<span class="token punctuation">:</span>\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9<span class="token punctuation">.</span><span class="token number">2</span>\include<span class="token punctuation">.</span>c<span class="token punctuation">)</span> Copy <span class="token operator">&lt;</span>installpath<span class="token operator">></span>\cuda\lib\x64\cudnn<span class="token punctuation">.</span>lib to C<span class="token punctuation">:</span>\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v9<span class="token punctuation">.</span><span class="token number">2</span>\lib\x64</code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 机器学习 </category>
          
          <category> 机器学习 </category>
          
          <category> VS2019 </category>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
            <tag> Tensorflow </tag>
            
            <tag> C++ </tag>
            
            <tag> VS2019 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 20.04LTS 编译Tensorflow C++</title>
      <link href="/posts/71bba0f8/"/>
      <url>/posts/71bba0f8/</url>
      
        <content type="html"><![CDATA[<h1>ubuntu 20.04LTS 编译tensorflow C++</h1><blockquote><p>NOTE! 因为ubuntu在虚拟机里,我是用的笔记本的显卡比较落后,安装NVIDIA驱动失败,故未使用 GPU功能,仅使用了CPU模式;</p></blockquote><blockquote><p>编译得到libtensorflow_cc.so和libtensorflow_framework.so 是C++ 所需要的</p></blockquote><p>[TOC]</p><h2 id="tensorflow-和Bazel-以及python-对应的版本">tensorflow 和Bazel 以及python 对应的版本</h2><div class="story post-story"><h3 id="Linux">Linux</h3><h4 id="CPU">CPU</h4><details green><summary> CPU </summary>              <div class='content'>              <table><thead><tr><th style="text-align:left">Version</th><th style="text-align:left">Python version</th><th style="text-align:left">Compiler</th><th style="text-align:left">Build tools</th></tr></thead><tbody><tr><td style="text-align:left">tensorflow-2.4.0</td><td style="text-align:left">3.6-3.8</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 3.1.0</td></tr><tr><td style="text-align:left">tensorflow-2.3.0</td><td style="text-align:left">3.5-3.8</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 3.1.0</td></tr><tr><td style="text-align:left">tensorflow-2.2.0</td><td style="text-align:left">3.5-3.8</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 2.0.0</td></tr><tr><td style="text-align:left">tensorflow-2.1.0</td><td style="text-align:left">2.7, 3.5-3.7</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 0.27.1</td></tr><tr><td style="text-align:left">tensorflow-2.0.0</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 0.26.1</td></tr><tr><td style="text-align:left">tensorflow-1.15.0</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 0.26.1</td></tr><tr><td style="text-align:left">tensorflow-1.14.0</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.24.1</td></tr><tr><td style="text-align:left">tensorflow-1.13.1</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.19.2</td></tr><tr><td style="text-align:left">tensorflow-1.12.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.15.0</td></tr><tr><td style="text-align:left">tensorflow-1.11.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.15.0</td></tr><tr><td style="text-align:left">tensorflow-1.10.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.15.0</td></tr><tr><td style="text-align:left">tensorflow-1.9.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.11.0</td></tr><tr><td style="text-align:left">tensorflow-1.8.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.10.0</td></tr><tr><td style="text-align:left">tensorflow-1.7.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.10.0</td></tr><tr><td style="text-align:left">tensorflow-1.6.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.9.0</td></tr><tr><td style="text-align:left">tensorflow-1.5.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.8.0</td></tr><tr><td style="text-align:left">tensorflow-1.4.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.5.4</td></tr><tr><td style="text-align:left">tensorflow-1.3.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.5</td></tr><tr><td style="text-align:left">tensorflow-1.2.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.5</td></tr><tr><td style="text-align:left">tensorflow-1.1.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.2</td></tr><tr><td style="text-align:left">tensorflow-1.0.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.2</td></tr></tbody></table>              </div>            </details><h4 id="GPU">GPU</h4><details green><summary> GPU </summary>              <div class='content'>              <table><thead><tr><th style="text-align:left">Version</th><th style="text-align:left">Python version</th><th style="text-align:left">Compiler</th><th style="text-align:left">Build tools</th><th style="text-align:left">cuDNN</th><th style="text-align:left">CUDA</th></tr></thead><tbody><tr><td style="text-align:left">tensorflow-2.4.0</td><td style="text-align:left">3.6-3.8</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 3.1.0</td><td style="text-align:left">8.0</td><td style="text-align:left">11.0</td></tr><tr><td style="text-align:left">tensorflow-2.3.0</td><td style="text-align:left">3.5-3.8</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 3.1.0</td><td style="text-align:left">7.6</td><td style="text-align:left">10.1</td></tr><tr><td style="text-align:left">tensorflow-2.2.0</td><td style="text-align:left">3.5-3.8</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 2.0.0</td><td style="text-align:left">7.6</td><td style="text-align:left">10.1</td></tr><tr><td style="text-align:left">tensorflow-2.1.0</td><td style="text-align:left">2.7, 3.5-3.7</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 0.27.1</td><td style="text-align:left">7.6</td><td style="text-align:left">10.1</td></tr><tr><td style="text-align:left">tensorflow-2.0.0</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 0.26.1</td><td style="text-align:left">7.4</td><td style="text-align:left">10.0</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.15.0</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 7.3.1</td><td style="text-align:left">Bazel 0.26.1</td><td style="text-align:left">7.4</td><td style="text-align:left">10.0</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.14.0</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.24.1</td><td style="text-align:left">7.4</td><td style="text-align:left">10.0</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.13.1</td><td style="text-align:left">2.7, 3.3-3.7</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.19.2</td><td style="text-align:left">7.4</td><td style="text-align:left">10.0</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.12.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.15.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.11.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.15.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.10.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.15.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.9.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.11.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.8.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.10.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.7.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.9.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.6.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.9.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.5.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.8.0</td><td style="text-align:left">7</td><td style="text-align:left">9</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.4.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.5.4</td><td style="text-align:left">6</td><td style="text-align:left">8</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.3.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.5</td><td style="text-align:left">6</td><td style="text-align:left">8</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.2.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.5</td><td style="text-align:left">5.1</td><td style="text-align:left">8</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.1.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.2</td><td style="text-align:left">5.1</td><td style="text-align:left">8</td></tr><tr><td style="text-align:left">tensorflow_gpu-1.0.0</td><td style="text-align:left">2.7, 3.3-3.6</td><td style="text-align:left">GCC 4.8</td><td style="text-align:left">Bazel 0.4.2</td><td style="text-align:left">5.1</td><td style="text-align:left">8</td></tr></tbody></table>              </div>            </details></div><h2 id="具体步骤">具体步骤</h2><div class="story post-story"><h3 id="一-首先安装python3-环境-如果你没有安装的话">一 首先安装python3 环境, 如果你没有安装的话</h3><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python3-dev python3-pip</code></pre><blockquote><p>安装TensorFlow 2 .whl包需要一个pip版本&gt;19.0</p></blockquote><h3 id="二-安装-Bazel">二 安装 Bazel</h3><p>这里我才用的是安装程序文件来进行的.</p><p>安装程序可以从Bazel’s下载 <a href="https://github.com/bazelbuild/bazel/releases">https://github.com/bazelbuild/bazel/releases</a>  选择上面你要编译的对应的bazel版本</p><p>安装程序包含Bazel二进制文件，并将其提取到**$HOME/bin**文件夹中。为了让Bazel工作，必须手动安装一些附加库。</p><p>如果没有以下环境. 需要进行安装</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> g++ <span class="token function">unzip</span> <span class="token function">zip</span></code></pre><p>如果想用Bazel 构建JAVA代码, 使用JDK</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># Ubuntu 16.04 (LTS) uses OpenJDK 8 by default:</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openjdk-8-jdk<span class="token comment"># Ubuntu 18.04 (LTS) uses OpenJDK 11 by default:</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openjdk-11-jdk</code></pre><p>下载之后, 运行</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">chmod</span> +x bazel-<span class="token operator">&lt;</span>version<span class="token operator">></span>-installer-linux-x86_64.sh./bazel-<span class="token operator">&lt;</span>version<span class="token operator">></span>-installer-linux-x86_64.sh --user</code></pre><blockquote><p>The <code>--user</code> flag installs Bazel to the <code>$HOME/bin</code> directory on your system and sets the <code>.bazelrc</code> path to <code>$HOME/.bazelrc</code>. Use the <code>--help</code> command to see additional installation options.</p></blockquote><p>当使用–user 来安装时, Bazel 会被安装到 <strong>$HOME/bin</strong>  路径下, 添加环境语句到环境**<sub>/.bashrc**或者**</sub>/.zshrc**变量里</p><p>可以使用VIM</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">vim</span> ~/.bashrc</code></pre><p>添加以下语句</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$PATH</span>:<span class="token environment constant">$HOME</span>/bin"</span></code></pre><p>然后实质生效</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">source</span> ~/.bashrc</code></pre><h3 id="三下载tensorflow源码">三下载tensorflow源码</h3><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">git</span> clone https://github.com/tensorflow/tensorflow.git<span class="token builtin class-name">cd</span> tensorflow</code></pre><p>选择要安装的版本</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> checkout branch_name  <span class="token comment"># r2.2, r2.3, r2.4 etc.</span></code></pre><h3 id="构建环境">构建环境</h3><pre class="language-shell" data-language="shell"><code class="language-shell">./configure</code></pre><h4 id="configure-会话展示">configure 会话展示</h4><p><strong>这里要说明的是如果有CUDA，那么Do you wish to build Tensorflow with CUDA?一定要选Y，然后其它的我基本都是N</strong></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">./configureYou have bazel <span class="token number">3.0</span>.0 installed.Please specify the location of python. <span class="token punctuation">[</span>Default is /usr/bin/python3<span class="token punctuation">]</span>: Found possible Python library paths:  /usr/lib/python3/dist-packages  /usr/local/lib/python3.6/dist-packagesPlease input the desired Python library path to use.  Default is <span class="token punctuation">[</span>/usr/lib/python3/dist-packages<span class="token punctuation">]</span>Do you wish to build TensorFlow with OpenCL SYCL support? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: No OpenCL SYCL support will be enabled <span class="token keyword">for</span> TensorFlow.Do you wish to build TensorFlow with ROCm support? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: No ROCm support will be enabled <span class="token keyword">for</span> TensorFlow.Do you wish to build TensorFlow with CUDA support? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: YCUDA support will be enabled <span class="token keyword">for</span> TensorFlow.Do you wish to build TensorFlow with TensorRT support? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: No TensorRT support will be enabled <span class="token keyword">for</span> TensorFlow.Found CUDA <span class="token number">10.1</span> in:    /usr/local/cuda-10.1/targets/x86_64-linux/lib    /usr/local/cuda-10.1/targets/x86_64-linux/includeFound cuDNN <span class="token number">7</span> in:    /usr/lib/x86_64-linux-gnu    /usr/includePlease specify a list of comma-separated CUDA compute capabilities you want to build with.You can <span class="token function">find</span> the compute capability of your device at: https://developer.nvidia.com/cuda-gpus Each capability can be specified as <span class="token string">"x.y"</span> or <span class="token string">"compute_xy"</span> to include both virtual and binary GPU code, or as <span class="token string">"sm_xy"</span> to only include the binary code.Please note that each additional compute capability significantly increases your build <span class="token function">time</span> and binary size, and that TensorFlow only supports compute capabilities <span class="token operator">>=</span> <span class="token number">3.5</span> <span class="token punctuation">[</span>Default is: <span class="token number">3.5</span>,7.0<span class="token punctuation">]</span>: <span class="token number">6.1</span>Do you want to use clang as CUDA compiler? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: nvcc will be used as CUDA compiler.Please specify <span class="token function">which</span> gcc should be used by nvcc as the <span class="token function">host</span> compiler. <span class="token punctuation">[</span>Default is /usr/bin/gcc<span class="token punctuation">]</span>: Please specify optimization flags to use during compilation when bazel option <span class="token string">"--config=opt"</span> is specified <span class="token punctuation">[</span>Default is -march<span class="token operator">=</span>native -Wno-sign-compare<span class="token punctuation">]</span>: Would you like to interactively configure ./WORKSPACE <span class="token keyword">for</span> Android builds? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: Not configuring the WORKSPACE <span class="token keyword">for</span> Android builds.Preconfigured Bazel build configs. You can use any of the below by adding <span class="token string">"--config=&lt;>"</span> to your build command. See .bazelrc <span class="token keyword">for</span> <span class="token function">more</span> details.    --config<span class="token operator">=</span>mkl            <span class="token comment"># Build with MKL support.</span>    --config<span class="token operator">=</span>monolithic     <span class="token comment"># Config for mostly static monolithic build.</span>    --config<span class="token operator">=</span>ngraph         <span class="token comment"># Build with Intel nGraph support.</span>    --config<span class="token operator">=</span>numa           <span class="token comment"># Build with NUMA support.</span>    --config<span class="token operator">=</span>dynamic_kernels    <span class="token comment"># (Experimental) Build kernels into separate shared objects.</span>    --config<span class="token operator">=</span>v2             <span class="token comment"># Build TensorFlow 2.x instead of 1.x.</span>Preconfigured Bazel build configs to DISABLE default on features:    --config<span class="token operator">=</span>noaws          <span class="token comment"># Disable AWS S3 filesystem support.</span>    --config<span class="token operator">=</span>nogcp          <span class="token comment"># Disable GCP support.</span>    --config<span class="token operator">=</span>nohdfs         <span class="token comment"># Disable HDFS support.</span>    --config<span class="token operator">=</span>nonccl         <span class="token comment"># Disable NVIDIA NCCL support.</span>Configuration finished</code></pre>              </div>            </details><h3 id="编译">编译</h3><p>配置好之后就进行编译：若采用CUDA 则如下</p><pre class="language-shell" data-language="shell"><code class="language-shell">bazel build --config<span class="token operator">=</span>opt --config<span class="token operator">=</span>cuda //tensorflow:libtensorflow_cc.so</code></pre><p>​这里如果不用cuda的话(前面配置的时候在CUDA那一项那里输入N)，就输入：</p><pre class="language-shell" data-language="shell"><code class="language-shell">bazel build --config<span class="token operator">=</span>opt  //tensorflow:libtensorflow_cc.so</code></pre><p><strong>可能会遇到的问题:</strong></p><ol><li><p><strong>/usr/bin/env: ‘python‘: No such file or directory</strong></p><p>如果以及安装了python3的版本,可能是因为显示的是python3.X 但用的的名称为python</p><p>所以可以建立一个软连接</p><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">whereis</span> python3<span class="token comment"># 如果安装的话,默认在/usr/bin/目录下sudo ln -s /usr/bin/python3 /usr/bin/python</span></code></pre></li></ol><p>接下来就是漫长的等待,</p><p>因为我没有用CUDA( NVIDIA的驱动没有安装上,所以用不了GPU加速) 耗时3+小时<img src="https://gitee.com/sizaif/images/raw/master/img/20210415213108.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210415213108.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>最终会在 当前目录下生成一个 bazel-bin 目录下 tensorflow 里 找到这两个文件</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210415213223.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210415213223.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210415213223587"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 机器学习 </category>
          
          <category> 机器学习 </category>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
            <tag> Tensorflow </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tensorflow-C++ &amp; OpenCV &amp; OpenBlas &amp; Eigen3 &amp; Protobuf 环境Docker镜像</title>
      <link href="/posts/1c98e054/"/>
      <url>/posts/1c98e054/</url>
      
        <content type="html"><![CDATA[<h1>tensorflow-C++ &amp; OpenCV &amp; OpenBlas &amp; eigen3 &amp; protobuf 环境docker镜像</h1><p>[toc]</p><h2 id="版本">版本</h2><div class="story post-story"><pre class="language-bash" data-language="bash"><code class="language-bash">tensorflow  <span class="token number">2.4</span>.1protobuf <span class="token number">3.9</span>.2opencv <span class="token number">4.5</span>.2openblas <span class="token number">0.3</span>.13eigen3 <span class="token number">3.3</span>.9</code></pre></div><h2 id="使用方法">使用方法:</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载镜像</span>docker pull sizaif2000/siz:1.0<span class="token comment"># 运行后 在 /home/tf_test/  下有 tensorflow 测试</span>--------docker run -p 本机映射端口:镜像映射端口 -d  --name 启动镜像名称 -e 镜像启动参数  镜像名称:镜像版本号       参数释义：     -p   本机端口和容器启动端口映射     -d   后台运行     --name   容器名称     -e    镜像启动参数------------------------tf_test <span class="token builtin class-name">.</span><span class="token operator">|</span>-- CMakeLists.txt<span class="token operator">|</span>-- README.md<span class="token variable"><span class="token variable">`</span>-- src    <span class="token variable">`</span></span>-- main.cpp<span class="token number">1</span> directory, <span class="token number">3</span> files------------------------<span class="token builtin class-name">cd</span> tf_testcmake.<span class="token function">make</span>./main<span class="token comment"># if ok, then you can see like this: </span>This is tensorflow <span class="token builtin class-name">test</span>XXXX-XX-XX 03:55:33.709188: I tensorflow/core/platform/cpu_feature_guard.cc:142<span class="token punctuation">]</span> This TensorFlow binary is optimized with oneAPI Deep Neural Network Library <span class="token punctuation">(</span>oneDNN<span class="token punctuation">)</span> to use the following CPU instructions <span class="token keyword">in</span> performance-critical operations:  SSE3 SSE4.1 SSE4.2AVX AVX2 FMATo <span class="token builtin class-name">enable</span> them <span class="token keyword">in</span> other operations, rebuild TensorFlow with the appropriate compiler flags.OKSession successfully created.</code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 机器学习 </category>
          
          <category> 机器学习 </category>
          
          <category> OpenCV </category>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> Tensorflow </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tensorflow V2.4 C++ 编译测试遇到的问题以及相关解决方法</title>
      <link href="/posts/fabe9f4f/"/>
      <url>/posts/fabe9f4f/</url>
      
        <content type="html"><![CDATA[<h1>tensorflow V2.4 C++ 编译测试遇到的问题以及相关解决方法</h1><p>[TOC]</p><h2 id="fatal-error-absl-strings-string-view-h-No-such-file-or-directory">fatal error: <em>absl/strings/string_view.h:</em> <em>No</em> <em>such</em> <em>file</em> <em>or</em> <em>directory</em></h2><div class="story post-story"><p><strong>解决方法:</strong></p><p>将 <a href="https://github.com/abseil/abseil-cpp">https://github.com/abseil/abseil-cpp</a> 项目中 git下来, 将 <code>absl</code> 目录下所有文件 复制到 <code>tensorflow/</code> 目录下</p><p><code>/usr/local/include/tf/tensorflow</code>  为 tensorflow 的 头文件位置</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/abseil/abseil-cpp<span class="token function">sudo</span> <span class="token function">cp</span> -r ./abseil-cpp/absl /usr/local/include/tf/tensorflow</code></pre></div><h2 id="atal-error-tensorflow-core-protobuf-error-codes-pb-h-No-such-file-or-directory">atal error: tensorflow/core/protobuf/error_codes.pb.h: No such file or directory</h2><div class="story post-story"><p><strong>解决方法</strong></p><p>先查看 tensorflow  头文件 目录下 <code>/usr/local/include/tf/tensorflow/core/protobuf/</code>    下有无此文件,</p><p>若无,则有可能在 <code>bazel-bin/tensorflow/core/proto</code>buf 目录下</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 当前在tensorflow 源码目录下</span><span class="token function">sudo</span> <span class="token function">cp</span> -r ./bazel-bin/tensorflow/ /usr/local/indlue/tf/tensorflow</code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 机器学习 </category>
          
          <category> 机器学习 </category>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 机器学习 </tag>
            
            <tag> Tensorflow </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tensorflow 与Protobuf版本对应问题</title>
      <link href="/posts/a689049b/"/>
      <url>/posts/a689049b/</url>
      
        <content type="html"><![CDATA[<h1>tensorflow 与protobuf版本对应问题</h1><p>[TOC]</p><h2 id="问题描述">问题描述</h2><div class="story post-story"><p>我在前面的文章编译了tensorflow <strong>2.4.1</strong>版本, 然后随之又根据protobuf github教程安装了<strong>3.15</strong>版本的protobuf</p><p>当我在编译代码引入tensorflow 时 提示如下错误:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210416225507.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210416225507.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210416225506542"></p><p>当我运行如下命令; 得到protoc的位置,和版本信息</p><pre class="language-bash" data-language="bash"><code class="language-bash">siz@ubuntu:~$ <span class="token function">which</span> protoc/usr/local/bin/protocsiz@ubuntu:~$  protoc --versionlibprotoc <span class="token number">3.15</span>.8</code></pre><p>查阅博客得到如下信息:</p><p>(参考链接: <a href="https://blog.csdn.net/datase/article/details/82347834">https://blog.csdn.net/datase/article/details/82347834</a>)</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210416230046.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210416230046.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210416230046528"></p><p>我想我遇到的应该是第二个问题:</p><p>所以我去了<a href="https://github.com/tensorflow/tensorflow">tensorflow github</a> 查看了 workspace.bzl 信息: 对应的 protobuf的版本为3.9.2;</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210416230256.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210416230256.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210416230256366"></p></div><h2 id="尝试解决">尝试解决</h2><div class="story post-story"><h3 id="卸载-protobuf">卸载 protobuf</h3><p>==Note! 因为之前第一次安装protobuf 采用的是覆盖安装,所以将Ubuntu自带的protobuf覆盖掉了, 所以我选择直接卸载掉最新的,重新安装,没有采用兼容安装的方式==</p><p>删除方式, 进入到下载的protobuf 路径里, 采用 <strong>make uninstall</strong> 方式</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">siz@ubuntu:~/soft$ <span class="token builtin class-name">cd</span> protobuf-3.15.8/siz@ubuntu:~/soft/protobuf-3.15.8$ <span class="token function">sudo</span> <span class="token function">make</span> uninstall<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> siz: Making uninstall <span class="token keyword">in</span> <span class="token builtin class-name">.</span>make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Entering directory <span class="token string">'/home/siz/soft/protobuf-3.15.8'</span> <span class="token punctuation">(</span> <span class="token builtin class-name">cd</span> <span class="token string">'/usr/local/lib/pkgconfig'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -f protobuf.pc protobuf-lite.pc <span class="token punctuation">)</span>make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/siz/soft/protobuf-3.15.8'</span>Making uninstall <span class="token keyword">in</span> srcmake<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Entering directory <span class="token string">'/home/siz/soft/protobuf-3.15.8/src'</span> <span class="token punctuation">(</span> <span class="token builtin class-name">cd</span> <span class="token string">'/usr/local/bin'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -f protoc <span class="token punctuation">)</span> /bin/bash <span class="token punctuation">..</span>/libtool   --mode<span class="token operator">=</span>uninstall <span class="token function">rm</span> -f <span class="token string">'/usr/local/lib/libprotobuf-lite.la'</span>libtool: uninstall: <span class="token function">rm</span> -f /usr/local/lib/libprotobuf-lite.la /usr/local/lib/libprotobuf-lite.a /bin/bash <span class="token punctuation">..</span>/libtool   --mode<span class="token operator">=</span>uninstall <span class="token function">rm</span> -f <span class="token string">'/usr/local/lib/libprotobuf.la'</span>libtool: uninstall: <span class="token function">rm</span> -f /usr/local/lib/libprotobuf.la /usr/local/lib/libprotobuf.a /bin/bash <span class="token punctuation">..</span>/libtool   --mode<span class="token operator">=</span>uninstall <span class="token function">rm</span> -f <span class="token string">'/usr/local/lib/libprotoc.la'</span>libtool: uninstall: <span class="token function">rm</span> -f /usr/local/lib/libprotoc.la /usr/local/lib/libprotoc.a <span class="token punctuation">(</span> <span class="token builtin class-name">cd</span> <span class="token string">'/usr/local/include'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -f google/protobuf/descriptor.proto google/protobuf/any.proto google/protobuf/api.proto google/protobuf/duration.proto google/protobuf/empty.proto google/protobuf/field_mask.proto google/protobuf/source_context.proto google/protobuf/struct.proto google/protobuf/timestamp.proto google/protobuf/type.proto google/protobuf/wrappers.proto google/protobuf/compiler/plugin.proto <span class="token punctuation">)</span> <span class="token punctuation">(</span> <span class="token builtin class-name">cd</span> <span class="token string">'/usr/local/include'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -f google/protobuf/stubs/callback.h google/protobuf/stubs/bytestream.h google/protobuf/stubs/casts.h google/protobuf/stubs/common.h google/protobuf/stubs/hash.h google/protobuf/stubs/logging.h google/protobuf/stubs/macros.h google/protobuf/stubs/map_util.h google/protobuf/stubs/mutex.h google/protobuf/stubs/once.h google/protobuf/stubs/platform_macros.h google/protobuf/stubs/port.h google/protobuf/stubs/status.h google/protobuf/stubs/stl_util.h google/protobuf/stubs/stringpiece.h google/protobuf/stubs/strutil.h google/protobuf/stubs/template_util.h google/protobuf/any.pb.h google/protobuf/api.pb.h google/protobuf/any.h google/protobuf/arena.h google/protobuf/arena_impl.h google/protobuf/arenastring.h google/protobuf/descriptor_database.h google/protobuf/descriptor.h google/protobuf/descriptor.pb.h google/protobuf/duration.pb.h google/protobuf/dynamic_message.h google/protobuf/empty.pb.h google/protobuf/extension_set.h google/protobuf/extension_set_inl.h google/protobuf/field_mask.pb.h google/protobuf/generated_enum_reflection.h google/protobuf/generated_enum_util.h google/protobuf/generated_message_reflection.h google/protobuf/generated_message_table_driven.h google/protobuf/generated_message_util.h google/protobuf/has_bits.h google/protobuf/implicit_weak_message.h google/protobuf/io/io_win32.h google/protobuf/map_entry.h google/protobuf/map_entry_lite.h google/protobuf/map_field.h google/protobuf/map_field_inl.h google/protobuf/map_field_lite.h google/protobuf/map.h google/protobuf/map_type_handler.h google/protobuf/message.h google/protobuf/message_lite.h google/protobuf/metadata.h google/protobuf/metadata_lite.h google/protobuf/parse_context.h google/protobuf/port.h google/protobuf/port_def.inc google/protobuf/port_undef.inc google/protobuf/reflection.h google/protobuf/reflection_ops.h google/protobuf/repeated_field.h google/protobuf/service.h google/protobuf/source_context.pb.h google/protobuf/struct.pb.h google/protobuf/text_format.h google/protobuf/timestamp.pb.h google/protobuf/type.pb.h google/protobuf/unknown_field_set.h google/protobuf/wire_format.h google/protobuf/wire_format_lite.h google/protobuf/wrappers.pb.h google/protobuf/io/coded_stream.h google/protobuf/io/gzip_stream.h google/protobuf/io/printer.h google/protobuf/io/strtod.h google/protobuf/io/tokenizer.h google/protobuf/io/zero_copy_stream.h google/protobuf/io/zero_copy_stream_impl.h google/protobuf/io/zero_copy_stream_impl_lite.h google/protobuf/compiler/code_generator.h google/protobuf/compiler/command_line_interface.h google/protobuf/compiler/importer.h google/protobuf/compiler/parser.h google/protobuf/compiler/plugin.h google/protobuf/compiler/plugin.pb.h google/protobuf/compiler/cpp/cpp_generator.h google/protobuf/compiler/csharp/csharp_generator.h google/protobuf/compiler/csharp/csharp_names.h google/protobuf/compiler/java/java_generator.h google/protobuf/compiler/java/java_names.h google/protobuf/compiler/js/js_generator.h google/protobuf/compiler/js/well_known_types_embed.h google/protobuf/compiler/objectivec/objectivec_generator.h google/protobuf/compiler/objectivec/objectivec_helpers.h google/protobuf/compiler/php/php_generator.h google/protobuf/compiler/python/python_generator.h google/protobuf/compiler/ruby/ruby_generator.h google/protobuf/util/type_resolver.h google/protobuf/util/delimited_message_util.h google/protobuf/util/field_comparator.h google/protobuf/util/field_mask_util.h google/protobuf/util/json_util.h google/protobuf/util/time_util.h google/protobuf/util/type_resolver_util.h google/protobuf/util/message_differencer.h <span class="token punctuation">)</span>make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/siz/soft/protobuf-3.15.8/src'</span>siz@ubuntu:~/soft/protobuf-3.15.8$ <span class="token function">which</span> protocsiz@ubuntu:~/soft/protobuf-3.15.8$ </code></pre>              </div>            </details><h3 id="重新安装protobuf">重新安装protobuf</h3><p>protobuf github release 地址: <a href="https://github.com/protocolbuffers/protobuf/releases">https://github.com/protocolbuffers/protobuf/releases</a></p><p>下载对应的3.92版本: 并解压</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> protobuf-XXX/./autogen.sh./configure <span class="token function">make</span> <span class="token function">make</span> check <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token function">sudo</span> ldconfig <span class="token comment"># refresh shared library cache.</span></code></pre><p>查看版本 protoc --version</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210417131632.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210417131632.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210417131632662"></p><p>至此安装完成</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 机器学习 </category>
          
          <category> 机器学习 </category>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> Tensorflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenSSL 使用手册</title>
      <link href="/posts/e82eda1b/"/>
      <url>/posts/e82eda1b/</url>
      
        <content type="html"><![CDATA[<h1>OpenSSL 命令行解析</h1><blockquote><p>😄 @Auther: sizaif</p><p>📆 2021-05-09  16:32:02</p></blockquote><p>[TOC]</p><p>参考文档</p><p>服务端: <a href="https://www.openssl.org/docs/man1.0.2/man1/openssl-s_server.html">https://www.openssl.org/docs/man1.0.2/man1/openssl-s_server.html</a></p><p>客户端:<a href="https://www.openssl.org/docs/man1.0.2/man1/s_client.html">https://www.openssl.org/docs/man1.0.2/man1/s_client.html</a></p><p>OpenSSL命令分为以下3个部分。<br><img src="https://img-blog.csdn.net/20170205231250664?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2N1eXhp/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" class="lazyload" data-srcset="https://img-blog.csdn.net/20170205231250664?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2N1eXhp/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>标准命令Standard commands</p><h3 id="1-asn1parse">1.asn1parse:</h3><p>asn1parse用于解释用ANS.1语法书写的语句(ASN一般用于定义语法的构成)</p><p>演示命令操作顺序：4 -&gt; 5 -&gt; 3 -&gt; 2-&gt; 6 -&gt; 7 -&gt;8</p><h3 id="2-ca"><a href="http://2.ca">2.ca</a>:</h3><p>ca用于CA的管理.<br>用法：</p><blockquote><p>openssl ca [-options]。</p></blockquote><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">2.1</span><span class="token punctuation">)</span> -selfsign使用对证书请求进行签名的密钥对来签发证书。即<span class="token string">"自签名"</span>，这种情况发生在生成证书的客户端、签发证书的CA都是同一台机器<span class="token punctuation">(</span>也是我们大多数实验中的情况<span class="token punctuation">)</span>，我们可以使用同一个密钥对来进行<span class="token string">"自签名"</span><span class="token number">2.2</span><span class="token punctuation">)</span> -in <span class="token function">file</span>需要进行处理的PEM格式的证书<span class="token number">2.3</span><span class="token punctuation">)</span> -out <span class="token function">file</span>处理结束后输出的证书文件<span class="token number">2.4</span><span class="token punctuation">)</span> -cert <span class="token function">file</span>用于签发的根CA证书<span class="token number">2.5</span><span class="token punctuation">)</span> -days arg 指定签发的证书的有效时间<span class="token number">2.6</span><span class="token punctuation">)</span> -keyfile arg   CA的私钥证书文件<span class="token number">2.7</span><span class="token punctuation">)</span> -keyform argCA的根私钥证书文件格式:    <span class="token number">2.7</span>.1<span class="token punctuation">)</span> PEM    <span class="token number">2.7</span>.2<span class="token punctuation">)</span> ENGINE <span class="token number">2.8</span><span class="token punctuation">)</span> -key arg   CA的根私钥证书文件的解密密码<span class="token punctuation">(</span>如果加密了的话<span class="token punctuation">)</span><span class="token number">2.9</span><span class="token punctuation">)</span> -config <span class="token function">file</span>    配置文件</code></pre>              </div>            </details><h3 id="3-X-509证书签发请求-CSR-管理">3. X.509证书签发请求(CSR)管理</h3><p>用法：</p><blockquote><p>openssl req [options] outfile</p></blockquote><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">3.1</span><span class="token punctuation">)</span> -inform arg输入文件格式    <span class="token number">3.1</span>.1<span class="token punctuation">)</span> DER    <span class="token number">3.1</span>.2<span class="token punctuation">)</span> PEM<span class="token number">3.2</span><span class="token punctuation">)</span> -outform arg   输出文件格式    <span class="token number">3.2</span>.1<span class="token punctuation">)</span> DER    <span class="token number">3.2</span>.2<span class="token punctuation">)</span> PEM<span class="token number">3.3</span><span class="token punctuation">)</span> -in arg待处理文件<span class="token number">3.4</span><span class="token punctuation">)</span> -out arg待输出文件<span class="token number">3.5</span><span class="token punctuation">)</span> -passin        用于签名待生成的请求证书的私钥文件的解密密码<span class="token number">3.6</span><span class="token punctuation">)</span> -key <span class="token function">file</span>用于签名待生成的请求证书的私钥文件<span class="token number">3.7</span><span class="token punctuation">)</span> -keyform arg      <span class="token number">3.7</span>.1<span class="token punctuation">)</span> DER    <span class="token number">3.7</span>.2<span class="token punctuation">)</span> NET    <span class="token number">3.7</span>.3<span class="token punctuation">)</span> PEM<span class="token number">3.8</span><span class="token punctuation">)</span> -new新的请求<span class="token number">3.9</span><span class="token punctuation">)</span> -x509          输出一个X509格式的证书 <span class="token number">3.10</span><span class="token punctuation">)</span> -daysX509证书的有效时间  <span class="token number">3.11</span><span class="token punctuation">)</span> -newkey rsa:bits 生成一个bits长度的RSA私钥文件，用于签发  <span class="token number">3.12</span><span class="token punctuation">)</span> -<span class="token punctuation">[</span>digest<span class="token punctuation">]</span>HASH算法    <span class="token number">3.12</span>.1<span class="token punctuation">)</span> md5    <span class="token number">3.12</span>.2<span class="token punctuation">)</span> sha1    <span class="token number">3.12</span>.3<span class="token punctuation">)</span> md2    <span class="token number">3.12</span>.4<span class="token punctuation">)</span> mdc2    <span class="token number">3.12</span>.5<span class="token punctuation">)</span> md4<span class="token number">3.13</span><span class="token punctuation">)</span> -config <span class="token function">file</span>   指定openssl配置文件<span class="token number">3.14</span><span class="token punctuation">)</span> -text: text显示格式</code></pre>              </div>            </details><h3 id="4-genrsa-生成RSA参数">4. genrsa: 生成RSA参数</h3><p>用法：</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">openssl genrsa <span class="token punctuation">[</span>args<span class="token punctuation">]</span> <span class="token punctuation">[</span>numbits<span class="token punctuation">]</span><span class="token number">4.1</span><span class="token punctuation">)</span> 对生成的私钥文件是否要使用加密算法进行对称加密:<span class="token number">4.1</span>.1<span class="token punctuation">)</span> -des: CBC模式的DES加密<span class="token number">4.1</span>.2<span class="token punctuation">)</span> -des3: CBC模式的3DES加密<span class="token number">4.1</span>.3<span class="token punctuation">)</span> -aes128: CBC模式的AES128加密<span class="token number">4.1</span>.4<span class="token punctuation">)</span> -aes192: CBC模式的AES192加密<span class="token number">4.1</span>.5<span class="token punctuation">)</span> -aes256: CBC模式的AES256加密<span class="token number">4.2</span><span class="token punctuation">)</span> -passout arg: arg为对称加密<span class="token punctuation">(</span>des、3des、aes<span class="token punctuation">)</span>的密码<span class="token punctuation">(</span>使用这个参数就省去了console交互提示输入密码的环节<span class="token punctuation">)</span><span class="token number">4.3</span><span class="token punctuation">)</span> -out file: 输出证书私钥文件<span class="token punctuation">[</span>numbits<span class="token punctuation">]</span>: 密钥长度example: 生成一个1024位的RSA私钥，并用3DES加密<span class="token punctuation">(</span>密码为123456<span class="token punctuation">)</span>，保存为server.key文件openssl genrsa -out server.key -passout pass:123456 -des3 <span class="token number">1024</span></code></pre>              </div>            </details><h3 id="5-RSA数据管理">5. RSA数据管理</h3><p>用法：</p><blockquote><p>openssl rsa [options] outfile</p></blockquote><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">5.1</span><span class="token punctuation">)</span> -inform arg输入密钥文件格式:    <span class="token number">5.1</span>.1<span class="token punctuation">)</span> DER<span class="token punctuation">(</span>ASN1<span class="token punctuation">)</span>    <span class="token number">5.1</span>.2<span class="token punctuation">)</span> NET    <span class="token number">5.1</span>.3<span class="token punctuation">)</span> PEM<span class="token punctuation">(</span>base64编码格式<span class="token punctuation">)</span> <span class="token number">5.2</span><span class="token punctuation">)</span> -outform arg 输出密钥文件格式    <span class="token number">5.2</span>.1<span class="token punctuation">)</span> DER    <span class="token number">5.2</span>.2<span class="token punctuation">)</span> NET    <span class="token number">5.2</span>.3<span class="token punctuation">)</span> PEM<span class="token number">5.3</span><span class="token punctuation">)</span> -in arg待处理密钥文件 <span class="token number">5.4</span><span class="token punctuation">)</span> -passin arg输入这个加密密钥文件的解密密钥<span class="token punctuation">(</span>如果在生成这个密钥文件的时候，选择了加密算法了的话<span class="token punctuation">)</span><span class="token number">5.5</span><span class="token punctuation">)</span> -out arg待输出密钥文件<span class="token number">5.6</span><span class="token punctuation">)</span> -passout arg  如果希望输出的密钥文件继续使用加密算法的话则指定密码 <span class="token number">5.7</span><span class="token punctuation">)</span> -des: CBC模式的DES加密<span class="token number">5.8</span><span class="token punctuation">)</span> -des3: CBC模式的3DES加密<span class="token number">5.9</span><span class="token punctuation">)</span> -aes128: CBC模式的AES128加密<span class="token number">5.10</span><span class="token punctuation">)</span> -aes192: CBC模式的AES192加密<span class="token number">5.11</span><span class="token punctuation">)</span> -aes256: CBC模式的AES256加密<span class="token number">5.12</span><span class="token punctuation">)</span> -text: 以text形式打印密钥key数据 <span class="token number">5.13</span><span class="token punctuation">)</span> -noout: 不打印密钥key数据 <span class="token number">5.14</span><span class="token punctuation">)</span> -pubin: 检查待处理文件是否为公钥文件<span class="token number">5.15</span><span class="token punctuation">)</span> -pubout: 输出公钥文件</code></pre>              </div>            </details><h3 id="6-x509">6. x509</h3><p>openssl x509是一个功能很丰富的证书处理工具。可以用来显示证书的内容，转换其格式，给CSR签名等X.509证书的管理工作<br>用法：</p><blockquote><p>openssl x509 [args]</p></blockquote><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">6.1</span><span class="token punctuation">)</span> -inform arg待处理X509证书文件格式    <span class="token number">6.1</span>.1<span class="token punctuation">)</span> DER    <span class="token number">6.1</span>.2<span class="token punctuation">)</span> NET    <span class="token number">6.1</span>.3<span class="token punctuation">)</span> PEM<span class="token number">6.2</span><span class="token punctuation">)</span> -outform arg   待输出X509证书文件格式    <span class="token number">6.2</span>.1<span class="token punctuation">)</span> DER    <span class="token number">6.2</span>.2<span class="token punctuation">)</span> NET    <span class="token number">6.2</span>.3<span class="token punctuation">)</span> PEM<span class="token number">6.3</span><span class="token punctuation">)</span> -in arg 待处理X509证书文件<span class="token number">6.4</span><span class="token punctuation">)</span> -out arg       待输出X509证书文件<span class="token number">6.5</span><span class="token punctuation">)</span> -req            表明输入文件是一个<span class="token string">"请求签发证书文件(CSR)"</span>，等待进行签发 <span class="token number">6.6</span><span class="token punctuation">)</span> -days arg       表明将要签发的证书的有效时间 <span class="token number">6.7</span><span class="token punctuation">)</span> -CA arg 指定用于签发请求证书的根CA证书 <span class="token number">6.8</span><span class="token punctuation">)</span> -CAform arg     根CA证书格式<span class="token punctuation">(</span>默认是PEM<span class="token punctuation">)</span> <span class="token number">6.9</span><span class="token punctuation">)</span> -CAkey arg      指定用于签发请求证书的CA私钥证书文件，如果这个option没有参数输入，那么缺省认为私有密钥在CA证书文件里有<span class="token number">6.10</span><span class="token punctuation">)</span> -CAkeyform arg  指定根CA私钥证书文件格式<span class="token punctuation">(</span>默认为PEM格式<span class="token punctuation">)</span><span class="token number">6.11</span><span class="token punctuation">)</span> -CAserial arg   指定序列号文件<span class="token punctuation">(</span>serial number <span class="token function">file</span><span class="token punctuation">)</span><span class="token number">6.12</span><span class="token punctuation">)</span> -CAcreateserial 如果序列号文件<span class="token punctuation">(</span>serial number <span class="token function">file</span><span class="token punctuation">)</span>没有指定，则自动创建它     </code></pre>              </div>            </details><h3 id="7-dhparam">7 dhparam</h3><p>openssl dhparam用于生成和管理dh文件。dh(Diffie-Hellman)是著名的密钥交换协议，或称为密钥协商协议，它可以保证通信双方安全地交换密钥。但注意，它不是加密算法，所以不提供加密功能，仅仅只是保护密钥交换的过程。在openvpn中就使用了该交换协议</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">openssl dhparam <span class="token punctuation">[</span>-in filename<span class="token punctuation">]</span> <span class="token punctuation">[</span>-out filename<span class="token punctuation">]</span> <span class="token punctuation">[</span>-dsaparam<span class="token punctuation">]</span> <span class="token punctuation">[</span>-noout<span class="token punctuation">]</span> <span class="token punctuation">[</span>-text<span class="token punctuation">]</span> <span class="token punctuation">[</span>-rand file<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>numbits<span class="token punctuation">]</span>选项说明：-in filename：从filename文件中读取密钥交换协议参数。-out filename：输出密钥交换协议参数到filename文件。-dsaparam：指定此选项将使用dsa交换协议替代dh交换协议。虽然生成速度更快，但更不安全。-noout：禁止输出任何信息。-text：以文本格式输出dh协议。-rand：指定随机数种子文件。numbits：指定生成的长度。</code></pre>              </div>            </details><h1>使用</h1><h2 id="客户端">客户端</h2><div class="story post-story"><pre class="language-bash" data-language="bash"><code class="language-bash">openssl s_client -key ./experiments/keystore/client.key -cert ./experiments/keystore/client.crt -CAfile ./experiments/keystore/demoCA/cacert.pem </code></pre></div><h2 id="服务端">服务端</h2><div class="story post-story"><pre class="language-bash" data-language="bash"><code class="language-bash">openssl s_server -key ./experiments/keystore/server.key -cert ./experiments/keystore/server.crt -CAfile ./experiments/keystore/demoCA/cacert.pem -accept <span class="token number">4433</span> -HTTP</code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 笔记 </category>
          
          <category> SSL </category>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
            <tag> 笔记 </tag>
            
            <tag> OpenSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenCV Tensorflow C++API   Protobuf Eigen3 编译过程</title>
      <link href="/posts/56ff1cb1/"/>
      <url>/posts/56ff1cb1/</url>
      
        <content type="html"><![CDATA[<h1>OpenCV Tensorflow C++API   Protobuf eigen3 编译过程</h1><blockquote><p>@auther by sizaif</p><p>2021-08-10  14:22:25</p></blockquote><p>[TOC]</p><h2 id="OpenCV">OpenCV</h2><div class="story post-story"><p>首先安装OpenCV的依赖文件，在终端运行下面命令：</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> build-essential<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> cmake <span class="token function">git</span> libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-dev python-numpy libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev libjasper-dev libdc1394-22-dev<span class="token comment">#  if errorE: unable to locate libjasper-dev</span><span class="token function">sudo</span> add-apt-repository <span class="token string">"deb http://security.ubuntu.com/ubuntu xenial-security main"</span><span class="token comment"># or vim sources.list  add  "deb http://security.ubuntu.com/ubuntu xenial-security main" and update </span><span class="token function">vim</span> /etc/apt/sources.list<span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libjasper1 libjasper-dev</code></pre>              </div>            </details><p><strong>Install compiler and build tools</strong></p><ul><li><p>To compile OpenCV you will need a C++ compiler. Usually it is G++/GCC or Clang/LLVM:</p><ul><li><p>Install GCC…</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y g++</code></pre></li><li><p>… or Clang:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y clang</code></pre></li></ul></li><li><p>OpenCV uses CMake build configuration tool:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y cmake</code></pre></li><li><p>CMake can generate scripts for different build systems, e.g. make,ninja:</p><ul><li><p>Install Make…</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y <span class="token function">make</span></code></pre></li><li><p>… or Ninja:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y ninja-build</code></pre></li></ul></li><li><p>Install tool for getting and unpacking sources:</p><ul><li><p>wget and unzip …</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y <span class="token function">wget</span> <span class="token function">unzip</span></code></pre></li><li><p>… or git :</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> -y <span class="token function">git</span></code></pre></li></ul></li></ul><p><strong>Download sources</strong></p><p>There are two methods of getting OpenCV sources:</p><ul><li><p>Download snapshot of repository using web browser or any download tool (~80-90Mb) and unpack it…</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -O opencv.zip https://github.com/opencv/opencv/archive/master.zipunzip opencv.zipmv opencv-master opencv</code></pre></li><li><p>… or clone repository to local machine using git to get full change history (&gt;470Mb):</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/opencv/opencv.gitgit -C opencv checkout master</code></pre></li></ul><blockquote><p>Note</p><p>Snapshots of other branches, releases or commits can be found on the <a href="https://github.com/opencv/opencv">GitHub</a> and the <a href="https://opencv.org/releases.html">official download page</a>.</p></blockquote><p><strong>Configure and build</strong></p><ul><li><p>Create build directory:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> -p build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> build</code></pre></li><li><p>Configure - generate build scripts for the preferred build system:</p><ul><li><p>For make…</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#自定义路径安装OpenCV 到 /usr/local/opencv 中cmake  -D CMAKE_INSTALL_PREFIX=/usr/local/opencv ../opencv </span></code></pre></li><li><p>… or for ninja :</p><pre class="language-bash" data-language="bash"><code class="language-bash">cmake -GNinja <span class="token punctuation">..</span>/opencv</code></pre></li></ul></li><li><p>Build - run actual compilation process:</p><ul><li><p>Using make …</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> -j4</code></pre></li><li><p>… or ninja :</p><pre class="language-bash" data-language="bash"><code class="language-bash">ninja</code></pre></li></ul></li></ul><blockquote><p>Note</p><p><em>Configure</em> process can download some files from the internet to satisfy library dependencies, connection failures can cause some of modules or functionalities to be turned off or behave differently. Refer to the <a href="https://docs.opencv.org/master/d0/d3d/tutorial_general_install.html">OpenCV installation overview</a> and <a href="https://docs.opencv.org/master/db/d05/tutorial_config_reference.html">OpenCV configuration options reference</a> tutorials for details and full configuration options reference.</p><p>If you experience problems with the build process, try to clean or recreate the build directory. Changes in the configuration like disabling a dependency, modifying build scripts or switching sources to another branch are not handled very well and can result in broken workspace.</p><p><em>Make</em> can run multiple compilation processes in parallel, <code>-j&lt;NUM&gt;</code> option means “run <NUM> jobs simultaneously”. <em>Ninja</em> will automatically detect number of available processor cores and does not need <code>-j</code> option.</p></blockquote><p><strong>Check build results</strong></p><p>After successful build you will find libraries in the <code>build/lib</code> directory and executables (test, samples, apps) in the <code>build/bin</code> directory:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> binls lib</code></pre><p>CMake package files will be located in the build root:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ls</span> OpenCVConfig*.cmakels OpenCVModules.cmake</code></pre><p><strong>Install</strong></p><blockquote><p>Warning</p><p>The installation process only copies files to predefined locations and does minor patching. Installing using this method does not integrate opencv into the system package registry and thus, for example, opencv can not be uninstalled automatically. We do not recommend system-wide installation to regular users due to possible conflicts with system packages.</p></blockquote><p>By default OpenCV will be installed to the <code>/usr/local</code> directory, all files will be copied to following locations:</p><ul><li><code>/usr/local/bin</code> - executable files</li><li><code>/usr/local/lib</code> - libraries (.so)</li><li><code>/usr/local/cmake/opencv4</code> - cmake package</li><li><code>/usr/local/include/opencv4</code> - headers</li><li><code>/usr/local/share/opencv4</code> - other files (e.g. trained cascades in XML format)</li></ul><p>Since <code>/usr/local</code> is owned by the root user, the installation should be performed with elevated privileges (<code>sudo</code>):</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><p>or</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ninja <span class="token function">install</span></code></pre><p>Installation root directory can be changed with <code>CMAKE_INSTALL_PREFIX</code> configuration parameter, e.g. <code>-DCMAKE_INSTALL_PREFIX=$HOME/.local</code> to install to current user’s local directory. Installation layout can be changed with <code>OPENCV_*_INSTALL_PATH</code> parameters. See <a href="https://docs.opencv.org/master/db/d05/tutorial_config_reference.html">OpenCV configuration options reference</a> for details.</p><hr><p>Generated on Tue Apr 20 2021 02:31:39 for OpenCV by  <a href="http://www.doxygen.org/index.html"> <img src="https://docs.opencv.org/master/doxygen.png" class="lazyload" data-srcset="https://docs.opencv.org/master/doxygen.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="doxygen"> </a>1.8.13</p></div><h2 id="Tensorflow">Tensorflow</h2><div class="story post-story"><h3 id="bazel">bazel</h3><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Bazel needs a C++ compiler and unzip / zip in order to work:</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> g++ <span class="token function">unzip</span> <span class="token function">zip</span><span class="token comment"># Run the installer</span><span class="token function">chmod</span> +x bazel-<span class="token operator">&lt;</span>version<span class="token operator">></span>-installer-linux-x86_64.sh./bazel-<span class="token operator">&lt;</span>version<span class="token operator">></span>-installer-linux-x86_64.sh --user<span class="token comment"># Set up your environment</span><span class="token function">vim</span> ~/.bashrc<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$PATH</span>:<span class="token environment constant">$HOME</span>/bin"</span><span class="token builtin class-name">source</span> ~/.bashrc</code></pre>              </div>            </details></div><h2 id="tensorflow-v2-4-0">tensorflow-v2.4.0</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装以下构建工具以配置开发环境。</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python3-dev python3-pippip <span class="token function">install</span> numpy<span class="token comment"># 安装 Bazel</span><span class="token function">git</span> clone https://github.com/tensorflow/tensorflow.git<span class="token builtin class-name">cd</span> tensorflow<span class="token function">git</span> checkout branch_name  <span class="token comment"># r2.2, r2.3, etc.</span>./configure<span class="token comment"># CUDA GPU</span>bazel build --config<span class="token operator">=</span>opt --config<span class="token operator">=</span>cuda //tensorflow:libtensorflow_cc.so<span class="token comment"># CPU</span>bazel build --config<span class="token operator">=</span>opt //tensorflow:libtensorflow_cc.so<span class="token comment"># 编译完成后,  将头文件 ( bazel-bin/tensorflow 和 下 **.so  复制到 /usr/local/include/tf/tensorflow 和 /usr/local/lib</span><span class="token function">mkdir</span> /usr/local/include/tf<span class="token function">cp</span> -r bazel-bin/tensorflow/* /usr/local/include/tf/tensorflow/<span class="token function">sudo</span> <span class="token function">cp</span> -r bazel-bin/tensorflow/*.so /usr/local/lib/</code></pre>              </div>            </details><h3 id="测试">测试</h3><p>CMakeLists.txt</p><details green><summary> CMakeLists.txt </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">cmake_minimum_required<span class="token punctuation">(</span>VERSION <span class="token number">2.8</span><span class="token punctuation">)</span><span class="token comment"># project Name &amp; Version</span>project<span class="token punctuation">(</span>STOtest<span class="token punctuation">)</span><span class="token comment"># find_package</span>find_package<span class="token punctuation">(</span>OpenCV REQUIRED<span class="token punctuation">)</span><span class="token comment"># set location </span><span class="token comment"># Openblas</span>set<span class="token punctuation">(</span>OpenBlas_DIR /usr/local/OpenBlas<span class="token punctuation">)</span><span class="token comment"># eigen</span>set<span class="token punctuation">(</span>Eigen_DIR /usr/local/include/eigen3<span class="token punctuation">)</span><span class="token comment"># tensorflow</span>set<span class="token punctuation">(</span>Tensorflow_INCLUDES            /usr/local/include/tf/            /usr/local/include/tf/tensorflow/            /usr/local/include/tf/tensorflow/third-party<span class="token punctuation">)</span>set<span class="token punctuation">(</span>Tensorflow_LIBS/usr/local/lib/libtensorflow_cc.so/usr/local/lib/libtensorflow_framework.so<span class="token punctuation">)</span><span class="token comment"># protobuf</span>set<span class="token punctuation">(</span>Protobuf_INCLUDES /usr/local/include/google<span class="token punctuation">)</span>set<span class="token punctuation">(</span>Protobuf_LIBS /usr/local/bin/protoc<span class="token punctuation">)</span>message<span class="token punctuation">(</span>STATUS: <span class="token string">"OpenBlas_DIR= <span class="token variable">$&#123;OpenBlas_DIR&#125;</span>"</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>STATUS <span class="token string">"OpenCV library status:"</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>STATUS <span class="token string">"    config=: <span class="token variable">$&#123;OpenCV_DIR&#125;</span>"</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>STATUS <span class="token string">"    version=: <span class="token variable">$&#123;OpenCV_VERSION&#125;</span>"</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>STATUS <span class="token string">"    libraries=: <span class="token variable">$&#123;OpenCV_LIBS&#125;</span>"</span><span class="token punctuation">)</span>message<span class="token punctuation">(</span>STATUS <span class="token string">"    include path=: <span class="token variable">$&#123;OpenCV_INCLUDE_DIRS&#125;</span>"</span><span class="token punctuation">)</span><span class="token comment"># include </span>include_directories<span class="token punctuation">(</span>    <span class="token variable">$&#123;Tensorflow_INCLUDES&#125;</span>    <span class="token variable">$&#123;Eigen_DIR&#125;</span>    <span class="token variable">$&#123;OpenBlas_DIR&#125;</span>    <span class="token variable">$&#123;Protobuf_INCLUDES&#125;</span><span class="token punctuation">)</span><span class="token comment"># src cpp</span>aux_source_directory<span class="token punctuation">(</span>./src DIR_SRCS<span class="token punctuation">)</span>add_executable<span class="token punctuation">(</span> main <span class="token builtin class-name">.</span><span class="token variable">$&#123;DIR_SRCS&#125;</span><span class="token punctuation">)</span><span class="token comment"># target</span>target_link_libraries<span class="token punctuation">(</span>main PRIVATE <span class="token variable">$&#123;OpenCV_LIBS&#125;</span> <span class="token variable">$&#123;Tensorflow_LIBS&#125;</span> <span class="token variable">$&#123;Protobuf_LIBS&#125;</span><span class="token punctuation">)</span></code></pre>              </div>            </details><details green><summary> code </summary>              <div class='content'>              <pre class="language-c++" data-language="c++"><code class="language-c++">&#x2F;&#x2F;#include &quot;opencv2&#x2F;highgui.hpp&quot;&#x2F;&#x2F;#include &quot;opencv2&#x2F;imgproc.hpp&quot;#include &lt;tensorflow&#x2F;core&#x2F;platform&#x2F;env.h&gt;#include &lt;tensorflow&#x2F;core&#x2F;public&#x2F;session.h&gt;#include &lt;iostream&gt;&#x2F;&#x2F;susing namespace cv;using namespace std;using namespace tensorflow;int main( )&#123;    cout &lt;&lt; &quot;hello tensorflow&quot; &lt;&lt;endl;       Session* session;    Status status &#x3D; NewSession(SessionOptions(), &amp;session);    if (!status.ok()) &#123;        cout &lt;&lt; status.ToString() &lt;&lt; endl;        cout &lt;&lt;&quot;Session not ok&quot; &lt;&lt; endl;        return 1;    &#125;    cout &lt;&lt; &quot;Session successfully created.&quot;&lt;&lt;endl;    return 0;&#125;</code></pre>              </div>            </details></div><h2 id="Protobuf">Protobuf</h2><div class="story post-story"><p>1）上Github下载protocbuf源码包</p><pre class="language-bash" data-language="bash"><code class="language-bash">https://github.com/protocolbuffers/protobuf/releases/tag/vX.X.X</code></pre><p>2）安装依赖包</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> autoconf automake libtool <span class="token function">curl</span> <span class="token function">make</span> g++ <span class="token function">unzip</span></code></pre><p>3）进入源码目录，执行./autogen.sh生成configure文件</p><p>4）依次执行</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"> ./configure <span class="token function">make</span> <span class="token function">make</span> check <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token function">sudo</span> ldconfig <span class="token comment"># refresh shared library cache.</span>  <span class="token comment"># 验证版本</span>siz@ubuntu:~$ protoc --versionlibprotoc <span class="token number">3.9</span>.2siz@ubuntu:~$ <span class="token function">whereis</span> protocprotoc: /usr/local/bin/protoc</code></pre>              </div>            </details></div><h2 id="Eigen3">Eigen3</h2><div class="story post-story"><h3 id="简单命令安装">简单命令安装</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libeigen3-dev</code></pre><h3 id="源码编译安装">源码编译安装</h3><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">http://eigen.tuxfamily.org/index.php?title<span class="token operator">=</span>Main_Page<span class="token function">git</span> clone https://gitlab.com/libeigen/eigen.git<span class="token function">mkdir</span> build<span class="token builtin class-name">cd</span> buildcmake <span class="token punctuation">..</span><span class="token function">sudo</span> <span class="token function">make</span> instal<span class="token comment"># 安装成功后,头文件路径在 /usr/local/include/eigen3/</span><span class="token comment"># CMakeLists.txt  中添加 eigen3 头文件</span>include_directories<span class="token punctuation">(</span> <span class="token string">"/usr/include/eigen3"</span> <span class="token punctuation">)</span></code></pre>              </div>            </details></div><h2 id="OpenBlas">OpenBlas</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/xianyi/OpenBLAS.git<span class="token builtin class-name">cd</span> OpenBLAS<span class="token function">make</span><span class="token function">make</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/Openblas <span class="token function">install</span></code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 机器学习 </category>
          
          <category> 机器学习 </category>
          
          <category> OpenCV </category>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenCV </tag>
            
            <tag> 机器学习 </tag>
            
            <tag> Tensorflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GnuTLS 使用手册</title>
      <link href="/posts/89554caf/"/>
      <url>/posts/89554caf/</url>
      
        <content type="html"><![CDATA[<h1>GnuTLS 使用手册</h1><blockquote><p>😄  @by sizaif</p><p>📆  2021-05-17  16:23:57</p></blockquote><p>[TOC]</p><h1>命令行解析</h1><h2 id="gnutls-serv">gnutls-serv</h2><div class="story post-story"><p><a href="https://gnutls.org/manual/html_node/gnutls_002dserv-Invocation.html">https://gnutls.org/manual/html_node/gnutls_002dserv-Invocation.html</a></p><details green><summary> GnuTLS server </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">gnutls-serv - GnuTLS serverUsage:  gnutls-serv <span class="token punctuation">[</span> -<span class="token operator">&lt;</span>flag<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>val<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">|</span> --<span class="token operator">&lt;</span>name<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token operator">=</span><span class="token operator">|</span> <span class="token punctuation">&#125;</span><span class="token operator">&lt;</span>val<span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">..</span>.   -d, --debug<span class="token operator">=</span>num            Enable debugging                                - it must be <span class="token keyword">in</span> the range:                                  <span class="token number">0</span> to <span class="token number">9999</span>       --sni-hostname<span class="token operator">=</span>str     Server<span class="token string">'s hostname for server name extension       --sni-hostname-fatal   Send fatal alert on sni-hostname mismatch       --alpn=str             Specify ALPN protocol to be enabled by the server                                - may appear multiple times       --alpn-fatal           Send fatal alert on non-matching ALPN name       --noticket             Don'</span>t accept session tickets       --earlydata            Accept early data       --maxearlydata<span class="token operator">=</span>num     The maximum early data size to accept                                - it must be <span class="token keyword">in</span> the range:                                  greater than or equal to <span class="token number">1</span>       --nocookie             Don<span class="token string">'t require cookie on DTLS sessions   -g, --generate             Generate Diffie-Hellman parameters   -q, --quiet                Suppress some messages       --nodb                 Do not use a resumption database       --http                 Act as an HTTP server       --echo                 Act as an Echo server       --crlf                 Do not replace CRLF by LF in Echo server mode   -u, --udp                  Use DTLS (datagram TLS) over UDP       --mtu=num              Set MTU for datagram TLS                                - it must be in the range:                                  0 to 17000       --srtp-profiles=str    Offer SRTP profiles   -a, --disable-client-cert  Do not request a client certificate                                - prohibits the option '</span>require-client-cert<span class="token string">'   -r, --require-client-cert  Require a client certificate       --verify-client-cert   If a client certificate is sent then verify it.   -b, --heartbeat            Activate heartbeat support       --x509fmtder           Use DER format for certificates to read from       --priority=str         Priorities string       --dhparams=file        DH params file to use                                - file must pre-exist       --x509cafile=str       Certificate file or PKCS #11 URL to use       --x509crlfile=file     CRL file to use                                - file must pre-exist       --x509keyfile=str      X.509 key file or PKCS #11 URL to use                                - may appear multiple times       --x509certfile=str     X.509 Certificate file or PKCS #11 URL to use                                - may appear multiple times       --rawpkkeyfile=str     Private key file (PKCS #8 or PKCS #12) or PKCS #11 URL to use                                - may appear multiple times       --rawpkfile=str        Raw public-key file to use                                - requires the option '</span>rawpkkeyfile'                                - may appear multiple <span class="token builtin class-name">times</span>       --srppasswd<span class="token operator">=</span>file       SRP password <span class="token function">file</span> to use                                - <span class="token function">file</span> must pre-exist       --srppasswdconf<span class="token operator">=</span>file   SRP password configuration <span class="token function">file</span> to use                                - <span class="token function">file</span> must pre-exist       --pskpasswd<span class="token operator">=</span>file       PSK password <span class="token function">file</span> to use                                - <span class="token function">file</span> must pre-exist       --pskhint<span class="token operator">=</span>str          PSK identity hint to use       --ocsp-response<span class="token operator">=</span>str    The OCSP response to send to client                                - may appear multiple <span class="token builtin class-name">times</span>       --ignore-ocsp-response-errors  Ignore any errors when setting the OCSP response   -p, --port<span class="token operator">=</span>num             The port to connect to   -l, --list                 Print a list of the supported algorithms and modes       --provider<span class="token operator">=</span>file        Specify the PKCS <span class="token comment">#11 provider library</span>                                - <span class="token function">file</span> must pre-exist       --keymatexport<span class="token operator">=</span>str     Label used <span class="token keyword">for</span> exporting keying material       --keymatexportsize<span class="token operator">=</span>num Size of the exported keying material       --recordsize<span class="token operator">=</span>num       The maximum record size to advertise                                - it must be <span class="token keyword">in</span> the range:                                  <span class="token number">0</span> to <span class="token number">16384</span>       --httpdata<span class="token operator">=</span>file        The data used as HTTP response                                - <span class="token function">file</span> must pre-exist   -v, --version<span class="token punctuation">[</span><span class="token operator">=</span>arg<span class="token punctuation">]</span>        output version information and <span class="token builtin class-name">exit</span>   -h, --help                 display extended usage information and <span class="token builtin class-name">exit</span>   -<span class="token operator">!</span>, --more-help            extended usage information passed thru pagerOptions are specified by doubled hyphens and their name or by a singlehyphen and the flag character.Server program that listens to incoming TLS connections.</code></pre>              </div>            </details></div><h2 id="使用">使用</h2><div class="story post-story"><h3 id="服务端">服务端</h3><p>Note that the server listens to port <code>5556</code> by default.</p><p>例子</p><pre class="language-bash" data-language="bash"><code class="language-bash">gnutls-serv --http --x509keyfile experiments/keystore/rsa2048_key.pem --x509certfile experiments/keystore/rsa2048_cert.pem --x509cafile experiments/keystore/rsa2048_cert.pem --pskpasswd experiments/keystore/keys.psk --priority NORMAL:+PSK:+SRP --mtu <span class="token number">1500</span> -p <span class="token number">30002</span>"</code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 笔记 </category>
          
          <category> SSL </category>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
            <tag> 笔记 </tag>
            
            <tag> GnuTLS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fuckopenssl 1.0.1l</title>
      <link href="/posts/2dc41376/"/>
      <url>/posts/2dc41376/</url>
      
        <content type="html"><![CDATA[<h1>fuckopenssl 1.0.1l</h1><p>[TOC]</p><blockquote><p>2021-08-10  14:19:38</p><p>@Auther by : sizaif</p></blockquote><h2 id="安装-openssl-1-0-1l">安装 openssl 1.0.1l</h2><div class="story post-story"><p>不整幺蛾子, 就默认安装位置</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://www.openssl.org/source/openssl-1.0.1l.tar.gz<span class="token function">tar</span> xzf openssl-1.0.1l.tar.gz<span class="token builtin class-name">cd</span> openssl-1.0.1l./config enable-ssl2 enable-weak-ciphers<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span class="token comment"># 默认安装位置在 /usr/local/ssl</span></code></pre>              </div>            </details><p><strong>更改版本信息</strong></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将旧版本的openssl进行备份</span><span class="token comment"># 如果已经是root 了 就不用sudo </span><span class="token function">sudo</span> <span class="token function">mv</span> /usr/bin/openssl /usr/bin/openssl.old    <span class="token comment"># 将新版本的openssl进行软链接</span><span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/local/ssl/bin/openssl /usr/bin/openssl    <span class="token comment">#进入etc目录</span><span class="token builtin class-name">cd</span> /etc/   <span class="token comment">#下一步一定要切换到root用户</span><span class="token comment"># 如果已经是root 用户, 直接执行  echo "/usr/local/lib" >> ld.so.conf  </span><span class="token function">su</span>     <span class="token comment">#将openssl的安装路径加入配置中</span><span class="token builtin class-name">echo</span> <span class="token string">"/usr/local/lib"</span> <span class="token operator">>></span> ld.so.conf    <span class="token comment"># 重新加载配置</span>ldconfig  </code></pre>              </div>            </details><p><strong>结果如图:</strong></p><details blue><summary> 图片 </summary>              <div class='content'>              <p><img src="https://gitee.com/sizaif/images/raw/master/img/20210503165412.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210503165412.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210503165410860"></p>              </div>            </details><p><strong>编译drown</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/Tim---/drown<span class="token assign-left variable">SSL_PREFIX</span><span class="token operator">=</span>/usr/local/ssl <span class="token function">make</span></code></pre><p><strong>结果如图:</strong></p><details blue><summary> 图片 </summary>              <div class='content'>              <p><img src="https://gitee.com/sizaif/images/raw/master/img/20210503165352.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210503165352.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210503165350673"></p>              </div>            </details><pre class="language-bash" data-language="bash"><code class="language-bash">./decrypt host:port certfile c<span class="token comment"># ./decrypt 127.0.0.1:7899 certfile c</span><span class="token comment"># </span></code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210503170500.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210503170500.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210503170459400"></p></div><h2 id="Passive-attack">Passive attack</h2><div class="story post-story"><details green><summary> Passive attack </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 因为已经将 openssl1.0.1l 配置到系统环境, 所以可以直接使用openssl 命令</span><span class="token comment">#</span>openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days <span class="token comment"># 结果如下:</span><span class="token comment">#########################################################################################</span>root@iZj6cg4e6vhdv5s3hpkoffZ:~/supengfei/drown/fuck<span class="token comment"># openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 123</span>Generating a <span class="token number">2048</span> bit RSA private key<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++<span class="token punctuation">..</span><span class="token punctuation">..</span>+++writing new private key to <span class="token string">'key.pem'</span>Enter PEM pass phrase:<span class="token comment"># 这里输入的是fuckopenssl</span>Verifying - Enter PEM pass phrase:-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter <span class="token string">'.'</span>, the field will be left blank.-----Country Name <span class="token punctuation">(</span><span class="token number">2</span> letter code<span class="token punctuation">)</span> <span class="token punctuation">[</span>AU<span class="token punctuation">]</span>:zhState or Province Name <span class="token punctuation">(</span>full name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Some-State<span class="token punctuation">]</span>:beijingLocality Name <span class="token punctuation">(</span>eg, city<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:beijingOrganization Name <span class="token punctuation">(</span>eg, company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Internet Widgits Pty Ltd<span class="token punctuation">]</span>:IBMOrganizational Unit Name <span class="token punctuation">(</span>eg, section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:123Common Name <span class="token punctuation">(</span>e.g. server FQDN or YOUR name<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:rootEmail Address <span class="token punctuation">[</span><span class="token punctuation">]</span>:123456@123.com<span class="token comment">#########################################################################################</span>openssl s_server -cert cert.pem -key key.pem -accept <span class="token number">4433</span> -www<span class="token comment">#</span><span class="token comment">#########################################################################################</span>root@iZj6cg4e6vhdv5s3hpkoffZ:~/supengfei/drown/fuck<span class="token comment"># openssl s_server -cert cert.pem -key key.pem -accept 4433 -www</span>Enter pass phrase <span class="token keyword">for</span> key.pem:<span class="token comment"># 这里输入的是上面的fuckopenssl</span>Using default temp DH parametersUsing default temp ECDH parametersACCEPT<span class="token comment">#########################################################################################</span><span class="token comment"># 打开新窗口</span><span class="token comment"># 安装 tshark</span><span class="token function">apt-get</span> <span class="token function">install</span> tshark<span class="token comment"># </span>tshark -i lo -w handshakes.cap tcp port <span class="token number">4433</span></code></pre>              </div>            </details><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210503172019.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210503172019.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210503172017959"></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 打开新窗口</span><span class="token comment"># openssl 已经配置到系统环境, 所以直接使用openssl 命令</span><span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1000</span><span class="token variable">)</span></span> <span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token punctuation">(</span>echo <span class="token string">'GET / HTTP/1.1\r\n'</span><span class="token punctuation">;</span> <span class="token function">sleep</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token operator">|</span> openssl s_client -connect <span class="token number">127.0</span>.0.1:4433 -cipher kRSA<span class="token punctuation">;</span> <span class="token keyword">done</span><span class="token comment"># 展示</span><span class="token comment">#########################################################################################</span>New, TLSv1/SSLv3, Cipher is AES256-GCM-SHA384SSL-Session:    Protocol  <span class="token builtin class-name">:</span> TLSv1.2    Cipher    <span class="token builtin class-name">:</span> AES256-GCM-SHA384    Session-ID: 49EB9A81AD65AE80476F9F72CF4472D17CFB4E33539DAAE5734B5BD2EFD878F3    Session-ID-ctx: 01000000    Master-Key: CCCF32EBBEC91A411D63589FBFAD0B2CE8290797D2749BAF3FFD5C05A4CAB79CFE2E0DAC2939155721DF65218B9757EE    Key-Arg   <span class="token builtin class-name">:</span> None    PSK identity: None    PSK identity hint: None    SRP username: None    Start Time: <span class="token number">1620033794</span>    Timeout   <span class="token builtin class-name">:</span> <span class="token number">300</span> <span class="token punctuation">(</span>sec<span class="token punctuation">)</span>    Verify <span class="token builtin class-name">return</span> code: <span class="token number">0</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span>--- <span class="token number">128</span> items <span class="token keyword">in</span> the session cache   <span class="token number">0</span> client connects <span class="token punctuation">(</span>SSL_connect<span class="token punctuation">(</span><span class="token punctuation">))</span>   <span class="token number">0</span> client renegotiates <span class="token punctuation">(</span>SSL_connect<span class="token punctuation">(</span><span class="token punctuation">))</span>   <span class="token number">0</span> client connects that finished<span class="token number">1000</span> server accepts <span class="token punctuation">(</span>SSL_accept<span class="token punctuation">(</span><span class="token punctuation">))</span>   <span class="token number">0</span> server renegotiates <span class="token punctuation">(</span>SSL_accept<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token number">1000</span> server accepts that finished   <span class="token number">0</span> session cache hits   <span class="token number">0</span> session cache misses   <span class="token number">0</span> session cache timeouts   <span class="token number">0</span> callback cache hits <span class="token number">872</span> cache full overflows <span class="token punctuation">(</span><span class="token number">128</span> allowed<span class="token punctuation">)</span>---no client certificate available<span class="token operator">&lt;</span>/BODY<span class="token operator">></span><span class="token operator">&lt;</span>/HTML<span class="token operator">></span>read:errno<span class="token operator">=</span><span class="token number">0</span><span class="token comment">#########################################################################################</span><span class="token comment"># get the encrypted pre-master secrets for each session with</span>tshark -r handshakes.cap -d tcp.port<span class="token operator">==</span><span class="token number">4433</span>,ssl -T fields -e ssl.handshake.epms -Y ssl.handshake.epms <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token builtin class-name">:</span></code></pre>              </div>            </details><p><strong>结果如下:</strong></p><details blue><summary> 图片 </summary>              <div class='content'>              <p><img src="https://gitee.com/sizaif/images/raw/master/img/20210503172529.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210503172529.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210503172527677"></p>              </div>            </details><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># To decrypt these handshakes, we need an OpenSSL server accepting SSLv2 connections :</span>openssl s_server -cert cert.pem -key key.pem -accept <span class="token number">4434</span> -www -ssl2<span class="token comment">#########################################################################################</span>root@iZj6cg4e6vhdv5s3hpkoffZ:~/supengfei/drown/fuck<span class="token comment"># openssl s_server -cert cert.pem -key key.pem -accept 4434 -www -ssl2</span>Enter pass phrase <span class="token keyword">for</span> key.pem:<span class="token comment"># 这里输入的是 上面的pem: fuckfuckfuck</span>Using default temp DH parametersUsing default temp ECDH parametersACCEPT<span class="token comment">#########################################################################################</span><span class="token comment"># We can now decrypt the encrypted pre-master secret</span><span class="token comment">#在drown/fuck/目录下执行</span><span class="token comment">#########################################################################################</span><span class="token comment"># root@iZj6cg4e6vhdv5s3hpkoffZ:~# ll supengfei/drown/fuck/</span><span class="token comment"># total 8024</span><span class="token comment"># drwxr-xr-x 2 root root    4096 May  3 17:33 ./</span><span class="token comment"># drwxr-xr-x 4 root root    4096 May  3 17:28 ../</span><span class="token comment"># -rw-r--r-- 1 root root    1375 May  3 17:14 cert.pem</span><span class="token comment"># -rw------- 1 root root 8196592 May  3 17:23 handshakes.cap</span><span class="token comment"># -rw-r--r-- 1 root root    1834 May  3 17:14 key.pem</span><span class="token comment"># -rw-r--r-- 1 root root       0 May  3 17:33 pms.tx</span><span class="token comment"># -rw-r--r-- 1 root root       0 May  3 17:28 pms.txt</span><span class="token comment"># root@iZj6cg4e6vhdv5s3hpkoffZ:~# </span><span class="token comment">#########################################################################################</span><span class="token comment">#这个位置是cert.perm handshakes.cap 的位置</span><span class="token comment"># ../decrypt 是drown目录下编译后会生成一个decrypt可执行文件位置</span>tshark -r handshakes.cap -d tcp.port<span class="token operator">==</span><span class="token number">4433</span>,ssl -T fields -e ssl.handshake.epms -Y ssl.handshake.epms <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token builtin class-name">:</span> <span class="token operator">|</span> <span class="token punctuation">..</span>/decrypt localhost:4434 cert.pem <span class="token operator">></span> pms.txt</code></pre>              </div>            </details><p><strong>结果展示</strong></p><details blue><summary> 图片 </summary>              <div class='content'>              <p><img src="https://gitee.com/sizaif/images/raw/master/img/20210503181801.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210503181801.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210503181800121"></p>              </div>            </details><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">RSA 830cdf70dc488c8b 0303b45e46017e9dfefd22a26b7c64648fb2d00fcf8627cb0070132e370ab57a1b595e2544b1668caf3618942c2a0e34RSA a62c4d1a5c4322e2 0303e37a220b3300e6c0d139d55a1c44c2429f11b0613d746db390beb16ad8bb0203f7494d3e7385a294e4f8a18fa5aeRSA 7215d21d1c22dfb8 0303434023187d88c73a921af635d7861ed60d66ebc4053e487ea85ab6d6b76dd373844063e8da156505dc8466310395RSA 1976fb27fbccbd36 0303c9c320f9cc92567bc488c502ffacbbef28241348e30df4b2d55fdd7f8680fb201b5f75e02b9bd1db4e8e2c2fdf84RSA 3b56f9c80a754f77 0303e8abf59f4132b1634f2b4e04bf4362c7f6dae5077dc9b6bb0c48efe0c7be47a256267688c7e28e70a28c830e6af6RSA 1686f037050931a5 03036cb5a1851a174a9f43f97be770bd22411da688197bef08154d7f91f687dc6e0090d35ce147862e8bcc5c7218398cRSA 6ce5d3fd06970d25 0303e4da20c0d6dd5e03bf97d0ee4d802cab150810df524359ab990df0a01f2d51fe6c69ebfdae99ff1b1c9042367966RSA 0e447f6c36cadd1c 030313b76ce57518d001229385f6b3ca376821692f72401a32e8b2b9a1322f523b9dc3c4808e7975e6e96c3883c3b8c4RSA 830280803c06b66a 0303c80069cbb7517d723d8476ff22077e7b33b10c67872093bc7793e01a501d56c2ea2f9d16266b32bd933d8d957f2bRSA 4ee250f545d2f1ae 0303096a212344c48bfaa3153f1d1196c81beb918d61e9497033b9bd4fb118dc474187fb0965de2eff0448c072ee46e0RSA 7b5fddbfbc5e2586 0303c7714d54a817514c086f8d4004547fb6191cbc5cd36ec7816b4ab81295278b5ba13054014413cd3abf75faa05d60RSA 6053a37a45c64592 03035126dad66420ee530e50be0cfdb6aca5cb3e6897c3a2c1cb56c39704112efd36069e450814ccd70b629dc23e26b4RSA a04a28e475029688 03036657caed02639f6b450a0c7293f4abf3ad188652bd443f2d27e6ffe53f859d1d91441aa0fcc646648557ecb910f8RSA 1d37821396fecd87 030375a2214a9b475fe93ddd424a71536a0642a07d0d093abdcc84a0e1b89d3f052719e44d1816f2698d24b67ef7cc26RSA 62a5f513fc94585b 0303a873790bf018f5d6c4e1ac4d87487a34e58471762a2dffd6d92e122ec284b7dc2206569118e0a6ebfb4c2960457dRSA 8de0c774b04a20d2 0303e8748fbea20c72709a8dc436fc631521cbd068c6beddfacd4fb224ef03da92e76af9bbf3b740908efd699a797973RSA a7575ef2b95aeeeb 03033f49c4e3b9642fddcda12c05601d69113adf7bebc4c0cb963ff898373a50a0494564c97a9e0ac3e18e1f709b68a9</code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 笔记 </category>
          
          <category> SSL </category>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
            <tag> 笔记 </tag>
            
            <tag> OpenSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安装Openssl GNUTLS WolfSSL 手册</title>
      <link href="/posts/b924c044/"/>
      <url>/posts/b924c044/</url>
      
        <content type="html"><![CDATA[<h1>安装Openssl GNUTLS WolfSSL 手册</h1><blockquote><p>😄 @Auther sizaif</p><p>📆2021-05-18  09:19:35</p></blockquote><p>[TOC]</p><h2 id="OpenSSL">OpenSSL</h2><div class="story post-story"><p>项目地址:<a href="https://www.openssl.org/">https://www.openssl.org/</a></p><h3 id="安装依赖库">安装依赖库</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装ssl 依赖库</span><span class="token function">sudo</span> <span class="token function">apt</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libssl-dev <span class="token function">make</span></code></pre><h3 id="下载源码并进入文件">下载源码并进入文件</h3><p><a href="https://www.openssl.org/source/old/1.1.1/">https://www.openssl.org/source/old/1.1.1/</a></p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 下载OpenSSL对应版本源码</span>https://www.openssl.org/source/old/1.1.1/openssl-1.1.1j.tar.gz<span class="token comment"># 进入文件后</span><span class="token builtin class-name">cd</span> openssl-XXX/</code></pre><h3 id="编译安装">编译安装</h3><p>编译安装有两种方式,</p><p>一种是编译后,不进行安装,即不把编译后的文件安装到系统环境下, 输入<code>openssl version</code>版本不变</p><p>另一种是编译后进行安装,更换到系统环境下</p><p>第一种,仅编译, 使用时通过<code>/openssl-xxx/apps/openssl</code> 使用这个版本的openssl</p><p>这样的优势是,可以快速测试多个openssl的版本,而不用重复更新安装</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置环境 prefix 是安装目录，openssldir是配置文件目录</span><span class="token comment"># </span><span class="token comment">#  Configure --prefix=/YOUR PATH</span>./Configure <span class="token comment"># or </span>./config<span class="token comment"># ./config  --prefix=/YOUR PATH</span><span class="token comment"># 编译安装</span><span class="token comment">#因为这里我们不需要安装,只需要拿到编译的结果去运行</span><span class="token comment"># 所以 不需要make install</span><span class="token function">make</span></code></pre>              </div>            </details><p>第二种,编译安装, 使用时直接使用<code>openssl</code> 命令来使用新安装的版本</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编译 需要等好长时间, 不如趁这个功夫取喝个茶,上个洗手间</span><span class="token function">make</span><span class="token comment"># 编译完成后, 进行安装 , 等待时间也不短, 不如去刷个小视频</span><span class="token comment"># </span><span class="token function">make</span> <span class="token function">install</span><span class="token comment"># 将旧版本的openssl进行备份</span><span class="token function">sudo</span> <span class="token function">mv</span> /usr/bin/openssl /usr/bin/openssl.old    <span class="token comment"># 将新版本的openssl进行软链接</span><span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/local/bin/openssl /usr/bin/openssl    <span class="token comment">#进入etc目录</span><span class="token builtin class-name">cd</span> /etc/   <span class="token comment">#下一步一定要切换到root用户</span><span class="token function">su</span>     <span class="token comment">#将openssl的安装路径加入配置中</span><span class="token builtin class-name">echo</span> <span class="token string">"/usr/local/lib"</span> <span class="token operator">>></span> ld.so.conf    <span class="token comment"># 重新加载配置</span>ldconfig  <span class="token comment"># 测试 版本 得到如下结果</span>openssl version<span class="token operator">></span>OpenSSL <span class="token number">1.1</span>.1b  <span class="token number">26</span> Feb <span class="token number">2019</span><span class="token comment"># 测试</span>ll /usr/local/include/ll /usr/local/lib/<span class="token comment"># 如下结果</span><span class="token comment">#如果需要更换版本的话,修改软链接的名称即可，参照：</span><span class="token comment">#将旧版本进行备份</span><span class="token function">sudo</span> <span class="token function">mv</span> /usr/include/openssl /usr/include/openssl.old    <span class="token comment">#将新版本进行软链接</span><span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/local/include/openssl /usr/include/openssl   </code></pre>              </div>            </details></div><h2 id="GnuTLS">GnuTLS</h2><div class="story post-story"><p>项目地址: <a href="https://www.gnutls.org/index.html">https://www.gnutls.org/index.html</a></p><h3 id="安装依赖库-2">安装依赖库</h3><p>编译需要 <a href="https://www.lysator.liu.se/~nisse/nettle/">libnettle</a> 和<a href="https://gmplib.org/">gmplib</a></p><p>Debian/Ubuntu:</p><details green><summary> Debian/Ubuntu </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> -y dash git-core autoconf libtool gettext autopoint<span class="token function">apt-get</span> <span class="token function">install</span> -y automake autogen nettle-dev libp11-kit-dev libtspi-dev libunistring-dev<span class="token function">apt-get</span> <span class="token function">install</span> -y guile-2.0-dev libtasn1-6-dev libidn2-0-dev <span class="token function">gawk</span> gperf<span class="token function">apt-get</span> <span class="token function">install</span> -y libunbound-dev dns-root-data bison help2man gtk-doc-tools<span class="token function">apt-get</span> <span class="token function">install</span> -y texinfo texlive texlive-generic-recommended texlive-extra-utils<span class="token function">apt-get</span> <span class="token function">install</span> pkg-config</code></pre>              </div>            </details><h3 id="编译安装-2">编译安装</h3><p>解释如下</p><blockquote><p>The GnuTLS Guile bindings are available for the Guile 3.0 and 2.2 series, as well as the legacy 2.0 and even 1.8 series.</p><p>By default they are installed under the GnuTLS installation directory, typically /usr/local/share/guile/site/). Normally Guile will not find the module there without help. You may experience something like this:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span>$ guile<span class="token operator">></span>…<span class="token operator">></span>scheme@<span class="token punctuation">(</span>guile-user<span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">(</span>use-modules <span class="token punctuation">(</span>gnutls<span class="token punctuation">))</span><span class="token operator">></span>ERROR: no code <span class="token keyword">for</span> module <span class="token punctuation">(</span>gnutls<span class="token punctuation">)</span></code></pre><p>There are two ways to solve this. The first is to make sure that when building GnuTLS, the Guile bindings will be installed in the same place where Guile looks. You may do this by using the <code>--with-guile-site-dir</code> parameter as follows:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span>$ ./configure --with-guile-site-dir<span class="token operator">=</span>no</code></pre></blockquote><p>命令如下</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># --with-guile-site-dir=no  构建GnuTLS时，Guile绑定将安装在与Guile相同的位置, 解释如上</span><span class="token comment"># 因为只需要测试GnuTls 所以使用如下的命令</span><span class="token comment"># 视实际情况决定</span>./configure --with-guile-site-dir<span class="token operator">=</span>no --with-included-libtasn1 --with-included-unistring --without-p11-kit --disable-guile --disable-doc</code></pre><p><strong>./configure结果</strong></p><details green><summary> ./configure结果 </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">configure: summary of build options:  version:              <span class="token number">3.6</span>.7 shared <span class="token number">53</span>:2:23  Host/Target system:   x86_64-pc-linux-gnu  Build system:         x86_64-pc-linux-gnu  Install prefix:       /usr/local  Compiler:             gcc  Valgrind:             no  CFlags:               -g -O2  Library types:        <span class="token assign-left variable">Shared</span><span class="token operator">=</span>yes, <span class="token assign-left variable">Static</span><span class="token operator">=</span>no  Local libopts:        <span class="token function">yes</span>  Local libtasn1:       <span class="token function">yes</span>  Local unistring:      <span class="token function">yes</span>  Use nettle-mini:      no  Documentation:        no <span class="token punctuation">(</span>manpages: no<span class="token punctuation">)</span>configure: External hardware support:  /dev/crypto:          no  Hardware accel:       x86-64  Padlock accel:        <span class="token function">yes</span>  Random gen. variant:  getrandom  PKCS<span class="token comment">#11 support:      no</span>  TPM support:          noconfigure: Optional features:<span class="token punctuation">(</span>note that included applications might not compile properly<span class="token keyword">if</span> features are disabled<span class="token punctuation">)</span>  SSL3.0 support:       no  SSL2.0 client hello:  <span class="token function">yes</span>  Allow SHA1 sign:      no  DTLS-SRTP support:    <span class="token function">yes</span>  ALPN support:         <span class="token function">yes</span>  OCSP support:         <span class="token function">yes</span>  SRP support:          <span class="token function">yes</span>  PSK support:          <span class="token function">yes</span>  DHE support:          <span class="token function">yes</span>  ECDHE support:        <span class="token function">yes</span>  GOST support:         <span class="token function">yes</span>  Anon auth support:    <span class="token function">yes</span>  Heartbeat support:    <span class="token function">yes</span>  IDNA support:         no  Non-SuiteB curves:    no  FIPS140 mode:         noconfigure: Optional libraries:  Guile wrappers:       no  C++ library:          <span class="token function">yes</span>  DANE library:         no  OpenSSL compat:       noconfigure: System files:  Trust store pkcs11:  Trust store dir:  Trust store file:     /etc/ssl/certs/ca-certificates.crt  Blacklist file:  CRL file:  Priority file:        /etc/gnutls/default-priorities  DNSSEC root key file: /etc/unbound/root.keyconfigure: WARNING:****** The DNSSEC root key <span class="token function">file</span> <span class="token keyword">in</span> /etc/unbound/root.key was not found.*** This <span class="token function">file</span> is needed <span class="token keyword">for</span> the verification of DNSSEC responses.*** Use the command: unbound-anchor -a <span class="token string">"/etc/unbound/root.key"</span>*** to generate or update it.***</code></pre>              </div>            </details><h4 id="安装">安装</h4><p>同Openssl 一样, 有两种方式, 仅<code> make</code>  和  <code> make &amp;&amp; make install</code></p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 编译   </span><span class="token function">make</span><span class="token comment"># 编译后 在 src 目录下 可以得到  gnutls-cli gnutls-cli-debug gnutls-serv 可执行文件</span><span class="token comment"># 验证版本</span><span class="token variable">$root</span>@380xxx:/xxx/gnutls-3.6.7<span class="token comment"># ./src/gnutls-serv -v</span>gnutls-serv <span class="token number">3.6</span>.7Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2000</span>-2019 Free Software Foundation, and others, all rights reserved.This is <span class="token function">free</span> software. It is licensed <span class="token keyword">for</span> use, modification andredistribution under the terms of the GNU General Public License,version <span class="token number">3</span> or later <span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">></span>Please send bug reports to:  <span class="token operator">&lt;</span>bugs@gnutls.org<span class="token operator">></span><span class="token comment">########################################################################################</span><span class="token comment"># 如果 安装的话 执行 make install</span><span class="token function">make</span> <span class="token function">install</span> <span class="token comment"># 会在 /usr/local/include/gnutls 生成头文件</span><span class="token comment"># /usr/local/bin/ 下 生成 gnutls-cli gnutls-cli-debug gnutls-serv 可执行文件</span><span class="token comment"># 验证版本 </span><span class="token variable">$root</span>@380xxx:/xxx/gnutls-3.6.7<span class="token comment"># /usr/local/bin/gnutls-serv -v</span>gnutls-serv <span class="token number">3.6</span>.7Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2000</span>-2019 Free Software Foundation, and others, all rights reserved.This is <span class="token function">free</span> software. It is licensed <span class="token keyword">for</span> use, modification andredistribution under the terms of the GNU General Public License,version <span class="token number">3</span> or later <span class="token operator">&lt;</span>http://gnu.org/licenses/gpl.html<span class="token operator">></span>Please send bug reports to:  <span class="token operator">&lt;</span>bugs@gnutls.org<span class="token operator">></span></code></pre>              </div>            </details></div><h2 id="WolfSSL">WolfSSL</h2><div class="story post-story"><p><a href="https://github.com/wolfSSL/wolfssl">https://github.com/wolfSSL/wolfssl</a></p><p><a href="https://www.wolfssl.com/">https://www.wolfssl.com/</a></p><h3 id="下载源码">下载源码</h3><pre class="language-bash" data-language="bash"><code class="language-bash">https://www.wolfssl.com/download/<span class="token comment">#  手动下载</span></code></pre><h3 id="编译安装-3">编译安装</h3><pre class="language-bash" data-language="bash"><code class="language-bash">./configure<span class="token comment">#./configure --help ./configure  --enable-psk --enable-pwdbased --enable-rsa --enable-sha --enable-debug --disable-dh --disable-ecc C_EXTRA_FLAGS=-DWOLFSSL_STATIC_PSK </span></code></pre><p>结果</p><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">Configuration summary <span class="token keyword">for</span> wolfssl version <span class="token number">4.7</span>.0   * Installation prefix:        /usr/local   * System type:                pc-linux-gnu   * Host CPU:                   x86_64   * C Compiler:                 gcc   * C Flags:                     -DWOLFSSL_STATIC_PSK  -g -ggdb -O0 -Wno-pragmas -Wall -Wno-strict-aliasing -Wextra -Wunknown-pragmas --param<span class="token operator">=</span>ssp-buffer-size<span class="token operator">=</span><span class="token number">1</span> -Waddress -Warray-bounds -Wbad-function-cast -Wchar-subscripts -Wcomment -Wfloat-equal -Wformat-security -Wformat<span class="token operator">=</span><span class="token number">2</span> -Wmaybe-uninitialized -Wmissing-field-initializers -Wmissing-noreturn -Wmissing-prototypes -Wnested-externs -Wnormalized<span class="token operator">=</span>id -Woverride-init -Wpointer-arith -Wpointer-sign -Wredundant-decls -Wshadow -Wsign-compare -Wstrict-overflow<span class="token operator">=</span><span class="token number">1</span> -Wswitch-enum -Wundef -Wunused -Wunused-result -Wunused-variable -Wwrite-strings -fwrapv   * C++ Compiler:   * C++ Flags:   * CPP Flags:   * CCAS Flags:                  -DWOLFSSL_STATIC_PSK   * LIB Flags:                   -pie -z relro -z now   * Debug enabled:              <span class="token function">yes</span>   * Coverage enabled:   * Warnings as failure:        no   * <span class="token function">make</span> -j:                    <span class="token number">9</span>   * VCS checkout:               no   Features   * FIPS:                       no   * Single threaded:            no   * Filesystem:                 <span class="token function">yes</span>   * OpenSSH Build:              no   * OpenSSL Extra API:          no   * OpenSSL Coexist:            no   * Old Names:                  <span class="token function">yes</span>   * Max Strength Build:         no   * Distro Build:               no   * Reproducible Build:         no   * fastmath:                   <span class="token function">yes</span>   * Assembly Allowed:           <span class="token function">yes</span>   * sniffer:                    no   * snifftest:                  no   * ARC4:                       no   * AES:                        <span class="token function">yes</span>   * AES-NI:                     no   * AES-CBC:                    <span class="token function">yes</span>   * AES-GCM:                    <span class="token function">yes</span>   * AES-CCM:                    no   * AES-CTR:                    no   * AES-CFB:                    no   * AES-OFB:                    no   * DES3:                       no   * IDEA:                       no   * Camellia:                   no   * NULL Cipher:                no   * MD2:                        no   * MD4:                        no   * MD5:                        <span class="token function">yes</span>   * RIPEMD:                     no   * SHA:                        <span class="token function">yes</span>   * SHA-224:                    <span class="token function">yes</span>   * SHA-384:                    <span class="token function">yes</span>   * SHA-512:                    <span class="token function">yes</span>   * SHA3:                       <span class="token function">yes</span>   * SHAKE256:                   <span class="token function">yes</span>   * BLAKE2:                     no   * BLAKE2S:                    no   * CMAC:                       no   * keygen:                     no   * certgen:                    no   * certreq:                    no   * certext:                    no   * certgencache:               no   * HC-128:                     no   * RABBIT:                     no   * CHACHA:                     <span class="token function">yes</span>   * XCHACHA:                    no   * Hash DRBG:                  <span class="token function">yes</span>   * PWDBASED:                   <span class="token function">yes</span>   * scrypt:                     no   * wolfCrypt Only:             no   * HKDF:                       <span class="token function">yes</span>   * X9.63 KDF:                  no   * MD4:                        no   * PSK:                        <span class="token function">yes</span>   * Poly1305:                   <span class="token function">yes</span>   * LEANPSK:                    no   * LEANTLS:                    no   * RSA:                        <span class="token function">yes</span>   * RSA-PSS:                    <span class="token function">yes</span>   * DSA:                        no   * DH:                         no   * DH Default Parameters:      <span class="token function">yes</span>   * ECC:                        no   * ECC Custom Curves           no   * ECC Minimum Bits            <span class="token number">224</span>   * CURVE25519:                 no   * ED25519:                    no   * CURVE448:                   no   * ED448:                      no   * FPECC:                      no   * ECC_ENCRYPT:                no   * ASN:                        <span class="token function">yes</span>   * Anonymous cipher:           no   * CODING:                     <span class="token function">yes</span>   * MEMORY:                     <span class="token function">yes</span>   * I/O POOL:                   no   * LIGHTY:                     no   * HAPROXY:                    no   * STUNNEL:                    no   * Apache httpd:               no   * NGINX:                      no   * ASIO:                       no   * LIBWEBSOCKETS:              no   * Qt                          no   * Qt Unit Testing             no   * SIGNAL:                     no   * ERROR_STRINGS:              <span class="token function">yes</span>   * DTLS:                       no   * SCTP:                       no   * Indefinite Length:          no   * Multicast:                  no   * SSL v3.0 <span class="token punctuation">(</span>Old<span class="token punctuation">)</span>:             no   * TLS v1.0 <span class="token punctuation">(</span>Old<span class="token punctuation">)</span>:             no   * TLS v1.1 <span class="token punctuation">(</span>Old<span class="token punctuation">)</span>:             <span class="token function">yes</span>   * TLS v1.2:                   <span class="token function">yes</span>   * TLS v1.3:                   <span class="token function">yes</span>   * Post-handshake Auth:        no   * Early Data:                 no   * Send State <span class="token keyword">in</span> HRR Cookie:   no   * OCSP:                       no   * OCSP Stapling:              no   * OCSP Stapling v2:           no   * CRL:                        no   * CRL-MONITOR:                no   * Persistent session cache:   no   * Persistent cert    cache:   no   * Atomic User Record Layer:   no   * Public Key Callbacks:       no   * NTRU:                       no   * QSH:                        no   * Whitewood netRandom:        no   * Server Name Indication:     no   * ALPN:                       no   * Maximum Fragment Length:    no   * Trusted CA Indication:      no   * Truncated HMAC:             no   * Supported Elliptic Curves:  no   * FFDHE only <span class="token keyword">in</span> client:       no   * Session Ticket:             no   * Extended Master Secret:     <span class="token function">yes</span>   * Renegotiation Indication:   no   * Secure Renegotiation:       no   * Fallback SCSV:              no   * Keying Material Exporter:   no   * All TLS Extensions:         no   * PKCS<span class="token comment">#7                      no</span>   * S/MIME                      no   * wolfSSH                     no   * wolfTPM                     no   * wolfSCEP                    no   * Secure Remote Password      no   * Small Stack:                no   * Linux Kernel Module:        no   * valgrind unit tests:        no   * LIBZ:                       no   * Examples:                   <span class="token function">yes</span>   * Crypt tests:                <span class="token function">yes</span>   * Stack sizes <span class="token keyword">in</span> tests:       no   * Heap stats <span class="token keyword">in</span> tests:        no   * User Crypto:                no   * Fast RSA:                   no   * Single Precision:           no   * SP math implementation:     no   * Async Crypto:               no   * PKCS<span class="token comment">#11:                    no</span>   * PKCS<span class="token comment">#12:                    yes</span>   * Cavium Nitrox:              no   * Cavium Octeon <span class="token punctuation">(</span>Sync<span class="token punctuation">)</span>:       no   * Intel Quick Assist:         no   * ARM ASM:                    no   * AES Key Wrap:               no   * Write duplicate:            no   * Xilinx Hardware Acc.:       no   * Inline Code:                <span class="token function">yes</span>   * Linux AF_ALG:               no   * Linux devcrypto:            no   * Crypto callbacks:           no</code></pre>              </div>            </details><details green><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span><span class="token comment"># 如果遇到错误 'aclocal-1.15' is missing on your system”</span><span class="token comment"># 先执行autoreconf -f -i  在执行 ./configure  在 make</span><span class="token comment">## 安装 如上</span><span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span class="token comment"># To test the build, run the testsuite program from the root wolfSSL directory:</span>./testsuite/testsuite.test<span class="token comment"># or use autoconf to run the testsuite as well as the standard wolfSSL API and crypto tests:</span><span class="token function">make</span> <span class="token builtin class-name">test</span><span class="token comment">############################</span><span class="token comment"># 如果没有configure  使用 cmake</span><span class="token comment"># 安装 cmake</span><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> cmake<span class="token comment"># Usage:</span><span class="token function">mkdir</span> build <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> buildcmake <span class="token punctuation">..</span>cmake --build <span class="token builtin class-name">.</span></code></pre>              </div>            </details><h3 id="结果运行">结果运行</h3><p>在<code>根目录下/exaples/</code> 中 有 <code>server</code> 和 <code>client</code></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 笔记 </category>
          
          <category> SSL </category>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
            <tag> 笔记 </tag>
            
            <tag> GnuTLS </tag>
            
            <tag> OpenSSL </tag>
            
            <tag> WolfSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>本地Navicat连接本地docker容器中mysql</title>
      <link href="/posts/35862d23/"/>
      <url>/posts/35862d23/</url>
      
        <content type="html"><![CDATA[<h1>本地navicat连接本地docker容器中mysql</h1><blockquote><p>😄 @Auther by sizaif</p><p>📆 2021-06-24  17:54:18</p></blockquote><p>[TOC]</p><h2 id="修订历史">修订历史</h2><div class="story post-story"><ul><li>2021-06-24  17:54:31: 首次编辑</li><li>2021-06-24  22:28:18: update bug</li></ul></div><h2 id="具体步骤">具体步骤</h2><div class="story post-story"><p>如果已经有了mysql镜像, 直接跳过,到docker mysql容器中</p><h3 id="docker-拉去-mysql-镜像">docker 拉去 mysql 镜像</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker pull mysql  </code></pre><h3 id="启动MySQL镜像">启动MySQL镜像</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker run --name<span class="token operator">=</span>mysql -itd -p <span class="token operator">&lt;</span>宿主机映射端口<span class="token operator">></span>:3306 -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token operator">&lt;</span>密码<span class="token operator">></span> mysql  </code></pre><h3 id="进入MySQL容器">进入MySQL容器</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker <span class="token builtin class-name">exec</span> -it mysql /bin/bash</code></pre><h3 id="进入MySQL">进入MySQL</h3><p><strong>设置允许外部登录的mysql用户</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ mysql -uroot -p<span class="token operator">&lt;</span>密码<span class="token operator">></span><span class="token comment"># 设置允许外部登录的mysql用户: 'test' host监听地址:'%' 密码 test</span>$ mysql<span class="token operator">></span> CREATE <span class="token environment constant">USER</span> If Not Exists <span class="token string">'test'</span>@<span class="token string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="token string">'test'</span><span class="token punctuation">;</span><span class="token comment"># 赋予用户权限</span>$ mysql<span class="token operator">></span> GRANT all privileges ON test.* TO <span class="token string">'test'</span>@<span class="token string">'%'</span> identified by <span class="token string">'test'</span><span class="token punctuation">;</span><span class="token comment"># 刷新</span>$ mysql<span class="token operator">></span>flush privileges<span class="token punctuation">;</span></code></pre><p><strong>修改mysql配置，允许任意主机访问</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改 mysqld.cnf中 bind-address监听地址loaclhst为0.0.0.0</span>$ <span class="token function">sed</span> -i <span class="token string">'s/^bind-address.*$/bind-address=0.0.0.0/'</span> /etc/mysql/mysql.conf.d/mysqld.cnf<span class="token comment"># 重启mysql</span>$ <span class="token function">service</span> mysql restart</code></pre><p>若嫌进入mysql太麻烦直接运行如下命令,替换掉<code>&lt;&gt;</code>中内容</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#修改mysql配置，允许任意主机访问</span>$ <span class="token function">sed</span> -i <span class="token string">'s/^bind-address.*$/bind-address=0.0.0.0/'</span> /etc/mysql/mysql.conf.d/mysqld.cnf$ <span class="token function">service</span> mysql restart<span class="token comment"># 新建允许外部登录的mysql用户：'&lt;test>'@'%'，密码&lt;test></span><span class="token assign-left variable"><span class="token environment constant">USER</span></span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/mysql/debian.cnf <span class="token operator">|</span><span class="token function">grep</span> user<span class="token operator">|</span><span class="token function">head</span> -1<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span><span class="token variable">`</span></span><span class="token assign-left variable">PW</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /etc/mysql/debian.cnf <span class="token operator">|</span><span class="token function">grep</span> password<span class="token operator">|</span><span class="token function">head</span> -1<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'&#123;print $3&#125;'</span><span class="token variable">`</span></span>mysql -u<span class="token variable">$&#123;<span class="token environment constant">USER</span>&#125;</span> -p<span class="token variable">$&#123;PW&#125;</span> -e<span class="token string">"CREATE USER If Not Exists '&lt;test>'@'%' IDENTIFIED WITH mysql_native_password BY '&lt;test>';"</span>mysql -u<span class="token variable">$&#123;<span class="token environment constant">USER</span>&#125;</span> -p<span class="token variable">$&#123;PW&#125;</span> -e<span class="token string">"GRANT all privileges ON &lt;your mysql continer name>.* TO '&lt;test>'@'%' identified by '&lt;test>';flush privileges;"</span></code></pre><h3 id="navicat-远程连接">navicat 远程连接</h3><p>然后远程连接【<strong>宿主机ip</strong>:<strong>&lt;宿主机映射端口&gt;</strong>】，使用新建的用户登录mysql即可。</p><blockquote><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token operator">></span>$ docker run --name<span class="token operator">=</span>mysql -itd -p <span class="token operator">&lt;</span>宿主机映射端口<span class="token operator">></span>:3306 -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token operator">&lt;</span>密码<span class="token operator">></span> mysql  </code></pre></blockquote><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210624181631.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210624181631.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210624181630341"></p></div><h2 id="问题发现整理">问题发现整理</h2><div class="story post-story"><ol><li><p><font color='red'>报2013错误</font></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210624181916.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210624181916.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210624181915547"></p><p>这个原因一般是由mysql中已经设定用户的远程host为’%',但是mysqld.cnf 或 my.cnf中 <code>bind-address </code>监听地址为<code>localhost</code>导致</p></li><li><p><font color='red'>报1045错误 Access defined</font></p><p>一般是由于密码不正确或用户不正确导致</p></li></ol></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 教程 </tag>
            
            <tag> Docker </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>生成Openssl &amp;&amp; Gnutls  Keys</title>
      <link href="/posts/bb0d4a87/"/>
      <url>/posts/bb0d4a87/</url>
      
        <content type="html"><![CDATA[<h1>生成openssl &amp;&amp; gnutls  keys</h1><blockquote><p>😄 @by sizaif</p><p>📆 2021-05-17  20:36:00</p></blockquote><p>[TOC]</p><h2 id="Openssl">Openssl</h2><div class="story post-story"><details green><summary> 代码 </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Generate DH parameters</span>openssl dhparam -outform PEM -out dhparams.pem -5 <span class="token number">2048</span><span class="token comment"># Generate CA key and certificate CA.pl or CA.sh</span>/usr/lib/ssl/misc/CA.pl -newca<span class="token comment"># Generate server key and certificate</span>openssl req -newkey rsa:1024 -nodes -keyout server.key -out server.reqopenssl ca -out server.crt -infiles server.req<span class="token comment"># Generate client key and certificate</span>openssl req -newkey rsa:1024 -nodes -keyout client.key -out client.reqopenssl ca -out client.crt -infiles client.req<span class="token comment"># Generate client DH key and certificate</span>openssl genpkey -paramfile dhparams.pem -out client_dh.keyopenssl pkey -in client_dh.key -pubout -out client_dh.pub<span class="token comment">#~/SSL/openssl/openssl-1.0.2/apps/openssl x509 -req -in client.req -CAkey demoCA/private/cakey.pem -CA demoCA/cacert.pem -force_pubkey client_dh.pub -out client_dh.crt -CAcreateserial -extensions v3_req -extfile ./openssl.cnf</span><span class="token comment"># Get keys in Java keystore</span><span class="token comment"># 这里设置服务端 的名称为 server  密码为 changeit</span>openssl pkcs12 -export -in server.crt -inkey server.key -out server.p12 -name server -CAfile ca.crt -caname rootkeytool -importkeystore -deststorepass changeit -destkeypass changeit -destkeystore keystore -srckeystore server.p12 -srcstoretype PKCS12 -srcstorepass changeit -alias server<span class="token comment"># 这里设置客户端 的名称为 client  密码为 changeit</span>openssl pkcs12 -export -in client.crt -inkey client.key -out client.p12 -name client -CAfile ca.crt -caname rootkeytool -importkeystore -srckeystore client.p12 -destkeystore keystore -srcstoretype PKCS12  -srcstorepass changeit -deststorepass changeit -destkeypass changeit  -alias client<span class="token comment">#openssl pkcs12 -export -in client_dh.crt -inkey client_dh.key -out client_dh.p12 -name clientdh -CAfile ca.crt -caname root</span><span class="token comment">#keytool -importkeystore -deststorepass changeit -destkeypass changeit -destkeystore keystore -srckeystore client_dh.p12 -srcstoretype PKCS12 -srcstorepass changeit -alias clientdh</span><span class="token comment"># Get keys in Netscape keystore</span>certutil -N -d <span class="token builtin class-name">.</span>certutil -A -n ca -i demoCA/cacert.pem -d <span class="token builtin class-name">.</span> -t TCcertutil -A -n server -i server.crt -d <span class="token builtin class-name">.</span> -t Ppk12util -d <span class="token builtin class-name">.</span> -i server.p12certutil -A -n client1 -i client.crt -d <span class="token builtin class-name">.</span> -t Ppk12util -d <span class="token builtin class-name">.</span> -i client.p12</code></pre>              </div>            </details></div><h2 id="GnuTLS">GnuTLS</h2><div class="story post-story"><details blue><summary> code </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#生成CA私钥</span>certtool --generate-privkey <span class="token operator">></span> x509-ca-key.pem<span class="token comment"># 创建CA模版</span><span class="token function">vim</span> ca.tmplcn <span class="token operator">=</span> <span class="token string">"GnuTLS test CA"</span>organization <span class="token operator">=</span> <span class="token string">"TLSTest"</span>serial <span class="token operator">=</span> <span class="token number">1</span>expiration_days <span class="token operator">=</span> <span class="token number">3650</span>casigning_keycert_signing_keycrl_signing_key<span class="token comment">#生成CA证书</span>certtool --generate-self-signed --load-privkey x509-ca-key.pem --template ca.tmpl --outfile x509-ca.pem<span class="token comment">#生成Server私钥</span>certtool --generate-privkey <span class="token operator">></span> x509-server-key.pem<span class="token comment">#创建Server证书模版</span><span class="token function">vim</span> server.tmplcn <span class="token operator">=</span> <span class="token string">"GnuTLS test server"</span> organization <span class="token operator">=</span> <span class="token string">"TLSTest"</span> expiration_days <span class="token operator">=</span> <span class="token number">3650</span>signing_key encryption_keytls_www_server<span class="token comment">#生成Server证书</span>certtool --generate-certificate --load-privkey x509-server-key.pem <span class="token punctuation">\</span>  --load-ca-certificate x509-ca.pem --load-ca-privkey x509-ca-key.pem <span class="token punctuation">\</span>  --template server.tmpl --outfile x509-server.pem  <span class="token comment">#生成Client私钥</span>certtool --generate-privkey <span class="token operator">></span> x509-client-key.pem<span class="token comment">#创建Client证书模版</span><span class="token function">vim</span> client.tmplcn <span class="token operator">=</span> GnuTLS <span class="token builtin class-name">test</span> client    tls_www_clientencryption_keysigning_key  tls_www_client<span class="token comment">#生成Client证书</span>certtool --generate-certificate --load-privkey x509-client-key.pem <span class="token punctuation">\</span>  --load-ca-certificate x509-ca.pem --load-ca-privkey x509-ca-key.pem <span class="token punctuation">\</span>  --template client.tmpl --outfile x509-client.pem  <span class="token comment">#转换为p12证书 以及java keystore ;Get keys in Java keystore</span><span class="token comment"># 这里设置的名称为 client</span><span class="token comment"># 密码为123456</span>certtool --to-p12 --load-ca-certificate x509-ca.pem <span class="token punctuation">\</span>  --load-privkey x509-client-key.pem --load-certificate x509-client.pem <span class="token punctuation">\</span>  --outder --outfile x509-client.p12keytool -importkeystore -srckeystore x509-client.p12 -destkeystore keystore -srcstoretype PKCS12 -srcstorepass <span class="token number">123456</span> -deststorepass <span class="token number">123456</span>  -alias client<span class="token comment"># 这里设置的名称为 server </span><span class="token comment"># 密码为123456</span>certtool --to-p12 --load-ca-certificate x509-ca.pem <span class="token punctuation">\</span>  --load-privkey x509-server-key.pem --load-certificate x509-server.pem <span class="token punctuation">\</span>  --outder --outfile x509-server.p12keytool -importkeystore -srckeystore x509-server.p12 -destkeystore keystore -srcstoretype PKCS12 -srcstorepass <span class="token number">123456</span> -deststorepass <span class="token number">123456</span>  -alias server</code></pre>              </div>            </details></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 笔记 </category>
          
          <category> SSL </category>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
            <tag> 笔记 </tag>
            
            <tag> GnuTLS </tag>
            
            <tag> OpenSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用代理进行 Docker Build 问题的解决思路</title>
      <link href="/posts/d4ac1b81/"/>
      <url>/posts/d4ac1b81/</url>
      
        <content type="html"><![CDATA[<h1>使用代理进行 docker build 问题的解决思路</h1><blockquote><p>😄 @Auther: sizaif</p><p>📆 2021-06-10  00:03:14</p><p>🐔 转载至:</p><p>原文作者: <a href="http://www.simpleapples.com/">simpleapples</a></p><p>原文链接: <a href="http://www.simpleapples.com/2019/04/18/building-docker-image-behind-proxy/">http://www.simpleapples.com/2019/04/18/building-docker-image-behind-proxy/</a></p><p>许可协议: <a href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></blockquote><p>[TOC]</p><h3 id="问题描述">问题描述</h3><p>在使用 docker build 打包镜像时，遇到了需要使用代理访问网络的需求。使用如下的 Dockerfile 来模拟这个场景：</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM golang:1.12RUN <span class="token function">curl</span> www.google.com --max-time <span class="token number">3</span></code></pre><p>国内一般网络环境下，curl <a href="http://www.google.com/">www.google.com</a> 是无法正常返回的，加入 –max-time 让 curl 的耗时不要太长。</p><h3 id="配置-http-proxy-变量">配置 http_proxy 变量</h3><p>首先需要在环境变量中设置 http_proxy 和 https_proxy，使得访问网络的命令（这里使用 curl 来代表）能够通过环境变量中配置的代理服务器访问 <a href="http://www.google.com./">www.google.com。</a></p><p><code>docker build </code>命令虽然是在<code> docker</code> 所在的宿主机上执行的，看上去像是直接使用了宿主机的网络环境，但实际上<code>docker build </code>也是启动了一个<code>container</code>进行构建，所以在构建过程中的所有命令都是在 <code>container </code>中执行的，<code>http_proxy</code> 和<code> https_proxy</code> 的配置也应该是在<code> container</code> 中进行的。可以使用 ENV 来配置 <code>container</code> 中的环境变量。</p><p>代理服务器启动在宿主机的 1087 端口上，修改 dockerfile 文件：</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM golang:1.12ENV http_proxy <span class="token string">"http://127.0.0.1:1087"</span>ENV HTTP_PROXY <span class="token string">"http://127.0.0.1:1087"</span>ENV https_proxy <span class="token string">"http://127.0.0.1:1087"</span>ENV HTTPS_PROXY <span class="token string">"http://127.0.0.1:1087"</span>RUN <span class="token function">curl</span> www.google.com --max-time <span class="token number">3</span></code></pre><p>重新执行 docker build 会发现 curl 依旧无法访问 <a href="http://www.google.xn--com%2C-394fp4bweo4fbyix5exq7b9sf0p8ep61e/">www.google.com，从报错信息上可以看到</a> 127.0.0.1 上的 1087 端口上并没有服务。</p><h3 id="访问宿主机">访问宿主机</h3><p>由于 <code>container</code> 默认是桥接网络，宿主机和 <code>container</code> 是平级的，被放在了一个虚拟的网段里。访问宿主机上的代理服务器，对于<code> container</code> 来说实际上是访问另一台机器上的服务器，127.0.0.1 指向的是 container 本身。在 docker 默认的桥接网络中，宿主机的 IP 一般是 <code>172.17.0.1（Linux）</code>，或者 <code>192.168.65.1（MacOS）</code>，可以将 http_proxy 中的 IP 换成 <code>172.17.0.1/192.168.65.1</code>，来实现通过宿主的代理服务器访问网络，修改 dockerfile：</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM golang:1.12ENV http_proxy <span class="token string">"http://172.17.0.1:1087"</span>ENV HTTP_PROXY <span class="token string">"http://172.17.0.1:1087"</span>ENV https_proxy <span class="token string">"http://172.17.0.1:1087"</span>ENV HTTPS_PROXY <span class="token string">"http://172.17.0.1:1087"</span>RUN <span class="token function">curl</span> www.google.com --max-time <span class="token number">3</span></code></pre><p>虽然使用这种方式可以达到目的，但是如果编译环境变了或者代理服务器的配置变了，哪怕只是操作系统从 Linux 变成了 MacOS，都得修改 dockerfile，显然不够解耦，也不方便。</p><h3 id="配置网络模式">配置网络模式</h3><p>docker 中还有一种 host 网络模式，就是让 container 使用宿主机的网络，相当于 container 在网络层面和宿主机不做隔离，使用这种网络模式执行 docker build，就不需要在 dockerfile 中添加 http_proxy 环境变量，container 可以直接读取宿主上的环境变量。</p><p>首先在宿主上导入 http_proxy 环境变量：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">http_proxy</span><span class="token operator">=</span><span class="token string">"http://127.0.0.1:7890"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">HTTP_PROXY</span><span class="token operator">=</span><span class="token string">"http://127.0.0.1:7890"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span><span class="token string">"http://127.0.0.1:7890"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">HTTPS_PROXY</span><span class="token operator">=</span><span class="token string">"http://127.0.0.1:7890"</span></code></pre><p>接下来将 dockerfile 简化：</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM golang:1.12RUN <span class="token function">curl</span> www.google.com --max-time <span class="token number">3</span></code></pre><p>重新执行 docker build，加上参数 –network host，使用宿主网络：</p><pre class="language-bash" data-language="bash"><code class="language-bash">docker build --network <span class="token function">host</span> <span class="token builtin class-name">.</span></code></pre><p>执行后 curl 就可以像在宿主上直接执行一样，通过代理访问 <a href="http://www.google.com/">www.google.com</a> 了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 技术向 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>证书间的道道油</title>
      <link href="/posts/b495581d/"/>
      <url>/posts/b495581d/</url>
      
        <content type="html"><![CDATA[<h1>证书间的道道油</h1><blockquote><p>😄 @auther sizaif</p><p>📆 2021-05-20  17:29:05</p></blockquote><p>[TOC]</p><h2 id="什么是PEM文件格式">什么是PEM文件格式</h2><div class="story post-story"><p>( <strong>Privacy-Enhanced Mail</strong>)</p><p>是一种事实上的文件格式，用于存储和发送加密密钥、证书和其他数据，基于一组定义“增强隐私的邮件”的1993 IETF标准</p><p>许多密码学标准使用ASN.1来定义它们的数据结构，并使用区分编码规则**<code>(Distinguished Encoding Rules, DER)</code>**来序列化这些结构,因为<code>DER</code>产生二进制输出，所以通过只支持ASCII的系统(如电子邮件)传输结果文件可能很困难。</p><p>PEM格式通过使用<code>base64</code>对二进制数据进行编码解决了这个问题。PEM还定义了一行页眉，包括“-----BEGIN”、一个标签和“-----”;一行页脚，包括“-----END”、一个标签和“-----”。标签决定了编码的消息类型。常用标签有“CERTIFICATE”、“CERTIFICATE REQUEST”、“PRIVATE KEY”、“X509 CRL”等。</p><p><strong>PEM数据通常存储在后缀为“ .pem”，后缀为“ .cer”或“ .crt”（用于证书）或后缀“ .key”（用于公钥或私钥）的文件中。[3] PEM文件中的标签比文件后缀更准确地表示数据类型，因为可以将许多不同类型的数据保存在“ .pem”文件中。</strong></p></div><h2 id="什么是X-690">什么是X.690</h2><div class="story post-story"><p>X.690是一个ITU-T标准，指定了几种ASN.1编码格式:</p><ul><li><a href="https://en.wikipedia.org/wiki/X.690#BER_encoding">Basic Encoding Rules</a> (BER)</li><li><a href="https://en.wikipedia.org/wiki/X.690#CER_encoding">Canonical Encoding Rules</a> (CER)</li><li><a href="https://en.wikipedia.org/wiki/X.690#DER_encoding">Distinguished Encoding Rules</a> (DER)</li></ul><p><strong>参考链接:</strong></p><p><a href="https://en.wikipedia.org/wiki/X.690#DER_encoding">https://en.wikipedia.org/wiki/X.690#DER_encoding</a></p><h3 id="BER-encoding">BER encoding</h3><p>基本编码规则的格式指定编码ASN.1数据结构的自描述和自定界格式。每个数据元素都被编码为类型标识符、长度描述、实际数据元素以及必要时的内容结束标记。这些编码类型通常称为类型-长度-值或TLV编码。这种格式允许接收方从不完整的流中解码ASN.1信息，而不需要任何关于数据的大小、内容或语义的预先知识</p><h3 id="DER-encoding">DER encoding</h3><p><strong>DER (Distinguished Encoding Rules)</strong> 是BER的一个受限变体，用于为ASN.1描述的数据结构产生明确的传输语法。像CER, DER编码是有效的BER编码。除一个发送者的选项外，DER与BER是一样的。</p><p>DER是BER的子集，提供了一种对ASN.1值进行编码的方法。DER适用于需要唯一编码的情况，例如在密码学中，并确保需要进行数字签名的数据结构产生唯一的序列化表示。DER可以被认为是误码率的标准形式。例如，在BER中，一个布尔值true可以被编码为255个非零字节值中的任何一个，而在DER中，有一种方法可以将布尔值true编码。</p><p>最重要的DER编码约束是:</p><ol><li><p>长度编码必须使用确定的形式</p><p>​此外，必须使用尽可能短的长度编码</p></li><li><p>位字符串、八字节字符串和受限字符串必须使用原始编码</p></li><li><p>Set中的元素根据标记值按排序顺序进行编码</p></li></ol><p><strong>DER广泛用于X.509等数字证书。</strong></p><h3 id="CER-encoding">CER encoding</h3><p>CER(规范编码规则)是BER的一种受限变体，用于为ASN.1描述的数据结构生成明确的传输语法。BER提供了对数据值如何编码的选择，而CER(连同DER)只从基本编码规则允许的编码中选择一种编码，消除了其他选项。当必须保留编码时，CER是有用的;例如，在证券交易中</p><h3 id="BER、CER、DER比较">BER、CER、DER比较</h3><p><code>BER格式</code>和<code>CER</code>或<code>DER</code>格式之间的关键区别是基本编码规则提供的灵活性</p><p><code>BER</code>，如上所述，是ITU-T X.690给出的用于ASN.1数据结构传输的编码规则的基本集合。它为发送方想要发送的数据结构提供了明确的编码规则，但也给发送方留下了一些编码选择.正如X.690标准中所述，“作为发送方的选项，基本编码规则允许替代编码。”声称符合基本编码规则的接收方应支持所有替代方案”</p><p>接收方必须准备好接受所有合法编码，才能合法声明<code>BER-compliance</code>,相比之下，<code>CER</code>和<code>DER</code>都将可用长度规范限制为单个选项。因此，<code>CER</code>和<code>DER</code>是误码率的限制形式，用于消除误码率标准的歧义。</p><p><code>CER</code>和<code>DER</code>的不同之处在于它们对发送方施加的限制。<code>CER</code>和<code>DER</code>的基本区别是，在某些精确定义的情况下，<code>DER</code>采用定长形式，<code>CER</code>采用不定长形式。也就是说，<code>DER</code>总是具有前导长度信息，而<code>CER</code>使用内容结束八位元，而不是提供编码数据的长度。因此，对于大的编码值，<code>CER</code>需要较少的元数据，而对于小的编码值，<code>DER</code>需要较少的元数据。</p><p>为了便于编码规则之间的选择，X.690标准文档提供了以下指导:</p><p>如果编码的值足够小，能够适应可用内存，并且需要快速跳过一些嵌套的值，那么区分编码规则比规范编码规则更合适。规范化编码规则比杰出的编码规则更合适的如果有需要编码值太大了,他们不能轻易适应可用内存或需要编码和传输的一部分价值在整个价值是可用的。基本编码规则比规范的或专有的编码规则i更合适</p></div><h2 id="公钥-私钥-数字证书">公钥,私钥,数字证书</h2><div class="story post-story"><h3 id="公钥私钥">公钥私钥</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210520212726.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210520212726.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="629313-20151122161624827-1966568154"></p><p>Bob有两把钥匙，一把叫公钥（public key），一把叫私钥（private key）</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210520212801.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210520212801.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="629313-20151122161551327-1906130388"></p><p>Bob的公钥可以公开供其他人使用，他只保留自己的私钥。公钥和私钥用来加解密数据，如果使用任意一把来加密数据，那么只有使用另外一把才能解密数据。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210520212838.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210520212838.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="629313-20151122163018436-693407030"></p><p>Susan想给Bob写信，她可以使用Bob的公钥将内容加密以后发送给Bob，Bob收到以后，使用私钥解密以便阅读内容。Bob的的其他同事即使截获了Susan发送给Bob的信件，由于没有Bob的私钥，也无法解密，从而确保数据安全。以上就是使用公钥和私钥加解密的过程演示。</p><p>如果Bob给Susan回信，如何保证数据安全呢？他可以使用Susan的公钥加密消息后发给Susan，Susan使用自己的私钥解密后阅读。所以保护好自己的私钥是多么重要的事情啊。</p><h3 id="数字签名">数字签名</h3><p>现在Bob决定给Pat写一份信，信件的内容不用加密，但是要保证Pat收到信件后，能够确认信件的确是Bob发出的，而不是别人冒充Bob发给Pat的，应该如果做呢？</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210520213004.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210520213004.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="629313-20151122163932046-1763066023"></p><p>Bob将信件通过hash软件计算一下，得到一串消息摘要（有的文章也称之为“hash值”）。这一过程能够保证2点：</p><p>1、过程不可逆。即不能通过消息摘计算出信件的内容。</p><p>2、消息摘要不会重复。即如果信件有任何改动，再次hash计算出的消息摘要一定不会和改动前的消息摘要一致。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210520213103.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210520213103.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="629313-20151122165949765-1082349152"></p><p>然后，Bob使用自己的私钥，将消息摘要加密。加密后的结果，我们称之为“数字签名”。现在，Bob就可以将信件连同数字签名一起发给Pat。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210520213139.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210520213139.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="629313-20151122170543796-107989233"></p><p>Pat收到信件以后，会做2件事：</p><p>1、使用Bob的公钥将数字签名解密，如果顺利解密，说明的确是Bob签发的数字签名，不是别人签发的，因为Bob的私钥没有公开。2、Pat使用hash软件对信件再次进行hash计算，和解密数字签名得到的消息摘要对比，如果一致，说明信件没有篡改，确实是Bob发出的。这就是数字签名的过程。它能够确保签名人发出的消息不被篡改，也能证明的确是签名人发出的消息。</p><h3 id="数字证书">数字证书</h3><p>使用数字证书可以确保公钥不被冒充。数字证书是经过权威机构（CA）认证的公钥，通过查看数字证书，可以知道该证书是由那家权威机构签发的，证书使用人的信息，使用人的公钥。它有以下特点：</p><p>1、由专门的机构签发的数字证书才安全有效。</p><p>2、签发数字证书是收费的。</p><p>3、不会被冒充，安全可信。</p><p>4、数字证书有使用期限，过了使用期限，证书变为不可用。CA也可以在试用期内，对证书进行作废操作。</p><h3 id="公钥私钥证书生成">公钥私钥证书生成</h3><p>参考:  <code>生成OpenSSL &amp;&amp; GntTLS &amp;&amp; WolfSSL keys 文档 </code></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> 笔记 </category>
          
          <category> SSL </category>
          
          <category> SSL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSL </tag>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAXB 学习</title>
      <link href="/posts/a893dad1/"/>
      <url>/posts/a893dad1/</url>
      
        <content type="html"><![CDATA[<h1>JAXB 学习</h1><blockquote><p>😄 @Auther: sizaif</p><p>📆 2021-06-06  21:13:30</p></blockquote><p>[TOC]</p><h2 id="说明">说明</h2><div class="story post-story"><p>Java XML绑定体系结构(JAXB)通过JAXB应用程序的示例介绍了Java XML绑定体系结构(JAXB)技术。</p><p><strong>在阅读本教程之前</strong></p><p>要理解和使用XML绑定Java体系结构(JAXB)教程中的信息，您应该了解以下技术:</p><ul><li>Java编程语言及其开发环境</li><li>可扩展标记语言</li></ul><p>本教程只详细研究JAXB特有的代码。</p></div><h2 id="JAXB概论">JAXB概论</h2><div class="story post-story"><p>用于XML绑定的Java体系结构(JAXB)提供了一种快速而方便的方法来绑定XML模式和Java表示，使得Java开发人员可以很容易地在Java应用程序中合并XML数据和处理函数。作为此过程的一部分，JAXB提供了将XML实例文档编组(读取)为Java内容树，然后将Java内容树编组(写入)为XML实例文档的方法。JAXB还提供了一种从Java对象生成XML模式的方法。</p><p>AXB 2.0包含了JAXB 1.0的几个重要改进:</p><ul><li>支持所有W3C XML Schema特性。(JAXB 1.0没有为某些W3C XML Schema特性指定绑定。)</li><li>通过添加<code>javax.xml.bind.annotation</code>包来控制这种绑定，支持将java绑定到xml。(JAXB 1.0指定了XML模式到java的映射，但没有指定java到XML模式的映射。)</li><li>显著减少了生成的模式派生类的数量。</li><li>通过JAXP 1.3验证api提供的额外验证功能。</li><li>较小的运行时库。</li></ul><p>本课描述JAXB体系结构、函数和核心概念，并提供示例和使用JAXB的逐步过程。</p></div><h2 id="JAXB架构">JAXB架构</h2><div class="story post-story"><p>本节描述JAXB处理模型中的组件和交互。</p><h3 id="结构概述">结构概述</h3><p>下图显示了组成JAXB实现的组件。</p><p>图:JAXB体系结构概述</p><p><img src="https://docs.oracle.com/javase/tutorial/figures/jaxb/jaxb-overview.gif" class="lazyload" data-srcset="https://docs.oracle.com/javase/tutorial/figures/jaxb/jaxb-overview.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="JAXB Architectural Overview"></p><p>JAXB实现由以下架构组件组成:</p><ul><li>模式编译器:将源模式绑定到一组从模式派生的程序元素。绑定由基于xml的绑定语言描述。</li><li>模式生成器:将一组现有的程序元素映射到派生的模式。映射是由程序注释描述的。</li><li>绑定运行时框架:提供解组(读取)和编组(写入)操作，以便使用模式派生的或现有的程序元素访问、操作和验证XML内容。</li></ul><h3 id="JAXB绑定过程">JAXB绑定过程</h3><p>下图显示了JAXB绑定过程中发生的事情。</p><p>图:JAXB绑定过程中的步骤</p><p><img src="https://docs.oracle.com/javase/tutorial/figures/jaxb/jaxb-dataBindingProcess.gif" class="lazyload" data-srcset="https://docs.oracle.com/javase/tutorial/figures/jaxb/jaxb-dataBindingProcess.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="Steps in the JAXB Binding Process"></p><p>JAXB数据绑定过程中的一般步骤是:</p><ol><li>生成类(<code>Generate classes</code>):将XML模式用作JAXB绑定编译器的输入，以基于该模式生成JAXB类。</li><li>编译类(<code>Compile classes</code>):必须编译所有生成的类、源文件和应用程序代码。</li><li>解组(<code>Unmarshal</code>):根据源模式中的约束编写的XML文档由JAXB绑定框架解组。请注意，JAXB还支持从文件和文档以外的源(如DOM节点、字符串缓冲区、SAX源等)对XML数据进行解组。</li><li>生成内容树(<code>Generate content tree</code>):解组过程生成从生成的JAXB类实例化的数据对象的内容树;这个内容树表示源XML文档的结构和内容。</li><li>验证(可选)😦 <code>Validate (optional)</code>)解组过程涉及在生成内容树之前验证源XML文档。注意，如果在步骤6中修改了内容树，还可以使用JAXB Validate操作在将内容编组回XML文档之前验证更改。</li><li>过程内容(<code>Process content</code>):通过使用绑定编译器生成的接口，客户机应用程序可以修改Java内容树表示的XML数据。</li><li>封装(<code>Marshal</code>):将处理过的内容树封送到一个或多个XML输出文档。可以在编组前对内容进行验证。</li></ol><p><strong>More About Unmarshalling</strong></p><p>解组(<code>Unmarshalling</code>)为客户机应用程序提供了将<code>XML数</code>据转换为<code>jaxb派生的Java对象</code>的能力。即 从<code>xml -&gt; java object</code></p><p><strong>More About Marshalling</strong></p><p>Marshalling 为客户端应用程序提供将<code>jaxb派生的Java对象</code>树转换为<code>XML</code>数据的能力。 即从 <code>java object -&gt; xml</code></p><p>默认情况下，<code>Marshalle</code>r在生成XML数据时使用<code>UTF-8</code>编码。</p><p>客户机应用程序不需要在编组之前验证Java内容树。也不要求Java内容树相对于其原始模式是有效的，以便将其编组为XML数据。</p><p><strong>More About Validation</strong></p><p>Validation 是验证XML文档是否满足模式中表示的所有约束的过程</p><p>JAXB 1.0在编组时提供验证，并在JAXB内容树上支持按需验证。JAXB 2.0只允许在解组和编组时进行验证。web服务处理模型在读取数据时是宽松的，而在写出数据时是严格的。为了满足该模型，在封送时间中添加了验证，以便用户可以确认在修改JAXB表单中的文档时没有使XML文档失效。</p></div><h2 id="表示-XML-内容">表示 XML 内容</h2><div class="story post-story"><p>本节描述 JAXB 如何将 XML 内容表示为 Java 对象。</p><p><strong>XML 模式的 Java 表示</strong></p><p>JAXB 支持在 Java 包中对生成的类进行分组。一个包包含以下内容：</p><ul><li>从 XML 元素名称派生或由绑定定制指定的 Java 类名称。</li><li>一个<code>ObjectFactory的</code>类，它是用来返回一个必然的Java类的实例的工厂。</li></ul><h3 id="绑定-XML-模式">绑定 XML 模式</h3><p>本节介绍 JAXB 使用的默认 XML-to-Java 绑定。所有这些绑定都可以通过使用自定义绑定声明来全局或逐个覆盖。有关默认 JAXB 绑定的完整信息，请参阅 <a href="http://jaxb.java.net/">JAXB 规范</a>。</p><p><strong>简单类型定义</strong></p><p>使用简单类型定义的模式组件通常绑定到 Java 属性。因为有不同种类的架构组件，以下 Java 属性属性（架构组件通用）包括：</p><ul><li>基础类型</li><li>集合类型，如果有</li><li>谓词</li></ul><p>其余的 Java 属性属性是使用<code>简单</code>类型定义在模式组件中指定的。</p><p><strong>默认数据类型绑定</strong></p><p>以下部分解释了默认的 schema-to-Java、 <code>JAXBElement</code>和 Java-to-schema 数据类型绑定。</p><h4 id="Schema-to-Java-Mapping">Schema-to-Java Mapping</h4><p>Java语言提供了比XML模式更丰富的数据类型集,下表提供了JAXB中XML数据类型到Java数据类型的映射。</p><table><thead><tr><th>XML Schema Type</th><th>Java Data Type</th></tr></thead><tbody><tr><td><code>xsd:string</code></td><td><code>java.lang.String</code></td></tr><tr><td><code>xsd:integer</code></td><td><code>java.math.BigInteger</code></td></tr><tr><td><code>xsd:int</code></td><td><code>int</code></td></tr><tr><td><code>xsd.long</code></td><td><code>long</code></td></tr><tr><td><code>xsd:short</code></td><td><code>short</code></td></tr><tr><td><code>xsd:decimal</code></td><td><code>java.math.BigDecimal</code></td></tr><tr><td><code>xsd:float</code></td><td><code>float</code></td></tr><tr><td><code>xsd:double</code></td><td><code>double</code></td></tr><tr><td><code>xsd:boolean</code></td><td><code>boolean</code></td></tr><tr><td><code>xsd:byte</code></td><td><code>byte</code></td></tr><tr><td><code>xsd:QName</code></td><td><code>javax.xml.namespace.QName</code></td></tr><tr><td><code>xsd:dateTime</code></td><td><code>javax.xml.datatype.XMLGregorianCalendar</code></td></tr><tr><td><code>xsd:base64Binary</code></td><td><code>byte[]</code></td></tr><tr><td><code>xsd:hexBinary</code></td><td><code>byte[]</code></td></tr><tr><td><code>xsd:unsignedInt</code></td><td><code>long</code></td></tr><tr><td><code>xsd:unsignedShort</code></td><td><code>int</code></td></tr><tr><td><code>xsd:unsignedByte</code></td><td><code>short</code></td></tr><tr><td><code>xsd:time</code></td><td><code>javax.xml.datatype.XMLGregorianCalendar</code></td></tr><tr><td><code>xsd:date</code></td><td><code>javax.xml.datatype.XMLGregorianCalendar</code></td></tr><tr><td><code>xsd:g</code></td><td><code>javax.xml.datatype.XMLGregorianCalendar</code></td></tr><tr><td><code>xsd:anySimpleType</code></td><td><code>java.lang.Object</code></td></tr><tr><td><code>xsd:anySimpleType</code></td><td><code>java.lang.String</code></td></tr><tr><td><code>xsd:duration</code></td><td><code>javax.xml.datatype.Duration</code></td></tr><tr><td><code>xsd:NOTATION</code></td><td><code>javax.xml.namespace.QName</code></td></tr></tbody></table><p>表:XML模式内置数据类型的JAXB映射</p><p><strong>JAXBElement对象</strong></p><p>当XML内容的派生Java表示不能推断XML元素信息时，将提供一个JAXBElement对象。该对象具有获取和设置对象名称和对象值的方法。</p><h4 id="Java-to-Schema-Mapping">Java-to-Schema Mapping</h4><p>下表显示了Java类到XML数据类型的默认映射。</p><table><thead><tr><th>Java Class</th><th>XML Data Type</th></tr></thead><tbody><tr><td><code>java.lang.String</code></td><td><code>xs:string</code></td></tr><tr><td><code>java.math.BigInteger</code></td><td><code>xs:integer</code></td></tr><tr><td><code>java.math.BigDecimal</code></td><td><code>xs:decimal</code></td></tr><tr><td><code>java.util.Calendar</code></td><td><code>xs:dateTime</code></td></tr><tr><td><code>java.util.Date</code></td><td><code>xs:dateTime</code></td></tr><tr><td><code>javax.xml.namespace.QName</code></td><td><code>xs:QName</code></td></tr><tr><td><code>java.net.URI</code></td><td><code>xs:string</code></td></tr><tr><td><code>javax.xml.datatype.XMLGregorianCalendar</code></td><td><code>xs:anySimpleType</code></td></tr><tr><td><code>javax.xml.datatype.Duration</code></td><td><code>xs:duration</code></td></tr><tr><td><code>java.lang.Object</code></td><td><code>xs:anyType</code></td></tr><tr><td><code>java.awt.Image</code></td><td><code>xs:base64Binary</code></td></tr><tr><td><code>javax.activation.DataHandler</code></td><td><code>xs:base64Binary</code></td></tr><tr><td><code>javax.xml.transform.Source</code></td><td><code>xs:base64Binary</code></td></tr><tr><td><code>java.util.UUID</code></td><td><code>xs:string</code></td></tr></tbody></table><p>表:XML数据类型到Java类的JAXB映射</p></div><h2 id="自定义生成的类和-Java-程序元素">自定义生成的类和 Java 程序元素</h2><div class="story post-story"><p>以下部分描述了如何定制生成的 JAXB 类和 Java 程序元素。</p><h3 id="Schema-to-Java">Schema-to-Java</h3><p>自定义JAXB绑定声明使您能够在XML模式中特定于XML的约束之外自定义生成的JAXB类，以包括特定于java的细化，例如类和包名映射。</p><p>JAXB 提供了两种自定义 XML 模式的方法：</p><ul><li>作为源 XML 模式中的内联注释</li><li>作为传递给 JAXB 绑定编译器的外部绑定定制文件中的声明</li></ul><p>本文档后面提供了展示如何定制 JAXB 绑定的代码示例。</p><h3 id="Java-to-Schema">Java-to-Schema</h3><p><code>javax.xml.bind.annotation</code> 包中定义的 JAXB 注释可用于自定义 Java 程序元素到 XML 模式的映射。下表总结了可用于 Java 包的 JAXB 注释。</p><p>表：与 Java 包关联的 JAXB 注释</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606214309.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606214309.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606214307713"></p><p>下表总结了可以与Java类一起使用的JAXB注释。</p><p>表：与 Java 类关联的 JAXB 注释</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606214733.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606214733.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606214731973"></p><p>下表总结了可用于 Java<code>枚举</code>类型的JAXB 注释。</p><p>表：与 Java<code>枚举</code> 类型关联的 JAXB 注释</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606214746.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606214746.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606214745020"></p><p>下表总结了可用于 Java 属性和字段的 JAXB 注释。</p><p>表：与 Java 属性和字段关联的 JAXB 注释</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606214930.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606214930.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606214802387"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606214948.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606214948.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606214947200"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606215004.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606215004.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606215002879"></p><p>下表总结了可用于对象工厂的 JAXB 注释。</p><p>表：与对象工厂关联的 JAXB 注释</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606215130.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606215130.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606215128719"></p><p>下表总结了可与适配器一起使用的 JAXB 注释。</p><p>表：与适配器关联的 JAXB 注释</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606215145.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606215145.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606215144297"></p></div><h2 id="JAXB-Examples">JAXB Examples</h2><div class="story post-story"><p>以下部分描述了如何使用 JAXB RI 包中包含的示例应用程序。JAXB RI 包可从 <a href="http://jaxb.java.net/">http://jaxb.java.net 获得</a>。下载并安装 JAXB RI 包。这些示例位于<em>jaxb-ri-install</em> <code>/samples/</code>目录中。这些示例演示并建立在关键的 JAXB 特性和概念之上。按照显示的顺序执行这些程序。</p><p>阅读完本节后，您应该对 JAXB 感到很舒服，您可以：</p><ul><li><p>从 XML 模式生成 JAXB Java 类</p></li><li><p>使用模式派生的 JAXB 类来解组和编组 Java 应用程序中的 XML 内容</p></li><li><p>使用派生架构的 JAXB 类创建 Java 内容树</p></li><li><p>在解组和运行时验证 XML 内容</p></li><li><p>自定义 JAXB 模式到 Java 的绑定</p></li></ul><p>本文档描述了三组示例：</p><ul><li>基本示例（Modify Marshal、Unmarshal Validate）演示了基本的 JAXB 概念，例如使用默认设置和绑定解组、编组和验证 XML 内容。</li><li>自定义示例（自定义内联、数据类型转换器、外部自定义）演示了自定义 XML 模式到 Java 对象的默认绑定的各种方法。</li><li>java-to-schema 示例展示了如何使用注释将 Java 类映射到 XML 模式。</li></ul><hr><p><strong>注意：</strong> 基本和自定义示例基于采购订单场景。每个都使用一个 XML 文档<code>po.xml</code>，它是针对 XML 模式<code>po.xsd 编写的</code>。这些文档来自 <a href="http://www.w3.org/TR/xmlschema-0/">W3C XML Schema Part 0: Primer</a>，由 David C. Fallside 编辑。</p><p>基本和自定义示例目录包含几个基本文件：</p><ul><li><code>po.xsd</code>是 XML 模式，用作 JAXB 绑定编译器的输入，将从模式派生的 JAXB Java 类生成。对于自定义内联和数据类型转换器示例，此文件包含内联绑定自定义。</li><li><code>po.xml</code>是包含示例 XML 内容的采购订单 XML 文件，它是每个示例中解组到 Java 内容树中的文件。该文件在每个示例中几乎相同；有细微的内容差异来突出不同的 JAXB 概念。</li><li><code>Main.java</code>是每个示例的主要 Java 类。</li><li><code>build.xml</code>是一个为您提供方便的 Ant 项目文件。使用 Ant 工具自动生成、编译和运行模式派生的 JAXB 类。该<code>的build.xml</code>文件跨越例子变化。</li><li><code>inline-customize</code>示例中的<code>MyDatatypeConverter.java</code>是一个 Java 类，用于提供自定义数据类型转换。</li><li>外部定制示例中的<code>binding.xjb</code>是一个外部绑定声明文件，它被传递到 JAXB 绑定编译器以定制默认的 JAXB 绑定。</li></ul><p>下表简要描述了基本的、定制的和 java-to-schema JAXB 示例。</p><table><thead><tr><th>Example Name</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/basic.html#bnbaz">Modify Marshal</a></td><td>演示如何修改Java内容树。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/basic.html#bnbbc">Unmarshal Validate</a></td><td>演示如何在解组期间启用验证</td></tr></tbody></table><p>表:定制JAXB示例</p><table><thead><tr><th>Example Name</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/custom.html#bnbbz">Customize Inline</a></td><td>演示如何通过在 XML 模式中使用内联注释来自定义默认 JAXB 绑定。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/custom.html#bnbci">Datatype Converter</a></td><td>说明 XML <code>simpleType</code>定义到 Java 数据类型的替代、更简洁的绑定，类似于自定义内联示例。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/custom.html#bnbcs">External Customize</a></td><td>说明如何使用外部绑定声明文件将只读模式的绑定自定义传递给 JAXB 绑定编译器。</td></tr></tbody></table><p>表:java到模式的JAXB示例</p><table><thead><tr><th>Example Name</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbcw">Create Marshal</a></td><td>演示如何使用 ObjectFactory 类创建 Java 内容树并将其编组为 XML 数据。它还演示了如何向 JAXB 列表属性添加内容。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbcz">XmlAccessorOrder</a></td><td>说明如何在 Java 类中使用<code>@XmlAccessorOrder</code>和<code>@XmlType.propOrder</code>映射注释来控制 Java 类型编组或解组 XML 内容的顺序。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbdf">XmlAdapter</a></td><td>说明如何使用接口<code>XmlAdapter</code>和注释<code>@XmlJavaTypeAdapter</code>提供 XML 内容进出<code>HashMap</code>（字段）的自定义映射，该字段使用整数 ( <code>int</code> ) 作为键，将字符串 ( <code>String</code> ) 作为值。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbdi">XmlAttribute</a></td><td>说明如何使用注解<code>@XmlAttribute</code>定义要作为 XML 属性处理的属性或字段。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbdl">XmlRootElement</a></td><td>说明如何使用注释<code>@XmlRootElement</code>为相应类的 XML 架构类型定义 XML 元素名称。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbdo">XmlSchemaType Class</a></td><td>说明如何使用注释<code>@XmlSchemaType</code>自定义属性或字段到 XML 内置类型的映射。</td></tr><tr><td><a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/j2schema.html#bnbdr">XmlType</a></td><td>说明如何使用注释<code>@XmlType</code>将类或<code>枚举</code>类型映射到 XML 架构类型。</td></tr></tbody></table><p>下表描述了基本示例的这些类及其与源XML模式的特定绑定。</p><h3 id="表-Schema-to-Java绑定">表:<code>Schema-to-Java</code>绑定</h3><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606223054.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606223054.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606223052736"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606223105.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606223105.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606223103331"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606223119.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606223119.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606223118424"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606223522.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606223522.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606223521428"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210606223530.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210606223530.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210606223529292"></p><h3 id="Schema-Derived-JAXB-Classes">Schema-Derived JAXB Classes</h3><p>下一节将简要解释JAXB绑定编译器为示例生成的以下各个类的功能:</p><ul><li>[<code>Items</code> Class](#Items` Class)</li><li>[<code>ObjectFactory</code> Class](#ObjectFactory` Class)</li><li>[<code>PurchaseOrderType</code> Class](# Class)</li><li>[<code>USAddress</code> Class](#USAddress` Class)</li></ul><h4 id="Items-Class"><code>Items</code> Class</h4><p>In <code>Items.java</code>:</p><ul><li>该<code>项目</code>类是部分 <code>primer.po</code>包。</li><li>该类为<code>Items</code> 和<code>ItemType</code>提供公共接口。</li><li>此类实例化中的内容绑定到 XML ComplexTypes <code>Items</code>及其子元素 <code>ItemType</code>。</li><li><code>Item</code>提供了<code>getItem()</code>方法。</li><li><code>ItemType</code>提供以下方法：<ul><li><code>getPartNum();</code></li><li><code>setPartNum(String value);</code></li><li><code>getComment();</code></li><li><code>setComment(java.lang.String value);</code></li><li><code>getUSPrice();</code></li><li><code>setUSPrice(java.math.BigDecimal value);</code></li><li><code>getProductName();</code></li><li><code>setProductName(String value);</code></li><li><code>getShipDate();</code></li><li><code>setShipDate(java.util.Calendar value);</code></li><li><code>getQuantity();</code></li><li><code>setQuantity(java.math.BigInteger value);</code></li></ul></li></ul><h4 id="ObjectFactory-Class"><code>ObjectFactory</code> Class</h4><p>In <code>ObjectFactory.java</code>:</p><ul><li>所述<code>的ObjectFactory</code>类是部分<code>primer.po</code>包。</li><li><code>ObjectFactory</code>提供了工厂方法，用于在 Java 内容树中实例化表示 XML 内容的 Java 接口。</li><li>方法名称是通过连接生成的：<ul><li>字符串常量<code>create</code>。</li><li>所有外部 Java 类名称，如果 Java 内容接口嵌套在另一个接口中。</li><li>Java 内容接口的名称。</li></ul></li></ul><p>例如，在这种情况下，对于 Java 接口<code>prime.po.Items.ItemType</code>，<code>ObjectFactory</code>创建方法<code>createItemsItemType()</code>。</p><h4 id="PurchaseOrderType-Class"><code>PurchaseOrderType</code> Class</h4><p>In <code>PurchaseOrderType.java</code>:</p><ul><li>所述<code>PurchaseOrderType</code>类是部分<code>primer.po</code>包。</li><li>此类实例化中的内容绑定到名为<code>PurchaseOrderType</code>的 XML 架构子元素。</li><li><code>PurchaseOrderType</code>是一个公共接口，提供以下方法：<ul><li><code>getItems();</code></li><li><code>setItems(primer.po.Items value);</code></li><li><code>getOrderDate();</code></li><li><code>setOrderDate(java.util.Calendar value);</code></li><li><code>getComment();</code></li><li><code>setComment(java.lang.String value);</code></li><li><code>getBillTo();</code></li><li><code>setBillTo(primer.po.USAddress value);</code></li><li><code>getShipTo();</code></li><li><code>setShipTo(primer.po.USAddress value);</code></li></ul></li></ul><h4 id="USAddress-Class"><code>USAddress</code> Class</h4><p>In <code>USAddress.java</code>:</p><ul><li>的<code>校舍地址</code>类是部分 <code>primer.po</code>包。</li><li>此类实例化中的内容绑定到名为<code>USAddress</code>的 XML 模式元素。</li><li><code>USAddress</code>是一个公共接口，提供以下方法：<ul><li><code>getState();</code></li><li><code>setState(String value);</code></li><li><code>getZip();</code></li><li><code>setZip(java.math.BigDecimal value);</code></li><li><code>getCountry();</code></li><li><code>setCountry(String value);</code></li><li><code>getCity();</code></li><li><code>setCity(String value);</code></li><li><code>getStreet();</code></li><li><code>setStreet(String value);</code></li><li><code>getName();</code></li><li><code>setName(String value);</code></li></ul></li></ul></div><h2 id="基本示例">基本示例</h2><div class="story post-story"><p>本节介绍了基本 JAXB 示例（Modify Marshal、Unmarshal Validate），这些示例演示了如何：</p><ul><li>将 XML 文档解组为 Java 内容树并访问其中包含的数据</li><li>修改 Java 内容树</li><li>使用<code>ObjectFactory</code>类创建 Java 内容树，然后将其编组为 XML 数据</li><li>在解组期间执行验证</li><li>在运行时验证 Java 内容树</li></ul><h3 id="Modify-Marshal-Example">Modify Marshal Example</h3><p>Modify Marshal示例演示了如何修改Java内容树。</p><ol><li><p>该<em>JAXB里安装</em><code>/samples/modify-marshal/src/Main.java</code>类声明导入三种标准的Java类，五JAXB绑定框架类和的<code>primer.po</code>包：</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>math<span class="token punctuation">.</span></span><span class="token class-name">BigDecimal</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">JAXBContext</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">JAXBElement</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">JAXBException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">Marshaller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">Unmarshaller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">primer<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></code></pre></li><li><p>创建了一个<code>JAXBContext</code>实例来处理在<code>prime.po</code> 中生成的类</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">JAXBContext</span> jc <span class="token operator">=</span> <span class="token class-name">JAXBContext</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span> <span class="token string">"primer.po"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>创建了一个<code>Unmarshaller</code>实例，并<code>解组</code>了<code>po.xml</code>文件。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Unmarshaller</span> u <span class="token operator">=</span> jc<span class="token punctuation">.</span><span class="token function">createUnmarshaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PurchaseOrder</span> po <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PurchaseOrder</span><span class="token punctuation">)</span>    u<span class="token punctuation">.</span><span class="token function">unmarshal</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"po.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p><code>set</code>方法用于修改内容树的<code>地址</code>分支中的信息。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">USAddress</span> address <span class="token operator">=</span> po<span class="token punctuation">.</span><span class="token function">getBillTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"John Bob"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setStreet</span><span class="token punctuation">(</span><span class="token string">"242 Main Street"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setCity</span><span class="token punctuation">(</span><span class="token string">"Beverly Hills"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"CA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setZip</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span>address<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"John Bob"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setStreet</span><span class="token punctuation">(</span><span class="token string">"242 Main Street"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setCity</span><span class="token punctuation">(</span><span class="token string">"Beverly Hills"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">"CA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>address<span class="token punctuation">.</span><span class="token function">setZip</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"90210"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>创建了一个<code>Marshaller</code>实例，并将更新的 XML 内容编组到<code>system.out</code>。所述<code>的setProperty</code> API用于指定输出编码; 在这种情况下，它是格式化的（人类可读的）XML。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Marshaller</span> m <span class="token operator">=</span> jc<span class="token punctuation">.</span><span class="token function">createMarshaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>m<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Marshaller</span><span class="token punctuation">.</span>JAXB_FORMATTED_OUTPUT<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>m<span class="token punctuation">.</span><span class="token function">marshal</span><span class="token punctuation">(</span>po<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li></ol><h3 id="Building-and-Running-the-Modify-Marshal-Example-Using-Ant">Building and Running the Modify Marshal Example Using Ant</h3><p>要使用 Ant 编译和运行 Modify Marshal 示例，请在终端窗口中，转到<em>jaxb-ri-install</em> <code>/samples/modify-marshal/</code>目录并键入以下内容：</p><pre class="language-java" data-language="java"><code class="language-java">ant</code></pre><h3 id="Unmarshal-Validate-Example">Unmarshal Validate Example</h3><p>Unmarshal Validate 示例演示了如何在解组期间启用验证。请注意，JAXB 在解组期间提供验证功能，但在编组期间不提供。验证在<a href="https://docs.oracle.com/javase/tutorial/jaxb/intro/arch.html#bnazn">更多关于验证</a>中进行了更详细的解释 。</p><ol><li><p>该<em>JAXB里安装</em><code>/samples/unmarshal-validate/src/Main.java</code>类声明为一个标准的Java类，十JAXB绑定框架类和进口<code>primer.po</code>包：</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">JAXBContext</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">JAXBException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">Marshaller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">UnmarshalException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">Unmarshaller</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">ValidationEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">ValidationEventHandler</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>bind<span class="token punctuation">.</span></span><span class="token class-name">ValidationEventLocator</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span><span class="token class-name">XMLConstants</span><span class="token punctuation">.</span>W3C_XML_SCHEMA_NS_URI<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>validation<span class="token punctuation">.</span></span><span class="token class-name">SchemaFactory</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>validation<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">primer<span class="token punctuation">.</span>po<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></code></pre></li><li><p>创建了一个<code>JAXBContext</code>实例来处理在<code>prime.po</code>包中生成的类。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">JAXBContext</span> jc <span class="token operator">=</span> <span class="token class-name">JAXBContext</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"primer.po"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>一个<code>Unmarshaller</code>的实例被创建。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Unmarshaller</span> u <span class="token operator">=</span> jc<span class="token punctuation">.</span><span class="token function">createUnmarshaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>默认的 JAXB <code>Unmarshaller ``ValidationEventHandler</code>已启用以向<code>system.out</code>发送验证警告和错误。默认配置会导致解组操作在遇到第一个验证错误时失败。</p><pre class="language-java" data-language="java"><code class="language-java">u<span class="token punctuation">.</span><span class="token function">setValidating</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>尝试将<code>po.xml</code>文件解组为 Java 内容树。出于本示例的目的，<code>po.xml</code>文件包含故意错误</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">PurchaseOrder</span> po <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PurchaseOrder</span><span class="token punctuation">)</span>u<span class="token punctuation">.</span><span class="token function">unmarshal</span><span class="token punctuation">(</span>    <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"po.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>默认验证事件处理程序处理验证错误，生成输出到<code>system.out</code>，然后抛出异常.</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token class-name">UnmarshalException</span> ue <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Caught UnmarshalException"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token class-name">JAXBException</span> je <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     je<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token class-name">IOException</span> ioe <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ioe<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre></li></ol><h3 id="Building-and-Running-the-Unmarshal-Validate-Example-Using-Ant">Building and Running the Unmarshal Validate Example Using Ant</h3><p>要使用 Ant 编译和运行 Unmarshal Validate 示例，请在终端窗口中，转到<em>jaxb-ri-install</em> <code>/samples/unmarshal-validate/</code>目录并键入以下内容：</p><pre class="language-none"><code class="language-none">ant </code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
          <category> JAXB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 笔记 </tag>
            
            <tag> Xml </tag>
            
            <tag> JAXB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA 配置Docker 本地环境开发Java</title>
      <link href="/posts/8904d55a/"/>
      <url>/posts/8904d55a/</url>
      
        <content type="html"><![CDATA[<h1>IDEA 配置docker 本地环境开发java</h1><blockquote><p>😄 @by sizaif</p><p>📆 2021-05-17  22:52:02</p></blockquote><p>[TOC]</p><h2 id="说明">说明</h2><div class="story post-story"><p>初步的思路是:  在windows平台下 使用<code>idea</code>调试代码, 通过 docker 配置运行linux环境, 连接到docker 容器中, 在docker容器中运行代码</p></div><h2 id="安装docker插件">安装docker插件</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210517230344.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210517230344.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210517230343009"></p></div><h2 id="docker-winwdos-开启tcp远程连接">docker-winwdos 开启tcp远程连接</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210517230657.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210517230657.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210517230655846"></p></div><h2 id="idea中配置docker环境">idea中配置docker环境</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210517230527.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210517230527.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210517230526322"></p></div><h2 id="idea配置运行环境">idea配置运行环境</h2><div class="story post-story"><p>未完待续</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Docker </tag>
            
            <tag> IDEA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git 多人协作 &amp; 贡献</title>
      <link href="/posts/8ea2fec1/"/>
      <url>/posts/8ea2fec1/</url>
      
        <content type="html"><![CDATA[<h1>git 多人协作 &amp; 贡献</h1><blockquote><p>😄 @Auther by sizaif</p><p>📆 2021-06-24  17:03:01</p></blockquote><p>[TOC]</p><h2 id="修订历史">修订历史</h2><div class="story post-story"><ul><li>2021-06-24  17:04:08: 首次编辑</li><li>2021-06-25  10:23:09: 添加pull request图片</li></ul></div><h2 id="整体流程">整体流程</h2><div class="story post-story"><p>首先fork别人的项目到在自己的github仓库中,然后拉取项目到本地开发,开发完成后做<strong>Pull Request</strong></p><p><strong>别人项目(主仓)</strong>: <strong>upstream/master</strong></p><p><strong>自己远程仓库:</strong> <strong>origin/master</strong></p><p><strong>本地仓库</strong>: <strong>local/master</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210624172846.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210624172846.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210624172845436"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210624175036.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210624175036.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210624175034857"></p></div><h2 id="保持你的仓库和原作者的仓库一致">保持你的仓库和原作者的仓库一致</h2><div class="story post-story"><p>一是在github项目中点击:</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210624173021.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210624173021.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210624173020096"></p><p>二是通过git命令实现</p><details ><summary> child:codeblock open:false color:green </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#查看本地远程仓库信息</span>$ <span class="token function">git</span> remote -v<span class="token comment">#添加主仓到本地仓,并命为upstream,( 这个仓库保持最新与原作者的master一致)</span>$ <span class="token function">git</span> remote <span class="token function">add</span> upstream 原作者的项目.git<span class="token comment">#再次查看本地远程仓库信息,此时 upstream 显示为原作者的项目地址</span>$ <span class="token function">git</span> remote-v <span class="token comment">#将主仓fetch到本地和本地master合并</span>$ <span class="token function">git</span> pull upstream master<span class="token comment"># 将本地master push到 你的远程仓库实现最新</span>$ <span class="token function">git</span> push</code></pre>              </div>            </details></div><h2 id="Pull-Request">Pull Request</h2><div class="story post-story"><p>当本地开发完,想pull 给作者贡献时, 用到<strong>pull request</strong></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210624174805.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210624174805.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210624174804380"></p><p>在接下来的界面中,添加一下你的主要工作内容,让原作者可以清晰的理解你的新get点,</p><p>提交后等待即可.</p><p>也可以直接在<em>jetbrains家 idea,pycharm</em>等软件里直接提交</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210625102301.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210625102301.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerfile构建docker时apt-Get Install遇到交互式处理方法</title>
      <link href="/posts/37be8a52/"/>
      <url>/posts/37be8a52/</url>
      
        <content type="html"><![CDATA[<h1>Dockerfile构建docker时apt-get install遇到交互式处理方法</h1><blockquote><p>😄 @auther by sizaif</p><p>📆2021-07-01  02:20:43</p></blockquote><p>[TOC]</p><h2 id="编辑历史">编辑历史</h2><div class="story post-story"><ul><li>2021-07-01  02:21:01: 第一次编辑</li></ul></div><h2 id="问题说明">问题说明</h2><div class="story post-story"><p>当使用Dockerfile构建docker时,执行命令<code>apt-get install -y build-essential </code> 时,会安装tzdata,</p><p>但从tzdata 2018版本开始（如2018d），安装过程中默认采用交互式，即要求输入指定的<strong>Geographic area</strong>和<strong>Time zone</strong>，从而必须人工值守进行安装，输出信息如下。</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210701022542.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210701022542.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210701022541213"></p><p>而Dockerfile构建过程中,无法进行交互.</p></div><h2 id="解决方法">解决方法</h2><div class="story post-story"><p>在 <code>apt-get install -y </code> 命令前 添加  <font color='orange'>DEBIAN_FRONTEND=noninteractive</font></p><p>即:</p><pre class="language-bash" data-language="bash"><code class="language-bash">RUN <span class="token assign-left variable">DEBIAN_FRONTEND</span><span class="token operator">=</span>noninteractive <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token operator">&lt;</span>software name<span class="token operator">></span></code></pre><p><font color='red'>注:</font></p><p><font color='red'><code>DEBIAN_FRONTEND=noninteractive</code> 同样适用于shell 脚本</font></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习笔记 </tag>
            
            <tag> 技术向 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerfile Tutorial</title>
      <link href="/posts/f8a23a09/"/>
      <url>/posts/f8a23a09/</url>
      
        <content type="html"><![CDATA[<h1>Dockerfile Tutorial</h1><blockquote><p>😄 @Auther: sizaif</p><p>📆2021-06-08  15:30:38</p></blockquote><p>[TOC]</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210608161945.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210608161945.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210608161944400"></p><p>Dockerfile 是一个文本文件，其内包含了一条条的 <strong>指令(Instruction)</strong>，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。</p><p>还以之前定制 <code>nginx</code> 镜像为例，这次我们使用 Dockerfile 来定制。</p><p>在一个空白目录中，建立一个文本文件，并命名为 <code>Dockerfile</code>：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">mkdir</span> mynginx$ <span class="token builtin class-name">cd</span> mynginx$ <span class="token function">touch</span> Dockerfile</code></pre><p>其内容为：</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM nginxRUN <span class="token builtin class-name">echo</span> <span class="token string">'&lt;h1>Hello, Docker!&lt;/h1>'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html</code></pre><p>这个 Dockerfile 很简单，一共就两行。涉及到了两条指令，<code>FROM</code> 和 <code>RUN</code>。</p><h2 id="FROM">FROM</h2><div class="story post-story"><p><code>FROM</code> 就是指定 <strong>基础镜像</strong>，因此一个 <code>Dockerfile</code> 中 <code>FROM</code> 是必备的指令，并且必须是第一条指令。</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM XXX<span class="token punctuation">..</span>.</code></pre><p>在 <a href="https://hub.docker.com/search?q=&amp;type=image&amp;image_filter=official">Docker Hub</a> 上有非常多的高质量的官方镜像，有可以直接拿来使用的服务类的镜像，如 <a href="https://hub.docker.com/_/nginx/"><code>nginx</code></a>、<a href="https://hub.docker.com/_/redis/"><code>redis</code></a>、<a href="https://hub.docker.com/_/mongo/"><code>mongo</code></a>、<a href="https://hub.docker.com/_/mysql/"><code>mysql</code></a>、<a href="https://hub.docker.com/_/httpd/"><code>httpd</code></a>、<a href="https://hub.docker.com/_/php/"><code>php</code></a>、<a href="https://hub.docker.com/_/tomcat/"><code>tomcat</code></a> 等；也有一些方便开发、构建、运行各种语言应用的镜像，如 <a href="https://hub.docker.com/_/node"><code>node</code></a>、<a href="https://hub.docker.com/_/openjdk/"><code>openjdk</code></a>、<a href="https://hub.docker.com/_/python/"><code>python</code></a>、<a href="https://hub.docker.com/_/ruby/"><code>ruby</code></a>、<a href="https://hub.docker.com/_/golang/"><code>golang</code></a> 等。可以在其中寻找一个最符合我们最终目标的镜像为基础镜像进行定制。</p><p>如果没有找到对应服务的镜像，官方镜像中还提供了一些更为基础的操作系统镜像，如 <a href="https://hub.docker.com/_/ubuntu/"><code>ubuntu</code></a>、<a href="https://hub.docker.com/_/debian/"><code>debian</code></a>、<a href="https://hub.docker.com/_/centos/"><code>centos</code></a>、<a href="https://hub.docker.com/_/fedora/"><code>fedora</code></a>、<a href="https://hub.docker.com/_/alpine/"><code>alpine</code></a> 等，这些操作系统的软件库为我们提供了更广阔的扩展空间。</p></div><h2 id="RUN-执行命令">RUN 执行命令</h2><div class="story post-story"><p><code>RUN</code> 指令是用来执行命令行命令的。由于命令行的强大能力，<code>RUN</code> 指令在定制镜像时是最常用的指令之一。其格式有两种：</p><ul><li><em>shell</em> 格式：<code>RUN &lt;命令&gt;</code>，就像直接在命令行中输入的命令一样。刚才写的 Dockerfile 中的 <code>RUN</code> 指令就是这种格式。</li></ul><pre class="language-none"><code class="language-none">RUN echo &#39;&lt;h1&gt;Hello, Docker!&lt;&#x2F;h1&gt;&#39; &gt; &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</code></pre><ul><li><em>exec</em> 格式：<code>RUN [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;]</code>，这更像是函数调用中的格式。</li></ul><p>既然 <code>RUN</code> 就像 Shell 脚本一样可以执行命令，那么我们是否就可以像 Shell 脚本一样把每个命令对应一个 RUN 呢？比如这样：</p><pre class="language-bash" data-language="bash"><code class="language-bash">FROM debian:stretchRUN <span class="token function">apt-get</span> updateRUN <span class="token function">apt-get</span> <span class="token function">install</span> -y gcc libc6-dev <span class="token function">make</span> <span class="token function">wget</span>RUN <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span>RUN <span class="token function">mkdir</span> -p /usr/src/redisRUN <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span>RUN <span class="token function">make</span> -C /usr/src/redisRUN <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span></code></pre><p>之前说过，Dockerfile 中每一个指令都会建立一层，<code>RUN</code> 也不例外。每一个 <code>RUN</code> 的行为，就和刚才我们手工建立镜像的过程一样：新建立一层，在其上执行这些命令，执行结束后，<code>commit</code> 这一层的修改，构成新的镜像。</p><p><strong>而上面的这种写法，创建了 7 层镜像。这是完全没有意义的，而且很多运行时不需要的东西，都被装进了镜像里，比如编译环境、更新的软件包等等。结果就是产生非常臃肿、非常多层的镜像，不仅仅增加了构建部署的时间，也很容易出错。 这是很多初学 Docker 的人常犯的一个错误。</strong></p><p><em>Union FS 是有最大层数限制的，比如 AUFS，曾经是最大不得超过 42 层，现在是不得超过 127 层。</em></p><p>上面的 <code>Dockerfile</code> 正确的写法应该是这样：</p><details green><summary> Dickerfile </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash">FROM debian:stretchRUN <span class="token builtin class-name">set</span> -x<span class="token punctuation">;</span> <span class="token assign-left variable">buildDeps</span><span class="token operator">=</span><span class="token string">'gcc libc6-dev make wget'</span> <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> update <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y <span class="token variable">$buildDeps</span> <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> -O redis.tar.gz <span class="token string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span> <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span> -p /usr/src/redis <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> -xzf redis.tar.gz -C /usr/src/redis --strip-components<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> -C /usr/src/redis <span class="token function">install</span> <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -rf /var/lib/apt/lists/* <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> redis.tar.gz <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -r /usr/src/redis <span class="token punctuation">\</span>    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> purge -y --auto-remove <span class="token variable">$buildDeps</span></code></pre>              </div>            </details><p>首先，之前所有的命令只有一个目的，就是编译、安装 redis 可执行文件。因此没有必要建立很多层，这只是一层的事情。因此，这里没有使用很多个 <code>RUN</code> 一一对应不同的命令，而是仅仅使用一个 <code>RUN</code> 指令，并使用 <code>&amp;&amp;</code> 将各个所需命令串联起来。<strong>将之前的 7 层，简化为了 1 层。在撰写 Dockerfile 的时候，要经常提醒自己，这并不是在写 Shell 脚本，而是在定义每一层该如何构建。</strong></p><p>并且，这里为了格式化还进行了换行。<strong>Dockerfile 支持 Shell 类的行尾添加 <code>\</code> 的命令换行方式，以及行首 <code>#</code> 进行注释的格式。良好的格式，比如换行、缩进、注释等，会让维护、排障更为容易，这是一个比较好的习惯。</strong></p><p>此外，还可以看到这一组命令的最后添加了清理工作的命令，删除了为了编译构建所需要的软件，清理了所有下载、展开的文件，并且还清理了 <code>apt</code> 缓存文件。这是很重要的一步，我们之前说过，镜像是多层存储，每一层的东西并不会在下一层被删除，会一直跟随着镜像。因此镜像构建时，一定要确保每一层只添加真正需要添加的东西，任何无关的东西都应该清理掉。</p><p>很多人初学 Docker 制作出了很臃肿的镜像的原因之一，就是忘记了每一层构建的最后一定要清理掉无关文件。</p></div><h2 id="构建镜像">构建镜像</h2><div class="story post-story"><p>好了，让我们再回到之前定制的 nginx 镜像的 Dockerfile 来。现在我们明白了这个 Dockerfile 的内容，那么让我们来构建这个镜像吧。</p><p>在 <code>Dockerfile</code> 文件所在目录执行：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker build -t nginx:v3 <span class="token builtin class-name">.</span>Sending build context to Docker daemon <span class="token number">2.048</span> kBStep <span class="token number">1</span> <span class="token builtin class-name">:</span> FROM nginx ---<span class="token operator">></span> e43d811ce2f4Step <span class="token number">2</span> <span class="token builtin class-name">:</span> RUN <span class="token builtin class-name">echo</span> <span class="token string">'&lt;h1>Hello, Docker!&lt;/h1>'</span> <span class="token operator">></span> /usr/share/nginx/html/index.html ---<span class="token operator">></span> Running <span class="token keyword">in</span> 9cdc27646c7b ---<span class="token operator">></span> 44aa4490ce2cRemoving intermediate container 9cdc27646c7bSuccessfully built 44aa4490ce2c</code></pre><p>从命令的输出结果中，我们可以清晰的看到镜像的构建过程。在 <code>Step 2</code> 中，如同我们之前所说的那样，<code>RUN</code> 指令启动了一个容器 <code>9cdc27646c7b</code>，执行了所要求的命令，并最后提交了这一层 <code>44aa4490ce2c</code>，随后删除了所用到的这个容器 <code>9cdc27646c7b</code>。</p><p>这里我们使用了 <code>docker build</code> 命令进行镜像构建。其格式为：</p><pre class="language-bash" data-language="bash"><code class="language-bash">docker build <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>上下文路径/URL/-<span class="token operator">></span></code></pre><p>在这里我们指定了最终镜像的名称 <code>-t nginx:v3</code>，构建成功后，我们可以像之前运行 <code>nginx:v2</code> 那样来运行这个镜像，其结果会和 <code>nginx:v2</code> 一样。</p></div><h2 id="镜像构建上下文（Context）">镜像构建上下文（Context）</h2><div class="story post-story"><p>如果注意，会看到 <code>docker build</code> 命令最后有一个 <code>.</code>。<code>.</code> 表示当前目录，而 <code>Dockerfile</code> 就在当前目录，因此不少初学者以为这个路径是在指定 <code>Dockerfile</code> 所在路径，这么理解其实是不准确的。如果对应上面的命令格式，你可能会发现，这是在指定 <strong>上下文路径</strong>。那么什么是上下文呢？</p><p>首先我们要理解 <code>docker build</code> 的工作原理。Docker 在运行时分为 Docker 引擎（也就是服务端守护进程）和客户端工具。Docker 的引擎提供了一组 REST API，被称为 <a href="https://docs.docker.com/develop/sdk/">Docker Remote API</a>，而如 <code>docker</code> 命令这样的客户端工具，则是通过这组 API 与 Docker 引擎交互，从而完成各种功能。因此，虽然表面上我们好像是在本机执行各种 <code>docker</code> 功能，但实际上，一切都是使用的远程调用形式在服务端（Docker 引擎）完成。也因为这种 C/S 设计，让我们操作远程服务器的 Docker 引擎变得轻而易举。</p><p>当我们进行镜像构建的时候，并非所有定制都会通过 <code>RUN</code> 指令完成，经常会需要将一些本地文件复制进镜像，比如通过 <code>COPY</code> 指令、<code>ADD</code> 指令等。而 <code>docker build</code> 命令构建镜像，其实并非在本地构建，而是在服务端，也就是 Docker 引擎中构建的。那么在这种客户端/服务端的架构中，如何才能让服务端获得本地文件呢？</p><p>这就引入了上下文的概念。当构建的时候，用户会指定构建镜像上下文的路径，<code>docker build</code> 命令得知这个路径后，会将路径下的所有内容打包，然后上传给 Docker 引擎。这样 Docker 引擎收到这个上下文包后，展开就会获得构建镜像所需的一切文件。</p><p>如果在 <code>Dockerfile</code> 中这么写：</p><pre class="language-bash" data-language="bash"><code class="language-bash">COPY ./package.json /app/</code></pre><p>这并不是要复制执行 <code>docker build</code> 命令所在的目录下的 <code>package.json</code>，也不是复制 <code>Dockerfile</code> 所在目录下的 <code>package.json</code>，而是复制 <strong>上下文（context）</strong> 目录下的 <code>package.json</code>。</p><p>因此，<code>COPY</code> 这类指令中的源文件的路径都是**<em>相对路径</em>。**这也是初学者经常会问的为什么 <code>COPY ../package.json /app</code> 或者 <code>COPY /opt/xxxx /app</code> 无法工作的原因，因为这些路径已经超出了上下文的范围，Docker 引擎无法获得这些位置的文件。如果真的需要那些文件，应该将它们复制到上下文目录中去。</p><p>现在就可以理解刚才的命令 <code>docker build -t nginx:v3 .</code> 中的这个 <code>.</code>，实际上是在指定上下文的目录，<code>docker build</code> 命令会将该目录下的内容打包交给 Docker 引擎以帮助构建镜像。</p><p>如果观察 <code>docker build</code> 输出，我们其实已经看到了这个发送上下文的过程：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker build -t nginx:v3 .Sending build context to Docker daemon <span class="token number">2.048</span> kB<span class="token punctuation">..</span>.</code></pre><p>理解构建上下文对于镜像构建是很重要的，避免犯一些不应该的错误。比如有些初学者在发现 <code>COPY /opt/xxxx /app</code> 不工作后，于是干脆将 <code>Dockerfile</code> 放到了硬盘根目录去构建，结果发现 <code>docker build</code> 执行后，在发送一个几十 GB 的东西，极为缓慢而且很容易构建失败。那是因为这种做法是在让 <code>docker build</code> 打包整个硬盘，这显然是使用错误。</p><p>一般来说，应该会将 <code>Dockerfile</code> 置于一个空目录下，或者项目根目录下。如果该目录下没有所需文件，那么应该把所需文件复制一份过来。如果目录下有些东西确实不希望构建时传给 Docker 引擎，那么可以用 <code>.gitignore</code> 一样的语法写一个 <code>.dockerignore</code>，该文件是用于剔除不需要作为上下文传递给 Docker 引擎的。</p><p>那么为什么会有人误以为 <code>.</code> 是指定 <code>Dockerfile</code> 所在目录呢？这是因为在默认情况下，如果不额外指定 <code>Dockerfile</code> 的话，会将上下文目录下的名为 <code>Dockerfile</code> 的文件作为 Dockerfile。</p><p>这只是默认行为，实际上 <code>Dockerfile</code> 的文件名并不要求必须为 <code>Dockerfile</code>，而且并不要求必须位于上下文目录中，比如可以用 <code>-f ../Dockerfile.php</code> 参数指定某个文件作为 <code>Dockerfile</code>。</p><p>当然，一般大家习惯性的会使用默认的文件名 <code>Dockerfile</code>，以及会将其置于镜像构建上下文目录中。</p></div><h2 id="COPY-复制文件">COPY 复制文件</h2><div class="story post-story"><p>格式：</p><ul><li><code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径&gt;... &lt;目标路径&gt;</code></li><li><code>COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,... &quot;&lt;目标路径&gt;&quot;]</code></li></ul><p>和 <code>RUN</code> 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p><p><code>COPY</code> 指令将从构建上下文目录中 <code>&lt;源路径&gt;</code> 的文件/目录复制到新的一层的镜像内的 <code>&lt;目标路径&gt;</code> 位置。比如：</p><pre class="language-bash" data-language="bash"><code class="language-bash">COPY package.json /usr/src/app/</code></pre><p><code>&lt;源路径&gt;</code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 <a href="https://golang.org/pkg/path/filepath/#Match"><code>filepath.Match</code></a> 规则，如：</p><pre class="language-bash" data-language="bash"><code class="language-bash">COPY hom* /mydir/COPY hom?.txt /mydir/</code></pre><p><code>&lt;目标路径&gt;</code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 <code>WORKDIR</code> 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p><p>此外，还需要注意一点，使用 <code>COPY</code> 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p><p>在使用该指令的时候还可以加上 <code>--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p><pre class="language-bash" data-language="bash"><code class="language-bash">COPY --chown<span class="token operator">=</span><span class="token number">55</span>:mygroup files* /mydir/COPY --chown<span class="token operator">=</span>bin files* /mydir/COPY --chown<span class="token operator">=</span><span class="token number">1</span> files* /mydir/COPY --chown<span class="token operator">=</span><span class="token number">10</span>:11 files* /mydir/</code></pre><p><strong>如果源路径为文件夹，复制的时候不是直接复制该文件夹，而是将文件夹中的内容复制到目标路径。</strong></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习笔记 </tag>
            
            <tag> 技术向 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker Tutorial</title>
      <link href="/posts/ac15f71a/"/>
      <url>/posts/ac15f71a/</url>
      
        <content type="html"><![CDATA[<h1>Docker Tutorial</h1><blockquote><p>😄 @Auther: sizaif</p><p>📆 2021-06-08  15:38:53</p></blockquote><p>[TOC]</p><h2 id="docker-docs">docker docs</h2><div class="story post-story"><p><a href="https://docs.docker.com/get-docker/">https://docs.docker.com/get-docker/</a></p></div><h2 id="Install-Docker-Desktop-for-Windows">Install Docker Desktop for Windows</h2><div class="story post-story"><p><a href="https://docs.docker.com/docker-for-windows/install/">https://docs.docker.com/docker-for-windows/install/</a></p></div><h2 id="overview">overview</h2><div class="story post-story"><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210608153924.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210608153924.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210608153922856"></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210608154100.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210608154100.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210608154058225"></p></div><h2 id="Commands">Commands</h2><div class="story post-story"><p><a href="https://docs.docker.com/engine/reference/commandline/cli/">https://docs.docker.com/engine/reference/commandline/cli/</a></p></div><h2 id="Build">Build</h2><div class="story post-story"><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker build <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token environment constant">PATH</span> <span class="token operator">|</span> URL <span class="token operator">|</span> -</code></pre></div><h2 id="Run">Run</h2><div class="story post-story"><p><strong>Usage</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker run <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span></code></pre></div><h2 id="Options">Options</h2><div class="story post-story"><details blue><summary> options </summary>              <div class='content'>              <table><thead><tr><th>Name, shorthand</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>--add-host</code></td><td></td><td>Add a custom host-to-IP mapping (host:ip)</td></tr><tr><td><code>--attach</code> , <code>-a</code></td><td></td><td>Attach to STDIN, STDOUT or STDERR</td></tr><tr><td><code>--blkio-weight</code></td><td></td><td>Block IO (relative weight), between 10 and 1000, or 0 to disable (default 0)</td></tr><tr><td><code>--blkio-weight-device</code></td><td></td><td>Block IO weight (relative device weight)</td></tr><tr><td><code>--cap-add</code></td><td></td><td>Add Linux capabilities</td></tr><tr><td><code>--cap-drop</code></td><td></td><td>Drop Linux capabilities</td></tr><tr><td><code>--cgroup-parent</code></td><td></td><td>Optional parent cgroup for the container</td></tr><tr><td><code>--cgroupns</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.41/"><strong>API 1.41+</strong></a> Cgroup namespace to use (host|private) ‘host’: Run the container in the Docker host’s cgroup namespace ‘private’: Run the container in its own private cgroup namespace ‘’: Use the cgroup namespace as configured by the default-cgroupns-mode option on the daemon (default)</td></tr><tr><td><code>--cidfile</code></td><td></td><td>Write the container ID to the file</td></tr><tr><td><code>--cpu-count</code></td><td></td><td>CPU count (Windows only)</td></tr><tr><td><code>--cpu-percent</code></td><td></td><td>CPU percent (Windows only)</td></tr><tr><td><code>--cpu-period</code></td><td></td><td>Limit CPU CFS (Completely Fair Scheduler) period</td></tr><tr><td><code>--cpu-quota</code></td><td></td><td>Limit CPU CFS (Completely Fair Scheduler) quota</td></tr><tr><td><code>--cpu-rt-period</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.25/"><strong>API 1.25+</strong></a> Limit CPU real-time period in microseconds</td></tr><tr><td><code>--cpu-rt-runtime</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.25/"><strong>API 1.25+</strong></a> Limit CPU real-time runtime in microseconds</td></tr><tr><td><code>--cpu-shares</code> , <code>-c</code></td><td></td><td>CPU shares (relative weight)</td></tr><tr><td><code>--cpus</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.25/"><strong>API 1.25+</strong></a> Number of CPUs</td></tr><tr><td><code>--cpuset-cpus</code></td><td></td><td>CPUs in which to allow execution (0-3, 0,1)</td></tr><tr><td><code>--cpuset-mems</code></td><td></td><td>MEMs in which to allow execution (0-3, 0,1)</td></tr><tr><td><code>--detach</code> , <code>-d</code></td><td></td><td>Run container in background and print container ID</td></tr><tr><td><code>--detach-keys</code></td><td></td><td>Override the key sequence for detaching a container</td></tr><tr><td><code>--device</code></td><td></td><td>Add a host device to the container</td></tr><tr><td><code>--device-cgroup-rule</code></td><td></td><td>Add a rule to the cgroup allowed devices list</td></tr><tr><td><code>--device-read-bps</code></td><td></td><td>Limit read rate (bytes per second) from a device</td></tr><tr><td><code>--device-read-iops</code></td><td></td><td>Limit read rate (IO per second) from a device</td></tr><tr><td><code>--device-write-bps</code></td><td></td><td>Limit write rate (bytes per second) to a device</td></tr><tr><td><code>--device-write-iops</code></td><td></td><td>Limit write rate (IO per second) to a device</td></tr><tr><td><code>--disable-content-trust</code></td><td><code>true</code></td><td>Skip image verification</td></tr><tr><td><code>--dns</code></td><td></td><td>Set custom DNS servers</td></tr><tr><td><code>--dns-opt</code></td><td></td><td>Set DNS options</td></tr><tr><td><code>--dns-option</code></td><td></td><td>Set DNS options</td></tr><tr><td><code>--dns-search</code></td><td></td><td>Set custom DNS search domains</td></tr><tr><td><code>--domainname</code></td><td></td><td>Container NIS domain name</td></tr><tr><td><code>--entrypoint</code></td><td></td><td>Overwrite the default ENTRYPOINT of the image</td></tr><tr><td><code>--env</code> , <code>-e</code></td><td></td><td>Set environment variables</td></tr><tr><td><code>--env-file</code></td><td></td><td>Read in a file of environment variables</td></tr><tr><td><code>--expose</code></td><td></td><td>Expose a port or a range of ports</td></tr><tr><td><code>--gpus</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.40/"><strong>API 1.40+</strong></a> GPU devices to add to the container (‘all’ to pass all GPUs)</td></tr><tr><td><code>--group-add</code></td><td></td><td>Add additional groups to join</td></tr><tr><td><code>--health-cmd</code></td><td></td><td>Command to run to check health</td></tr><tr><td><code>--health-interval</code></td><td></td><td>Time between running the check (ms|s|m|h) (default 0s)</td></tr><tr><td><code>--health-retries</code></td><td></td><td>Consecutive failures needed to report unhealthy</td></tr><tr><td><code>--health-start-period</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.29/"><strong>API 1.29+</strong></a> Start period for the container to initialize before starting health-retries countdown (ms|s|m|h) (default 0s)</td></tr><tr><td><code>--health-timeout</code></td><td></td><td>Maximum time to allow one check to run (ms|s|m|h) (default 0s)</td></tr><tr><td><code>--help</code></td><td></td><td>Print usage</td></tr><tr><td><code>--hostname</code> , <code>-h</code></td><td></td><td>Container host name</td></tr><tr><td><code>--init</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.25/"><strong>API 1.25+</strong></a> Run an init inside the container that forwards signals and reaps processes</td></tr><tr><td><code>--interactive</code> , <code>-i</code></td><td></td><td>Keep STDIN open even if not attached</td></tr><tr><td><code>--io-maxbandwidth</code></td><td></td><td>Maximum IO bandwidth limit for the system drive (Windows only)</td></tr><tr><td><code>--io-maxiops</code></td><td></td><td>Maximum IOps limit for the system drive (Windows only)</td></tr><tr><td><code>--ip</code></td><td></td><td>IPv4 address (e.g., 172.30.100.104)</td></tr><tr><td><code>--ip6</code></td><td></td><td>IPv6 address (e.g., 2001:db8::33)</td></tr><tr><td><code>--ipc</code></td><td></td><td>IPC mode to use</td></tr><tr><td><code>--isolation</code></td><td></td><td>Container isolation technology</td></tr><tr><td><code>--kernel-memory</code></td><td></td><td>Kernel memory limit</td></tr><tr><td><code>--label</code> , <code>-l</code></td><td></td><td>Set meta data on a container</td></tr><tr><td><code>--label-file</code></td><td></td><td>Read in a line delimited file of labels</td></tr><tr><td><code>--link</code></td><td></td><td>Add link to another container</td></tr><tr><td><code>--link-local-ip</code></td><td></td><td>Container IPv4/IPv6 link-local addresses</td></tr><tr><td><code>--log-driver</code></td><td></td><td>Logging driver for the container</td></tr><tr><td><code>--log-opt</code></td><td></td><td>Log driver options</td></tr><tr><td><code>--mac-address</code></td><td></td><td>Container MAC address (e.g., 92:d0:c6:0a:29:33)</td></tr><tr><td><code>--memory</code> , <code>-m</code></td><td></td><td>Memory limit</td></tr><tr><td><code>--memory-reservation</code></td><td></td><td>Memory soft limit</td></tr><tr><td><code>--memory-swap</code></td><td></td><td>Swap limit equal to memory plus swap: ‘-1’ to enable unlimited swap</td></tr><tr><td><code>--memory-swappiness</code></td><td><code>-1</code></td><td>Tune container memory swappiness (0 to 100)</td></tr><tr><td><code>--mount</code></td><td></td><td>Attach a filesystem mount to the container</td></tr><tr><td><code>--name</code></td><td></td><td>Assign a name to the container</td></tr><tr><td><code>--net</code></td><td></td><td>Connect a container to a network</td></tr><tr><td><code>--net-alias</code></td><td></td><td>Add network-scoped alias for the container</td></tr><tr><td><code>--network</code></td><td></td><td>Connect a container to a network</td></tr><tr><td><code>--network-alias</code></td><td></td><td>Add network-scoped alias for the container</td></tr><tr><td><code>--no-healthcheck</code></td><td></td><td>Disable any container-specified HEALTHCHECK</td></tr><tr><td><code>--oom-kill-disable</code></td><td></td><td>Disable OOM Killer</td></tr><tr><td><code>--oom-score-adj</code></td><td></td><td>Tune host’s OOM preferences (-1000 to 1000)</td></tr><tr><td><code>--pid</code></td><td></td><td>PID namespace to use</td></tr><tr><td><code>--pids-limit</code></td><td></td><td>Tune container pids limit (set -1 for unlimited)</td></tr><tr><td><code>--platform</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.32/"><strong>API 1.32+</strong></a> Set platform if server is multi-platform capable</td></tr><tr><td><code>--privileged</code></td><td></td><td>Give extended privileges to this container</td></tr><tr><td><code>--publish</code> , <code>-p</code></td><td></td><td>Publish a container’s port(s) to the host</td></tr><tr><td><code>--publish-all</code> , <code>-P</code></td><td></td><td>Publish all exposed ports to random ports</td></tr><tr><td><code>--pull</code></td><td><code>missing</code></td><td>Pull image before running (“always”|“missing”|“never”)</td></tr><tr><td><code>--read-only</code></td><td></td><td>Mount the container’s root filesystem as read only</td></tr><tr><td><code>--restart</code></td><td><code>no</code></td><td>Restart policy to apply when a container exits</td></tr><tr><td><code>--rm</code></td><td></td><td>Automatically remove the container when it exits</td></tr><tr><td><code>--runtime</code></td><td></td><td>Runtime to use for this container</td></tr><tr><td><code>--security-opt</code></td><td></td><td>Security Options</td></tr><tr><td><code>--shm-size</code></td><td></td><td>Size of /dev/shm</td></tr><tr><td><code>--sig-proxy</code></td><td><code>true</code></td><td>Proxy received signals to the process</td></tr><tr><td><code>--stop-signal</code></td><td><code>SIGTERM</code></td><td>Signal to stop a container</td></tr><tr><td><code>--stop-timeout</code></td><td></td><td><a href="https://docs.docker.com/engine/api/v1.25/"><strong>API 1.25+</strong></a> Timeout (in seconds) to stop a container</td></tr><tr><td><code>--storage-opt</code></td><td></td><td>Storage driver options for the container</td></tr><tr><td><code>--sysctl</code></td><td></td><td>Sysctl options</td></tr><tr><td><code>--tmpfs</code></td><td></td><td>Mount a tmpfs directory</td></tr><tr><td><code>--tty</code> , <code>-t</code></td><td></td><td>Allocate a pseudo-TTY</td></tr><tr><td><code>--ulimit</code></td><td></td><td>Ulimit options</td></tr><tr><td><code>--user</code> , <code>-u</code></td><td></td><td>Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])</td></tr><tr><td><code>--userns</code></td><td></td><td>User namespace to use</td></tr><tr><td><code>--uts</code></td><td></td><td>UTS namespace to use</td></tr><tr><td><code>--volume</code> , <code>-v</code></td><td></td><td>Bind mount a volume</td></tr><tr><td><code>--volume-driver</code></td><td></td><td>Optional volume driver for the container</td></tr><tr><td><code>--volumes-from</code></td><td></td><td>Mount volumes from the specified container(s)</td></tr><tr><td><code>--workdir</code> , <code>-w</code></td><td></td><td>Working directory inside the container</td></tr></tbody></table>              </div>            </details><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动容器</span>$ docker <span class="token builtin class-name">exec</span> -it XXID /bin/bash<span class="token comment">#创造容器</span>$ docker run -dit -p <span class="token number">8080</span>:80 -v /e/windowssrc:容器里映射路径 --name 起个名字 ubuntu:你的镜像tag（默认是latest）<span class="token comment">#创造容器并运行多个命令</span>$ docker run -dit XXX<span class="token punctuation">(</span>images<span class="token punctuation">)</span> /bin/bash -c <span class="token string">"ls &amp;&amp; pwd"</span><span class="token comment">#删除容器</span>$ docker <span class="token function">rm</span> -f XXID<span class="token comment">#查看所有的容器命令如下：</span>$ docker <span class="token function">ps</span> -a</code></pre></div><h2 id="容器打包并做成镜像">容器打包并做成镜像</h2><div class="story post-story"><p><strong>容器打包</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker commit containerId dockerUserName/XXX</code></pre><blockquote><p>注：containerId为你需要上传的容器id，dockerUserName为dockerHub的登录名，xxx为仓库名,当然也不一定非得是dockerUserName/xxx，只是为了方便起见</p></blockquote><p>接下来为存在于本地的镜像打标签</p><pre class="language-shell" data-language="shell"><code class="language-shell">$ docker tag imageName dockerUserName/xxx<span class="token punctuation">[</span>:tag<span class="token punctuation">]</span><span class="token comment">#注：imageName为你需要上传的镜像name，</span><span class="token comment"># dockerUserName为dockerHub的登录名，xxx为仓库名，必须和你在dockerhub中新建的仓库名相同，tag不指定就是latest</span></code></pre><p>打包好之后，就把打包好的镜像上传</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ docker push dockerUserName/xxx<span class="token punctuation">[</span>:tag<span class="token punctuation">]</span></code></pre><p>注：tag不指定就是latest<br>————————————————</p></div><h2 id="git设置、查看、取消代理">git设置、查看、取消代理</h2><div class="story post-story"><p>设置代理：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> config --global http.proxy <span class="token string">'socks5://127.0.0.1:1080'</span> $ <span class="token function">git</span> config --global https.proxy <span class="token string">'socks5://127.0.0.1:1080'</span></code></pre><p>查看代理：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> config --global --get http.proxy$ <span class="token function">git</span> config --global --get https.proxy</code></pre><p>取消代理：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">git</span> config --global --unset http.proxygit config --global --unset https.proxy</code></pre></div><h2 id="换源"><strong>换源</strong></h2><div class="story post-story"><p>针对docker容器的代理配置：</p><p>在创建(run)容器的时候，加上 --net=host 这个选项，就可以实现容器内外共享网络，然后再在容器内部配置git，就可以实现容器内代理了</p><p>Ubuntu系统中，软件源文件地址为：<code>/etc/apt/sources.list</code></p><p>1.备份原来的源，将以前的源备份一下，以防以后可以用的。</p><pre class="language-none"><code class="language-none">$ sudo cp &#x2F;etc&#x2F;apt&#x2F;sources.list &#x2F;etc&#x2F;apt&#x2F;sources.list.bak</code></pre><p>2.打开/etc/apt/sources.list文件，在前面添加如下条目，并保存。</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/apt/sources.list（可将vim更换为自己熟悉的编辑器）</code></pre><details green><summary> 添加源 </summary>              <div class='content'>              <pre class="language-text" data-language="text"><code class="language-text">#添加阿里源deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse#添加清华源deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal main restricted universe multiversedeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-updates main restricted universe multiversedeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-backports main restricted universe multiversedeb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ focal-security main restricted universe multiverse multiverse</code></pre>              </div>            </details><p>3.更新</p><p>更新源</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> update</code></pre><p>如出现依赖问题，解决方式如下：</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> -f <span class="token function">install</span></code></pre><p>更新软件：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> <span class="token function">apt-get</span> upgrade</code></pre></div><h2 id="修改-etc-profile-打包后不生效得问题">修改/etc/profile 打包后不生效得问题</h2><div class="story post-story"><p>解决办法:</p><p><strong>可以将环境变量放到 <code>/root/.bashrc</code> 这个里面</strong></p><p>docker 容器中 默认用户为 root, 将环境变量放到 <code>./bashrc</code> 中</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习笔记 </tag>
            
            <tag> 教程 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java 8 Tutorial 教程</title>
      <link href="/posts/c65d65/"/>
      <url>/posts/c65d65/</url>
      
        <content type="html"><![CDATA[<h1>Java 8 Tutorial 教程</h1><blockquote><p>😄 @Auther sizaif</p><p>📆 2021-05-29  20:41:05</p><p>🔗 翻译自 <a href="https://winterbe.com/posts/2014/03/16/java-8-tutorial/">https://winterbe.com/posts/2014/03/16/java-8-tutorial/</a></p></blockquote><p>[TOC]</p><h2 id="说明">说明</h2><div class="story post-story"><p>欢迎来到我对Java 8的介绍。本教程将逐步指导您了解所有新的语言特性。在简短简单的代码示例的支持下，您将学习如何使用默认接口方法、lambda表达式、方法引用和可重复注释。在本文的最后，您将熟悉最新的API变化，如流、功能接口、地图扩展和新的日期API。</p></div><h2 id="接口缺省方法">接口缺省方法</h2><div class="story post-story"><p>Java 8允许我们利用<code>default</code>关键字向接口添加非抽象的方法实现。</p><p>此特性也称为扩展方法( <strong>Extension Methods</strong>.)。这是第一个例子:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Formula</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">double</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span> <span class="token keyword">double</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>除了抽象方法<code>calculate</code>接口外，<code>Formula</code>还定义了默认方法<code>sqrt</code>。具体类只需实现抽象方法<code>calculate</code> 默认方法<code>sqrt</code>可以开箱即用。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Formula</span> formula <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Formula</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>formula<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 100.0</span>formula<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 4.0</span></code></pre><p>该公式以匿名对象的形式实现。这段代码相当冗长:6行代码就可以完成这样一个简单的<code>sqrt(a * 100)</code>计算。正如我们将在下一节中看到的，在Java 8中有一种更好的实现单个方法对象的方法。</p></div><h2 id="拉姆达-Lambda-表达式">拉姆达(Lambda)表达式</h2><div class="story post-story"><p>让我们从一个简单的例子开始，在以前的Java版本中如何对字符串列表排序:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> names <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"peter"</span><span class="token punctuation">,</span> <span class="token string">"anna"</span><span class="token punctuation">,</span> <span class="token string">"mike"</span><span class="token punctuation">,</span> <span class="token string">"xenia"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>静态实用方法<code>Collections.sort</code>接受一个列表和一个比较器，以便对给定列表的元素进行排序. 您经常会发现自己创建了匿名比较器并将它们传递给sort方法。</p><p>Java 8的语法要短得多，而不是整天创建匿名对象，</p><p><strong>lambda expressions</strong>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>正如您所看到的，代码更短，更容易阅读。但它变得更短:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span> a<span class="token punctuation">,</span> <span class="token class-name">String</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>对于一行方法主体，可以跳过大括号{}和return关键字。但它变得更短:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-></span> b<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>java编译器知道参数类型，所以您也可以跳过它们。让我们更深入地了解lambda表达式在实际中是如何使用的</p></div><h2 id="函数式接口">函数式接口</h2><div class="story post-story"><p>lambda表达式如何适应java类型系统?每个lambda对应于由接口指定的给定类型.一个所谓的函数接口<code>必须包含一个抽象方法</code>声明。</p><p>该类型的每个lambda表达式都将与这个抽象方法匹配。由于默认方法不是抽象的，您可以自由地将默认方法添加到函数接口中。</p><p>只要接口只包含一个抽象方法，我们就可以将任意接口作为lambda表达式使用。为了确保您的接口满足需求，您应该添加<code>@FunctionalInterface</code>注释。编译器知道这个注释，当您试图向接口添加第二个抽象方法声明时，就会抛出编译器错误。</p><p>Example:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">interface</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token class-name">T</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">F</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> converter <span class="token operator">=</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Integer</span> converted <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>converted<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 123</span></code></pre><p>请记住，如果<code>@FunctionalInterface</code>注释被省略，那么代码也是有效的。</p></div><h2 id="方法和构造函数引用">方法和构造函数引用</h2><div class="story post-story"><p>通过使用静态方法引用，可以进一步简化上面的示例代码:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> converter <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">;</span><span class="token class-name">Integer</span> converted <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>converted<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 123</span></code></pre><p>Java 8允许您通过<code>::</code>关键字传递方法或构造函数的引用。上面的例子展示了如何引用静态方法。但我们也可以引用对象方法:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Something</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Something</span> something <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> converter <span class="token operator">=</span> something<span class="token operator">::</span><span class="token function">startsWith</span><span class="token punctuation">;</span><span class="token class-name">String</span> converted <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token string">"Java"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>converted<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// "J"</span></code></pre><p>让我们看看<code>::</code>关键字如何在构造函数中工作。首先，我们定义了一个带有不同构造函数的示例<code>bean</code>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> firstName<span class="token punctuation">;</span>    <span class="token class-name">String</span> lastName<span class="token punctuation">;</span>    <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstName<span class="token punctuation">,</span> <span class="token class-name">String</span> lastName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> firstName<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> lastName<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>接下来，我们指定一个用于创建新人员的人员工厂接口:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">PersonFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">P</span> <span class="token keyword">extends</span> <span class="token class-name">Person</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>    <span class="token class-name">P</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstName<span class="token punctuation">,</span> <span class="token class-name">String</span> lastName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>我们不是手动实现工厂，而是通过构造函数引用将所有东西粘在一起:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">PersonFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> personFactory <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span><span class="token class-name">Person</span> person <span class="token operator">=</span> personFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"Peter"</span><span class="token punctuation">,</span> <span class="token string">"Parker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>通过<code>Person::new</code>创建对Person构造函数的引用。Java编译器通过匹配<code>PersonFactory.create</code>的签名自动选择正确的构造函数。</p></div><h2 id="Lambda范围">Lambda范围</h2><div class="story post-story"><p>从lambda表达式访问外部作用域变量非常类似于匿名对象。您可以从本地外部作用域以及实例字段和静态变量访问最终变量。</p><h3 id="访问局部变量">访问局部变量</h3><p>我们可以从lambda表达式的外部作用域读取最终局部变量:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter <span class="token operator">=</span>        <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>stringConverter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 3</span></code></pre><p>但与匿名对象不同的是，变量<code>num</code>不必声明为final。此代码也是有效的:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter <span class="token operator">=</span>        <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>stringConverter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 3</span></code></pre><p>但是<code>num</code>必须是隐式的final，才能编译代码。以下代码无法编译:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter <span class="token operator">=</span>        <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>num <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></code></pre><p><strong>也禁止从lambda表达式内写入num。</strong></p><h3 id="访问字段和静态变量">访问字段和静态变量</h3><p>与局部变量相比，我们可以从lambda表达式中读写实例字段和静态变量。这种行为在匿名对象中很常见。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Lambda4</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> outerStaticNum<span class="token punctuation">;</span>    <span class="token keyword">int</span> outerNum<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">testScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter1 <span class="token operator">=</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            outerNum <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> stringConverter2 <span class="token operator">=</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            outerStaticNum <span class="token operator">=</span> <span class="token number">72</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><h3 id="访问缺省接口方法">访问缺省接口方法</h3><p>还记得第一部分的公式例子吗? 接口<code>Formula</code>定义了一个默认方法<code>sqrt</code>，可以从每个公式实例(包括匿名对象)访问该方法。这不适用于lambda表达式。</p><p><strong>不能</strong>从lambda表达式中访问默认方法。以下代码无法编译:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Formula</span> formula <span class="token operator">=</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">sqrt</span><span class="token punctuation">(</span> a <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><h2 id="内置函数式接口">内置函数式接口</h2><div class="story post-story"><p>JDK 1.8 API包含许多内置的功能性接口。它们中的一些在较早的Java版本中很有名，比如<code>Comparator</code>或<code>Runnable</code>。通过<code>@FunctionalInterface</code>注释对这些现有接口进行了扩展，以支持Lambda。</p><p>但是Java 8 API也充满了新的功能接口，使您的生活更轻松。其中一些新接口来自 <a href="https://code.google.com/p/guava-libraries/">Google Guava</a>库。即使您熟悉这个库，也应该密切关注这些接口是如何通过一些有用的方法扩展来扩展的。</p><h3 id="谓词-Predicates">谓词(Predicates)</h3><p>谓词是一个参数的布尔值函数。该接口包含用于将谓词组合成复杂逻辑术语(和或否定)的各种默认方法。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> predicate <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>predicate<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">// truepredicate.negate().test("foo");     // falsePredicate&lt;Boolean> nonNull = Objects::nonNull;Predicate&lt;Boolean> isNull = Objects::isNull;Predicate&lt;String> isEmpty = String::isEmpty;Predicate&lt;String> isNotEmpty = isEmpty.negate();</span></code></pre><h3 id="函数-Functions">函数(Functions)</h3><p>函数接受一个参数并产生一个结果。默认方法可以用于将多个函数链接在一起(compose, andThen)。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> toInteger <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">;</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> backToString <span class="token operator">=</span> toInteger<span class="token punctuation">.</span><span class="token function">andThen</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>backToString<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// "123"</span></code></pre><h3 id="suppliers">suppliers</h3><p>Suppliers生成给定泛型类型的结果。与函数不同，,Suppliers不接受参数。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> personSupplier <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">;</span>personSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// new Person</span></code></pre><h3 id="Consumers">Consumers</h3><p>消费者表示对单个输入参数执行的操作</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> greeter <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello, "</span> <span class="token operator">+</span> p<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>greeter<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Luke"</span><span class="token punctuation">,</span> <span class="token string">"Skywalker"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="comparators">comparators</h3><p>比较器在较早的Java版本中很有名。Java 8向接口中添加了各种默认方法。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> comparator <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-></span> p1<span class="token punctuation">.</span>firstName<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>p2<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Person</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"John"</span><span class="token punctuation">,</span> <span class="token string">"Doe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Person</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"Wonderland"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>comparator<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// > 0comparator.reversed().compare(p1, p2);  // &lt; 0</span></code></pre><h3 id="Optionals">Optionals</h3><p>可选对象不是函数接口，而是一个防止<code>NullPointerException</code>的漂亮实用工具。这是下一节的一个重要概念，所以让我们快速了解一下<code>optional</code>是如何工作的。</p><p><code>Optional</code>是一个简单的值容器，它可以是空值或非空值。考虑一个可能返回非空结果但有时什么也不返回的方法。在<code>Java 8</code>中，不是返回null，而是返回一个Optional。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> optional <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"bam"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>optional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// trueoptional.get();                 // "bam"optional.orElse("fallback");    // "bam"optional.ifPresent((s) -> System.out.println(s.charAt(0)));     // "b"</span></code></pre></div><h2 id="Streams">Streams</h2><div class="story post-story"><p><code>stream</code>表示一个可以执行一个或多个操作的元素序列。流操作可以是中间操作，也可以是终端操作。终端操作返回某种类型的结果，而中间操作返回流本身，因此您可以在一行中链接多个方法调用。流是在源文件上创建的，例如<code>java.util.Collection</code>，如列表或集合(不支持映射)。流操作可以顺序执行，也可以并行执行。</p><p>让我们首先看看顺序流是如何工作的。首先，我们以字符串列表的形式创建一个示例源:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stringCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"ddd2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"aaa2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"bbb1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"aaa1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"bbb3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"ccc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"bbb2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stringCollection<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"ddd1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Java 8中的集合被扩展了，所以你可以通过调用<code>Collection.stream()</code>或<code>Collection.parallelStream()</code>简单地创建流。下面的部分解释了最常见的流操作。</p><h3 id="Filter">Filter</h3><p>Filter接受一个谓词(predicate)来过滤流中的所有元素。这个操作是中间的，它使我们能够对结果调用另一个流操作(<code>forEach</code>)。ForEach 接受要为过滤流中的每个元素执行的使用者。<code>ForEach</code>是一个终端操作。它是<code>void</code>的，所以我们不能调用另一个流操作。</p><pre class="language-java" data-language="java"><code class="language-java">stringCollection    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// "aaa2", "aaa1"</span></code></pre><h3 id="Sorted">Sorted</h3><p><code>Sorted</code>是一个中间操作，它返回流的排序视图。元素按自然顺序排序，除非传递自定义<code>Comparator</code>。</p><pre class="language-java" data-language="java"><code class="language-java">stringCollection    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// "aaa1", "aaa2"</span></code></pre><p>==请记住，sorted只创建流的排序视图，而不操作后台集合的顺序。<code>stringCollection</code>的顺序是不变的:==</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stringCollection<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ddd2, aaa2, bbb1, aaa1, bbb3, ccc, bbb2, ddd1</span></code></pre><h3 id="Map">Map</h3><p>中间操作映射(Map)通过给定的函数将每个元素转换为另一个对象。下面的示例将每个字符串转换为大写字符串。但是您也可以使用<code>map</code>将每个对象转换为另一种类型。结果流的泛型类型取决于传递给<code>map</code>的函数的泛型类型。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 映射map 从小写变成大写, 并按照从小到大排序stringCollection    .stream()    .map(String::toUpperCase)    .sorted((a, b) -> b.compareTo(a))    .forEach(System.out::println);// "DDD2", "DDD1", "CCC", "BBB3", "BBB2", "AAA2", "AAA1"</span></code></pre><h3 id="Match">Match</h3><p>可以使用各种匹配操作来检查某个谓词是否与流匹配。所有这些操作都是<code>terminal</code>，并返回一个<code>布尔结果</code>。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 是否有至少一个以a开头的存在?boolean anyStartsWithA =    stringCollection        .stream()        .anyMatch((s) -> s.startsWith("a"));System.out.println(anyStartsWithA);      // true//是否全都是以a开头?boolean allStartsWithA =    stringCollection        .stream()        .allMatch((s) -> s.startsWith("a"));System.out.println(allStartsWithA);      // false// 是否不存在以z开头?boolean noneStartsWithZ =    stringCollection        .stream()        .noneMatch((s) -> s.startsWith("z"));System.out.println(noneStartsWithZ);      // true</span></code></pre><h3 id="Count">Count</h3><p>Count是一个终端操作，将流中的元素个数作为<code>long</code>返回。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 以B开头的个数long startsWithB =    stringCollection        .stream()        .filter((s) -> s.startsWith("b"))        .count();System.out.println(startsWithB);    // 3</span></code></pre><h3 id="Reduce">Reduce</h3><p>这个终端操作使用给定函数对流中的元素进行还原。结果是一个<code>可选(Optional)</code>的保存减少的值。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> reduced <span class="token operator">=</span>    stringCollection        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-></span> s1 <span class="token operator">+</span> <span class="token string">"#"</span> <span class="token operator">+</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>reduced<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// "aaa1#aaa2#bbb1#bbb2#bbb3#ccc#ddd1#ddd2"</span></code></pre></div><h2 id="Parallel-Streams">Parallel Streams</h2><div class="story post-story"><p>如上所述，流可以是顺序的，也可以是并行的。顺序流上的操作在单个线程上执行，而并行流上的操作在多个线程上并发执行。</p><p>下面的示例演示了通过使用并行流来提高性能是多么容易。</p><p>首先，我们创建了一系列独特元素:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">UUID</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    values<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>现在我们测量对这个集合的流进行排序所花费的时间。</p><h3 id="Sequential-Sort">Sequential Sort</h3><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> count <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> millis <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"sequential sort took: %d ms"</span><span class="token punctuation">,</span> millis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// sequential sort took: 899 ms</span></code></pre><h3 id="Parallel-Sort">Parallel Sort</h3><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> count <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> millis <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"parallel sort took: %d ms"</span><span class="token punctuation">,</span> millis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// parallel sort took: 472 ms</span></code></pre><p>正如您可以看到的，这两个代码片段几乎是相同的，但并行排序大约快50%。您需要做的就是将<code>stream()</code>更改为<code>parallelStream()</code>。</p></div><h2 id="Map-2">Map</h2><div class="story post-story"><p>如前所述，映射不支持流。相反，映射现在支持各种新的、有用的方法来完成常见的任务。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">"val"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>上面的代码应该是不言自明的:<code>putIfAbsent</code>阻止我们写额外的<code>if null</code>检查;<code>forEach</code>接受一个消费者来为映射的每个值执行操作。</p><p>这个例子展示了如何使用函数在mao上计算代码:</p><pre class="language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">computeIfPresent</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>num<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">-></span> val <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val33map.computeIfPresent(9, (num, val) -> null);map.containsKey(9);     // falsemap.computeIfAbsent(23, num -> "val" + num);map.containsKey(23);    // truemap.computeIfAbsent(3, num -> "bam");map.get(3);             // val33</span></code></pre><p>接下来，我们学习如何删除一个给定键的条目，仅当它当前映射到一个给定值时:</p><pre class="language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"val3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val33map.remove(3, "val33");map.get(3);             // null</span></code></pre><p>另一个有用的方法:</p><pre class="language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">"not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// not found</span></code></pre><p>合并一个map条目是很容易的:</p><pre class="language-java" data-language="java"><code class="language-java">map<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"val9"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span> <span class="token operator">-></span> value<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// val9map.merge(9, "concat", (value, newValue) -> value.concat(newValue));map.get(9);             // val9concat</span></code></pre><p>合并要么把键/值放到映射中，如果键不存在，要么调用合并函数来改变现有的值。</p></div><h2 id="Date-API">Date API</h2><div class="story post-story"><p>Java 8在<code>Java .time</code>包下包含了一个全新的日期和<code>Date API</code>。新的<code>Date API</code>可以与J  <a href="http://www.joda.org/joda-time/">Joda-Time</a>库相比较，但是它们<a href="http://blog.joda.org/2009/11/why-jsr-310-isn-joda-time_4941.html">是不同的</a>。下面的示例涵盖了这个新API的最重要部分。</p><h3 id="Clock">Clock</h3><p>Clock提供对当前日期和时间的访问。时钟知道一个时区，可以用来代替<code>System.currentTimeMillis()</code>来检索当前的毫秒数。这种时间线上的瞬时点也可以用<code>Instant类</code>表示。<code>instant</code>可用于创建遗留的<code>java.util.Date</code>对象。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Clock</span> clock <span class="token operator">=</span> <span class="token class-name">Clock</span><span class="token punctuation">.</span><span class="token function">systemDefaultZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> millis <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Instant</span> instant <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">instant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Date</span> legacyDate <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>instant<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// legacy java.util.Date</span></code></pre><h3 id="Timezones">Timezones</h3><p>时区用<code>ZoneId</code>表示。可以通过静态工厂方法轻松地访问它们。时区定义了在瞬间和本地日期和时间之间进行转换时非常重要的偏移量。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">getAvailableZoneIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// prints all available timezone idsZoneId zone1 = ZoneId.of("Europe/Berlin");ZoneId zone2 = ZoneId.of("Brazil/East");System.out.println(zone1.getRules());System.out.println(zone2.getRules());// ZoneRules[currentStandardOffset=+01:00]// ZoneRules[currentStandardOffset=-03:00]</span></code></pre><h3 id="LocalTime">LocalTime</h3><p>LocalTime表示没有时区的时间，例如晚上10点或17:30:15。下面的示例为上面定义的时区创建两个本地时间。然后我们比较这两个时间，并计算这两个时间的</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalTime</span> now1 <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span>zone1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LocalTime</span> now2 <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span>zone2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>now1<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>now2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// falselong hoursBetween = ChronoUnit.HOURS.between(now1, now2);long minutesBetween = ChronoUnit.MINUTES.between(now1, now2);System.out.println(hoursBetween);       // -3System.out.println(minutesBetween);     // -239</span></code></pre><p>LocalTime附带了各种工厂方法来简化新实例的创建，包括时间字符串的解析。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalTime</span> late <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>late<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 23:59:59DateTimeFormatter germanFormatter =    DateTimeFormatter        .ofLocalizedTime(FormatStyle.SHORT)        .withLocale(Locale.GERMAN);LocalTime leetTime = LocalTime.parse("13:37", germanFormatter);System.out.println(leetTime);   // 13:37</span></code></pre><h3 id="LocalDate">LocalDate</h3><p>LocalDate表示一个不同的日期，例如<code>2014-03-11</code>。它是不可变的，工作方式与<code>LocalTime</code>完全类似。该示例演示了如何通过增加或减少日、月或年来计算新的日期。请记住，每个操作都返回一个新实例。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalDate</span> today <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LocalDate</span> tomorrow <span class="token operator">=</span> today<span class="token punctuation">.</span><span class="token function">plus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">ChronoUnit</span><span class="token punctuation">.</span>DAYS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LocalDate</span> yesterday <span class="token operator">=</span> tomorrow<span class="token punctuation">.</span><span class="token function">minusDays</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LocalDate</span> independenceDay <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2014</span><span class="token punctuation">,</span> <span class="token class-name">Month</span><span class="token punctuation">.</span>JULY<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DayOfWeek</span> dayOfWeek <span class="token operator">=</span> independenceDay<span class="token punctuation">.</span><span class="token function">getDayOfWeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dayOfWeek<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// FRIDAY</span></code></pre><p>从字符串中解析<code>LocalDate</code>就像解析<code>LocalTime</code>一样简单:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DateTimeFormatter</span> germanFormatter <span class="token operator">=</span>    <span class="token class-name">DateTimeFormatter</span>        <span class="token punctuation">.</span><span class="token function">ofLocalizedDate</span><span class="token punctuation">(</span><span class="token class-name">FormatStyle</span><span class="token punctuation">.</span>MEDIUM<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">withLocale</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span>GERMAN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LocalDate</span> xmas <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"24.12.2014"</span><span class="token punctuation">,</span> germanFormatter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>xmas<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2014-12-24</span></code></pre><h3 id="LocalDateTime">LocalDateTime</h3><p><code>LocalDateTime</code>表示**<code>日期-时间</code>**。它将上面的日期和时间合并到一个实例中。<code>LocalDateTime</code>是不可变的，工作原理类似于<code>LocalTime</code>和<code>LocalDate</code>。我们可以利用方法从日期-时间中检索某些字段:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">LocalDateTime</span> sylvester <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2014</span><span class="token punctuation">,</span> <span class="token class-name">Month</span><span class="token punctuation">.</span>DECEMBER<span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">DayOfWeek</span> dayOfWeek <span class="token operator">=</span> sylvester<span class="token punctuation">.</span><span class="token function">getDayOfWeek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dayOfWeek<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// WEDNESDAYMonth month = sylvester.getMonth();System.out.println(month);          // DECEMBERlong minuteOfDay = sylvester.getLong(ChronoField.MINUTE_OF_DAY);System.out.println(minuteOfDay);    // 1439</span></code></pre><p>通过附加的时区信息，可以将其转换为瞬间。瞬间可以很容易地转换为<code>java.util.Date</code>类型的遗留日期。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Instant</span> instant <span class="token operator">=</span> sylvester        <span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">toInstant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Date</span> legacyDate <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>instant<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>legacyDate<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Wed Dec 31 23:59:59 CET 2014</span></code></pre><p>格式化日期-时间就像格式化日期或时间一样。我们可以从自定义模式创建格式化器，而不是使用预定义的格式。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">DateTimeFormatter</span> formatter <span class="token operator">=</span>    <span class="token class-name">DateTimeFormatter</span>        <span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"MMM dd, yyyy - HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">LocalDateTime</span> parsed <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"Nov 03, 2014 - 07:13"</span><span class="token punctuation">,</span> formatter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> string <span class="token operator">=</span> formatter<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Nov 03, 2014 - 07:13</span></code></pre><p>与<code>java.text.NumberFormat</code>不同，新的<code>DateTimeFormatter</code>是<strong>不可变的和线程安全的</strong>。</p></div><h2 id="Annotations">Annotations</h2><div class="story post-story"><p>Java 8中的注释是可重复的。让我们直接进入一个例子来解决这个问题。</p><p>首先，我们定义一个包装注释，它包含一个实际注释的数组:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@interface</span> <span class="token class-name">Hints</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Hint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token annotation punctuation">@Repeatable</span><span class="token punctuation">(</span><span class="token class-name">Hints</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token annotation punctuation">@interface</span> <span class="token class-name">Hint</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>Java 8允许我们通过声明注释@Repeatable来使用相同类型的多个注释。</p><p>变体1:使用容器注释(旧式)</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Hints</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint2"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></code></pre><p>变体2:使用可重复的注释(新学校)</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint1"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Hint</span><span class="token punctuation">(</span><span class="token string">"hint2"</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></code></pre><p>通过使用变体2,java编译器隐式地在底层设置@Hints注释。这对于通过反射阅读注释信息很重要。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Hint</span> hint <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Hint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hint<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// nullHints hints1 = Person.class.getAnnotation(Hints.class);System.out.println(hints1.value().length);  // 2Hint[] hints2 = Person.class.getAnnotationsByType(Hint.class);System.out.println(hints2.length);          // 2</span></code></pre><p>尽管我们从来没有在<code>Person类</code>上声明<code>@Hints</code>注释，但通过<code>getnotation (hint .class)</code>仍然可读。然而，更方便的方法是<code>getAnnotationsByType</code>，它允许直接访问所有带注释的<code>@Hin</code>注释。</p><p>此外，Java 8中注释的使用扩展到了两个新的目标:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE_PARAMETER<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE_USE<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token annotation punctuation">@interface</span> <span class="token class-name">MyAnnotation</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></code></pre></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 技术向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Py自动化脚本实现去除hexo标签插件语法</title>
      <link href="/posts/28f3a3fd/"/>
      <url>/posts/28f3a3fd/</url>
      
        <content type="html"><![CDATA[<h1>py自动化脚本实现去除hexo标签插件语法</h1><p>[TOC]</p><h2 id="需求">需求</h2><div class="story post-story"><p>鱼和熊掌不可兼得,当采用<code>typora</code>编写md文档时,typora等其他软件是不支持hexo的插件语法的,故而不会实时渲染的.只会显示源代码: 例如</p><details yello><summary> 源码 </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span>% note danger, note error/danger %<span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>% note success, note done/success %<span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p>当同步发表到CSDN等其他博客时,会把源代码显示出来,显得非常不美观,且含有乱码.</p><p>故而写一个自动化脚本去除含有 hexo 语法的 内容, 尝试还源一个纯净的md文件</p></div><h2 id="代码">代码</h2><div class="story post-story"><details green><summary> code </summary>              <div class='content'>              <pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># !/usr/bin/python</span><span class="token comment"># -*- coding: utf-8 -*-</span><span class="token comment"># @Author: float311@163.com; sizaif2000@163.com</span><span class="token comment"># @Description: 将hexo博客修改为csdn可以使用的格式</span><span class="token comment"># @Date 2021/8/8 17:59</span><span class="token comment"># @Update 2021-08-09  10:17:50</span><span class="token comment"># @note:</span><span class="token comment">#   已知bug:</span><span class="token comment">#          1. hexo语法不能与文本混用,即处在一行中, 例如: 带 &#123;% u 下划线 %&#125; 的文本 ; 会导致 文本内容丢失</span><span class="token comment">#          2. 代码框中内容也会被处理</span><span class="token keyword">import</span> sys<span class="token punctuation">,</span>re<span class="token keyword">def</span> <span class="token function">matchstring</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># radio, checkout note</span>    matchradio <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'&#123;% [rcn].*'</span><span class="token punctuation">,</span>line<span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>    <span class="token keyword">if</span> matchradio<span class="token punctuation">:</span>        <span class="token keyword">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>            <span class="token string">r'%&#125;'</span><span class="token punctuation">,</span>            <span class="token string">""</span><span class="token punctuation">,</span>            <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>    <span class="token comment"># floding timeline, tab end</span>    matchall <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'&#123;% [fte].*'</span><span class="token punctuation">,</span>line<span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>    <span class="token keyword">if</span> matchall<span class="token punctuation">:</span>        <span class="token comment"># 全部丢弃</span>        <span class="token keyword">return</span> <span class="token boolean">None</span>    <span class="token comment"># link</span>    matchlink <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'&#123;% link .*'</span><span class="token punctuation">,</span>line<span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>    <span class="token keyword">if</span> matchlink<span class="token punctuation">:</span>        temp <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>        line <span class="token operator">=</span> <span class="token string">"["</span><span class="token operator">+</span>temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"]("</span><span class="token operator">+</span>re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'%&#125;'</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>temp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">")"</span>        <span class="token keyword">return</span>  line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># audio,video</span>    matchaudio <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'&#123;% [av].*'</span><span class="token punctuation">,</span>line<span class="token punctuation">,</span>re<span class="token punctuation">.</span>I<span class="token punctuation">)</span>    <span class="token keyword">if</span> matchaudio<span class="token punctuation">:</span>        <span class="token keyword">return</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span>    <span class="token comment"># &lt;!--类</span>    matchall2 <span class="token operator">=</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"&lt;!--"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> matchall2<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">None</span><span class="token keyword">def</span> <span class="token function">modify</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    根据hexo MD文件生成CSDN博客适用的MD文件    :param original: 源文件    :param result: 新文件    """</span>    content <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>original<span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> o<span class="token punctuation">:</span>        <span class="token keyword">for</span> line <span class="token keyword">in</span> o<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"&#123;%"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">and</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"&lt;!--"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                content <span class="token operator">+=</span> line            <span class="token keyword">else</span><span class="token punctuation">:</span>                line <span class="token operator">=</span> matchstring<span class="token punctuation">(</span>line<span class="token punctuation">)</span>                <span class="token keyword">if</span> line <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>                    content <span class="token operator">+=</span> line    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"w+"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> n<span class="token punctuation">:</span>        n<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    original_md <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".md"</span>    result_md <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".md"</span>    modify<span class="token punctuation">(</span>original_md<span class="token punctuation">,</span> result_md<span class="token punctuation">)</span></code></pre>              </div>            </details></div><h2 id="使用方法">使用方法</h2><div class="story post-story"><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 文件名不需要带md</span>$ py main 源文件 输出文件</code></pre></div><h2 id="已知bug">已知bug</h2><div class="story post-story"><ol><li><s>radio,checkout,note 文本内容中不能含有’,'(逗号), 会导致分割数据丢失</s></li><li>hexo语法不能与文本混用,即处在一行中, 例如: 带<code>&#123;% u 下划线 %&#125;的文本</code>; 会导致文本内容丢失</li><li>代码框中的内容也会被处理</li></ol><p>​        <strong>上面的情况暂时需要手动处理</strong></p></div><h2 id="感谢">感谢</h2><div class="story post-story"><p>感谢 <a href="mailto:float311@163.com">float311@163.com</a></p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 脚本 </tag>
            
            <tag> 技术向 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo-Gui Project</title>
      <link href="/posts/739d4da5/"/>
      <url>/posts/739d4da5/</url>
      
        <content type="html"><![CDATA[<p>[toc]</p><h2 id="hexo图形界面-gui需求文档">hexo图形界面 gui需求文档</h2><div class="story post-story"><ul><li>[ ] 部署到github</li><li>[ ] 一键创建文章,并自动资源管理器中打开_post文件夹</li><li>[ ] 一键创建page,并自动资源管理器中打开source文件夹</li><li>[ ] 一键本地预览</li><li>[ ] 一键生成,发布到github仓库( 需要配置仓库名称, 待讨论)</li><li>[ ] 一键打开更改hexo配置</li><li>[ ] 一键打开更改hexo 主题配置</li></ul><h3 id="一键创建文章">一键创建文章</h3><p>几种方案:</p><p><strong>选择其中一种</strong></p><ul><li>[ ] 一键创建文章,并自动资源管理器中打开_post文件夹</li><li>[ ] 一键创建文章,并自动调用typora打开文章</li></ul><h3 id="一键创建page">一键创建page</h3><p>方案雷同 创建文章</p><h3 id="一键本地预览">一键本地预览</h3><pre class="language-bash" data-language="bash"><code class="language-bash">$ hexo s -g</code></pre><h3 id="一键生成-发布到github仓库">一键生成,发布到github仓库</h3><p>若直接调用</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ hexo s -d</code></pre><p>则会交互要求输入 github用户名和密码进行验证</p><p>不想交互输入的话,</p><ol><li><p>提前设定 用户名和密码</p></li><li><p>使用sshkey git推送</p></li></ol><h3 id="一键打开设置hexo配置">一键打开设置hexo配置</h3><p>类同 更改hexo主题配置</p><h3 id="一键打开更改hexo-主题配置">一键打开更改hexo 主题配置</h3><p>需要在hexo 根目录下 新建<code>_config.主题.yml</code></p><p>调用 程序打开, 或者 打开所在文件夹,或者 根据主题一键部署(待讨论, 工作量大)</p><p><strong>选择其中一种</strong></p><ul><li>[ ] 调用程序打开 e.g  sublime text, notep++,等</li><li>[ ] 直接打开所在文件夹,用户自己打开配置</li><li>[ ] 调用窗口,gui 设定参数(工作量大)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> github计划 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AutoHotkey+Typora 实现快捷键输入Hexo标签插件</title>
      <link href="/posts/96be5746/"/>
      <url>/posts/96be5746/</url>
      
        <content type="html"><![CDATA[<h1>AutoHotkey+Typora 实现快捷键输入hexo标签插件</h1><p>[toc]</p><h2 id="需求">需求</h2><div class="story post-story"><p>使用hexo写博客时,hexo包括主题文件,提供了丰富的标签插件美化,在博客上非常美观简洁,甚是喜欢.</p><p>但语法写起来比较麻烦,需要每次查询,或者手打.</p><p>人类的本质是去掉重复工作,<code>懒是提高生产力的最大障碍</code>.</p><p>故而想到了使用快捷键的方式在typora中快速的插入语法</p></div><h2 id="所需环境">所需环境</h2><div class="story post-story"><div class='checkbox green checked'><input type="radio" checked="checked"/>            <p>AutoHotkey</p>            </div><div class='checkbox cyan checked'><input type="radio" checked="checked"/>            <p>Typora</p>            </div><p><strong>AutoHotkey</strong>:</p><p>去官网安装即可</p><img src="https://gitee.com/sizaif/images/raw/master/img/20210808210510.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210808210510.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210808210508667" style="zoom:50%;" /><div class="tag link"><a class="link-card" title="AutoHotkey官网" href="https://www.autohotkey.com/"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">AutoHotkey官网</p><p class="url">https://www.autohotkey.com/</p></div></a></div><p><strong>Typora</strong>:</p><p>去官网安装</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210808210608.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210808210608.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210808210606079"></p><div class="tag link"><a class="link-card" title="Typora官网" href="https://typora.io/"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">Typora官网</p><p class="url">https://typora.io/</p></div></a></div></div><h2 id="编写Autohotkey脚本">编写Autohotkey脚本</h2><div class="story post-story"><h3 id="创建xxx-ahk文件">创建xxx.ahk文件</h3><p>粘贴我写的代码进去, 可自定义脚本,添加其他功能.</p><p><code>^</code> : ctrl</p><p><code>!</code>: alt</p><p><code>#</code>: win</p><p><code>+</code>: shift</p><p><code>~</code>: alt+tab</p><details green><summary> 代码 </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">;</span> Typora<span class="token punctuation">;</span> 快捷设置兼容hexo格式<span class="token punctuation">;</span> SendInput <span class="token punctuation">&#123;</span>Text<span class="token punctuation">&#125;</span> 解决中文输入法问题<span class="token comment">#IfWinActive ahk_exe Typora.exe</span><span class="token punctuation">&#123;</span>    <span class="token punctuation">;</span> ctrl+1 tab    ^1::addtabcode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span> ctrl+2  note    ^2::addnotecode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span> ctrl+3  folding    ^3::addfoldingcode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span> ctrl+4  <span class="token function">link</span>    ^4::addlinkcode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span> ctrl+5  span    ^5::addspancode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span> ctrl+6  radio    ^6::addradiocode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 快捷设置tab<span class="token function-name function">addtabcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    clipboard :<span class="token operator">=</span> <span class="token string">"&#123;% tabs tab-id %&#125;<span class="token variable"><span class="token variable">`</span>n<span class="token variable">`</span></span>t&lt;!-- tab 1 --><span class="token variable"><span class="token variable">`</span>nreplace<span class="token variable">`</span></span>n&lt;!-- endtab --><span class="token variable"><span class="token variable">`</span>n<span class="token operator">&lt;</span><span class="token operator">!</span>-- tab <span class="token number">2</span> --<span class="token operator">></span><span class="token variable">`</span></span>nreplace<span class="token variable"><span class="token variable">`</span>n<span class="token operator">&lt;</span><span class="token operator">!</span>-- endtab --<span class="token operator">></span><span class="token variable">`</span></span>n&#123;% endtabs %&#125;"</span>    Send ^v    <span class="token builtin class-name">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 快捷设置note<span class="token function-name function">addnotecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    clipboard :<span class="token operator">=</span> <span class="token string">"&#123;% note danger, note error/danger %&#125;<span class="token variable"><span class="token variable">`</span>n<span class="token punctuation">&#123;</span>% note success, note done/success %<span class="token punctuation">&#125;</span><span class="token string">"    Send ^v    return&#125;; 快捷设置foldingaddfoldingcode()&#123;    clipboard := "</span><span class="token punctuation">&#123;</span>% folding green, text %<span class="token punctuation">&#125;</span><span class="token variable">`</span></span>n&#123;% endfolding %&#125;"</span>    Send ^v    <span class="token builtin class-name">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 快捷设置link<span class="token function-name function">addlinkcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    clipboard :<span class="token operator">=</span> <span class="token string">"&#123;% link title, link %&#125;"</span>    Send ^v    <span class="token builtin class-name">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 快捷设置span<span class="token function-name function">addspancode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    clipboard :<span class="token operator">=</span> <span class="token string">"&#123;% span parm, txt %&#125;"</span>    Send ^v    <span class="token builtin class-name">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> 快捷设置radio<span class="token function-name function">addradiocode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    clipboard :<span class="token operator">=</span> <span class="token string">"&#123;% radio green checked, text %&#125;"</span>    Send ^v    <span class="token builtin class-name">return</span>   <span class="token punctuation">&#125;</span></code></pre>              </div>            </details><h3 id="编译运行-xxx-ahk文件">编译运行 xxx.ahk文件</h3><p>鼠标右键文件 <code>compiler script</code></p><p>双击启动脚本</p><h3 id="Typora中运行">Typora中运行</h3><p>快去愉快的测试吧!</p></div><h2 id="遇到问题">遇到问题</h2><div class="story post-story"><p>当设置 <code>alt</code> 按键的时候, 如果运行时按下出现键盘功能变得诡异,</p><p>请再按一次<code>alt</code></p></div><h2 id="相关文档">相关文档</h2><div class="story post-story"><p>但鱼和熊掌不可兼得,当采用<code>typora</code>编写md文档时,typora等其他软件是不支持hexo的插件语法的,故而不会实时渲染的.只会显示源代码: 例如</p><details yello><summary> 源码 </summary>              <div class='content'>              <pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span>% note danger, note error/danger %<span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>% note success, note done/success %<span class="token punctuation">&#125;</span></code></pre>              </div>            </details><p>当去CSDN等其他博客发表时,会把源代码显示出来,显得非常丑.</p><p>解决方法:</p><div class="tag link"><a class="link-card" title="py自动化脚本实现去除hexo标签插件语法" href="https://www.sizaif.com/2021/08/08/py%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%8E%BB%E9%99%A4hexo%E6%A0%87%E7%AD%BE%E6%8F%92%E4%BB%B6%E8%AF%AD%E6%B3%95/"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">py自动化脚本实现去除hexo标签插件语法</p><p class="url">https://www.sizaif.com/2021/08/08/py%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%8E%BB%E9%99%A4hexo%E6%A0%87%E7%AD%BE%E6%8F%92%E4%BB%B6%E8%AF%AD%E6%B3%95/</p></div></a></div></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网站 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Volantis 5.0 标签插件</title>
      <link href="/posts/e55b6fd4/"/>
      <url>/posts/e55b6fd4/</url>
      
        <content type="html"><![CDATA[<h1>volantis 5.0 标签插件</h1><blockquote><p>为了兼容老用户，旧的标签插件在重构之前依然沿用旧的格式，即 <strong>command</strong> + <strong>空格</strong> 作为参数分隔符，而部分新增标签插件是 <strong>空格</strong> + <strong>英文竖线</strong> + <strong>空格</strong> ，请注意区分。</p><p>我们也在探索哪种分隔符既简单又不容易引起冲突，所以可能存在多种格式，具体以对应文档描述为准。</p></blockquote><h2 id="text">text</h2><div class="story post-story"><div class="tabs" id="tab-01"><ul class="nav-tabs"><li class="tab active"><a class="#tab-01-1">效果</a></li><li class="tab"><a class="#tab-01-2">源码</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tab-01-1"><p>带 <u>下划线</u> 的文本；带 <emp>着重号</emp> 的文本；带 <wavy>波浪线</wavy> 的文本；带 <del>删除线</del> 的文本</p><p>键盘样式的文本：<kbd>⌘</kbd> + <kbd>D</kbd></p><p>密码样式的文本：<psw>这里没有验证码</psw></p></div><div class="tab-pane" id="tab-01-2"><pre class="language-none"><code class="language-none">带 &#123;% u 下划线 %&#125; 的文本；带 &#123;% emp 着重号 %&#125; 的文本；带 &#123;% wavy 波浪线 %&#125; 的文本；带 &#123;% del 删除线 %&#125; 的文本键盘样式的文本：&#123;% kbd ⌘ %&#125; + &#123;% kbd D %&#125;密码样式的文本：&#123;% psw 这里没有验证码 %&#125;</code></pre></div></div></div><div class="tag link"><a class="link-card" title="标签插件" href="https://volantis.js.org/v5/tag-plugins/"><div class="left"><img src="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" class="lazyload" data-srcset="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/logo/256/safari.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="/></div><div class="right"><p class="text">标签插件</p><p class="url">https://volantis.js.org/v5/tag-plugins/</p></div></a></div></div>]]></content>
      
      
      <categories>
          
          <category> 建站笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网站 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo+github博客搭建</title>
      <link href="/posts/b4a23979/"/>
      <url>/posts/b4a23979/</url>
      
        <content type="html"><![CDATA[<h1>hexo+github博客搭建</h1><h2 id="需求">需求</h2><div class="story post-story"><div class='checkbox red checked'><input type="checkbox" checked="checked"/>            <p>将本地博客存放在<code>DropBox</code>云中</p>            </div><div class='checkbox green checked'><input type="checkbox" checked="checked"/>            <p>使用hexo构建博客系统</p>            </div><div class='checkbox yellow checked'><input type="checkbox" checked="checked"/>            <p>使用github作为远程仓库</p>            </div><div class='checkbox cyan'><input type="checkbox" />            <p>使用gitee作为备用仓库</p>            </div><div class='checkbox blue checked'><input type="checkbox" checked="checked"/>            <p>绑定域名</p>            </div><div class='checkbox purple checked'><input type="checkbox" checked="checked"/>            <p>本地使用<strong>ssh git</strong>方式推送</p>            </div></div><h2 id="搭建步骤">搭建步骤</h2><div class="story post-story"><h3 id="安装必要环境">安装必要环境</h3><pre class="language-yaml" data-language="yaml"><code class="language-yaml">gitwindows10 (非必须)<span class="token key atrule">Hexo</span><span class="token punctuation">:</span> 4.2 ~ 5.x<span class="token key atrule">hexo-cli</span><span class="token punctuation">:</span> 3.1 ~ 4.x<span class="token key atrule">node.js</span><span class="token punctuation">:</span> 12.16 ~ latest <span class="token comment"># 推荐使用 LTS 版</span><span class="token key atrule">npm</span><span class="token punctuation">:</span> 6.13 ~ latest</code></pre><p><strong>安装node,js:</strong></p><p><a href="https://nodejs.org/en/">https://nodejs.org/en/</a></p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210808131949.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210808131949.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210808131948508"></p><p><strong>安装git:</strong></p><p><a href="https://git-scm.com/">https://git-scm.com/</a></p><p><strong>安装node.js 和git后进行测试:</strong></p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> -v$ <span class="token function">git</span> --version</code></pre><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210808133810.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210808133810.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210808133809220"></p><p><strong>安装hexo</strong>:</p><blockquote><p>因为我将blog文件存放在Dropbox云中,</p><p>而Dropbox本地文件在<code>.Dropbox\XXX</code> 若之间使用<code>npm</code>命令则会出现找不到包的问题</p></blockquote><p>我这里的解决方法是:</p><ol><li><p>先在控制台使用npm 命令安装<code> npm install hexo-cli -g</code></p></li><li><p>将目录<code>C:\Users\XXX\AppData\Roaming\npm</code> 下的 node_modules和 hexo*相关的文件复制一份到<code>.Dropbox\XXX\Blog\</code>下</p></li><li><p>在<code>.Dropbox\XXX\Blog\</code>下打开控制台继续执行安装hexo的命令</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 npm install hexo-cli -g</span><span class="token comment"># 测试版本</span>$ hexo -v<span class="token comment"># 安装</span>$ hexo init blog <span class="token operator">&amp;</span> <span class="token builtin class-name">cd</span> blog <span class="token operator">&amp;</span> <span class="token function">npm</span> <span class="token function">install</span><span class="token comment"># 浏览器访问 localhost:4000 测试 </span>$ hexo server<span class="token comment"># 此时本地安装hexo已完成</span></code></pre><p>hexo文件树:</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">.</span>├── _config.yml <span class="token comment"># 网站的配置信息，您可以在此配置大部分的参数。 </span>├── package.json├── scaffolds <span class="token comment"># 模版文件夹</span>├── <span class="token builtin class-name">source</span>  <span class="token comment"># 资源文件夹，除 _posts 文件，其他以下划线_开头的文件或者文件夹不会被编译打包到public文件夹</span><span class="token operator">|</span>   ├── _drafts <span class="token comment"># 草稿文件</span><span class="token operator">|</span>   └── _posts <span class="token comment"># 文章Markdowm文件 </span>└── themes  <span class="token comment"># 主题文件夹</span></code></pre><blockquote><p>如果遇到npm 安装 报错问题, 尝试删除 <code>package-lock.json</code> 再试</p></blockquote><p>hexo常用命令:</p><pre class="language-bash" data-language="bash"><code class="language-bash">hexo<span class="token function">npm</span> <span class="token function">install</span> hexo -g <span class="token comment">#安装  </span><span class="token function">npm</span> update hexo -g <span class="token comment">#升级  </span>hexo init <span class="token comment">#初始化</span>简写hexo n <span class="token string">"我的博客"</span> <span class="token operator">==</span> hexo new <span class="token string">"我的博客"</span> <span class="token comment">#新建文章</span>hexo p <span class="token operator">==</span> hexo publishhexo g <span class="token operator">==</span> hexo generate<span class="token comment">#生成</span>hexo s <span class="token operator">==</span> hexo server <span class="token comment">#启动服务预览</span>hexo d <span class="token operator">==</span> hexo deploy<span class="token comment">#部署</span>服务器hexo server <span class="token comment">#Hexo 会监视文件变动并自动更新，您无须重启服务器。</span>hexo server -s <span class="token comment">#静态模式</span>hexo server -p <span class="token number">5000</span> <span class="token comment">#更改端口</span>hexo server -i <span class="token number">192.168</span>.1.1 <span class="token comment">#自定义 IP</span>hexo clean <span class="token comment">#清除缓存 网页正常情况下可以忽略此条命令</span>hexo g <span class="token comment">#生成静态网页</span>hexo d <span class="token comment">#开始部署</span>监视文件变动hexo generate <span class="token comment">#使用 Hexo 生成静态文件快速而且简单</span>hexo generate --watch <span class="token comment">#监视文件变动</span>完成后部署两个命令的作用是相同的hexo generate --deployhexo deploy --generatehexo deploy -ghexo server -g草稿hexo publish <span class="token punctuation">[</span>layout<span class="token punctuation">]</span> <span class="token operator">&lt;</span>title<span class="token operator">></span></code></pre></li></ol><p><strong>安装hexo主题:</strong></p><p>安装适合自己口味的主题</p><h3 id="设置github">设置github</h3><p>github 新建仓库,仓库名称为 <strong><a href="http://XXX.github.io">XXX.github.io</a></strong>; XXX为你的用户名!</p><p>注意项:</p><pre><code>1. ==仓库名称中XXX必须与用户名对应!!!!==2. 方式为`public`</code></pre><h3 id="设置使用ssh方式推送">设置使用ssh方式推送</h3><ol><li><p>查看本地<code>C:\Users\XXX\.ssh</code> 下有无<code>id_rsa</code>样式文件</p></li><li><p>若无,创建新的ssh 密钥,</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ ssh-keygen -T rsa -C <span class="token string">'github邮箱地址'</span><span class="token comment"># 回车继续, passphrase 密码可输入可不输</span></code></pre></li><li><p>复制<code>.ssh</code>目录下的<code>id_rsa.pub</code>中文件内容到github ssh keys管理中</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210808135240.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210808135240.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210808135239587"></p></li><li><p>测试ssh</p><pre class="language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">ssh</span> git@github.com</code></pre><p><strong>若出现: ssh: connect to host <a href="http://github.com">github.com</a> port 22: Connection refused 错误</strong></p><p>解决方法:</p><ol><li><p><code>XXX\.ssh</code>目录下创建config文件</p></li><li><p>config文件中写入下面的信息：</p><pre class="language-bash" data-language="bash"><code class="language-bash">Host github.com  User xxxxx@xx.com<span class="token punctuation">(</span>github用户邮箱<span class="token punctuation">)</span>  Hostname ssh.github.com  PreferredAuthentications publickey  IdentityFile ~/.ssh/id_rsa  Port <span class="token number">443</span></code></pre></li><li><p>再使用<code>ssh git@github.com</code>测试</p><p><img src="https://gitee.com/sizaif/images/raw/master/img/20210808135729.png" class="lazyload" data-srcset="https://gitee.com/sizaif/images/raw/master/img/20210808135729.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20210808135728807"></p></li></ol></li></ol><h3 id="选择配置自己的hexo-主题-可选">选择配置自己的hexo 主题(可选)</h3><p>选择适合自己口味的blog主题即可</p></div><h2 id="域名绑定github">域名绑定github</h2><div class="story post-story"><ol><li><p>域名解析商解析方式选择<code>CNAME</code>; 站点为: <code>XXX.github.io</code></p></li><li><p>xxx.github.io仓库中,setting选项Page中配置 Custom domain</p><p>内容为你的域名,save保存</p></li><li><p>blog 根目录下的source文件中创建<code>CNAME</code>文件 (必须选项)</p></li></ol><p>内容为你的域名</p><p>作用: 防止每次hexo推送博客后,域名解析失效,重新配置Custom domain</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网站 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>吹一吹云空调</title>
      <link href="/posts/bfcf32d/"/>
      <url>/posts/bfcf32d/</url>
      
        <content type="html"><![CDATA[<iframe height="900" width="100%" frameborder="0" scrolling='no' src="https://ac.yunyoujun.cn"></iframe>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>第一次建站</title>
      <link href="/posts/8b3781ae/"/>
      <url>/posts/8b3781ae/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><h2 id="春江花月夜">春江花月夜</h2><div class="story post-story"><p>春江潮水连海平，海上明月共潮生。</p><p>滟滟随波千万里，何处春江无月明！</p><p>江流宛转绕芳甸，月照花林皆似霰；</p><p>空里流霜不觉飞，汀上白沙看不见。</p><p>江天一色无纤尘，皎皎空中孤月轮。</p><p>江畔何人初见月？江月何年初照人？</p><p>人生代代无穷已，江月年年望相似。</p><p>不知江月待何人，但见长江送流水。</p><p>白云一片去悠悠，青枫浦上不胜愁。</p><p>谁家今夜扁舟子？何处相思明月楼？</p><p>可怜楼上月裴回，应照离人妆镜台。</p><p>玉户帘中卷不去，捣衣砧上拂还来。</p><p>此时相望不相闻，愿逐月华流照君。</p><p>鸿雁长飞光不度，鱼龙潜跃水成文。</p><p>昨夜闲潭梦落花，可怜春半不还家。</p><p>江水流春去欲尽，江潭落月复西斜。</p><p>斜月沉沉藏海雾，碣石潇湘无限路。</p><p>不知乘月几人归，落月摇情满江树。</p></div><h2 id="寄语">寄语</h2><div class="story post-story"><p><strong>愿所有日日夜夜的努力都能迎来明日的初升的太阳</strong></p><p>by sizaif</p><p>2021-08-07  23:38:41</p><h3 id="你好明天">你好明天</h3></div>]]></content>
      
      
      <categories>
          
          <category> 杂文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网站 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8 Stream 教程学习</title>
      <link href="/posts/2180828f/"/>
      <url>/posts/2180828f/</url>
      
        <content type="html"><![CDATA[<h1>Java8 Stream 教程学习</h1><blockquote><p>😄 @Auther: sizaif</p><p>📆 2021-05-29  20:37:59</p><p>🔗 转载翻译于 <a href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/">https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/</a><a href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/"></a></p></blockquote><p>[TOC]</p><h2 id="说明">说明</h2><div class="story post-story"><p>这个示例驱动的教程深入概述了Java 8流。当我第一次读到<code>Stream </code>API时，我对它的名字感到困惑，因为它听起来类似于Java I/O中的<code>InputStream</code>和<code>OutputStream</code>。但是Java 8流是完全不同的东西。Stream是<a href="http://en.wikipedia.org/wiki/Monad_(functional_programming)">Monads</a>，因此在将函数式编程引入Java中扮演着重要的角色:</p><blockquote><p>在函数式编程，<code>Monads</code>是一个结构，表示计算定义为一系列的步骤。一个具有单子结构的类型定义了将操作链起来的含义，或将该类型的函数嵌套在一起。</p></blockquote><p>本指南教你如何使用Java 8流以及如何使用不同类型的可用流操作。您将了解处理顺序以及流操作的顺序如何影响运行时性能。更强大的流操作<code>reduce</code>，<code>collect</code>和<code>flatMap</code>将详细介绍。本教程最后对并行流进行了深入研究。</p></div><h2 id="流是如何工作的-How-streams-work">流是如何工作的(How streams work)</h2><div class="story post-story"><p>一个流表示一个元素序列，并支持不同类型的操作来对这些元素执行计算:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> myList <span class="token operator">=</span>    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"c2"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>myList    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// C1</span><span class="token comment">// C2</span></code></pre><p>流操作可以是中间操作，也可以是终端操作。中间操作返回一个流，因此我们可以不使用分号链接多个中间操作.终端操作要么为空，要么返回非流结果.上面的过滤器示例中，<code>map</code>和<code>sorted</code>是中间操作，而<code>forEach</code>是终端操作。有关所有可用流操作的完整列表，请参阅stream Javadoc。如上例中所示的这种流操作链也称为操作管道。</p><p>大多数流操作接受某种类型的lambda表达式参数，一个指定操作确切行为的函数接口。大多数操作必须是无干扰和无状态的。这是什么意思?</p><p>当一个函数不修改流的基础数据源时，它就是<a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html#NonInterference">无干扰</a>的,例如,在上面的例子中，没有一个<code>lambda表达式</code>通过从集合中添加或删除元素来修改<code>myList</code>。</p><p>当操作的执行是确定的时，函数就是<a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html#Statelessness">无状态</a> 的，例如，在上面的例子中，没有<code>lambda</code>表达式依赖于在执行过程中可能改变的外部作用域的任何可变变量或状态。</p></div><h2 id="不同类型的流-Different-kind-of-streams">不同类型的流(Different kind of streams)</h2><div class="story post-story"><p>可以从各种数据源创建流，特别是集合。列表和集合支持新的方法<code>stream()</code>和<code>parallelStream()</code>来创建顺序流或并行流。并行流能够在多个线程上操作，本教程的后面一节将对此进行介绍。我们现在主要关注顺序流:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"a3"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// a1</span></code></pre><p>在对象列表上调用方法<code>stream()</code>将返回一个常规对象流。但我们不需要创建集合来处理流，就像我们在下一个代码示例中看到的:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"a3"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// a1</span></code></pre><p>只需使用<code>stream .of()</code>从一堆对象引用创建一个流。</p><p>除了常规的对象流之外，<code>Java 8</code>还提供了特殊类型的流，用于处理基本数据类型<code>int</code>、<code>long</code>和<code>double</code>。你可能已经猜到是<code>IntStream</code>, <code>LongStream</code>和<code>DoubleStream</code>。</p><p><code>IntStreams</code>可以使用<code>IntStream.range()</code>替换常规的<code>for循环</code>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1</span><span class="token comment">// 2</span><span class="token comment">// 3</span></code></pre><p>所有这些基元流都像普通的对象流一样工作，有以下不同:基元流使用特化的l<code>ambda表达式</code>，例如用<code>IntFunction</code>代替<code>Function</code>，用<code>IntPredicate</code>代替<code>Predicate</code>。原始流支持附加的终端聚合操作<code>sum()</code>和<code>average()</code>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">-></span> <span class="token number">2</span> <span class="token operator">*</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 5.0</span></code></pre><p>有时将常规对象流转换为基本流很有用，反之亦然。为此，对象流支持特殊的映射操作<code>mapToInt()</code>、<code>mapToLong()</code>和<code>mapToDouble</code>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"a3"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token operator">::</span><span class="token function">parseInt</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span></code></pre><p>原始流可以通过mapToObj()转换为对象流:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// a1</span><span class="token comment">// a2</span><span class="token comment">// a3</span></code></pre><p>下面是一个组合的例子:<code>double类型</code>的流首先映射到<code>int类型</code>的流，然后再映射到<code>string类型</code>的对象流:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token operator">::</span><span class="token function">intValue</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// a1</span><span class="token comment">// a2</span><span class="token comment">// a3</span></code></pre></div><h2 id="处理次序-Processing-Order">处理次序(Processing Order)</h2><div class="story post-story"><p>现在，我们已经学习了如何创建和使用不同类型的流，让我们深入了解如何在幕后处理流操作。中间操作的一个重要特征是惰性。看看这个例子，这里缺少了一个终端操作:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在执行此代码片段时，不会将任何内容打印到控制台。这是因为只有在存在终端操作时才会执行中间操作。</p><p>让我们通过终端操作forEach来扩展上面的示例:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>执行此代码片段会在控制台上产生所需的输出:</p><pre class="language-text" data-language="text"><code class="language-text">filter:  d2forEach: d2filter:  a2forEach: a2filter:  b1forEach: b1filter:  b3forEach: b3filter:  cforEach: c</code></pre><p>结果的顺序可能会令人惊讶。一种简单的方法是在流的所有元素上一个接一个地水平执行操作.但是每个元素都沿着链垂直移动。第一个字符串<code>“d2”</code>传递<code>filter</code>然后<code>forEach</code>，只有这样第二个字符串<code>“a2”</code>才会被处理。</p><p>这种行为可以减少对每个元素执行的实际操作数，在下一个例子中我们可以看到:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"anyMatch: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// map:      d2</span><span class="token comment">// anyMatch: D2</span><span class="token comment">// map:      a2</span><span class="token comment">// anyMatch: A2</span></code></pre><p>只要谓词应用于给定的输入元素，<code>anyMatch</code>操作就返回<code>true</code>。对于传递给<code>“A2”</code>的第二个元素是这样的。由于流链是垂直执行的，所以在这种情况下只需要执行<code>两次map</code>。因此，不是映射流的所有元素，而是尽可能少地调用map。</p><h3 id="Why-order-matters">Why order matters</h3><p>下一个示例包含两个中间操作<code>map</code>和<code>filter</code>以及终端操作<code>forEach</code>。让我们再次检查这些操作是如何执行的:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// map:     d2</span><span class="token comment">// filter:  D2</span><span class="token comment">// map:     a2</span><span class="token comment">// filter:  A2</span><span class="token comment">// forEach: A2</span><span class="token comment">// map:     b1</span><span class="token comment">// filter:  B1</span><span class="token comment">// map:     b3</span><span class="token comment">// filter:  B3</span><span class="token comment">// map:     c</span><span class="token comment">// filter:  C</span></code></pre><p>您可能已经猜到，对于底层集合中的每个字符串，<code>map</code>和<code>filter</code>都被调用5次，而<code>forEach</code>只被调用一次。</p><p>如果我们改变操作的顺序，将<code>filter</code>移到链的开头，就可以大大减少实际执行的次数:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// filter:  d2</span><span class="token comment">// filter:  a2</span><span class="token comment">// map:     a2</span><span class="token comment">// forEach: A2</span><span class="token comment">// filter:  b1</span><span class="token comment">// filter:  b3</span><span class="token comment">// filter:  c</span></code></pre><p>现在，<code>map</code>只被调用一次，所以对于大量输入元素，操作管道的执行速度要快得多。在编写复杂的方法链时，请记住这一点。</p><p>让我们通过一个额外的操作来扩展上面的例子，<code>sorted</code>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sort: %s; %s\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>排序是一种特殊的中间操作。这是一个所谓的有状态操作，因为为了对元素集合排序，您必须在排序期间保持状态。</p><p>执行这个示例会得到以下控制台输出:</p><pre class="language-text" data-language="text"><code class="language-text">sort:    a2; d2sort:    b1; a2sort:    b1; d2sort:    b1; a2sort:    b3; b1sort:    b3; d2sort:    c; b3sort:    c; d2filter:  a2map:     a2forEach: A2filter:  b1filter:  b3filter:  cfilter:  d2</code></pre><p>首先，对整个输入集合执行排序操作。换句话说，<code>排序</code>是水平执行的。所以在这种情况下，对于输入集合中的每个元素的多个组合，sorted被调用8次。</p><p>再一次，我们可以通过重新排序链来优化性能:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sort: %s; %s\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// filter:  d2</span><span class="token comment">// filter:  a2</span><span class="token comment">// filter:  b1</span><span class="token comment">// filter:  b3</span><span class="token comment">// filter:  c</span><span class="token comment">// map:     a2</span><span class="token comment">// forEach: A2</span></code></pre><p>在本例中，从未调用sorted，因为filter将输入集合减少到只有一个元素。因此，对于更大的输入集合，性能会大大提高</p></div><h2 id="复用流-Reusing-Streams">复用流(Reusing Streams)</h2><div class="story post-story"><p>Java 8流不能被重用。当你调用任何终端操作时，流就会被关闭:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stream <span class="token operator">=</span>    <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>stream<span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ok</span>stream<span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// exception</span></code></pre><p>在同一个流的<code>anyMatch</code>之后调用<code>nonmatch会</code>导致以下异常:</p><pre class="language-text" data-language="text"><code class="language-text">java.lang.IllegalStateException: stream has already been operated upon or closed    at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:229)    at java.util.stream.ReferencePipeline.noneMatch(ReferencePipeline.java:459)    at com.winterbe.java8.Streams5.test7(Streams5.java:38)    at com.winterbe.java8.Streams5.main(Streams5.java:28)</code></pre><p>为了克服这个限制，我们必须为想要执行的每个终端操作创建一个新的流链，例如，我们可以创建一个流供应商来构造一个所有中间操作都已经设置好的新流:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stream</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> streamSupplier <span class="token operator">=</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>streamSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// okstreamSupplier.get().noneMatch(s -> true);  // ok</span></code></pre><p>对<code>get()</code>的每次调用都会构造一个新流，我们将在其上保存以调用所需的终端操作。</p></div><h2 id="高级操作-Advanced-Operations">高级操作(Advanced Operations)</h2><div class="story post-story"><p>流支持许多不同的操作。我们已经学习了最重要的操作，如<code>filter</code>或<code>map</code>。我把所有其他可用的操作留给您去发现(请参阅<a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream Javadoc</a>)。相反，让我们深入研究更复杂的操作收集、<code>flatMap</code>和<code>reduce</code>。</p><p>本节中的大多数代码示例使用以下人员列表进行演示:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token keyword">int</span> age<span class="token punctuation">;</span>    <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> persons <span class="token operator">=</span>    <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Peter"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Pamela"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"David"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="Collect">Collect</h3><p>Collect是一个非常有用的终端操作，可以将流的元素转换为另一种结果，例如: <code>list</code>,<code>map</code>,<code>set</code>.Collect接受<code>Collector</code>，收集器由四种不同的操作组成:供应商(<em>supplier</em>)、累加器( <em>accumulator</em>)、合并器(<em>combiner</em>)和收尾器(<em>finisher</em>)。乍一听，这听起来非常复杂，但好的部分是Java 8通过collector类支持各种内置收集器。所以对于最常见的操作，你不需要自己实现收集器。</p><p>让我们从一个非常常见的用例开始:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> filtered <span class="token operator">=</span>    persons        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"P"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// [Peter, Pamela]</span></code></pre><p>如您所见，从流的元素构造一个列表非常简单。需要一个集合而不是列表-只需使用collections . toset()。</p><p>下一个例子将所有人按年龄分组:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span><span class="token punctuation">></span></span> personsByAge <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>personsByAge    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"age %s: %s\n"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// age 18: [Max]</span><span class="token comment">// age 23: [Peter, Pamela]</span><span class="token comment">// age 12: [David]</span></code></pre><p><code>Collectors</code>是非常多才多艺的。你也可以创建流元素的聚合，</p><p>例如确定所有人的平均年龄:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Double</span> averageAge <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">averagingInt</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>averageAge<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 19.0</span></code></pre><p>如果您对更全面的统计信息感兴趣，汇总收集器将返回一个特殊的内置汇总统计信息对象。因此，我们可以简单地确定人员的最小年龄，最大年龄和算术平均年龄以及总和和计数。</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">IntSummaryStatistics</span> ageSummary <span class="token operator">=</span>    persons        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">summarizingInt</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ageSummary<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// IntSummaryStatistics&#123;count=4, sum=76, min=12, average=19.000000, max=23&#125;</span></code></pre><p>下一个例子将所有人连接到一个字符串中:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> phrase <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span>age <span class="token operator">>=</span> <span class="token number">18</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-></span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">" and "</span><span class="token punctuation">,</span> <span class="token string">"In Germany "</span><span class="token punctuation">,</span> <span class="token string">" are of legal age."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// In Germany Max and Peter and Pamela are of legal age.</span></code></pre><p>连接收集器接受分隔符以及可选的前缀和后缀。</p><p>为了将流元素转换为映射，我们必须指定键和值应该如何映射。请记住，映射的键必须是唯一的，否则抛出<code>IllegalStateException</code>。您可以选择将<code>merge</code>函数作为附加参数传递，以绕过异常:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>        p <span class="token operator">-></span> p<span class="token punctuation">.</span>age<span class="token punctuation">,</span>        p <span class="token operator">-></span> p<span class="token punctuation">.</span>name<span class="token punctuation">,</span>        <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span> <span class="token operator">-></span> name1 <span class="token operator">+</span> <span class="token string">";"</span> <span class="token operator">+</span> name2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// &#123;18=Max, 23=Peter;Pamela, 12=David&#125;</span></code></pre><p>现在我们已经了解了一些最强大的内置收集器，让我们尝试构建自己的特殊收集器。我们想要将流中的所有人转换为单个字符串，该字符串由以<code>|</code>管道字符分隔的所有大写字母组成。</p><p>为了实现这一点，我们通过<code>collector .of()</code>创建一个新的收集器。我们必须传递收集器的四个组成部分:供应商(<em>supplier</em>)、累加器( <em>accumulator</em>)、合并器(<em>combiner</em>)和收尾器(<em>finisher</em>)</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">,</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> personNameCollector <span class="token operator">=</span>    <span class="token class-name">Collector</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">" | "</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// supplier        (j, p) -> j.add(p.name.toUpperCase()),  // accumulator        (j1, j2) -> j1.merge(j2),               // combiner        StringJoiner::toString);                // finisherString names = persons    .stream()    .collect(personNameCollector);System.out.println(names);  // MAX | PETER | PAMELA | DAVID</span></code></pre><p>由于Java中的字符串是不可变的，我们需要一个像<code>StringJoiner</code>这样的<code>helper类</code>来让收集器构造我们的字符串。提供者最初构造这样一个带有适当分隔符的<code>StringJoiner</code>。累加器用于将每个人的大写名称添加到<code>StringJoiner</code>中。组合器知道如何将两个<code>StringJoiners</code>合并为一个。在最后一步中，完成器从StringJoiner构造所需的字符串。</p><h3 id="FlatMap">FlatMap</h3><p>我们已经学习了如何利用<code>map</code>操作将流的对象转换为另一种类型的对象。<code>Map</code>有一定的局限性，因为每个对象只能映射到另一个对象。但是，如果我们想将一个对象转换为多个其他对象，或者根本不转换该怎么办呢?这就是<code>flatMap</code>的救星。</p><p><code>FlatMap</code>将流的每个元素转换为其他对象的流。因此，每个对象将被转换为0个、一个或多个由流支持的其他对象。这些流的内容将被放置到<code>flatMap</code>操作返回的流中。</p><p>在我们看到flatMap的实际应用之前，我们需要一个适当的类型层次结构:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Bar</span><span class="token punctuation">></span></span> bars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> name<span class="token punctuation">;</span>    <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></code></pre><p>我们利用我们关于流的知识来实例化几个对象:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Foo</span><span class="token punctuation">></span></span> foos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// create foos</span><span class="token class-name">IntStream</span>    <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> foos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">"Foo"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// create bars</span>foos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>f <span class="token operator">-></span>    <span class="token class-name">IntStream</span>        <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-></span> f<span class="token punctuation">.</span>bars<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token string">"Bar"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" &lt;- "</span> <span class="token operator">+</span> f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>现在我们有一个包含三个<code>foo</code>的列表，每个<code>foo</code>由<code>三个bar</code>组成。</p><p><code>FlatMap</code>接受一个必须返回对象流的函数。因此，为了解析每个foo的bar对象，我们只需传递适当的函数:</p><pre class="language-java" data-language="java"><code class="language-java">foos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>f <span class="token operator">-></span> f<span class="token punctuation">.</span>bars<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>b <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Bar1 &lt;- Foo1</span><span class="token comment">// Bar2 &lt;- Foo1</span><span class="token comment">// Bar3 &lt;- Foo1</span><span class="token comment">// Bar1 &lt;- Foo2</span><span class="token comment">// Bar2 &lt;- Foo2</span><span class="token comment">// Bar3 &lt;- Foo2</span><span class="token comment">// Bar1 &lt;- Foo3</span><span class="token comment">// Bar2 &lt;- Foo3</span><span class="token comment">// Bar3 &lt;- Foo3</span></code></pre><p>正如您所看到的，我们已经成功地将三个foo对象的流转换为九个bar对象的流。</p><p>最后，上面的代码示例可以简化为一个流操作的单一管道:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">"Foo"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>f <span class="token operator">-></span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token string">"Bar"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" &lt;- "</span> f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>bars<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>f <span class="token operator">-></span> f<span class="token punctuation">.</span>bars<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>b <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>FlatMap</code>也适用于Java 8中引入的<code>Optional</code>类。<code>flatMap</code>操作返回另一种类型的可选对象。因此可以利用它来防止讨厌的空检查。</p><p>想想这样一个高度分层的结构:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Nested</span> nested<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Nested</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Inner</span> inner<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">class</span> <span class="token class-name">Inner</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">String</span> foo<span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>为了解析外部实例的内部字符串<code>foo</code>，你必须添加多个空检查来防止可能的<code>nullpointerexception</code>:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Outer</span> outer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>outer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> outer<span class="token punctuation">.</span>nested <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> outer<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>inner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>outer<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></code></pre><p>同样的行为可以通过使用可选的<code>flatMap</code>操作获得:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>o <span class="token operator">-></span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>nested<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>n <span class="token operator">-></span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>i <span class="token operator">-></span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>对flatMap的每次调用返回一个可选的包装(如果存在)所需对象，如果不存在则返回null。</p><h3 id="Reduce">Reduce</h3><p><code>reduce</code>操作将流的所有元素合并为一个结果。Java 8支持三种不同的reduce方法。第一种方法将元素流缩减为流中的一个元素。</p><p>让我们看看如何使用这个方法来确定最年长的人:</p><pre class="language-java" data-language="java"><code class="language-java">persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-></span> p1<span class="token punctuation">.</span>age <span class="token operator">></span> p2<span class="token punctuation">.</span>age <span class="token operator">?</span> p1 <span class="token operator">:</span> p2<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Pamela</span></code></pre><p><code>reduce</code>方法接受一个<code>BinaryOperator</code>累加器函数。这实际上是一个<code>BiFunction</code>，其中两个操作数共享同一类型，在这里是<code>Person</code>。<code>BiFunctions</code>类似于<code>Function</code>，但接受两个参数。示例函数比较两个人的年龄，以便返回具有最大年龄的人。</p><p>第二个reduce方法同时接受标识值和<code>BinaryOperator</code>累加器。该方法可用于构造一个新的Person，</p><p>该Person具有来自流中所有其他人员的聚合名称和年龄:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Person</span> result <span class="token operator">=</span>    persons        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            p1<span class="token punctuation">.</span>age <span class="token operator">+=</span> p2<span class="token punctuation">.</span>age<span class="token punctuation">;</span>            p1<span class="token punctuation">.</span>name <span class="token operator">+=</span> p2<span class="token punctuation">.</span>name<span class="token punctuation">;</span>            <span class="token keyword">return</span> p1<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"name=%s; age=%s"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>name<span class="token punctuation">,</span> result<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// name=MaxPeterPamelaDavid; age=76</span></code></pre><p>第三个reduce方法接受三个参数:<code>一个标识值</code>、<code>一个BiFunction累加器</code>和<code>一个BinaryOperator类型</code>的组合函数。因为身份值类型不限于Person类型，我们可以利用这个约简来确定所有人的年龄总和:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> ageSum <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-></span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">,</span> <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-></span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ageSum<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 76</span></code></pre><p>正如你所看到的，结果是76，但在引擎盖下到底发生了什么?让我们通过一些调试输出来扩展上面的代码:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> ageSum <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accumulator: sum=%s; person=%s\n"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"combiner: sum1=%s; sum2=%s\n"</span><span class="token punctuation">,</span> sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// accumulator: sum=0; person=Max// accumulator: sum=18; person=Peter// accumulator: sum=41; person=Pamela// accumulator: sum=64; person=David</span></code></pre><p>正如你所看到的，累加器函数完成了所有的工作。它首先被调用，初始值为0，第一个人是Max。在接下来的三个步骤中，总和随着最后一步的年龄不断增加，直到76岁。</p><p>Wait what?合成器(combiner)从来没有被调用?并行执行同一个流将解除秘密:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Integer</span> ageSum <span class="token operator">=</span> persons    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accumulator: sum=%s; person=%s\n"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"combiner: sum1=%s; sum2=%s\n"</span><span class="token punctuation">,</span> sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// accumulator: sum=0; person=Pamela</span><span class="token comment">// accumulator: sum=0; person=David</span><span class="token comment">// accumulator: sum=0; person=Max</span><span class="token comment">// accumulator: sum=0; person=Peter</span><span class="token comment">// combiner: sum1=18; sum2=23</span><span class="token comment">// combiner: sum1=23; sum2=12</span><span class="token comment">// combiner: sum1=41; sum2=35</span></code></pre><p>并行执行此流会导致完全不同的执行行为。现在合并器被调用了。由于累加器是并行调用的，因此需要合并器将单独累加的值相加。</p><p>让我们在下一章更深入地探讨并行流。</p></div><h2 id="并行流-Parallel-Streams">并行流(Parallel Streams)</h2><div class="story post-story"><p>流可以并行执行，以提高大量输入元素的运行时性能。并行流使用通过静态<code>ForkJoinPool. commonpool()</code>方法可用的公共<code>ForkJoinPool</code>。底层线程池的大小最多使用5个线程—取决于可用的物理CPU内核的数量:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">ForkJoinPool</span> commonPool <span class="token operator">=</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">.</span><span class="token function">commonPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commonPool<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3</span></code></pre><p>在我的机器上，公共池初始化时的并行度默认为3。这个值可以通过设置以下JVM参数来增加或减少:</p><pre class="language-text" data-language="text"><code class="language-text">-Djava.util.concurrent.ForkJoinPool.common.parallelism=5</code></pre><p>集合支持<code>parallelStream()</code>方法来创建元素的并行流。或者，您可以在给定流上调用中间方法<code>parallel()</code>来将顺序流转换为并行对应流。</p><p>为了少描述并行流的并行执行行为，下面的例子将当前线程的信息打印到<code>sout:</code></p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"c2"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"filter: %s [%s]\n"</span><span class="token punctuation">,</span>            s<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"map: %s [%s]\n"</span><span class="token punctuation">,</span>            s<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"forEach: %s [%s]\n"</span><span class="token punctuation">,</span>        s<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>通过研究调试输出，我们应该更好地理解哪些线程实际用于执行流操作:</p><pre class="language-text" data-language="text"><code class="language-text">filter:  b1 [main]filter:  a2 [ForkJoinPool.commonPool-worker-1]map:     a2 [ForkJoinPool.commonPool-worker-1]filter:  c2 [ForkJoinPool.commonPool-worker-3]map:     c2 [ForkJoinPool.commonPool-worker-3]filter:  c1 [ForkJoinPool.commonPool-worker-2]map:     c1 [ForkJoinPool.commonPool-worker-2]forEach: C2 [ForkJoinPool.commonPool-worker-3]forEach: A2 [ForkJoinPool.commonPool-worker-1]map:     b1 [main]forEach: B1 [main]filter:  a1 [ForkJoinPool.commonPool-worker-3]map:     a1 [ForkJoinPool.commonPool-worker-3]forEach: A1 [ForkJoinPool.commonPool-worker-3]forEach: C1 [ForkJoinPool.commonPool-worker-2]</code></pre><p>正如您可以看到的，并行流利用了公共<code>ForkJoinPool</code>中的所有可用线程来执行流操作。连续运行时的输出可能不同，因为实际使用的特定线程的行为是不确定的。</p><p>让我们通过一个额外的流操作——<code>sort</code>来扩展这个示例:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"c2"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"filter: %s [%s]\n"</span><span class="token punctuation">,</span>            s<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"map: %s [%s]\n"</span><span class="token punctuation">,</span>            s<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"sort: %s &lt;> %s [%s]\n"</span><span class="token punctuation">,</span>            s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> s1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"forEach: %s [%s]\n"</span><span class="token punctuation">,</span>        s<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>乍一看，结果可能很奇怪:</p><pre class="language-txt" data-language="txt"><code class="language-txt">filter:  c2 [ForkJoinPool.commonPool-worker-3]filter:  c1 [ForkJoinPool.commonPool-worker-2]map:     c1 [ForkJoinPool.commonPool-worker-2]filter:  a2 [ForkJoinPool.commonPool-worker-1]map:     a2 [ForkJoinPool.commonPool-worker-1]filter:  b1 [main]map:     b1 [main]filter:  a1 [ForkJoinPool.commonPool-worker-2]map:     a1 [ForkJoinPool.commonPool-worker-2]map:     c2 [ForkJoinPool.commonPool-worker-3]sort:    A2 &lt;> A1 [main]sort:    B1 &lt;> A2 [main]sort:    C2 &lt;> B1 [main]sort:    C1 &lt;> C2 [main]sort:    C1 &lt;> B1 [main]sort:    C1 &lt;> C2 [main]forEach: A1 [ForkJoinPool.commonPool-worker-1]forEach: C2 [ForkJoinPool.commonPool-worker-3]forEach: B1 [main]forEach: A2 [ForkJoinPool.commonPool-worker-2]forEach: C1 [ForkJoinPool.commonPool-worker-1]</code></pre><p>排序似乎只在主线程上顺序执行。实际上，在并行流上排序使用了新的Java 8方法<code>Arrays.parallelSort()</code>。如Javadoc中所述，如果排序是顺序执行还是并行执行，该方法决定数组的长度:</p><blockquote><p>如果指定数组的长度小于最小粒度，则使用适当的<code>Arrays</code>对其进行排序。排序方法。</p></blockquote><p>回到上一节的<code>reduce</code>示例。我们已经发现，<code>combiner</code>函数只在并行中调用，而不是在顺序流中调用。让我们看看哪些线程真正涉及:</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">></span></span> persons <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Peter"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Pamela"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"David"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>persons    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accumulator: sum=%s; person=%s [%s]\n"</span><span class="token punctuation">,</span>                sum<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"combiner: sum1=%s; sum2=%s [%s]\n"</span><span class="token punctuation">,</span>                sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>控制台输出显示累加器和组合器函数在所有可用线程上并行执行:</p><pre class="language-text" data-language="text"><code class="language-text">accumulator: sum=0; person=Pamela; [main]accumulator: sum=0; person=Max;    [ForkJoinPool.commonPool-worker-3]accumulator: sum=0; person=David;  [ForkJoinPool.commonPool-worker-2]accumulator: sum=0; person=Peter;  [ForkJoinPool.commonPool-worker-1]combiner:    sum1=18; sum2=23;     [ForkJoinPool.commonPool-worker-1]combiner:    sum1=23; sum2=12;     [ForkJoinPool.commonPool-worker-2]combiner:    sum1=41; sum2=35;     [ForkJoinPool.commonPool-worker-2]</code></pre><p>总之，可以这样说，并行流可以为具有大量输入元素的流带来很好的性能提升。但是请记住，像<code>reduce</code>和<code>collect</code>这样的并行流操作需要额外的计算(合并操作)，这在顺序执行时是不需要的。</p><p>此外，我们还了解到所有并行流操作共享同一个jvm范围的公共<code>ForkJoinPool</code>。因此，您可能希望避免实现缓慢阻塞的流操作，因为这可能会降低应用程序中严重依赖并行流的其他部分的速度。</p></div>]]></content>
      
      
      <categories>
          
          <category> 技术向 </category>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 学习笔记 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
